{% extends "app/layout.html" %}
{% block css %}
{% endblock %}

{% block content %}
<div class="content-wrap">
    <div class="content-ui-row">
        <form class="search-form" id="searchForm">
            <div class="card-content search">
                <!-- 개발자 수동 적용, grid-template-columns:1fr 1fr 1fr auto  -->
                <div class="form-ui">
                    <div class="col-auto">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="keyword" data-labelCd="검색어">검색어</label>
                            <div class="field-wrapper">
                                <input id="keyword" name="keyword" placeholder="AAS 이름 검색" />
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="card-group-btn search">
                            <button id="btnSearch" class="btn-search" data-labelCd="Search" title="조회">조회</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="left-panel">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">list_alt</i><label data-labelCd="AAS목록">AAS목록</label></span>
                
                <div class="aas-menu-btn">
                    <div class="btn-add-menu">                        
                        <button id="btnAddRoot" name="addRoot" title="최상위노드추가"><i class="material-symbols-outlined k-button-text add">add</i></button>
                    </div>
                </div>
            </div>
            <ul class="tree" id="aas_tree">
                <li>
                        <div class="tree-node" onclick="toggleNode(this)">
                            <span class="toggle-btn">-</span><i class="material-symbols-outlined folder">folder</i><span class="aas-title"> AAS </span> myAASwithGlobalSecurityMetaModel<span class="aas-time"> 25-01-22 01:12:18</span>
                        </div>
                        <ul>
                            <li>
                                <div class="tree-node" onclick="toggleNode(this)">
                                    <span class="toggle-btn">-</span><i class="material-symbols-outlined folder-open">folder_open</i><span class="sub-title"> Sub </span> SecuritySettingsForServer @QUALIFIERS <span class="aas-time"> (25-01-21 08:03:38.611)</span>
                                </div>
                                <ul>
                                    <li>
                                        <div class="tree-node">
                                            <ul>
                                                <li><span class="prop-title">Prop</span> isNotAuthenticated<span class="aas-time"> (25-01-19 09:36:37.099)</span></li>
                                            </ul>
                                        </div>
                                        <!--이가영 file 아이콘 추가-->
                                        <div class="tree-node">
                                            <ul>
                                                <li class="aas-save"><i class="material-symbols-outlined folder-save">save</i><span class="file-title">file</span> isNotAuthenticated<span class="aas-time"> (25-01-19 09:36:37.099)</span></li>
                                            </ul>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="tree-node" onclick="toggleNode(this)">
                                            <span class="toggle-btn">-</span><i class="material-symbols-outlined draft">description</i><span class="coll-title">Coll </span> roles #1 <span class="aas-time">  (25-01-19 09:36:37.099)</span>
                                        </div>
                                        <div class="tree-node" onclick="toggleNode(this)">
                                            <ul>
                                                <li><span class="prop-title">Prop </span> isNotAuthenticated <span class="aas-time"> (25-01-19 09:36:37.099)</span></li>
                                            </ul>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="tree-node" onclick="toggleNode(this)">
                                            <span class="toggle-btn">-</span> <i class="material-symbols-outlined draft">description</i><span class="coll-title"> Coll</span>  roleMapping #1 <span class="aas-time"> (25-01-19 09:36:37.099)</span>
                                        </div>
                                        <div class="tree-node" onclick="toggleNode(this)">
                                            <ul>
                                                <!--col 추가 이가영 250328-->
                                                <li>
                                                    <i class="material-symbols-outlined draft">description</i>
                                                    <span class="coll-title">Coll</span> isNotAuthenticated<span class="aas-time"> (25-01-19 09:36:37.099)</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                </li>
                <li>
                    <div class="tree-node" onclick="toggleNode(this)">
                        <span class="toggle-btn">-</span><i class="material-symbols-outlined folder">folder</i><span class="aas-title"> AAS </span> myAASwithGlobalSecurityMetaModel<span class="aas-time"> (25-01-22 01:12:18.991)</span>
                    </div>
                    <ul>
                        <li>
                            <div class="tree-node" onclick="toggleNode(this)">
                                <span class="toggle-btn">-</span><i class="material-symbols-outlined folder-open">folder_open</i><span class="sub-title"> Sub </span> SecuritySettingsForServer @QUALIFIERS <span class="aas-time"> (25-01-21 08:03:38.611)</span>
                            </div>
                            <ul>
                                <li>
                                    <div class="tree-node" onclick="toggleNode(this)">
                                        <span class="toggle-btn">-</span> <i class="material-symbols-outlined draft">description</i><span class="coll-title">Coll </span> roles #1 <span class="aas-time">  (25-01-19 09:36:37.099)</span>
                                    </div>
                                    <div class="tree-node" onclick="toggleNode(this)">
                                        <ul>
                                            <li><span class="prop-title">Prop </span> isNotAuthenticated <span class="aas-time"> (25-01-19 09:36:37.099)</span></li>
                                        </ul>
                                    </div>
                                </li>
                                <li>
                                    <div class="tree-node" onclick="toggleNode(this)">
                                        <span class="toggle-btn">-</span><i class="material-symbols-outlined draft">description</i> <span class="coll-title"> Coll</span>  roleMapping #1 <span class="aas-time"> (25-01-19 09:36:37.099)</span>
                                    </div>
                                    <div class="tree-node" onclick="toggleNode(this)">
                                        <ul>
                                            <li><span class="prop-title">Prop </span> isNotAuthenticated<span class="aas-time"> (25-01-19 09:36:37.099)</span></li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>


        </div>


        <!--
        <div class="content-ui-row connect">
            <div class="card-content grid">
                <div class="panel-container">

                </div>
                <div id="aas_grid"></div>
        </div>
            </div>
    -->
        <div class="right-panel" id="div_aas_detail" style="display:none">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i>AAS상세입력</span>
                <span>
                    <button name="clear"><i class="material-symbols-outlined">refresh</i></button>
                    <!--<button name="clear"><i class="material-symbols-outlined">forms_add_on</i></button>-->
                    <button name="save"><i class="material-symbols-outlined">save</i></button>
                    <!--<button name="delete"><i class="material-symbols-outlined">delete</i></button>-->
                    <button name="add_child"><i class="material-symbols-outlined">format_list_bulleted_add</i></button>
                </span>
                </div>
                <form>
                    <input type="hidden" name="aas_pk" value="" />
                    <div class="right-panel-content">
                        <div class="aas-info">
                            <div class="aas-input-group">
                                <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위AAS">상위AAS</label>
                                <input name="p_display_name" class="form-control aas-form-control" readonly />
                            </div>
                        </div>
                        <hr />
                        <div class="aas-info">
                            <div class="aas-input-group">
                                <label class="k-label k-form-label essential" for="id_short" data-labelCd="id Short">id Short</label>
                                <input name="id_short" class="form-control aas-form-control" />
                            </div>
                            <div class="aas-input-group">
                                <label class="k-label k-form-label essential" for="id" data-labelCd="id">id</label>
                                <input name="id" class="form-control aas-form-control" />
                            </div>

                            <div class="aas-input-group">
                                <label class="k-label k-form-label essential" for="displayName" data-labelCd="Display name">Display name</label>
                                <input name="displayName" class="form-control aas-form-control" placeholder="이름입력" />
                                <select name="lang_code" class="form-control aas-form-control">
                                    <option value="ko-KR">한글</option>
                                    <option value="en-US">English</option>
                                </select>
                            </div>
                            <div class="aas-input-group">
                                <label class="k-label k-form-label" for="description" data-labelCd="비고">비고</label>
                                <textarea name="description" class="form-control aas-form-control"></textarea>
                            </div>

                            <div class="aas-input-group">
                                <label class="k-label k-form-label" for="description" data-labelCd="수정일">수정일</label>
                                <input name="created" placeholder="YYYY-MM-DD hh:mm:ss" class="form-control aas-form-control" />
                            </div>
                        </div>
                        <hr />
    <!--

    <div class="card-group-btn">
        <span class="info-text"><i class="material-symbols-outlined">edit_square</i>Administration</span>
    </div>

    <div class="aas-info">
        <div class="aas-input-group">
            <input name="version" placeholder="version" class="form-control aas-form-control" />
            <input name="revision" placeholder="revision" class="form-control aas-form-control" />
            <input name="creator" placeholder="creator" class="form-control aas-form-control" />
        </div>
    </div>
    <hr />
    -->
                    <div class="card-group-btn">
                        <span class="info-text"><i class="material-symbols-outlined">edit_square</i>Asset Information</span>
                    </div>

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="asset_kind" data-labelCd="Asset Kind">Asset Kind</label>
                            <select name="asset_kind" class="form-control aas-form-control">
                                <option value="NotApplicable">NotApplicable</option>
                                <option value="Instance">Instance</option>
                                <option value="Type">Type</option>
                            </select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="globalAssetId" data-labelCd="Asset Type">Asset Type</label>
                            <select name="assetType" class="form-control aas-form-control">
                                <option value="equipment">equipment</option>
                                <option value="material">material</option>
                                <option value="product">product</option>
                                <option value="tool">tool</option>
                                <option value="software">software</option>
                            </select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="globalAssetId" data-labelCd="Grobal Asset ID">Grobal Asset ID</label>
                            <input name="globalAssetId" class="form-control aas-form-control" placeholder="ex) 설비코드 등" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label ">Default Thumbnail</label>
                            <input name="thumbnailfiles" type="file" aria-label="files" accept="image/*" placeholder="설비이미지파일지정" />
                            <button name="upload"><i class="material-symbols-outlined">upload</i></button>

                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label "></label>
                            <div id="previewThumbnail"></div>
                        </div>
                    </div>

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="globalAssetId" data-labelCd="Specific Asset IDs">Specific Asset IDs</label>
                            <div id="specificAsssetIds_grid"></div>
                        </div>
                    </div>
</div>
            </form>
        </div>

        <div class="right-panel" id="div_submodel_detail" style="display:none">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i><label data-labelCd="Submodel">Submodel</label></span>
                <span>
                    <button name="clear"><i class="material-symbols-outlined">refresh</i></button>
                    <button name="save"><i class="material-symbols-outlined">save</i></button>
                    <button name="delete"><i class="material-symbols-outlined">delete</i></button>
                    <button name="add_child"><i class="material-symbols-outlined">format_list_bulleted_add</i></button>
                </span>
            </div>
            <form>
                <input type="hidden" name="sm_pk" value="" />
                <div class="right-panel-content">
                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위AAS">상위AAS</label>
                            <input name="p_display_name" class="form-control aas-form-control" readonly />
                        </div>
                    </div>
                    <hr />
                    <div class="aas-info">

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id_short" data-labelCd="id Short">id Short</label>
                            <input name="id_short" class="form-control aas-form-control" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id" data-labelCd="id">id</label>
                            <input name="id" class="form-control aas-form-control" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="scope" data-labelCd="적용범위">적용범위</label>
                            <select name="scope" class="form-control aas-form-control">
                                <option value="share">공유</option>
                                <option value="exclusive">전용</option>
                            </select>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="displayName" data-labelCd="Display name">Display name</label>
                            <input name="displayName" class="form-control aas-form-control" placeholder="이름입력" />
                            <select name="lang_code" class="form-control aas-form-control">
                                <option value="ko-KR">한글</option>
                                <option value="en-US">English</option>
                            </select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="description" data-labelCd="비고">비고</label>
                            <textarea name="description" class="form-control aas-form-control"></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="right-panel" id="div_subcollection_detail" style="display:none">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i><label data-labelCd="Collection">Collection</label></span>
                <span>
                    <button name="clear"><i class="material-symbols-outlined">refresh</i></button>
                    <button name="save"><i class="material-symbols-outlined">save</i></button>
                    <button name="delete"><i class="material-symbols-outlined">delete</i></button>
                    <button name="add_child"><i class="material-symbols-outlined">format_list_bulleted_add</i></button>
                </span>
            </div>
            <form>
                <input type="hidden" name="sme_pk" value="" />
                <div class="right-panel-content">

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위">상위</label>
                            <input name="p_display_name" class="form-control aas-form-control" readonly />
                        </div>
                    </div>
                    <hr />

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id_short" data-labelCd="id Short">id Short</label>
                            <input name="id_short" class="form-control aas-form-control" />
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="displayName" data-labelCd="Display name">Display name</label>
                            <input name="displayName" class="form-control aas-form-control" placeholder="이름입력" />
                            <select name="lang_code" class="form-control aas-form-control">
                                <option value="ko-KR">한글</option>
                                <option value="en-US">English</option>
                            </select>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="description" data-labelCd="비고">비고</label>
                            <textarea name="description" class="form-control aas-form-control"></textarea>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="displayName" data-labelCd="생성일">생성일</label>
                            <input name="created" class="form-control aas-form-control" />
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="right-panel" id="div_prpt_detail" style="display:none">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i><label data-labelCd="Property Element">Property Element</label></span>
                <span>
                    <button name="clear"><i class="material-symbols-outlined">refresh</i></button>
                    <button name="save"><i class="material-symbols-outlined">save</i></button>
                    <button name="delete"><i class="material-symbols-outlined">delete</i></button>
                </span>
            </div>
            <div class="right-panel-content">
                <form>
                    <input type="hidden" name="sme_pk" value="" />

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위">상위</label>
                            <input name="p_display_name" class="form-control aas-form-control" readonly />
                        </div>
                    </div>
                    <hr />

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id_short" data-labelCd="id Short">id Short</label>
                            <input name="id_short" class="form-control aas-form-control" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="category" data-labelCd="Category">Category</label>
                            <input name="category" class="form-control aas-form-control" placeholder="category" />
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="valueType" data-labelCd="Value Type">Value Type</label>
                            <select name="valueType" class="form-control aas-form-control">
                                <option value="xs:anyURI">xs:anyURI</option>
                                <option value="xs:base64Binary">xs:base64Binary</option>
                                <option value="xs:boolean">xs:boolean</option>
                                <option value="xs:byte">xs:byte</option>
                                <option value="xs:date">xs:date</option>
                                <option value="xs:dateTime">xs:dateTime</option>
                                <option value="xs:decimal">xs:decimal</option>
                                <option value="xs:double">xs:double</option>
                                <option value="xs:duration">xs:duration</option>
                                <option value="xs:gDay">xs:gDay</option>
                                <option value="xs:gMonth">xs:gMonth</option>
                                <option value="xs:gMonthDay">xs:gMonthDay</option>
                                <option value="xs:gYearMonth">xs:gYearMonth</option>
                                <option value="xs:float">xs:float</option>
                                <option value="xs:hexBinary">xs:hexBinary</option>
                                <option value="xs:int">xs:int</option>
                                <option value="xs:integer">xs:integer</option>
                                <option value="xs:long">xs:long</option>
                                <option value="xs:negativeInteger">xs:negativeInteger</option>
                                <option value="xs:nonNegativeInteger">xs:nonNegativeInteger</option>
                                <option value="xs:nonPositiveInteger">xs:nonPositiveInteger</option>
                                <option value="xs:positiveInteger">xs:positiveInteger</option>
                                <option value="xs:short">xs:short</option>
                                <option value="xs:string">xs:string</option>
                                <option value="xs:time">xs:time</option>
                                <option value="xs:unsignedByte">xs:unsignedByte</option>
                                <option value="xs:unsigendInt">xs:unsigendInt</option>
                                <option value="xs:unsignedLong">xs:unsignedLong</option>
                                <option value="xs:unsignedShort">xs:unsignedShort</option>
                            </select>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="value" data-labelCd="value">value</label>
                            <input name="value" class="form-control aas-form-control" />
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="displayName" data-labelCd="Display name">Display name</label>
                            <input name="displayName" class="form-control aas-form-control" placeholder="이름입력" />
                            <select name="lang_code" class="form-control aas-form-control">
                                <option value="ko-KR">한글</option>
                                <option value="en-US">English</option>
                            </select>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="description" data-labelCd="비고">비고</label>
                            <textarea name="description" class="form-control aas-form-control"></textarea>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="displayName" data-labelCd="생성일">생성일</label>
                            <input name="created" class="form-control aas-form-control" readonly />
                        </div>

                    </div>
                </form>
            </div>
        </div>

        <div class="right-panel" id="div_file_detail" style="display:none">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i><label data-labelCd="File Element">File Element</label></span>
                <span>
                    <button name="clear"><i class="material-symbols-outlined">refresh</i></button>
                    <button name="save"><i class="material-symbols-outlined">save</i></button>
                    <button name="delete"><i class="material-symbols-outlined">delete</i></button>
                </span>
            </div>

        </div>
    </div>
</div>

{% verbatim %}
<script type="text/x-kendo-template" id="aasTemplate">
    <li>
    # if(sub_items.length>0) { #
        <div class="tree-node">
            <span class="toggle-btn aas-node">-</span><i class="material-symbols-outlined folder-open">folder_open</i><span class="aas-title">#: gubun # </span> <span class="aas_detail" aas_pk="#=aas_pk#" gubun="aas">#: displayName #</span><span class="aas-time"> #: created #</span>
        </div>
        <ul id="aas_sub_#=aas_pk#">
        #
        for(let idx=0; idx<sub_items.length;idx++) {
         let item = sub_items[idx];
         let gubun = item.gubun;
        #
         # if(gubun=="aas"){ #
            <div class="tree-node">

                <span class="toggle-btn aas-node">-</span><i class="material-symbols-outlined folder-open">folder_open</i><span class="aas-title">#: item.gubun # </span> <span class="aas_detail" aas_pk="#=item.aas_pk#" gubun="aas">#: item.displayName #</span><span class="aas-time"> #: item.created #</span>
            </div>
            # if(item.sub_items.length>0) {#
                <ul id="aas_sub_#=item.aas_pk#">
                    #
                    for(let sidx=0;sidx<item.sub_items.length; sidx++){
                      let sm_item = item.sub_items[sidx];
                    #
                    <li>
                        <div class="tree-node" >
                            <span class="toggle-btn submodel-node" sm_pk="#=sm_item.sm_pk#" >+</span>
                            <i class="material-symbols-outlined folder-open">folder</i>
                            <span class="sub-title"> #: sm_item.gubun # </span>
                            <span class="submodel_detail" sm_pk="#=sm_item.sm_pk#" gubun="#= sm_item.gubun #" aas_pk="#=item.aas_pk#">#: sm_item.displayName # </span>
                            <span class="aas-time"> #: sm_item.created #</span>
                        </div>
                        <ul id="sm_#=sm_item.sm_pk#" class="hidden"></ul>
                    </li>
                    # } #

                </ul>
            # } #
         # } else { #

            <li>
                <div class="tree-node" gubun="#= item.gubun #">
                    <span class="toggle-btn submodel-node" gubun="#= item.gubun #" sm_pk="#=item.sm_pk#" >+</span>
                    <i class="material-symbols-outlined folder-open">folder</i>
                    <span class="sub-title"> #: item.gubun # </span>
                    <span class="submodel_detail" sm_pk="#=item.sm_pk#" aas_pk="#=item.aas_pk#">#: item.displayName # </span>
                    <span class="aas-time"> #: item.created #</span>
                </div>
                <ul id="sm_#=item.sm_pk#" class="hidden"></ul>
            </li>

         # } #
        # } #
        </ul>
    # } else { #
        <div class="tree-node">
            <span class="toggle-btn aas-node"></span><i class="material-symbols-outlined folder-open">folder_open</i><span class="aas-title">#: gubun # </span> <span class="aas_detail" aas_pk="#=aas_pk#" gubun="aas">#: displayName #</span><span class="aas-time"> #: created #</span>
        </div>
    # } #
    </li>
</script>

<script type="text/x-kendo-template" id="submodelTemplate">
    <li>
        <div class="tree-node" >
            <span class="toggle-btn submodel-node" sm_pk="#=sm_pk#" >+</span>
            <i class="material-symbols-outlined folder">folder</i>
            <span class="sub-title"> #: gubun # </span>
            <span class="submodel_detail" data_pk="#=sm_pk#" gubun="#= gubun #"">#: displayName # </span>
            <span class="aas-time"> #: created #</span>
        </div>
        <ul id="sub_ul_#=sm_pk#" class="hidden">

        </ul>
    </li>

</script>

<script type="text/x-kendo-template" id="smeTemplate">
     # for (let i=0;i<data.length; i++) { let item = data[i]; #
      <li>
          # if (item.gubun =='prop'){ #
              <ul class="tree-node">
                  <li><span class="prop-title">Prop</span> <a class="sme_prpt_title" data_pk="#=item.sme_pk#" gubun="#= item.gubun #" >#= item.displayName # = #=item.prpt_value#</a><span class="aas-time"> (#= item.created #)</span></li>
              </ul>
          # } #

          # if (item.gubun =='file'){ #
              <ul class="tree-node">
                  <li><span class="prop-title">Prop</span> <a class="sme_file_title" data_pk="#=item.sme_pk#" gubun="#= item.gubun #"> #= item.displayName #</a><span class="aas-time"> (#= item.created #)</span></li>
              </ul>
          # } #

         # if (item.gubun =='coll') { #
              <div class="tree-node" gubun="#=item.gubun#" >
                  <span class="toggle-btn sme-coll-node" data_pk="#=item.sme_pk#">+</span><i class="material-symbols-outlined folder">folder</i><span class="sub-title"> #: item.gubun # </span> <a class="sme_collection_title" data_pk="#=item.sme_pk#" gubun="#= item.gubun #">#: item.displayName # </a><span class="aas-time"> #: item.created #</span>
              </div>
              <ul class="hidden"></ul>
         # } #
    </li>
     # } #
</script>

<script type="text/x-kendo-template" id="popupSubmodelElementSelection">

</script>

{% endverbatim %}
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    class AASPage {
        constructor() {
            this.grid = null;
            this.baseUrl = '/api/aas/aasgui';
            this.$aasTree = $('#aas_tree');

            this.$div_aas_detail = $('#div_aas_detail');
            this.$div_submodel_detail = $('#div_submodel_detail');
            this.$div_subcollection_detail = $('#div_subcollection_detail');
            this.$div_prpt_detail = $('#div_prpt_detail');
            this.$div_file_detail = $('#div_file_detail');
            this.init();
        }

        init() {
            let _this = this;

            this.divItems = [this.$div_aas_detail, this.$div_submodel_detail, this.$div_subcollection_detail, this.$div_prpt_detail, this.$div_file_detail];

            let option = {
                columns: [
                    { field: "name", title: "Name", width: 80 },
                    { field: "value", title: "Value", width: 100 },
                ],
                change: function (e) {

                },
                dataBound: function (e) {
                    kendoUtil.showGridRowCount(this.element);
                },
                height: "150px"
            };
            _this.displayNameGrid = new Grid($("#specificAsssetIds_grid"), option);

            //search form
            $('#keyword').kendoTextBox();
            $('#keyword').keypress(function (e) {
                // Enter(=13)키가 눌렸을 때, 기본 동작 방지 후 searchMainData 호출
                if (e.keyCode == 13) {
                    e.preventDefault();
                    _this.searchMainData();
                }
            });

            //form button
            $('#btnSearch').kendoButton({
                icon: "search",
                themeColor: "base",
                click: function () {
                    _this.searchMainData();
                }
            });


            
            // 최상위 AAs 추가
            $('#btnAddRoot').kendoButton({
                
                themeColor: "base",
                click: function () {
                    _this.addRootNode();
                }
            });

            ////////////////////////////////////////////////////////////////////////////
            // AAS
            this.$div_aas_detail.find("button[name=clear]").kendoButton({
                themeColor: "base",
                click: function () {
                    let $form = _this.$div_aas_detail.find('form');
                    $form[0].reset();
                }
            });

            this.$div_aas_detail.find("button[name=save]").kendoButton({
                themeColor: "info",
                click: function () {
                    _this.saveAASData();
                }
            });

            this.$div_aas_detail.find("button[name=add_child]").kendoButton({
                themeColor: "info",
                click: function () {
                    Alert.alert('하위노드추가', '기능구현중');
                }
            });
            ////////////////////////////////////////////////////////////////////////////

            this.$div_aas_detail.find("button[name=delete]").kendoButton({
                themeColor: "error",
                click: function () {
                    let $form = _this.$div_aas_detail.find('form');
                }
            });

            this.$div_aas_detail.find("button[name=upload]").kendoButton({
                themeColor: "info",
                click: function () {
                    let $form = _this.$div_aas_detail.find('form');
                }
            });


            this.$div_aas_detail.find("input[name=thumbnailfiles]").on('change', function (e) {
                let files = e.currentTarget.files;
                //console.log(typeof files, files);
                $('#previewThumbnail').empty();
                let file;
                if (files.length > 0) {
                    file = files[0];

                    let img = document.createElement('img');
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        
                        img.setAttribute('src', e.target.result);
                        img.setAttribute('style', "width:200px;");
                        img.setAttribute('data-file', file.name);
                        
                        $('#previewThumbnail').append(img);
                    };
                    reader.readAsDataURL(file);
                }
            });

            ///////////////////////////////////////////////////////////////////////////////
            // Submodel
            this.$div_submodel_detail.find("button[name=clear]").kendoButton({
                themeColor: "base",
                click: function () {
                    let $form = _this.$div_submodel_detail.find('form');
                    $form[0].reset();
                }
            });

            this.$div_submodel_detail.find("button[name=save]").kendoButton({
                themeColor: "info",
                click: function () {
                    _this.saveSubmodel();
                }
            });

            this.$div_submodel_detail.find("button[name=delete]").kendoButton({
                themeColor: "error",
                click: function () {
                    let $form = _this.$div_submodel_detail.find('form');
                }
            });
            // 서브모델 하위 항목 추가
            this.$div_submodel_detail.find("button[name=add_child]").kendoButton({
                themeColor: "info",
                click: function () {
                    let $form = _this.$div_submodel_detail.find('form');
                }
            });

            //SubmodelElementCollection
            this.$div_subcollection_detail.find('button[name=clear]').kendoButton({
                themeColor: "base",
                click: function () {
                }
            });
            this.$div_subcollection_detail.find('button[name=save]').kendoButton({
                themeColor: "info",
                click: function () {
                    _this.saveSubmodelElementCollection();
                }
            });
            this.$div_subcollection_detail.find('button[name=delete]').kendoButton({
                themeColor: "error",
                click: function () {
                }
            });

            // 서브모델엘리먼트컬렉션 하위 항목 추가
            this.$div_subcollection_detail.find("button[name=add_child]").kendoButton({
                themeColor: "info",
                click: function () {
                    let $form = _this.$div_subcollection_detail.find('form');

                }
            });

            //PropertyElement
            //SubmodelElementCollection
            this.$div_prpt_detail.find('button[name=clear]').kendoButton({
                themeColor: "base",
                click: function () {
                }
            });

            this.$div_prpt_detail.find('button[name=save]').kendoButton({
                themeColor: "info",
                click: function () {
                    _this.savePropertyElement();
                }
            });

            this.$div_prpt_detail.find('button[name=delete]').kendoButton({
                themeColor: "error",
                click: function () {
                }
            });

            //FileElement
            this.$div_file_detail.find('button[name=clear]').kendoButton({
                themeColor: "base",
                click: function () {
                }
            });
            this.$div_file_detail.find('button[name=save]').kendoButton({
                themeColor: "info",
                click: function () {
                }
            });
            this.$div_file_detail.find('button[name=delete]').kendoButton({
                themeColor: "error",
                click: function () {
                }
            });

        }

        addRootNode() {
            Alert.alert('최상위노드추가', '기능구현중');
        }

        showAASDetail($item) {

            let _this = this;
            let aas_pk = $item.attr('aas_pk');
            let gubun = $item.attr('gubun');
            let action = gubun + '_detail';
            let param = { action: action, aas_pk: aas_pk };

            this.hideAllDetail();
            this.$div_aas_detail.show();

            let $form = this.$div_aas_detail.find('form');
            let $lang_code = this.$div_aas_detail.find('select[name=lang_code]');

            let fnSuccess = function (result) {
                if (result.success) {
                    let aasData = result.data;
                    FormUtil.BindDataForm(aasData, $form);
                    $lang_code.off('change').on('change', function () {
                        let selectedLangCode = $lang_code.val();
                        let disp_text = _this.getLangTextFromJson(selectedLangCode, aasData.json_displayname);
                        let desc_text = _this.getLangTextFromJson(selectedLangCode, aasData.json_description);
                        $form.find("input[name=displayName]").val(disp_text);
                        $form.find("input[name=description]").text(desc_text);
                    });

                    _this.$div_submodel_detail.find("button[name=add_child]").removeAttr('disabled');
                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);

        }

        aasToggleNode(node) {

            let childUl = node.parentElement.nextElementSibling;
            if (childUl) {
                childUl.classList.toggle('hidden');
                let toggleBtn = node.parentElement.querySelector('.toggle-btn');
                let isHidden = childUl.classList.contains('hidden');
                if (isHidden) {
                    toggleBtn.textContent = '+';
                }
                else {
                    //서브모델 목록 펼치기
                    //이미 데이터가 있음
                    toggleBtn.textContent = '-';
                }
            }
        }


        saveSubmodelElementCollection() {
            let _this = this;
            let $form = _this.$div_subcollection_detail.find("form");
            let data = FormUtil.extractForm($form);
            let fnSuccess = function (result) {
                if (result.success) {
                    alert(result.data);
                    Alert.alert("저장확인", '저장되었습니다.');
                }
                else {
                    Alert.alert("저장오류", result.message);
                }
            }

            let url = this.baseUrl + '?action=save_submodel_element_collection'
            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        hideAllDetail() {
            $.each(this.divItems, function (idx, item) {
                item.hide();
            });
        }

        getLangTextFromJson(selectedLangCode, strJson) {
            let strText = '';
            if (strJson != null) {
                let jsonArr = JSON.parse(strJson);
                $.each(jsonArr, function (idx, item) {
                    if (item.language == selectedLangCode) {
                        strText = item.text;
                    }
                });
            }
            return strText;
        }     

        saveSubmodel() {
            let _this = this;
            let $form = this.$div_submodel_detail.find('form');
            let data = FormUtil.extractForm($form);

            let fnSaveSuccess = function (result) {
                if (result.success) {
                    Alert.alert('Submodel 저장확인', '저장하였습니다.');
                }
            };
            let url = this.baseUrl + "?action=save_submodel";
            AjaxUtil.postAsyncData(url, data, fnSaveSuccess);
        }

        showSubmodelDetail($item) {
            let _this = this;
            let sm_pk = $item.attr('sm_pk');
            let aas_pk = $item.attr('aas_pk');
            this.hideAllDetail();
            this.$div_submodel_detail.show();

            let $form = this.$div_submodel_detail.find("form");
            let $lang_code = this.$div_submodel_detail.find('select[name=lang_code]');
            
            let param = { action: 'submodel_detail', sm_pk: sm_pk, aas_pk: aas_pk };
            let fnSuccess = function (result) {
                if (result.success) {
                    let submodelData = result.data;
                    FormUtil.BindDataForm(submodelData, $form);
                    
                    $lang_code.off('change').on('change', function () {
                        let selectedLangCode = $lang_code.val();
                        let disp_text = _this.getLangTextFromJson(selectedLangCode, submodelData.json_displayname);
                        let desc_text = _this.getLangTextFromJson(selectedLangCode, submodelData.json_description);
                        $form.find("input[name=displayName]").val(disp_text);
                        $form.find("input[name=description]").text(desc_text);
                    });
                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);
        }

        submodelToggleNode(node)
        {
            let _this = this;
            /*
            서브모델 하위에 올 수 있는 서브모델 엘리먼트는 
            Property, Collection, File
            */

            let ul = node.parentElement.nextElementSibling;            
            if (ul) {
                ul.classList.toggle('hidden');
                let toggleBtn = node.parentElement.querySelector('.toggle-btn');
                let isHidden = ul.classList.contains('hidden');
                if (isHidden) {
                    toggleBtn.textContent = '+';
                }
                else {
                    toggleBtn.textContent = '-';
                }

                if (toggleBtn.textContent == '-') {
                    let $node = $(node);
                    if ($node.attr('loaded') != '1') {
                        this.submodelElementsRender($node);
                    }
                }
            }
        }

        submodelElementsRender($node) {
            let _this = this;
            let sm_pk = $node.attr('sm_pk');
            let param = { 'action': 'submodel_element_list', sm_pk: sm_pk };
            let $sm_children_ul = this.$aasTree.find('#sm_' + sm_pk);
            $sm_children_ul.empty();

            let fnSuccess = function (result) {
                if (result.success) {
                    let items = result.items;

                    if (items.length == 0) {

                    }

                    let template = kendo.template($('#smeTemplate').html());
                    let smeHtml = template(items);
                    $sm_children_ul.html(smeHtml);

                    $sm_children_ul.find('.sme_prpt_title').on('click', function () {
                        _this.showPropertyDetail($(this), $node);
                    });

                    $sm_children_ul.find('.sme-coll-node').on('click', function () {
                        let $collNode = $(this);
                        if ($collNode.attr('loaded') != "1") {
                            _this.submodelElementsCollectionRender($collNode);
                        }
                        _this.aasToggleNode(this);

                    });
                    $sm_children_ul.find('.sme_collection_title').on('click', function () {
                        _this.showSubmodelElementsCollectionDetail($(this));
                    });

                    $node.attr('loaded', "1");

                }
                else {
                    Alert.alert('조회오류', '서브모델엘리먼트를 가져오지 못했습니다.');
                }
            }

            AjaxUtil.getAsyncData(_this.baseUrl, param, fnSuccess);
        }

        submodelElementsCollectionRender($node) {
            let _this = this;
            let sme_pk = $node.attr('data_pk');
            let param = {
                action: 'submodel_element_collection_items',
                sme_pk: sme_pk
            };

            let fnSuccess = function (result) {
                if (result.success) {

                    let ul = $node[0].parentElement.nextElementSibling;
                    let $children_ul = $(ul);
                    //console.log($children_ul);                    

                    let items = result.items;
                    let template = kendo.template($('#smeTemplate').html());

                    let arrHtml = [];

                    $children_ul.empty();
                    let html = template(items);
                    $children_ul.html(html);
                    $children_ul.find('.sme_prpt_title').on('click', function () {
                        _this.showPropertyDetail($(this), $node);
                    });

                    $children_ul.find('.sme-coll-node').on('click', function () {
                        _this.submodelElementsCollectionRender($(this));
                        _this.aasToggleNode(this);
                    });
                    $children_ul.find('.sme_collection_title').on('click', function () {
                        _this.showSubmodelElementsCollectionDetail($(this));
                    });

                    $node.attr('loaded', "1");
                }
                else {
                    Alert.alert('조회오류', result.message);
                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);
        }

        showSubmodelElementsCollectionDetail($node) {
            let _this = this;
            let data_pk = $node.attr("data_pk");
            this.hideAllDetail();
            this.$div_subcollection_detail.show();
            let $form = this.$div_subcollection_detail.find("form");
            let $lang_code = this.$div_subcollection_detail.find('select[name=lang_code]');
            let param = { action: "submodel_element_collection_detail", data_pk : data_pk};
            let fnSuccess = function (result) {
                if (result.success) {
                    let submodelCollData = result.data;
                    FormUtil.BindDataForm(submodelCollData, $form);

                    $lang_code.off('change').on('change', function () {
                        let selectedLangCode = $lang_code.val();
                        let disp_text = _this.getLangTextFromJson(selectedLangCode, submodelCollData.json_displayname);
                        let desc_text = _this.getLangTextFromJson(selectedLangCode, submodelCollData.json_description);
                        $form.find("input[name=displayName]").val(disp_text);
                        $form.find("input[name=description]").text(desc_text);
                    });


                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);
        }

        // property
        savePropertyElement() {

            //1. 입력항목체크
            //2. 저장하시겠습니까? confirm
            //3. 저장진행

            let $form = this.$div_prpt_detail.find("form");
            let data = FormUtil.extractForm($form);

            let fnSuccess = function (result) {
                if (result.success) {
                    Alert.alert("Property", "저장되었습니다.");
                }else {
                    Alert.alert("저장오류", result.message);
                }
            };

            let url = this.baseUrl + "?action=save_property";
            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        showPropertyDetail($node, $parentNode) {
            let _this = this;
            let data_pk = $node.attr("data_pk");

            console.log("property parent node : ", $parentNode);

            this.hideAllDetail();
            this.$div_prpt_detail.show();
            let $form = this.$div_prpt_detail.find("form");
            let $lang_code = this.$div_prpt_detail.find('select[name=lang_code]');
            let param = { action: 'property_detail', data_pk: data_pk };

            $form[0].reset();

            let fnSuccess = function (result) {
                if (result.success) {
                    let prptData = result.data;
                    FormUtil.BindDataForm(prptData, $form);

                    $lang_code.off('change').on('change', function () {
                        let selectedLangCode = $lang_code.val();
                        let disp_text = _this.getLangTextFromJson(selectedLangCode, prptData.json_displayname);
                        let desc_text = _this.getLangTextFromJson(selectedLangCode, prptData.json_description);
                        $form.find("input[name=displayName]").val(disp_text);
                        $form.find("input[name=description]").text(desc_text);
                    });
                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);
        }


        saveAASData() {
            let _this = this;
            let $form = this.$div_aas_detail.find('form');
            let data = FormUtil.extractForm($form);

            let funcSucc = function (resp) {
                if (resp.success) {
                    $('#id').val(resp.id);
                    Notify.success('저장되었습니다.');
                    _this.resetData();
                    _this.searchMainData();
                } else {
                    Alert.alert('error', resp.message);
                }
            };

            AjaxUtil.postAsyncData(this.baseUrl, data, funcSucc);
        }
      

        showAASTreeList(aasItems) {
            let _this = this;
            let arrHtmls = [];
            this.$aasTree.empty();

            // 시작점
            $.each(aasItems, function (idx, item) {
                let template = kendo.template($("#aasTemplate").html());
                let nodeHtml = template(item);
                arrHtmls.push(nodeHtml);
            });

            let html = arrHtmls.join("");
            this.$aasTree.html(html);


            //let objDetailList = this.$aasTree.find('.aas_detail');
            //console.log(objDetailList);


            this.$aasTree.find('.aas_detail').on('click', function () {
                _this.showAASDetail($(this));
            });

            this.$aasTree.find(".aas-node").on('click', function () {
                _this.aasToggleNode(this);
            });

            this.$aasTree.find('.submodel_detail').on('click', function () {
                _this.showSubmodelDetail($(this));
            });

            this.$aasTree.find('.submodel-node').on('click', function () {
                _this.submodelToggleNode(this);
            });
        }

        searchMainData() {

            let _this = this;
            let param = {
                action: 'aas_read',
                keyword: $('#keyword').val(),
            };

            let fnSuccess = function (result) {

                if (result.success) {
                    _this.showAASTreeList(result.items);
                }
                else {
                    Alert.alert('조회오류', result.message);
                }
                
            };

            AjaxUtil.getAsyncData(_this.baseUrl, param, fnSuccess);
        }

    };

    let page = new AASPage();

    $(document).ready(function () { 
        page.searchMainData();
    });

    function toggleNode(node) {
        let childUl = node.nextElementSibling;
        if (childUl) {
            childUl.classList.toggle('hidden');
            let toggleBtn = node.querySelector('.toggle-btn');
            toggleBtn.textContent = childUl.classList.contains('hidden') ? '+' : '-';
        }
    }
</script>

{% endblock %}