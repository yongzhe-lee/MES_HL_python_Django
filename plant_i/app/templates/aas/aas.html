{% extends "app/layout.html" %}
{% block css %}

<style>
    .aas-panel {
        height: calc(100vh - 110px);
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrap">
    <div class="content-ui-row">
        <form class="search-form" id="searchForm">
            <div class="card-content search">
                <!-- 개발자 수동 적용, grid-template-columns:1fr 1fr 1fr auto  -->
                <div class="form-ui">
                    <div class="col-auto">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="keyword" data-labelCd="검색어">검색어</label>
                            <div class="field-wrapper">
                                <input id="keyword" name="keyword" placeholder="AAS 이름 검색" />
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="card-group-btn search">
                            <button id="btnSearch" class="btn-search" data-labelCd="Search" title="조회">조회</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="left-panel aas-panel">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">list_alt</i><label data-labelCd="AAS목록">AAS목록</label></span>
                <div>
                    <button id="btnAddRoot" type="button" title="AAS등록" tabindex="0" class="y_write_auth"></button>
                    <button id="btnAdminManage" type="button" title="Ver, Rev관리" class="y_write_auth"></button>
                </div>
            </div>
            <ul class="tree" id="aas_tree"></ul>
        </div>
        <!--초기로딩시 보여주는 빈화면-->
        <div class="right-panel aas-panel" id="div_dummy"></div>

        <div class="right-panel aas-panel" id="div_aas_detail" style="display: none;">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i>AAS상세입력</span>
                <span>
                    <button type="button" name="save" title="저장" class="y_write_auth"></button>
                    <button type="button" name="delete" title="삭제" class="y_write_auth"></button>
                    <button type="button" name="add_child" title="하위항목선택등록" class="y_write_auth"></button>
                </span>
            </div>
            <form>
                <input type="hidden" id="p_aas_pk" name="p_aas_pk" />
                <input type="hidden" id="aas_pk" name="aas_pk" value="" />
                <div class="right-panel-content">
                    <div class="aas-info">
                        <div class="aas-input-group" style="display:flex">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위AAS">상위AAS</label>
                            <input name="p_display_name" class="form-control aas-form-control" placeholder="부모없음(최상위)" readonly />

                        </div>
                    </div>
                    <hr />
                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id_short" data-labelCd="id Short">id Short</label>
                            <input name="id_short" class="form-control aas-form-control" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id" data-labelCd="id">id</label>
                            <input name="id" class="form-control aas-form-control" />
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="displayName" data-labelCd="Display name">Display name</label>
                            <input name="displayName" class="form-control aas-form-control" placeholder="이름입력" />
                            <select name="lang_code" class="form-control aas-form-control">
                                <option value="ko-KR">한글</option>
                                <option value="en-US">English</option>
                            </select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="description" data-labelCd="비고">비고</label>
                            <textarea name="description" class="form-control aas-form-control"></textarea>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label" data-labelCd="작성일">작성일</label>
                            <input name="created" placeholder="YYYY-MM-DD hh:mm:ss" class="form-control aas-form-control" readonly="readonly" />
                            <input name="creator" placeholder="creator" class="form-control aas-form-control" />
                        </div>

                    </div>
                </div>
                <div class="right-panel-content">
                    <div class="card-group-btn">
                        <span class="info-text"><i class="material-symbols-outlined">edit_square</i>Administration</span>
                    </div>

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" data-labelCd="Version">Version</label>
                            <input name="version" placeholder="version" class="form-control aas-form-control" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" data-labelCd="Revison">Revison</label>
                            <input name="revision" placeholder="revision" class="form-control aas-form-control" />
                        </div>
                    </div>
                </div>
                <div id="divAssetInfo" class="right-panel-content" style="display:none">
                    <hr />
                    <div class="card-group-btn">
                        <span class="info-text"><i class="material-symbols-outlined">edit_square</i>Asset Information</span>
                    </div>

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="asset_kind" data-labelCd="Asset Kind">Asset Kind</label>
                            <select id="asset_kind" name="asset_kind" class="form-control aas-form-control" disabled></select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="globalAssetId" data-labelCd="Asset Type">Asset Type</label>
                            <select id="asset_type" name="asset_type" class="form-control aas-form-control" disabled></select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="globalAssetId" data-labelCd="Grobal Asset ID">Grobal Asset ID</label>
                            <input name="globalAssetId" class="form-control aas-form-control" readonly />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label ">Thumbnail</label>
                            <img src="/static/img/no-image.png" id="imgAASThumbnail" />
                        </div>
                    </div>

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="globalAssetId" data-labelCd="Specific Asset IDs">Specific Asset IDs</label>
                            <div id="specificAsssetIds_grid"></div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="right-panel aas-panel" id="div_submodel_detail" style="display: none;">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i><label data-labelCd="Submodel">Submodel</label></span>
                <span>
                    <button name="clear"><i class="material-symbols-outlined">refresh</i></button>
                    <button name="save" class="y_write_auth"><i class="material-symbols-outlined">save</i></button>
                    <button name="delete" class="y_write_auth"><i class="material-symbols-outlined">delete</i></button>
                    <button name="add_child" class="y_write_auth"><i class="material-symbols-outlined">format_list_bulleted_add</i></button>
                </span>
            </div>
            <form>
                <input type="hidden" name="sm_pk" value="" />
                <input type="hidden" name="aas_pk" value="" />
                <div class="right-panel-content">
                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위AAS">상위AAS</label>
                            <input name="p_display_name" class="form-control aas-form-control" readonly />

                        </div>
                    </div>
                    <hr />
                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id_short" data-labelCd="id Short">id Short</label>
                            <input name="id_short" class="form-control aas-form-control" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id" data-labelCd="id">id</label>
                            <input name="id" class="form-control aas-form-control" readonly placeholder="자동생성" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="model_kind" data-labelCd="적용범위">적용범위</label>
                            <select name="model_kind" class="form-control aas-form-control">
                                <option value="Template">재사용(공유, Template)</option>
                                <option value="Instance">특정자산(전용, Instance)</option>
                            </select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="category" data-labelCd="카테고리">카테고리</label>
                            <select name="category" class="form-control aas-form-control">
                                <option value="CONSTANT">변하지 않는 값 (예: 제조사, 모델번호 등)	제조사 정보, 고정 사양</option>
                                <option value="PARAMETER">파라미터</option>
                                <option value="DOCUMENT">문서</option>
                                <option value="EVENT">이벤트</option>
                            </select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="semantic_id" data-labelCd="Semantic ID">Semantic ID</label>
                            <input name="semantic_id" class="form-control aas-form-control" readonly />
                            <button type="button" class="btn-search" name="btnShowPopupSemanticId">입력</button>
                            <div style="display:none"><input name="semantic_ref_pk" class="form-control aas-form-control" readonly /></div>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="displayName" data-labelCd="Display name">Display name</label>
                            <input name="displayName" class="form-control aas-form-control" placeholder="이름입력" />
                            <select name="lang_code" class="form-control aas-form-control">
                                <option value="ko-KR">한글</option>
                                <option value="en-US">English</option>
                            </select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="description" data-labelCd="비고">비고</label>
                            <textarea name="description" class="form-control aas-form-control"></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="right-panel aas-panel" id="div_subcollection_detail" style="display: none;">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i><label data-labelCd="SubmodelElement Collection">SubmodelElement Collection</label></span>
                <span>
                    <button name="clear"><i class="material-symbols-outlined">refresh</i></button>
                    <button name="save" class="y_write_auth"><i class="material-symbols-outlined">save</i></button>
                    <button name="delete" class="y_write_auth"><i class="material-symbols-outlined">delete</i></button>
                    <button name="add_child" class="y_write_auth"><i class="material-symbols-outlined">format_list_bulleted_add</i></button>
                </span>
            </div>
            <form>
                <input type="hidden" name="p_sme_pk" value="" />
                <input type="hidden" name="p_sm_pk" value="" />
                <input type="hidden" name="sme_pk" value="" />

                <div class="right-panel-content">

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위">상위</label>
                            <input name="p_display_name" class="form-control aas-form-control" readonly />
                        </div>
                    </div>
                    <hr />

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id_short" data-labelCd="id Short">id Short</label>
                            <input name="id_short" class="form-control aas-form-control" />
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="displayName" data-labelCd="Display name">Display name</label>
                            <input name="displayName" class="form-control aas-form-control" placeholder="이름입력" />
                            <select name="lang_code" class="form-control aas-form-control">
                                <option value="ko-KR">한글</option>
                                <option value="en-US">English</option>
                            </select>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="model_kind" data-labelCd="적용범위">적용범위</label>
                            <select name="model_kind" class="form-control aas-form-control">
                                <option value="Template">재사용(공유, Template)</option>
                                <option value="Instance">특정자산(전용, Instance)</option>
                            </select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="semantic_id" data-labelCd="Semantic ID">Semantic ID</label>
                            <input name="semantic_id" class="form-control aas-form-control" readonly />
                            <button type="button" class="btn-search" name="btnShowPopupSemanticId">입력</button>
                            <div style="display:none"><input name="semantic_ref_pk" class="form-control aas-form-control" readonly /></div>
                        </div>


                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="description" data-labelCd="비고">비고</label>
                            <textarea name="description" class="form-control aas-form-control"></textarea>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="displayName" data-labelCd="생성일">생성일</label>
                            <input name="created" class="form-control aas-form-control" />
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="right-panel aas-panel" id="div_prpt_detail" style="display: none;">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i><label data-labelCd="Property Element">Property Element</label></span>
                <span>
                    <button name="clear"><i class="material-symbols-outlined">refresh</i></button>
                    <button name="save" class="y_write_auth"><i class="material-symbols-outlined">save</i></button>
                    <button name="delete" class="y_write_auth"><i class="material-symbols-outlined">delete</i></button>
                </span>
            </div>
            <div class="right-panel-content">
                <form>
                    <input type="hidden" name="p_sme_pk" value="" />
                    <input type="hidden" name="p_sm_pk" value="" />
                    <input type="hidden" name="sme_pk" value="" />

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위">상위</label>
                            <input name="p_display_name" class="form-control aas-form-control" readonly />
                        </div>
                    </div>
                    <hr />

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="id_short" data-labelCd="id Short">id Short</label>
                            <input name="id_short" class="form-control aas-form-control" />
                        </div>


                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="displayName" data-labelCd="Display name">Display name</label>
                            <input name="displayName" class="form-control aas-form-control" placeholder="이름입력" />
                            <select name="lang_code" class="form-control aas-form-control">
                                <option value="ko-KR">한글</option>
                                <option value="en-US">English</option>
                            </select>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="description" data-labelCd="비고">비고</label>
                            <textarea name="description" class="form-control aas-form-control"></textarea>
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="category" data-labelCd="Category">Category</label>
                            <input name="category" class="form-control aas-form-control" placeholder="category" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="model_kind" data-labelCd="적용범위">적용범위</label>
                            <select name="model_kind" class="form-control aas-form-control">
                                <option value="Template">재사용(공유, Template)</option>
                                <option value="Instance">특정자산(전용, Instance)</option>
                            </select>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="valueType" data-labelCd="Value Type">Value Type</label>
                            <select name="valueType" class="form-control aas-form-control">
                                <option value="xs:anyURI">xs:anyURI</option>
                                <option value="xs:base64Binary">xs:base64Binary</option>
                                <option value="xs:boolean">xs:boolean</option>
                                <option value="xs:byte">xs:byte</option>
                                <option value="xs:date">xs:date</option>
                                <option value="xs:dateTime">xs:dateTime</option>
                                <option value="xs:decimal">xs:decimal</option>
                                <option value="xs:double">xs:double</option>
                                <option value="xs:duration">xs:duration</option>
                                <option value="xs:gDay">xs:gDay</option>
                                <option value="xs:gMonth">xs:gMonth</option>
                                <option value="xs:gMonthDay">xs:gMonthDay</option>
                                <option value="xs:gYearMonth">xs:gYearMonth</option>
                                <option value="xs:float">xs:float</option>
                                <option value="xs:hexBinary">xs:hexBinary</option>
                                <option value="xs:int">xs:int</option>
                                <option value="xs:integer">xs:integer</option>
                                <option value="xs:long">xs:long</option>
                                <option value="xs:negativeInteger">xs:negativeInteger</option>
                                <option value="xs:nonNegativeInteger">xs:nonNegativeInteger</option>
                                <option value="xs:nonPositiveInteger">xs:nonPositiveInteger</option>
                                <option value="xs:positiveInteger">xs:positiveInteger</option>
                                <option value="xs:short">xs:short</option>
                                <option value="xs:string">xs:string</option>
                                <option value="xs:time">xs:time</option>
                                <option value="xs:unsignedByte">xs:unsignedByte</option>
                                <option value="xs:unsigendInt">xs:unsigendInt</option>
                                <option value="xs:unsignedLong">xs:unsignedLong</option>
                                <option value="xs:unsignedShort">xs:unsignedShort</option>
                            </select>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="value" data-labelCd="Value">Value</label>
                            <input name="value" class="form-control aas-form-control" />
                        </div>
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="value_id" data-labelCd="Value ID">Value ID</label>
                            <input name="value_id" class="form-control aas-form-control" /> <button type="button" class="btn-search" name="btnShowPopupPrptValueID">입력</button>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="semantic_id" data-labelCd="Semantic ID">Semantic ID</label>
                            <input name="semantic_id" class="form-control aas-form-control" readonly />
                            <button type="button" class="btn-search" name="btnShowPopupSemanticId">입력</button>
                            <div style="display:none"><input name="semantic_ref_pk" class="form-control aas-form-control" readonly /></div>
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="displayName" data-labelCd="Qualifier">Qualifier</label>
                            <!--type, valuetype, value-->
                        </div>

                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="displayName" data-labelCd="생성일">생성일</label>
                            <input name="created" class="form-control aas-form-control" readonly />
                        </div>

                    </div>
                </form>
            </div>
        </div>

        <div class="right-panel aas-panel" id="div_file_detail" style="display: none;">
            <div class="card-group-btn">
                <span class="info-text"><i class="material-symbols-outlined">edit_square</i><label data-labelCd="File Element">File Element</label></span>
                <span>
                    <button name="clear"><i class="material-symbols-outlined">refresh</i></button>
                    <button name="save" class="y_write_auth"><i class="material-symbols-outlined">save</i></button>
                    <button name="delete" class="y_write_auth"><i class="material-symbols-outlined">delete</i></button>
                </span>
            </div>
            <div class="right-panel-content">
                <form>
                    <input type="hidden" name="p_sme_pk" value="" />
                    <input type="hidden" name="p_sm_pk" value="" />
                    <input type="hidden" name="sme_pk" value="" />

                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위">상위</label>
                            <input name="p_display_name" class="form-control aas-form-control" readonly />
                        </div>
                    </div>
                    <hr />

                    <div class="aas-input-group">
                        <label class="k-label k-form-label essential" for="id_short" data-labelCd="id Short">id Short</label>
                        <input name="id_short" class="form-control aas-form-control" />
                    </div>
                    <div class="aas-input-group">
                        <label class="k-label k-form-label essential" for="category" data-labelCd="Category">Category</label>
                        <input name="category" class="form-control aas-form-control" placeholder="category" />
                    </div>
                    <div class="aas-input-group">
                        <label class="k-label k-form-label" for="model_kind" data-labelCd="적용범위">적용범위</label>
                        <select name="model_kind" class="form-control aas-form-control">
                            <option value="Template">재사용(공유, Template)</option>
                            <option value="Instance">특정자산(전용, Instance)</option>
                        </select>
                    </div>

                    <div class="aas-input-group">
                        <label class="k-label k-form-label essential" for="displayName" data-labelCd="Display name">Display name</label>
                        <input name="displayName" class="form-control aas-form-control" placeholder="이름입력" />
                        <select name="lang_code" class="form-control aas-form-control">
                            <option value="ko-KR">한글</option>
                            <option value="en-US">English</option>
                        </select>
                    </div>
                    <div class="aas-input-group">
                        <label class="k-label k-form-label" for="description" data-labelCd="비고">비고</label>
                        <textarea name="description" class="form-control aas-form-control"></textarea>
                    </div>
                    <div class="aas-info">
                        <div class="aas-input-group">
                            <label class="k-label k-form-label essential" for="file_element" data-labelCd="File">File</label>
                            <input name="file_element" type="file" class="form-control aas-form-control" />
                            <div id="divFileElement">

                            </div>
                        </div>
                    </div>

                    <div class="aas-input-group">
                        <label class="k-label k-form-label" data-labelCd="작성일">작성일</label>
                        <input name="created" placeholder="YYYY-MM-DD hh:mm:ss" class="form-control aas-form-control" readonly="readonly" />
                        <input name="creator" placeholder="creator" class="form-control aas-form-control" />
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<!--팝업템플리드-->
<div id="tmplAASSubItemChoice" class="content-wrap popup" style="display:none">
    <div class="content-ui-row">
        <div class="card-content edit">
            <form>
                <input type="hidden" name="p_sme_pk" value="" />
                <input type="hidden" name="p_sm_pk" value="" />

                <div class="edit-form-ui">
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위AAS">상위AAS</label>
                            <div class="field-wrapper">
                                <input type="text" name="p_display_name" class="form-control" readonly />
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="cboAASSubItemType" data-labelCd="항목구분">항목구분</label>
                            <div class="field-wrapper" style="display:flex">
                                <select id="cboAASSubItemType">
                                    <option value="submodel">SUBMODEL</option>
                                    <option value="aas">AAS</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="edit-form-ui">
                <div class="col-12">
                    <hr />
                </div>
                <button type="button" id="btnSelectAASSubType" class="btn-search">선택</button>
            </div>
        </div>
    </div>
</div>

<div id="tmplPopupSubmodelElementSelection" class="content-wrap popup" style="display:none">
    <div class="content-ui-row">
        <div class="card-content edit">
            <form>
                <input type="hidden" name="parentType" value="" />
                <input type="hidden" name="p_sme_pk" value="" />
                <input type="hidden" name="p_sm_pk" value="" />

                <div class="edit-form-ui">
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="상위Submodel">상위Submodel</label>
                            <div class="field-wrapper">
                                <input type="text" name="p_display_name" class="form-control" readonly />
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="submodelelement_type" data-labelCd="항목구분">항목구분</label>
                            <div class="field-wrapper" style="display:flex">
                                <select name="submodelelement_type" class="form-control">
                                    <option value="PropertyElement">Property Element</option>
                                    <option value="FileElement">File Element</option>
                                    <option value="SubmodelElementCollection">SubmodelElement Collection</option>

                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="edit-form-ui">
                <div class="col-12">
                    <hr />
                </div>
                <button type="button" name="btnSelectSubmodelElementType" class="btn-search">선택</button>
            </div>
        </div>
    </div>
</div>

<div id="tmplPopupSemanticIdSearch" class="content-wrap popup" style="display:none">
    <div class="content-ui-row">
        <div class="card-content edit">
            <form>
                <div class="edit-form-ui">
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="p_display_name" data-labelCd="SubModel">SubModel</label>
                            <div class="field-wrapper">
                                <input type="text" name="p_display_name" class="form-control" readonly />
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="reference_type" data-labelCd="Reference Type">Reference Type</label>
                            <div class="field-wrapper">
                                <select name="reference_type" class="form-control">
                                    <option value="ConceptDescription">ConceptDescription</option>
                                    <option value="ExternalReference">ExternalReference</option>
                                    <option value="GlobalReference">GlobalReference</option>
                                    <option value="ModelReference">ModelReference</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="edit-form-ui">
                    <div class="col-12">
                        <hr />
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="key_type" data-labelCd="Key Type">Key Type</label>
                            <div class="field-wrapper">
                                <select name="key_type" class="form-control">
                                    <option value="GlobalReference">GlobalReference</option>
                                    <option value="AssetAdministrationShell">AssetAdministrationShell</option>
                                    <option value="Submodel">Submodel</option>
                                    <option value="SubmodelElement">SubmodelElement</option>
                                    <option value="BlobElement">Blob</option>
                                    <option value="FileElement">File</option>
                                    <option value="FragmentReference">FragmentReference</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="local" data-labelCd="Local">Local</label>
                            <div class="field-wrapper">
                                <select name="local" class="form-control">
                                    <option value="Y">Yes</option>
                                    <option value="N">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="value" data-labelCd="Value">Value</label>

                            <div class="field-wrapper">
                                <input type="text" name="value" class="form-control" />
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <hr />
                    </div>
                    <div class="col-12">
                        <button type="button" name="btnSemanticIdSelect" class="btn-search">입력완료</button>
                    </div>
                </div>
            </form>        
        </div>
    </div>
</div>

{% verbatim %}
<script type="text/x-kendo-template" id="aasTemplate">
    <li>
    # if(sub_items.length>0) { #
        <div class="tree-node">
            <span class="toggle-btn aas-node">-</span>
            <i class="material-symbols-outlined folder-open">folder_open</i>
            <span class="aas-title">#: gubun # </span>
            <span class="aas_detail" aas_pk="#=aas_pk#" gubun="aas">#: displayName #</span>
            <span class="aas-time"> #: created #</span>
        </div>
        <ul id="aas_sub_#=aas_pk#">
        #
        for(let idx=0; idx<sub_items.length;idx++) {
         let item = sub_items[idx];
         let gubun = item.gubun;
        #
         # if(gubun=="aas"){ #
            <div class="tree-node">
                <span class="toggle-btn aas-node">-</span><i class="material-symbols-outlined folder-open">folder_open</i>
                <span class="aas-title">#: item.gubun # </span>
                <span class="aas_detail" aas_pk="#=item.aas_pk#" gubun="aas">#: item.displayName #</span>
                <span class="aas-time"> (#:item.id_short #) , #: item.created #</span>
            </div>
            # if(item.sub_items.length>0) {#
                <ul id="aas_sub_#=item.aas_pk#">
                    #
                    for(let sidx=0;sidx<item.sub_items.length; sidx++){
                      let sm_item = item.sub_items[sidx];
                       if (sm_item.gubun=="aas") {
                    #

                    #
                       }
                       else {
                    #
                        <li>
                            <div class="tree-node">
                                <span class="toggle-btn submodel-node" sm_pk="#=sm_item.sm_pk#" >+</span>
                                <i class="material-symbols-outlined folder-open">folder</i>
                                <span class="sub-title"> #: sm_item.gubun # </span>
                                <span class="submodel_detail" sm_pk="#=sm_item.sm_pk#" gubun="#= sm_item.gubun #" aas_pk="#=item.aas_pk#">#: sm_item.displayName # </span>
                                <span class="aas-time">(#: sm_item.id_short #) #: sm_item.created #</span>
                            </div>
                            <ul id="sm_#=sm_item.sm_pk#" class="hidden"></ul>
                        </li>
                    #
                       }
                    #
                    # } #

                </ul>
            # } #
         # } else { #

            <li>
                <div class="tree-node">
                    <span class="toggle-btn submodel-node" gubun="#= item.gubun #" sm_pk="#=item.sm_pk#" >+</span>
                    <i class="material-symbols-outlined folder-open">folder</i>
                    <span class="sub-title"> #: item.gubun # </span>
                    <span class="submodel_detail" gubun="#= item.gubun #" sm_pk="#=item.sm_pk#" aas_pk="#=item.aas_pk#">#: item.displayName # </span>
                    <span class="aas-time"> #: item.created #</span>
                </div>
                <ul id="sm_#=item.sm_pk#" class="hidden"></ul>
            </li>

         # } #
        # } #
        </ul>
    # } else { #
        <div class="tree-node">
            <span class="toggle-btn aas-node"></span>
            <i class="material-symbols-outlined folder-open">folder_open</i>
            <span class="aas-title">#: gubun # </span>
            <span class="aas_detail" aas_pk="#=aas_pk#" gubun="aas">#: displayName #</span>
            <span class="aas-time">(#:id_short #) ,  #: created #</span>
        </div>
    # } #
    </li>
</script>

<script type="text/x-kendo-template" id="smeTemplate">
     # for (let i=0;i<data.length; i++) { 
           let item = data[i]; 
     #
      <li>
          # if (item.gubun =='prop'){ #
              <ul class="tree-node">
                  <li>
                      <span class="prop-title">Prop</span>
                      <span class="sme_prpt_detail" data_pk="#=item.sme_pk#" gubun="#= item.gubun #">#= item.displayName # = #=item.prpt_value#</span>
                      <span class="aas-time"> (#= item.created #)</span>
                  </li>
              </ul>
          # } #
          # if (item.gubun =='file'){ #
              <ul class="tree-node">
                  <li>
                      <span class="prop-title">File</span>
                      <span class="sme_file_detail" data_pk="#=item.sme_pk#" gubun="#= item.gubun #">#= item.displayName #</span>
                      <span class="aas-time"> (#= item.created #)</span>
                  </li>
              </ul>
          # } #

         # if (item.gubun =='coll') { #
              <div class="tree-node">
                  <span class="toggle-btn sme-coll-node" data_pk="#=item.sme_pk#">+</span>
                  <i class="material-symbols-outlined folder">folder</i>
                  <span class="sub-title"> #: item.gubun # </span>
                  <span class="sme_collection_detail" gubun="#=item.gubun#" data_pk="#=item.sme_pk#">#: item.displayName # </span>
                  <span class="aas-time"> #: item.created #</span>
              </div>
              <ul class="hidden"></ul>
         # } #
    </li>
     # } #
</script>
{% endverbatim %}
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    class AASPage {
        constructor() {
            this.grid = null;
            this.baseUrl = '/api/aas/aasgui';
            this.$aasTree = $('#aas_tree');

            this.$tmplAASSubItemChoiceWin = null;
            this.$div_dummy = $('#div_dummy');
            this.$div_aas_detail = $('#div_aas_detail');
            this.$div_submodel_detail = $('#div_submodel_detail');
            this.$div_subcollection_detail = $('#div_subcollection_detail');
            this.$div_prpt_detail = $('#div_prpt_detail');
            this.$div_file_detail = $('#div_file_detail');
            
            this.$tmplPopupSemanticIdSearchWin = null;
            this.init();
            this.initTree();
            this.initAAS();
            this.initSubModel();
            this.initSubmodelItemCollection();
            this.initPropertyElement();
            this.initFileElement();
            this.initSemanticIDPopup();
        }

        initSemanticIDPopup() {
            let _this = this;
            // Submodel Semantic ID 입력팝업화면
            this.$tmplPopupSemanticIdSearchWin = $('#tmplPopupSemanticIdSearch').kendoWindow({
                width: "700", // windowWidth
                height: "500",
                title: "Semantic ID 등록",
                visible: false,
                actions: ["Close"],
                close: () => {
                    // 별도 구현, 여기에 구현하면 안됨
                }
            });

            //reference_type, key_type
            this.$tmplPopupSemanticIdSearchWin.find('select[name=reference_type]').kendoDropDownList();
            this.$tmplPopupSemanticIdSearchWin.find('select[name=key_type]').kendoDropDownList();
      
            // Submodel Semantic ID 입력팝업화면에서 선택완료 버튼클릭
            let $btn = this.$tmplPopupSemanticIdSearchWin.find('button[name=btnSemanticIdSelect]');
            $btn.on("click", function () {
                if (_this.fnSemanticIDSelectCallback) {
                    let callback = function () { };
                    _this.callbackSemanticIdSelect(callback);
                }
            });
        }
        
        callbackSemanticIdSelect(fnCallback) {
            if (fnCallback) {
                fnCallback();
            }
        }

        // 공통함수->Semantic ID 입력시 사용
        showPopupSemanticIdSelection(p_display_name) {
            let _this = this;
            let $form = this.$tmplPopupSemanticIdSearchWin.find("form");
            $form[0].reset();
            this.$tmplPopupSemanticIdSearchWin.find('input[name=p_display_name]').val(p_display_name);
            this.$tmplPopupSemanticIdSearchWin.data("kendoWindow").center().open(); 
        }

        hideAllDetail() {
            $.each(this.divItems, function (idx, item) {
                item.hide();
            });
        }

        initTree() {
            let _this = this;
            // 최상위 AAs 추가
            $('#btnAddRoot').kendoButton({
                icon: 'plus',
                themeColor: "base",
                click: function () {
                    _this.addRootNode();
                }
            });

            this.$btnAdminManage = $('#btnAdminManage').kendoButton({
                icon: 'eye',
                themeColor: "base",
                click: function () {
                    _this.showManagement();//버전 리비젼 관리
                }
            });
        }

        init() {
            let _this = this;
            this.divItems = [this.$div_dummy, this.$div_aas_detail, this.$div_submodel_detail, this.$div_subcollection_detail, this.$div_prpt_detail, this.$div_file_detail];

            //search form
            $('#keyword').kendoTextBox();
            $('#keyword').keypress(function (e) {
                // Enter(=13)키가 눌렸을 때, 기본 동작 방지 후 searchMainData 호출
                if (e.keyCode == 13) {
                    e.preventDefault();
                    _this.searchMainData();
                }
            });

            //form button
            $('#btnSearch').kendoButton({
                icon: "search",
                themeColor: "base",
                click: function () {
                    _this.searchMainData();
                }
            });

            // AAS에서 하위 모델 (aas, submodel )선택하는 팝업
            this.$tmplAASSubItemChoiceWin = $('#tmplAASSubItemChoice').kendoWindow({
                width: "500", // windowWidth
                height: "300",
                title: "AAS하위항목 선택등록",
                visible: false,
                actions: ["Close"],
                close: () => {
                    // 별도 구현, 여기에 구현하면 안됨
                }
            });

            // Submodel, SubmodelElementCollection에서 SubmodelElement 추가시 선택하는 팝업
            this.$tmplSubmodelElementSelectionWin = $('#tmplPopupSubmodelElementSelection').kendoWindow({
                width: "500", // windowWidth
                height: "300",
                title: "SubmodelElement 선택등록",
                visible: false,
                actions: ["Close"],
                close: () => {
                    // 별도 구현, 여기에 구현하면 안됨
                }
            });

            this.$tmplSubmodelElementSelectionWin.find("select[name=submodelelement_type]").kendoDropDownList();

            // 서브모델 하위추가
            this.$tmplSubmodelElementSelectionWin.find("button[name=btnSelectSubmodelElementType]").on('click', function (e) {
                _this.selectSubmodelElementType();
            });

        }

        initAAS() {
            let _this = this;
            this.$div_aas_detail.find("button[name=save]").kendoButton({
                icon: 'save',
                themeColor: "info",
                click: function () {
                    Alert.confirm("AAS저장", "저장하시겠습니까?", function () {
                        _this.saveAASData();
                    });
                }
            });

            this.$div_aas_detail.find("button[name=delete]").kendoButton({
                icon: 'trash',
                themeColor: "error",
                click: function () {
                    let $form = _this.$div_aas_detail.find('form');

                }
            });

            this.$div_aas_detail.find("button[name=add_child]").kendoButton({
                icon: 'insert-bottom',
                themeColor: "info",
                click: function () {
                    // AAS 하위등록시 AAS, submodel 인지 선택하여 등록할 수 있게 한다.
                    // 선택팝업 오픈
                    _this.$tmplAASSubItemChoiceWin.data("kendoWindow").center().open();
                }
            });

            let $cboAASSubItemType = $('#cboAASSubItemType').kendoDropDownList({
                dataTextField: "text",
                dataValueField: "value"
            });

            // 하위항목유형 선택버튼 클릭시 aas, submodel에 따라 분기처리
            $('#btnSelectAASSubType').kendoButton({
                icon: 'insert-bottom',
                themeColor: "info",
                click: function () {

                    _this.$tmplAASSubItemChoiceWin.data("kendoWindow").close();
                    let aasSubType = $cboAASSubItemType.val();
                    let $aas_form = _this.$div_aas_detail.find('form');
                    let p_display_name = $aas_form.find("input[name=displayName]").val();
                    let p_aas_pk = $aas_form.find("input[name=aas_pk]").val();
                    if (aasSubType == "aas") {
                        $aas_form[0].reset();
                        $aas_form.find('input[name=aas_pk]').val("");
                        $aas_form.find("input[name=p_display_name]").val(p_display_name);
                        $aas_form.find('input[name=p_aas_pk]').val(p_aas_pk);
                    } else if (aasSubType == "submodel") {
                        let $form = _this.$div_submodel_detail.find('form');
                        $form[0].reset();
                        $form.find('input[name=sm_pk]').val('');
                        $form.find('input[name=aas_pk]').val(p_aas_pk);
                        $form.find('input[name=p_display_name]').val(p_display_name);
                        _this.hideAllDetail();
                        _this.$div_submodel_detail.show();
                    }
                }
            });

            let option = {
                columns: [
                    { field: "name", title: "Name", width: 80 },
                    { field: "value", title: "Value", width: 100 },
                ],
                change: function (e) {

                },
                dataBound: function (e) {
                    kendoUtil.showGridRowCount(this.element);
                },
                height: "150px"
            };

            this.specificAsssetIdsGrid = new Grid($("#specificAsssetIds_grid"), option);

        }

        selectSubmodelElementType() {
            let _this = this;
            let $form = null;
            let $popupForm = this.$tmplSubmodelElementSelectionWin.find("form");
            let parentType = $popupForm.find("input[name=parentType]").val();
            let submodelelement_type = $popupForm.find("select[name=submodelelement_type]").val();            
            let p_sm_pk = $popupForm.find("input[name=p_sm_pk]").val();
            let p_sme_pk = $popupForm.find("input[name=p_sme_pk]").val();
            let p_display_name = $popupForm.find("input[name=p_display_name]").val();

            switch (submodelelement_type) {
                case "PropertyElement":
                    _this.hideAllDetail();
                    $form = _this.$div_prpt_detail.find("form");
                    $form[0].reset();
                    $form.find('input[name=p_sm_pk]').val(p_sm_pk);
                    $form.find('input[name=sme_pk]').val("");
                    $form.find('input[name=p_sme_pk]').val(p_sme_pk);
                    $form.find("input[name=p_display_name]").val(p_display_name);

                    _this.$div_prpt_detail.show();
                    break;
                case "FileElement":
                    _this.hideAllDetail();
                    $form = _this.$div_file_detail.find("form");
                    $form[0].reset();
                    $form.find('input[name=p_sm_pk]').val(p_sm_pk)
                    $form.find('input[name=sme_pk]').val("")
                    $form.find('input[name=p_sme_pk]').val(p_sme_pk);
                    $form.find("input[name=p_display_name]").val(p_display_name);

                    _this.$div_aas_detail.find("#divFileElement").empty();


                    _this.$div_file_detail.show();
                    break;
                case "SubmodelElementCollection":
                    _this.hideAllDetail();
                    $form = _this.$div_subcollection_detail.find("form");
                    $form[0].reset();
                    $form.find('input[name=p_sm_pk]').val(p_sm_pk)
                    $form.find('input[name=sme_pk]').val("")
                    $form.find('input[name=p_sme_pk]').val(p_sme_pk);
                    $form.find("input[name=p_display_name]").val(p_display_name);

                    _this.$div_subcollection_detail.show();
                    break;
                default:
                    Alert.alert("Submodel Element Type오류", "submodelelement_type");
                    break;
            }

            _this.$tmplSubmodelElementSelectionWin.data("kendoWindow").close();
        }

        ///////////////////////////////////////////////////////////////////////////////
        // Submodel
        initSubModel() {

            let _this = this;
            let $submodel_form = _this.$div_submodel_detail.find('form');
            this.$div_submodel_detail.find("button[name=clear]").kendoButton({
                themeColor: "base",
                click: function () {
                    $submodel_form[0].reset();
                }
            });

            this.$div_submodel_detail.find("button[name=save]").kendoButton({
                themeColor: "info",
                click: function () {
                    Alert.confirm("Submodel 저장", "저장하시겠습니까?", function () {
                        _this.saveSubmodel();
                    });
                }
            });

            this.$div_submodel_detail.find("button[name=delete]").kendoButton({
                themeColor: "error",
                click: function () {
                    //상위 AAS에서 대해서 배제 혹은 데이터 자체삭제
                }
            });

            // 서브모델 하위 항목 추가
            this.$div_submodel_detail.find("button[name=add_child]").kendoButton({
                themeColor: "info",
                click: function () {
                    // submodelelement(PropertyElement, FileElement..),submodelelementcollection 등등을 선택할 수 있는 팝업을 생성
                    // 팝업창에서 상위 부모 이름 설정
                    let sm_pk = $submodel_form.find("input[name=sm_pk]").val();
                    let p_display_name = $submodel_form.find("input[name=displayName]").val();

                    let $popupForm = _this.$tmplSubmodelElementSelectionWin.find("form")

                    $popupForm.find("input[name=p_display_name]").val(p_display_name);
                    $popupForm.find("input[name=parentType]").val("submodel");

                    
                    if (!sm_pk) {
                        Alert.alert("Submodel 하위항목추가 오류", "Submodel을 저장후에 하위항목을 추가할 수 있습니다.");
                        return;
                    }

                    $popupForm.find("input[name=p_sm_pk]").val(sm_pk);
                    $popupForm.find("input[name=p_sme_pk]").val("");
                    _this.$tmplSubmodelElementSelectionWin.data("kendoWindow").center().open();
                }
            });

            // Submodel 입력 화면에서 Semantic ID 팝업입력 버튼 클릭
            this.$div_submodel_detail.find("button[name=btnShowPopupSemanticId]").on('click', function (e) {
                let parentDisplayName= $submodel_form.find("input[name=displayName]").val()
                _this.showPopupSemanticIdSelection(parentDisplayName);
            });
        }

        initSubmodelItemCollection() {
            let _this = this;
            let $sumodelcollection_form = _this.$div_subcollection_detail.find('form');

            //SubmodelElementCollection
            this.$div_subcollection_detail.find('button[name=clear]').kendoButton({
                themeColor: "base",
                click: function () {
                    Alert.alert("property 삭제", '구현중입니다.');
                }
            });

            this.$div_subcollection_detail.find('button[name=save]').kendoButton({
                themeColor: "info",
                click: function () {
                    Alert.confirm("Submodel Collection 저장확인", "저장하시겠습니까?", function () {
                        _this.saveSubmodelElementCollection();
                    });
                }
            });

            this.$div_subcollection_detail.find('button[name=delete]').kendoButton({
                themeColor: "error",
                click: function () {
                    Alert.alert("property 삭제", '구현중입니다.');
                }
            });

            // 서브모델엘리먼트컬렉션에서 하위 항목 추가
            this.$div_subcollection_detail.find("button[name=add_child]").kendoButton({
                themeColor: "info",
                click: function () {
                    let p_display_name = $sumodelcollection_form.find("input[name=displayName]").val();
                    let p_sme_pk = $sumodelcollection_form.find("input[name=sme_pk]").val();
                    _this.$tmplSubmodelElementSelectionWin.find("input[name=parentType]").val("submodelelementcollection");
                    _this.$tmplSubmodelElementSelectionWin.find("input[name=p_display_name]").val(p_display_name);
                    _this.$tmplSubmodelElementSelectionWin.find("input[name=p_sm_pk]").val("");
                    _this.$tmplSubmodelElementSelectionWin.find("input[name=p_sme_pk]").val(p_sme_pk);
                    _this.$tmplSubmodelElementSelectionWin.data("kendoWindow").center().open();
                }
            });
        }

        initPropertyElement() {
            let _this = this;
            //PropertyElement
            //SubmodelElementCollection
            this.$div_prpt_detail.find('button[name=clear]').kendoButton({
                themeColor: "base",
                click: function () {
                }
            });

            this.$div_prpt_detail.find('button[name=save]').kendoButton({
                themeColor: "info",
                click: function () {
                    Alert.confirm("Property 저장", "저장하시겠습니가?", function () {
                        _this.savePropertyElement();
                    });
                }
            });

            this.$div_prpt_detail.find('button[name=delete]').kendoButton({
                themeColor: "error",
                click: function () {
                }
            });
        }

        initFileElement() {
            let _this = this;
            ///
            let $form = _this.$div_file_detail.find("form");
            let $fileElement = $form.find("input[name=file_element]").kendoUpload({
                remove: function (e) {
                    if (userinfo.can_write() == false) {
                        return;
                    }
                }
            });

            if (userinfo.can_write()==false) {
                var upload = $fileElement.data("kendoUpload");
                upload.disable();
            }

            this.$fileElement = $fileElement;

            //FileElement
            this.$div_file_detail.find('button[name=clear]').kendoButton({
                themeColor: "base",
                click: function () {
                }
            });
            this.$div_file_detail.find('button[name=save]').kendoButton({
                themeColor: "info",
                click: function () {
                    Alert.confirm("FileElement Save", "저장하시겠습니까?", function () {
                        _this.saveFileElement();
                    });
                }
            });
            this.$div_file_detail.find('button[name=delete]').kendoButton({
                themeColor: "error",
                click: function () {
                }
            });
        }

        addRootNode() {
            // 최상위 등록시 필요
            let _this = this;
            this.hideAllDetail();
            let $form = this.$div_aas_detail.find('form');
            $form[0].reset();

            $('#p_aas_pk').val("");
            $('#aas_pk').val("");

            this.$div_aas_detail.find("button[name=delete]").hide();
            this.$div_aas_detail.find("button[name=add_child]").hide();
            this.$div_aas_detail.show();
        }

        showAASDetail($item) {

            let _this = this;
            let aas_pk = $item.attr('aas_pk');
            let gubun = $item.attr('gubun');
            let action = gubun + '_detail';
            let param = { action: action, aas_pk: aas_pk };

            this.hideAllDetail();

            if (userinfo.can_write()) {
                this.$div_aas_detail.find("button[name=delete]").show();
                this.$div_aas_detail.find("button[name=add_child]").show();
            }

            this.$div_aas_detail.show();

            let $form = this.$div_aas_detail.find('form');
            let $lang_code = this.$div_aas_detail.find('select[name=lang_code]');


            let fnSuccess = function (result) {
                if (result.success) {

                    let aasData = result.data;
                    FormUtil.BindDataForm(aasData, $form);

                    //하위추가팝업데이터 사전 설정함
                    _this.$tmplAASSubItemChoiceWin.find('input[name=p_display_name]').val(aasData.displayName);

                    $lang_code.off('change').on('change', function () {
                        let selectedLangCode = $lang_code.val();
                        let disp_text = _this.getLangTextFromJson(selectedLangCode, aasData.json_displayname);
                        let desc_text = _this.getLangTextFromJson(selectedLangCode, aasData.json_description);
                        $form.find("input[name=displayName]").val(disp_text);
                        $form.find("input[name=description]").text(desc_text);
                    });

                    _this.$div_submodel_detail.find("button[name=add_child]").removeAttr('disabled');
                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);

        }

        saveAASData() {
            let _this = this;
            let $form = this.$div_aas_detail.find('form');
            let data = FormUtil.extractForm($form);
            let funcSucc = function (resp) {
                if (resp.success) {
                    $('#id').val(resp.aas_pk);
                    Alert.alert("AAS 저장", '저장되었습니다.');
                    //_this.resetData();
                    _this.searchMainData();
                } else {
                    Alert.alert('error', resp.message);
                }
            };
            let url = this.baseUrl + "?action=aas_save"
            AjaxUtil.postAsyncData(url, data, funcSucc);
        }

        aasToggleNode(node) {

            let childUl = node.parentElement.nextElementSibling;
            let nodName = childUl.nodName;
            let $cc = $(childUl);
            //console.log($cc[0].nodeName);
            if ($cc[0].nodeName == "DIV") {
                return;
            }

            if (childUl) {
                childUl.classList.toggle('hidden');
                let toggleBtn = node.parentElement.querySelector('.toggle-btn');
                let isHidden = childUl.classList.contains('hidden');
                if (isHidden) {
                    toggleBtn.textContent = '+';
                }
                else {
                    //서브모델 목록 펼치기
                    //이미 데이터가 있음
                    toggleBtn.textContent = '-';
                }
            }
        }

        saveSubmodelElementCollection() {
            let _this = this;
            let $form = _this.$div_subcollection_detail.find("form");
            let data = FormUtil.extractForm($form);

            let fnSuccess = function (result) {
                if (result.success) {                    
                    Alert.alert("저장확인", '저장되었습니다.');
                }
                else {
                    Alert.alert("저장오류", result.message);
                }
            }

            let url = this.baseUrl + '?action=save_submodel_element_collection'
            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        getLangTextFromJson(selectedLangCode, strJson) {
            let strText = '';
            if (strJson != null) {
                let jsonArr = JSON.parse(strJson);
                $.each(jsonArr, function (idx, item) {
                    if (item.language == selectedLangCode) {
                        strText = item.text;
                    }
                });
            }
            return strText;
        }

        saveSubmodel() {
            let _this = this;
            let $form = this.$div_submodel_detail.find('form');
            let data = FormUtil.extractForm($form);

            let fnSaveSuccess = function (result) {
                if (result.success) {
                    Alert.alert('Submodel 저장확인', '저장되었습니다.');
                    _this.searchMainData();
                } else {
                    Alert.alert('Submodel 저장오류', result.message);
                }
            };

            let url = this.baseUrl + "?action=save_submodel";
            AjaxUtil.postAsyncData(url, data, fnSaveSuccess);
        }

        showSubmodelDetail($item) {
            let _this = this;
            let sm_pk = $item.attr('sm_pk');
            let aas_pk = $item.attr('aas_pk');
            this.hideAllDetail();
            this.$div_submodel_detail.show();

            let $form = this.$div_submodel_detail.find("form");
            let $lang_code = this.$div_submodel_detail.find('select[name=lang_code]');

            let param = { action: 'submodel_detail', sm_pk: sm_pk, aas_pk: aas_pk };
            let fnSuccess = function (result) {
                if (result.success) {
                    let submodelData = result.data;
                    FormUtil.BindDataForm(submodelData, $form);

                    $lang_code.off('change').on('change', function () {
                        let selectedLangCode = $lang_code.val();
                        let disp_text = _this.getLangTextFromJson(selectedLangCode, submodelData.json_displayname);
                        let desc_text = _this.getLangTextFromJson(selectedLangCode, submodelData.json_description);
                        $form.find("input[name=displayName]").val(disp_text);
                        $form.find("input[name=description]").text(desc_text);
                    });
                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);
        }

        submodelToggleNode(node) {
            let _this = this;
            /*
            서브모델 하위에 올 수 있는 서브모델 엘리먼트는
            Property, Collection, File
            */

            let ul = node.parentElement.nextElementSibling;
            let $ul = $(ul);
            //console.log($ul[0].nodeName);

            if (ul) {
                ul.classList.toggle('hidden');
                let toggleBtn = node.parentElement.querySelector('.toggle-btn');
                let isHidden = ul.classList.contains('hidden');
                if (isHidden) {
                    toggleBtn.textContent = '+';
                }
                else {
                    toggleBtn.textContent = '-';
                    let $node = $(node);
                    this.submodelElementsRender($node);
                    //if ($node.attr('loaded') != '1') {                                           }
                }
            }
        }

        submodelElementsRender($node) {
            let _this = this;
            let sm_pk = $node.attr('sm_pk');
            let param = { 'action': 'submodel_element_list', sm_pk: sm_pk };
            let $sm_children_ul = this.$aasTree.find('#sm_' + sm_pk);
            $sm_children_ul.empty();

            let fnSuccess = function (result) {
                if (result.success) {
                    let items = result.items;

                    if (items.length == 0) {

                    }

                    let template = kendo.template($('#smeTemplate').html());
                    let smeHtml = template(items);
                    $sm_children_ul.html(smeHtml);

                    $sm_children_ul.find('.sme_prpt_detail').on('click', function () {
                        _this.showPropertyDetail($(this), $node);
                    });

                    $sm_children_ul.find('.sme_file_detail').on('click', function () {
                        _this.showFileElementDetail($(this));
                    });

                    $sm_children_ul.find('.sme-coll-node').on('click', function () {
                        let $collNode = $(this);
                        _this.submodelElementsCollectionRender($collNode);
                        _this.aasToggleNode(this);

                    });
                    $sm_children_ul.find('.sme_collection_detail').on('click', function () {
                        _this.showSubmodelElementsCollectionDetail($(this));
                    });

                    $node.attr('loaded', "1");

                }
                else {
                    Alert.alert('조회오류', '서브모델엘리먼트를 가져오지 못했습니다.');
                }
            }

            AjaxUtil.getAsyncData(_this.baseUrl, param, fnSuccess);
        }

        submodelElementsCollectionRender($node) {
            let _this = this;
            let sme_pk = $node.attr('data_pk');
            let param = {
                action: 'submodel_element_collection_items',
                sme_pk: sme_pk
            };

            let fnSuccess = function (result) {
                if (result.success) {

                    let ul = $node[0].parentElement.nextElementSibling;
                    let $children_ul = $(ul);
                    //console.log($children_ul);

                    let items = result.items;

                    let template = kendo.template($('#smeTemplate').html());

                    let arrHtml = [];
                    $children_ul.empty();
                    let html = template(items);
                    $children_ul.html(html);

                    //하위자식이 있는경우
                    if (items.length > 0) {

                    } else {
                        //하위자식이 없는경우
                    }


                    $children_ul.find('.sme_prpt_detail').on('click', function () {
                        _this.showPropertyDetail($(this), $node);
                    });

                    $children_ul.find('.sme-coll-node').off('click').on('click', function () {
                        //alert('sme-coll-node');
                        _this.submodelElementsCollectionRender($(this));
                        _this.aasToggleNode(this);
                    });
                    $children_ul.find('.sme_collection_detail').on('click', function () {
                        _this.showSubmodelElementsCollectionDetail($(this));
                    });

                    $children_ul.find('.sme_file_detail').on('click', function () {
                        _this.showFileElementDetail($(this));
                    });

                    

                    $node.attr('loaded', "1");
                }
                else {
                    Alert.alert('조회오류', result.message);
                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);
        }

        showSubmodelElementsCollectionDetail($node) {
            let _this = this;
            let data_pk = $node.attr("data_pk");
            this.hideAllDetail();
            this.$div_subcollection_detail.show();
            let $form = this.$div_subcollection_detail.find("form");
            let $lang_code = this.$div_subcollection_detail.find('select[name=lang_code]');
            let param = {
                action: "submodel_element_collection_detail",
                data_pk: data_pk
            };
            let fnSuccess = function (result) {
                if (result.success) {
                    let submodelCollData = result.data;
                    FormUtil.BindDataForm(submodelCollData, $form);
                    
                    $lang_code.off('change').on('change', function () {
                        let selectedLangCode = $lang_code.val();
                        let disp_text = _this.getLangTextFromJson(selectedLangCode, submodelCollData.json_displayname);
                        let desc_text = _this.getLangTextFromJson(selectedLangCode, submodelCollData.json_description);
                        $form.find("input[name=displayName]").val(disp_text);
                        $form.find("input[name=description]").text(desc_text);
                    });


                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);
        }


        showFileElementDetail($node) {
            let _this = this;
            let data_pk = $node.attr("data_pk");
            this.hideAllDetail();
            this.$div_file_detail.show();
            let $form = this.$div_file_detail.find("form");
            $form[0].reset();

            var upload = this.$fileElement.data("kendoUpload");
            upload.clearAllFiles();

            let param = {
                action: "file_element_detail",
                data_pk: data_pk
            };


            let $lang_code = this.$div_file_detail.find('select[name=lang_code]');
            let $divFileElement = $form.find("#divFileElement");

            let fnSuccess = function (result) {
                if (result.success) {
                    let fileData = result.data;
                    FormUtil.BindDataForm(fileData, $form);
                    $lang_code.off('change').on('change', function () {
                        let selectedLangCode = $lang_code.val();
                        let disp_text = _this.getLangTextFromJson(selectedLangCode, fileData.json_displayname);
                        let desc_text = _this.getLangTextFromJson(selectedLangCode, fileData.json_description);
                        $form.find("input[name=displayName]").val(disp_text);
                        $form.find("input[name=description]").text(desc_text);
                    });

                    //$img.attr("src", "/api/files/aas?model_type=file&data_pk=" + fileData.sme_pk);
                    let url = "/api/files/aas?model_type=file&data_pk=" + fileData.sme_pk
                    let html = '📦<a href="' + url + '">' + fileData.filename + '</a> ';  //<i class="material-symbols-outlined">delete</i></span></a> <i class="material-symbols-outlined">attach_file</i>
                    
                    $divFileElement.append(html);
                }
                else {
                    Alert.alert("FileElement 조회오류", result.message);
                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);
        }

        // property
        savePropertyElement() {

            //1. 입력항목체크
            //2. 저장하시겠습니까? confirm
            //3. 저장진행

            let $form = this.$div_prpt_detail.find("form");
            let data = FormUtil.extractForm($form);

            let fnSuccess = function (result) {
                if (result.success) {
                    Alert.alert("Property", "저장되었습니다.");
                } else {
                    Alert.alert("저장오류", result.message);
                }
            };

            let url = this.baseUrl + "?action=save_property";
            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        showPropertyDetail($node, $parentNode) {
            let _this = this;
            let data_pk = $node.attr("data_pk");

            console.log("property parent node : ", $parentNode);

            this.hideAllDetail();
            this.$div_prpt_detail.show();
            let $form = this.$div_prpt_detail.find("form");
            let $lang_code = this.$div_prpt_detail.find('select[name=lang_code]');
            let param = { action: 'property_detail', data_pk: data_pk };

            $form[0].reset();

            let fnSuccess = function (result) {
                if (result.success) {
                    let prptData = result.data;
                    FormUtil.BindDataForm(prptData, $form);

                    $lang_code.off('change').on('change', function () {
                        let selectedLangCode = $lang_code.val();
                        let disp_text = _this.getLangTextFromJson(selectedLangCode, prptData.json_displayname);
                        let desc_text = _this.getLangTextFromJson(selectedLangCode, prptData.json_description);
                        $form.find("input[name=displayName]").val(disp_text);
                        $form.find("input[name=description]").text(desc_text);
                    });
                }
            };

            AjaxUtil.getAsyncData(this.baseUrl, param, fnSuccess);
        }

        saveFileElement() {
            let _this = this;
            let $form = this.$div_file_detail.find("form");
            let $inputFile = $form.find("input[name=file_element]");

            if ($inputFile[0].files.count == 0) {
                Alert.alert("File Element 입력누락" , "파일을 선택하세요");
                return;
            }

            let form_data = new FormData($form[0]);
            let fnSuccess = function (result) {
                if (result.success) {
                    Alert.alert("FileElement 저장", "저장되었습니다.");
                } else {
                    Alert.alert("FileElement 저장오류", result.message);
                }
            }

            let url = this.baseUrl + "?action=save_file_element";
            AjaxUtil.postFileAsyncData(url, form_data, fnSuccess);
        }

        showAASTreeList(aasItems) {
            let _this = this;
            let arrHtmls = [];
            this.$aasTree.empty();

            // 시작점
            $.each(aasItems, function (idx, item) {
                let template = kendo.template($("#aasTemplate").html());
                let nodeHtml = template(item);
                arrHtmls.push(nodeHtml);
            });

            let html = arrHtmls.join("");
            this.$aasTree.html(html);

            this.$aasTree.find('.aas_detail').on('click', function () {
                _this.showAASDetail($(this));
            });

            this.$aasTree.find(".aas-node").on('click', function () {
                _this.aasToggleNode(this);
            });

            this.$aasTree.find('.submodel_detail').on('click', function () {
                _this.showSubmodelDetail($(this));
            });

            this.$aasTree.find('.submodel-node').on('click', function () {
                
                _this.submodelToggleNode(this);
            });
        }

        showManagement() {
            Alert.alert("리비전관리", "기능구현중입니다.");
        }

        searchMainData() {

            let _this = this;
            let param = {
                action: 'aas_read',
                keyword: $('#keyword').val(),
            };

            let fnSuccess = function (result) {

                if (result.success) {
                    _this.showAASTreeList(result.items);
                }
                else {
                    Alert.alert('조회오류', result.message);
                }

            };

            AjaxUtil.getAsyncData(_this.baseUrl, param, fnSuccess);
        }

    };

    let page = new AASPage();
    $(document).ready(function () {
        page.searchMainData();
    });

    function toggleNode(node) {
        let childUl = node.nextElementSibling;
        if (childUl) {
            childUl.classList.toggle('hidden');
            let toggleBtn = node.querySelector('.toggle-btn');
            toggleBtn.textContent = childUl.classList.contains('hidden') ? '+' : '-';
        }
    }

    $('#aas_tree').on('click', '.tree-node', function (e) {
        e.stopPropagation(); // 하위 요소 클릭시 중복 이벤트 방지
        $('.tree-node').removeClass('active');
        $(this).addClass('active');
    });

</script>

{% endblock %}