<div id="modalEquipMaster" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>설비마스터 상세정보</h4>
		</div>
		<div class="modal-body">
			<div class="edit-form-ui">
				<div class="col-12 col-sm-6 col-md-3" style="display: flex; justify-content: center; align-items: center; height: 200px;">
					<img src="/static/img/no-image.png" alt="No image" style="width: 100px; height: 100px;">
				</div>
				<div class="col-12 col-sm-5 col-md-6" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 200px;">
					<div class="form-group col-12">
						<label for="equip_code" class="required">설비코드*</label>
						<input type="text" class="form-control" id="equip_code" name="equip_code">
					</div>
					<div class="form-group col-12">
						<label for="equip_name" class="required">설비명*</label>
						<input type="text" class="form-control" id="equip_name" name="equip_name">
					</div>
					<div id="div_equip_status" class="form-group col-12" style="display:none;">
						<label for="txt_equip_status" data-labelCd="설비상태">설비상태</label>
						<div style="display: flex; align-items: center;">
							<input type="text" class="form-control" id="txt_equip_status" name="txt_equip_status" style="flex: 0.3;" />
							<button class="btn" style="background-color: #6c757d; border: 1px solid #6c757d; color: white; margin-left: 20px;">상태변경</button>
						</div>
					</div>
				</div>
				<div class="col-12 col-sm-6 col-md-3" style="display: flex; justify-content: center; align-items: center; height: 200px;">
					<div style="display: flex; flex-direction: column; justify-content: space-between; height: 190px;">
						<div style="width: 100%; height: 130px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; background-color: white;">
							<img src="/static/img/qr-sample.png" alt="QR Code" style="width: 110px; height: 110px;">
						</div>
						<div>
							<div style="text-align: left; color: red; margin-bottom: 5px;">
								카테고리*
							</div>
							<div style="display: flex; gap: 5px;">
								<input type="hidden" id="equip_category_id" name="equip_category_id" />
								<input type="text" class="form-control" id="equip_category" name="equip_category" style="background-color: #f9f9f9; flex: 1;" readonly>
								<button id="btnEquipClass" class="btn" style="min-width: 36px; padding: 0; background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; outline: none;">
									<img src="/static/img/folder-icon.png" alt="폴더" style="width: 24px; height: 24px;">
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 탭 섹션 -->
			<div class="section">
				<div class="tab-group">
					<button class="tab-button active" data-tab="equipMasterForm" style="background: #1e4f88; color: white; border-color: #1e4f88;">기본정보</button>
					<button class="tab-button" data-tab="equipSpec">사양(Spec)</button>
					<button class="tab-button" data-tab="equipPartsBom">Parts/BOM</button>
					<button class="tab-button" data-tab="fileTab">파일</button>
					<button class="tab-button" data-tab="pmTab">PM</button>
					<button class="tab-button" data-tab="inspectionTab">점검</button>
					<button class="tab-button" data-tab="logTab">로그</button>
					<button class="tab-button" data-tab="assetEvaluationTab">자산평가</button>
				</div>
				<div class="tab-content">
					<!-- 기본정보 탭 컨텐츠 -->
					<div class="tab-pane active" id="equipMasterForm">
						<form id="baseinfoForm">
							<div class="form-group col-md-4">
								<label for="loc_pk" class="required" data-labelCd="EquipLoc">설비위치*</label>
								<button type="button" class="plusbutton" id="equipLocPlus" name="equipLocPlus"></button>
								<button type="button" class="gridbutton" id="equipLocHist" name="equipLocHist"></button>
								<select id="loc_pk" name="loc_pk" data-msg="설비위치를" required></select>
							</div>
							<div class="form-group col-md-4">
								<label for="dept_pk" class="required" data-labelCd="관리부서">관리부서*</label>
								<button type="button" class="gridbutton" id="mngDept" name="mngDept"></button>
								<select id="dept_pk" name="dept_pk" data-msg="관리부서를"></select>
							</div>
							<div class="form-group col-md-4">
								<label class="required" data-labelCd="설치일">설치일*</label>
								<input type="date" id="InstallDate" class="form-control" data-msg="설치일을" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; " name="InstallDate">
							</div>
							<div class="form-group col-md-4">
								<label>설비중요도</label>
								<select id="import_rank_pk" name="import_rank_pk"></select>
							</div>
							<div class="form-group col-md-4">
								<label>프로세스</label>
								<select id="process_cd" name="process_cd"></select>
							</div>
							<div class="form-group col-md-4">
								<label>제조일</label>
								<input type="date" id="ProductionYear" class="form-control" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; " name="ProductionYear">
							</div>
							<div class="form-group col-md-4">
								<label>시스템</label>
								<select id="system_cd" name="system_cd"></select>
							</div>
							<div class="form-group col-md-4">
								<label for="asset_nos">자산번호</label>
								<input type="text" class="form-control" id="asset_nos" name="asset_nos">
							</div>
							<div class="form-group col-md-4">
								<label>상위설비</label>
								<button type="button" class="zoombutton" id="upLoc" name="upLoc"></button>
								<input type="hidden" id="upEquipPk" name="upEquipPk" readonly>
								<input type="text" class="form-control" id="upEquip" name="upEquip" readonly>
							</div>
							<div class="form-group col-md-4">
								<label for="mtrl_nm" class="required">순환설비자재*</label>
								<button type="button" class="zoombutton" id="recycleMat" name="recycleMat"></button>
								<input type="hidden" class="form-control" id="equip_mtrl_pk" name="equip_mtrl_pk" readonly>
								<input type="text" class="form-control" data-msg="순환설비자재를"  id="mtrl_nm" name="mtrl_nm" readonly>
							</div>
							<div class="form-group col-md-4">
								<label>코스트 센터</label>
								<select id="ccenterCd" name="ccenterCd"></select>
							</div>
							<div class="form-group col-md-4">
								<label for="environEquipYn" class="required">법정관리 설비 여부</label>
								<div class="field-wrapper">
									<input id="environEquipYn" name="environEquipYn" data-msg="법정관리 설비 여부를" />
								</div>
							</div>
							<div class="form-group col-md-4">
								<label>공급업체</label>
								<select id="supplier" name="supplier"></select>
							</div>
							<div class="form-group col-md-4">
								<label>구매비용</label>
								<input type="number" class="form-control" id="PurchaseCost" name="PurchaseCost">
							</div>
							<div class="form-group col-md-4">
								<label>보증만료일</label>
								<input type="text" class="form-control" id="warranty_dt" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; " name="warranty_dt">
							</div>
							<div class="form-group col-md-4">
								<label>제조사</label>
								<select id="Maker" name="Maker"></select>
							</div>
							<div class="form-group col-md-4">
								<label>모델넘버</label>
								<input type="text" class="form-control" id="Model" name="Model">
							</div>
							<div class="form-group col-md-4">
								<label>시리얼넘버</label>
								<input type="text" class="form-control" id="SerialNumber" name="SerialNumber">
							</div>
							<div class="form-group col-md-11">
								<label>비고</label>
								<textarea class="form-control" id="Description" name="Description" placeholder="2000자 이하로 입력하세요" maxlength="2000"></textarea>
							</div>
						</form>
					</div>

					<!-- 사양(Spec) 탭 컨텐츠 -->
					<div class="tab-pane" id="equipSpec" style="overflow-y:auto; height: 400px;">
						<div class="form-row">
							<div class="form-group col-md-4">
								<label>설비분류</label>
								<input type="text" class="form-control" id="equip_class_path" name="equip_class_path" readonly>
							</div>
							<div class="form-group col-md-8">
								<label>설비분류 설명</label>
								<input type="text" class="form-control" id="equip_class_desc" name="equip_class_desc" readonly>
							</div>
						</div>
						<div id="equSpecGrid" class="grid">
						</div>
					</div>

					<!-- Parts/BOM 탭 컨텐츠 -->
					<div class="tab-pane" id="equipPartsBom">
						<!-- Parts 섹션 -->
						<div style="margin-bottom: 20px;">
							<div style="display: flex; align-items: center; margin-bottom: 10px;">
								<div style="display: flex; align-items: center;">
									<span>Parts</span>
									<span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background-color: #e9ecef; border-radius: 50%; margin-left: 5px; font-size: 12px;">1</span>
								</div>
								<button class="btn" style="margin-left: auto; background-color: #1e4f88; color: white; padding: 4px 12px; font-size: 12px;">자재선택</button>
							</div>
							<div id="partsGrid" class="grid"></div>
						</div>

						<!-- BOM 계층구조 보기 섹션 -->
						<div>
							<div style="display: flex; align-items: center; margin-bottom: 10px;">
								<div style="display: flex; align-items: center;">
									<span>BOM 계층구조 보기</span>
									<span style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background-color: #e9ecef; border-radius: 50%; margin-left: 5px; font-size: 12px;">1</span>
								</div>
							</div>
							<div style="border: 1px solid #dee2e6; padding: 15px;">
								<div style="color: #1e4f88; font-weight: bold; margin-bottom: 10px;">YPE00013 : AuSn Granule기</div>
							</div>
						</div>
					</div>

					<!--파일 탭 컨텐츠 -->
					<div class="tab-pane" id="fileTab" style="overflow-y:auto; height: 400px;">
						{% include 'components/ImageUpload.html' with tableName='cm_equipment' attachName='image' dataPk=cm_equipment.equip_pk|default:'' %}
						{% include 'components/FileUpload.html' with tableName='cm_equipment' attachName='file' dataPk=cm_equipment.equip_pk|default:'' %}
					</div>

					<!--PM 탭 컨텐츠 -->
					<div class="tab-pane" id="pmTab" style="overflow-y:auto; height: 400px;">
						<div id="pmGrid" class="grid"></div>
					</div>

					<!--점검 탭 컨텐츠 -->
					<div class="tab-pane" id="inspectionTab" style="overflow-y:auto; height: 400px;">
						<div id="inspectionGrid" class="grid"></div>
					</div>

					<!--로그 탭 컨텐츠 -->
					<div class="tab-pane" id="logTab" style="overflow-y:auto; height: 400px;">
						<div id="logGrid" class="grid"></div>
					</div>

					<!--자산평가 탭 컨텐츠 -->
					<div class="tab-pane" id="assetEvaluationTab" style="overflow-y:auto; height: 400px;">
						<div id="assetEvaluationGrid" class="grid"></div>
					</div>
				</div>
			</div>
		</div>
		<!-- 버튼 영역 -->
		<div class="modal-footer">
			<button type="button" style="background-color: #dc3545 !important; color: white !important; border-color: #d9534f !important;" id="disposedBtn">설비불용처리</button>
			<button type="button" style="background-color: #dc3545 !important; color: white !important; border-color: #d9534f !important;" id="notUseBtn">사용안함</button>
			<button type="button" class="btn-save" id="saveBtn">저장</button>
			<button type="button" class="btn-close" id="closeBtn">닫기</button>
		</div>
	</div>
</div>
<style>
</style>

{% include 'popup/modalEquClassSel.html' %}
{% include 'popup/modalEquLoc.html' %}
{% include 'popup/modalEquLocHist.html' %}
{% include 'popup/modalEquDeptHist.html' %}
{% include 'popup/modalEquSel.html' %}
{% include 'popup/modalMatSel.html' %}

<script type="text/javascript">
	class EquipMaster {
		constructor() {
			this.baseUrl = '/api/kmms/equipment';
			this.equip_pk = null;
			this.equipStatusYN = false;

			// DropDown Tree와 List 컨트롤 정의
			this.locPkDropDown = null;
			this.deptPkDropDown = null;
			this.importRankDropDown = null;
			this.processCdDropDown = null;
			this.systemCdDropDown = null;
			this.supplierDropDown = null;
			this.makerDropDown = null;
			this.ccenterCdDropDown = null;

			// 그리드 컨트롤 정의
			this.pmGrid = null;
			this.equSpecGrid = null;
			this.partsGrid = null;
			this.inspectionGrid = null;
			this.logGrid = null;
			this.assetEvaluationGrid = null;

			// DatePicker 컨트롤 정의
			this.productionYearPicker = null;
			this.installDatePicker = null;
			this.warrantyDatePicker = null;

			// Switch 컨트롤 정의
			this.environEquipYnSwitch = null;

			// 모달 관련 요소 정의
			this.modal = null;

			this.init();
		}

		init() {
			const _this = this;  // this 컨텍스트 저장

			// 모달 요소 초기화
			this.modal = $("#modalEquipMaster");

			// DropDown Tree와 List 초기화
			this.locPkDropDown = AjaxUtil.fillDropDownTreeOptions($('#loc_pk'), 'cm_location', 'all');
			this.deptPkDropDown = AjaxUtil.fillDropDownTreeOptions($('#dept_pk'), 'cm_depart', 'all');
			this.importRankDropDown = AjaxUtil.fillDropDownOptions($('#import_rank_pk'), 'cm_import_rank', 'all', null);
			this.processCdDropDown = AjaxUtil.fillDropDownOptions($('#process_cd'), 'cm_code', 'all', null, 'EQUIPMENT_PROCESS');
			this.systemCdDropDown = AjaxUtil.fillDropDownOptions($('#system_cd'), 'cm_code', 'all', null, 'EQUIP_SYSTEM');
			this.supplierDropDown = AjaxUtil.fillDropDownOptions($('#supplier'), 'cm_supplier', 'all', null, 'COMP_TYPE', 'CP_S,CP_B');
			this.makerDropDown = AjaxUtil.fillDropDownOptions($('#Maker'), 'cm_supplier', 'all', null, 'COMP_TYPE', 'CP_M,CP_B');
			this.ccenterCdDropDown = AjaxUtil.fillDropDownOptions($('#ccenterCd'), 'cm_code', 'all', null, 'COST_CENTER');

			// DatePicker 초기화
			this.productionYearPicker = $("#ProductionYear").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");
			this.installDatePicker = $("#InstallDate").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");
			this.warrantyDatePicker = $("#warranty_dt").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");

			// Switch 초기화
			this.environEquipYnSwitch = $("#environEquipYn").kendoSwitch().data("kendoSwitch");

			// 버튼 이벤트 핸들러 설정
			$("#equipLocPlus").kendoButton({
				icon: "k-i-plus",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalWindow', { width: '70%', height: '70%' });
					locationPage.show(function (ctrl) {
						if (ctrl === 'equip_loc') {
							AjaxUtil.fillDropDownTreeOptions($('#loc_pk'), 'cm_location', 'all');
						}
					});
				}
			});

			$("#btnEquipClass").kendoButton({
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEquClass', { width: '40%', height: '70%' });
					equipClassPage.show(function (res) {
						$("#equip_category_id").val(res.equip_category_id);
						$("#equip_category").val(res.remark);
					});
				}
			});

			$("#equipLocHist").kendoButton({
				icon: "k-i-grid-layout",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEquipLocHist', { width: '70%', height: '55%' });
					equipLocHistPage.show();
				}
			});

			$("#mngDept").kendoButton({
				icon: "k-i-grid-layout",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalWindowDept', { width: '60%', height: '55%' });
					equipDeptHistPage.show();
				}
			});

			$("#upLoc").kendoButton({
				icon: "k-i-zoom-in",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEqu', { width: '70%', height: '70%' });
					equipSelectPage.show(function (data) {
						$("#upEquipPk").val(data._equip_pk);
						$("#upEquip").val(data._equip_nm);
					});
				}
			});

			$("#recycleMat").kendoButton({
				icon: "k-i-zoom-in",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalMatSel');
					matSelectPage.show(function (data) {
						$("#equip_mtrl_pk").val(data._mtrl_pk);
						$("#mtrl_nm").val(data._mtrl_nm);
					});
				}
			});

			$('#disposedBtn').kendoButton({});
			$('#notUseBtn').kendoButton({});

			// 기존 이벤트 핸들러 제거
			$('#saveBtn').off('click');
			
			$('#saveBtn').kendoButton({
				click: function (e) {
					e.preventDefault();  // 이벤트 기본 동작 방지
					_this.saveData();
					//const result = await fetchSomeData(); // 비동기 함수 호출
				}
			});

			$('#closeBtn').kendoButton({
				click: function () {
					_this.resetForm();
					_this.modal.fadeOut();
				}
			});

			// ESC 키로 모달 닫기
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) this.modal.fadeOut();
			});

			// 그리드 초기화 코드는 그대로 유지...
			this.pmGrid = $("#pmGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: this.baseUrl + '/pm',
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'pm',
									id: _this.equip_pk
								};
							}
						}
					},
					pageSize: 50
				}),
				height: 550,
				sortable: true,
				pageable: {
					refresh: false,
					pageSizes: [50],
					buttonCount: 5
				},
				columns: [
					{ field: "pm_no", title: "PM번호", width: 100, attributes: { style: "text-align: center" } },
					{ field: "pm_nm", title: "PM명", width: 200 },
					{ field: "dept_nm", title: "설명부서", width: 120, attributes: { style: "text-align: center" } },
					{ field: "manager_nm", title: "PM 담당자", width: 120, attributes: { style: "text-align: center" } },
					{ field: "pm_type", title: "PM유형", width: 100, attributes: { style: "text-align: center" } },
					{ field: "cycle", title: "주기", width: 80, attributes: { style: "text-align: center" } },
					{ field: "cycle_unit", title: "주기단위", width: 100, attributes: { style: "text-align: center" } },
					{ field: "last_complete_dt", title: "최근 완료일", width: 120, attributes: { style: "text-align: center" } },
					{ field: "use_yn", title: "사용여부", width: 100, attributes: { style: "text-align: center" } }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.equSpecGrid = $("#equSpecGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: this.baseUrl,
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'detail',
									id: _this.equip_pk
								};
							}
						}
					},
				}),
				height: 550,
				sortable: true,
				pageable: true,
				autoBind: false,
				columns: [
					{ field: "no", title: "NO", width: 120 },
					{ field: "specnm", title: "사양명", width: 120, },
					{ field: "unit", title: "단위", width: 100 },
					{ field: "spec", title: "사양(Spec)", width: 100 }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.partsGrid = $("#partsGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: this.baseUrl + '/parts',
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'parts',
									id: _this.equip_pk
								};
							}
						}
					},
					pageSize: 50
				}),
				height: 300,
				sortable: true,
				pageable: {
					refresh: false,
					pageSizes: [50],
					buttonCount: 5
				},
				columns: [
					{ field: "no", title: "NO", width: 80, attributes: { style: "text-align: center" } },
					{ field: "material_code", title: "자재코드", width: 120 },
					{ field: "material_name", title: "자재명", width: 200 },
					{ field: "quantity", title: "구성수량", width: 100, attributes: { style: "text-align: center" } },
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								// 삭제 로직 구현
							}
						},
						width: 100
					}
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.inspectionGrid = $("#inspectionGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: this.baseUrl + '/inspection',
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'inspection',
									id: _this.equip_pk
								};
							}
						}
					},
					pageSize: 50
				}),
				height: 550,
				sortable: true,
				pageable: {
					refresh: false,
					pageSizes: [50],
					buttonCount: 5
				},
				columns: [
					{ field: "inspection_no", title: "점검번호", width: 100, attributes: { style: "text-align: center" } },
					{ field: "inspection_nm", title: "점검명", width: 200 },
					{ field: "dept_nm", title: "점검부서", width: 120, attributes: { style: "text-align: center" } },
					{ field: "manager_nm", title: "점검담당자", width: 120, attributes: { style: "text-align: center" } },
					{ field: "inspection_type", title: "점검유형", width: 100, attributes: { style: "text-align: center" } },
					{ field: "cycle", title: "주기", width: 80, attributes: { style: "text-align: center" } },
					{ field: "cycle_unit", title: "주기단위", width: 100, attributes: { style: "text-align: center" } },
					{ field: "last_complete_dt", title: "최근 완료일", width: 120, attributes: { style: "text-align: center" } },
					{ field: "use_yn", title: "사용여부", width: 100, attributes: { style: "text-align: center" } }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.assetEvaluationGrid = $("#assetEvaluationGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: this.baseUrl + '/asset-evaluation',
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'asset-evaluation',
									id: _this.equip_pk
								};
							}
						}
					},
					pageSize: 50
				}),
				height: 550,
				sortable: true,
				pageable: {
					refresh: false,
					pageSizes: [50],
					buttonCount: 5
				},
				columns: [
					{ field: "evaluation_criteria", title: "자산평가기준", width: 150, attributes: { style: "text-align: center" } },
					{ field: "evaluation_grade", title: "자산평가단계", width: 150, attributes: { style: "text-align: center" } },
					{ field: "evaluation_value", title: "자산평가값", width: 150, attributes: { style: "text-align: center" } },
					{ field: "last_evaluation_dt", title: "최종자산평가", width: 150, attributes: { style: "text-align: center" } }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.logGrid = $("#logGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: this.baseUrl + '/log',
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'log',
									id: _this.equip_pk
								};
							}
						}
					},
					pageSize: 50
				}),
				height: 550,
				sortable: true,
				pageable: {
					refresh: false,
					pageSizes: [50],
					buttonCount: 5
				},
				columns: [
					{ field: "user_nm", title: "사용자", width: 100, attributes: { style: "text-align: center" } },
					{ field: "log_type", title: "로그 타입", width: 120, attributes: { style: "text-align: center" } },
					{ field: "log_content", title: "로그 내역", width: 500 },
					{ field: "log_dt", title: "일시", width: 150, attributes: { style: "text-align: center" } }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			// 탭 클릭 이벤트
			$('.tab-button').on('click', function () {
				const tabId = $(this).data('tab');
				$('.tab-button').removeClass('active').removeAttr('style');
				$('.tab-pane').removeClass('active').hide();
				$(this).addClass('active').css({
					'background': '#1e4f88',
					'color': 'white',
					'border-color': '#1e4f88'
				});
				if (tabId) $('#' + tabId).addClass('active').show();
				if (tabId === 'fileTab') {
					if (window.imageUploader) window.imageUploader.loadFilesFromServer();
					if (window.fileUploader) window.fileUploader.loadFilesFromServer();
				}
			});
		}

		//설비 마스터
		show(equip_pk) {
			let _this = this;
			_this.equip_pk = equip_pk;
			_this.equipStatusYN = _this.equip_pk ? true : false;

			// 설비 상세 정보 API 호출
			let param = {
				action: 'findOne',
				equip_pk: equip_pk,
			};

			let equipData = AjaxUtil.getSyncData('/api/kmms/equipment', param);

			// 1.1. 기존 데이터 바인딩
			this.bindEquipMasterData(equipData);

			if (equipData) {
				$("#modalEquipMaster").fadeIn();
			}

			// ✅ 여기서 imageUploader의 dataPk를 재세팅 후 파일 목록 새로 로드
			if (window.imageUploader) {
				window.imageUploader.dataPk = equip_pk;
				window.imageUploader.loadFilesFromServer(() => {
					showMainImageFromUploader();
				});
			}

			// ✅ 여기서 fileUploader의 dataPk를 재세팅 후 파일 목록 새로 로드
			if (window.fileUploader) {
				window.fileUploader.dataPk = equip_pk;
				window.fileUploader.loadFilesFromServer(() => {
					showMainFileFromUploader();
				});
			}
		}

		//저장
		saveData() {
			let _this = this;

			let data = FormUtil.extractForm($('#baseinfoForm'));
			data.equipCode = $("#equip_code").val();
			data.equipName = $("#equip_name").val();
			data.equipClassPk = $("#equip_category_id").val();
			data.loc_pk = $("#loc_pk").data("kendoDropDownTree").value();
			data.dept_pk = $("#dept_pk").data("kendoDropDownTree").value();
			console.log('data:', data);

			// 폼 외부 필드 유효성 검사
			if (!data.equipCode) {
				Alert.alert('', '설비코드를 입력해주세요.');
				return;
			}

			if (!data.equipName) {
				Alert.alert('', '설비명을 입력해주세요.');
				return;
			}

			if (!data.equipClassPk) {
				Alert.alert('', '카테고리를 선택해주세요.');
				return;
			}

			if (!data.loc_pk) {
				Alert.alert('', '설비위치를 선택해주세요.');
				return;
			}

			if (!data.dept_pk) {
				Alert.alert('', '관리부서를 선택해주세요.');
				return;
			}
			if (!$('#InstallDate').val()) {
				Alert.alert('', '설치일을 선택해주세요.');
				return;
			}
			if (!$('#mtrl_nm').val()) {
				Alert.alert('', '순환설비자재를 선택해주세요.');
				return;
			}

			let fnSuccess = function (res) {
				if (res.success) {				
					Alert.alert('', res.message);
					_this.resetForm();
					//_this.modal.fadeOut();
				} else if (!res.success) {
					Alert.alert('', res.message);
				}
			};
			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, fnSuccess);
		}

		bindEquipMasterData(data) {
			console.log('row_data:', data);
			// 기본 필드 바인딩
			const basicFields = {
				'equip_master_pk': data.equip_pk,
				'equip_code': data.equip_cd,
				'equip_name': data.equip_nm,
				'asset_nos': data.asset_nos,
				'upEquip': data.up_loc_nm,
				'mtrl_nm': data.mtrl_nm,
				'ProductionYear': data.make_dt,
				'InstallDate': data.install_dt,
				'warranty_dt': data.warranty_dt,
				PurchaseCost: formatCurrency(data.buy_cost),
				Model: data.model_number,
				SerialNumber: data.serial_number,
			};

			// 기본 필드 값 설정
			Object.entries(basicFields).forEach(([id, value]) => {
				$(`#${id}`).val(value);
			});

			// Kendo Switch 설정
			const environEquipYnSwitch = $("#environEquipYn").data("kendoSwitch");
			if (environEquipYnSwitch) {
				const isChecked = data.environ_equip_yn === 'Y';
				environEquipYnSwitch.check(isChecked);
			}

			function formatCurrency(value) {
				if (!value && value !== 0) return '';
				return '₩ ' + Number(value).toLocaleString('ko-KR');
			}

			// DropDown 컨트롤 값 설정
			const setDropDownValue = (dropDown, value) => {
				if (dropDown && value) {
					dropDown.value(value);
					dropDown.trigger("change");
				}
			};

			// 각 DropDown 컨트롤 값 설정
			setDropDownValue(this.locPkDropDown, data.loc_pk);
			setDropDownValue(this.deptPkDropDown, data.dept_pk);
			setDropDownValue(this.importRankDropDown, data.import_rank_pk);
			setDropDownValue(this.processCdDropDown, data.process_cd);
			setDropDownValue(this.systemCdDropDown, data.system_cd);
			setDropDownValue(this.supplierDropDown, data.supplier);
			setDropDownValue(this.makerDropDown, data.maker);
			setDropDownValue(this.ccenterCdDropDown, data.ccenter_cd);
		}

		// 모달 초기화 메소드
		resetForm() {
			// 기본 입력 필드 초기화
			$("#modalEquipMaster input[type='text']").val('');
			$("#modalEquipMaster input[type='number']").val('');
			$("#modalEquipMaster input[type='date']").val('');
			$("#modalEquipMaster input[type='hidden']").val('');
			$("#modalEquipMaster textarea").val('');

			// DropDown 컨트롤 초기화
			if (this.locPkDropDown) this.locPkDropDown.value('');
			if (this.deptPkDropDown) this.deptPkDropDown.value('');
			if (this.importRankDropDown) this.importRankDropDown.value('');
			if (this.processCdDropDown) this.processCdDropDown.value('');
			if (this.systemCdDropDown) this.systemCdDropDown.value('');
			if (this.supplierDropDown) this.supplierDropDown.value('');
			if (this.makerDropDown) this.makerDropDown.value('');
			if (this.ccenterCdDropDown) this.ccenterCdDropDown.value('');

			// DatePicker 초기화
			if (this.productionYearPicker) this.productionYearPicker.value('');
			if (this.installDatePicker) this.installDatePicker.value('');
			if (this.warrantyDatePicker) this.warrantyDatePicker.value('');

			// Switch 초기화
			if (this.environEquipYnSwitch) this.environEquipYnSwitch.check(false);

			// 이미지 초기화
			if (window.imageUploader && typeof window.imageUploader.clearFiles === 'function') {
				window.imageUploader.clearFiles();
			}

			// 파일 초기화
			if (window.fileUploader && typeof window.fileUploader.clearFiles === 'function') {
				window.fileUploader.clearFiles();
			}

			// 그리드 초기화
			if (this.pmGrid) this.pmGrid.dataSource.data([]);
			if (this.equSpecGrid) this.equSpecGrid.dataSource.data([]);
			if (this.partsGrid) this.partsGrid.dataSource.data([]);
			if (this.inspectionGrid) this.inspectionGrid.dataSource.data([]);
			if (this.logGrid) this.logGrid.dataSource.data([]);
			if (this.assetEvaluationGrid) this.assetEvaluationGrid.dataSource.data([]);

			// 기본 이미지로 복원
			$("#modalEquipMaster img").attr("src", "/static/img/no-image.png");

			// 클래스 속성 초기화
			this.equip_pk = null;
			this.equipStatusYN = false;
		}
	}


	$(document).ready(function () {
		equipMasterPage = new EquipMaster();
	});

	function showMainImageFromUploader() {
		if (!window.imageUploader) return;

		const imageDataList = window.imageUploader.getImagesData();
		const mainImage = imageDataList.find(file => file); // 첫 번째 이미지

		const container = document.querySelector('#modalEquipMaster .image-container');
		if (container) {
			if (mainImage) {
				container.innerHTML = `
				<img src="${mainImage.src}" alt="${mainImage.name}" style="max-width: 100%; max-height: 100%;">
			`;
			} else {
				// fallback 이미지
				container.innerHTML = `
				<div style="text-align: center;">
					<img src="/static/img/no-image.png" alt="No image" style="width: 100px; height: 100px;">
					<div style="margin-top: 10px; color: #999;">No image</div>
				</div>
			`;
			}
		}
	}

	function showMainFileFromUploader() {
		if (!window.fileUploader) return;

		const fileDataList = window.fileUploader.getFilesData();
		const mainFile = fileDataList.find(file => file); // 첫 번째 파일

		const container = document.querySelector('#modalEquipMaster .file-container');
		if (container) {
			if (mainFile) {
				container.innerHTML = `
				<div style="text-align: center;">
					<i class="fas fa-file" style="font-size: 48px; color: #1e4f88;"></i>
					<div style="margin-top: 10px; color: #333;">${mainFile.name}</div>
					<div style="color: #666; font-size: 12px;">${formatFileSize(mainFile.size)}</div>
				</div>
			`;
			} else {
				// fallback 파일 표시
				container.innerHTML = `
				<div style="text-align: center;">
					<i class="fas fa-file" style="font-size: 48px; color: #999;"></i>
					<div style="margin-top: 10px; color: #999;">No file</div>
				</div>
			`;
			}
		}
	}

	function formatFileSize(bytes) {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}

	async function fetchSomeData() {
		try {
			if (window.imageUploader) {
				const imageResult = await window.imageUploader.saveImages();
			}
			if (window.fileUploader) {
				const fileResult = await window.fileUploader.saveFiles();
			}
		} catch (error) {
			console.error('Error:', error);
			alert(error.message);
			throw error;
		}
	}
</script>

