<div id="modalEquipMaster" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>설비마스터 상세정보</h4>
		</div>
		<div class="modal-body">
			<div class="edit-form-ui">
				<div class="col-12 col-sm-6 col-md-3" style="display: flex; justify-content: center; align-items: center; height: 200px;">
					<img id="equipThumbmail" src="/static/img/no-image.png" alt="No image" style="width: 100px; height: 100px;">
				</div>
				<div class="col-12 col-sm-5 col-md-6" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 200px;">
					<div class="form-group col-12">
						<label for="equip_code" class="required">설비코드*</label>
						<input type="text" class="form-control" id="equip_code" name="equip_code">
					</div>
					<div class="form-group col-12">
						<label for="equip_name" class="required">설비명*</label>
						<input type="text" class="form-control" id="equip_name" name="equip_name">
					</div>
					<div id="div_equip_status" class="form-group col-12" style="display:none;">
						<label for="txt_equip_status" data-labelCd="설비상태">설비상태</label>
						<div style="display: flex; align-items: center;">
							<input type="text" class="form-control" id="txt_equip_status" name="txt_equip_status" style="flex: 0.3;" />
							<button class="btn" style="background-color: #6c757d; border: 1px solid #6c757d; color: white; margin-left: 20px;">상태변경</button>
						</div>
					</div>
				</div>
				<div class="col-12 col-sm-6 col-md-3" style="display: flex; justify-content: center; align-items: center; height: 200px;">
					<div style="display: flex; flex-direction: column; justify-content: space-between; height: 190px;">
						<div style="width: 100%; height: 130px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; background-color: white;">
							<img src="/static/img/qr-sample.png" alt="QR Code" style="width: 110px; height: 110px;">
						</div>
						<div>
							<div style="text-align: left; color: red; margin-bottom: 5px;">
								카테고리*
							</div>
							<div style="display: flex; gap: 5px;">
								<input type="hidden" id="equip_category_id" name="equip_category_id" />
								<input type="text" class="form-control" id="equip_category" name="equip_category" style="background-color: #f9f9f9; flex: 1;" readonly>
								<button id="btnEquipCategory" class="btn" style="min-width: 36px; padding: 0; background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; outline: none;">
									<img src="/static/img/folder-icon.png" alt="폴더" style="width: 24px; height: 24px;">
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 탭 섹션 -->
			<div class="section">
				<div class="tab-group">
					<button class="tab-button active" data-tab="equipMasterForm" style="background: #1e4f88; color: white; border-color: #1e4f88;">기본정보</button>
					<button class="tab-button" data-tab="equipSpec">사양(Spec)</button>
					<button class="tab-button" data-tab="equipPartsBom">Parts/BOM</button>
					<button class="tab-button" data-tab="fileTab">파일</button>
					<button class="tab-button" data-tab="pmTab">PM</button>
					<button class="tab-button" data-tab="inspectionTab">점검</button>
					<button class="tab-button" data-tab="logTab">로그</button>
					<button class="tab-button" data-tab="assetEvaluationTab">자산평가</button>
				</div>
				<div class="tab-content">
					<!-- 기본정보 탭 컨텐츠 -->
					<div class="tab-pane active" id="equipMasterForm">
						<form id="baseinfoForm">
							<div class="form-group col-md-4">
								<label for="loc_pk" class="required" data-labelCd="EquipLoc">설비위치*</label>
								<button type="button" class="plusbutton" id="equipLocPlus" name="equipLocPlus"></button>
								<button type="button" class="gridbutton" id="equipLocHist" name="equipLocHist"></button>
								<select id="loc_pk" name="loc_pk" data-msg="설비위치를" required></select>
							</div>
							<div class="form-group col-md-4">
								<label for="dept_pk" class="required" data-labelCd="관리부서">관리부서*</label>
								<button type="button" class="gridbutton" id="mngDept" name="mngDept"></button>
								<select id="dept_pk" name="dept_pk" data-msg="관리부서를"></select>
							</div>
							<div class="form-group col-md-4">
								<label class="required" data-labelCd="설치일">설치일*</label>
								<input type="date" id="install_dt" name="install_dt" class="form-control" data-msg="설치일을" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; ">
							</div>
							<div class="form-group col-md-4">
								<label>설비중요도</label>
								<select id="import_rank_pk" name="import_rank_pk"></select>
							</div>
							<div class="form-group col-md-4">
								<label>프로세스</label>
								<select id="process_cd" name="process_cd"></select>
							</div>
							<div class="form-group col-md-4">
								<label>제조일</label>
								<input type="date" id="make_dt" name="make_dt" class="form-control" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; ">
							</div>
							<div class="form-group col-md-4">
								<label>시스템</label>
								<select id="system_cd" name="system_cd"></select>
							</div>
							<div class="form-group col-md-4">
								<label for="asset_nos">자산번호</label>
								<input type="text" class="form-control" id="asset_nos" name="asset_nos">
							</div>
							<div class="form-group col-md-4">
								<label>상위설비</label>
								<button type="button" class="zoombutton" id="upLoc" name="upLoc"></button>
								<input type="hidden" id="up_loc_pk" name="up_loc_pk" readonly>
								<input type="text" class="form-control" id="up_loc_nm" name="up_loc_nm" readonly>
							</div>
							<div class="form-group col-md-4">
								<label for="mtrl_nm" class="required">순환설비자재*</label>
								<button type="button" class="zoombutton" id="recycleMat" name="recycleMat"></button>
								<input type="hidden" class="form-control" id="mtrl_pk" name="mtrl_pk" readonly>
								<input type="text" class="form-control" data-msg="순환설비자재를" id="mtrl_nm" name="mtrl_nm" readonly>
							</div>
							<div class="form-group col-md-4">
								<label>코스트 센터</label>
								<select id="ccenter_cd" name="ccenter_cd"></select>
							</div>
							<div class="form-group col-md-4">
								<label for="environ_equip_yn" class="required">법정관리 설비 여부</label>
								<div class="field-wrapper">
									<input id="environ_equip_yn" name="environ_equip_yn" data-msg="법정관리 설비 여부를" />
								</div>
							</div>
							<div class="form-group col-md-4">
								<label>공급업체</label>
								<select id="supplier_pk" name="supplier_pk"></select>
							</div>
							<div class="form-group col-md-4">
								<label for="buy_cost">구매비용</label>
								<input type="number" class="form-control" id="buy_cost" name="buy_cost">
							</div>
							<div class="form-group col-md-4">
								<label for="warranty_dt">보증만료일</label>
								<input type="text" class="form-control" id="warranty_dt" name="warranty_dt" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; ">
							</div>
							<div class="form-group col-md-4">
								<label for="maker_pk">제조사</label>
								<select id="maker_pk" name="maker_pk"></select>
							</div>
							<div class="form-group col-md-4">
								<label for="model_number">모델넘버</label>
								<input type="text" class="form-control" id="model_number" name="model_number">
							</div>
							<div class="form-group col-md-4">
								<label for="serial_number">시리얼넘버</label>
								<input type="text" class="form-control" id="serial_number" name="serial_number">
							</div>
							<div class="form-group col-md-11">
								<label for="equip_dsc">비고</label>
								<textarea class="form-control" id="equip_dsc" name="equip_dsc" placeholder="2000자 이하로 입력하세요" maxlength="2000"></textarea>
							</div>
						</form>
					</div>

					<!-- 사양(Spec) 탭 컨텐츠 -->
					<div class="tab-pane" id="equipSpec">
						<div class="form-row">
							<div class="form-group col-md-2">
								<label>설비분류</label>
								<input type="text" class="form-control" id="equip_class_path" name="equip_class_path" readonly>
							</div>
							<div class="form-group col-md-5">
								<label>설비분류 설명</label>
								<input type="text" class="form-control" id="equip_class_desc" name="equip_class_desc" readonly>
							</div>
							<div class="form-group col-md-5">
								<label></label>
								<div style="display:flex;">
									<button type="button" class="outlinebutton" id="btnEquipClassDesc" name="btnEquipClassDesc"></button>
									<span style="width: 10px;"></span>
									<button type="button" class="trashbutton" id="btnEquipSpecDel" name="btnEquipSpecDel"></button>
								</div>
							</div>
						</div>
						<div>
							<label>설비사양</label>
							<button type="button" class="plusbutton" id="equipSpecPlus" name="equipSpecPlus"></button>
						</div>
						<div id="equSpecGrid" class="grid">
						</div>
					</div>

					<!-- Parts/BOM 탭 컨텐츠 -->
					<div class="tab-pane" id="equipPartsBom">
						<!-- Parts 섹션 -->
						<div style="margin-bottom: 20px;">
							<div style="display: flex; align-items: center; margin-bottom: 10px;">
								<div style="display: flex; align-items: center;">
									<span>Parts</span>
								</div>
								<button class="btn" id="btnEquipPartsBomMatMultiSel" name="btnEquipPartsBomMatMultiSel" style="margin-left: auto; background-color: #1e4f88; color: white; padding: 4px 12px; font-size: 12px;">자재선택</button>
							</div>
							<div id="partsGrid" class="grid"></div>
						</div>

						<!-- BOM 계층구조 보기 섹션 -->
						<div>
							<div style="display: flex; align-items: center; margin-bottom: 10px;">
								<div style="display: flex; align-items: center;">
									<span>BOM 계층구조 보기</span>									
								</div>
							</div>
							<div style="border: 1px solid #dee2e6; padding: 15px;">
								<div id="bomGrid" style="color: #1e4f88; font-weight: bold; margin-bottom: 10px;"></div>
							</div>
						</div>
					</div>

					<!--파일 탭 컨텐츠 -->
					<div class="tab-pane" id="fileTab" style="overflow-y:auto; height: 400px;">
						{% include 'components/ImageUpload.html' with tableName='cm_equipment' attachName='image' dataPk=cm_equipment.equip_pk|default:'' %}
						{% include 'components/FileUpload.html' with tableName='cm_equipment' attachName='file' dataPk=cm_equipment.equip_pk|default:'' %}
					</div>

					<!--PM 탭 컨텐츠 -->
					<div class="tab-pane" id="pmTab" style="overflow-y:auto; height: 300px;">
						<div id="pmGrid" class="grid"></div>
					</div>

					<!--점검 탭 컨텐츠 -->
					<div class="tab-pane" id="inspectionTab" style="overflow-y:auto; height: 300px;">
						<div id="inspectionGrid" class="grid"></div>
					</div>

					<!--로그 탭 컨텐츠 -->
					<div class="tab-pane" id="logTab">
						<div id="logGrid" class="grid"></div>
					</div>

					<!--자산평가 탭 컨텐츠 -->
					<div class="tab-pane" id="assetEvaluationTab" style="overflow-y:auto; height: 300px;">
						<div id="assetEvaluationGrid" class="grid"></div>
					</div>
				</div>
			</div>
		</div>
		<!-- 버튼 영역 -->
		<div class="modal-footer">
			<button type="button" style="background-color: #dc3545 !important; color: white !important; border-color: #d9534f !important;" id="disposedBtn">설비불용처리</button>
			<button type="button" style="background-color: #dc3545 !important; color: white !important; border-color: #d9534f !important;" id="notUseBtn">사용안함</button>
			<button type="button" class="btn-save" id="saveBtn">저장</button>
			<button type="button" class="btn-close" id="closeBtn">닫기</button>
		</div>
	</div>
</div>

	{% include 'popup/modalEquCategorySel.html' %}
	{% include 'popup/modalEquClassSel.html' %}
	{% include 'popup/modalEquLoc.html' %}
	{% include 'popup/modalEquLocHist.html' %}
	{% include 'popup/modalEquDeptHist.html' %}
	{% include 'popup/modalEquSel.html' %}
	{% include 'popup/modalMatSel.html' %}
	{% include 'popup/modalMatMultiSel.html' %}

<script type="text/javascript">
	class EquipMaster {
		constructor() {
			this.baseUrl = '/api/kmms/equipment';
			this.equip_pk = null;
			this.equip_cd = null;
			this.equipStatusYN = false;

			// DropDown Tree와 List 컨트롤 정의
			this.locPkDropDown = null;
			this.deptPkDropDown = null;
			this.importRankDropDown = null;
			this.processCdDropDown = null;
			this.systemCdDropDown = null;
			this.ccenterCdDropDown = null;
			this.supplierDropDown = null;
			this.makerDropDown = null;

			// 그리드 컨트롤 정의
			this.pmGrid = null;
			this.equSpecGrid = null;
			this.partsGrid = null;
			this.bomGrid = null;
			this.inspectionGrid = null;
			this.logGrid = null;
			this.assetEvaluationGrid = null;

			// DatePicker 컨트롤 정의
			this.productionYearPicker = null;
			this.installDatePicker = null;
			this.warrantyDatePicker = null;

			// Switch 컨트롤 정의
			this.environEquipYnSwitch = null;

			// 모달 관련 요소 정의
			this.modal = null;

			this.init();
		}

		init() {
			const _this = this;
			this.modal = $("#modalEquipMaster");

			// DropDown Tree와 List 초기화
			this.locPkDropDown = AjaxUtil.fillDropDownTreeOptions($('#loc_pk'), 'cm_location', 'all');
			this.deptPkDropDown = AjaxUtil.fillDropDownTreeOptions($('#dept_pk'), 'cm_depart', 'all');
			this.importRankDropDown = AjaxUtil.fillDropDownOptions($('#import_rank_pk'), 'cm_import_rank', 'all', null);
			this.processCdDropDown = AjaxUtil.fillDropDownOptions($('#process_cd'), 'cm_code', 'all', null, 'EQUIPMENT_PROCESS');
			this.systemCdDropDown = AjaxUtil.fillDropDownOptions($('#system_cd'), 'cm_code', 'all', null, 'EQUIP_SYSTEM');
			this.supplierDropDown = AjaxUtil.fillDropDownOptions($('#supplier_pk'), 'cm_supplier', 'all', null, 'COMP_TYPE', 'CP_S,CP_B');
			this.makerDropDown = AjaxUtil.fillDropDownOptions($('#maker_pk'), 'cm_supplier', 'all', null, 'COMP_TYPE', 'CP_M,CP_B');
			this.ccenterCdDropDown = AjaxUtil.fillDropDownOptions($('#ccenter_cd'), 'cm_code', 'all', null, 'COST_CENTER');

			// DatePicker 초기화
			this.productionYearPicker = $("#make_dt").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");
			this.installDatePicker = $("#install_dt").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");
			this.warrantyDatePicker = $("#warranty_dt").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");

			// Switch 초기화
			this.environEquipYnSwitch = $("#environ_equip_yn").kendoSwitch().data("kendoSwitch");

			// 버튼 이벤트 핸들러 설정
			$("#equipLocPlus").kendoButton({
				icon: "k-i-plus",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalWindow', { width: '70%', height: '70%' });
					locationPage.show(function (ctrl) {
						if (ctrl === 'equip_loc') {
							AjaxUtil.fillDropDownTreeOptions($('#loc_pk'), 'cm_location', 'all');
						}
					});
				}
			});

			$("#btnEquipCategory").kendoButton({
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEquCategorySel', { width: '40%', height: '70%' });
					equipCategoryPage.show(function (res) {
						$("#equip_category_id").val(res.equip_category_id);
						$("#equip_category").val(res.remark);
					});
				}
			});

			$("#equipLocHist").kendoButton({
				icon: "k-i-grid-layout",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEquipLocHist', { width: '70%', height: '55%' });
					equipLocHistPage.show();
				}
			});

			$("#mngDept").kendoButton({
				icon: "k-i-grid-layout",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalWindowDept', { width: '60%', height: '55%' });
					equipDeptHistPage.show();
				}
			});

			$("#upLoc").kendoButton({
				icon: "k-i-zoom-in",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEqu', { width: '70%', height: '70%' });
					equipSelectPage.show(function (data) {
						$("#up_loc_pk").val(data._equip_pk);
						$("#up_loc_nm").val(data._equip_nm);
					});
				}
			});

			$("#recycleMat").kendoButton({
				icon: "k-i-zoom-in",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalMatSel');
					matSelectPage.show(function (data) {
						$("#mtrl_pk").val(data._mtrl_pk);
						$("#mtrl_nm").val(data._mtrl_nm);
					});
				}
			});

			$('#disposedBtn').kendoButton({});
			$('#notUseBtn').kendoButton({});

			$("#btnEquipClassDesc").kendoButton({
				icon: "k-i-insert-top",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEquClass', { width: '70%', height: '70%' });
					equipClassPage.show(function (data) {
						$("#equip_class_path").val(data.hierarchy_path);
						$("#equip_class_desc").val(data.equip_class_desc);
					}, $("#equip_category_id").val(), $("#equip_category").val());
				}
			});

			$("#btnEquipSpecDel").kendoButton({
				icon: "k-i-trash",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					$("#equip_class_path").val('');
					$("#equip_class_desc").val('');
				}
			});

			$("#btnEquipPartsBomMatMultiSel").kendoButton({		
				rounded: "full",
				click: function (e) {
					e.preventDefault();					
					setModalPosition('#modalMatMultiSel', { width: '70%', height: '70%' });
					matMultiSelectPage.show(function (data) {			
						if (Array.isArray(data)) {
							data.forEach(function(row) {
								_this.partsGrid.dataSource.add(row);
							});
						}
					});
				}
			});

			$("#btnConfirmEquipSpec").kendoButton({ icon: "k-i-save", themeColor: "base" });
			$("#btnCancelEquipSpec").kendoButton({ icon: "k-i-cancel", themeColor: "base" });

			// 설비사양 설정 Kendo Window 초기화
			$("#specSettingWindow").kendoWindow({
				width: "600px",
				title: "설비사양 설정",
				visible: false,
				modal: true,
				actions: []
			});

			// 행 추가 함수
			function addSpecRow(specnm = '', unit = '', spec = '') {
				const $tbody = $("#specTable tbody");
				const row = `
					<tr>
						<td class="spec-row-delete-container">
							<button class="spec-row-delete-btn removeSpecRowBtn">
								<span class="spec-row-delete-icon">×</span>
							</button>
						</td>
						<td width="30%"><input type="text" class="k-textbox spec-input-field" value="${specnm}"></td>
						<td width="20%"><input type="text" class="k-textbox spec-input-field" value="${unit}"></td>
						<td width="38%"><input type="text" class="k-textbox spec-input-field" value="${spec}"></td>
					</tr>
				`;
				$tbody.append(row);
			}

			// 행 추가 버튼 이벤트
			$("#addSpecRowBtn").on("click", function () {
				addSpecRow();
			});

			// 행 삭제 버튼 이벤트 (위임)
			$("#specTable").on("click", ".removeSpecRowBtn", function () {
				$(this).closest("tr").remove();
			});

			// 확인/취소 버튼 이벤트
			$("#btnConfirmEquipSpec").on("click", () => {
				// 1. 입력값 수집
				const specRows = [];
				$("#specTable tbody tr").each(function (index) {
					const $tds = $(this).find("td");
					const specnm = $tds.eq(1).find("input").val();
					const unit = $tds.eq(2).find("input").val();
					const spec = $tds.eq(3).find("input").val();
					if (specnm || unit || spec) { // 모두 빈 값이면 제외
						specRows.push({
							no: index + 1,
							specnm: specnm,
							unit: unit,
							spec: spec
						});
					}
				});

				// 2. equSpecGrid에 데이터 반영
				_this.equSpecGrid.dataSource.data(specRows);

				// 3. 팝업 닫기
				$("#specSettingWindow").data("kendoWindow").close();
			});

			// 취소 버튼 이벤트
			$("#btnCancelEquipSpec").on("click", () => {
				$("#specSettingWindow").data("kendoWindow").close();
			});

			// 플러스 버튼 클릭 시 Kendo Window 오픈
			$("#equipSpecPlus").kendoButton({
				icon: "k-i-plus",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					// 기존 행 초기화
					$("#specTable tbody").empty();
					
					// equSpecGrid의 데이터 가져오기
					const gridData = _this.equSpecGrid.dataSource.data();
					
					// 데이터가 있으면 모든 행 추가
					if (gridData && gridData.length > 0) {
						gridData.forEach(function(row) {
							addSpecRow(row.specnm, row.unit, row.spec);
						});
					} else {
						// 데이터가 없으면 빈 행 추가
						addSpecRow();
					}
					
					$("#specSettingWindow").data("kendoWindow").center().open();
				}
			});

			// 기존 이벤트 핸들러 제거
			$('#saveBtn').off('click');

			$('#saveBtn').kendoButton({
				click: function (e) {
					e.preventDefault();  // 이벤트 기본 동작 방지
					_this.saveData();					
				}
			});

			$('#closeBtn').kendoButton({
				click: function () {
					_this.resetForm();
					// 기본정보 탭 활성화
					$('.tab-button').removeClass('active').removeAttr('style');
					$('.tab-pane').removeClass('active').hide();
					$('.tab-button[data-tab="equipMasterForm"]').addClass('active').css({
						'background': '#1e4f88',
						'color': 'white',
						'border-color': '#1e4f88'
					});
					$('#equipMasterForm').addClass('active').show();
					_this.modal.fadeOut();
				}
			});

			// ESC 키로 모달 닫기
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) this.modal.fadeOut();
			});

			this.equSpecGrid = $("#equSpecGrid").kendoGrid({		
				height: 200,
				sortable: true,
				pageable: false,
				autoBind: false,
				columns: [
					{ field: "no", title: "NO", width: 120 },
					{ field: "specnm", title: "사양명", width: 120, },
					{ field: "unit", title: "단위", width: 100 },
					{ field: "spec", title: "사양(Spec)", width: 100 }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.partsGrid = $("#partsGrid").kendoGrid({
				height: 200,
				sortable: true,
				columns: [
					{ field: "_mtrl_pk", title: "NO", width: 80, attributes: { style: "text-align: center" } },
					{ field: "_mtrl_cd", title: "자재코드", width: 120 },
					{ field: "_mtrl_class_nm", title: "자재명", width: 200 },
					{ field: "_safety_stock_amt", title: "구성수량", width: 100, attributes: { style: "text-align: center" } },
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var grid = this;
								var tr = $(e.target).closest("tr");
								var dataItem = grid.dataItem(tr);
								grid.dataSource.remove(dataItem);
							}
						},
						width: 100
					}
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			const optionBom = {
				dataSource: {
					schema: {
						model: {
							id: "disp_cd",
							parentId: "disp_up_cd",
							fields: {
								disp_up_cd: { field: "disp_up_cd", nullable: true },
								disp_cd: { field: "disp_cd" },
								disp_nm: { field: "disp_nm" }
							},
							expanded: true
						}
					}
				},
				height: 200,
				filterable: true,
				sortable: true,
				columns: [					
					{ field: "disp_nm", title: "설비" },
				],
				selectable: true,
			};
			this.bomGrid = $("#bomGrid").kendoTreeList(optionBom).data("kendoTreeList");

			// 그리드 초기화 코드는 그대로 유지...
			this.pmGrid = $("#pmGrid").kendoGrid({
				height: 300,
				sortable: true,
				columns: [
					{ field: "pm_pk", hidden: true },
					{ field: "pm_no", title: "PM번호", width: 200, attributes: { style: "text-align: center" } },
					{ field: "pm_nm", title: "PM명", width: 200 },
					{ field: "dept_nm", title: "설명부서", width: 120, attributes: { style: "text-align: center" } },
					{ field: "pm_user_nm", title: "PM 담당자", width: 120, attributes: { style: "text-align: center" } },
					{ field: "pm_type_nm", title: "PM유형", width: 100, attributes: { style: "text-align: center" } },
					{ field: "per_number", title: "주기", width: 80, attributes: { style: "text-align: center" } },
					{ field: "cycle_type_nm", title: "주기단위", width: 100, attributes: { style: "text-align: center" } },
					{ field: "last_work_dt", title: "최근 완료일", width: 120, attributes: { style: "text-align: center" } },
					{ field: "use_yn", title: "사용여부", width: 100, attributes: { style: "text-align: center" } }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.inspectionGrid = $("#inspectionGrid").kendoGrid({
				height: 300,
				sortable: true,
				columns: [
					{ field: "inspection_no", title: "점검번호", width: 100, attributes: { style: "text-align: center" } },
					{ field: "inspection_nm", title: "점검명", width: 200 },
					{ field: "dept_nm", title: "점검부서", width: 120, attributes: { style: "text-align: center" } },
					{ field: "manager_nm", title: "점검담당자", width: 120, attributes: { style: "text-align: center" } },
					{ field: "inspection_type", title: "점검유형", width: 100, attributes: { style: "text-align: center" } },
					{ field: "cycle", title: "주기", width: 80, attributes: { style: "text-align: center" } },
					{ field: "cycle_unit", title: "주기단위", width: 100, attributes: { style: "text-align: center" } },
					{ field: "last_complete_dt", title: "최근 완료일", width: 120, attributes: { style: "text-align: center" } },
					{ field: "use_yn", title: "사용여부", width: 100, attributes: { style: "text-align: center" } }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.assetEvaluationGrid = $("#assetEvaluationGrid").kendoGrid({
				height: 300,
				sortable: true,
				columns: [
					{ field: "evaluation_criteria", title: "자산평가기준", width: 150, attributes: { style: "text-align: center" } },
					{ field: "evaluation_grade", title: "자산평가단계", width: 150, attributes: { style: "text-align: center" } },
					{ field: "evaluation_value", title: "자산평가값", width: 150, attributes: { style: "text-align: center" } },
					{ field: "last_evaluation_dt", title: "최종자산평가", width: 150, attributes: { style: "text-align: center" } }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.logGrid = $("#logGrid").kendoGrid({
				dataSource: {
					transport: {
						read: {
							url: this.baseUrl,
							type: "GET",
							data: function () {
								return {
									action: 'log',
									equip_pk: _this.equip_pk
								};
							}
						}
					},
					schema: {
						data: function (response) {
							console.log("Grid Response:", response);
							if (Array.isArray(response)) {
								return response;
							}
							return [];
						}
					},
				},
				autoBind: false,
				height: 300,
				sortable: true,
				columns: [
					{ field: "inserter_nm", title: "사용자", width: 100, attributes: { style: "text-align: center" } },
					{ field: "log_type", title: "로그 타입", width: 120, attributes: { style: "text-align: center" } },
					{ field: "log_history", title: "로그 내역", width: 500 },
					{ field: "log_date", title: "일시", width: 150, attributes: { style: "text-align: center" } }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			// 탭 클릭 이벤트
			$('.tab-button').on('click', function () {
				const tabId = $(this).data('tab');
				$('.tab-button').removeClass('active').removeAttr('style');
				$('.tab-pane').removeClass('active').hide();
				$(this).addClass('active').css({
					'background': '#1e4f88',
					'color': 'white',
					'border-color': '#1e4f88'
				});
				if (tabId) $('#' + tabId).addClass('active').show();

				// switch-case로 탭별 분기 처리
				switch (tabId) {
					case 'equipSpec':
						if (_this.equip_pk) {
							var param = {
								action: 'findAll',
								equipPk: _this.equip_pk
							};
							let equipSpecData = AjaxUtil.getSyncData('/api/kmms/equip_spec', param);
							_this.bindEquipSpec(equipSpecData);
						}
						break;
					case 'equipPartsBom':
						if (_this.equip_pk) {
							var paramParts = {
								action: 'getEquipPartMtrls',
								equipPk: _this.equip_pk
							};

							let equipPartsData = AjaxUtil.getSyncData('/api/kmms/equip_part_mtrl', paramParts);
							_this.bindEquipParts(equipPartsData);
							
							// BOM 그리드 데이터 가져오기
							var paramBom = {
								action: 'getEquipBomTree',
								equip_cd: _this.equip_cd
							};
							
							let equipBomData = AjaxUtil.getSyncData('/api/kmms/equip_part_mtrl', paramBom);
							_this.bindEquipBom(equipBomData);
						}
						break;
					case 'logTab':
						if (_this.equip_pk && _this.logGrid) {
							_this.logGrid.dataSource.read();
						}
						break;
					case 'pmTab':
						if (_this.equip_pk && _this.pmGrid) {
							var param = {
								action: 'getEquipPmList',
								equip_pk: _this.equip_pk
							};
							let equipPmData = AjaxUtil.getSyncData(_this.baseUrl, param);
							_this.pmGrid.dataSource.data(equipPmData);
						}
						break;
					case 'inspectionTab':
						if (_this.equip_pk && _this.inspectionGrid) {
							_this.inspectionGrid.dataSource.read();
						}
						break;
					case 'assetEvaluationTab':
						if (_this.equip_pk && _this.assetEvaluationGrid) {
							_this.assetEvaluationGrid.dataSource.read();
						}
						break;
					case 'fileTab':
						if (_this.equip_pk) {					
							if (window.imageUploader) {
								window.imageUploader.dataPk = _this.equip_pk;
								window.imageUploader.loadFilesFromServer(() => {
									showMainImageFromUploader();
								});
							}

							if (window.fileUploader) {
								window.fileUploader.dataPk = _this.equip_pk;
								window.fileUploader.loadFilesFromServer(() => {
									showMainFileFromUploader();
								});
							}

						}
						break;
				}
			});

			// 팝업이 열릴 때 깨지는 컨트롤만 명시적으로 Kendo 위젯을 직접 초기화 (이미 적용된 경우는 건드리지 않음)
			setTimeout(function() {
				var $locPk = $('#loc_pk');
				if ($locPk.length && !$locPk.data('kendoDropDownTree')) {
					AjaxUtil.fillDropDownTreeOptions($locPk, 'cm_location', 'all');
				}
				var $deptPk = $('#dept_pk');
				if ($deptPk.length && !$deptPk.data('kendoDropDownTree')) {
					AjaxUtil.fillDropDownTreeOptions($deptPk, 'cm_depart', 'all');
				}
				var $environSwitch = $('#environ_equip_yn');
				if ($environSwitch.length && !$environSwitch.data('kendoSwitch')) {
					$environSwitch.kendoSwitch();
				}
			}, 100);
		}

		//설비 마스터
		show(equip_pk) {
			let _this = this;
			_this.equip_pk = equip_pk;			
			_this.equipStatusYN = _this.equip_pk ? true : false;

			// 설비 상세 정보 API 호출
			let param = {
				action: 'findOne',
				equip_pk: equip_pk,
			};
			
			let equipData = AjaxUtil.getSyncData('/api/kmms/equipment', param);			
			_this.equip_cd = equipData.equip_cd;

			//썸네일 이미지			
			_this.showEquipThumbmail(equip_pk);

			// 기본정보
			this.bindEquipMasterData(equipData);

			if (equipData) {
				$("#modalEquipMaster").fadeIn();
			}

		}

		//저장
		saveData() {
			let _this = this;

			let data = FormUtil.extractForm($('#baseinfoForm'));
			data.equip_pk = _this.equip_pk;
			data.equipCode = $("#equip_code").val();
			data.equipName = $("#equip_name").val();
			data.equip_category_id = $("#equip_category_id").val();
			data.equipClassName = $("#equip_category").val();
			data.loc_pk = $("#loc_pk").data("kendoDropDownTree").value();
			data.dept_pk = $("#dept_pk").data("kendoDropDownTree").value();
			data.EquipClassPath = $("#equip_class_path").val();
			data.EquipClassDesc = $("#equip_class_desc").val();

			// 사양 그리드 데이터 추가
			if (_this.equSpecGrid) {
				data.specList = _this.equSpecGrid.dataSource.data().map(row => ({
					specnm: row.specnm,
					unit: row.unit,
					spec: row.spec
				}));
			}

			// Parts 그리드 데이터 추가
			if (_this.partsGrid) {
				data.partsList = _this.partsGrid.dataSource.data().map(row => ({
					_mtrl_pk: row._mtrl_pk,
					_mtrl_cd: row._mtrl_cd,
					_mtrl_class_nm: row._mtrl_class_nm,
					_safety_stock_amt: row._safety_stock_amt
				}));
			}

			console.log('data:', data);

			// 폼 외부 필드 유효성 검사
			if (!data.equipCode) {
				Alert.alert('', '설비코드를 입력해주세요.');
				return;
			}

			if (!data.equipName) {
				Alert.alert('', '설비명을 입력해주세요.');
				return;
			}

			if (!data.equipClassName) {
				Alert.alert('', '카테고리를 선택해주세요.');
				return;
			}

			if (!data.loc_pk) {
				Alert.alert('', '설비위치를 선택해주세요.');
				return;
			}

			if (!data.dept_pk) {
				Alert.alert('', '관리부서를 선택해주세요.');
				return;
			}
			if (!$('#install_dt').val()) {
				Alert.alert('', '설치일을 선택해주세요.');
				return;
			}
			if (!$('#mtrl_nm').val()) {
				Alert.alert('', '순환설비자재를 선택해주세요.');
				return;
			}

			let fnSuccess = function (res) {
				console.log('saveData', res);
				console.log('equip_pk:', _this.equip_pk);
				if (res.success) {					
					//파일 저장
					const result = fetchSomeData();

					Alert.alert('', res.message);
					_this.resetForm();
					_this.modal.fadeOut();
				} else if (!res.success) {
					Alert.alert('', res.message);
				}
			};
			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, fnSuccess);
		}

		bindEquipMasterData(data) {
			console.log('cm_equipment_findOne', data);
			$("#equip_code").val(data.equip_cd);
			$("#equip_name").val(data.equip_nm);
			$("#txt_equip_status").val(data.equip_status_nm);
			$("#equip_category_id").val(data.equip_category_id);
			$("#equip_category").val(data.equip_category_remark);

			FormUtil.BindDataForm(data, $('#baseinfoForm'));

			//사양(Spec)
			$("#equip_class_path").val(data.equip_class_path); //설비분류
			$("#equip_class_desc").val(data.equip_class_desc); // 설비분류설명
		}

		bindEquipSpec(data) {
			console.log('bindEquipSpec', data);
			// 그리드에 맞는 데이터로 변환
			const gridData = (data || []).map((row, idx) => ({
				no: idx + 1,
				specnm: row.equip_spec_nm,
				unit: row.equip_spec_unit,
				spec: row.equip_spec_value
			}));
			this.equSpecGrid.dataSource.data(gridData);
		}

		bindEquipParts(data) {
			console.log('bindEquipParts', data);
			// 그리드에 맞는 데이터로 변환
			const gridData = (data || []).map((row, idx) => ({
				no: idx + 1,				
				_mtrl_pk: row.mtrl_pk,
				_mtrl_cd: row.mtrl_cd,
				_mtrl_class_nm: row.mtrl_nm,
				_safety_stock_amt: row.amt,
			}));
			this.partsGrid.dataSource.data(gridData);
		}

		bindEquipBom(data) {
			console.log('bindEquipBom', data);
			// 그리드에 맞는 데이터로 변환 (빈 문자열을 null로 변환)
			const gridData = (data || []).map((row, idx) => ({
				disp_up_cd: row.disp_up_cd === "" ? null : row.disp_up_cd,
				disp_cd: row.disp_cd,
				disp_nm: row.disp_nm,
			}));
			this.bomGrid.dataSource.data(gridData);
		}

		showEquipThumbmail(dataPk) {
			console.log('showEquipThumbmail', dataPk);
			const url = '/api/files/upload?action=call_attach_file';
			const data = {			
				tableName: 'cm_equipment',
				attachName: 'image',
				dataPk: dataPk || ''
			};

			AjaxUtil.postAsyncData(url, data, (res) => {
				if (res.success && res.data && res.data.length > 0) {
					// 마지막 이미지 데이터 가져오기
					const lastImage = res.data[res.data.length - 1];
					const imageSrc = '/uploads/plant_i/cm_equipment/' + lastImage.PhysicFileName;
					
					// 썸네일 이미지 업데이트
					$("#equipThumbmail").attr("src", imageSrc);
				} else {
					// 이미지가 없는 경우 기본 이미지 표시
					$("#equipThumbmail").attr("src", "/static/img/no-image.png");
				}
			});
		}

		// 모달 초기화 메소드
		resetForm() {
			// 기본 입력 필드 초기화
			$("#modalEquipMaster input[type='text']").val('');
			$("#modalEquipMaster input[type='number']").val('');
			$("#modalEquipMaster input[type='date']").val('');
			$("#modalEquipMaster input[type='hidden']").val('');
			$("#modalEquipMaster textarea").val('');

			// DropDown 컨트롤 초기화
			if (this.locPkDropDown) this.locPkDropDown.value('');
			if (this.deptPkDropDown) this.deptPkDropDown.value('');
			if (this.importRankDropDown) this.importRankDropDown.value('');
			if (this.processCdDropDown) this.processCdDropDown.value('');
			if (this.systemCdDropDown) this.systemCdDropDown.value('');
			if (this.supplierDropDown) this.supplierDropDown.value('');
			if (this.makerDropDown) this.makerDropDown.value('');
			if (this.ccenterCdDropDown) this.ccenterCdDropDown.value('');

			// DatePicker 초기화
			if (this.productionYearPicker) this.productionYearPicker.value('');
			if (this.installDatePicker) this.installDatePicker.value('');
			if (this.warrantyDatePicker) this.warrantyDatePicker.value('');

			// Switch 초기화
			if (this.environEquipYnSwitch) this.environEquipYnSwitch.check(false);

			// 이미지 초기화
			if (window.imageUploader && typeof window.imageUploader.clearFiles === 'function') {
				window.imageUploader.clearFiles();
			}

			// 파일 초기화
			if (window.fileUploader && typeof window.fileUploader.clearFiles === 'function') {
				window.fileUploader.clearFiles();
			}

			// 그리드 초기화
			if (this.pmGrid) this.pmGrid.dataSource.data([]);
			if (this.equSpecGrid) this.equSpecGrid.dataSource.data([]);
			if (this.partsGrid) this.partsGrid.dataSource.data([]);
			if (this.inspectionGrid) this.inspectionGrid.dataSource.data([]);
			if (this.logGrid) this.logGrid.dataSource.data([]);
			if (this.assetEvaluationGrid) this.assetEvaluationGrid.dataSource.data([]);

			// 기본 이미지로 복원
			$("#modalEquipMaster img").attr("src", "/static/img/no-image.png");

			// 클래스 속성 초기화
			this.equip_pk = null;
			this.equipStatusYN = false;
		}
	}


	$(document).ready(function () {
		if (typeof window.equipMasterPage === 'undefined') {
			window.equipMasterPage = new EquipMaster();
		}
	});

	function showMainImageFromUploader() {
		if (!window.imageUploader) return;

		const imageDataList = window.imageUploader.getImagesData();
		const mainImage = imageDataList.find(file => file); // 첫 번째 이미지

		const container = document.querySelector('#modalEquipMaster .image-container');
		if (container) {
			if (mainImage) {
				container.innerHTML = `
					<img src="${mainImage.src}" alt="${mainImage.name}" style="max-width: 100%; max-height: 100%;">
				`;
			} else {
				// fallback 이미지
				container.innerHTML = `
					<div style="text-align: center;">
						<img src="/static/img/no-image.png" alt="No image" style="width: 100px; height: 100px;">
						<div style="margin-top: 10px; color: #999;">No image</div>
					</div>
				`;
			}
		}
	}

	function showMainFileFromUploader() {
		if (!window.fileUploader) return;

		const fileDataList = window.fileUploader.getFilesData();
		const mainFile = fileDataList.find(file => file); // 첫 번째 파일

		const container = document.querySelector('#modalEquipMaster .file-container');
		if (container) {
			if (mainFile) {
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #1e4f88;"></i>
						<div style="margin-top: 10px; color: #333;">${mainFile.name}</div>
						<div style="color: #666; font-size: 12px;">${formatFileSize(mainFile.size)}</div>
					</div>
				`;
			} else {
				// fallback 파일 표시
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #999;"></i>
						<div style="margin-top: 10px; color: #999;">No file</div>
					</div>
				`;
			}
		}
	}

	function formatFileSize(bytes) {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}

	function fetchSomeData() {
		try {
			if (window.imageUploader) {
				const imageResult = window.imageUploader.saveImages();
			}
			if (window.fileUploader) {
				const fileResult = window.fileUploader.saveFiles();
			}
		} catch (error) {
			console.error('Error:', error);
			alert(error.message);
			throw error;
		}
	}

	$(document).on("click", ".grid-column-link", async function (e) {
		e.preventDefault();
		let equipPk = $(this).data("equip-pk");
		if (!equipPk) return;

		// 이미 로드된 경우 재사용
		if ($('#modalEquipMaster').length > 0 && typeof equipMasterPage !== 'undefined') {
			equipMasterPage.show(equipPk);
			// 기본정보 탭 활성화
			$('.tab-button').removeClass('active').removeAttr('style');
			$('.tab-pane').removeClass('active').hide();
			$('.tab-button[data-tab="equipMasterForm"]').addClass('active').css({
				'background': '#1e4f88',
				'color': 'white',
				'border-color': '#1e4f88'
			});
			$('#equipMasterForm').addClass('active').show();
			return;
		}
	});
</script>

<!-- 설비사양 설정 Kendo Window 팝업 -->
<div id="specSettingWindow" class="dynamic-window" style="display:none;">
	<table id="specTable" class="k-grid k-widget dynamic-table" style="width: 100%; height: 300px; overflow-y: auto; ">
		<thead>
			<tr>
				<th>
					<button id="addSpecRowBtn" class="k-button k-primary">행 추가</button>
				</th>
				<th>사양명</th>
				<th>단위</th>
				<th>사양(Spec)</th>
			</tr>
		</thead>
		<tbody>
			<!-- 동적 행 추가 -->
		</tbody>
	</table>
	<div class="modal-footer">
		<button type="button" class="btn-save" id="btnConfirmEquipSpec">확인</button>
		<button type="button" class="btn-close" id="btnCancelEquipSpec">취소</button>
	</div>
</div>

