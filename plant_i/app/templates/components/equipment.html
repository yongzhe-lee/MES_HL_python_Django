<div id="modalEquipMaster" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>설비마스터 상세정보</h4>
		</div>
		<div class="modal-body">
			<div class="edit-form-ui">
				<div class="col-12 col-sm-6 col-md-3" style="display: flex; justify-content: center; align-items: center; height: 200px; border: 1px solid #ddd; margin-bottom: 10px;">
					<img id="equipThumbmail" src="/static/img/no-image.png" alt="No image" style="width: 200px; height: 200px; object-fit: contain; object-position: center;">
				</div>
				<div class="col-12 col-sm-5 col-md-6">
					<div class="form-group col-12">
						<label for="equip_code" class="required">설비코드</label>
						<input type="text" class="form-control" id="equip_code" name="equip_code" placeholder="20자 이하로 입력해주세요">
					</div>
					<div class="form-group col-12">
						<label for="equip_name" class="required">설비명</label>
						<input type="text" class="form-control" id="equip_name" name="equip_name" placeholder="200자 이하로 입력해주세요">
					</div>
					<div id="div_equip_status" class="form-group col-12" style="display:none;">
						<div>
							<label for="txt_equip_status" data-labelCd="설비상태">설비상태</label>
							<div style="display: flex; align-items: center;">
								<input type="text" class="form-control" id="txt_equip_status" name="txt_equip_status" style="flex: 0.3;" readonly />
								<button id="btnChangeStatus" class="btn" style="background-color: #6c757d !important; border: 1px solid #6c757d !important; color: white !important; margin-left: 20px;">상태변경</button>
							</div>
						</div>
						<div id="div_equip_date_container" style="display:none;">
							<label for="txt_equip_date" data-labelCd="고장일시">고장일시</label>
							<div style="display: flex; align-items: center;">
								<input type="text" class="form-control" id="txt_equip_date" name="txt_equip_date" style="flex: 0.3;" readonly />
							</div>
						</div>
						<div id="div_disposed_date_container" style="display:none;">
							<label for="txt_disposed_date" data-labelCd="불용일시">불용일시</label>
							<div style="display: flex; align-items: center;">
								<input type="text" class="form-control" id="txt_disposed_date" name="txt_disposed_date" style="flex: 0.3;" readonly />
							</div>
						</div>
					</div>
				</div>
				<div class="col-12 col-sm-6 col-md-3" style="display: flex; justify-content: center; align-items: center; height: 200px;">
					<div style="display: flex; flex-direction: column; justify-content: space-between; height: 190px;">
						<div style="width: 100%; height: 130px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; background-color: white; visibility: hidden;">
							<img src="/static/img/qr-sample.png" alt="QR Code" style="width: 110px; height: 110px;">
						</div>
						<div>
							<div style="text-align: left; color: red; margin-bottom: 5px;">
								카테고리*
							</div>
							<div style="display: flex; gap: 5px;">
								<input type="hidden" id="equip_category_id" name="equip_category_id" />
								<input type="text" class="form-control" id="equip_category" name="equip_category" style="background-color: #f9f9f9; flex: 1;" readonly>
								<button id="btnEquipCategory" class="btn" style="min-width: 36px; padding: 0; background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; outline: none;">
									<!-- <img src="/static/img/folder-icon.png" alt="폴더" style="width: 24px; height: 24px;"> -->
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 탭 섹션 -->
			<div class="section">
				<div class="tab-group">
					<button class="tab-button active" data-tab="equipMasterForm" style="background: #1e4f88; color: white; border-color: #1e4f88;">기본정보</button>
					<button class="tab-button" data-tab="equipSpec">사양(Spec)</button>
					<!-- <button class="tab-button" data-tab="equipPartsBom">Parts/BOM</button> -->
					<button class="tab-button" data-tab="fileTab">파일</button>
					<button class="tab-button" data-tab="pmTab">PM</button>
					<button class="tab-button" data-tab="inspectionTab">점검</button>
					<button class="tab-button" data-tab="logTab">로그</button>
				</div>
				<div class="tab-content">
					<!-- 기본정보 탭 컨텐츠 -->
					<div class="tab-pane active" id="equipMasterForm">
						<form id="baseinfoForm">
							<div class="form-group col-md-3">
								<label for="loc_pk" class="required" data-labelCd="EquipLoc">설비위치</label>
								<button type="button" class="plusbutton" id="equipLocPlus" name="equipLocPlus" style="display: none !important;"></button>
								<button type="button" class="gridbutton" id="equipLocHist" name="equipLocHist"></button>
								<select id="loc_pk" name="loc_pk" data-msg="설비위치를" required></select>
							</div>
							<div class="form-group col-md-3">
								<label for="dept_pk" class="required" data-labelCd="관리부서">관리부서</label>
								<button type="button" class="gridbutton" id="mngDept" name="mngDept"></button>
								<select id="dept_pk" name="dept_pk" data-msg="관리부서를"></select>
							</div>
							<div class="form-group col-md-3">
								<label class="required" data-labelCd="설치일">설치일</label>
								<input type="date" id="install_dt" name="install_dt" class="form-control" data-msg="설치일을" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; ">
							</div>
							<div class="form-group col-md-3">
								<label>설비중요도</label>
								<select id="import_rank_pk" name="import_rank_pk"></select>
							</div>
							<div class="form-group col-md-3">
								<label>제조일</label>
								<input type="date" id="make_dt" name="make_dt" class="form-control" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; ">
							</div>
							<div class="form-group col-md-3">
								<label for="asset_nos">자산번호</label>
								<input type="text" class="form-control" id="asset_nos" name="asset_nos">
							</div>
							<div class="form-group col-md-3">
								<label>상위설비</label>
								<button type="button" class="zoombutton" id="upLoc" name="upLoc"></button>
								<input type="hidden" id="up_equip_pk" name="up_equip_pk" readonly>
								<input type="text" class="form-control" id="up_equip_nm" name="up_equip_nm" readonly>
							</div>
							<div class="form-group col-md-3">
								<label for="mtrl_nm">순환설비자재</label>
								<button type="button" class="zoombutton" id="recycleMat" name="recycleMat"></button>
								<input type="hidden" class="form-control" id="mtrl_pk" name="mtrl_pk" readonly>
								<input type="text" class="form-control" data-msg="순환설비자재를" id="mtrl_nm" name="mtrl_nm" readonly>
							</div>
							<div class="form-group col-md-3">
								<label for="environ_equip_yn" class="required">법정관리 설비 여부</label>
								<div class="field-wrapper">
									<input id="environ_equip_yn" name="environ_equip_yn" data-msg="법정관리 설비 여부를" />
								</div>
							</div>
							<div class="form-group col-md-3">
								<label>코스트 센터</label>
								<select id="ccenter_cd" name="ccenter_cd"></select>
							</div>
							<div class="form-group col-md-3">
								<label>공급업체</label>
								<select id="supplier_pk" name="supplier_pk"></select>
							</div>
							<div class="form-group col-md-3">
								<label for="maker_pk">제조사</label>
								<select id="maker_pk" name="maker_pk"></select>
							</div>
							<div class="form-group col-md-3">
								<label for="buy_cost">구매비용</label>
								<input type="number" class="form-control" id="buy_cost" name="buy_cost">
							</div>
							<div class="form-group col-md-3">
								<label for="warranty_dt">보증만료일</label>
								<input type="text" class="form-control" id="warranty_dt" name="warranty_dt" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; ">
							</div>

							<div class="form-group col-md-3">
								<label for="model_number">모델넘버</label>
								<input type="text" class="form-control" id="model_number" name="model_number">
							</div>
							<div class="form-group col-md-3">
								<label for="serial_number">시리얼넘버</label>
								<input type="text" class="form-control" id="serial_number" name="serial_number">
							</div>
							<div class="form-group col-md-11">
								<label for="equip_dsc">비고</label>
								<textarea class="form-control" style="height: auto !important;" rows="2" id="equip_dsc" name="equip_dsc" placeholder="2000자 이하로 입력하세요" maxlength="2000"></textarea>
							</div>
						</form>
					</div>

					<!-- 사양(Spec) 탭 컨텐츠 -->
					<div class="tab-pane" id="equipSpec">
						<div class="form-row">
							<div class="form-group col-md-2">
								<label>설비분류</label>
								<input type="text" class="form-control" id="equip_class_path" name="equip_class_path" readonly>
							</div>
							<div class="form-group col-md-5">
								<label>설비분류 설명</label>
								<input type="text" class="form-control" id="equip_class_desc" name="equip_class_desc" readonly>
							</div>
							<div class="form-group col-md-5">
								<label></label>
								<div style="display:flex;">
									<button type="button" class="outlinebutton" id="btnEquipClassDesc" name="btnEquipClassDesc"></button>
									<span style="width: 10px;"></span>
									<button type="button" class="trashbutton" id="btnEquipSpecDel" name="btnEquipSpecDel"></button>
								</div>
							</div>
						</div>
						<div>
							<label>설비사양</label>
							<button type="button" class="plusbutton" id="equipSpecPlus" name="equipSpecPlus"></button>
						</div>
						<div id="equSpecGrid" class="grid">
						</div>
					</div>

					<!-- Parts/BOM 탭 컨텐츠 -->
					<div class="tab-pane" id="equipPartsBom">
						<!-- Parts 섹션 -->
						<div style="margin-bottom: 20px;">
							<div style="display: flex; align-items: center; margin-bottom: 10px;">
								<div style="display: flex; align-items: center;">
									<span>Parts</span>
								</div>
								<button class="btn" id="btnEquipPartsBomMatMultiSel" name="btnEquipPartsBomMatMultiSel" style="margin-left: auto; background-color: #1e4f88; color: white; padding: 4px 12px; font-size: 12px;">자재선택</button>
							</div>
							<div id="partsGrid" class="grid"></div>
						</div>

						<!-- BOM 계층구조 보기 섹션 -->
						<div>
							<div style="display: flex; align-items: center; margin-bottom: 10px;">
								<div style="display: flex; align-items: center;">
									<span>BOM 계층구조 보기</span>
								</div>
							</div>
							<div style="border: 1px solid #dee2e6; padding: 15px;">
								<div id="bomGrid" style="color: #1e4f88; font-weight: bold; margin-bottom: 10px;"></div>
							</div>
						</div>
					</div>

					<!--파일 탭 컨텐츠 -->
					<div class="tab-pane" id="fileTab" style="height: 400px;">
						{% include 'components/ImageUpload.html' with tableName='cm_equipment' attachName='image' dataPk=cm_equipment.equip_pk|default:'' %}
						{% include 'components/FileUpload.html' with tableName='cm_equipment' attachName='file' dataPk=cm_equipment.equip_pk|default:'' %}
					</div>

					<!--PM 탭 컨텐츠 -->
					<div class="tab-pane" id="pmTab" style="overflow-y:auto; height: 300px;">
						<div id="pmGrid" class="grid"></div>
					</div>

					<!--점검 탭 컨텐츠 -->
					<div class="tab-pane" id="inspectionTab" style="overflow-y:auto; height: 300px;">
						<div id="inspectionGrid" class="grid"></div>
					</div>

					<!--로그 탭 컨텐츠 -->
					<div class="tab-pane" id="logTab">
						<div id="logGrid" class="grid"></div>
					</div>

				</div>
			</div>
		</div>
		<!-- 버튼 영역 -->
		<div class="modal-footer">
			<button type="button" style="background-color: #dc3545 !important; color: white !important; border-color: #d9534f !important; display: none;" id="disposedBtn">설비불용처리</button>
			<button type="button" style="background-color: #dc3545 !important; color: white !important; border-color: #d9534f !important; display: none;" id="notUseBtn">사용안함</button>
			<button type="button" class="btn-save" id="saveBtn">저장</button>
			<button type="button" class="btn-close" id="closeBtn">닫기</button>
		</div>
	</div>
</div>

<!-- 현상 Kendo Window 팝업 -->
<div id="equipDisposedWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="disposedForm">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label for="disposedType" class="required">불용처리유형</label>
					<select id="disposedType" name="disposedType"></select>
				</div>
				<div class="form-group col-md-6">
					<label for="disposedDate" class="required">불용처리일</label>
					<input type="date" id="disposedDate" name="disposedDate" class="form-control" style="flex:1;" />
				</div>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnConfirmDisp">확인</button>
		<button type="button" class="btn-close" id="btnCloseDisp">취소</button>
	</div>
</div>

<!-- 불용 참조목록 Kendo Window 팝업 -->
<div id="equipRespDispWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<div class="alert alert-warning" style="background: #fcf7ee; border: 1px solid #e7c98b; color: #7c6a3a; padding: 16px; margin-bottom: 20px; border-radius: 8px;">
			<strong>경고!</strong><br>
			해당 설비가 참조 사용(아래 참조 목록 확인) 중 입니다. 하단 체크박스 선택 후 [참조 비활성화] 버튼을 누르면 비활성화 가능 합니다.<br>
			PM WO에 결과 입력(작업입력, 자재, 외주업체, 고장부위) 된 경우 비활성화 불가합니다. 이 경우는 WO를 완료하거나 입력값을 삭제하고 진행하십시오.<br>
			<br>
			비활성화가 완료되면 불용처리를 다시 시도해주십시오.
		</div>
	</div>
	<div class="grid-section">
		<h5>PM 목록</h5>
		<div id="pmListGrid" style="display: none;"></div>
		<h5>자식 설비목록(참조되고있는)</h5>
		<div id="equipListGrid" style="display: none;"></div>
		<h5>PM WO 목록</h5>
		<div id="woListGrid" style="display: none;"></div>
		<h5>점검마스터 목록</h5>
		<div id="equipChkMastListGrid" style="display: none;"></div>
		<h5>점검 작업목록</h5>
		<div id="equipChkScheListGrid" style="display: none;"></div>
	</div>
	<div class="modal-footer" style="display: flex; align-items: center; justify-content: space-between;">
		<div>
			<label style="margin-bottom: 0;">
				<input type="checkbox" id="chkItems" name="chkItems" />
				PM WO목록, 점검 작업목록을 취소하고 PM/점검 마스터 사용안함으로 변경, 자식 설비목록의 상위설비 설정 삭제
			</label>
		</div>
		<div>
			<button type="button" class="btn-close btn-red" id="btnConfirmRespDisp" disabled>참조 비활성화</button>
			<button type="button" class="btn-close" id="btnCloseRespDisp">닫기</button>
		</div>
	</div>
</div>

<!-- 상태변경 Kendo Window 팝업 -->
<div id="changeEquipStatusWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="changeEquipStatusForm">
			<div class="form-row">
				<ul id="equipStatusRadioGroup"></ul>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnConfirmChangeEquipStatus">확인</button>
		<button type="button" class="btn-close" id="btnCloseChangeEquipStatus">취소</button>
	</div>
</div>

	{% include 'popup/modalEquCategorySel.html' %}
	{% include 'popup/modalEquClassSel.html' %}
	{% include 'popup/modalEquLoc.html' %}
	{% include 'popup/modalEquLocHist.html' %}
	{% include 'popup/modalEquDeptHist.html' %}
	{% include 'popup/modalEquSel.html' %}
	{% include 'popup/modalMatSel.html' %}
	{% include 'popup/modalMatMultiSel.html' %}

<script type="text/javascript">
	class EquipMaster {
		constructor() {
			this.baseUrl = '/api/kmms/equipment';
			this.equip_pk = null;
			this.equip_cd = null;
			this.equip_status = null;
			this.equipStatusYN = false;
			this.useYn = null;

			// DropDown Tree와 List 컨트롤 정의
			this.locPkDropDown = null;
			this.deptPkDropDown = null;
			this.importRankDropDown = null;
			this.ccenterCdDropDown = null;
			this.supplierDropDown = null;
			this.makerDropDown = null;
			this.disposedTypeDropDown = null;

			// 그리드 컨트롤 정의
			this.pmGrid = null;
			this.equSpecGrid = null;
			this.partsGrid = null;
			this.bomGrid = null;
			this.inspectionGrid = null;
			this.logGrid = null;
			this.pmListGrid = null;
			this.equipListGrid = null;
			this.woListGrid = null;
			this.equipChkMastListGrid = null;
			this.equipChkScheListGrid = null;

			this.pmList = []
			this.chkEquipList = []
			this.equipChkRsltList = []
			this.woList = []
			this.woList2 = []
			this.equipList = []

			// DatePicker 컨트롤 정의
			this.productionYearPicker = null;
			this.installDatePicker = null;
			this.warrantyDatePicker = null;
			this.disposedDatePicker = null;

			// Switch 컨트롤 정의
			this.environEquipYnSwitch = null;

			// 모달 관련 요소 정의
			this.modal = null;

			this.init();
		}

		init() {
			const _this = this;
			this.modal = $("#modalEquipMaster");

			// DropDown Tree와 List 초기화
			this.locPkDropDown = AjaxUtil.fillDropDownTreeOptions($('#loc_pk'), 'cm_location', 'select');
			this.deptPkDropDown = AjaxUtil.fillDropDownTreeOptions($('#dept_pk'), 'depart', 'select');
			this.importRankDropDown = AjaxUtil.fillDropDownOptions($('#import_rank_pk'), 'cm_import_rank', 'choose', null);
			this.supplierDropDown = AjaxUtil.fillDropDownOptions($('#supplier_pk'), 'cm_supplier', 'choose', null, 'COMP_TYPE', 'CP_S,CP_B');
			this.makerDropDown = AjaxUtil.fillDropDownOptions($('#maker_pk'), 'cm_supplier', 'choose', null, 'COMP_TYPE', 'CP_M,CP_B');
			this.ccenterCdDropDown = AjaxUtil.fillDropDownOptions($('#ccenter_cd'), 'cm_code', 'choose', null, 'COST_CENTER');
			this.disposedTypeDropDown = AjaxUtil.fillDropDownOptions($('#disposedType'), 'cm_code', 'choose', null, 'DISPOSE_TYPE');

			// DatePicker 초기화
			this.productionYearPicker = $("#make_dt").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");
			this.installDatePicker = $("#install_dt").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");
			this.warrantyDatePicker = $("#warranty_dt").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");
			this.disposedDatePicker = $("#disposedDate").kendoDatePicker({ value: kendo.toString(new Date(), 'yyyy-MM-dd'), format: "yyyy-MM-dd" }).data("kendoDatePicker");

			// Switch 초기화
			this.environEquipYnSwitch = $("#environ_equip_yn").kendoSwitch().data("kendoSwitch");

			// 버튼 이벤트 핸들러 설정
			$("#equipLocPlus").kendoButton({
				icon: "k-i-plus",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalWindow', { width: '70%', height: '70%' });
					locationPage.show(function (ctrl) {
						if (ctrl === 'equip_loc') {
							AjaxUtil.fillDropDownTreeOptions($('#loc_pk'), 'cm_location', 'all');
						}
					});
				}
			});

			$("#chkItems").kendoCheckBox({
				checked: false,   // 기본 체크
			});


			$("#btnEquipCategory").kendoButton({
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEquCategorySel', { width: '40%', height: '70%' });
					equipCategoryPage.show(function (res) {
						$("#equip_category_id").val(res.equip_category_id);
						$("#equip_category").val(res.equip_category_desc);
					});
				}
			}).addClass("folder-icon-btn");

			$('#disposedBtn').kendoButton({
				themeColor: "base",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '설비 불용처리',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '40vw',
						height: '25vh',
					}
					popupComn.openTempPopup($("#equipDisposedWindow"), options);
				}
			});

			$("#btnConfirmDisp").kendoButton({
				icon: "k-i-save",
				themeColor: "base",
				click: function () {
					Alert.confirm('', `설비를 불용처리하시겠습니까?`, () => {

						_this.pmDataBind();
						_this.equipChildDataBind();
						_this.woDataBind();
						_this.equipCheckDataBind();
						_this.equipChkScheDataBind();


						//추가 팝업 띄운다
						const options = {
							title: '설비 불용처리 참조 목록',
							visible: false,
							modal: true,
							actions: [],
							appendTo: "body",
							width: '70vw',
							height: '70vh',
						}
						popupComn.openTempPopup($("#equipRespDispWindow"), options);

						/*

						let formData = FormUtil.extractForm($("#disposedForm"));
						let fnSuccess = function (res) {
										if (res.success) {
											FormUtil.resetForm($("#disposedForm"));
											Alert.alert('', res.message);
										} else if (!res.success) {
											Alert.alert('', res.message);
										}
						};
						AjaxUtil.postAsyncData('/api/kmms/reliab_code' + '?action=insert', formData, fnSuccess);

						*/

					});
				}
			});

			$("#btnCloseDisp").kendoButton({
				themeColor: "base",
				click: function () {
					$("#equipDisposedWindow").data("kendoWindow").close();
				}
			});

			$("#equipLocHist").kendoButton({
				icon: "k-i-grid-layout",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEquipLocHist', { width: '70%', height: '55%' });
					equipLocHistPage.show(_this.equip_pk);
				}
			});

			$("#mngDept").kendoButton({
				icon: "k-i-grid-layout",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalWindowDept', { width: '70%', height: '55%' });
					equipDeptHistPage.show(_this.equip_pk);
				}
			});

			$("#upLoc").kendoButton({
				icon: "k-i-zoom-in",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEqu', { width: '70%', height: '70%' });
					equipSelectPage.show(function (data) {
						$("#up_equip_pk").val(data.equip_pk);
						$("#up_equip_nm").val(data.equip_nm);
					});
				}
			});

			$("#recycleMat").kendoButton({
				icon: "k-i-zoom-in",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalMatSel');
					matSelectPage.show(function (data) {
						$("#mtrl_pk").val(data._mtrl_pk);
						$("#mtrl_nm").val(data._mtrl_nm);
					});
				}
			});

			$('#notUseBtn').kendoButton({
				themeColor: "base",
				click: function (e) {
					e.preventDefault();
					_this.setEquipNotUse();
				}
			});

			// 상태변경 팝업
			$('#btnChangeStatus').kendoButton({
				themeColor: "base",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					const options = {
						title: '상태변경',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '40vw',
						height: '20vh',
					}
					popupComn.openTempPopup($("#changeEquipStatusWindow"), options);
					// 라디오 버튼 초기값
					let currentEquipStatus = _this.equip_status;
                    let radioGroupInstance = $("#equipStatusRadioGroup").data("kendoRadioGroup");

                    if (currentEquipStatus) {
                        radioGroupInstance.value(currentEquipStatus);
                    } else {
                        radioGroupInstance.value("ES_OPER");
                    }
				}
			});
            $("#equipStatusRadioGroup").kendoRadioGroup({
                items: [{
                    value: "ES_OPER",
                    label: "가동중"
                }, {
                    value: "ES_IDLE",
                    label: "유휴"
                }]
            });
			$("#btnConfirmChangeEquipStatus").kendoButton({
				themeColor: "base",
				click: function (e) {
					e.preventDefault();
					_this.changeEquipStatusData();
				}
			});
			$("#btnCloseChangeEquipStatus").kendoButton({
				themeColor: "base",
				click: function (e) {
					e.preventDefault();
					$("#changeEquipStatusWindow").data("kendoWindow").close();
				}
			});


			$("#btnEquipClassDesc").kendoButton({
				icon: "k-i-insert-top",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEquClass', { width: '70%', height: '70%' });
					equipClassPage.show(function (data) {
						$("#equip_class_path").val(data.hierarchy_path);
						$("#equip_class_desc").val(data.equip_class_desc);
					}, $("#equip_category_id").val(), $("#equip_category").val());
				}
			});

			$("#btnEquipSpecDel").kendoButton({
				icon: "k-i-trash",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					$("#equip_class_path").val('');
					$("#equip_class_desc").val('');
				}
			});

			$("#btnEquipPartsBomMatMultiSel").kendoButton({
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalMatMultiSel', { width: '70%', height: '70%' });
					matMultiSelectPage.show(function (data) {
						if (Array.isArray(data)) {
							data.forEach(function (row) {
								_this.partsGrid.dataSource.add(row);
							});
						}
					});
				}
			});

			$("#btnConfirmEquipSpec").kendoButton({ icon: "k-i-save", themeColor: "base" });
			$("#btnCancelEquipSpec").kendoButton({ icon: "k-i-cancel", themeColor: "base" });

			// 설비사양 설정 Kendo Window 초기화
			$("#specSettingWindow").kendoWindow({
				width: "600px",
				title: "설비사양 설정",
				visible: false,
				modal: true,
				actions: []
			});

			// 행 추가 함수
			function addSpecRow(specnm = '', unit = '', spec = '') {
				const $tbody = $("#specTable tbody");
				const row = `
					<tr>
						<td class="spec-row-delete-container">
							<button class="spec-row-delete-btn removeSpecRowBtn">
								<span class="spec-row-delete-icon">×</span>
							</button>
						</td>
						<td width="30%"><input type="text" class="k-textbox spec-input-field" value="${specnm}"></td>
						<td width="20%"><input type="text" class="k-textbox spec-input-field" value="${unit}"></td>
						<td width="38%"><input type="text" class="k-textbox spec-input-field" value="${spec}"></td>
					</tr>
				`;
				$tbody.append(row);
			}

			// 행 추가 버튼 이벤트
			$("#addSpecRowBtn").on("click", function () {
				addSpecRow();
			});

			// 행 삭제 버튼 이벤트 (위임)
			$("#specTable").on("click", ".removeSpecRowBtn", function () {
				$(this).closest("tr").remove();
			});

			// 확인/취소 버튼 이벤트
			$("#btnConfirmEquipSpec").on("click", () => {
				// 1. 입력값 수집
				const specRows = [];
				$("#specTable tbody tr").each(function (index) {
					const $tds = $(this).find("td");
					const specnm = $tds.eq(1).find("input").val();
					const unit = $tds.eq(2).find("input").val();
					const spec = $tds.eq(3).find("input").val();
					if (specnm || unit || spec) { // 모두 빈 값이면 제외
						specRows.push({
							no: index + 1,
							specnm: specnm,
							unit: unit,
							spec: spec
						});
					}
				});

				// 2. equSpecGrid에 데이터 반영
				_this.equSpecGrid.dataSource.data(specRows);

				// 3. 팝업 닫기
				$("#specSettingWindow").data("kendoWindow").close();
			});

			// 취소 버튼 이벤트
			$("#btnCancelEquipSpec").on("click", () => {
				$("#specSettingWindow").data("kendoWindow").close();
			});

			// 플러스 버튼 클릭 시 Kendo Window 오픈
			$("#equipSpecPlus").kendoButton({
				icon: "k-i-plus",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					// 기존 행 초기화
					$("#specTable tbody").empty();

					// equSpecGrid의 데이터 가져오기
					const gridData = _this.equSpecGrid.dataSource.data();

					// 데이터가 있으면 모든 행 추가
					if (gridData && gridData.length > 0) {
						gridData.forEach(function (row) {
							addSpecRow(row.specnm, row.unit, row.spec);
						});
					} else {
						// 데이터가 없으면 빈 행 추가
						addSpecRow();
					}

					$("#specSettingWindow").data("kendoWindow").center().open();
				}
			});

			// 기존 이벤트 핸들러 제거
			$('#saveBtn').off('click');

			$('#saveBtn').kendoButton({
				click: function (e) {
					e.preventDefault();  // 이벤트 기본 동작 방지
					_this.saveData();
				}
			});

			$("#btnConfirmRespDisp").off('click').on('click', function (e) {
				e.preventDefault();
				Alert.confirm('', `설비를 참조하고 있는 정보들을 비활성화 (취소,사용안함) 하시겠습니까?`, () => {
					// PM 마스터 목록
					let pmList = []
					// 자식 설비 목록
					let equipList = []
					// WO 목록
					let woList = []
					// WO 승인 목록
					let woList2 = []
					// 점검 결과 목록
					let equipChkRsltList = []
					// 점검 마스터 목록
					let chkEquipList = []
				
					if (_this.pmList != undefined) {
						for (var k = 0; k < _this.pmList.length; k++) {
							pmList.push(_this.pmList[k].pmPk)
						}
					}

					// 자식 설비목록(참조되고있는)
					if (_this.equipList != undefined) {
						for (var m = 0; m < _this.equipList.length; m++) {
							equipList.push(_this.equipList[m].equipPk)
						}
					}
					if (_this.woList != undefined) {
						for (var l = 0; l < _this.woList.length; l++) {
							woList.push(_this.woList[l].workOrderPk)
							woList2.push(_this.woList[l].workOrderApprovalPk)
						}
					}
					if (_this.equipChkRsltList != undefined) {
						for (var j = 0; j < _this.equipChkRsltList.length; j++) {
							equipChkRsltList.push(_this.equipChkRsltList[j].chkSchePk)
						}
					}
					if (_this.chkEquipList != undefined) {
						for (var i = 0; i < _this.chkEquipList.length; i++) {
							chkEquipList.push(_this.chkEquipList[i].chkMastPk)
						}
					}

					let data = {
						action: 'equip_disabled_update',
						equipPk: _this.equip_pk,
						chkMastPk: chkEquipList,
						chkSchePk: equipChkRsltList,
						pmPk: pmList,
						workOrderPk: woList,
						workOrderApprovalPk: woList2,
						equipListPk: equipList,
					}

					AjaxUtil.getSyncData('/api/kmms/equipment', data, function (res) {
						if (res.success) {
							Alert.alert('', res.message);
							$("#equipRespDispWindow").data("kendoWindow").close();
						}
					});
				});
			});

			$("#btnCloseRespDisp").kendoButton({
				themeColor: "base",
				click: function (e) {
					e.preventDefault();
					$("#equipRespDispWindow").data("kendoWindow").close();
				}
			});

			$('#closeBtn').kendoButton({
				click: function () {
					_this.resetForm();
					// 기본정보 탭 활성화
					$('.tab-button').removeClass('active').removeAttr('style');
					$('.tab-pane').removeClass('active').hide();
					$('.tab-button[data-tab="equipMasterForm"]').addClass('active').css({
						'background': '#1e4f88',
						'color': 'white',
						'border-color': '#1e4f88'
					});
					$('#equipMasterForm').addClass('active').show();
					_this.modal.fadeOut();
				}
			});

			// ESC 키로 모달 닫기
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) this.modal.fadeOut();
			});

			this.equSpecGrid = $("#equSpecGrid").kendoGrid({
				height: 200,
				sortable: true,
				pageable: false,
				autoBind: false,
				columns: [
					{ field: "no", title: "NO", width: 120 },
					{ field: "specnm", title: "사양명", width: 120, },
					{ field: "unit", title: "단위", width: 100 },
					{ field: "spec", title: "사양(Spec)", width: 100 }
				],
				noRecords: true,
				messages: {
					noRecords: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.partsGrid = $("#partsGrid").kendoGrid({
				height: 200,
				sortable: true,
				columns: [
					{ field: "_mtrl_pk", title: "NO", width: 80, attributes: { style: "text-align: center" } },
					{ field: "_mtrl_cd", title: "자재코드", width: 120 },
					{ field: "_mtrl_class_nm", title: "자재명", width: 200 },
					{ field: "_safety_stock_amt", title: "구성수량", width: 100, attributes: { style: "text-align: center" } },
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var grid = this;
								var tr = $(e.target).closest("tr");
								var dataItem = grid.dataItem(tr);
								grid.dataSource.remove(dataItem);
							}
						},
						width: 100
					}
				],
				noRecords: true,
				messages: {
					noRecords: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			const optionBom = {
				dataSource: {
					schema: {
						model: {
							id: "disp_cd",
							parentId: "disp_up_cd",
							fields: {
								disp_up_cd: { field: "disp_up_cd", nullable: true },
								disp_cd: { field: "disp_cd" },
								disp_nm: { field: "disp_nm" }
							},
							expanded: true
						}
					}
				},
				height: 200,
				filterable: true,
				sortable: true,
				columns: [
					{ field: "disp_nm", title: "설비" },
				],
				selectable: true,
			};
			this.bomGrid = $("#bomGrid").kendoTreeList(optionBom).data("kendoTreeList");

			// 그리드 초기화 코드는 그대로 유지...
			this.pmGrid = $("#pmGrid").kendoGrid({
				height: 300,
				sortable: true,
				columns: [
					{ field: "pm_pk", hidden: true },
					{ field: "pm_no", title: "PM번호", width: 200, attributes: { style: "text-align: center" } },
					{ field: "pm_nm", title: "PM명", width: 200 },
					{ field: "dept_nm", title: "설명부서", width: 120, attributes: { style: "text-align: center" } },
					{ field: "pm_user_nm", title: "PM 담당자", width: 120, attributes: { style: "text-align: center" } },
					{ field: "pm_type_nm", title: "PM유형", width: 100, attributes: { style: "text-align: center" } },
					{ field: "per_number", title: "주기", width: 80, attributes: { style: "text-align: center" } },
					{ field: "cycle_type_nm", title: "주기단위", width: 100, attributes: { style: "text-align: center" } },
					{ field: "last_work_dt", title: "최근 완료일", width: 120, attributes: { style: "text-align: center" } },
					{ field: "use_yn", title: "사용여부", width: 100, attributes: { style: "text-align: center" } }
				],
				noRecords: true,
				messages: {
					noRecords: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.inspectionGrid = $("#inspectionGrid").kendoGrid({
				height: 300,
				sortable: true,
				columns: [
					{ field: "inspection_no", title: "점검번호", width: 100, attributes: { style: "text-align: center" } },
					{ field: "inspection_nm", title: "점검명", width: 200 },
					{ field: "dept_nm", title: "점검부서", width: 120, attributes: { style: "text-align: center" } },
					{ field: "manager_nm", title: "점검담당자", width: 120, attributes: { style: "text-align: center" } },
					{ field: "inspection_type", title: "점검유형", width: 100, attributes: { style: "text-align: center" } },
					{ field: "cycle", title: "주기", width: 80, attributes: { style: "text-align: center" } },
					{ field: "cycle_unit", title: "주기단위", width: 100, attributes: { style: "text-align: center" } },
					{ field: "last_complete_dt", title: "최근 완료일", width: 120, attributes: { style: "text-align: center" } },
					{ field: "use_yn", title: "사용여부", width: 100, attributes: { style: "text-align: center" } }
				],
				noRecords: true,
				messages: {
					noRecords: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			this.logGrid = $("#logGrid").kendoGrid({
				dataSource: {
					transport: {
						read: {
							url: this.baseUrl,
							type: "GET",
							data: function () {
								return {
									action: 'log',
									equip_pk: _this.equip_pk
								};
							}
						}
					},
					schema: {
						data: function (response) {
							console.log("Grid Response:", response);
							if (Array.isArray(response)) {
								return response;
							}
							return [];
						}
					},
				},
				autoBind: false,
				height: 300,
				sortable: true,
				columns: [
					{ field: "inserter_nm", title: "사용자", width: 100, attributes: { style: "text-align: center" } },
					{ field: "log_type", title: "로그 타입", width: 120, attributes: { style: "text-align: center" } },
					{ field: "log_history", title: "로그 내역", width: 500 },
					{ field: "log_date", title: "일시", width: 150, attributes: { style: "text-align: center" } }
				],
				noRecords: true,
				messages: {
					noRecords: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			let pmListGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'pmNo', title: 'PM번호', width: 100 },
					{ field: "pmNm", title: "PM명", width: 200 },
					{ field: "equipCd", title: "설비코드", width: 150 },
					{ field: "equipNm", title: "설비명", width: 200 },
				],
				height: "220px"
			};
			_this.pmListGrid = new Grid($("#pmListGrid"), pmListGridOption);

			let equipListGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'equipCd', title: '설비코드', width: 100 },
					{ field: "equipNm", title: "설비명", width: 200 },
					{ field: "locNm", title: "위치", width: 150 },
					{ field: "equipStatusNm", title: "설비상태", width: 100 },
				],
				height: "220px"
			};
			_this.equipListGrid = new Grid($("#equipListGrid"), equipListGridOption);

			let woListGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'workOrderNo', title: '작업지시번호', width: 100 },
					{ field: "workTitle", title: "작업제목", width: 200 },
					{ field: "equipCd", title: "설비코드", width: 150 },
					{ field: "equipNm", title: "설비명", width: 100 },
				],
				height: "220px"
			};
			_this.woListGrid = new Grid($("#woListGrid"), woListGridOption);

			let equipChkMastListGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'chkMastNo', title: '점검번호', width: 100 },
					{ field: "chkMastNm", title: "점검명", width: 200 },
					{ field: "deptNm", title: "점검부서", width: 150 },
				],
				height: "220px"
			};
			_this.equipChkMastListGrid = new Grid($("#equipChkMastListGrid"), equipChkMastListGridOption);

			let equipChkScheListGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'chkScheNo', title: '점검일정번호', width: 100 },
					{ field: "chkMastNm", title: "점검명", width: 200 },
					{ field: "deptNm", title: "점검부서", width: 150 },
					{ field: "chkScheDt", title: "점검계획일", width: 100 },
				],
				height: "220px"
			};
			_this.equipChkScheListGrid = new Grid($("#equipChkScheListGrid"), equipChkScheListGridOption);

			$('#modalEquipMaster .tab-button').on('click', function (e) {
				e.preventDefault();
				const tabId = $(this).data('tab');
				$('#modalEquipMaster .tab-button').removeClass('active').removeAttr('style');
				$('#modalEquipMaster .tab-pane').removeClass('active').hide();
				$(this).addClass('active').css({
					'background': '#1e4f88',
					'color': 'white',
					'border-color': '#1e4f88'
				});
				if (tabId) $('#' + tabId).addClass('active').show();

				// switch-case로 탭별 분기 처리
				switch (tabId) {
					case 'equipSpec':
						if (_this.equip_pk) {
							var param = {
								action: 'findAll',
								equipPk: _this.equip_pk
							};
							let equipSpecData = AjaxUtil.getSyncData('/api/kmms/equip_spec', param);
							_this.bindEquipSpec(equipSpecData);
						}
						break;
					case 'equipPartsBom':
						if (_this.equip_pk) {
							var paramParts = {
								action: 'getEquipPartMtrls',
								equipPk: _this.equip_pk
							};

							let equipPartsData = AjaxUtil.getSyncData('/api/kmms/equip_part_mtrl', paramParts);
							_this.bindEquipParts(equipPartsData);

							// BOM 그리드 데이터 가져오기
							var paramBom = {
								action: 'getEquipBomTree',
								equip_cd: _this.equip_cd
							};

							let equipBomData = AjaxUtil.getSyncData('/api/kmms/equip_part_mtrl', paramBom);
							_this.bindEquipBom(equipBomData);
						}
						break;
					case 'logTab':
						if (_this.equip_pk && _this.logGrid) {
							_this.logGrid.dataSource.read();
						}
						break;
					case 'pmTab':
						if (_this.equip_pk && _this.pmGrid) {
							var param = {
								action: 'getEquipPmList',
								equip_pk: _this.equip_pk
							};
							let equipPmData = AjaxUtil.getSyncData(_this.baseUrl, param);
							_this.pmGrid.dataSource.data(equipPmData);
						}
						break;
					case 'inspectionTab':
						if (_this.equip_pk && _this.inspectionGrid) {
							_this.inspectionGrid.dataSource.read();
						}
						break;
					case 'fileTab':
						if (_this.equip_pk) {
							if (window.imageUploader) {
								window.imageUploader.setDataPk(_this.equip_pk);
								window.imageUploader.loadFilesFromServer(() => {
									showMainImageFromUploader();
								});
							}

							if (window.fileUploader) {
								window.fileUploader.setDataPk(_this.equip_pk);
								window.fileUploader.loadFilesFromServer(() => {
									showMainFileFromUploader();
								});
							}

						}
						break;
					default:
						break;
				}
			});

			// 팝업이 열릴 때 깨지는 컨트롤만 명시적으로 Kendo 위젯을 직접 초기화 (이미 적용된 경우는 건드리지 않음)
			setTimeout(function () {
				var $locPk = $('#loc_pk');
				if ($locPk.length && !$locPk.data('kendoDropDownTree')) {
					AjaxUtil.fillDropDownTreeOptions($locPk, 'cm_location', 'choose');
				}
				var $deptPk = $('#dept_pk');
				if ($deptPk.length && !$deptPk.data('kendoDropDownTree')) {
					AjaxUtil.fillDropDownTreeOptions($deptPk, 'depart', 'choose');
				}
				var $environSwitch = $('#environ_equip_yn');
				if ($environSwitch.length && !$environSwitch.data('kendoSwitch')) {
					$environSwitch.kendoSwitch();
				}
			}, 100);
		}

		//설비 마스터
		show(equip_pk, mode) {
			// mode가 전달되지 않은 경우에만 기본값 적용
			if (mode === undefined || mode === null) {
				mode = 'read';
			}
			let _this = this;
			_this.equip_pk = equip_pk;
			_this.equipStatusYN = _this.equip_pk ? true : false;

			if (equip_pk) {
				// 기존 설비 수정/조회
				// 설비 상세 정보 API 호출
				let param = {
					action: 'findOne',
					equip_pk: equip_pk,
				};

				let equipData = AjaxUtil.getSyncData('/api/kmms/equipment', param);
				if (!equipData) {
					alert("데이터 오류 발생[존재하지 않는 설비코드]");
					return;
				}
				_this.equip_cd = equipData.equip_cd;
				_this.equip_status = equipData.equip_status;

				//썸네일 이미지
				_this.showEquipThumbmail(equip_pk);

				// 기본정보
				this.bindEquipMasterData(equipData);
			} else {
				// 새 설비 등록
				this.resetForm();
			}

			// 모달이 열리기 전에 기본정보 탭을 미리 활성화
			$('#modalEquipMaster .tab-button').removeClass('active').removeAttr('style');
			$('#modalEquipMaster .tab-pane').removeClass('active').hide();
			
			// 기본정보 탭 활성화
			$('.tab-button[data-tab="equipMasterForm"]').addClass('active').css({
				'background': '#1e4f88',
				'color': 'white',
				'border-color': '#1e4f88'
			});
			$('#equipMasterForm').addClass('active').show();

			// 모드에 따라 폼 필드 활성화/비활성화 설정
			this.setFormMode(mode);

			// 모달 표시
			$("#modalEquipMaster").fadeIn();
		}

		pmDataBind() {
			let _this = this;
			/* findAll [pm-mapper.xml] */
			let result = AjaxUtil.getAsyncData('/api/kmms/pm_master', { action: 'pm_equip_disposed', equipPk: _this.equip_pk }, function () { });
			_this.pmList = result;

			let kendoGrid = $("#pmListGrid").data("kendoGrid");
			if (kendoGrid) { kendoGrid.setDataSource(new kendo.data.DataSource({ data: result })); }

			if (result != undefined) { $("#pmListGrid").css("display", "block"); }
		}

		equipChildDataBind() {
			let _this = this;
			/* findChildAll [equipment-mapper.xml] */
			let result = AjaxUtil.getSyncData('/api/kmms/equipment', { action: 'equip_child_disposed', equipPk: _this.equip_pk });
			_this.equipList = result;

			let kendoGrid = $("#equipListGrid").data("kendoGrid");
			if (kendoGrid) { kendoGrid.setDataSource(new kendo.data.DataSource({ data: result })); }

			if (result != undefined) { $("#equipListGrid").css("display", "block"); }
		}

		woDataBind() {
			let _this = this;
			/* searchAll [work-order-mapper.xml] */
			let result = AjaxUtil.getAsyncData('/api/kmms/work_order', { action: 'wo_equip_disposed', equipPk: _this.equip_pk }, function () { });
			_this.woList = result;

			let kendoGrid = $("#woListGrid").data("kendoGrid");
			if (kendoGrid) { kendoGrid.setDataSource(new kendo.data.DataSource({ data: result })); }

			if (result != undefined) { $("#woListGrid").css("display", "block"); }
		}

		equipCheckDataBind() {
			let _this = this;
			/* findAll [equip-check-mast-mapper.xml] */
			let result = AjaxUtil.getAsyncData('/api/kmms/equipment', { action: 'equip_check_disposed', equipPk: _this.equip_pk }, function () { });
			_this.equipChkScheList = result;

			let kendoGrid = $("#equipChkMastListGrid").data("kendoGrid");
			if (kendoGrid) { kendoGrid.setDataSource(new kendo.data.DataSource({ data: result })); }

			if (result != undefined) { $("#equipChkMastListGrid").css("display", "block"); }
		}

		equipChkScheDataBind() {
			let _this = this;
			/* findAll [equip-chk-sche-mapper.xml] */
			let result = AjaxUtil.getAsyncData('/api/kmms/equipment', { action: 'equip_chk_sche_disposed', equipPk: _this.equip_pk }, function () { });
			_this.equipChkRsltList = result;

			let kendoGrid = $("#equipChkScheListGrid").data("kendoGrid");
			if (kendoGrid) { kendoGrid.setDataSource(new kendo.data.DataSource({ data: result })); }

			if (result != undefined) { $("#equipChkScheListGrid").css("display", "block"); }
		}

		//저장
		saveData() {
			let _this = this;

			let data = FormUtil.extractForm($('#baseinfoForm'));
			data.equip_pk = _this.equip_pk;
			data.equipCode = $("#equip_code").val();
			data.equipName = $("#equip_name").val();
			data.equip_category_id = $("#equip_category_id").val();
			data.equipClassName = $("#equip_category").val();
			data.loc_pk = $("#loc_pk").data("kendoDropDownTree").value();
			data.dept_pk = $("#dept_pk").data("kendoDropDownTree").value();
			data.EquipClassPath = $("#equip_class_path").val();
			data.EquipClassDesc = $("#equip_class_desc").val();

			// 사양 그리드 데이터 추가
			if (_this.equSpecGrid) {
				data.specList = _this.equSpecGrid.dataSource.data().map(row => ({
					specnm: row.specnm,
					unit: row.unit,
					spec: row.spec
				}));
			}

			// Parts 그리드 데이터 추가
			if (_this.partsGrid) {
				data.partsList = _this.partsGrid.dataSource.data().map(row => ({
					_mtrl_pk: row._mtrl_pk,
					_mtrl_cd: row._mtrl_cd,
					_mtrl_class_nm: row._mtrl_class_nm,
					_safety_stock_amt: row._safety_stock_amt
				}));
			}

			if (!data.equipCode) {
				Alert.alert('', '설비코드를 입력해주세요.', '확인', $("#equip_code"));				
				return;
			}
			if (data.equipCode.length > 20) {
				Alert.alert('', '설비코드는 20자 이내로 입력해주세요.', '확인', $("#equip_code"));		
				return;
			}

			if (!data.equipName) {
				Alert.alert('', '설비명을 입력해주세요.', '확인', $("#equip_name"));
				return;
			}
			if (data.equipName.length > 200) {
				Alert.alert('', '설비명은 200자 이내로 입력해주세요.', '확인', $("#equip_name"));
				return;
			}

			if (!data.equipClassName) {
				Alert.alert('', '카테고리를 선택해주세요.', '확인', $("#equip_category"));
				return;
			}

			if (!data.loc_pk) {
				Alert.alert('', '설비위치를 선택해주세요.');
				return;
			}

			if (!data.dept_pk) {
				Alert.alert('', '관리부서를 선택해주세요.');
				return;
			}
			if (!$('#install_dt').val()) {
				Alert.alert('', '설치일을 선택해주세요.', '확인', $("#install_dt"));
				return;
			}

			let fnSuccess = function (res) {			
				if (res.success) {
					// reg 모드인 경우 equip_pk 업데이트
					if (!_this.equip_pk && res.data && res.data.equip_pk) {
						_this.equip_pk = res.data.equip_pk;
						
						if (window.imageUploader) {
							window.imageUploader.dataPk = _this.equip_pk;
						}
						if (window.fileUploader) {
							window.fileUploader.dataPk = _this.equip_pk;
						}
					}
					
					//파일 저장
					const result = fetchSomeData();

					Alert.alert('', res.message);
					_this.resetForm();
					_this.modal.fadeOut();
					page.searchMainData();
				} else if (!res.success) {
					Alert.alert('', res.message);
				}
			};
			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, fnSuccess);
		}

        //설비상태 변경
		changeEquipStatusData() {
			let _this = this;

			let selectedEquipStatus = $("#equipStatusRadioGroup").data("kendoRadioGroup").value();
			let equipPk = _this.equip_pk;

			if (!equipPk) {
				Alert.alert('', '설비 정보가 없습니다.');
				return;
			}
			if (!selectedEquipStatus) {
				Alert.alert('', '설비 상태를 선택해주세요.');
				return;
			}

			let data = {
				equip_pk: equipPk,
				equipStatus: selectedEquipStatus
			};

			let funcSucc = function (resp) {
				if (resp.success) {
					Notify.success('변경되었습니다.');
					$('#changeEquipStatusWindow').data('kendoWindow').close();
                    let radioGroup = $("#equipStatusRadioGroup").data("kendoRadioGroup");
					let selectedEquipStatus = radioGroup.value();
                    let radioGroupItems = radioGroup.options.items;
					let selectedLabel = selectedEquipStatus;

                    for (let i = 0; i < radioGroupItems.length; i++) {
                        if (radioGroupItems[i].value === selectedEquipStatus) {
                            selectedLabel = radioGroupItems[i].label;
                            break;
                        }
                    }
					$('#txt_equip_status').val(selectedLabel);
					_this.equip_status = selectedEquipStatus;

					// 설비상태 변경 후 추가 필드 업데이트
					_this.updateEquipStatusFields();

					page.searchMainData();
				} else {
                    Alert.alert('', res.message);
				}
			}
			AjaxUtil.postAsyncData(_this.baseUrl + '?action=change', data, funcSucc);
		}

		// 사용안함 버튼 텍스트 업데이트
		updateNotUseButtonText() {
			let _this = this;
			
			if (_this.equip_pk && _this.useYn) {
				const isCurrentlyUsed = _this.useYn === 'Y';
				const buttonText = isCurrentlyUsed ? '사용안함' : '사용';
				$('#notUseBtn').text(buttonText);
			}
		}

		// 설비 사용/사용안함 토글 처리
		setEquipNotUse() {
			let _this = this;

			if (!_this.equip_pk) {
				Alert.alert('', '설비 정보가 없습니다.');
				return;
			}

			// 현재 설비 상태 확인
			if (!_this.useYn) {
				Alert.alert('', '설비 상태 정보를 가져올 수 없습니다.');
				return;
			}

			const isCurrentlyUsed = _this.useYn === 'Y';
			const actionText = isCurrentlyUsed ? '사용안함' : '사용';
			const confirmMessage = `설비마스터를 ${actionText}으로 처리하시겠습니까?`;

			Alert.confirm('', confirmMessage, () => {
				let data = {
					action: isCurrentlyUsed ? 'set_not_use' : 'set_use',
					equip_pk: _this.equip_pk
				};

				let funcSucc = function (resp) {
					if (resp.success) {
						Notify.success(`설비마스터가 ${actionText}으로 처리되었습니다.`);
						
						_this.modal.fadeOut();
						
						if (typeof page !== 'undefined' && page.searchMainData) {
							page.searchMainData();
						}
					} else {
						Alert.alert('', resp.message || `설비 ${actionText} 처리에 실패했습니다.`);
					}
				};

				AjaxUtil.postAsyncData(_this.baseUrl + `?action=${data.action}`, data, funcSucc);
			});
		}

		bindEquipMasterData(data) {
			console.log('cm_equipment_findOne', data);
			$("#equip_code").val(data.equip_cd);
			$("#equip_name").val(data.equip_nm);
			$("#txt_equip_status").val(data.equip_status_nm);
			
			this.useYn = data.use_yn;
			
			$("#equip_category_id").val(data.equip_category_id);
			$("#equip_category").val(data.equip_category_desc);

			FormUtil.BindDataForm(data, $('#baseinfoForm'));

			//사양(Spec)
			$("#equip_class_path").val(data.equip_class_path);
			$("#equip_class_desc").val(data.equip_class_desc);

			// 고장일시와 불용일시 데이터 바인딩
			$("#txt_equip_date").val(data.breakdown_dt || '');
			$("#txt_disposed_date").val(data.disposed_date || '');

			// 설비상태에 따른 추가 필드 업데이트
			this.updateEquipStatusFields();
			
			// 사용안함 버튼 텍스트 업데이트
			this.updateNotUseButtonText();
		}

		bindEquipSpec(data) {
			console.log('bindEquipSpec', data);
			// 그리드에 맞는 데이터로 변환
			const gridData = (data || []).map((row, idx) => ({
				no: idx + 1,
				specnm: row.equip_spec_nm,
				unit: row.equip_spec_unit,
				spec: row.equip_spec_value
			}));
			this.equSpecGrid.dataSource.data(gridData);
		}

		bindEquipParts(data) {
			console.log('bindEquipParts', data);
			// 그리드에 맞는 데이터로 변환
			const gridData = (data || []).map((row, idx) => ({
				no: idx + 1,
				_mtrl_pk: row.mtrl_pk,
				_mtrl_cd: row.mtrl_cd,
				_mtrl_class_nm: row.mtrl_nm,
				_safety_stock_amt: row.amt,
			}));
			this.partsGrid.dataSource.data(gridData);
		}

		bindEquipBom(data) {
			console.log('bindEquipBom', data);
			// 그리드에 맞는 데이터로 변환 (빈 문자열을 null로 변환)
			const gridData = (data || []).map((row, idx) => ({
				disp_up_cd: row.disp_up_cd === "" ? null : row.disp_up_cd,
				disp_cd: row.disp_cd,
				disp_nm: row.disp_nm,
			}));
			this.bomGrid.dataSource.data(gridData);
		}

		showEquipThumbmail(dataPk) {
			console.log('showEquipThumbmail', dataPk);
			const url = '/api/files/upload?action=call_attach_file';
			const data = {
				tableName: 'cm_equipment',
				attachName: 'image',
				dataPk: dataPk || ''
			};

			AjaxUtil.postAsyncData(url, data, (res) => {
				if (res.success && res.data && res.data.length > 0) {
					// 마지막 이미지 데이터 가져오기
					const lastImage = res.data[res.data.length - 1];
					const imageSrc = '/uploads/plant_i/cm_equipment/' + lastImage.PhysicFileName;

					// 썸네일 이미지 업데이트
					$("#equipThumbmail").attr("src", imageSrc);
				} else {
					// 이미지가 없는 경우 기본 이미지 표시
					$("#equipThumbmail").attr("src", "/static/img/no-image.png");
				}
			});
		}

		// 폼 모드 설정 (읽기/편집/등록)
		setFormMode(mode) {
			const isReadMode = mode === 'read';
			const isEditMode = mode === 'edit';
			const isRegMode = mode === 'reg';
			
			// 모달 전체에서 모든 입력 요소들을 자동으로 찾아서 처리
			const modal = $('#modalEquipMaster');
			const allInputs = modal.find('input, select, textarea');
			
			allInputs.each(function() {
				const element = $(this);
				const elementId = element.attr('id');
				
				// 특정 필드들은 제외 (예: readonly 필드, hidden 필드)
				if (elementId === 'equip_pk' || element.attr('type') === 'hidden') return;
				
				// Kendo UI 컴포넌트인지 확인
				const kendoTypes = ['kendoDropDownList', 'kendoDatePicker', 'kendoSwitch', 'kendoTextBox', 'kendoDropDownTree'];
				let isKendoComponent = false;
				let kendoType = null;
				
				for (const type of kendoTypes) {
					if (element.data(type)) {
						isKendoComponent = true;
						kendoType = type;
						break;
					}
				}
				
				if (isKendoComponent) {
					// Kendo UI 컴포넌트 처리
					try {
						const kendoInstance = element.data(kendoType);
						if (kendoInstance && typeof kendoInstance.enable === 'function') {
							kendoInstance.enable(!isReadMode);
						}
					} catch (e) {
						console.log(`Kendo component error for ${elementId}:`, e);
					}
				} else {
					// 일반 입력 필드 처리
					element.prop('disabled', isReadMode);
				}
			});
			
			// FileUpload 컴포넌트 읽기 모드 설정
			if (window.fileUploader && typeof window.fileUploader.setReadOnlyMode === 'function') {
				window.fileUploader.setReadOnlyMode(isReadMode);
			}
			
			// ImageUpload 컴포넌트 읽기 모드 설정
			if (window.imageUploader && typeof window.imageUploader.setReadOnlyMode === 'function') {
				window.imageUploader.setReadOnlyMode(isReadMode);
			}
			
			// 버튼들도 모드에 따라 표시/숨김
			if (isReadMode) {
				// 읽기모드: 모든 편집 관련 버튼 숨김
				$('#saveBtn').hide();
				$('#disposedBtn').hide();
				$('#notUseBtn').hide();
				$('#upLoc').hide().css('visibility', 'hidden').css('opacity', '0');
				$('#recycleMat').hide().css('visibility', 'hidden').css('opacity', '0');
				$("#div_equip_status").show();
				$("#btnChangeStatus").hide();
				this.updateEquipStatusFields(); // 설비상태에 따른 추가 필드 처리
				$('#btnEquipClassDesc').hide().css('visibility', 'hidden').css('opacity', '0');
				$('#btnEquipSpecDel').hide().css('visibility', 'hidden').css('opacity', '0');
				$('#equipSpecPlus').hide().css('visibility', 'hidden').css('opacity', '0');
				$('#btnEquipCategory').hide().css('visibility', 'hidden').css('opacity', '0');
			} else if (isEditMode) {
				// 편집모드: 기존 설비 수정 시 모든 버튼 표시
				$('#saveBtn').show();
				$('#disposedBtn').show();
				$('#notUseBtn').show();
				$('#upLoc').show().css('visibility', 'visible').css('opacity', '1');
				$('#recycleMat').show().css('visibility', 'visible').css('opacity', '1');
				$("#div_equip_status").show();
				$("#btnChangeStatus").show();
				this.updateEquipStatusFields(); // 설비상태에 따른 추가 필드 처리
				$('#btnEquipClassDesc').hide().css('visibility', 'visible').css('opacity', '1');
				$('#btnEquipSpecDel').hide().css('visibility', 'visible').css('opacity', '1');
				$('#equipSpecPlus').hide().css('visibility', 'visible').css('opacity', '1');
				$('#btnEquipCategory').show().css('visibility', 'visible').css('opacity', '1');
			} else if (isRegMode) {
				// 등록모드: 새 설비 등록 시 일부 버튼만 표시
				$('#saveBtn').show();
				$('#disposedBtn').hide();
				$('#notUseBtn').hide();
				$('#upLoc').show().css('visibility', 'visible').css('opacity', '1');
				$('#recycleMat').show().css('visibility', 'visible').css('opacity', '1');
				$("#div_equip_status").hide();
				$("#btnChangeStatus").hide();
				$('#btnEquipClassDesc').hide().css('visibility', 'visible').css('opacity', '1');
				$('#btnEquipSpecDel').hide().css('visibility', 'visible').css('opacity', '1');
				$('#equipSpecPlus').hide().css('visibility', 'visible').css('opacity', '1');
				$('#btnEquipCategory').show().css('visibility', 'visible').css('opacity', '1');
			}
		}

		// 설비상태에 따른 추가 필드 표시/숨김 처리
		updateEquipStatusFields() {
			const equipStatus = this.equip_status || '';
			
			// 모든 추가 필드 숨기기
			$("#div_equip_date_container").hide();
			$("#div_disposed_date_container").hide();
			
			// 설비상태에 따라 해당 필드만 표시
			if (equipStatus === 'ES_BKDN') {
				// 고장 상태일 때 고장일시 표시
				$("#div_equip_date_container").show();
			} else if (equipStatus === 'ES_DISP') {
				// 불용 상태일 때 불용일시 표시
				$("#div_disposed_date_container").show();
			}
		}

		// 모달 초기화 메소드
		resetForm() {
			// 기본 입력 필드 초기화
			$("#modalEquipMaster input[type='text']").val('');
			$("#modalEquipMaster input[type='number']").val('');
			$("#modalEquipMaster input[type='date']").val('');
			$("#modalEquipMaster input[type='hidden']").val('');
			$("#modalEquipMaster textarea").val('');

			// DropDown 컨트롤 초기화
			if (this.locPkDropDown) this.locPkDropDown.value('');
			if (this.deptPkDropDown) this.deptPkDropDown.value('');
			if (this.importRankDropDown) this.importRankDropDown.value('');
			if (this.supplierDropDown) this.supplierDropDown.value('');
			if (this.makerDropDown) this.makerDropDown.value('');
			if (this.ccenterCdDropDown) this.ccenterCdDropDown.value('');

			// DatePicker 초기화
			if (this.productionYearPicker) this.productionYearPicker.value('');
			if (this.installDatePicker) this.installDatePicker.value('');
			if (this.warrantyDatePicker) this.warrantyDatePicker.value('');

			// Switch 초기화
			if (this.environEquipYnSwitch) this.environEquipYnSwitch.check(false);

			// 이미지 초기화
			if (window.imageUploader && typeof window.imageUploader.clearImages === 'function') {
				window.imageUploader.clearImages();
				window.imageUploader.dataPk = null;
			}

			// 파일 초기화
			if (window.fileUploader && typeof window.fileUploader.clearFiles === 'function') {
				window.fileUploader.clearFiles();
				window.fileUploader.dataPk = null;
			}

			// 그리드 초기화
			if (this.pmGrid) this.pmGrid.dataSource.data([]);
			if (this.equSpecGrid) this.equSpecGrid.dataSource.data([]);
			if (this.partsGrid) this.partsGrid.dataSource.data([]);
			if (this.inspectionGrid) this.inspectionGrid.dataSource.data([]);
			if (this.logGrid) this.logGrid.dataSource.data([]);

			// 기본 이미지로 복원
			$("#modalEquipMaster img").attr("src", "/static/img/no-image.png");

			// 클래스 속성 초기화
			this.equip_pk = null;
			this.equipStatusYN = false;
			this.useYn = null;

			// 버튼 숨김 처리
			$("#disposedBtn").hide();
			$("#notUseBtn").hide();
			$("#div_equip_status").hide();
			
			// 추가 필드 초기화
			$("#div_equip_date_container").hide();
			$("#div_disposed_date_container").hide();
			$("#txt_equip_date").val('');
			$("#txt_disposed_date").val('');

			FormUtil.resetForm($('#baseinfoForm'));
		}
	}

	$(document).ready(function () {
		if (typeof window.equipMasterPage === 'undefined') {
			window.equipMasterPage = new EquipMaster();
		}
		// 체크박스 클릭 시 버튼 활성/비활성화
		$('#chkItems').on('change', function () {
			if ($(this).is(':checked')) {
				$('#btnConfirmRespDisp').prop('disabled', false);
			} else {
				$('#btnConfirmRespDisp').prop('disabled', true);
			}
		});

	});

	function showMainImageFromUploader() {
		if (!window.imageUploader) return;

		const imageDataList = window.imageUploader.getImagesData();
		const mainImage = imageDataList.find(file => file); // 첫 번째 이미지

		const container = document.querySelector('#modalEquipMaster .image-container');
		if (container) {
			if (mainImage) {
				container.innerHTML = `
					<img src="${mainImage.src}" alt="${mainImage.name}" style="max-width: 100%; max-height: 100%;">
				`;
			} else {
				// fallback 이미지
				container.innerHTML = `
					<div style="text-align: center;">
						<img src="/static/img/no-image.png" alt="No image" style="width: 100px; height: 100px;">
						<div style="margin-top: 10px; color: #999;">No image</div>
					</div>
				`;
			}
		}
	}

	function showMainFileFromUploader() {
		if (!window.fileUploader) return;

		const fileDataList = window.fileUploader.getFilesData();
		const mainFile = fileDataList.find(file => file); // 첫 번째 파일

		const container = document.querySelector('#modalEquipMaster .file-container');
		if (container) {
			if (mainFile) {
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #1e4f88;"></i>
						<div style="margin-top: 10px; color: #333;">${mainFile.name}</div>
						<div style="color: #666; font-size: 12px;">${formatFileSize(mainFile.size)}</div>
					</div>
				`;
			} else {
				// fallback 파일 표시
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #999;"></i>
						<div style="margin-top: 10px; color: #999;">No file</div>
					</div>
				`;
			}
		}
	}

	function formatFileSize(bytes) {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}

	function fetchSomeData() {		
		try {
			if (window.imageUploader && typeof window.imageUploader.saveImages === 'function' && window.imageUploader.getImagesData && window.imageUploader.getImagesData().length > 0) {
				const imageResult = window.imageUploader.saveImages();
			}
			if (window.fileUploader && typeof window.fileUploader.saveFiles === 'function' && window.fileUploader.getFilesData && window.fileUploader.getFilesData().length > 0) {
				const fileResult = window.fileUploader.saveFiles();
			}
		} catch (error) {
			console.error('Error:', error);
			alert(error.message);
			throw error;
		}
	}
</script>

<!-- 설비사양 설정 Kendo Window 팝업 -->
<div id="specSettingWindow" class="dynamic-window" style="display:none;">
	<table id="specTable" class="k-grid k-widget dynamic-table" style="width: 100%; height: 300px; overflow-y: auto; ">
		<thead>
			<tr>
				<th>
					<button id="addSpecRowBtn" class="k-button k-primary">행 추가</button>
				</th>
				<th>사양명</th>
				<th>단위</th>
				<th>사양(Spec)</th>
			</tr>
		</thead>
		<tbody>
			<!-- 동적 행 추가 -->
		</tbody>
	</table>
	<div class="modal-footer">
		<button type="button" class="btn-save" id="btnConfirmEquipSpec">확인</button>
		<button type="button" class="btn-close" id="btnCancelEquipSpec">취소</button>
	</div>
</div>

<style>
	#btnConfirmRespDisp.btn-red {
		background-color: #dc3545 !important;
		color: white !important;
		border-color: #d9534f !important;
		border-radius: 1px;
	}

		#btnConfirmRespDisp.btn-red:disabled {
			background-color: #f5c6cb !important;
			color: #fff !important;
			border-color: #f5c6cb !important;
			cursor: not-allowed;
			opacity: 0.65;
		}

.folder-icon-btn {
    background-image: url('/static/img/folder-icon.png') !important;
    background-size: 24px 24px !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
}
</style>
