<div id="modalMaterialMaster" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>자재마스터 상세정보</h4>
		</div>
		<div class="modal-body">
			<div class="top-section">
				<div class="section-header">
					<span></span>
					<button type="button" class="btn-copy" id="copyMtrl" name="copyMtrl">
						자재복사
					</button>
				</div>
			</div>
			<div class="edit-form-ui">
				<div class="col-12 col-sm-6 col-md-3" style="display: flex; justify-content: center; align-items: center; height: 200px;">
					<img id="matThumbmail" src="/static/img/no-image.png" alt="No image" style="width: 100px; height: 100px;">
				</div>
				<div class="col-12 col-sm-6 col-md-6">
					<div class="form-row">
						<div class="form-group" style="width: 100%;">
							<label for="mtrl_cd" class="required" data-labelCd="자재코드">자재코드*</label>
							<input type="hidden" id="mtrl_pk" value="{{ material.mtrl_pk }}">
							<input type="text" class="form-control" id="mtrl_cd" name="mtrl_cd" placeholder="50자 이하로 입력하세요">
						</div>
					</div>
					<div class="form-row">
						<div class="form-group" style="width: 100%;">
							<label for="mtrl_nm" class="required" data-labelCd="자재명">자재명*</label>
							<input type="text" class="form-control" id="mtrl_nm" name="mtrl_nm" placeholder="150자 이하로 입력하세요">
						</div>
					</div>
					<div class="form-row">
						<div class="form-group" style="width: 100%;">
							<label for="mtrl_class_pk" class="required" data-labelCd="자재종류">자재종류*</label>
							<button type="button" class="plusbutton" id="mrtlClassPlus" name="mrtlClassPlus"></button>
							<div style="display: flex; gap: 5px;">
								<select id="mtrl_class_pk" name="mtrl_class_pk"></select>
							</div>
						</div>
					</div>
				</div>
				<div class="col-12 col-sm-6 col-md-3" style="display: flex; justify-content: center; align-items: center; height: 200px;">
					<img src="/static/img/qr-sample.png" alt="QR Code" style="width: 200px; height: 200px;">
				</div>
			</div>
			<!-- 탭 섹션 -->
			<div class="section">
				<div class="tab-group">
					<button class="tab-button active" data-tab="materialMasterTab" style="background: #1e4f88; color: white; border-color: #1e4f88;">기본정보</button>
					<button class="tab-button" data-tab="fileTabMat">파일</button>
					<button class="tab-button" data-tab="logTab">로그</button>
				</div>
				<div class="tab-content">
					<!-- 기본정보 탭 컨텐츠 -->
					<form id="materialMasterForm">
						<div class="tab-pane active" id="materialMasterTab">
							<div class="form-group col-md-3">
								<label for="safety_stock_amt" data-labelCd="최소재고량">최소재고량</label>
								<input type="number" class="form-control" id="safety_stock_amt" name="safety_stock_amt">
							</div>
							<div class="form-group col-md-3">
								<label for="stock_amt" data-labelCd="안전재고">안전재고</label>
								<input type="text" class="form-control" id="safety_amt" name="safety_amt" readonly>
							</div>
							<div class="form-group col-md-2">
								<label for="amt_unit_pk" class="required" data-labelCd="수량단위">수량단위*</label>
								<button type="button" class="plusbutton" id="amtUnitPlus" name="amtUnitPlus"></button>
								<select id="amt_unit_pk" name="amt_unit_pk"></select>
							</div>
							<div class="form-group col-md-2">
								<label for="unit_price" data-labelCd="최근 단가">최근 단가</label>
								<input type="number" class="form-control" id="unit_price" name="unit_price">
							</div>
							<div class="form-group col-md-2">
								<label for="unit_price_dt" data-labelCd="최근 단가일자">최근 단가일자</label>
								<input type="date" class="form-control" id="unit_price_dt" name="unit_price_dt" style="border: 1px solid #dee2e6; height: 28px; padding: 0 !important; border-top-left-radius: 4px; border-bottom-left-radius: 4px; ">
							</div>
							<div class="form-group col-md-11">
								<label for="mtrl_dsc" class="required" data-labelCd="자재사양">자재사양*</label>
								<textarea class="form-control" id="mtrl_dsc" name="mtrl_dsc" placeholder="4000자 이하로 입력하세요"></textarea>
							</div>
							<div class="form-group col-md-3">
								<label for="supplier_pk" data-labelCd="공급업체">공급업체</label>
								<select id="supplier_pk" name="supplier_pk"></select>
							</div>
							<div class="form-group col-md-3">
								<label for="maker_pk" data-labelCd="제조사">제조사</label>
								<select id="maker_pk" name="maker_pk"></select>
							</div>
							<div class="form-group col-md-3">
								<label for="construction_pk" data-labelCd="시공사">시공사</label>
								<select id="construction_pk" name="construction_pk"></select>
							</div>
							<div class="form-group col-md-3">
								<label for="equipment_pk" data-labelCd="장비사">장비사</label>
								<select id="equipment_pk" name="equipment_pk"></select>
							</div>
							<div class="form-group col-md-3">
								<label for="delivery_days" data-labelCd="조달기간">조달기간</label>
								<input type="number" class="form-control" id="delivery_days" name="delivery_days">
							</div>
							<div class="form-group col-md-3">
								<label for="delivery_type" data-labelCd="조달기간유형">조달기간유형</label>
								<select id="delivery_type" name="delivery_type"></select>
							</div>
							<div class="form-group col-md-3">
								<label for="erp_mtrl_cd" data-labelCd="ERP 품목코드">ERP 품목코드</label>
								<input type="text" class="form-control" id="erp_mtrl_cd" name="erp_mtrl_cd" placeholder="50자 이하로 입력하세요">
							</div>
							<div class="form-group col-md-3">
								<label for="allow_add_bom" data-labelCd="설비 Parts로 추가">설비 Parts로 추가</label>
								<div class="field-wrapper">
									<input type="checkbox" id="allow_add_bom" name="allow_add_bom" />
								</div>
							</div>
						</div>

					</form>
					<!--파일 탭 컨텐츠 -->
					<div class="tab-pane" id="fileTabMat" style="overflow-y:auto; height: 400px;">
						{% include 'components/ImageUpload.html' with tableName='cm_material' attachName='image' dataPk=cm_material.mtrl_pk|default:'' %}
						{% include 'components/FileUpload.html' with tableName='cm_material' attachName='file' dataPk=cm_material.mtrl_pk|default:'' %}
					</div>
					<!--로그 탭 컨텐츠 -->
					<div class="tab-pane" id="logTab">
						<div id="logGridMat" class="grid"></div>
					</div>
				</div>
				<!-- 버튼 영역 -->
				<div class="modal-footer">
					<button type="button" class="btn-delete" id="delBtnMatM">삭제</button>
					<button type="button" class="btn-save" id="saveBtnMatM">저장</button>
					<button type="button" class="btn-close" id="closeBtn">닫기</button>
				</div>
			</div>
		</div>
	</div>
</div>

<style>

.modal-body {
    overflow-y: auto; 
}

</style>

{% include 'popup/modalMtrlClassAdd.html' %}
{% include 'popup/modalAmtUnitAdd.html' %}
{% include 'popup/modalMtrlCopy.html' %}

<script type="text/javascript">
	class MaterialMaster {
		constructor() {
			this.baseUrl = '/api/kmms/material';
			this.mtrl_pk = null;

			// DropDown Tree와 List 컨트롤 정의
			this.mtrl_class_pk = null;
			this.amt_unit_pk = null;
			this.supplier_pk = null;
			this.maker_pk = null;
			this.construction_pk = null;
			this.equipment_pk = null;
			this.delivery_type = null;

			this.unit_price_dt = null;

			// 그리드 컨트롤 정의
			this.logGridMat = null;

			// 모달 관련 요소 정의
			this.modal = null;

			this.init();
		}

		init() {
			const _this = this;
			this.modal = $("#modalMaterialMaster");

			// DropDown Tree와 List 초기화
			this.mtrl_class_pk = AjaxUtil.fillDropDownOptions($('#mtrl_class_pk'), 'cm_base_code', 'all', null, 'MTRL_CLASS');
			this.amt_unit_pk = AjaxUtil.fillDropDownOptions($('#amt_unit_pk'), 'cm_base_code', 'all', null, 'AMT_UNIT');
			this.supplier_pk = AjaxUtil.fillDropDownOptions($('#supplier_pk'), 'cm_supplier', 'all', null, 'COMP_TYPE', 'CP_S,CP_B');
			this.maker_pk = AjaxUtil.fillDropDownOptions($('#maker_pk'), 'cm_supplier', 'all', null, 'COMP_TYPE', 'CP_M,CP_B');
			this.construction_pk = AjaxUtil.fillDropDownOptions($('#construction_pk'), 'cm_supplier', 'all', null, 'COMP_TYPE', 'CP_C');
			this.equipment_pk = AjaxUtil.fillDropDownOptions($('#equipment_pk'), 'cm_supplier', 'all', null, 'COMP_TYPE', 'CP_E');
			this.delivery_type = AjaxUtil.fillDropDownOptions($('#delivery_type'), 'cm_code', 'all', null, 'PERIOD_TYPE');

			// DatePicker 초기화
			this.unit_price_dt = $("#unit_price_dt").kendoDatePicker({ format: "yyyy-MM-dd" }).data("kendoDatePicker");

			$("#allow_add_bom").kendoSwitch().data("kendoSwitch");

			this.logGridMat = $("#logGridMat").kendoGrid({
				dataSource: {
					transport: {
						read: {
							url: this.baseUrl,
							type: "GET",
							data: function () {
								return {
									action: 'log',
									mtrl_pk: _this.mtrl_pk
								};
							}
						}
					},
					schema: {
						data: function (response) {
							console.log("Grid Response:", response);
							if (Array.isArray(response)) {
								return response;
							}
							return [];
						}
					},
				},
				autoBind: false,
				height: 300,
				sortable: true,
				columns: [
					{ field: "inserter_nm", title: "사용자", width: 100, attributes: { style: "text-align: center" } },
					{ field: "log_type", title: "로그 타입", width: 120, attributes: { style: "text-align: center" } },
					{ field: "log_history", title: "로그 내역", width: 500 },
					{ field: "log_date", title: "일시", width: 150, attributes: { style: "text-align: center" } }
				],
				noRecords: {
					template: "조회된 데이터가 없습니다."
				}
			}).data("kendoGrid");

			// 탭 클릭 이벤트
			$('.tab-button').on('click', function () {
				const tabId = $(this).data('tab');
				$('.tab-button').removeClass('active').removeAttr('style');
				$('.tab-pane').removeClass('active').hide();
				$(this).addClass('active').css({
					'background': '#1e4f88',
					'color': 'white',
					'border-color': '#1e4f88'
				});
				if (tabId) $('#' + tabId).addClass('active').show();

				// switch-case로 탭별 분기 처리
				switch (tabId) {		
					case 'fileTabMat':
						if (_this.mtrl_pk) {
							if (window.imageUploader) {
								window.imageUploader.dataPk = _this.mtrl_pk;
								window.imageUploader.loadFilesFromServer(() => {
									showMainImageFromUploader();
								});
							}

							if (window.fileUploader) {
								window.fileUploader.dataPk = _this.mtrl_pk;
								window.fileUploader.loadFilesFromServer(() => {
									showMainFileFromUploader();
								});
							}

						}
						break;
					case 'logTab':
						if (_this.mtrl_pk && _this.logGridMat) {
							_this.logGridMat.dataSource.read();
						}
						break;
					default:
						if (_this.mtrl_pk) {
							// 기본정보
							this.showMatThumbmail(_this.mtrl_pk);
						}
						break;
				}
			});

            $("#copyMtrl").kendoButton({
                icon: "k-i-copy",// 복사 아이콘
                click: function (e) {
                    e.preventDefault();
                    setModalPosition('#modalMtrlCopy', { width: '70%', height: '70%' });
                    mtrlCopyPage.show(function (selectedMtrl) {
                        console.log('selectedMtrl:', selectedMtrl);

                        FormUtil.BindDataForm(selectedMtrl, $('#materialMasterForm'));

                        _this.mtrl_pk = selectedMtrl.mtrl_pk;
                        _this.showMatThumbmail(selectedMtrl.mtrl_pk);
                        $("#mtrl_cd").val(selectedMtrl.mtrl_cd);
                        $("#mtrl_nm").val(selectedMtrl.mtrl_nm);
                        $('#mtrl_class_pk').data("kendoDropDownList").value(selectedMtrl.mtrl_class_pk);
                    });
                }
            });

			$("#mrtlClassPlus").kendoButton({
				icon: "k-i-plus",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalMtrlClassAdd', { width: '70%', height: '30%' });
					mtrlClassAddPage.show(function (ctrl) {
						if (ctrl === 'mtrl_class') {
							AjaxUtil.fillDropDownOptions($('#mtrl_class_pk'), 'cm_base_code', 'all', null, 'MTRL_CLASS');
						}
					});
				}
			});

			$("#amtUnitPlus").kendoButton({
				icon: "k-i-plus",
				rounded: "full",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalAmtUnitAdd', { width: '70%', height: '70%' });
					amtUnitAddPage.show(function (ctrl) {
						if (ctrl === 'amt_unit') {
							AjaxUtil.fillDropDownOptions($('#amt_unit_pk'), 'cm_base_code', 'all', null, 'AMT_UNIT');
						}
					});
				}
			});

			$('#delBtnMatM').off('click').kendoButton({
				click: function (e) {
					e.preventDefault();

					Alert.confirm('', '삭제하시겠습니까?', function () {
						_this.deleteData();
					})
				}
			});

			$('#saveBtnMatM').off('click').kendoButton({
				click: function (e) {
					e.preventDefault();

					Alert.confirm('', '저장하시겠습니까?', function () {
						_this.saveData();
					})
				}
			});

			// 모달 닫기
			$('#closeBtn').kendoButton({
				click: function () {
					_this.resetForm();

					$('.tab-button').removeClass('active').removeAttr('style');
					$('.tab-pane').removeClass('active').hide();
					$('.tab-button[data-tab="materialMasterTab"]').addClass('active').css({
						'background': '#1e4f88',
						'color': 'white',
						'border-color': '#1e4f88'
					});
					$('#materialMasterTab').addClass('active').show();
					_this.modal.fadeOut();
				}
			});

			// ESC 키로 모달 닫기
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) {
					_this.resetForm();
					_this.modal.fadeOut();
				}
			});
		}

		//저장
		saveData() {
			let _this = this;
			let data = FormUtil.extractForm($('#materialMasterForm'));

			data.mtrl_pk = _this.mtrl_pk;
			data.MtrlCode = $("#mtrl_cd").val();
			data.MtrlName = $("#mtrl_nm").val();
			data.MtrlClassCodePk = $("#mtrl_class_pk").val();

			// 유효성 검사
			if (!$('#mtrl_cd').val()) {
				Alert.alert('', '자재코드를 입력해주세요.');
				return;
			}
			if (!$('#mtrl_nm').val()) {
				Alert.alert('', '자재명을 입력해주세요.');
				return;
			}

			if (!$('#mtrl_class_pk').val()) {
				Alert.alert('', '자재종류를 입력해주세요.');
				return;
			}
			if (!$('#amt_unit_pk').val()) {
				Alert.alert('', '수량단위를 입력해주세요.');
				return;
			}
			if (!$('#mtrl_dsc').val()) {
				Alert.alert('', '자재사양을 입력해주세요.');
				return;
			}

			let fnSuccess = async function (res) {
				if (res.success) {
					//파일 저장
					const result = fetchSomeData();

					Alert.alert('', '저장되었습니다.');

					page.searchMainData();
					_this.resetForm();
					$("#modalMaterialMaster").fadeOut();
				} else if (!res.success) {
					Alert.alert('', res.message);
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, fnSuccess);
			console.log(data);
		}

		deleteData() {
			let _this = this;

			let mtrl_pk = $("#mtrl_pk").val();
			if (mtrl_pk) {
				let fnSuccess = function (res) {
					if (res.success) {
						Alert.alert('', '삭제되었습니다.');
						page.searchMainData();
						_this.resetForm();
						$("#modalMaterialMaster").fadeOut();
					} else if (!res.success) {
						Alert.alert('', '삭제실패');
					}
				};
				AjaxUtil.postAsyncData(_this.baseUrl + '?action=delete', { mtrl_pk: mtrl_pk }, fnSuccess);
			} else {
				Alert.alert('', '데이터를 선택하세요.');
			}
		}

		//자재 마스터
		show(mtrl_pk) {
			let _this = this;
			_this.mtrl_pk = mtrl_pk;
			
			// 자재 상세 정보 API 호출
			let param = {
				action: 'findOne',
				mtrl_pk: mtrl_pk,
			};

			let materialData = AjaxUtil.getSyncData('/api/kmms/material', param);
			
			//썸네일 이미지			
			_this.showMatThumbmail(mtrl_pk);

			// 1.1. 기존 데이터 바인딩
			this.bindMaterialMasterData(materialData);

			if (materialData) {
				$("#modalMaterialMaster").fadeIn();
			}
		}
		
		bindMaterialMasterData(data) {
			FormUtil.BindDataForm(data, $('#materialMasterForm'));

			console.log('row_data:', data);
			$("#mtrl_cd").val(data.mtrl_cd);
			$("#mtrl_nm").val(data.mtrl_nm);

			$('#mtrl_class_pk').data("kendoDropDownList").value(data.mtrl_class_pk);

		}

		showMatThumbmail(dataPk) {
			const url = '/api/files/upload?action=call_attach_file';
			const data = {
				tableName: 'cm_material',
				attachName: 'image',
				dataPk: dataPk || ''
			};

			AjaxUtil.postAsyncData(url, data, (res) => {
				if (res.success && res.data && res.data.length > 0) {
					// 마지막 이미지 데이터 가져오기					
					const lastImage = res.data[res.data.length - 1];
					const imageSrc = '/uploads/plant_i/cm_material/' + lastImage.PhysicFileName;

					// 썸네일 이미지 업데이트
					$("#matThumbmail").attr("src", imageSrc);
				} else {
					// 이미지가 없는 경우 기본 이미지 표시
					$("#matThumbmail").attr("src", "/static/img/no-image.png");
				}
			});
		}

		// 모달 초기화 메소드
		resetForm() {
			FormUtil.resetForm($('#materialMasterForm'));

			$("#mtrl_cd").val('');
			$("#mtrl_nm").val('');
			$('#mtrl_class_pk').data("kendoDropDownList").value('');

			// 이미지 초기화
			if (window.imageUploader && typeof window.imageUploader.clearFiles === 'function') {
				window.imageUploader.clearFiles();
			}

			// 파일 초기화
			if (window.fileUploader && typeof window.fileUploader.clearFiles === 'function') {
				window.fileUploader.clearFiles();
			}

			// 기본 이미지로 복원
			$("#modalMaterialMaster img").attr("src", "/static/img/no-image.png");

			// 클래스 속성 초기화
			this.mtrl_pk = null;

			// 그리드 초기화
			if (this.logGridMat) this.logGridMat.dataSource.data([]);
		}
	}

	$(document).ready(function () {
		if (typeof window.materialMasterPage === 'undefined') {
			window.materialMasterPage = new MaterialMaster();
		}
	});

	function showMainImageFromUploader() {
		if (!window.imageUploader) return;

		const imageDataList = window.imageUploader.getImagesData();
		const mainImage = imageDataList.find(file => file); // 첫 번째 이미지

		const container = document.querySelector('#modalMaterialMaster .image-container');
		if (container) {
			if (mainImage) {
				container.innerHTML = `
					<img src="${mainImage.src}" alt="${mainImage.name}" style="max-width: 100%; max-height: 100%;">
				`;
			} else {
				// fallback 이미지
				container.innerHTML = `
					<div style="text-align: center;">
						<img src="/static/img/no-image.png" alt="No image" style="width: 100px; height: 100px;">
						<div style="margin-top: 10px; color: #999;">No image</div>
					</div>
				`;
			}
		}
	}

	function showMainFileFromUploader() {
		if (!window.fileUploader) return;

		const fileDataList = window.fileUploader.getFilesData();
		const mainFile = fileDataList.find(file => file); // 첫 번째 파일

		const container = document.querySelector('#modalMaterialMaster .file-container');
		if (container) {
			if (mainFile) {
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #1e4f88;"></i>
						<div style="margin-top: 10px; color: #333;">${mainFile.name}</div>
						<div style="color: #666; font-size: 12px;">${formatFileSize(mainFile.size)}</div>
					</div>
				`;
			} else {
				// fallback 파일 표시
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #999;"></i>
						<div style="margin-top: 10px; color: #999;">No file</div>
					</div>
				`;
			}
		}
	}

	function formatFileSize(bytes) {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}

	function fetchSomeData() {		
		try {
			if (window.imageUploader && typeof window.imageUploader.saveImages === 'function' && window.imageUploader.getImagesData && window.imageUploader.getImagesData().length > 0) {
				const imageResult = window.imageUploader.saveImages();
			}
			if (window.fileUploader && typeof window.fileUploader.saveFiles === 'function' && window.fileUploader.getFilesData && window.fileUploader.getFilesData().length > 0) {
				const fileResult = window.fileUploader.saveFiles();
			}
		} catch (error) {
			console.error('Error:', error);
			alert(error.message);
			throw error;
		}
	}

	$(document).on("click", ".grid-column-link", async function (e) {
		e.preventDefault();
		let equipPk = $(this).data("equip-pk");
		if (!equipPk) return;

		// 이미 로드된 경우 재사용
		if ($('#modalMaterialMaster').length > 0 && typeof materialMasterPage !== 'undefined') {
			materialMasterPage.show(equipPk);
			// 기본정보 탭 활성화
			$('.tab-button').removeClass('active').removeAttr('style');
			$('.tab-pane').removeClass('active').hide();
			$('.tab-button[data-tab="equipMasterForm"]').addClass('active').css({
				'background': '#1e4f88',
				'color': 'white',
				'border-color': '#1e4f88'
			});
			$('#equipMasterForm').addClass('active').show();
			return;
		}
	});
</script>


