{% extends "app/layout.html" %}
{% block css %}

<style>
	/* âœ… ê²€ìƒ‰ í¼ ê¸°ë³¸ ìƒíƒœ: í•œ ì¤„ë§Œ ë³´ì´ê²Œ ì„¤ì • */
	#searchFormContent {
		overflow: hidden;
		height: 50px; /* âœ… í•œ ì¤„ë§Œ ë³´ì´ë„ë¡ ì„¤ì • */
		transition: height 0.3s ease-in-out;
	}

	/* âœ… ê²€ìƒ‰ í¼ì´ í¼ì³ì§„ ìƒíƒœ */
	.search-expanded {
		height: auto !important; /* âœ… í¼ì¹  ë•Œ ì „ì²´ ë³´ì´ë„ë¡ ì„¤ì • */
	}

	/* âœ… ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	#toggleSearchBtn {
		width: 20px;
		height: 20px;
		border: none;
		background: transparent;
		cursor: pointer;
		position: relative;
	}

		#toggleSearchBtn::before {
			content: "â–¼";
			color: #0d6efd;
			font-size: 20px;
			position: absolute;
			left: 50%;
			top: 50%;
			transform: translate(-50%, -50%);
			transition: transform 0.3s ease; /* âœ… ì• ë‹ˆë©”ì´ì…˜ ì ìš© */
		}

		#toggleSearchBtn.expanded::before {
			content: "â–²";
		}

	/* Kendo Scheduler ì´ë²¤íŠ¸ ë°”ê¹¥ íŒŒë€ìƒ‰(ê¸°ë³¸ ë°°ê²½, í…Œë‘ë¦¬) ì œê±° */
	.k-event, .k-scheduler-event, .k-event-template {
		background: #fff !important;
		border-color: #fff !important;
		color: #1976d2;
	}
</style>

{% endblock %}

{% block content %}

<div class="content-wrap">
	<div class="content-ui-row">
		<form id="searchForm" class="search-form">
			<div class="card-content search">
				<div class="form-ui-header">
					<div id="toggleSearchBtn"></div> <!-- âœ… ì‚¼ê°í˜• í™”ì‚´í‘œ ë²„íŠ¼ -->
				</div>
				<div class="form-ui" id="searchFormContent">
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ê²€ìƒ‰í‚¤ì›Œë“œ</label>
							<input id="chkMastNo" class="k-textbox" placeholder="ì ê²€ë²ˆí˜¸" style="width: 30%;" />
							<input id="searchText" class="k-textbox" placeholder="ì ê²€ëª…,ì„¤ë¹„ì½”ë“œ,ì„¤ë¹„ëª…" style="width: 60%;" />
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ê´€ë¦¬ë¶€ì„œ</label>
							<select id="equipDeptPk" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì„¤ë¹„ìœ„ì¹˜</label>
							<select id="locPk" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì ê²€ ë¶€ì„œ</label>
							<select id="deptPk" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì ìš©ì—¬ë¶€</label>
							<select id="useYn" style="width: 200px;">
							</select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì£¼ê¸°ë‹¨ìœ„</label>
							<select id="cycleTypeCd" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ë‹¤ìŒ ì£¼ê¸°ì¼</label>
							<div id="date_chk"></div>
							<div id="srch_date_range"></div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="form-item align-h">
							<label class="k-label k-form-label" for="chk_my_task">ë‚˜ì˜ ë‹´ë‹¹ê±´</label>
							<input id="chk_my_task" name="chk_my_task">
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label" for="chk_legal">ë²•ì •ê´€ë¦¬ì„¤ë¹„</label>
							<input id="chk_legal" name="chk_legal">
						</div>
					</div>
				</div>
			</div>
		</form>
		<div class="content-ui-row">
			<div class="card-content grid">
				<div class="card-group-btn">
					<span class="info-text">
						<i class="material-symbols-outlined">list_alt</i>
						<label data-labelCd="ì ê²€ ë§ˆìŠ¤í„°">ì ê²€ ë§ˆìŠ¤í„°</label>
						<button id="btnSimulation" class="btn-search" style="margin-left: 10px;">ì£¼ê¸° ì‹œë®¬ë ˆì´ì…˜</button>
					</span>
					<span>
						<!-- ì˜¤ë¥¸ìª½ ë²„íŠ¼ ì˜ì—­-->
						<button id="btnAdd" class="btn-search">ë“±ë¡</button>
						<button id="btnSearch" class="btn-search">ì¡°íšŒ</button>
						<button id="btnExcel">Excel</button>
						<button id="btnPopupTest" class="btn-search">íŒì—…í…ŒìŠ¤íŠ¸</button>
					</span>
				</div>
				<div id="pi_master_grid"></div>
			</div>
		</div>

	</div>
</div>
<!-- PMì¼ì •ìƒì„± Kendo Window íŒì—… -->
<div id="simulationCalendarWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div>
		<form id="shearchCalForm">
			<div class="card-content">
				<div class="form-ui">
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì‘ì—…ë¶€ì„œ</label>
							<select id="calDeptPk" name="calDeptPk" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ë‹´ë‹¹ì</label>
							<select id="calChkUserPk" name="calChkUserPk" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì¡°íšŒìœ í˜•</label>
							<select id="calSearchType" name="calSearchType" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<button id="btnSearchCal" class="btn-search">ê²€ìƒ‰</button>
						</div>
					</div>
				</div>
			</div>
			<div id="simulationScheduler"></div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnCloseCalendar">ë‹«ê¸°</button>
	</div>
</div>
<!-- PMì¼ì •ìƒì„± Kendo Window íŒì—… -->
<div id="simulationCalDetailWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div>
		<div id="piDetailGrid"></div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnCloseCalDetail">ë‹«ê¸°</button>
	</div>
</div>
{% verbatim %}
{% endverbatim %}
{% endblock %}

{% block scripts %}

{% include '../../popup/modalPiMaster.html'%}
{% include '../../popup/modalPmCopy.html'%}
{% include '../../popup/modalOccupations.html'%}
{% include 'common/file_upload.html' %}
{% include '../../popup/modalEqus.html'%}
{% include '../../popup/popup_test.html'%}
{% include '../../popup/modalItems.html'%}

<script type="text/javascript">
	class PiMasterPage {
		constructor() {
			this.grid = null;
			this.gridDetail = null;
			this.upload = null;
			this.baseUrl = '/api/kmms/pi_master';

			this.comboDept = [];
			this.schedulerData = [];
			this.holidayInfo = null;
			this.holidayCustom = null;

			this.init();
		}

		init() {
			let _this = this;
			let piGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'chk_mast_pk', title: 'ì ê²€ PK', hidden: true },
					{ field: 'chk_mast_no', title: 'ì ê²€ë²ˆí˜¸', width: 80 },
					{
						field: "chk_mast_nm",
						title: "ì ê²€ëª…",
						width: 150,
						template: '<a href="javascript:void(0);" class="check-link" data-check-pk="#=chk_mast_pk#">#=chk_mast_nm#</a>'
					},
					{ field: 'dept_nm', title: 'ì ê²€ë¶€ì„œ', width: 100 },
					{ field: 'chk_user_nm', title: 'ì ê²€ë‹´ë‹¹ì', width: 100 },
					{ field: 'chk_equip_item_cnt', title: 'ì ê²€ì„¤ë¹„ìˆ˜ëŸ‰', width: 100 },
					{ field: 'equip_chk_item_cnt', title: 'ì ê²€í•­ëª©ìˆ˜ëŸ‰', width: 100 },
					{
						field: 'cycle_display_nm',
						title: 'ì£¼ê¸°',
						width: 80,
						template: '#=cycle_display_nm# (#=per_number#)'
					},
					{ field: 'cycle_type_nm', title: 'ì£¼ê¸°ë‹¨ìœ„', width: 100 },

					{
						field: 'sched_start_date',
						title: 'ì£¼ê¸° ì‹œì‘ì¼',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(sched_start_date), "yyyy-MM-dd") #'
					},
					{
						field: 'last_chk_date',
						title: 'ìµœê·¼ ìƒì„±ëœ ì¼ì •',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(last_chk_date), "yyyy-MM-dd") #'
					},
					{
						//field: 'next_chk_date',
						//choi : ì„ì‹œ ì½”ë”©
						field: 'last_chk_date',
						title: 'ë‹¤ìŒ ì£¼ê¸°ì¼',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(last_chk_date), "yyyy-MM-dd") #'
					},
					{
						field: 'use_yn',
						title: 'ì ìš©ì—¬ë¶€',
						width: 80,
						template: '#= use_yn == "Y" ? "ì ìš©" : "ë¯¸ì ìš©" #'
					}
				],
				dataBound: function (e) {
					$(".pm-link").off("click").on("click", function (e) {
						e.preventDefault();
						let pmPk = $(this).data("pm-pk");  // âœ… pm_pk ê°’ ê°€ì ¸ì˜¤ê¸°

					});
				},
				height: "540px"
			};
			_this.grid = new Grid($("#pi_master_grid"), piGridOption);

			let piDetailGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'chk_mast_pk', title: 'ì ê²€ PK', hidden: true },
					{ field: 'chk_mast_no', title: 'ì ê²€ë²ˆí˜¸', width: 80 },
					{
						field: "chk_mast_nm",
						title: "ì ê²€ëª…",
						width: 150,
					},			
					{
						field: 'sched_start_date',
						title: 'ì£¼ê¸° ì‹œì‘ì¼',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(sched_start_date), "yyyy-MM-dd") #'
					},
					{
						field: 'last_chk_date',
						title: 'ìµœê·¼ ìƒì„±ëœ ì¼ì •',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(last_chk_date), "yyyy-MM-dd") #'
					},
					{
						field: 'cycle_display_nm',
						title: 'ì£¼ê¸°',
						width: 80,
					},
				],
				height: "400px"
			};

			_this.gridDetail = new Grid($("#piDetailGrid"), piDetailGridOption);

			$('#checkNo').kendoTextBox();
			$('#searchText').kendoTextBox();

			AjaxUtil.fillDropDownTreeOptions($("#locPk"), "location", "select");
			AjaxUtil.fillDropDownTreeOptions($("#equipDeptPk"), "depart", "select");
			AjaxUtil.fillDropDownTreeOptions($("#deptPk"), "depart", "select");

			$("#useYn").kendoDropDownList({
				dataSource: [
					{ text: "ì „ì²´", value: "" },
					{ text: "ì ìš©", value: "Y" },
					{ text: "ë¯¸ì ìš©", value: "N" },
				],
				dataTextField: "text",
				dataValueField: "value"
			});

			$("#cycleTypeCd").kendoDropDownList({
				dataSource: [
					{ text: "ì„ íƒ", value: "" },
					{ text: "ë…„", value: "Y" },
					{ text: "ì›”", value: "M" },
					{ text: "ì£¼", value: "W" },
					{ text: "ì¼", value: "D" },
				],
				dataTextField: "text",
				dataValueField: "value"
			});

			$('#btnAdd').kendoButton({
				icon: "pencil",
				themeColor: "blue",
				spriteCssClass: "k-icon k-foo",
				click: function (e) {
					e.preventDefault();
					page.resetModalInputs();  // ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ

					//choi : popup/modalPiMaster.htmlì— ìˆëŠ” idë¥¼ ì°¸ê³ í•˜ì—¬ popupì²˜ë¦¬í•œë‹¤
					$("#modalPiMaster").fadeIn();
				}
			});

			$('#btnExcel').kendoButton({
				icon: "file-excel",
				themeColor: "success",
				click: function () {
					page.exportExcel();
				}
			});


			//choi : testë²„íŠ¼
			$('#btnPopupTest').kendoButton({
				icon: "pencil",
				themeColor: "blue",
				spriteCssClass: "k-icon k-foo",
				click: function (e) {
					e.preventDefault();

					let popup = new PopupTestPage();

					popup.show(function (selectedItem) {
						// ì—¬ê¸°ì„œ ì„ íƒëœ ë°ì´í„°ë¥¼ ë°›ì•„ì„œ ì²˜ë¦¬
						console.log("ì„ íƒëœ í•­ëª©:", selectedItem);
					});
				}
			});


			$('#chk_my_task').kendoSwitch({
				checked: false,
				change: function (e) {
					if (e.checked) {
						console.log("chk_my_task ON ìƒíƒœë¡œ ë³€ê²½ë¨");
					} else {
						console.log("chk_my_task OFF ìƒíƒœë¡œ ë³€ê²½ë¨");
					}
				}
			});

			$('#chk_legal').kendoSwitch({
				checked: false
			});

			$('#date_chk').kendoSwitch({
				checked: false
			});

			//search form
			$("#srch_date_range").kendoDateRangePicker({
				range: {
					start: new Date(),
					end: new Date()
				},
				change: function (e) {

				},
				format: "yyyy-MM-dd",
				labels: false,
				startField: "start_date",
				endField: "end_date"
			});

			$('#btnAdd').kendoButton({
				icon: "k-i-pencil",
				themeColor: "info",     // info í…Œë§ˆ ì‚¬ìš©
				fillMode: "outline",    // outline ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
				click: function (e) {
					e.preventDefault();
					page.resetModalInputs();  // ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
					$("#modalPiMaster").fadeIn();
				}
			}).css('visibility', 'visible');

			//form button
			$('#btnSearch').kendoButton({
				icon: "search",
				themeColor: "base",
				click: function () {
					_this.searchMainData();
				}
			});

			AjaxUtil.fillDropDownTreeOptions($("#calDeptPk"), "depart", "select");
			AjaxUtil.fillDropDownOptions($('#calChkUserPk'), 'cm_user_info', 'choose');
			AjaxUtil.fillDropDownOptions($('#calSearchType'), 'cm_code', 'choose', null, 'CYCLE_TYPE');

			// ì ê²€ ì£¼ê¸° ì‹œë®¬ë ˆì´ì…˜ Kendo Window ì´ˆê¸°í™” (ìµœì´ˆ 1íšŒë§Œ)
			$("#simulationCalendarWindow").kendoWindow({
				title: "ì ê²€ ì£¼ê¸° ì‹œë®¬ë ˆì´ì…˜",
				visible: false,
				modal: true,
				actions: [],
				appendTo: "body",
				width: '90vw',
				position: { top: 20, left: 100 }
			});

			$("#simulationCalDetailWindow").kendoWindow({
				title: "ì ê²€ ì£¼ê¸° ì‹œë®¬ë ˆì´ì…˜ ìƒì„¸",
				visible: false,
				modal: true,
				actions: [],
				appendTo: "body",
				width: '80vw',
				position: { top: 50, left: 150 }
			});

			$('#btnSimulation').kendoButton({
				icon: "k-i-calendar",
				themeColor: "info",     // info í…Œë§ˆ ì‚¬ìš©
				fillMode: "outline",    // outline ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
				click: function (e) {
					e.preventDefault();

					let calParam = {
						action: 'selectEquipChkScheSimulationCycleByMon',
						deptPk: $('#calDeptPk').data('kendoDropDownTree').value(),
						userPk: $('#calChkUserPk').data('kendoDropDownList').value(),
						calSearchType: $('#calSearchType').data('kendoDropDownList').value()
					};

					_this.schedulerData = AjaxUtil.getSyncData('/api/kmms/pi_master', calParam);
					_this.holidayInfo = AjaxUtil.getSyncData('/api/kmms/holiday', { action: 'findAllHolidayInfoRes' });
					_this.holidayCustom = AjaxUtil.getSyncData('/api/kmms/holiday', { action: 'findAllHolidayCustom' });

					_this.loadSimulationScheduler();

					var wnd = $("#simulationCalendarWindow").data("kendoWindow");
					wnd.open();
				}
			}).css('visibility', 'visible');

			$("#btnCloseCalendar").kendoButton({
				themeColor: "base",
				click: function () {
					$("#simulationCalendarWindow").data("kendoWindow").close();
				}
			});

			$("#btnCloseCalDetail").kendoButton({
				themeColor: "base",
				click: function () {
					$("#simulationCalDetailWindow").data("kendoWindow").close();
				}
			});

			// ì¡°íšŒ ì¡°ê±´ ë³€ê²½ ì‹œì—ë„ ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨
			$('#calDeptPk, #calChkUserPk, #calSearchType').on('change', () => {
				this.loadSimulationScheduler();
			});
		}

		/**
		 * ëª¨ë‹¬ì°½ ì…ë ¥ë€ ì´ˆê¸°í™” í•¨ìˆ˜
		 * choi : ëª¨ë‹¬ì°½ì— ê°’ì„ ë„˜ê²¨ì£¼ëŠ” ì—­í• ì„ í•¨
		 */
		resetModalInputs() {
			// ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
			if (this.grid) {
				this.grid.setData([]);
			}
			FormUtil.resetForm($("#searchForm"));// í¼ ì´ˆê¸°í™”
		}

		searchMainData() {
			let _this = this;

			// ë‚ ì§œ ë°ì´í„° ì²˜ë¦¬
			let startDate = '';
			let endDate = '';
			let dateRangePicker = $("#srch_date_range").data("kendoDateRangePicker");

			if (dateRangePicker) {
				let range = dateRangePicker.range();
				if (range) {
					startDate = range.start ? kendo.toString(range.start, 'yyyy-MM-dd') : '';
					endDate = range.end ? kendo.toString(range.end, 'yyyy-MM-dd') : '';
				}
			}

			// ì•ˆì „í•œ ì»´í¬ë„ŒíŠ¸ ê°’ ê°€ì ¸ì˜¤ê¸°
			const getComponentValue = (selector, type) => {
				try {
					const component = $(selector).data(type);
					return component ? component.value() : '';
				} catch (e) {
					console.warn(`Failed to get value for ${selector}`, e);
					return '';
				}
			};

			var isDateChecked = getComponentValue("#date_chk", "kendoSwitch");
			var isMyTaskChecked = getComponentValue("#chk_my_task", "kendoSwitch");
			var isLegalChecked = getComponentValue("#chk_legal", "kendoSwitch");

			let param = {
				action: 'findAll',
				chkMastNo: $('#chkMastNo').val(),
				searchText: $('#searchText').val(),
				equipDeptPk: getComponentValue("#equipDeptPk", "kendoDropDownTree"),
				locPk: getComponentValue("#locPk", "kendoDropDownTree"),
				deptPk: getComponentValue("#deptPk", "kendoDropDownTree"),
				useYn: getComponentValue("#useYn", "kendoDropDownList"),
				cycleTypeCd: getComponentValue("#cycleTypeCd", "kendoDropDownList"),
				startDate: isDateChecked ? startDate : '',
				endDate: isDateChecked ? endDate : '',

				isMyTask: isMyTaskChecked ? 'Y' : 'N',
				isLegal: isLegalChecked ? 'Y' : 'N',
			};

			//for test
			let result = AjaxUtil.getSyncData(_this.baseUrl, param);
			console.log(result);
			_this.grid.setData(result);
		}

		// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
		exportExcel() {
			let gridData = $('#pi_master_grid').data("kendoGrid");
			gridData.bind("excelExport", function (e) {
				e.workbook.fileName = "pi_master.xlsx";
			});
			gridData.saveAsExcel();
		}

		loadSimulationScheduler() {
			// âœ… holidayInfoê°€ ìœ íš¨í•œ ê²½ìš° ì¶”ê°€ ë°ì´í„° ì‚½ì…
			if (Array.isArray(this.holidayInfo)) {
				this.holidayInfo.forEach(holiday => {
					this.schedulerData.push({
						id: holiday.id,
						title: holiday.name,
						start: new Date(holiday.year, holiday.month - 1, holiday.day),
						end: new Date(holiday.year, holiday.month - 1, holiday.day),
						isAllDay: true,
						type: holiday.type,
					});
				});
			}

			// âœ… holidayCustomê°€ ìœ íš¨í•œ ê²½ìš° ì¶”ê°€ ë°ì´í„° ì‚½ì…
			if (Array.isArray(this.holidayCustom)) {
				this.holidayCustom.forEach(holiday => {
					this.schedulerData.push({
						id: holiday.id,
						title: holiday.name,
						start: new Date(holiday.year, holiday.month - 1, holiday.day),
						end: new Date(holiday.year, holiday.month - 1, holiday.day),
						isAllDay: true,
						type: holiday.type,
					});
				});
			}
			console.log('schedulerData', this.schedulerData);
			var dataSource = new kendo.data.SchedulerDataSource({
				data: this.schedulerData,
				schema: {
					model: {
						id: "id",
						fields: {
							id: { type: "number" },
							title: { field: "title", defaultValue: "No title", validation: { required: true } },
							start: { type: "date", field: "start" },
							end: { type: "date", field: "end" },
							isAllDay: { type: "boolean", field: "isAllDay" }
						}
					}
				}
			});

			$("#simulationScheduler").empty();

			$("#simulationScheduler").kendoScheduler({
				date: new Date('2025-05-01'),
				height: 650,
				views: [
					{ type: "month", selected: true, eventHeight: 30 }
				],
				editable: false,
				timezone: "Asia/Seoul",
				autoBind: true,
				allDaySlot: true,
				showWorkHours: false,
				messages: {
					today: "ì˜¤ëŠ˜",
					allDay: "ì¢…ì¼",
					date: "ë‚ ì§œ",
					event: "ì´ë²¤íŠ¸",
					time: "ì‹œê°„",
					showFullDay: "í•˜ë£¨ ì „ì²´ ë³´ê¸°",
					showWorkDay: "ì—…ë¬´ ì‹œê°„ë§Œ ë³´ê¸°",
					save: "ì €ì¥",
					cancel: "ì·¨ì†Œ",
					destroy: "ì‚­ì œ"
				},
				eventTemplate: (e) => {
					const y = e.start.getFullYear();
					const m = (e.start.getMonth() + 1).toString().padStart(2, '0');
					const d = e.start.getDate().toString().padStart(2, '0');
					const eventDate = `${y}-${m}-${d}`;

					// holidayInfo + holidayCustom í†µí•©
					const allHolidays = [...(this.holidayInfo || []), ...(this.holidayCustom || [])];

					const isHoliday = allHolidays.some(h => {
						const hy = h.year;
						const hm = h.month.toString().padStart(2, '0');
						const hd = h.day.toString().padStart(2, '0');
						const hDate = `${hy}-${hm}-${hd}`;
						return hDate === eventDate;
					});

					const textColor = isHoliday ? '#d32f2f' : '#1976d2';
					const bgColor = isHoliday ? '#ffffff' : '#dff0d8';

					return `<span style="background:${bgColor};color:${textColor};border-radius:6px;padding:2px 6px;">${e.title}</span>`;
				},
				dataSource: dataSource
			});

			// ì¼ì • í´ë¦­ ì‹œ alert (jQuery ì´ë²¤íŠ¸ ìœ„ì„)
			$("#simulationScheduler").off("click", ".k-event").on("click", ".k-event", function (e) {
				var scheduler = $("#simulationScheduler").data("kendoScheduler");
				var uid = $(this).data("uid");
				var event = scheduler.occurrenceByUid(uid);
				if (event) {
					//console.log('event:', event);
					//debugger;
					if (event.type == '') {
						// ê·¸ ì™¸ ì¼ì •ì€ ëª¨ë‹¬ì°½ìœ¼ë¡œ í‘œì‹œ
						var wnd = $("#simulationCalDetailWindow").data("kendoWindow");
						wnd.open();
					}
				}
			});
		}
	}

	let page = null;
	page = new PiMasterPage();

	$(document).ready(function () {
		page.searchMainData();

		// âœ… ìµœì´ˆì—ëŠ” í•œ ì¤„ë§Œ í‘œì‹œ (CSSì—ì„œ height: 50px; ì ìš©)
		$("#searchFormContent").removeClass("search-expanded");

		// âœ… ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
		$(document).on("click", "#toggleSearchBtn", function () {
			let searchForm = $("#searchFormContent");

			if (searchForm.hasClass("search-expanded")) {
				searchForm.removeClass("search-expanded").animate({ height: "50px" }, 300);
				$("#toggleSearchBtn").removeClass("expanded");  // ğŸ”¹ expanded í´ë˜ìŠ¤ ì œê±°
			} else {
				searchForm.addClass("search-expanded").animate({ height: "auto" }, 300);
				$("#toggleSearchBtn").addClass("expanded");  // ğŸ”¹ expanded í´ë˜ìŠ¤ ì¶”ê°€
			}
		});
	});
</script>

{% endblock %}