{% extends "app/layout.html" %}

{% block content %}
<div class="content-wrap">
	<div class="content-ui-row">
		<form id="searchForm" class="search-form">
			<div class="card-content search">
				<div class="form-ui-header">
					<div id="toggleSearchBtn"></div> <!-- âœ… ì‚¼ê°í˜• í™”ì‚´í‘œ ë²„íŠ¼ -->
				</div>
				<div class="form-ui" id="searchFormContent">
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ê²€ìƒ‰í‚¤ì›Œë“œ</label>
							<input id="keyword" name="keyword" class="k-textbox" placeholder="PMë²ˆí˜¸,PMëª…,ì„¤ë¹„ì½”ë“œ,ì„¤ë¹„ëª…" style="width: 100%;" />
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ê´€ë¦¬ë¶€ì„œ</label>
							<select id="srch_dept" name="equDept" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì„¤ë¹„ìœ„ì¹˜</label>
							<select id="srch_location" name="equLoc" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì‹¤í–‰ ë¶€ì„œ</label>
							<select id="srch_pmDept" name="pmDept" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">PMìœ í˜•</label>
							<select id="serchPmType" name="pmType" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì ìš©ì—¬ë¶€</label>
							<select id="srchApplyYn" name="applyYn" style="width: 200px;">
							</select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ì£¼ê¸°ë‹¨ìœ„</label>
							<select id="srchPeriodUnit" name="cycleType" style="width: 200px;"></select>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label">ë‹¤ìŒ ì£¼ê¸°ì¼</label>
							<div id="srch_date_range"></div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="form-item align-h">
							<label class="k-label k-form-label" for="chk_my_task">ë‚˜ì˜ ë‹´ë‹¹ê±´</label>
							<input id="chk_my_task" name="isMyTask">
						</div>
					</div>
					<div class="col-auto">
						<div class="form-item align-h">
							<label class="k-label k-form-label" for="chk_legal">ë²•ì •ê´€ë¦¬ì„¤ë¹„</label>
							<input id="chk_legal" name="isLegal">
						</div>
					</div>
				</div>
			</div>
		</form>
		<div class="content-ui-row connect">
			<div class="card-content grid">
				<div class="card-group-btn">
					<span class="info-text">
						<i class="material-symbols-outlined">list_alt</i>
						<label data-labelCd="PM ë§ˆìŠ¤í„°">PM ë§ˆìŠ¤í„°</label>
					</span>
					<span>
						<!-- ì˜¤ë¥¸ìª½ ë²„íŠ¼ ì˜ì—­-->
						<button id="btnMakeSchedule" class="btn-search">PMì¼ì •ìƒì„±</button>
						<button id="btnSearch" class="btn-search">ì¡°íšŒ</button>
						<button id="btnExcel">Excel</button>
					</span>
				</div>
				<div id="pm_master_grid"></div>
			</div>
		</div>
	</div>
</div>
<!-- PMì¼ì •ìƒì„± Kendo Window íŒì—… -->
<div id="makePmScheWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="col-auto">
		<form id="rangeDateForm">
			<div class="form-item align-h">
				<input type="hidden" name="sche_type" value="M" />
				<label class="k-label k-form-label">ìƒì„±ê¸°ê°„</label>
				<div id="makePmScheRange"></div>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-save" id="btnMakeScheduleModal">PMì¼ì •ìƒì„±</button>
		<button type="button" class="btn-close" id="btnCancelScheduleModal">ì·¨ì†Œ</button>
	</div>
</div>
{% verbatim %}
{% endverbatim %}
{% endblock %}

{% block scripts %}

{% include '../../popup/modalPmMaster.html'%}
{% include '../../popup/modalEquSel.html'%}
{% include '../../popup/modalPmCopy.html'%}
{% include '../../popup/modalOccupations.html'%}
{% include '../../popup/modalMatSel.html'%}

<script type="text/javascript">
	class PmMasterPage {
		constructor() {
			this.grid = null;
			this.upload = null;
			this.baseUrl = '/api/kmms/pm_master';

			this.comboDept = [];

			this.init();
		}

		/**
		 * ê·¸ë¦¬ë“œì™€ ê²€ìƒ‰ ì¡°ê±´ì„ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜
		 */
		resetData() {
			// ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
			if (this.grid) {
				this.grid.setData([]);
			}
			FormUtil.resetForm($("#searchForm"));
		}

		init() {
			let _this = this;
			let equipmentGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				selectable: "multiple, row",
				columns: [
					{ selectable: true, width: "50px" },
					{ field: 'pm_pk', title: 'PM PK', hidden: true },  // âœ… pm_pk ê°’ ìœ ì§€
					{ field: 'pm_no', title: 'PM ë²ˆí˜¸', width: 120 },
					{
						field: "pm_nm",
						title: "PMëª…",
						width: 150,
						template: '<a href="javascript:void(0);" class="grid-column-link" data-pm-pk="#=pm_pk#">#=pm_nm#</a>'
					},
					{ field: 'pm_type_nm', title: 'PM ìœ í˜•', width: 80 },
					{ field: 'equip_cd', title: 'ì„¤ë¹„ì½”ë“œ', width: 100 },
					{ field: 'equip_nm', title: 'ì„¤ë¹„ëª…', width: 150 },
					{ field: 'equip_cd', title: 'ì¹´í…Œê³ ë¦¬', width: 100 },
					{ field: 'equip_cd', title: 'í”„ë¡œì„¸ìŠ¤', width: 100 },
					{ field: 'equip_cd', title: 'ì‹œìŠ¤í…œ', width: 100 },
					{ field: 'dept_nm', title: 'ì‹¤í–‰ë¶€ì„œ', width: 100 },
					{ field: 'equip_cd', title: 'ìµœì¢… PM ìƒì„±ì¼', width: 100 },
					{ field: 'cycle_type_nm', title: 'ì£¼ê¸°', width: 50 }
				],

				dataBound: function (e) {
					$(".grid-column-link").off("click").on("click", async function (e) {
						try {
							e.preventDefault();
							let pmPk = $(this).data("pm-pk");
							let equipPk = $(this).data("equip-pk");
							if (pmPk) {
								setModalPosition('#modalPmMaster', { width: '70%', height: '70%' });
								pmMasterPage.show(pmPk);
							} else if (equipPk) {
								// ê¸°ì¡´ íŒì—…/ì¸ìŠ¤í„´ìŠ¤ ì™„ì „ ì œê±°
								$('#modalEquipMaster').remove();
								window.equipMasterPage = undefined;

								// íŒì—… append
								const response = await $.get('/api/kmms/equipment?action=load_modal');
								$('body').append(response);

								// ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° show
								window.equipMasterPage = new EquipMaster();
								window.equipMasterPage.show(equipPk);

							}
						} catch (error) {
							console.error('Error in click handler:', error);
							alert('ì„¤ë¹„ ë§ˆìŠ¤í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
						}
					});
				},
				height: "540px"
			};
			_this.grid = new Grid($("#pm_master_grid"), equipmentGridOption);

			$('#keyword').kendoTextBox();

			$("#makePmScheRange").kendoDateRangePicker({
				range: {
					start: new Date(),
					end: new Date(new Date().setMonth(new Date().getMonth() + 3))
				},
				format: "yyyy-MM-dd",
				labels: false,
				startField: "start_date",
				endField: "end_date"
			});

			AjaxUtil.fillDropDownTreeOptions($("#srch_location"), "cm_location", "select");
			AjaxUtil.fillDropDownTreeOptions($("#srch_dept"), "cm_depart", "select");
			AjaxUtil.fillDropDownTreeOptions($("#srch_pmDept"), "cm_depart", "select");
			AjaxUtil.fillDropDownOptions($('#serchPmType'), 'cm_base_code', 'choose', null, 'PM_TYPE');

			$("#srchApplyYn").kendoDropDownList({
				dataSource: [
					{ text: "ì „ì²´", value: "" },
					{ text: "ì ìš©", value: "Y" },
					{ text: "ë¯¸ì ìš©", value: "N" },
				],
				dataTextField: "text",
				dataValueField: "value"
			});

			$("#srchPeriodUnit").kendoDropDownList({
				dataSource: [
					{ text: "ì„ íƒ", value: "" },
					{ text: "ë…„", value: "Y" },
					{ text: "ì›”", value: "M" },
					{ text: "ì£¼", value: "W" },
					{ text: "ì¼", value: "D" },
				],
				dataTextField: "text",
				dataValueField: "value"
			});

			$('#btnExcel').kendoButton({
				icon: "file-excel",
				themeColor: "success",
				click: function () {
					page.exportExcel();
				}
			});

			$('#chk_my_task').kendoSwitch({
				checked: false
			});

			$('#chk_legal').kendoSwitch({
				checked: false
			});

			// PMì¼ì •ìƒì„± Kendo Window ì´ˆê¸°í™”
			$("#makePmScheWindow").kendoWindow({			
				title: "PMì¼ì •ìƒì„±",
				visible: false,
				modal: true,
				actions: [],
				appendTo: "body"
			});

			//search form
			$("#srch_date_range").kendoDateRangePicker({
				range: {
					start: new Date(),
					end: new Date(new Date().setMonth(new Date().getMonth() + 3))
				},
				change: function (e) {

				},
				format: "yyyy-MM-dd",
				labels: false,
				startField: "start_date",
				endField: "end_date"
			});

			$('#btnMakeSchedule').kendoButton({
				icon: "k-i-pencil",
				themeColor: "info",     // info í…Œë§ˆ ì‚¬ìš©
				fillMode: "outline",    // outline ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
				click: function (e) {
					e.preventDefault();					
					// pm_master_gridì—ì„œ ì„ íƒëœ rowê°€ ìˆëŠ”ì§€ í™•ì¸
					var grid = $("#pm_master_grid").data("kendoGrid");
					var selected = grid.select();
					if (selected.length === 0) {
						Alert.alert('', 'ì¼ì • ìƒì„±ì„ ìœ„í•œ PM ë§ˆìŠ¤í„°ë¥¼ ê·¸ë¦¬ë“œ ëª©ë¡ì—ì„œ ì„ íƒí•´ ì£¼ì„¸ìš”.');
						return;
					}

					// ì²´í¬ëœ rowê°€ ìˆì„ ë•Œ ì‹¤í–‰í•  ì½”ë“œ ì‘ì„± (ì—¬ê¸°ì— ì¼ì • ìƒì„± ë¡œì§ ì¶”ê°€)
					var wnd = $("#makePmScheWindow").data("kendoWindow");
					if (!wnd) {
						$("#makePmScheWindow").kendoWindow({
							width: "300px",
							title: "PMì¼ì •ìƒì„±",
							visible: false,
							modal: true,
							actions: [],
							appendTo: "body"
						});
						wnd = $("#makePmScheWindow").data("kendoWindow");
					}
					wnd.open().center();
				}
			}).css('visibility', 'visible');


			$('#btnMakeScheduleModal').kendoButton({
				icon: "k-i-pencil",
				themeColor: "info",     // info í…Œë§ˆ ì‚¬ìš©
				fillMode: "outline",    // outline ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
				click: (e) => {
					e.preventDefault();
					let pm_schedule_param = FormUtil.extractForm($("#rangeDateForm"));

					var grid = $("#pm_master_grid").data("kendoGrid");
					var selected = grid.select();
					var selectedData = [];
					selected.each(function() {
						var dataItem = grid.dataItem(this);
						selectedData.push(dataItem);
					});
					pm_schedule_param.pm_pks = selectedData.map(row => row.pm_pk).join(',');

					let fnSuccess = function (res) {
						Alert.alert('', 'PM ì¼ì •ì´ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
					};
					console.log('pm_schedule_param:', pm_schedule_param);
					AjaxUtil.postAsyncData('/api/kmms/pm_master' + '?action=executeMakeSchedulePm', pm_schedule_param, fnSuccess);

				}
			}).css('visibility', 'visible');

			$("#btnCancelScheduleModal").kendoButton({
				icon: "k-i-cancel",
				themeColor: "base",
				click: function () {
					$("#makePmScheWindow").data("kendoWindow").close();
				}
			});

			//form button
			$('#btnSearch').kendoButton({
				icon: "search",
				themeColor: "info",     // info í…Œë§ˆ ì‚¬ìš©
				fillMode: "outline",    // outline ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
				content: "ì¡°íšŒ",
				click: function () {
					_this.searchMainData();
				}
			}).css('visibility', 'visible');
		}

		searchMainData() {
			let pm_search_param = FormUtil.extractForm($("#searchForm"));
			pm_search_param.action = 'findAll';

			let result = AjaxUtil.getSyncData(this.baseUrl, pm_search_param);
			if (result) {
				this.grid.setData(result);
			}
		}

		// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
		exportExcel() {
			let gridData = $('#pm_master_grid').data("kendoGrid");
			gridData.bind("excelExport", function (e) {
				e.workbook.fileName = "pm_master.xlsx";
			});
			gridData.saveAsExcel();
		}

	};

	let page = new PmMasterPage();

	$(document).ready(function () {
		page.searchMainData();

		// âœ… ìµœì´ˆì—ëŠ” í•œ ì¤„ë§Œ í‘œì‹œ (CSSì—ì„œ height: 50px; ì ìš©)
		$("#searchFormContent").removeClass("search-expanded");

		// âœ… ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
		$(document).on("click", "#toggleSearchBtn", function () {
			let searchForm = $("#searchFormContent");

			if (searchForm.hasClass("search-expanded")) {
				searchForm.removeClass("search-expanded").animate({ height: "50px" }, 300);
				$("#toggleSearchBtn").removeClass("expanded");  // ğŸ”¹ expanded í´ë˜ìŠ¤ ì œê±°
			} else {
				searchForm.addClass("search-expanded").animate({ height: "auto" }, 300);
				$("#toggleSearchBtn").addClass("expanded");  // ğŸ”¹ expanded í´ë˜ìŠ¤ ì¶”ê°€
			}
		});

	});

</script>

{% endblock %}
