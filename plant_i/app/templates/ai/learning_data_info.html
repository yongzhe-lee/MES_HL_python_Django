{% extends "app/layout.html" %}
{% block css %}
{% endblock %}
{% block content %}
<div class="content-wrap">
    <div class="content-ui-row">
        <form class="search-form" id="searchForm" onsubmit="return false;">
            <div class="card-content search">
                <div class="form-ui">
                    <div class="col-12 col-md-4 col-xl-3">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="cboModelType" data-labelCd="모델유형">모델유형</label>
                            <div class="field-wrapper">
                                <select id="cboModelType" name="cboModelType"></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-xl-3">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="sch_keyword" data-labelCd="검색어">검색어</label>
                            <div class="field-wrapper">
                                <input id="sch_keyword" name="sch_keyword" />
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="card-group-btn search">
                            <button id="btnSearch" class="btn-search">조회</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="content-ui-row connect">
            <div class="card-content grid">
                <div class="card-group-btn">
                    <span class="info-text">
                        <i class="material-symbols-outlined">list_alt</i>
                        <label data-labelCd="모델 목록">모델 목록</label>
                    </span>
                    <span>
                        <!-- 오른쪽 버튼 영역-->
                        <button id="btnExcel">Excel</button>
                    </span>
                </div>
                <div id="model_grid"></div>
            </div>
        </div>
        <div class="content-ui-row connect">
            <div class="card-content edit">
                <div id="tabstrip">
                    <!-- ======================================= tab 리스트 ======================================= -->
                    <ul>
                        <li class="k-active">태그집합생성</li>    <!-- Tab1: 태그집합생성 (기존 작성 내용 그대로) -->
                        <li>데이터</li>
                        <li>변수통계값</li>
                        <li>수치형분포확인</li>
                        <li>범주형분포확인</li>
                        <li>전처리</li>
                        <li>상관관계히트맵</li>
                        <li>XY지정</li>
                        <li>산점도</li>
                        <li>상관관계값조회</li>
                        <li>주성분분석</li>
                        <li>모델생성</li>
                    </ul>
                    <!-- ======================================= 이하 tab 컨텐츠 ======================================= -->
                    <!-- Tab1: 태그집합생성 -->
                    <div class="tab-contents">
                        <!-- tab1 - tag form & grid -->
                        <div class="content-wrap">
                            <div class="col-12 col-md-6">
                                <div class="content-ui-row connect">
                                    <div class="card-group-btn">
                                        <span class="info-text">
                                            <i class="material-symbols-outlined">list_alt</i>
                                            <label data-labelCd="설비 태그">설비 태그</label>
                                        </span>
                                    </div>
                                    <form class="search-form" id="searchTagForm">
                                        <div class="card-content search">
                                            <div class="form-ui">
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" for="cboEquip" data-labelCd="설비">설비</label>
                                                        <div class="field-wrapper">
                                                            <select id="cboEquip" name="cboEquip"></select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" for="cboTagGroup" data-labelCd="태그그룹">태그그룹</label>
                                                        <div class="field-wrapper">
                                                            <select id="cboTagGroup" name="cboTagGroup"></select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" for="cboTag" data-labelCd="태그">태그</label>
                                                        <div class="field-wrapper">
                                                            <select id="cboTag" name="cboTag"></select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="card-group-btn search">
                                                        <button id="btnSearchTag" class="btn-search">조회</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                    <div id="tag_grid"></div>
                                </div>
                                <!-- tab1 - mes form & grid -->
                                <div class="content-ui-row connect">
                                    <div class="card-group-btn">
                                        <span class="info-text k-mt-5">
                                            <i class="material-symbols-outlined">list_alt</i>
                                            <label data-labelCd="MES 데이터">MES 데이터</label>
                                        </span>
                                    </div>
                                    <form class="search-form" id="searchMesForm">
                                        <div class="card-content search">
                                            <div class="form-ui">
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" for="cboLineMES" data-labelCd="라인">라인</label>
                                                        <div class="field-wrapper">
                                                            <select id="cboLineMES" name="cboLineMES"></select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" for="cboEquipMES" data-labelCd="설비">설비</label>
                                                        <div class="field-wrapper">
                                                            <select id="cboEquipMES" name="cboEquipMES"></select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" for="cboMtrlMES" data-labelCd="품목">품목</label>
                                                        <div class="field-wrapper">
                                                            <select id="cboMtrlMES" name="cboMtrlMES"></select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="card-group-btn search">
                                                        <button id="btnSearchMES" class="btn-search">조회</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                    <div id="mes_tag_grid"></div>
                                </div>
                                <!-- tab1 - qms form & grid -->
                                <div class="content-ui-row connect">
                                    <div class="card-group-btn">
                                        <span class="info-text k-mt-5">
                                            <i class="material-symbols-outlined">list_alt</i>
                                            <label data-labelCd="QMS 데이터">QMS 데이터</label>
                                        </span>
                                    </div>
                                    <form class="search-form" id="searchQmsForm">
                                        <div class="card-content search">
                                            <div class="form-ui">
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" for="cboLineQMS" data-labelCd="라인">라인</label>
                                                        <div class="field-wrapper">
                                                            <select id="cboLineQMS" name="cboLineQMS"></select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" for="cboEquipQMS" data-labelCd="설비">설비</label>
                                                        <div class="field-wrapper">
                                                            <select id="cboEquipQMS" name="cboEquipQMS"></select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" for="cboMtrlQMS" data-labelCd="품목">품목</label>
                                                        <div class="field-wrapper">
                                                            <select id="cboMtrlQMS" name="cboMtrlQMS"></select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="card-group-btn search">
                                                        <button id="btnSearchQMS" class="btn-search">조회</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                    <div id="qms_tag_grid"></div>
                                </div>
                            </div>
                            <!-- 그래프 영역 (Tab1의 오른쪽 영역) -->
                            <!--<div class="col-12 col-md-6 col-xl-4">
                                <div class="content-ui-column connect">
                                    <div id="chart"></div>
                                </div>
                            </div>-->
                            <!-- 최종 태그 집합 (Tab1의 오른쪽 영역) -->
                            <div class="col-12 col-md-6">
                                <div class="content-ui-column connect">
                                    <div class="card-group-btn">
                                        <span class="info-text">
                                            <i class="material-symbols-outlined">list_alt</i>
                                            <label data-labelCd="최종 태그 집합">최종 태그 집합</label>
                                        </span>
                                        <span>
                                            <button id="btnExcelMerged">Excel</button>
                                            <button id="btnSaveMerged" title="저장"><i class="material-symbols-outlined">save</i>저장</button>
                                            <!-- 삭제 기능 우선 보류. -->
                                            <button id="btnDeleteMerged" title="삭제"><i class="material-symbols-outlined">delete</i>삭제</button>
                                        </span>
                                    </div>
                                    <form class="search-form" id="searchMergedForm">
                                        <div class="card-content search">
                                            <div class="form-ui">
                                                <div class="col-auto">
                                                    <div class="form-item align-h">
                                                        <label class="k-label k-form-label" data-labelCd="기간"> 기간</label>
                                                        <div class="field-wrapper">
                                                            <div id="srchDt">
                                                                <div class="input-group-append">
                                                                    <input class="tac" type="text" id="srchStartDt" name="srchStartDt" />
                                                                    <span class="input-group-text fs-xl">
                                                                        <i class="fas fa-calendar-alt calendar_color"></i>
                                                                    </span>
                                                                    <input class="tac" type="text" id="srchEndDt" name="srchEndDt" />
                                                                    <span class="input-group-text fs-xl">
                                                                        <i class="fas fa-calendar-alt calendar_color"></i>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="card-group-btn search">
                                                        <button class="btn-search" id="btnSearchMerged">조회</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                    <div id="merged_tag_grid"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Tab2: 데이터 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="데이터 상세정보">데이터 상세정보</label>
                            </span>
                            <span>
                                <button id="btnNewData" title="csv등록">csv등록</button>
                                <button id="btnEditData" title="수정">수정</button>
                                <!-- 삭제 기능 우선 보류. -->
                                <!--<button id="btnEditData" title="삭제">삭제</button>-->
                            </span>
                        </div>
                        <div id="data_detail_grid"></div>
                    </div>

                    <!-- Tab3: 변수통계값 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="변수통계값">변수통계값</label>
                            </span>
                            <span>
                                <!--<button id="btnSearchCol" title="조회"><i class="material-symbols-outlined">search</i>조회</button>-->
                                <!--<button id="btnMakeColInfo" title="컬럼정보생성">컬럼정보생성</button>-->
                            </span>
                        </div>
                        <div id="ds_col_grid"></div>
                    </div>

                    <!-- Tab4: 수치형분포확인 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="수치형분포확인">수치형분포확인</label>
                            </span>
                            <span>
                                <button id="btnNumDistChart" title="조회"><i class="material-symbols-outlined">search</i>조회</button>
                            </span>
                        </div>
                        <div><img id="num_dist_chart" style="width:100%"/></div>
                    </div>

                    <!-- Tab5: 범주형분포확인 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="범주형분포확인">범주형분포확인</label>
                            </span>
                            <!--<span>
                                <button id="btnCatDistChart" title="조회"><i class="material-symbols-outlined">search</i>조회</button>
                            </span>-->
                        </div>
                            <div class="col-12 col-md-4">
                                <div class="form-item align-h">
                                    <label class="k-label k-form-label" for="cate_vari" data-labelCd="범주형변수">범주형변수</label>
                                    <div class="field-wrapper">
                                        <select id="cate_vari" name="cate_vari" multiple></select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <div class="card-group-btn search">
                                    <button class="btn-search" id="btnCatDistChart">조회</button>
                                </div>
                            </div>
                        <!--<select class="form-control2" id="cate_vari" multiple></select>-->
                        <div><img id="cat_dist_chart" style="width:100%" /></div>
                    </div>

                    <!-- Tab6: 전처리 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="전처리">전처리</label>
                            </span>
                            <span>
                                <!--<button id="btnSearchPreprocess" title="조회"><i class="material-symbols-outlined">search</i>조회</button>-->
                                <button id="btnSavePreprocess" title="결측치/이상치 제거"><i class="material-symbols-outlined">delete</i>결측치/이상치 제거</button>
                            </span>
                        </div>
                        <div id="ds_col_grid2"></div>
                    </div>

                    <!-- Tab7: 상관관계히트맵 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="상관관계히트맵">상관관계히트맵</label>
                            </span>
                            <span>
                                <button id="btnHeatmap" title="조회"><i class="material-symbols-outlined">search</i>조회</button>
                            </span>
                        </div>
                        <div id="heatmap_chart"></div>
                    </div>

                    <!-- Tab8: XY 지정 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="XY 지정">XY 지정</label>
                            </span>
                            <span>
                                <button id="btnSaveXY" title="저장"><i class="material-symbols-outlined">save</i>저장</button>
                            </span>
                        </div>
                        <div id="settingXy_grid"></div>
                    </div>

                    <!-- Tab9: 산점도 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="산점도">산점도</label>
                            </span>
                            <span>
                                <button id="btnScatterPlot" title="조회"><i class="material-symbols-outlined">search</i>조회</button>
                            </span>
                        </div>
                        <div id="scatter_chart"></div>
                    </div>

                    <!-- Tab10: 상관관계값조회 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="상관관계값조회">상관관계값조회</label>
                            </span>
                            <!--<span>
                                <button id="btnCorrValue" title="조회"><i class="material-symbols-outlined">search</i>조회</button>
                            </span>-->
                        </div>
                        <div id="corr_grid"></div>
                    </div>

                    <!-- Tab11: 주성분분석 (PCA와 동일) -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="주성분분석">주성분분석</label>
                            </span>
                            <span>
                                <button id="btnPCAChart" title="조회"><i class="material-symbols-outlined">search</i>조회</button>
                                <button id="btnPCAApply" title="적용">적용</button>
                            </span>
                        </div>
                        <div id="pca_chart">
                            <div id="pca_plotly" style="width:100%;"></div>
                            <div id="pca_result" style="width:100%;"></div>
                        </div>
                    </div>

                    <!-- Tab12: 모델생성 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="모델생성">모델생성</label>
                            </span>
                            <!-- 필요에 따라 추가 버튼을 배치하세요 -->
                        </div>
                        <div id="model_create_grid"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% verbatim %}
<script type="text/x-kendo-template" id="fileUploadTemplate">
    <div class="content_wrap popup">
        <div class="card-content edit">
            <form id="dsDataForm" class="search-form">
                <div class="form-ui">
                    <input type="hidden" id="id" name="id">
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label essential" for="Name" data-labelCd="모델명">모델명</label>
                            <div class="field-wrapper">
                                <input type="text" id="Name" name="Name" data-msg="모델명을" />
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="Type" data-labelCd="구분">구분</label>
                            <div class="field-wrapper">
                                <input type="text" id="Type" name="Type" />
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="Description" data-labelCd="비고">비고</label>
                            <div class="field-wrapper">
                                <textarea id="Description" name="Description"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!-- kendo 첨부파일 -->
            <div class="card-group-btn k-mt-5">
                <span class="info-text"><i class="material-symbols-outlined">attach_file</i><label data-labelCd="첨부된 데이터(csv)">첨부된 데이터(csv)</label></span>
            </div>
            <form id="fileForm">
                <div class="form-item align-v">
                    <div class="field-wrapper">
                        <div id="da_file_area" name="da_file_area"></div>
                    </div>
                </div>
            </form>
            <div class="card-group-btn" style="margin-top:10px">
                <span></span>
                <span>
                    <button id="btnSaveModalData"><i class="material-symbols-outlined">save</i>저장</button>
                    <button id="btnCloseModal" class="btn-cancel">닫기</button>
                </span>
            </div>
        </div>
    </div>
</script>
{% endverbatim %}
{% endblock %}

{% block scripts %}
{% include 'common/file_upload.html' %}
<script type="text/javascript">
    class DataSciencePage {
        constructor() {
            this.baseUrl = '/api/ai/learning_data';
            this.modelGrid = null;
            this.mm_id = null; // model master_id
            this.md_id = null; // model_id

            // FileUploadPage 인스턴스를 전역으로 선언
            window.fileUploaderInstance = null;

            // mission_proc_options를 선언 (옵션 배열)
            this.mission_proc_options = [
                { code: '', name: '-' },
                { code: 'drop', name: '제거' },
                { code: 'mean', name: '평균' },
                { code: 'median', name: '중간값' },
                { code: 'mode', name: '최빈값' }
            ];
            // mission_option_dc도 생성 (코드별 이름 매핑)
            this.mission_option_dc = {};
            this.mission_proc_options.forEach(item => {
                this.mission_option_dc[item.code] = item.name;
            });

            this.init();
        }

        init() {
            this.initUIComponents();
            this.initGrids();
            //this.searchMainData();
            this.initTabStrip();
        }

        initUIComponents() {
            let _this = this;

            // model search form
            AjaxUtil.fillDropDownOptions($('#cboModelType'), 'user_code', 'all', null, 'MODEL_TYPE')
            $('#sch_keyword').kendoTextBox({ placeholder: '모델명, 유형, 설명' });
            kendoUtil.bindEnterKey('#sch_keyword', () => this.searchMainData());

            kendoUtil.bindButton('#btnSearch', 'search', 'info', () => this.searchMainData());
            kendoUtil.bindButton('#btnExcel', 'file-excel', 'success', () => {
                kendoUtil.saveAsExcel(this.modelGrid, "모델 목록");
            });

            // tab1 form
            _this.setupDropdowns({
                lineId: null,
                equipId: 'cboEquip',
                tagGroupId: 'cboTagGroup',
                tagId: 'cboTag',
                mtrlId: null
            });
            _this.setupDropdowns({
                lineId: 'cboLineMES',
                equipId: 'cboEquipMES',
                tagGroupId: null,
                tagId: null,
                mtrlId: 'cboMtrlMES'
            });
            _this.setupDropdowns({
                lineId: 'cboLineQMS',
                equipId: 'cboEquipQMS',
                tagGroupId: null,
                tagId: null,
                mtrlId: 'cboMtrlQMS'
            });
            $("#srchStartDt").kendoDatePicker({
                format: "yyyy-MM-dd",
                value: new Date(new Date().setDate(new Date().getDate() - 7))
            }).closest(".k-datepicker").css("width", "140px");

            $("#srchEndDt").kendoDatePicker({
                format: "yyyy-MM-dd",
                value: new Date()
            }).closest(".k-datepicker").css("width", "140px");

            // tab1 button
            // 저장 버튼 설정
            kendoUtil.bindButton('#btnSaveMerged', null, 'info', () => {
                Alert.confirm('', '저장하시겠습니까?', () => {
                    this.saveData();
                });
            });
            // 삭제 버튼 설정
            kendoUtil.bindButton('#btnDeleteMerged', null, 'error', () => {
                Alert.confirm('', '삭제하시겠습니까?', () => {
                    this.deleteData();
                });
            });
            // 엑셀 버튼 설정
            kendoUtil.bindButton('#btnExcelMerged', 'file-excel', 'success', () => {
                kendoUtil.saveAsExcel(this.grid, "태그집합");
            });

            // 조회
            // 설비 태그 폼의 조회 버튼 바인딩
            _this.bindSearchButton("#btnSearchTag", "#searchTagForm", "#tag_grid", "read");
            // MES 데이터 폼의 조회 버튼 바인딩
            _this.bindSearchButton("#btnSearchMES", "#searchMesForm", "#mes_tag_grid", "read");
            // QMS 데이터 폼의 조회 버튼 바인딩
            _this.bindSearchButton("#btnSearchQMS", "#searchQmsForm", "#qms_tag_grid", "read");
            // 최종 태그 집합 조회 버튼이 있다면
            _this.bindSearchButton("#btnSearchMerged", "#searchMergedForm", "#merged_tag_grid", "read");


            // tab2
            // csv기반 모델 등록
            kendoUtil.bindButton('#btnNewData', 'file-excel', 'success', () => {

                if (_this.mm_id) {
                    if (_this.md_id) {
                        Alert.confirm("info",
                            "이미 등록된 파일이 존재합니다. 수정하시겠습니까?",
                            function () {
                                let data = _this.getDsInfo();
                                _this.openDataUploadPopup(data);
                            },
                            function () { }
                        );
                    } else {
                        // csv 데이터 업로드 = 모델 생성으로 고정
                        _this.openDataUploadPopup();
                    }
                } else {
                    Alert.alert('info', '목록에서 데이터를 업로드 할 모델마스터를 선택해 주세요.');
                }
            });

            // 모델 수정
            kendoUtil.bindButton('#btnEditData', null, 'info', () => {
                //if (this.mm_id) {
                if (_this.md_id) {
                    let data = _this.getDsInfo();
                    _this.openDataUploadPopup(data);
                } else {
                    Alert.alert('error', '목록에서 데이터를 수정할 모델을 선택해 주세요.');
                }
            });

            //tab6
            kendoUtil.bindButton('#btnSavePreprocess', null, 'error', () => {
                Alert.confirm('', '결측치 및 이상치를 제거하시겠습니까?', () => {
                    _this.saveDsCol();
                });
            });

            //tab8
            //$('#y_all_check').on('click', function () {
            //    let checked = $(this).prop('checked');
            //    $('input[name="chkbx_y"]').prop('checked', checked);
            //})

            kendoUtil.bindButton('#btnSaveXY', null, 'success', () => {
                Alert.confirm('', '지정한 X, Y변수를 저장하시겠습니까??', () => {
                    _this.saveDsColXY();
                });
            });

            // 범주형 분석
            $('#btnCatDistChart').kendoButton({
                icon: "search",
                themeColor: "base",
                click: function () {
                    _this.fillCategoryVars();
                }
            });

            // 여기부터
            $('#cate_vari').kendoDropDownList({
                dataSource: [],
                dataTextField: "text",
                dataValueField: "value",
                optionLabel: "선택하세요",
                change: function (e) {
                    let selected = this.dataItem();
                    if (selected) {
                        _this.getCatDistChart(selected.code);
                    }
                }
            });
        }


        // 드롭다운 선택 사항에 따른 이벤트 핸들링
        setupDropdowns(config) {
            const { lineId, equipId, tagGroupId, tagId, mtrlId } = config;

            let line = lineId ? $(`#${lineId}`) : null;
            let equip = $(`#${equipId}`);
            let tagGroup = tagGroupId ? $(`#${tagGroupId}`) : null;
            let tag = tagId ? $(`#${tagId}`) : null;
            let mtrl = mtrlId ? $(`#${mtrlId}`) : null;

            // 드롭다운 초기화
            if (line) AjaxUtil.fillDropDownOptions(line, 'line', 'all', null);
            AjaxUtil.fillDropDownOptions(equip, 'equipment', 'all', null);
            if (tagGroup) AjaxUtil.fillDropDownOptions(tagGroup, 'tag_group', 'all', null);
            if (tag) AjaxUtil.fillDropDownOptions(tag, 'tag', 'all', null);
            if (mtrl) AjaxUtil.fillDropDownOptions(mtrl, 'material', 'all', null);

            // 이벤트 핸들러
            if (line) {
                line.change(function () {
                    AjaxUtil.fillDropDownOptions(equip, 'equipment', 'all', null, null, null, line.val());
                });
            }

            equip.change(function () {
                if (tag) {
                    AjaxUtil.fillDropDownOptions(tag, 'tag', 'all', null, equip.val(), tagGroup ? tagGroup.val() : null);
                }
            });

            if (tagGroup) {
                tagGroup.change(function () {
                    AjaxUtil.fillDropDownOptions(tag, 'tag', 'all', null, equip.val() ? equip.val() : null, tagGroup.val());
                });
            }
        }

        bindSearchButton(buttonId, formId, gridId, action) {
            $(buttonId).kendoButton({
                icon: "search",
                click: function (e) {
                    e.preventDefault();
                    // 폼 데이터를 직렬화
                    var params = $(formId).serialize();
                    // 기본 URL + 액션 및 쿼리 파라미터 구성
                    var url = page.baseUrl + "?action=" + action + "&" + params;
                    // 그리드 데이터 소스 업데이트 후 읽기
                    var grid = $(gridId).data("kendoGrid");
                    if (grid) {
                        grid.dataSource.transport.options.read.url = url;
                        grid.dataSource.read();
                    }
                }
            });
        }

        initGrids() {
            // 모델 목록 그리드 초기화
            this.modelGrid = new TreeGrid($('#model_grid'), this.getGridOptions('model_grid'));
            this.searchMainData();
        }

        getGridOptions(gridName) {
            let _this = this;
            let defaultOption = {
                pageable: false,
                columns: [],
                height: "300px"
            };

            // gridName에 따른 특정 옵션 (columns 설정)
            let specificOption;

            // data가 없을 때 그리드에 뜨는 메시지
            let noDataMessage = "태그를 조합하거나 CSV 파일을 업로드하여 AI 모델을 생성하세요. 데이터가 등록되면 기본 모델이 생성되며, 이후 과정에 따라 알고리즘과 모델 정보가 자동으로 업데이트됩니다.";
            let noDataTemplate = `<div style='position: absolute; top: 0; left: 0; width: 100%; padding:10px; text-align:left;'> ${noDataMessage} </div>`;
            const getNoDataTemplate = () =>
                `<div style='position: absolute; top: 0; left: 0; width: 100%; padding:10px; text-align:left;'> ${noDataMessage} </div>`;

            switch (gridName) {

                case 'model_grid':
                    specificOption = {
                        pageable: false,
                        columnMenu: {
                            componentType: "classic",
                            autoSize: true,
                            clearAllFilters: true,
                            columns: { sort: "asc" }
                        },
                        columns: [
                            // number 쓰면 tree구조 고장남
                            //{ title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'id', hidden: true },
                            { field: 'name', title: '모델명', width: 120 },
                            { field: 'type', title: '유형', width: 50 },
                            { field: 'ver', title: 'Ver', width: 50 },
                            { field: 'description', title: '설명', width: 150 },
                            //{ field: 'cycle', title: '모델생성주기', width: 100 },
                            { field: 'var_count', title: '변수개수', width: 60 },
                            { field: 'file_name', title: '원본파일명', width: 150 },
                            { field: 'algorithm_type', title: 'ML(알고리즘)', width: 100 },
                            //{ field: '_created', title: '등록일', width: 100 }
                        ],
                        change: function (e) {
                            let activeTab = $("#tabstrip").data("kendoTabStrip").select().index();
                            // 첫번째 tab일 때, showAlert을 false로 전달하여 모델 미선택 알럿창 방지
                            if (activeTab === 0) {
                                _this.loadGridByTab(activeTab, false);
                            } else {
                                _this.loadGridByTab(activeTab);
                            }
                            //if (_this.getSelectedModel(activeTab, activeTab === 0 ? false : true)) {
                            //    // 선택된 모델의 데이터를 현재 열려있는 탭 것만 갱신
                            //    _this.loadGridByTab(activeTab); 
                            //}
                        },
                        height: "300px"
                    };
                    break;

                case 'tag_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'equipment_name', title: '설비명', width: 125 },
                            { field: 'tag_group_name', title: '태그그룹명', width: 125 },
                            { field: 'tag_name', title: '태그명', width: 200 }
                        ],
                        height: "200px"
                    };
                    break;

                case 'mes_tag_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'line', title: '라인', width: 100 },
                            { field: 'equipment_name', title: '설비명', width: 150 },
                            { field: 'PNL', title: '부적합기준', width: 100 },
                            { field: 'P/N', title: '합부결과', width: 100 },
                        ],
                        height: "200px"
                    };
                    break;

                case 'qms_tag_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'line', title: '라인', width: 100 },
                            { field: 'equipment_name', title: '설비명', width: 150 },
                            { field: 'material', title: '품목', width: 100 },
                            { field: 'P/N', title: '합부결과', width: 100 },
                        ],
                        height: "200px"
                    };
                    break;

                case 'merged_tag_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'line', title: '라인', width: 100 },
                            { field: 'equipment_name', title: '설비명', width: 150 },
                            { field: 'material', title: '품목', width: 100 },
                            { field: 'P/N', title: '합부결과', width: 100 },
                        ],
                        height: "1000px"
                    };
                    break;

                case 'data_detail_grid':
                    specificOption = {
                        //pageable: false,
                        pageable: {
                            refresh: true,  // 새로고침 버튼 추가
                            pageSizes: [10, 20, 50, 100, "all"],  // 선택 가능한 페이지 크기
                            buttonCount: 5  // 페이지네이션 버튼 개수
                        },
                        dataSource: new kendo.data.DataSource({
                            pageSize: 50,  // 기본 페이지 크기
                            serverPaging: false,  // 서버 페이징 비활성화 (클라이언트 페이징만 사용)
                            data: []  // 초기 데이터 비워두기
                        }),
                        columns: [
                            // file에 따라 달라지므로 동적으로 생성
                        ],
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        }
                    };
                    break;

                case 'ds_col_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'VarName', title: '변수명', width: 150 },
                            { field: 'DataCount', title: '데이터개수', width: 100 },
                            { field: 'MissingCount', title: '결측치개수', width: 100 },
                            { field: 'CategoryCount', title: '범주개수', width: 100 },
                            { field: 'Mean', title: '평균', width: 100 },
                            { field: 'Std', title: '표준편차', width: 100 },
                            { field: 'Q1', title: 'Q1', width: 100 },
                            { field: 'Q2', title: 'Q2', width: 100 },
                            { field: 'Q3', title: 'Q3', width: 100 }
                        ],
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        }
                    };
                    break;

                case 'ds_col_grid2':
                    specificOption = {
                        pageable: false,
                        editable: true,  // 편집 가능하도록 설정(콤보박스용)
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'VarName', title: '변수명', width: 150, editable: () => false },
                            {
                                field: "MissingValProcess",
                                title: "결측치 처리방법",
                                width: 120,
                                attributes: { style: "text-align: center" },
                                template: function (dataItem) {
                                    let selectedOption = _this.mission_proc_options.find(opt => opt.code == dataItem.MissingValProcess);
                                    return `<select name="MissingValProcess" class="k-picker k-dropdownlist k-picker-solid k-picker-md k-rounded-md k-valid">
                                                <option selected value="${selectedOption ? selectedOption.code : ''}">${selectedOption? selectedOption.name : "선택"}</option>
                                            </select>`;
                                },
                                // 임의로 editor 형식으로 변환되는 것 방지
                                editable: () => false
                                //editor: function (container, options) {
                                //    $('<select name="' + options.field + '"></select>')
                                //        .appendTo(container)
                                //        .kendoDropDownList({
                                //            text: "선택",
                                //            dataSource: _this.mission_proc_options,
                                //            dataTextField: "name",
                                //            dataValueField: "code",
                                //            value: options.model.MissingValProcess,
                                //            optionLabel: {
                                //                name: "선택",
                                //                code: ""
                                //            },
                                //            change: function (e) {
                                //                options.model.set("MissingValProcess", e.sender.value());
                                //            }
                                //        });
                                //}
                            },
                            {
                                field: "DropOutLow",
                                title: "이상치하한",
                                width: 100,
                                attributes: { style: "text-align: center" },
                                template: function (dataItem) {
                                    let value = dataItem.DropOutLow ?? "";
                                    let displayValue = value == null ? "입력" : value; // ✅ 값이 없으면 "입력" 표시
                                    return `<input name="DropOutLow" class="k-input k-textbox k-input-solid k-input-md k-rounded-md" 
                                              value="${displayValue}" placeholder="입력" />`;
                                },
                                editor: function (container, options) {
                                    $('<input name="DropOutLow"/>')
                                        .appendTo(container)
                                        .kendoTextBox({
                                            value: options.model.DropOutLow ?? null, // ✅ 값이 없으면 placeholder로 "입력" 표시
                                            placeholder: "입력",
                                            change: function (e) {
                                                let newValue = e.sender.value().trim();
                                                options.model.set("DropOutLow", newValue === "" ? null : newValue); // ✅ 빈 값이면 null 처리
                                            },
                                        //    width: "100%"
                                        });
                                }
                                //template: function (dataItem) {
                                //    return dataItem.DropOutLow !== null && dataItem.DropOutLow !== undefined ? dataItem.DropOutLow : "입력";
                                //},
                                //editor: function (container, options) {
                                //    $('<input name="' + options.field + '"/>')
                                //        .appendTo(container)
                                //        .kendoNumericTextBox({
                                //            format: "n2",
                                //            decimals: 2,
                                //            step: 0.01,
                                //            value: options.model[options.field] || null,
                                //            change: function (e) {
                                //                let newValue = e.sender.value();
                                //                options.model.set(options.field, newValue); // 🚀 값 바로 반영 (검증 없음)
                                //            }
                                //        });
                                //}
                            },
                            {
                                field: "DropOutUpper",
                                title: "이상치상한",
                                width: 100,
                                attributes: { style: "text-align: center" },
                                //template: function (dataItem) {
                                //    return dataItem.DropOutUpper !== null && dataItem.DropOutUpper !== undefined ? dataItem.DropOutUpper : "입력";
                                //},
                                //editor: function (container, options) {
                                //    $('<input name="' + options.field + '"/>')
                                //        .appendTo(container)
                                //        .kendoNumericTextBox({
                                //            format: "n2",
                                //            decimals: 2,
                                //            step: 0.01,
                                //            value: options.model[options.field] || null,
                                //            change: function (e) {
                                //                let newValue = e.sender.value();
                                //                options.model.set(options.field, newValue); // 🚀 값 바로 반영 (검증 없음)
                                //            }
                                //        });
                                //}
                                template: function (dataItem) {
                                    let value = dataItem.DropOutUpper ?? "";
                                    let displayValue = value == null ? "입력" : value; // ✅ 값이 없으면 "입력" 표시
                                    return `<input name="DropOutUpper" class="k-input k-textbox k-input-solid k-input-md k-rounded-md" 
                                            value="${displayValue}" placeholder="입력" />`;
                                },
                                editor: function (container, options) {
                                    $('<input name="DropOutUpper"/>')
                                        .appendTo(container)
                                        .kendoTextBox({
                                            value: options.model.DropOutUpper ?? null, // ✅ 값이 없으면 placeholder로 "입력" 표시
                                            placeholder: "입력",
                                            change: function (e) {
                                                let newValue = e.sender.value().trim();
                                                options.model.set("DropOutUpper", newValue === "" ? null : newValue); // ✅ 빈 값이면 null 처리
                                            },
                                        //    width: "100%"
                                        });
                                }
                            },
                            { field: 'DataCount', title: '데이터수', width: 80, editable: () => false },
                            { field: 'MissingCount', title: '결측치수', width: 80, editable: () => false },
                            { field: 'CategoryCount', title: '범주개수', width: 80, editable: () => false },
                            { field: 'Mean', title: '평균', width: 80, editable: () => false },
                            { field: 'Std', title: '표준편차', width: 80, editable: () => false },
                            { field: 'Q1', title: 'Q1', width: 80, editable: () => false },
                            { field: 'Q2', title: 'Q2', width: 80, editable: () => false },
                            { field: 'Q3', title: 'Q3', width: 80, editable: () => false },

                        ],
                        dataBound: function (e) {
                            let grid = this;

                            // ✅ DropDownList 바인딩 (MissingValProcess)
                            grid.tbody.find("select[name='MissingValProcess']").each(function () {
                                let select = $(this);
                                let row = select.closest("tr");
                                let dataItem = grid.dataItem(row);

                                select.kendoDropDownList({
                                    dataSource: _this.mission_proc_options, // ✅ "-" 옵션 그대로 유지
                                    dataTextField: "name",
                                    dataValueField: "code",
                                    value: dataItem.MissingValProcess || "", // ✅ 빈 값이면 "-"가 표시됨
                                    optionLabel: "선택", // ✅ "선택"이 표시되지만 "-"도 그대로 유지
                                    change: function (e) {
                                        dataItem.set("MissingValProcess", e.sender.value());
                                    }
                                });
                            });

                            //// TextBox 바인딩 (DropOutLow)
                            //grid.tbody.find("input[name='DropOutLow']").each(function () {
                            //    let input = $(this);
                            //    let row = input.closest("tr");
                            //    let dataItem = grid.dataItem(row);

                            //    input.kendoTextBox({
                            //        format: "n8",
                            //        decimals: 8,
                            //        value: dataItem.DropOutLow ?? null, // ✅ 값이 없으면 placeholder로 "입력" 표시
                            //        placeholder: "입력", // ✅ placeholder 추가
                            //        change: function (e) {
                            //            let newValue = e.sender.value().trim();
                            //            dataItem.set("DropOutLow", newValue == "" ? null : newValue); // ✅ 빈 값이면 "입력" 표시
                            //        },
                            //        width: "100%"
                            //    });
                            //});

                            //// TextBox 바인딩 (DropOutUpper)
                            //grid.tbody.find("input[name='DropOutUpper']").each(function () {
                            //    let input = $(this);
                            //    let row = input.closest("tr");
                            //    let dataItem = grid.dataItem(row);

                            //    input.kendoTextBox({
                            //        format: "n8",
                            //        decimals: 8,
                            //        value: dataItem.DropOutUpper ?? null, // ✅ 값이 없으면 placeholder로 "입력" 표시
                            //        placeholder: "입력", // ✅ placeholder 추가
                            //        change: function (e) {
                            //            let newValue = e.sender.value().trim();
                            //            dataItem.set("DropOutUpper", newValue == "" ? null : newValue); // ✅ 빈 값이면 "입력" 표시
                            //        },
                            //        width: "100%"
                            //    });
                            //});

                            // 그리드 행 번호 자동 업데이트
                            let items = grid.items();
                            items.each(function (index) {
                                $(this).find("td:first").html(index + 1);
                            });

                            kendoUtil.showGridRowCount(this.element);
                        },
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        }
                    };
                    break;

                case 'settingXy_grid':
                    specificOption = {
                        pageable: false,
                        sortable: false,    // 해당 기능 true 되면 check 선택 이벤트보다 sort 이벤트가 실행됨
                        filterable: false,
                        editable: false,  // 어차피 dom으로 직접 조작해서 value 주기 때문에 false로
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' }},
                            { field: 'VarName', title: '변수명', width: 150 },
                            {
                                field: 'X',
                                width: 80,
                                headerTemplate: '<input type="checkbox" class="chkbx k-checkbox k-checkbox-md k-rounded-md" id="x_all_check"/>X변수',
                                attributes: { style: "text-align: center" },
                                template: function (item) {
                                    return '<input name="chkbx_x" type="checkbox"' + (item.X == 1 ? 'checked="checked"' : '') + 'class="chkbx k-checkbox k-checkbox-md k-rounded-md" />';
                                },
                            },
                            {
                                field: 'Y',
                                width: 80,
                                attributes: { style: "text-align: center" },
                                title: 'Y변수',
                                template: function (item) {
                                    return '<input name="chkbx_y" type="checkbox"' + (item.Y == 1 ? 'checked="checked"' : '') + 'class="chkbx k-checkbox k-checkbox-md k-rounded-md" />';
                                },
                            },
                            { field: 'DataCount', title: '데이터개수', width: 100 },
                            { field: 'MissingCount', title: '결측치개수', width: 100 },
                            { field: 'CategoryCount', title: '범주개수', width: 80 },
                            { field: 'Mean', title: '평균', width: 80 },
                            { field: 'Std', title: '표준편차', width: 80 },
                            { field: 'Q1', title: 'Q1', width: 80 },
                            { field: 'Q2', title: 'Q2', width: 80 },
                            { field: 'Q3', title: 'Q3', width: 80 },
                            { field: "MissingValProcess", title: "결측치 처리방법", width: 120 },
                            { field: "DropOutLow", title: "이상치하한", width: 100 },
                            { field: "DropOutUpper", title: "이상치상한", width: 100 }
                        ],
                        dataBound: function (e) {
                            let grid = this;
                            let items = grid.items();

                            // ✅ 개별 X 체크박스 클릭 시 데이터 반영
                            grid.element.find("input[name='chkbx_x']").on("change", function () {
                                let row = $(this).closest("tr");
                                let dataItem = grid.dataItem(row);
                                dataItem.set("X", this.checked ? 1 : 0);
                            });

                            // ✅ 개별 Y 체크박스 클릭 시 데이터 반영 (Y는 하나만 선택 가능)
                            grid.element.find("input[name='chkbx_y']").on("change", function () {
                                let row = $(this).closest("tr");
                                let dataItem = grid.dataItem(row);

                                console.log("1", grid.element.find("input[name='chkbx_y']:checked"));
                                if (this.checked) {
                                    console.log("2", grid.element.find("input[name='chkbx_y']:checked"));

                                    // ✅ Y가 이미 선택된 상태인지 확인 (본인이 체크되기 전 기준)
                                    // ✅ 현재 체크된 상태에서 Y가 이미 선택된 항목이 있는지 확인
                                    let existingChecked = grid.element.find("input[name='chkbx_y']:checked").not(this);

                                    if (existingChecked.length > 0) {
                                        console.log("3", grid.element.find("input[name='chkbx_y']:checked"));

                                        Alert.alert("error", "Y변수는 하나만 선택할 수 있습니다.");
                                        $(this).prop("checked", false);  // 방금 체크한 거 해제
                                        return;
                                    }
                                    console.log("4", grid.element.find("input[name='chkbx_y']:checked"));
                                    // ✅ 기존 Y 해제 후 현재 선택 반영
                                    grid.dataSource.data().forEach(item => item.set("Y", 0));
                                    dataItem.set("Y", 1);
                                } else {
                                    // ✅ 체크 해제된 경우 데이터 반영
                                    dataItem.set("Y", 0);
                                }
                                console.log("5", grid.element.find("input[name='chkbx_y']:checked"));

                            });

                            // X 전체 선택 버튼 이벤트 (Y는 단일 선택이라 없음)
                            $("#x_all_check").on("click", function () {
                                let checked = $(this).prop("checked");
                                // data 업데이트
                                console.log("checked1", checked);
                                grid.dataSource.data().forEach(item => item.set("X", checked ? 1 : 0));
                                // UI 업데이트 (체크박스 상태)
                                console.log("checked2", checked);
                                $('input[name="chkbx_x"]').prop("checked", checked);
                                console.log("checked3", checked);
                            });

                            // 행 번호 추가
                            items.each(function (index) {
                                $(this).find("td:first").html(index + 1);
                            });

                            // 그리드 row 개수 표시
                            kendoUtil.showGridRowCount(this.element);
                        },
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        },
                    };
                    break;

                case 'corr_grid':
                    noDataMessage += "<br>상관관계값의 경우 X,Y변수가 지정되어야 연산이 가능하므로, XY지정 탭에서 X변수와 Y변수를 지정해주세요.";
                    specificOption = {
                        pageable: false,
                        columns: [
                            //{ title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'YVarName', title: 'Y변수', width: 80 },
                            { field: 'data_type', title: '구분', width: 80 },
                            { field: 'intercept_', title: '절편', width: 80 }
                        ],
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        }
                    };
                    console.log("noDataTemplate", noDataTemplate);
                    console.log("noDataMessage", noDataMessage);
                    break;
                // 필요시 다른 탭(그리드) 옵션 추가 가능
                default:
                    specificOption = defaultOption;
            }

            // 기본 옵션과 특정 옵션을 병합하여 반환 (두 객체의 속성을 합칩니다)
            //return Object.assign({}, defaultOption, specificOption);

            let gridOptions = specificOption;

            if (!gridOptions.dataBound) {
                // dataBound를 따로 설정하지 않은 그리드는 공통사항을 할당
                gridOptions.dataBound = function (e) {
                    let items = this.items();
                    items.each(function (index) {
                        $(this).find("td:first").html(index + 1);
                    });

                    kendoUtil.showGridRowCount(this.element);
                };
            }

            //if (!gridOptions.change) {
            //    // change를 따로 설정하지 않은 그리드는 공통사항을 할당
            //    gridOptions.change = function (e) {
            //        this.refresh();
            //    };
            //}

            console.log("gridOptions", gridOptions);

            return gridOptions;
        }

        initTabStrip() {
            let _this = this;
            $("#tabstrip").kendoTabStrip({
                animation: { open: { effects: "fadeIn" } },
                activate: function (e) {
                    let activeTabIndex = $(e.item).index();
                    _this.loadGridByTab(activeTabIndex);
                }
            });
            // 초기 로드시 기본 탭(Tab1, 인덱스 0)의 그리드를 명시적으로 로드
            _this.loadGridByTab(0);
        }

        loadGridByTab(tabIndex) {
            // 탭 인덱스에 따라 해당 탭의 컨테이너를 초기화 또는 갱신
            switch (tabIndex) {
                case 0:
                    // 페이지 최초 로드 시에 모델 선택 alert 방지
                    if (this.getSelectedModel(tabIndex, false)) {
                        this.renderGrid("tag_grid", "tag");
                        this.renderGrid("mes_tag_grid", "mes");
                        this.renderGrid("qms_tag_grid", "qms");
                        this.renderGrid("merged_tag_grid", "merged_tag");
                    }
                    break;
                case 1:
                    this.renderGrid("data_detail_grid", "ds_rows_list");
                    break;
                case 2:
                    this.renderGrid("ds_col_grid", "ds_col_list");
                    break;
                case 3:
                    this.loadChartImage("num_dist_chart", "ds_numcol_boxhist");
                    //$("#num_dist_chart").data("kendoChart") && $("#num_dist_chart").data("kendoChart").refresh();
                    break;
                case 4:
                    $("#cat_dist_chart").data("kendoChart") && $("#cat_dist_chart").data("kendoChart").refresh();
                    break;
                case 5:
                    this.renderGrid("ds_col_grid2", "ds_col_list");
                    break;
                case 6:
                    $("#heatmap_chart").data("kendoChart") && $("#heatmap_chart").data("kendoChart").refresh();
                    break;
                case 7:
                    this.renderGrid("settingXy_grid", "ds_col_list");
                    break;
                case 8:
                    $("#scatter_chart").data("kendoChart") && $("#scatter_chart").data("kendoChart").refresh();
                    break;
                case 9:
                    this.renderGrid("corr_grid", "ds_var_corr_sheet");
                    break;
                case 10:
                    // Tab11: 주성분분석은 Plotly 차트 및 결과 영역(pca_plotly, pca_result)을 별도로 처리
                    break;
                case 11:
                    this.renderGrid("model_create_grid");
                    break;
                default:
                    console.log("해당 탭에 그리드 없음");
            }
        }

        getSelectedModel(tabIndex, showAlert = true) {
            let _this = this;
            let data = _this.modelGrid.getSelect();

            if (!data || data.length === 0) {
                if (showAlert && tabIndex !== 0) {
                    Alert.alert('info', '상단 목록에서 데이터를 조회할 모델을 선택해 주세요.');
                }
                return null;
            }

            let selectData = data[0];
            _this.mm_id = selectData.master_id;
            _this.md_id = selectData.model_id;

            console.log("선택된 모델:", selectData);

            return selectData;
        }


        renderGrid(gridId, action) {
            let _this = this; // 현재 클래스 인스턴스 참조

            let selectModel = _this.getSelectedModel();
            if (!selectModel) return;

            let grid = $("#" + gridId).data("kendoGrid");

            let options = this.getGridOptions(gridId);

            // 그리드 인스턴스가 이미 존재하면 refresh, 없으면 생성
            if (grid) {
                // 이전에 조회했던 모델에 데이터가 없었던 경우 columns이 빈 배열로 초기화된 상태
                // 본래 컬럼 설정을 다시 찾아갈 수 있도록.
                grid.options.columns = options.columns;

            } else {
                new Grid($("#" + gridId), options);
            }

            // API 호출: action 값이 전달되면 공통 업데이트 함수 호출
            if (action) {
                _this.updateGridData(gridId, action, { md_id: _this.md_id });
            }
        }

        updateGridData(gridId, action, extraParam) {
            let _this = this;
            let param = Object.assign({ action: action }, extraParam || {});

            let gridInstance = $("#" + gridId).data("kendoGrid");
            // tab 용도별로 고정으로 생성되어야 하는 컬럼
            let baseColumns = gridInstance.options.columns;

            let succFunc = function (result) {
                console.log("result", result);
                // xrows(컬럼)를 백엔드에서 보내주는 경우(데이터마다 colunmn이 달라지는 경우)
                if (result.xrows) {
                    if (result.xrows.length > 0) {
                        var dynamicColumns = result.xrows.map(function (item, index) {
                            return {
                                field: 'col_' + (index + 1),          // x + 변수순서
                                //field: item.VarName,        // 필드 이름 (백엔드에서 보내는 컬럼명)
                                title: item.VarName,          // 제목 (화면에 표시될 텍스트)
                                width: item.width || 100,     // 백엔드에서 제공된 width가 없으면 기본값 100px 사용
                            };
                        });

                        if (baseColumns) {
                            console.log("baseColumns", baseColumns);
                            dynamicColumns = [...baseColumns, ...dynamicColumns];
                        }

                        // No. 이유는 알 수 없지만 첫번째 컬럼의 값이 row의 index로 바인딩되는 에러 발생(id 아님!)
                        // 이참에 그냥 index컬럼을 만들어버림
                        // "No" 컬럼이 없는 경우에만 추가
                        if (!dynamicColumns.some(col => col.title === "No")) {
                            dynamicColumns.unshift({ "title": "No", "width": 50 });
                        }

                        console.log("dynamicColumns", dynamicColumns);

                        gridInstance.setOptions({ columns: dynamicColumns });
                        gridInstance.dataSource.data(result.rows);
                        //console.log("gridInstance.dataSource.data", gridInstance.dataSource.data());
                    } else {
                        // xrows는 있지만 빈 배열 일 때. 컬럼&데이터 초기화하여 noDataMessage 표시
                        let pageSize = gridInstance.dataSource.options.pageSize;

                        gridInstance.setOptions({
                            columns: [],
                            dataSource: {
                                // pageSize 설정이 덮어씌워져서 all로 바뀌는 것 방지
                                pageSize: pageSize ? pageSize : null,
                                page: pageSize ? 1 : null, // 첫 페이지로 이동
                                data: []
                            }
                        });
                    }
                } else {
                    // 일반적인 grid 데이터일 때
                    gridInstance.dataSource.data(result);
                }

                gridInstance.autoFitColumns();
            }

            AjaxUtil.getAsyncData(_this.baseUrl, param, succFunc);
        }

        loadChartImage(chartId, action) {
            let _this = this;

            let selectModel = _this.getSelectedModel();
            if (!selectModel) return;

            let param = {
                action: action,
                md_id: _this.md_id
            };
            console.log("param", param);

            try {
                let result = AjaxUtil.getSyncData(_this.baseUrl, param); // 동기 요청 후 결과 반환
                console.log("result", result);

                if (result && result.success) {
                    $('#' + chartId).attr('src', result.chart_url);
                } else {
                    console.error("이미지 로드 실패: 응답 성공 여부 확인 필요", result);
                }
            } catch (error) {
                console.error("이미지 로드 중 오류 발생:", error.message);
            }
        }

        // csv file 업로드 popup
        openDataUploadPopup(data) {
            let _this = this;
            let templateHtml = $('#fileUploadTemplate').html();
            let $popup = $(templateHtml);
            // 브라우저 너비의 50%를 팝업 너비로 설정
            let windowWidth = window.innerWidth * 0.5;
            let title = 'csv data 기반 모델 생성';

            let $form = $popup.find('#dsDataForm');

            if (data) {
                title = 'csv data 기반 모델 수정';
                FormUtil.BindDataForm(data, $form);
            }

            $popup.kendoWindow({
                width: `${windowWidth}px`,  // 가변적인 너비 설정
                height: "auto",
                title: title,
                visible: false,
                actions: ["Close"],
                close: function () {
                    /* 팝업 닫을 때 필요한 로직 */
                    // 조건 넣으면 좋을 거 같긴 한데. 만약 file_item이 null이 아니면
                    // 업로드된 파일의 데이터를 table로 이식.
                    // 필수 param: md_id(또는 mm_id), name, (이하 선택) type, description
                    //_this.saveDsModel();

                    // 팝업 닫을 때 destroy --> destroy하지 않으면 다시 open했을 때 file영역이 렌더링 되지 않음
                    this.destroy();
                }
            });

            $popup.data("kendoWindow").center().open();

            // 📌 기존 업로더 유지 (이미 존재하면 새로 생성하지 않음)

            window.fileUploaderInstance = new FileUploadPage($('#da_file_area'), {
                placeholder: '',
                extensions: ['.csv'],       // 확장자
                tableName: 'ds_model',      // 테이블명
                attachName: 'attach_data',
                others: 'ai\\learning_data',// path
                dataPk: data? data.id : -1,               // 해당 테이블의 dataPk
                height: '100px',
                width: '100%',
                maxFilesCount: 1,           // 최대 파일 개수
                maxFileSize: 2000,          // 최대 용량
                allowedDuple: true
            });

            console.log(" window.fileUploaderInstance", window.fileUploaderInstance);

            $popup.find('#Name').kendoTextBox();
            $popup.find('#Type').kendoTextBox();
            $popup.find('#Description').kendoTextArea({
                rows: 2,
                maxLength: 200,
                placeholder: ""
            });

            $popup.find('#btnSaveModalData').kendoButton({
                themeColor: "info",
                click: function () {
                    Alert.confirm("",
                        "저장하시겠습니까?",
                        function () {
                            const fileIds = _this.getUploadedFileIds();
                            _this.saveDsModel($form, $popup.data("kendoWindow"), fileIds);
                            _this.makeDbFromFile();
                            _this.renderGrid("data_detail_grid", "ds_rows_list");
                        },
                        function () { }
                    );
                }
            });

            $popup.find('#btnCloseModal').kendoButton({
                themeColor: "base",
                click: function () {
                    $popup.data('kendoWindow').close();
                }
            });
        }

        // 업로드된 fileId 가져오기
        getUploadedFileIds() {
            if (window.fileUploaderInstance) {
                // 📌 업로드된 모든 파일의 fileId를 가져옴
                const fileIds = Object.values(window.fileUploaderInstance.fileMap).map(file => file.id);
                console.log("업로드된 fileId 목록:", fileIds);
                return fileIds;
            } else {
                console.log("파일 업로더가 초기화되지 않음");
                return [];
            }
        }

        getDsInfo() {
            let _this = this;
            let url = _this.baseUrl;
            let param = {
                action: 'ds_model_info',
                md_id: _this.md_id,
            };

            let result = AjaxUtil.getSyncData(url, param);
            return result
        }

        makeDbFromFile() {
            let _this = this;
            let url = _this.baseUrl;
            let param = {
                action: 'make_db_from_file',
                md_id: _this.md_id,
            };

            let result = AjaxUtil.getSyncData(url, param);
            console.log('makeDbFromFile url, param, result', url, param, result);
            if (result.success) {
                console.log('DB생성.');
            }
        }

        searchMainData() {
            let _this = this;
            let param = {
                action: 'ds_model_tree_list',
                master_type: $('#cboModelType').val(),
                keyword: $('#sch_keyword').val()
            };

            let succFunc = function (result) {
                console.log("result", result);

                //let options = {
                //    id: 'id',
                //    parentId: 'parent_id',
                //    fields: {
                //        id: { type: "number" }, // TreeGrid용 고유 ID
                //        parent_id: { type: "number", nullable: true }, // TreeGrid용 부모 ID
                //    }
                //}

                // table union 과정에서 id의 고유성이 보장되지 않을 수 있어서 tree용 id를 생성해줌
                // id와 parentId가 동일하면 오류 발생
                let options = {
                    id: 'tree_id',
                    parentId: 'tree_master_id',
                    fields: {
                        tree_id: { field: "tree_id", type:"string" }, // TreeGrid용 고유 ID
                        tree_master_id: { field: "tree_master_id", type:"string", nullable: true }, // TreeGrid용 부모 ID
                    }
                }

                //console.log("options", options);
                _this.modelGrid.setTreeDataSource(result, options);

                console.log("✅ 현재 DataSource 데이터 확인:", _this.modelGrid.getData());

                //console.log("_this.modelGrid", _this.modelGrid);

                //_this.modelGrid.grid.refresh();
                //_this.modelGrid.grid.dataSource.read();

                // _this.modelGrid.expandAll();
                // 잡았다 요놈. 여기서 아래 에러 발생
                //Uncaught NotFoundError: Failed to execute 'replaceChild' on 'Node': The node to be replaced is not a child of this node.

            };
            AjaxUtil.getAsyncData(_this.baseUrl, param, succFunc);
            //AjaxUtil.getAsyncData(_this.baseUrl, param, function (result) {
            //    _this.modelGrid.setData(result);
            //});
        }

        fillCategoryVars() {
            let _this = this;
            let url = _this.baseUrl;
            let param = {
                action: 'cate_col_list',
                md_id: _this.md_id,
            };
            let rows = AjaxUtil.getSyncData(url, param);
            AjaxUtil.fillSelectOptionsRows($('#cate_vari'), rows)
            //        .kendoDropDownList({
            //            text: "선택",
            //            dataSource: _this.mission_proc_options,
            //            dataTextField: "name",
            //            dataValueField: "code",
            //            value: options.model.MissingValProcess,
            //            optionLabel: {
            //                name: "선택",
            //                code: ""
            //            }
        }

        saveDsCol() {
            let _this = this;

            let url = _this.baseUrl + '?action=save_ds_col_preprocess';

            let grid_data = $('#ds_col_grid2').data("kendoGrid").dataSource.data();

            console.log('save_ds_col_preprocess grid_data1', grid_data);

            // 데이터 타입에 따른 결측치 처리 방식 제한
            for (let i = 0; i < grid_data.length; i++) {
                let row = grid_data[i]; // 현재 행(row) 데이터

                // 범주형 데이터(char) → mean, median 사용 금지
                if (row.CategoryCount > 0 && row.Mean == null) {
                    console.log('save_ds_col_preprocess grid_data2-1', grid_data);
                    if (row.MissingValProcess === "mean" || row.MissingValProcess === "median") {
                        console.log('save_ds_col_preprocess grid_data2-2', grid_data);
                        Alert.alert("info", `범주형 데이터(${row.VarName})는 평균(mean) 또는 중위값(median)으로 처리할 수 없습니다. 다른 방식을 선택해 주세요.`);
                        return;
                    }
                }
                // 수치형(연속형) 데이터 → mode 사용 금지
                else if (!row.CategoryCount) {
                    console.log('save_ds_col_preprocess grid_data3-1', grid_data);
                    if (row.MissingValProcess === "mode") {
                        console.log('save_ds_col_preprocess grid_data3-2', grid_data);
                        Alert.alert("info", `수치형 데이터(${row.VarName})는 최빈값(mode)으로 처리할 수 없습니다. 다른 방식을 선택해 주세요.`);
                        return;
                    }
                }
                console.log('save_ds_col_preprocess grid_data4', grid_data);
                // 수치형(이산형) 데이터는 자동으로 통과 (모든 방식 허용)
            }

            let data = {
                md_id: _this.md_id,
                Q: JSON.stringify(grid_data),
            };

            let fnSuccess = function () {
                Notify.success('저장되었습니다');
                _this.renderGrid("ds_col_grid2", "ds_col_list");
            }

            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        saveDsColXY() {
            let _this = this;

            //let _this = this;
            let url = _this.baseUrl + '?action=save_ds_col_xy';

            let grid_data = $('#settingXy_grid').data("kendoGrid").dataSource.data();
            console.log('grid_data', grid_data);

            let yCount = 0; // Y가 선택된 개수를 체크하는 변수

            grid_data.forEach(function (item) {
                item.X = (item.X == 'true' || item.X == 1) ? 1 : 0;
                item.Y = (item.Y == 'true' || item.Y == 1) ? 1 : 0;

                if (item.Y === 1) {
                    yCount++; // Y가 선택된 경우 개수 증가
                }
            });

            // Y가 2개 이상 선택된 경우 경고 메시지 출력 후 저장 중단
            if (yCount > 1) {
                Alert.alert('error', 'Y 변수는 하나만 선택해야 합니다.');
                return; // 🚨 저장 로직 중단
            }

            let data = {
                md_id: _this.md_id,
                Q: JSON.stringify(grid_data),
            };

            let fnSuccess = function (result) {
                if (result.message) {
                    Alert.alert("info", `아래의 ${message}`);
                }
                if (result.success) {
                    Notify.success('저장되었습니다');
                }
                _this.renderGrid("settingXy_grid", "ds_col_list");
            }

            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        saveData() {
            //let data = FormUtil.extractForm($('#detailForm'));
            //if (checkForm($('#detailForm')) === false) return;
            AjaxUtil.postAsyncData(this.baseUrl + '?action=save', data, (resp) => {
                if (resp.success) {
                    Notify.success('저장되었습니다.');
                    this.searchMainData();
                } else {
                    Alert.alert('error', resp.message);
                }
            });
        }

        saveDsModel($form, modalContainer, fileIds) {
            let _this = this;

            let url = _this.baseUrl + '?action=save_ds_model';
            let data = FormUtil.extractForm($form);
            data['mm_id'] = _this.mm_id;
            data['fileId'] = fileIds[0];

            console.log('$form data', data);

            if (checkForm($form) === false) return;

            let fnSuccess = function () {
                modalContainer.close();
                Notify.success('저장되었습니다');
                //_this.showDsDataList();
                //_this.showModelData();
                //_this.renderGrid("data_detail_grid", "ds_rows_list");
                _this.searchMainData();
            }

            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        deleteData() {
            let data = this.modelGrid.getSelect();
            if (data.length > 0) {
                let selectData = data[0];
                AjaxUtil.postAsyncData(this.baseUrl + '?action=delete', { id: selectData.id }, (resp) => {
                    if (resp.success) {
                        Notify.success('삭제되었습니다.');
                        this.searchMainData();
                    } else {
                        Alert.alert('error', resp.message);
                    }
                });
            }
        }
    }

    let page = new DataSciencePage();

    $(document).ready(function () {
        //page.searchMainData();
    });
</script>
{% endblock %}
