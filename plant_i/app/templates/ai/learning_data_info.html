{% extends "app/layout.html" %}
{% block css %}
<style>
    small > i.material-symbols-outlined {
        font-size: inherit;
    }
</style>
{% endblock %}
{% block content %}
<div class="content-wrap">
    <div class="content-ui-row">
        <form class="search-form" id="searchForm" onsubmit="return false;">
            <div class="card-content search">
                <div class="form-ui">
                    <div class="col-12 col-md-4 col-xl-3">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="cboModelType" data-labelCd="모델유형">모델유형</label>
                            <div class="field-wrapper">
                                <select id="cboModelType" name="cboModelType" class="form-control"></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-xl-3">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="sch_keyword" data-labelCd="검색어">검색어</label>
                            <div class="field-wrapper">
                                <input id="sch_keyword" name="sch_keyword" class="form-control"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="card-group-btn search">
                            <button id="btnSearch" class="btn-search">조회</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="content-ui-row connect">
            <div class="card-content grid">
                <div class="card-group-btn">
                    <span class="info-text">
                        <i class="material-symbols-outlined">list_alt</i>
                        <label data-labelCd="모델 목록">모델 목록</label>
                    </span>
                    <span>
                        <!-- 오른쪽 버튼 영역-->
                        <button id="btnExcel">Excel</button>
                    </span>
                </div>
                <div id="model_grid"></div>
            </div>
        </div>
        <div class="content-ui-row connect">
            <div class="card-content edit">
                <div id="tabstrip">
                    <!-- ======================================= tab 리스트 ======================================= -->
                    <ul>
                        <li class="k-active">태그집합생성</li>    <!-- Tab1: 태그집합생성 (기존 작성 내용 그대로) -->
                        <li>데이터</li>
                        <li>변수통계값</li>
                        <li>수치형분포확인</li>
                        <li>범주형분포확인</li>
                        <li>전처리</li>
                        <li>상관관계히트맵</li>
                        <li>XY지정</li>
                        <li>산점도</li>
                        <li>상관관계값조회</li>
                        <li>주성분분석</li>
                        <li>모델생성</li>
                    </ul>
                    <!-- ======================================= 이하 tab 컨텐츠 ======================================= -->
                    <!-- Tab1: 태그집합생성 -->
                    <div class="tab-contents">
                        <!-- tab1 - tag form & grid -->
                        <div class="col-12 col-md-6">
                            <div class="content-ui-row connect">
                                <div class="card-group-btn">
                                    <span class="info-text">
                                        <i class="material-symbols-outlined">list_alt</i>
                                        <label data-labelCd="설비 태그">설비 태그</label>
                                    </span>
                                </div>
                                <form class="search-form" id="searchTagForm">
                                    <div class="card-content search">
                                        <div class="form-ui">
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" for="cboEquip" data-labelCd="설비">설비</label>
                                                    <div class="field-wrapper">
                                                        <select id="cboEquip" name="cboEquip" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" for="cboTagGroup" data-labelCd="태그그룹">태그그룹</label>
                                                    <div class="field-wrapper">
                                                        <select id="cboTagGroup" name="cboTagGroup" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" for="cboTag" data-labelCd="태그">태그</label>
                                                    <div class="field-wrapper">
                                                        <select id="cboTag" name="cboTag" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="card-group-btn search">
                                                    <button id="btnSearchTag" class="btn-search">조회</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <div id="tag_grid" style="width: 100%"></div>
                            </div>
                            <!-- tab1 - mes form & grid -->
                            <div class="content-ui-row connect">
                                <div class="card-group-btn">
                                    <span class="info-text k-mt-5">
                                        <i class="material-symbols-outlined">list_alt</i>
                                        <label data-labelCd="MES 데이터">MES 데이터</label>
                                    </span>
                                </div>
                                <form class="search-form" id="searchMesForm">
                                    <div class="card-content search">
                                        <div class="form-ui">
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" for="cboLineMES" data-labelCd="라인">라인</label>
                                                    <div class="field-wrapper">
                                                        <select id="cboLineMES" name="cboLineMES" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" for="cboEquipMES" data-labelCd="설비">설비</label>
                                                    <div class="field-wrapper">
                                                        <select id="cboEquipMES" name="cboEquipMES" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" for="cboMtrlMES" data-labelCd="품목">품목</label>
                                                    <div class="field-wrapper">
                                                        <select id="cboMtrlMES" name="cboMtrlMES" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="card-group-btn search">
                                                    <button id="btnSearchMES" class="btn-search">조회</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <div id="mes_tag_grid" style="width: 100%"></div>
                            </div>
                            <!-- tab1 - qms form & grid -->
                            <div class="content-ui-row connect">
                                <div class="card-group-btn">
                                    <span class="info-text k-mt-5">
                                        <i class="material-symbols-outlined">list_alt</i>
                                        <label data-labelCd="QMS 데이터">QMS 데이터</label>
                                    </span>
                                </div>
                                <form class="search-form" id="searchQmsForm">
                                    <div class="card-content search">
                                        <div class="form-ui">
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" for="cboLineQMS" data-labelCd="라인">라인</label>
                                                    <div class="field-wrapper">
                                                        <select id="cboLineQMS" name="cboLineQMS" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" for="cboEquipQMS" data-labelCd="설비">설비</label>
                                                    <div class="field-wrapper">
                                                        <select id="cboEquipQMS" name="cboEquipQMS" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" for="cboMtrlQMS" data-labelCd="품목">품목</label>
                                                    <div class="field-wrapper">
                                                        <select id="cboMtrlQMS" name="cboMtrlQMS" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="card-group-btn search">
                                                    <button id="btnSearchQMS" class="btn-search">조회</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <div id="qms_tag_grid" style="width: 100%"></div>
                            </div>
                        </div>
                        <!-- 그래프 영역 (Tab1의 오른쪽 영역) -->
                        <!--<div class="col-12 col-md-6 col-xl-4">
            <div class="content-ui-column connect">
                <div id="chart"></div>
            </div>
        </div>-->
                        <!-- 최종 태그 집합 (Tab1의 오른쪽 영역) -->
                        <div class="col-12 col-md-6">
                            <div class="content-ui-column connect">
                                <div class="card-group-btn">
                                    <span class="info-text">
                                        <i class="material-symbols-outlined">list_alt</i>
                                        <label data-labelCd="최종 태그 집합">최종 태그 집합</label>
                                    </span>
                                    <span>
                                        <button id="btnExcelMerged">Excel</button>
                                        <button id="btnSaveMerged" title="저장"><i class="material-symbols-outlined">save</i>저장</button>
                                        <!-- 삭제 기능 우선 보류. -->
                                        <button id="btnDeleteMerged" title="삭제"><i class="material-symbols-outlined">delete</i>삭제</button>
                                    </span>
                                </div>
                                <form class="search-form" id="searchMergedForm">
                                    <div class="card-content search">
                                        <div class="form-ui">
                                            <div class="col-auto">
                                                <div class="form-item align-h">
                                                    <label class="k-label k-form-label" data-labelCd="기간"> 기간</label>
                                                    <div class="field-wrapper">
                                                        <div id="srchDt">
                                                            <div class="input-group-append">
                                                                <input class="form-control" type="text" id="srchStartDt" name="srchStartDt" />
                                                                <span class="input-group-text fs-xl">
                                                                    <i class="fas fa-calendar-alt calendar_color"></i>
                                                                </span>
                                                                <input class="form-control" type="text" id="srchEndDt" name="srchEndDt" />
                                                                <span class="input-group-text fs-xl">
                                                                    <i class="fas fa-calendar-alt calendar_color"></i>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="card-group-btn search">
                                                    <button class="btn-search" id="btnSearchMerged">조회</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <div id="merged_tag_grid"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Tab2: 데이터 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="데이터 상세정보">데이터 상세정보</label>
                            </span>
                            <span>
                                <button id="btnNewData" title="csv등록" style="display:none">csv등록</button>
                                <button id="btnEditData" title="수정" style="display:none">수정</button>
                                <button id="btnDeleteData" title="삭제" style="display:none"><i class="material-symbols-outlined">delete</i>삭제</button>
                            </span>
                        </div>
                        <div id="data_detail_grid"></div>
                    </div>

                    <!-- Tab3: 변수통계값 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="변수통계값">변수통계값</label>
                            </span>
                        </div>
                        <div id="ds_col_grid"></div>
                    </div>

                    <!-- Tab4: 수치형분포확인 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="수치형분포확인">수치형분포확인</label>
                            </span>
                        </div>
                        <div class="col-auto">
                            <p>
                                * 수치형 데이터의 값별 분포 수를 보여 줍니다.
                                변수 개수, 또는 데이터 개수가 많은 경우 시간이 오래 걸릴 수 있습니다.
                            </p>
                        </div>
                        <div style="text-align:center;"><img id="num_dist_chart" style="width:90%" /></div>
                    </div>

                    <!-- Tab5: 범주형분포확인 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="범주형분포확인">범주형분포확인</label>
                            </span>
                        </div>
                        <form class="search-form" id="cateVarForm">
                            <div class="card-content search">
                                <div class="form-ui">
                                    <div class="col-12 col-md-6 col-lg-4">
                                        <div class="form-item align-h">
                                            <label class="k-label k-form-label" for="cate_vari" data-labelCd="범주형변수">범주형변수</label>
                                            <div class="field-wrapper">
                                                <select id="cate_vari" name="cate_vari" class="k-picker k-dropdownlist k-picker-solid k-picker-md k-rounded-md k-valid"></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="card-group-btn search">
                                            <button class="btn-search" id="btnCatDistChart">조회</button>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <p>
                                            * 범주형 변수를 선택한 후 조회 버튼을 클릭하면 데이터의 값별 분포 수를 보여 줍니다.
                                            변수 개수, 또는 데이터 개수가 많은 경우 시간이 오래 걸릴 수 있습니다.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div style="text-align:center;"><img id="cat_dist_chart" style="width:90%;" /></div>
                    </div>

                    <!-- Tab6: 전처리 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="전처리">전처리</label>
                            </span>
                            <span>
                                <button id="btnSavePreprocess" title="결측치/이상치 제거"><i class="material-symbols-outlined">delete</i>결측치/이상치 제거</button>
                            </span>
                        </div>
                        <div id="ds_col_grid2"></div>
                    </div>

                    <!-- Tab7: 상관관계히트맵 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="상관관계히트맵">상관관계히트맵</label>
                            </span>
                        </div>
                        <div class="col-auto">
                            <p>
                                * 수치형 데이터 간 상관관계를 히트맵 형태로 표시합니다.
                            </p>
                        </div>
                        <div style="text-align:center;"><img id="heatmap_chart" style="width:90%;" /></div>
                    </div>

                    <!-- Tab8: XY 지정 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="XY 지정">XY 지정</label>
                            </span>
                            <span>
                                <button id="btnSaveXY" title="저장"><i class="material-symbols-outlined">save</i>저장</button>
                            </span>
                        </div>
                        <div id="settingXy_grid"></div>
                    </div>

                    <!-- Tab9: 산점도 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="산점도">산점도</label>
                            </span>
                        </div>
                        <div class="col-auto">
                            <p>
                                * X변수와 Y변수에 대해서 산점도를 그려 표시합니다.
                                변수 개수, 또는 데이터 개수가 많은 경우 시간이 오래 걸릴 수 있습니다.<br />
                                <!--* X변수와 Y변수를 지정한 경우는 해당 상관관계만, 지정하지 않은 경우는 전체 변수 간의 상관관계를 표시합니다.-->
                            </p>
                        </div>
                        <div style="text-align:center;"><img id="scatter_chart" style="width:90%" /></div>
                    </div>
                    <!-- Tab10: 상관관계값조회 -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="상관관계값조회">상관관계값조회</label>
                            </span>
                        </div>
                        <div id="corr_grid"></div>
                    </div>

                    <!-- Tab11: 주성분분석 (PCA와 동일) -->
                    <div class="tab-contents">
                        <div class="card-group-btn">
                            <span class="info-text">
                                <i class="material-symbols-outlined">edit_square</i>
                                <label data-labelCd="주성분분석">주성분분석</label>
                            </span>
                        </div>
                        <form class="search-form" id="pcaForm">
                            <div class="card-content search">
                                <div class="form-ui">
                                    <div class="col-12 col-md-6 col-lg-4">
                                        <div class="form-item align-h">
                                            <label class="k-label k-form-label" for="pca_num_dim" data-labelCd="PCA차원(주성분 수)">PCA차원(주성분 수)</label>
                                            <div class="field-wrapper">
                                                <select id="pca_num_dim" name="pca_num_dim" class="k-picker k-dropdownlist k-picker-solid k-picker-md k-rounded-md k-valid"></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="card-group-btn search">
                                            <button class="btn-search" id="btnPcaApply">실행</button>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <p>
                                            * PCA(차원축소)는 고차원 데이터의 차원을 축소하여 데이터의 주요 특징을 파악하고 시각화 및 분석을 용이하게 만드는 기법입니다.<br />
                                            * 축소될 차원 수를 선택하지 않을 경우, 설명률이 90% 이상이 되는 차원으로 자동 지정됩니다.(PCA 실행 결과 차트는 3D까지만 지원됩니다.)
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div id="pca_chart">
                            <div id="pca_plotly" style="width: 80%; margin: auto; position: relative;"></div>
                            <div id="pca_result" style="width: 80%; margin: auto; position: relative;"></div>
                        </div>
                    </div>

                    <!-- Tab12: 모델생성 -->
                    <div class="tab-contents">
                        <!-- ▶ 리모컨 설정 영역 (왼쪽) -->
                        <div class="col-12 col-md-4">
                            <div class="card-content edit">
                                <div class="card-group-btn">
                                    <span class="info-text">
                                        <i class="material-symbols-outlined">tune</i>
                                        <label data-labelCd="모델 설정">모델 설정</label>
                                    </span>
                                    <!--<span>
                                        <button id="btnSaveTrain" title="저장"><i class="material-symbols-outlined">save</i>저장</button>
                                        <button id="btnTrainStart" title="학습"><i class="material-symbols-outlined">play_arrow</i>학습</button>
                                    </span>-->
                                </div>
                                <form class="search-form" id="modelTrainForm">
                                    <div class="edit-form-ui">
                                        <div class="col-12">
                                            <div class="form-item align-h">
                                                <label class="k-label k-form-label" for="cboModelTask" data-labelCd="분석유형">분석유형</label>
                                                <div class="field-wrapper">
                                                    <select id="cboModelTask" name="cboModelTask" class="form-control"></select>
                                                    <small id="taskHint" class="form-text text-muted" style="display:none;">
                                                        <i class="material-symbols-outlined">info</i>
                                                        <span></span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-item align-h">
                                                <label class="k-label k-form-label" for="cboAlgoType" data-labelCd="알고리즘">알고리즘</label>
                                                <div class="field-wrapper">
                                                    <select id="cboAlgoType" name="cboAlgoType" class="form-control"></select>
                                                    <small id="algoInfo" class="form-text text-muted" style="display:none;">
                                                        <i class="material-symbols-outlined">info</i>
                                                        <span></span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- 동적 하이퍼파라미터 폼 들어갈 자리 -->
                                        <!-- 우선 제이슨으로 받고 나중에 동적 폼으로 변경 -->
                                        <div class="col-12">
                                            <div class="form-item align-h">
                                                <label class="k-label k-form-label" for="hyperParamForm" data-labelCd="하이퍼파라미터 설정">하이퍼파라미터 설정</label>
                                                <div class="field-wrapper">
                                                    <textarea id="hyperParamForm" name="hyperParamForm"></textarea>
                                                    <!--<textarea id="hyperParamForm" name="hyperParamForm" class="form-control"></textarea>-->
                                                    <!--<div id="hyperParamForm" name="hyperParamForm" class="form-control"></div>-->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            <!-- 실행 버튼 -->
                                <div class="card-group-btn k-mt-5">
                                    <span></span>
                                    <span>
                                        <button id="btnSaveTrain" title="저장"><i class="material-symbols-outlined">save</i>저장</button>
                                        <button id="btnTrainStart" title="학습"><i class="material-symbols-outlined">play_arrow</i>학습</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- 결과 화면 영역 (오른쪽) -->
                        <div class="col-12 col-md-8">
                            <div class="card-content edit">
                                <div class="card-group-btn">
                                    <span class="info-text">
                                        <i class="material-symbols-outlined">insights</i>
                                        <label data-labelCd="모델 학습 결과">모델 학습 결과</label>
                                    </span>
                                    <span>
                                        <!--<button id="btnDownloadModel" title="모델 다운로드"><i class="material-symbols-outlined">download</i>모델 다운로드</button>-->
                                    </span>
                                </div>

                                <!-- 성능 지표 -->
                                <div id="model_result_summary" class="k-mt-3 k-mb-3">
                                    <!-- 예: Accuracy, F1-score, R2 등 -->
                                </div>

                                <!-- 성능 그래프 -->
                                <div id="model_result_chart" style="text-align: center;">
                                    <img id="model_chart_img" style="width:90%;" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% verbatim %}
<script type="text/x-kendo-template" id="fileUploadTemplate">
    <div class="content_wrap popup">
        <div class="card-content edit">
            <form id="dsDataForm" class="search-form">
                <div class="form-ui">
                    <input type="hidden" id="id" name="id">
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label essential" for="Name" data-labelCd="모델명">모델명</label>
                            <div class="field-wrapper">
                                <input type="text" id="Name" name="Name" data-msg="모델명을" />
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="Type" data-labelCd="구분">구분</label>
                            <div class="field-wrapper">
                                <input type="text" id="Type" name="Type" />
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="Description" data-labelCd="비고">비고</label>
                            <div class="field-wrapper">
                                <textarea id="Description" name="Description"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!-- kendo 첨부파일 -->
            <div class="card-group-btn k-mt-5">
                <span class="info-text"><i class="material-symbols-outlined">attach_file</i><label data-labelCd="첨부된 데이터(csv)">첨부된 데이터(csv)</label></span>
            </div>
            <form id="fileForm">
                <div class="form-item align-v">
                    <div class="field-wrapper">
                        <div id="da_file_area" name="da_file_area"></div>
                    </div>
                </div>
            </form>
            <div class="card-group-btn" style="margin-top:10px">
                <span></span>
                <span>
                    <button id="btnSaveModalData"><i class="material-symbols-outlined">save</i>저장</button>
                    <button id="btnCloseModal" class="btn-cancel">닫기</button>
                </span>
            </div>
        </div>
    </div>
</script>
{% endverbatim %}
{% endblock %}

{% block scripts %}
<!--{% include 'common/file_upload.html' %}-->
<script type="text/javascript">
    class DataSciencePage {
        constructor() {
            this.baseUrl = '/api/ai/learning_data';
            this.modelGrid = null;
            this.mm_id = null; // model master_id
            this.md_id = null; // model_id

            // FileUploadPage 인스턴스를 전역으로 선언
            window.fileUploaderInstance = null;

            // mission_proc_options를 선언 (옵션 배열)
            this.mission_proc_options = [
                { code: '', name: '-' },
                { code: 'drop', name: '제거' },
                { code: 'mean', name: '평균' },
                { code: 'median', name: '중간값' },
                { code: 'mode', name: '최빈값' }
            ];
            // mission_option_dc도 생성 (코드별 이름 매핑)
            this.mission_option_dc = {};
            this.mission_proc_options.forEach(item => {
                this.mission_option_dc[item.code] = item.name;
            });

            this.init();
        }

        init() {
            this.initUIComponents();
            this.initGrids();
            //this.searchMainData();
            this.initTabStrip();
        }

        initUIComponents() {
            let _this = this;

            // 메인데이터 model search form
            AjaxUtil.fillDropDownOptions($('#cboModelType'), 'user_code', 'all', null, 'MODEL_TYPE')
            $('#sch_keyword').kendoTextBox({ placeholder: '모델명, 유형, 설명' });
            kendoUtil.bindEnterKey('#sch_keyword', () => this.searchMainData());

            kendoUtil.bindButton('#btnSearch', 'search', 'info', () => this.searchMainData());
            kendoUtil.bindButton('#btnExcel', 'file-excel', 'success', () => {
                kendoUtil.saveAsExcel(this.modelGrid, "모델 목록");
            });

            // tab1 form
            _this.setupDropdowns({
                lineId: null,
                equipId: 'cboEquip',
                tagGroupId: 'cboTagGroup',
                tagId: 'cboTag',
                mtrlId: null
            });
            _this.setupDropdowns({
                lineId: 'cboLineMES',
                equipId: 'cboEquipMES',
                tagGroupId: null,
                tagId: null,
                mtrlId: 'cboMtrlMES'
            });
            _this.setupDropdowns({
                lineId: 'cboLineQMS',
                equipId: 'cboEquipQMS',
                tagGroupId: null,
                tagId: null,
                mtrlId: 'cboMtrlQMS'
            });
            $("#srchStartDt").kendoDatePicker({
                format: "yyyy-MM-dd",
                value: new Date(new Date().setDate(new Date().getDate() - 7))
            }).closest(".k-datepicker").css("width", "140px");

            $("#srchEndDt").kendoDatePicker({
                format: "yyyy-MM-dd",
                value: new Date()
            }).closest(".k-datepicker").css("width", "140px");

            // tab1 button
            // 저장 버튼 설정
            kendoUtil.bindButton('#btnSaveMerged', null, 'info', () => {
                Alert.confirm('', '저장하시겠습니까?', () => {
                    //this.saveData();
                });
            });
            // 삭제 버튼 설정
            kendoUtil.bindButton('#btnDeleteMerged', null, 'error', () => {
                Alert.confirm('', '삭제하시겠습니까?', () => {
                    //this.deleteData();
                });
            });
            // 엑셀 버튼 설정
            kendoUtil.bindButton('#btnExcelMerged', 'file-excel', 'success', () => {
                kendoUtil.saveAsExcel(this.grid, "태그집합");
            });

            // tab1 조회버튼
            // 설비 태그 폼의 조회 버튼 바인딩
            _this.bindSearchButton("#btnSearchTag", "#searchTagForm", "#tag_grid", "read");
            // MES 데이터 폼의 조회 버튼 바인딩
            _this.bindSearchButton("#btnSearchMES", "#searchMesForm", "#mes_tag_grid", "read");
            // QMS 데이터 폼의 조회 버튼 바인딩
            _this.bindSearchButton("#btnSearchQMS", "#searchQmsForm", "#qms_tag_grid", "read");
            // 최종 태그 집합 조회 버튼이 있다면
            _this.bindSearchButton("#btnSearchMerged", "#searchMergedForm", "#merged_tag_grid", "read");


            // tab2
            // csv기반 모델 등록 버튼
            kendoUtil.bindButton('#btnNewData', 'k-i-save', 'info', () => {
            //kendoUtil.bindButton('#btnNewData', 'file-excel', 'success', () => {

                if (!_this.mm_id) {
                    Alert.alert('info', '목록에서 데이터를 업로드 할 모델마스터를 선택해 주세요.');
                    return;
                }

                if (_this.md_id) {
                    Alert.confirm("info",
                        "이미 등록된 파일이 존재합니다. 수정하시겠습니까?",
                        function () {
                            let data = _this.getDsInfo();
                            _this.openDataUploadPopup(data);
                        },
                    );
                } else {
                    // csv 데이터 업로드 = 모델 생성으로 고정
                    _this.openDataUploadPopup();
                }
            });

            // tab2 모델 수정 버튼
            kendoUtil.bindButton('#btnEditData', 'k-i-save', 'info', () => {
                if (!_this.md_id) {
                    Alert.alert('error', '목록에서 데이터를 수정할 모델을 선택해 주세요.');
                    return;
                }

                // 기생성된 모델 정보(data)를 popup에게 전달
                const data = _this.getDsInfo();
                _this.openDataUploadPopup(data);
            });
            
            // tab2 모델 삭제 버튼
            kendoUtil.bindButton('#btnDeleteData', null, 'error', () => {
                if (!_this.md_id) {
                    Alert.alert('error', '목록에서 삭제할 모델을 선택해 주세요.');
                    return;
                }

                Alert.confirm("delete", "삭제하시겠습니까?", function () {
                    _this.deleteModel();
                });
            });

            // tab5 범주형 변수 리스트
            $('#cate_vari').kendoMultiSelect({
                dataSource: [], // 
                //dataSource: _this.fillCategoryVars(),
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "선택하세요",
                filter: "contains",
                downArrow: true,
                clearButton: true,
                noDataTemplate: "No Data",
                change: function (e) {
                    console.log("선택 변경됨", this.value());
                },
                value: []
            });

            // tab5 범주형 분석 조회 버튼
            kendoUtil.bindButton('#btnCatDistChart', "search", 'base', () => {
                let items = $("#cate_vari").data("kendoMultiSelect").value() || [];

                // 값이 단일 문자열일 경우 배열로 변환
                if (!Array.isArray(items)) {
                    items = [items];
                }
                console.log("items", items);

                let values = '';

                if (items.length > 0) {
                    items.forEach(function (value, index) {
                        if (index == 0)
                            values = value;
                        else
                            values += ',' + value;
                    });
                    console.log("value", values);
                    _this.loadChartImage("cat_dist_chart", "ds_col_count_plot", { variables: values });
                } else {
                    Alert.alert("info", "범주형 변수를 선택해주세요.");
                }
            });

            // tab6 전처리 저장 버튼
            kendoUtil.bindButton('#btnSavePreprocess', null, 'error', () => {
                Alert.confirm('', '결측치 및 이상치를 제거하시겠습니까?', () => {
                    _this.saveDsCol();
                });
            });

            // tab8 x,y 지정 저장 버튼
            kendoUtil.bindButton('#btnSaveXY', null, 'success', () => {
                Alert.confirm('', '지정한 X, Y변수를 저장하시겠습니까??', () => {
                    _this.saveDsColXY();
                });
            });

            // tab11 PCA 차원축소 가능 범위 드롭다운 
            $('#pca_num_dim').kendoDropDownList({
                dataSource: [],
                dataTextField: "text",
                dataValueField: "value",
                //placeholder: "선택하세요",
                optionLabel: {
                    text: "선택하세요",
                    value: ""
                },
                noDataTemplate: "No Data",
                change: function (e) {
                    console.log("선택 변경됨", this.value());
                },
                value: []
            });

            // tab11 pca 실행 버튼
            kendoUtil.bindButton('#btnPcaApply', null, 'base', () => {
                let dropdown = $("#pca_num_dim").data("kendoDropDownList");

                if (dropdown) {
                    let selected_value = dropdown.value();

                    let num_components = selected_value || null;
                    console.log("num_components", num_components);

                    _this.loadChartImage("pca_result", "pca_apply", { num_components: num_components });
                }
            });

            // tab12 form 초기화
            AjaxUtil.fillDropDownOptions($('#cboModelTask'), 'user_code', 'choose', null, 'TASK_TYPE');
            AjaxUtil.fillDropDownOptions($('#cboAlgoType'), 'user_code', 'choose', null, 'ALGORITHM_TYPE');
            $('#hyperParamForm').kendoTextArea({
                rows: 10,
                maxLength: 200,
                placeholder: ""
            });

            // 선택한 알고리즘과 매핑된 분석유형 저장용
            let currentAlgoMappedTasks = [];

            $('#cboModelTask').change(function () {
                const taskType = this.value;
                const groupCode = taskType ? `AI_${taskType}` : 'ALGORITHM_TYPE';

                const selectedAlgo = $('#cboAlgoType').data('kendoDropDownList').value();

                // 알고리즘이 선택되어 있고, 매핑된 유형에 현재 task가 없다면
                if (selectedAlgo && taskType && !currentAlgoMappedTasks.includes(taskType)) {
                    Alert.confirm('info', 
                        '선택하신 분석유형은 현재 선택된 알고리즘과 매핑되지 않습니다.' +
                        '<br/>확인 버튼을 누르면 알고리즘 목록이 리셋됩니다.', 
                        () => {
                            AjaxUtil.fillDropDownOptions($('#cboAlgoType'), 'user_code', 'choose', selectedAlgo, groupCode);
                            $('#cboAlgoType').data('kendoDropDownList').value('');
                            $('#cboAlgoType').trigger('change');
                        },
                        () => {
                            // 취소: 분석유형 선택을 되돌림
                            $('#cboModelTask').data('kendoDropDownList').value(''); // 또는 이전값
                        }
                    );
                    return; // Alert 후 나머지 실행 막기
                }
                
                AjaxUtil.fillDropDownOptions($('#cboAlgoType'), 'user_code', 'choose', selectedAlgo, groupCode);

                $('#cboAlgoType').trigger('change');

            });

            let previousAlgoValue = null;

            $('#cboAlgoType').off('change').on('change', function (e) {
                //$('#cboAlgoType').change(function (e) {
                const algo = this.value;
                console.log('change 발생!', {
                    time: new Date().toISOString(),
                    value: algo,
                    triggeredBy: e.originalEvent ? '사용자 또는 trigger' : '스크립트 내부'
                });

                // 외부 로직 억제(외부 원인 change 호출 방지)
                if (algo != '' && algo == previousAlgoValue) {
                    console.log('[중복 억제] same value, skipping...');
                    return;
                }

                previousAlgoValue = algo;

                const selectedTask = $('#cboModelTask').data('kendoDropDownList').value();
                const algoList = $('#cboAlgoType').data('kendoDropDownList').dataSource.data();
                //const algoList = $('#cboAlgoType').data('kendoDropDownList').dataSource.data();
                const taskHint = $('#taskHint');
                const algoInfo = $('#algoInfo');

                // algoInfo & taskHint 초기화
                algoInfo.hide().find('span').text('');
                taskHint.hide().find('span').text('');

                console.log("algoList", algoList);

                if (selectedTask) {
                    if (algoList.length <= 1) { 
                        // 선택된 분석유형이 있지만, 알고리즘이 1개 이하일 때(기본 1개. text:전체, value:'')
                        algoInfo.show().find('span').text('해당 분석 유형에 적합한 알고리즘이 없습니다.');
                        //algoInfo.show();

                        return;
                    }
                    // 리턴을 여기서 안하는 이유는 selectedTask가 있어도 아래를 타야할 때가 있어서 
                } 

                if (!algo) {
                    return;
                }                    

                const rows = AjaxUtil.getSelectData('user_code', null, algo);
                const taskTypes = [...new Set(
                    rows.filter(r => r.group?.startsWith('AI_'))
                        .map(r => r.group.replace('AI_', ''))
                )];

                currentAlgoMappedTasks = taskTypes; // 현재 알고리즘과 매핑된 분석유형 리스트 저장

                if (!taskTypes.length) {
                    taskHint.show().find('span').text('해당 알고리즘은 분석 유형과 매핑되어 있지 않습니다.');
                    //taskHint.show();
                } else {
                    const taskNames = AjaxUtil.getSelectData('user_code', 'TASK_TYPE')
                        .filter(t => taskTypes.includes(t.code || t.value))
                        .map(t => t.text)
                        .join(', ');

                    console.log(`selectedTask: ${selectedTask} \ntaskTypes: ${taskTypes}`);
                    if (taskTypes.length == 1 && taskTypes[0] == selectedTask) {
                        // 이미 선택된 task가 있고, 추천유형(1개)과 일치하는 경우
                        taskHint.hide().find('span').text('');
                    } else {
                        // 선택된 task가 없거나 추천 유형이 2개 이상인 경우
                        taskHint.show().find('span').text(`추천 분석유형: ${taskNames}`);
                    }
                }
            }); 

            // tab12 버튼
            kendoUtil.bindButton('#btnSaveTrain', null, 'info', () => {
                Alert.confirm('', '모델 학습 정보를 저장하시겠습니까?', () => {
                    _this.saveTrainConfig();
                });
            });

            kendoUtil.bindButton('#btnTrainStart', null, 'success', () => {
                _this.startTrain();
            });
        }

        // 드롭다운 선택 사항에 따른 이벤트 핸들링
        setupDropdowns(config) {
            const { lineId, equipId, tagGroupId, tagId, mtrlId } = config;

            let line = lineId ? $(`#${lineId}`) : null;
            let equip = $(`#${equipId}`);
            let tagGroup = tagGroupId ? $(`#${tagGroupId}`) : null;
            let tag = tagId ? $(`#${tagId}`) : null;
            let mtrl = mtrlId ? $(`#${mtrlId}`) : null;

            // 드롭다운 초기화
            if (line) AjaxUtil.fillDropDownOptions(line, 'line', 'all', null);
            AjaxUtil.fillDropDownOptions(equip, 'equipment', 'all', null);
            if (tagGroup) AjaxUtil.fillDropDownOptions(tagGroup, 'tag_group', 'all', null);
            if (tag) AjaxUtil.fillDropDownOptions(tag, 'tag', 'all', null);
            if (mtrl) AjaxUtil.fillDropDownOptions(mtrl, 'material', 'all', null);

            // 이벤트 핸들러
            if (line) {
                line.change(function () {
                    AjaxUtil.fillDropDownOptions(equip, 'equipment', 'all', null, null, null, line.val());
                });
            }

            equip.change(function () {
                if (tag) {
                    AjaxUtil.fillDropDownOptions(tag, 'tag', 'all', null, equip.val(), tagGroup ? tagGroup.val() : null);
                }
            });

            if (tagGroup) {
                tagGroup.change(function () {
                    AjaxUtil.fillDropDownOptions(tag, 'tag', 'all', null, equip.val() ? equip.val() : null, tagGroup.val());
                });
            }
        }

        toggleDataCrudButtons() {
            const hasMmId = !!this.mm_id;
            const hasMdId = !!this.md_id;

            // 등록 버튼은 md_id가 없고 mm_id가 있을 때만
            $('#btnNewData').toggle(hasMmId && !hasMdId);

            // 수정/삭제 버튼은 md_id가 있을 때만
            $('#btnEditData, #btnDeleteData').toggle(hasMdId);
        }

        bindSearchButton(buttonId, formId, gridId, action) {
            $(buttonId).kendoButton({
                icon: "search",
                click: function (e) {
                    e.preventDefault();
                    // 폼 데이터를 직렬화
                    var params = $(formId).serialize();
                    // 기본 URL + 액션 및 쿼리 파라미터 구성
                    var url = page.baseUrl + "?action=" + action + "&" + params;
                    // 그리드 데이터 소스 업데이트 후 읽기
                    var grid = $(gridId).data("kendoGrid");
                    if (grid) {
                        grid.dataSource.transport.options.read.url = url;
                        grid.dataSource.read();
                    }
                }
            });
        }

        initGrids() {
            // 모델 목록 그리드 초기화
            this.modelGrid = new TreeGrid($('#model_grid'), this.getGridOptions('model_grid'));
            this.searchMainData();
        }

        getGridOptions(gridName) {
            let _this = this;
            let defaultOption = {
                pageable: false,
                columns: [],
                height: "300px"
            };

            // gridName에 따른 특정 옵션 (columns 설정)
            let specificOption;

            // data가 없을 때 그리드에 뜨는 메시지
            let noDataMessage = "태그를 조합하거나 CSV 파일을 업로드하여 AI 모델을 생성하세요. 데이터가 등록되면 기본 모델이 생성되며, 이후 과정에 따라 알고리즘과 모델 정보가 자동으로 업데이트됩니다.";
            let noDataTemplate = `<div style='position: absolute; top: 0; left: 0; width: 100%; padding:10px; text-align:left;'> ${noDataMessage} </div>`;
            const getNoDataTemplate = () =>
                `<div style='position: absolute; top: 0; left: 0; width: 100%; padding:10px; text-align:left;'> ${noDataMessage} </div>`;

            switch (gridName) {

                case 'model_grid':
                    specificOption = {
                        pageable: false,
                        columnMenu: {
                            componentType: "classic",
                            autoSize: true,
                            clearAllFilters: true,
                            columns: { sort: "asc" }
                        },
                        columns: [
                            // number 쓰면 tree구조 고장남
                            //{ title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'id', hidden: true },
                            { field: 'name', title: '모델명', width: 120 },
                            { field: 'type', title: '유형', width: 50 },
                            { field: 'ver', title: 'Ver', width: 50 },
                            { field: 'description', title: '설명', width: 150 },
                            //{ field: 'cycle', title: '모델생성주기', width: 100 },
                            { field: 'var_count', title: '변수개수', width: 60 },
                            { field: 'file_name', title: '원본파일명', width: 150 },
                            { field: 'algorithm_type', title: 'ML(알고리즘)', width: 100 },
                            //{ field: '_created', title: '등록일', width: 100 }
                        ],
                        change: function (e) {
                            let activeTab = $("#tabstrip").data("kendoTabStrip").select().index();
                            // 현재 열려있는 탭에서만 선택된 모델의 데이터 갱신
                            _this.loadContentByTab(activeTab, false);
                        },
                        height: "300px"
                    };
                    break;

                case 'tag_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'equipment_name', title: '설비명', width: 125 },
                            { field: 'tag_group_name', title: '태그그룹명', width: 125 },
                            { field: 'tag_name', title: '태그명', width: 200 }
                        ],
                        height: "200px"
                    };
                    break;

                case 'mes_tag_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'line', title: '라인', width: 100 },
                            { field: 'equipment_name', title: '설비명', width: 150 },
                            { field: 'PNL', title: '부적합기준', width: 100 },
                            { field: 'P/N', title: '합부결과', width: 100 },
                        ],
                        height: "200px"
                    };
                    break;

                case 'qms_tag_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'line', title: '라인', width: 100 },
                            { field: 'equipment_name', title: '설비명', width: 150 },
                            { field: 'material', title: '품목', width: 100 },
                            { field: 'P/N', title: '합부결과', width: 100 },
                        ],
                        height: "200px"
                    };
                    break;

                case 'merged_tag_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'line', title: '라인', width: 100 },
                            { field: 'equipment_name', title: '설비명', width: 150 },
                            { field: 'material', title: '품목', width: 100 },
                            { field: 'P/N', title: '합부결과', width: 100 },
                        ],
                        height: "1000px"
                    };
                    break;

                case 'data_detail_grid':
                    specificOption = {
                        //pageable: false,
                        pageable: {
                            refresh: true,  // 새로고침 버튼 추가
                            pageSizes: [10, 20, 50, 100, "all"],  // 선택 가능한 페이지 크기
                            buttonCount: 5  // 페이지네이션 버튼 개수
                        },
                        dataSource: new kendo.data.DataSource({
                            pageSize: 50,  // 기본 페이지 크기
                            serverPaging: false,  // 서버 페이징 비활성화 (클라이언트 페이징만 사용)
                            data: []  // 초기 데이터 비워두기
                        }),
                        columns: [
                            // file에 따라 달라지므로 동적으로 생성
                        ],
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        }
                    };
                    break;

                case 'ds_col_grid':
                    specificOption = {
                        pageable: false,
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'VarName', title: '변수명', width: 150 },
                            { field: 'DataCount', title: '데이터개수', width: 100 },
                            { field: 'MissingCount', title: '결측치개수', width: 100 },
                            { field: 'CategoryCount', title: '범주개수', width: 100 },
                            { field: 'Mean', title: '평균', width: 100 },
                            { field: 'Std', title: '표준편차', width: 100 },
                            { field: 'Q1', title: 'Q1', width: 100 },
                            { field: 'Q2', title: 'Q2', width: 100 },
                            { field: 'Q3', title: 'Q3', width: 100 }
                        ],
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        }
                    };
                    break;

                case 'ds_col_grid2':
                    specificOption = {
                        pageable: false,
                        editable: true,  // 편집 가능하도록 설정(콤보박스용)
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'VarName', title: '변수명', width: 150, editable: () => false },
                            {
                                field: "MissingValProcess",
                                title: "결측치 처리방법",
                                width: 120,
                                attributes: { style: "text-align: center" },
                                template: function (dataItem) {
                                    let selectedOption = _this.mission_proc_options.find(opt => opt.code == dataItem.MissingValProcess);
                                    return `<select name="MissingValProcess" class="k-picker k-dropdownlist k-picker-solid k-picker-md k-rounded-md k-valid">
                                                <option selected value="${selectedOption ? selectedOption.code : ''}">${selectedOption? selectedOption.name : "선택"}</option>
                                            </select>`;
                                },
                                // 임의로 editor 형식으로 변환되는 것 방지
                                editable: () => false
                                //editor: function (container, options) {
                                //    $('<select name="' + options.field + '"></select>')
                                //        .appendTo(container)
                                //        .kendoDropDownList({
                                //            text: "선택",
                                //            dataSource: _this.mission_proc_options,
                                //            dataTextField: "name",
                                //            dataValueField: "code",
                                //            value: options.model.MissingValProcess,
                                //            optionLabel: {
                                //                name: "선택",
                                //                code: ""
                                //            },
                                //            change: function (e) {
                                //                options.model.set("MissingValProcess", e.sender.value());
                                //            }
                                //        });
                                //}
                            },
                            {
                                field: "DropOutLow",
                                title: "이상치하한",
                                width: 100,
                                attributes: { style: "text-align: center" },
                                template: function (dataItem) {
                                    let value = dataItem.DropOutLow ?? "";
                                    let displayValue = value == null ? "입력" : value; // ✅ 값이 없으면 "입력" 표시
                                    return `<input name="DropOutLow" class="k-input k-textbox k-input-solid k-input-md k-rounded-md" 
                                              value="${displayValue}" placeholder="입력" />`;
                                },
                                editor: function (container, options) {
                                    $('<input name="DropOutLow"/>')
                                        .appendTo(container)
                                        .kendoTextBox({
                                            value: options.model.DropOutLow ?? null, // ✅ 값이 없으면 placeholder로 "입력" 표시
                                            placeholder: "입력",
                                            change: function (e) {
                                                let newValue = e.sender.value().trim();
                                                options.model.set("DropOutLow", newValue === "" ? null : newValue); // ✅ 빈 값이면 null 처리
                                            },
                                        //    width: "100%"
                                        });
                                }
                                //template: function (dataItem) {
                                //    return dataItem.DropOutLow !== null && dataItem.DropOutLow !== undefined ? dataItem.DropOutLow : "입력";
                                //},
                                //editor: function (container, options) {
                                //    $('<input name="' + options.field + '"/>')
                                //        .appendTo(container)
                                //        .kendoNumericTextBox({
                                //            format: "n2",
                                //            decimals: 2,
                                //            step: 0.01,
                                //            value: options.model[options.field] || null,
                                //            change: function (e) {
                                //                let newValue = e.sender.value();
                                //                options.model.set(options.field, newValue); // 🚀 값 바로 반영 (검증 없음)
                                //            }
                                //        });
                                //}
                            },
                            {
                                field: "DropOutUpper",
                                title: "이상치상한",
                                width: 100,
                                attributes: { style: "text-align: center" },
                                //template: function (dataItem) {
                                //    return dataItem.DropOutUpper !== null && dataItem.DropOutUpper !== undefined ? dataItem.DropOutUpper : "입력";
                                //},
                                //editor: function (container, options) {
                                //    $('<input name="' + options.field + '"/>')
                                //        .appendTo(container)
                                //        .kendoNumericTextBox({
                                //            format: "n2",
                                //            decimals: 2,
                                //            step: 0.01,
                                //            value: options.model[options.field] || null,
                                //            change: function (e) {
                                //                let newValue = e.sender.value();
                                //                options.model.set(options.field, newValue); // 🚀 값 바로 반영 (검증 없음)
                                //            }
                                //        });
                                //}
                                template: function (dataItem) {
                                    let value = dataItem.DropOutUpper ?? "";
                                    let displayValue = value == null ? "입력" : value; // ✅ 값이 없으면 "입력" 표시
                                    return `<input name="DropOutUpper" class="k-input k-textbox k-input-solid k-input-md k-rounded-md" 
                                            value="${displayValue}" placeholder="입력" />`;
                                },
                                editor: function (container, options) {
                                    $('<input name="DropOutUpper"/>')
                                        .appendTo(container)
                                        .kendoTextBox({
                                            value: options.model.DropOutUpper ?? null, // ✅ 값이 없으면 placeholder로 "입력" 표시
                                            placeholder: "입력",
                                            change: function (e) {
                                                let newValue = e.sender.value().trim();
                                                options.model.set("DropOutUpper", newValue === "" ? null : newValue); // ✅ 빈 값이면 null 처리
                                            },
                                        //    width: "100%"
                                        });
                                }
                            },
                            { field: 'DataCount', title: '데이터수', width: 80, editable: () => false },
                            { field: 'MissingCount', title: '결측치수', width: 80, editable: () => false },
                            { field: 'CategoryCount', title: '범주개수', width: 80, editable: () => false },
                            { field: 'Mean', title: '평균', width: 80, editable: () => false },
                            { field: 'Std', title: '표준편차', width: 80, editable: () => false },
                            { field: 'Q1', title: 'Q1', width: 80, editable: () => false },
                            { field: 'Q2', title: 'Q2', width: 80, editable: () => false },
                            { field: 'Q3', title: 'Q3', width: 80, editable: () => false },

                        ],
                        dataBound: function (e) {
                            let grid = this;

                            // ✅ DropDownList 바인딩 (MissingValProcess)
                            grid.tbody.find("select[name='MissingValProcess']").each(function () {
                                let select = $(this);
                                let row = select.closest("tr");
                                let dataItem = grid.dataItem(row);

                                select.kendoDropDownList({
                                    dataSource: _this.mission_proc_options, // ✅ "-" 옵션 그대로 유지
                                    dataTextField: "name",
                                    dataValueField: "code",
                                    value: dataItem.MissingValProcess || "", // ✅ 빈 값이면 "-"가 표시됨
                                    optionLabel: "선택", // ✅ "선택"이 표시되지만 "-"도 그대로 유지
                                    change: function (e) {
                                        dataItem.set("MissingValProcess", e.sender.value());
                                    }
                                });
                            });

                            //// TextBox 바인딩 (DropOutLow)
                            //grid.tbody.find("input[name='DropOutLow']").each(function () {
                            //    let input = $(this);
                            //    let row = input.closest("tr");
                            //    let dataItem = grid.dataItem(row);

                            //    input.kendoTextBox({
                            //        format: "n8",
                            //        decimals: 8,
                            //        value: dataItem.DropOutLow ?? null, // ✅ 값이 없으면 placeholder로 "입력" 표시
                            //        placeholder: "입력", // ✅ placeholder 추가
                            //        change: function (e) {
                            //            let newValue = e.sender.value().trim();
                            //            dataItem.set("DropOutLow", newValue == "" ? null : newValue); // ✅ 빈 값이면 "입력" 표시
                            //        },
                            //        width: "100%"
                            //    });
                            //});

                            //// TextBox 바인딩 (DropOutUpper)
                            //grid.tbody.find("input[name='DropOutUpper']").each(function () {
                            //    let input = $(this);
                            //    let row = input.closest("tr");
                            //    let dataItem = grid.dataItem(row);

                            //    input.kendoTextBox({
                            //        format: "n8",
                            //        decimals: 8,
                            //        value: dataItem.DropOutUpper ?? null, // ✅ 값이 없으면 placeholder로 "입력" 표시
                            //        placeholder: "입력", // ✅ placeholder 추가
                            //        change: function (e) {
                            //            let newValue = e.sender.value().trim();
                            //            dataItem.set("DropOutUpper", newValue == "" ? null : newValue); // ✅ 빈 값이면 "입력" 표시
                            //        },
                            //        width: "100%"
                            //    });
                            //});

                            // 그리드 행 번호 자동 업데이트
                            let items = grid.items();
                            items.each(function (index) {
                                $(this).find("td:first").html(index + 1);
                            });

                            kendoUtil.showGridRowCount(this.element);
                        },
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        }
                    };
                    break;

                case 'settingXy_grid':
                    specificOption = {
                        pageable: false,
                        sortable: false,    // 해당 기능 true 되면 check 선택 이벤트보다 sort 이벤트가 실행됨
                        filterable: false,
                        editable: false,  // 어차피 dom으로 직접 조작해서 value 주기 때문에 false로
                        columns: [
                            { title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' }},
                            { field: 'VarName', title: '변수명', width: 150 },
                            {
                                field: 'X',
                                width: 80,
                                headerTemplate: '<input type="checkbox" class="chkbx k-checkbox k-checkbox-md k-rounded-md" id="x_all_check"/>X변수',
                                attributes: { style: "text-align: center" },
                                template: function (item) {
                                    return '<input name="chkbx_x" type="checkbox"' + (item.X == 1 ? 'checked="checked"' : '') + 'class="chkbx k-checkbox k-checkbox-md k-rounded-md" />';
                                },
                            },
                            {
                                field: 'Y',
                                width: 80,
                                //headerTemplate: '<input type="checkbox" class="chkbx k-checkbox k-checkbox-md k-rounded-md" id="y_all_check"/>Y변수',
                                attributes: { style: "text-align: center" },
                                title: 'Y변수',
                                template: function (item) {
                                    return '<input name="chkbx_y" type="checkbox"' + (item.Y == 1 ? 'checked="checked"' : '') + 'class="chkbx k-checkbox k-checkbox-md k-rounded-md" />';
                                },
                            },
                            { field: 'DataCount', title: '데이터개수', width: 100 },
                            { field: 'MissingCount', title: '결측치개수', width: 100 },
                            { field: 'CategoryCount', title: '범주개수', width: 80 },
                            { field: 'Mean', title: '평균', width: 80 },
                            { field: 'Std', title: '표준편차', width: 80 },
                            { field: 'Q1', title: 'Q1', width: 80 },
                            { field: 'Q2', title: 'Q2', width: 80 },
                            { field: 'Q3', title: 'Q3', width: 80 },
                            { field: "MissingValProcess", title: "결측치 처리방법", width: 120 },
                            { field: "DropOutLow", title: "이상치하한", width: 100 },
                            { field: "DropOutUpper", title: "이상치상한", width: 100 }
                        ],
                        dataBound: function (e) {
                            let grid = this;
                            let items = grid.items();

                            // 개별 X 체크박스 클릭 시 데이터 반영
                            grid.element.find("input[name='chkbx_x']").on("change", function () {
                                let row = $(this).closest("tr");
                                let dataItem = grid.dataItem(row);
                                dataItem.set("X", this.checked ? 1 : 0);
                            });

                            // 개별 Y 체크박스 클릭 시 데이터 반영
                            grid.element.find("input[name='chkbx_y']").on("change", function () {
                                let row = $(this).closest("tr");
                                let dataItem = grid.dataItem(row);

                                //임시 y 1개만 지정 해제
                                //dataItem.set("Y", this.checked ? 1 : 0);

                                console.log("1", grid.element.find("input[name='chkbx_y']:checked"));
                                if (this.checked) {
                                    console.log("2", grid.element.find("input[name='chkbx_y']:checked"));

                                    // Y가 이미 선택된 상태인지 확인 (본인이 체크되기 전 기준)
                                    // 현재 체크된 상태에서 Y가 이미 선택된 항목이 있는지 확인
                                    let existingChecked = grid.element.find("input[name='chkbx_y']:checked").not(this);

                                    if (existingChecked.length > 0) {
                                        console.log("3", grid.element.find("input[name='chkbx_y']:checked"));

                                        Alert.alert("error", "Y변수는 하나만 선택할 수 있습니다.");
                                        $(this).prop("checked", false);  // 방금 체크한 거 해제
                                        return;
                                    }
                                    console.log("4", grid.element.find("input[name='chkbx_y']:checked"));
                                    // ✅ 기존 Y 해제 후 현재 선택 반영
                                    grid.dataSource.data().forEach(item => item.set("Y", 0));
                                    dataItem.set("Y", 1);
                                } else {
                                    // ✅ 체크 해제된 경우 데이터 반영
                                    dataItem.set("Y", 0);
                                }
                                console.log("5", grid.element.find("input[name='chkbx_y']:checked"));

                            });

                            // X 전체 선택 버튼 이벤트 (Y는 단일 선택이라 없음)
                            $("#x_all_check").on("click", function () {
                                let checked = $(this).prop("checked");
                                // data 업데이트
                                console.log("checked1", checked);
                                grid.dataSource.data().forEach(item => item.set("X", checked ? 1 : 0));
                                // UI 업데이트 (체크박스 상태)
                                console.log("checked2", checked);
                                $('input[name="chkbx_x"]').prop("checked", checked);
                                console.log("checked3", checked);
                            });

                            //// Y 전체 선택 버튼 이벤트 (Y는 단일 선택이라 없음)
                            //$("#y_all_check").on("click", function () {
                            //    let checked = $(this).prop("checked");
                            //    // data 업데이트
                            //    console.log("checked1", checked);
                            //    grid.dataSource.data().forEach(item => item.set("Y", checked ? 1 : 0));
                            //    // UI 업데이트 (체크박스 상태)
                            //    console.log("checked2", checked);
                            //    $('input[name="chkbx_y"]').prop("checked", checked);
                            //    console.log("checked3", checked);
                            //});

                            // 행 번호 추가
                            items.each(function (index) {
                                $(this).find("td:first").html(index + 1);
                            });

                            // 그리드 row 개수 표시
                            kendoUtil.showGridRowCount(this.element);
                        },
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        },
                    };
                    break;

                case 'corr_grid':
                    noDataMessage += "<br>상관관계값의 경우 X,Y변수가 지정되어야 연산이 가능하므로, XY지정 탭에서 X변수와 Y변수를 지정해주세요.";
                    specificOption = {
                        pageable: false,
                        columns: [
                            //{ title: 'No', template: (dataItem) => `<div>${dataItem.index + 1}</div>`, width: 50, attributes: { style: 'text-align: center' } },
                            { field: 'YVarName', title: 'Y변수', width: 80 },
                            { field: 'data_type', title: '구분', width: 80 },
                            { field: 'intercept_', title: '절편', width: 80 }
                        ],
                        height: "300px",
                        noRecords: {
                            template: getNoDataTemplate()
                        }
                    };
                    console.log("noDataTemplate", noDataTemplate);
                    console.log("noDataMessage", noDataMessage);
                    break;
                // 필요시 다른 탭(그리드) 옵션 추가 가능
                default:
                    specificOption = defaultOption;
            }

            let gridOptions = specificOption;

            if (!gridOptions.dataBound) {
                // dataBound를 따로 설정하지 않은 그리드는 공통사항을 할당
                gridOptions.dataBound = function (e) {
                    let items = this.items();
                    items.each(function (index) {
                        $(this).find("td:first").html(index + 1);
                    });

                    kendoUtil.showGridRowCount(this.element);
                };
            }

            console.log("gridOptions", gridOptions);

            return gridOptions;
        }

        initTabStrip() {
            let _this = this;
            $("#tabstrip").kendoTabStrip({
                animation: { open: { effects: "fadeIn" } },
                activate: function (e) {
                    let activeTabIndex = $(e.item).index();
                    _this.loadContentByTab(activeTabIndex, false);
                }
            });
            // 초기 로드시 기본 탭(Tab1, 인덱스 0)과 첫번째 열람 여부를 명시적으로 로드
            _this.loadContentByTab(0, true);
        }

        loadContentByTab(tabIndex, first = false) {
            let _this = this;

            let selectModel = null;

            // 페이지가 처음 로드 될 때는 모델 선택 alert이 발생하지 않도록, 표출 여부를 false로 전달
            if (first) {
                selectModel = _this.getSelectedModel(false);
            } else {
                selectModel = _this.getSelectedModel(true, tabIndex);
            }

            // 선택된 모델이 없으면 정지. 단, 페이지를 처음 로드할 때는 계속 진행
            if (!selectModel && !(first && tabIndex === 0)) {
                return;
            }

            // 탭 인덱스에 따라 해당 탭의 컨테이너를 초기화 또는 갱신
            switch (tabIndex) {
                case 0:
                    _this.renderGrid("tag_grid", "tag");
                    _this.renderGrid("mes_tag_grid", "mes");
                    _this.renderGrid("qms_tag_grid", "qms");
                    _this.renderGrid("merged_tag_grid", "merged_tag");
                    break;
                case 1:
                    _this.renderGrid("data_detail_grid", "ds_rows_list");
                    _this.toggleDataCrudButtons();  //그리드에서 선택한 모델에 따른 버튼 토글
                    break;
                case 2:
                    _this.renderGrid("ds_col_grid", "ds_col_list");
                    break;
                case 3:
                    _this.loadChartImage("num_dist_chart", "ds_numcol_boxhist");
                    break;
                case 4:
                    // 범주형 변수 리스트
                    let cate_var_list = $("#cate_vari").data("kendoMultiSelect");
                    if (cate_var_list) {
                        cate_var_list.setDataSource(_this.fillCategoryVars());
                        // 선택된 모델 변경시 차트 초기화
                        if (!cate_var_list.value().length) {
                            $('#cat_dist_chart').attr('src', '').css('opacity', 0);
                        }
                        console.log("cate_var_list", cate_var_list);
                    }
                    break;
                case 5:
                    _this.renderGrid("ds_col_grid2", "ds_col_list");
                    break;
                case 6:
                    _this.loadChartImage("heatmap_chart", "ds_heatmap");
                    break;
                case 7:
                    _this.renderGrid("settingXy_grid", "ds_col_list");
                    break;
                case 8:
                    _this.loadChartImage("scatter_chart", "ds_col_scatter");
                    break;
                case 9:
                    _this.renderGrid("corr_grid", "ds_var_corr_sheet");
                    break;
                case 10:
                    // Tab11: 주성분분석은 누적설명률 차트 및 결과 영역(pca_plotly, pca_result)을 별도로 처리
                    // pca 차원축소 범위 리스트(실제 변수 개수)
                    let pca_dim_list = $("#pca_num_dim").data("kendoDropDownList");
                    if (pca_dim_list) {
                        pca_dim_list.setDataSource([]);
                        console.log("pca_dim_list", pca_dim_list);
                    }
                    _this.loadChartImage("pca_plotly", "pca_evr");
                    break;
                case 11:
                    _this.renderGrid("model_create_grid");
                    break;
                default:
                    console.log("해당 탭에 그리드 없음");
            }
        }

        //getSelectedModel(tabIndex, showAlert = true) {
        getSelectedModel(showAlert = true, tabIndex = null) {
            let _this = this;
            let data = _this.modelGrid.getSelect();

                //if (showAlert && tabIndex !== 0) {
            if (!data || data.length === 0) {
                if (showAlert) {
                    if (tabIndex == 1) {
                        // 데이터 탭에서만
                        Alert.alert('info',
                            '상단 목록에서 생성할 모델의 종류(마스터)를 선택해주세요. 이미 모델을 생성하신 경우, 데이터를 조회할 모델을 선택해 주세요.'

                            //'상단 목록에서 생성할 모델의 종류(마스터)를 선택해주세요.'
                            //+ '<br>이미 모델을 생성하신 경우, 데이터를 조회할 모델을 선택해 주세요.'
                        );
                    } else {
                        Alert.alert('info', '상단 목록에서 데이터를 조회할 모델을 선택해 주세요.');
                    }
                }
                return null;
            } 

            const selectData = data[0];
            console.log("선택된 모델:", selectData);
            _this.mm_id = selectData.master_id;
            _this.md_id = selectData.model_id;

            return selectData;
        }


        renderGrid(gridId, action) {
            let _this = this;
            let grid = $("#" + gridId).data("kendoGrid");
            let options = this.getGridOptions(gridId);

            if (grid) {
                /* 그리드 인스턴스가 이미 존재할 때,
                ** 이전에 조회했던 모델에 데이터가 없었던 경우 columns이 빈 배열로 초기화된 상태.
                ** 본래 컬럼 설정을 다시 찾아갈 수 있도록 재할당 */
                grid.options.columns = options.columns;

            } else {
                new Grid($("#" + gridId), options);
            }

            // API 호출: action 값이 전달되면 공통 업데이트 함수 호출
            if (action) {
                _this.updateGridData(gridId, action, { md_id: _this.md_id });
            }
        }

        updateGridData(gridId, action, extraParam) {
            let _this = this;
            let param = Object.assign({ action: action }, extraParam || {});

            let gridInstance = $("#" + gridId).data("kendoGrid");
            // tab별 용도에 따라 고정으로 생성되어야 하는 컬럼(원천 데이터의 컬럼과 별개)
            let baseColumns = gridInstance.options.columns;

            let succFunc = function (result) {
                console.log("result", result);
                // xrows(컬럼)를 백엔드에서 보내주는 경우(데이터마다 컬럼이 달라지는 경우)
                if (result.xrows) {
                    if (result.xrows.length > 0) {
                        var dynamicColumns = result.xrows.map(function (item, index) {
                            return {
                                field: 'col_' + (index + 1),// col_ + 변수순서
                                //field: item.VarName,      // 필드 이름 (백엔드에서 보내는 컬럼명)
                                title: item.VarName,        // 제목 (화면에 표시될 텍스트)
                                width: item.width || 100,   // 백엔드에서 제공된 width가 없으면 기본값 100px 사용
                            };
                        });

                        if (baseColumns) {
                            console.log("baseColumns", baseColumns);
                            // base컬럼이 있으면 데이터의 컬럼들과 병합(정적 생성 + 동적 생성)
                            dynamicColumns = [...baseColumns, ...dynamicColumns];
                        }

                        // No. 이유는 알 수 없지만 첫번째 컬럼의 값이 row의 index로 바인딩되는 에러 발생(id 아님!)
                        // 이참에 그냥 index컬럼을 만들어버림
                        // "No" 컬럼이 없는 경우에만 추가.
                        if (!dynamicColumns.some(col => col.title === "No")) {
                            dynamicColumns.unshift({ "title": "No", "width": 50 });
                        }

                        console.log("dynamicColumns", dynamicColumns);

                        gridInstance.setOptions({ columns: dynamicColumns });
                        gridInstance.dataSource.data(result.rows);
                        //console.log("gridInstance.dataSource.data", gridInstance.dataSource.data());
                    } else {
                        // xrows는 있지만 빈 배열 일 때. 컬럼&데이터 초기화하여 noDataMessage 표시
                        let pageSize = gridInstance.dataSource.options.pageSize;

                        gridInstance.setOptions({
                            columns: [],
                            dataSource: {
                                // pageSize 설정이 덮어씌워져서 all로 바뀌는 것 방지
                                pageSize: pageSize ? pageSize : null,
                                page: pageSize ? 1 : null, // 페이지 속성이 있으면 첫 페이지로 이동
                                data: []
                            }
                        });
                    }
                } else {
                    // 일반적인 grid 데이터일 때
                    gridInstance.dataSource.data(result);
                }
                // 컬럼 크기 자동 조절
                gridInstance.autoFitColumns();
            }

            AjaxUtil.getAsyncData(_this.baseUrl, param, succFunc);
        }

        loadChartImage(chartId, action, extraParam = null) {
            let _this = this;

            // 그래프 초기화 PCA 차트는 `empty()`, 이미지 차트는 `src` 비우기
            if ($('#' + chartId).is('div')) {
                $('#' + chartId).empty();
                // PCA 수행 결과 로드 시, 이전에 생성된 설명률 차트도 남아있어야 하므로 여기서 초기화x
            } else {
                $('#' + chartId).attr('src', '').css('opacity', 0); // 이미지 차트
            }

            let param = {
                action: action,
                md_id: _this.md_id,
                ...extraParam
            };

            console.log("param", param);

            try {
                let result = AjaxUtil.getSyncData(_this.baseUrl, param); // 동기 요청 후 결과 반환
                console.log("result", result);

                // 결과가 없거나 실패했을 경우, 먼저 처리하고 함수 종료
                if (!result || !result.success) {
                    // 실패 시 PCA 수행 결과 차트 초기화
                    $('#' + chartId).siblings().empty();

                    let errorMessage = null;

                    if (result?.not_enough_x_vars) {
                        errorMessage = "지정된 X변수가 1개 이하이므로 더이상 축소할 차원이 없습니다. <br>PCA 진행을 원하는 경우, XY지정 탭에서 X변수를 2개 이상 선택해주세요.";

                    } else if (result?.no_xy_message) {
                        errorMessage = "X, Y변수가 지정되어야 연산이 가능하므로, 먼저 XY지정 탭에서 X변수와 Y변수를 지정해주세요.";

                    } else {
                        errorMessage = `이미지 로드에 실패했습니다. 응답 성공 여부 확인이 필요합니다.\n응답: ${JSON.stringify(result)}`;
                        console.error("이미지 로드 실패: 응답 성공 여부 확인 필요", result);
                    }

                    Alert.alert(result?.not_enough_x_vars || result?.no_xy_message ? "info" : "error", errorMessage);
                    return;
                }

                // pca 관련 그래프면 plotly로, 아니면 이미지로
                if (result.pca_plotly) {
                    //let x_range = result.x_vars_len;
                    let x_range = result.x_vars_len ?? null;

                    // PCA 그래프 그리기
                    $('#' + chartId).html(result.pca_plotly);
                    //window.dispatchEvent(new Event('resize'));

                    // PCA 드롭다운 업데이트 (x_range가 있는 경우만)
                    if (x_range !== null) {
                        let pca_dim_list = $("#pca_num_dim").data("kendoDropDownList");
                        if (pca_dim_list) {
                            let dim_range = [];
                            for (let i = 1; i < parseInt(x_range); i++) {
                                dim_range.push({ value: i, text: i });
                            }
                            console.log("dim_range", dim_range);
                            pca_dim_list.setDataSource(dim_range);
                        }

                        // 설명률 차트 업데이트 시, pca수행결과 차트 초기화
                        $('#' + chartId).siblings().empty();
                    }
                    return; // PCA 실행 후 일반 차트 실행 방지
                }

                else {
                    // 일반 차트(이미지)
                    $('#' + chartId).attr('src', result.chart_url).css('opacity', 1);
                }

            } catch (error) {
                Alert.alert("error", `이미지 로드에 실패했습니다. \n에러 메시지: ${error.message}`);
                console.error("이미지 로드 중 오류 발생:", error.message);
            }
        }

        // csv file 업로드 popup
        openDataUploadPopup(data) {
            let _this = this;
            let windowWidth = 700;
            let windowHeight = 520;
            //let windowWidth = window.innerWidth * 0.5;
            //let windowHeight = window.innerHeight * 0.7;

            const options = {
                title: data ? 'csv data 기반 모델 수정' : 'csv data 기반 모델 생성',
                width: `${windowWidth}px`,
                height: `${windowHeight}px`,
                param: {
                    data: data ? data : null,
                    mm_id: _this.mm_id ? _this.mm_id : null,
                    md_id: _this.md_id ? _this.md_id : null
                },
                closeCallback: function (pop_data) {
                    if (!pop_data) return;
                    if (pop_data.success) {
                        console.log("부모 원본 데이터", data);
                        console.log("팝업한테서 온 데이터", pop_data);
                        //let new_md_id = data.success.md_id;
                        _this.md_id = pop_data.md_id;
                        // 모델 저장or수정에 성공하면 file > db 변환(업로드된 파일이 변경되었을 때만)
                        if (!data || data.file_id != pop_data.new_file_id) {
                            _this.makeDbFromFile();
                        }
                        Notify.success('저장되었습니다.');
                        _this.searchMainData();
                        _this.renderGrid("data_detail_grid", "ds_rows_list");
                        _this.toggleDataCrudButtons();
                    } else {
                        Alert.alert('', '저장 실패');
                    }
                }
            }
            popupComn.openPopup('/page/popup/modalModel', options);

            //let _this = this;
            //let templateHtml = $('#fileUploadTemplate').html();
            //let $popup = $(templateHtml);
            //// 브라우저 너비의 50%를 팝업 너비로 설정
            //let windowWidth = window.innerWidth * 0.5;
            //let title = 'csv data 기반 모델 생성';

            //let $form = $popup.find('#dsDataForm');

            //if (data) {
            //    title = 'csv data 기반 모델 수정';
            //    FormUtil.BindDataForm(data, $form);
            //}

            //$popup.kendoWindow({
            //    width: `${windowWidth}px`,  // 가변적인 너비 설정
            //    height: "auto",
            //    title: title,
            //    visible: false,
            //    actions: ["Close"],
            //    close: function () {
            //        /* 팝업 닫을 때 필요한 로직 */
            //        // 조건 넣으면 좋을 거 같긴 한데. 만약 file_item이 null이 아니면
            //        // 업로드된 파일의 데이터를 table로 이식.
            //        // 필수 param: md_id(또는 mm_id), name, (이하 선택) type, description
            //        //_this.saveDsModel();

            //        // 팝업 닫을 때 destroy --> destroy하지 않으면 다시 open했을 때 file영역이 렌더링 되지 않음
            //        this.destroy();
            //    }
            //});

            //$popup.data("kendoWindow").center().open();

            //// 📌 기존 업로더 유지 (이미 존재하면 새로 생성하지 않음)

            //window.fileUploaderInstance = new FileUploadPage($('#da_file_area'), {
            //    placeholder: '',
            //    extensions: ['.csv'],       // 확장자
            //    tableName: 'ds_model',      // 테이블명
            //    attachName: 'attach_data',
            //    others: 'ai\\learning_data',// path
            //    dataPk: data? data.id : -1,               // 해당 테이블의 dataPk
            //    height: '100px',
            //    width: '100%',
            //    maxFilesCount: 1,           // 최대 파일 개수
            //    maxFileSize: 2000,          // 최대 용량
            //    allowedDuple: true
            //});

            //console.log(" window.fileUploaderInstance", window.fileUploaderInstance);

            //$popup.find('#Name').kendoTextBox();
            //$popup.find('#Type').kendoTextBox();
            //$popup.find('#Description').kendoTextArea({
            //    rows: 2,
            //    maxLength: 200,
            //    placeholder: ""
            //});

            //$popup.find('#btnSaveModalData').kendoButton({
            //    themeColor: "info",
            //    click: function () {
            //        Alert.confirm("",
            //            "저장하시겠습니까?",
            //            function () {
            //                const fileIds = _this.getUploadedFileIds();
            //                _this.saveDsModel($form, $popup.data("kendoWindow"), fileIds);
            //                _this.makeDbFromFile();
            //                _this.renderGrid("data_detail_grid", "ds_rows_list");
            //            },
            //            function () { }
            //        );
            //    }
            //});

            //$popup.find('#btnCloseModal').kendoButton({
            //    themeColor: "base",
            //    click: function () {
            //        $popup.data('kendoWindow').close();
            //    }
            //});
        }

        // 업로드된 fileId 가져오기
        getUploadedFileIds() {
            if (window.fileUploaderInstance) {
                // 📌 업로드된 모든 파일의 fileId를 가져옴
                const fileIds = Object.values(window.fileUploaderInstance.fileMap).map(file => file.id);
                console.log("업로드된 fileId 목록:", fileIds);
                return fileIds;
            } else {
                console.log("파일 업로더가 초기화되지 않음");
                return [];
            }
        }

        getDsInfo() {
            let _this = this;
            let url = _this.baseUrl;
            let param = {
                action: 'ds_model_info',
                md_id: _this.md_id,
            };

            let result = AjaxUtil.getSyncData(url, param);
            return result
        }

        makeDbFromFile() {
            let _this = this;
            let url = _this.baseUrl;
            let param = {
                action: 'make_db_from_file',
                md_id: _this.md_id,
            };

            let result = AjaxUtil.getSyncData(url, param);
            console.log('makeDbFromFile url, param, result', url, param, result);

            if (result.success) {
                console.log('DB생성.');
            } else {
                Alert.alert('error', 'file -> DB 변환 실패');
            }
        }

        searchMainData() {
            let _this = this;
            let param = {
                action: 'ds_model_tree_list',
                master_type: $('#cboModelType').val(),
                keyword: $('#sch_keyword').val()
            };

            let succFunc = function (result) {
                console.log("result", result);

                // table union 과정에서 id의 고유성이 보장되지 않을 수 있어서 tree용 id를 생성해줌
                // id와 parentId가 동일하면 오류 발생
                let options = {
                    id: 'tree_id',
                    parentId: 'tree_master_id',
                    fields: {
                        tree_id: { field: "tree_id", type:"string" }, // TreeGrid용 고유 ID
                        tree_master_id: { field: "tree_master_id", type:"string", nullable: true }, // TreeGrid용 부모 ID
                    }
                }

                //console.log("options", options);
                _this.modelGrid.setTreeDataSource(result, options);

                console.log("✅ 현재 DataSource 데이터 확인:", _this.modelGrid.getData());

                //console.log("_this.modelGrid", _this.modelGrid);

                //_this.modelGrid.grid.refresh();
                //_this.modelGrid.grid.dataSource.read();

                // _this.modelGrid.expandAll();
                // 잡았다 요놈. 여기서 아래 에러 발생
                //Uncaught NotFoundError: Failed to execute 'replaceChild' on 'Node': The node to be replaced is not a child of this node.

            };
            AjaxUtil.getAsyncData(_this.baseUrl, param, succFunc);
            //AjaxUtil.getAsyncData(_this.baseUrl, param, function (result) {
            //    _this.modelGrid.setData(result);
            //});
        }

        fillCategoryVars() {
            let _this = this;
            let url = _this.baseUrl;
            let param = {
                action: 'cate_col_list',
                md_id: _this.md_id,
            };
            let rows = AjaxUtil.getSyncData(url, param);
            console.log("rows", rows);

            return rows;
        }

        saveDsCol() {
            let _this = this;

            let url = _this.baseUrl + '?action=save_ds_col_preprocess';

            let grid_data = $('#ds_col_grid2').data("kendoGrid").dataSource.data();

            console.log('save_ds_col_preprocess grid_data1', grid_data);

            // 데이터 타입에 따른 결측치 처리 방식 제한
            for (let i = 0; i < grid_data.length; i++) {
                let row = grid_data[i]; // 현재 행(row) 데이터

                // 범주형 데이터(char) → mean, median 사용 금지
                if (row.CategoryCount > 0 && row.Mean == null) {
                    console.log('save_ds_col_preprocess grid_data2-1', grid_data);
                    if (row.MissingValProcess === "mean" || row.MissingValProcess === "median") {
                        console.log('save_ds_col_preprocess grid_data2-2', grid_data);
                        Alert.alert("info", `범주형 데이터(${row.VarName})는 평균(mean) 또는 중위값(median)으로 처리할 수 없습니다. 다른 방식을 선택해 주세요.`);
                        return;
                    }
                }
                // 수치형(연속형) 데이터 → mode 사용 금지
                else if (!row.CategoryCount) {
                    console.log('save_ds_col_preprocess grid_data3-1', grid_data);
                    if (row.MissingValProcess === "mode") {
                        console.log('save_ds_col_preprocess grid_data3-2', grid_data);
                        Alert.alert("info", `수치형 데이터(${row.VarName})는 최빈값(mode)으로 처리할 수 없습니다. 다른 방식을 선택해 주세요.`);
                        return;
                    }
                }
                console.log('save_ds_col_preprocess grid_data4', grid_data);
                // 수치형(이산형) 데이터는 자동으로 통과 (모든 방식 허용)
            }

            let data = {
                md_id: _this.md_id,
                Q: JSON.stringify(grid_data),
            };

            let fnSuccess = function () {
                Notify.success('저장되었습니다');
                _this.renderGrid("ds_col_grid2", "ds_col_list");
            }

            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        saveDsColXY() {
            let _this = this;

            //let _this = this;
            let url = _this.baseUrl + '?action=save_ds_col_xy';

            let grid_data = $('#settingXy_grid').data("kendoGrid").dataSource.data();
            console.log('grid_data', grid_data);

            let yCount = 0; // Y가 선택된 개수를 체크하는 변수

            // forEach문의 경우 중간에 중지 불가.
            //grid_data.forEach(function (item) {
            for (let item of grid_data) {
                item.X = (item.X == 'true' || item.X == 1) ? 1 : 0;
                item.Y = (item.Y == 'true' || item.Y == 1) ? 1 : 0;

                // X = Y인 경우(독립변수와 종속변수가 같은 경우) 경고 메시지 출력 후 저장 중단
                if (item.X == 1 && item.Y == 1) {
                    Alert.alert('error', 'X변수와 Y변수가 같습니다. 다시 선택해주세요.');
                    return; // 🚨 저장 로직 중단
                } 

                if (item.Y === 1) {
                    yCount++; // Y가 선택된 경우 개수 증가
                }
            }

            // Y가 2개 이상 선택된 경우 경고 메시지 출력 후 저장 중단
            if (yCount > 1) {
                Alert.alert('error', 'Y변수는 하나만 선택해야 합니다.');
                return; // 저장 로직 중단
            }
            
            let data = {
                md_id: _this.md_id,
                Q: JSON.stringify(grid_data),
            };

            let fnSuccess = function (result) {
                if (result.message) {
                    let excluded_x = result.message.non_numeric_x;
                    let excluded_y = result.message.non_numeric_y;

                    Alert.alert("info",
                        `수치형 데이터가 아닌 변수는 제외됩니다. 
                        <br/>제외된 X변수: ${excluded_x ? excluded_x : '없음'}
                        <br/>제외된 Y변수: ${excluded_y ? excluded_y : '없음'}`
                    );
                }
                if (result.success) {
                    Notify.success('저장되었습니다');
                }
                _this.renderGrid("settingXy_grid", "ds_col_list");
            }

            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        saveData() {
            //let data = FormUtil.extractForm($('#detailForm'));
            //if (checkForm($('#detailForm')) === false) return;
            AjaxUtil.postAsyncData(this.baseUrl + '?action=save', data, (resp) => {
                if (resp.success) {
                    Notify.success('저장되었습니다.');
                    this.searchMainData();
                } else {
                    Alert.alert('error', resp.message);
                }
            });
        }

        deleteModel() {
            console.log("들어왔니?1");
            let _this = this;

            console.log("_this.md_id", _this.md_id);
            if (_this.md_id) {
                console.log("들어왔니?2");

                AjaxUtil.postAsyncData(this.baseUrl + '?action=delete_ds_model', { md_id: _this.md_id }, (resp) => {
                    if (resp.success) {
                        console.log("들어왔니?3");
                        Notify.success('삭제되었습니다.');
                        _this.searchMainData();
                        _this.renderGrid("data_detail_grid", "ds_rows_list");

                        _this.md_id = null;
                        _this.toggleDataCrudButtons();
                    } else {
                        console.log("들어왔니?4");

                        Alert.alert('error', resp.message);
                    }
                });
            }
        }

        saveTrainConfig() {

        }

        startTrain() {

        }


    }

    let page = new DataSciencePage();

    $(document).ready(function () {
        //page.searchMainData();
    });
</script>
{% endblock %}
