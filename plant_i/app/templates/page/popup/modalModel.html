{% extends "app/layout.html" %}
{% block css %}
<style>
    /* Kendo TextBoxê°€ ë¹„í™œì„±í™”ëœ ìƒíƒœì¼ ë•Œ ìŠ¤íƒ€ì¼ ë³€ê²½ */
    /*.k-textbox.k-disabled {
        background-color: #f0f0f0;*/ /* ë¹„í™œì„±í™”ëœ ìƒíƒœì˜ ë°°ê²½ìƒ‰ */
        /*border: 1px solid #d0d0d0;*/ /* ë¹„í™œì„±í™”ëœ ìƒíƒœì˜ í…Œë‘ë¦¬ ìƒ‰ */
    /*}*/

    /* ëª¨ë‹¬ í‘¸í„° ìŠ¤íƒ€ì¼ */
    .modal-footer {
        padding: 0px 20px;
        margin: 10px 0 0 0;
        text-align: right;
        border-top: 0px solid #dee2e6;
    }

    .upload-container {
        margin: 20px !important; 
    }
    /* ì €ì¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    /*.btn-save {
        background: #ECF5FF !important;
        color: #409EFF !important;
        border-color: #B3D8FF !important;
        border: 1px solid #00a9ff !important;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        min-width: 40px;
        height: 32px;
        line-height: 1;
    }

        .btn-save:hover {
            background-color: #C2DFFF !important;
            border-color: #0054e0 !important;
        }*/

    /* ê¸°ë³¸ ìƒíƒœ (ë””í´íŠ¸) */
    /*.btn-close {
        background: #ECF5FF !important;
        color: #409EFF !important;
        border-color: #B3D8FF !important;
        border: 1px solid #00a9ff !important;
        padding: 5px 12px;
        border-radius: 6px;
        cursor: pointer;
        min-width: 60px;
        height: 32px;
        font-size: 14px;
        text-align: center;
        display: inline-block;
    }*/

        /* ë§ˆìš°ìŠ¤ í˜¸ë²„ ì‹œ (hover) */
        /*.btn-close:hover {
            background-color: #C2DFFF !important;
            border-color: #0054e0 !important;
        }

    .k-button.btn-close {
        background: #ECF5FF !important;
        color: #409EFF !important;
        border-color: #B3D8FF !important;
        border: 1px solid #00a9ff !important;
    }

        .k-button.btn-close:hover {
            background-color: #C2DFFF !important;
            border-color: #0054e0 !important;
        }*/
</style>
{% endblock %}

{% block content %}
<div class="content_wrap">
    <div class="content-ui-row">
        <div class="content-ui-row connect">
            <div class="card-content edit">
                <form id="dsDataForm" class="search-form">
                    <div class="edit-form-ui">
                        <input type="hidden" id="id" name="id">
                        <div class="col-12">
                            <div class="form-item align-h">
                                <label class="k-label k-form-label essential" for="Name" data-labelCd="ëª¨ë¸ëª…">ëª¨ë¸ëª…</label>
                                <div class="field-wrapper">
                                    <input type="text" id="Name" name="Name" data-msg="ëª¨ë¸ëª…ì„" />
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-item align-h">
                                <label class="k-label k-form-label" for="Type" data-labelCd="êµ¬ë¶„">êµ¬ë¶„</label>
                                <div class="field-wrapper">
                                    <input type="text" id="Type" name="Type" />
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-item align-h">
                                <label class="k-label k-form-label" for="DataVersion" data-labelCd="ë°ì´í„° ë²„ì „">ë°ì´í„° ë²„ì „</label>
                                <div class="field-wrapper">
                                    <input id="DataVersion" name="DataVersion"/>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-item align-h">
                                <label class="k-label k-form-label" for="Description" data-labelCd="ë¹„ê³ ">ë¹„ê³ </label>
                                <div class="field-wrapper">
                                    <textarea id="Description" name="Description"></textarea>
                                </div>
                            </div>
                        </div>
                        <!--<div class="col-12">
                        <div class="form-item align-h">
                            <label class="k-label k-form-label" for="da_file_area" data-labelCd="ì²¨ë¶€ëœ ë°ì´í„°(csv)">ì²¨ë¶€ëœ ë°ì´í„°(csv)</label>
                            <div class="field-wrapper">
                                <div id="da_file_area" name="da_file_area"></div>
                            </div>
                        </div>
                    </div>-->
                    </div>
                </form>
                <!-- kendo ì²¨ë¶€íŒŒì¼ -->
                <div class="card-group-btn k-mt-5">
                    <span class="info-text"><i class="material-symbols-outlined">attach_file</i><label data-labelCd="ì²¨ë¶€ëœ ë°ì´í„°(csv)">ì²¨ë¶€ëœ ë°ì´í„°(csv)</label></span>
                </div>
                <div class="form-item align-h">
                    <div class="field-wrapper">
                        <div id="da_file_area" name="da_file_area"></div>
                    </div>
                </div>
                <!--<div class="card-group-btn" style="margin-top:10px">
                <span></span>
                <span>
                    <button id="btnSaveModalData"><i class="material-symbols-outlined">save</i>ì €ì¥</button>
                    <button id="btnCloseModal" class="btn-cancel">ë‹«ê¸°</button>
                </span>
            </div>-->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="btnSaveModalData">ì €ì¥</button>
            <button type="button" id="btnCloseModal">ë‹«ê¸°</button>
            <!--<button type="button" id="btnSaveModalData" class="btn-save">ì €ì¥</button>
            <button type="button" id="btnCloseModal" class="btn-close">ë‹«ê¸°</button>-->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% include 'common/file_upload.html' %}
<script type="text/javascript">
    class PopupModelPage {
        constructor() {
            this.popupData = null;
            this.upload = null;
            this.mm_id = null;
            this.md_id = null;
            this.baseUrl = '/api/ai/learning_data';
            //this.param = null;

            this.init();
        }
        init() {
            let _this = this;

            _this.popupData = window.popupData.param;

            console.log("_this.popupData", _this.popupData);

            _this.mm_id = _this.popupData.mm_id;
            _this.md_id = _this.popupData.md_id;

            $('#Name').kendoTextBox();
            $('#Type').kendoTextBox(/*{ enable: false }*/);
            $('#DataVersion').kendoTextBox(/*{ enable: false }*/);
            $('#Description').kendoTextArea({
                rows: 2,
                maxLength: 200,
                placeholder: ""
            });

            // ì €ì¥ëœ ëª¨ë¸ ì •ë³´ë¥¼ ë¶€ëª¨ì—ê²Œ ë°›ì€ ê²½ìš°(ìˆ˜ì • ì‹œ)
            if (_this.popupData) {
                FormUtil.BindDataForm(_this.popupData.data, $('#dsDataForm'));
            }

            // ì €ì¥ë²„íŠ¼ í´ë¦­ì‹œ
            $('#btnSaveModalData').kendoButton({
                icon: "k-i-save",
                themeColor: "info",
                click: function () {
                    Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                        const fileIds = _this.getUploadedFileIds();
                        _this.saveDsModel(fileIds);
                    });
                }
            });

            $('#btnCloseModal').kendoButton({
                themeColor: "info",
                click: function () {
                    window.popupData.close();
                }
            });

            // ë¶€ëª¨í•œí…Œ ë°›ì•„ì˜¨ dataPkì™€ filemapì´ ì ìš©ë˜ë ¤ë©´ ì´ˆê¸°í™” í•„ìš”
            _this.upload = new FileUploadPage($('#da_file_area'), {
                placeholder: '',
                extensions: ['.csv'],       // í™•ì¥ì
                tableName: 'ds_model',      // í…Œì´ë¸”ëª…
                attachName: 'attach_data',
                others: 'ai\\learning_data',// path
                dataPk: _this.popupData.data ? _this.popupData.data.id : -1,  // í•´ë‹¹ í…Œì´ë¸”ì˜ dataPk
                //dataPk: -1,               // í•´ë‹¹ í…Œì´ë¸”ì˜ dataPk
                height: '100px',
                width: '100%',
                maxFilesCount: 1,           // ìµœëŒ€ íŒŒì¼ ê°œìˆ˜
                maxFileSize: 2000,          // ìµœëŒ€ ìš©ëŸ‰
                allowedDuple: true
            });

        };

        // ì—…ë¡œë“œëœ fileId ê°€ì ¸ì˜¤ê¸°
        getUploadedFileIds() {
            let _this = this;
            if (_this.upload) {
                // ğŸ“Œ ì—…ë¡œë“œëœ ëª¨ë“  íŒŒì¼ì˜ fileIdë¥¼ ê°€ì ¸ì˜´
                const fileIds = Object.values(_this.upload.fileMap).map(file => file.id);
                console.log("ì—…ë¡œë“œëœ fileId ëª©ë¡:", fileIds);
                return fileIds;
            } else {
                console.log("íŒŒì¼ ì—…ë¡œë”ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ");
                return [];
            }
        }

        saveDsModel(fileIds) {
            let _this = this;

            let url = _this.baseUrl + '?action=save_ds_model';

            let data = FormUtil.extractForm($('#dsDataForm'));
            data['mm_id'] = _this.mm_id;
            data['fileId'] = fileIds[0];

            console.log('form data', data);

            if (checkForm($('#dsDataForm')) === false) return;

            let fnSuccess = function (resp) {
                if (resp.success) {
                    // íŒì—… ë‹«ìœ¼ë©´ì„œ ë°ì´í„° ì „ë‹¬
                    window.popupData.close(resp);
                } else {
                    Alert.alert('error', resp.message);
                }
            }

            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }
    };

    $(document).ready(function () {
        page = new PopupModelPage();

        // ë¶€ëª¨ì—ì„œ ì „ë‹¬í•œ param ì ‘ê·¼
        if (window.popupData && window.popupData.param) {
            console.log("ë¶€ëª¨ì—ì„œ ë°›ì€ param:", window.popupData.param);

        }
    });
</script>
{% endblock %}