{% extends "app/layout.html" %}
{% block css %}
<style>
    .chart_border {
        border: 1px solid blue;
    }
</style>
{% endblock %}
{% block content %}
<div class="content_wrap">
    <section class="section">

        <div class="title_box ">
            <div class="left_align">
                <h3 data-labelCd="산점도">산점도</h3>
            </div>

            <button type="button" class="btn-default pull-right " id="btnHedaerFilter" title="필터 보이기/감추기"><i class="fas fa-filter"></i></button>
            <button type="button" class="btn-default pull-right mr-1" id="btnHeaderCompress" title="화면 확대/축소"><i class="fas fa-compress" id="iCompress"></i></button>
        </div>

        <div class="table_box search">

            <div class="row">


                <div class="col-12 col-lg-3 col-xl-3" >
                    <div class="input-group" >
                        <div class="input-group-prepend">
                            <span class="input-group-text fit_box_sm" data-labelCd="일자">일자</span>
                        </div> 
                        <div data-ax5picker="basic" id="srchDt">
                            <div class="input-group-append">
                            <input class="tac " type="text" id="dateFrom" name="dateFrom" />
                                <span class="input-group-text fs-xl">
                                    <i class="fas fa-calendar-alt calendar_color" ></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-3 col-xl-3" >
                    <div class="input-group" >
                        <div class="input-group-prepend">
                            <span class="input-group-text fit_box_t4" data-labelCd="시간">시간</span>
                        </div>
                        <input  type="text" id="timeStart" name="timeStart" class="timepicker tac" style="width: 30%;" />
                        <span class="slow_sign">~</span>
                        <input type="text" id="timeEnd" name="timeEnd" class="timepicker tac" style="width: 30%;" />
                    </div>
                </div>

                <div class="col-11 col-lg-3 col-xl-3" >
                    <div class="input-group">

                        <select id="cboTag" name="cboTag" class="form-control" multiple="multiple" title="태그"></select>
                    </div>
                </div>

                <div class="col-1" >
                        <button type="button" class="btn-default" id="btnSearch" title="조회"><i class="fas fa-search"></i></button>
                </div>

            </div>
        </div>
    </section>
</div>
<div id="chart_sample"></div>
<div class="row" id="divChart">
</div>

{% endblock %}

{% block scripts %}
<script src="/static/resource/apexcharts/apexcharts.3.26.min.js"></script>
<script type="text/javascript">

    class chartScatter {
        constructor(chartId, title, data) {
            //this.grid = null;
            this.chart = null;
            this.chartId = chartId;
            this.title = title;
            this.data = data;
            this.options = null;
            this.init();
        }

        init() {
            let _this = this;

            this.options = {
                series: [
                    {
                        'type':'scatter',
                        //'x': _this.data.x,
                        //'y': _this.data.y,
                        'name': _this.data.name,
                        //'code': _this.data.code,
                        'data': _this.data.scatter_data,
                    },
                    {
                        'type':'line',
                        'name': 'Line',
                        'data': _this.data.line_data,
                    },
                ],
                chart: {
                    height: 350,
                    type: 'line',
                    //zoom: {
                    //    enabled: true,
                    //    type: 'xy'
                    //}
                },
                title: {
                    text: this.title,
                    align: "center"
                },
                fill: {
                  type:'solid',
                },
                markers: {
                  size: [6, 0]
                },
                tooltip: {
                  shared: false,
                  intersect: true,
                },
                legend: {
                  show: false
                },
                xaxis: {
                    type: 'numeric',
                    tickAmount: 10,
                    min: _this.data.min_x,
                    max: _this.data.max_x,
                    labels: {
                        formatter: function (val) {
                            return parseFloat(val).toFixed(_this.data.round_x);
                            //return val;
                        }
                    }
                },
                yaxis: {
                    tickAmount: 10,
                    labels: {
                        formatter: function (val) {
                            return parseFloat(val).toFixed(_this.data.round_y);
                            //return val;
                        }
                    }
                }
            };

            //console.log('options', _this.options);

            var chart = new ApexCharts(document.querySelector("#" + this.chartId), _this.options);
            chart.render();
        }

    }

    let chart_array = [];

    function searchDataBind() {
        let start_date = $('#dateFrom').val() + ' ' + $('#timeStart').val() + ':00';
        let end_date = $('#dateFrom').val() + ' ' + $('#timeEnd').val() + ':00';
        let tag = $('#cboTag').val();
        let tag_codes = tag == null ? '' : tag.join(';');
        let url = '/api/tagdata/scatter_data?action=read';
        let param = {
            start_date: start_date,
            end_date: end_date,
            tag_codes: tag_codes
        };

        let result = AjaxUtil.getSyncData(url, param);
        console.log('result ', result);

        if (result != null) {
            chart_array.forEach(function (item, idx) {
                if (item != null) {
                     if (item.chart) {
                        console.log('chart destroy', idx);
                        item.chart.destroy();
                        item.chart = null;
                    }
                }
            });
            $('#divChart').empty();
            result.forEach(function (tag_data, idx) {
                let tag_cnt = tag.length;
                let sizeVal = 12 / tag_cnt;
                let html = '<div class="col-lg-' + sizeVal + ' col-md-6 col-sm-12"><span id="chartInfo_'+idx+'">Info</span><br/><br/><div id="chart_' + idx + '" class="chart_border"></div></div>'
                //console.log('idx', idx, html);
                $('#divChart').append(html);

                //tag_data = {
                //    code: 'x-y',
                //    name: 'x-y',
                //    x: 'x',
                //    y: 'y',
                //};
                //tag_data.data = [
                //    [16.4, 5.4], [21.7, 2], [25.4, 3], [19, 2], [10.9, 1], [13.6, 3.2], [10.9, 7.4], [10.9, 0], [10.9, 8.2], [16.4, 0]
                //    , [16.4, 1.8], [13.6, 0.3], [13.6, 0], [29.9, 0], [27.1, 2.3], [16.4, 0], [13.6, 3.7], [10.9, 5.2], [16.4, 6.5]
                //    , [10.9, 0], [24.5, 7.1], [10.9, 0], [8.1, 4.7], [19, 0], [21.7, 1.8], [27.1, 0], [24.5, 0]
                //    , [27.1, 0], [29.9, 1.5], [27.1, 0.8], [22.1, 2]
                //];
                    //chart_array[idx] = new chartScatter('chart_' + idx, 'X-Y', tag_data);
                chart_array[idx] = new chartScatter('chart_' + idx, tag_data.name_x + '(X)-' + tag_data.name_y+'(Y)', tag_data);
                ////else
                ////    chart_array[idx] = null;
                //console.log('data', idx, tag_data);
                let text = 'r-square=' + tag_data.r2;
                text += ', p-value=' + tag_data.p;
                if (tag_data.first_equation != '')
                    text += ', ' + tag_data.first_equation;

                $('#chartInfo_' + idx).text(text);
            })

            //console.log('#divChart', $('#divChart'));
        }

    }

    function sample_scatter() {
        let options = {
            series: [
                //{
                //    name: "SAMPLE A",
                //    type: 'scatter',
                //    data: [
                //        [16.4, 5.4], [21.7, 2], [25.4, 3], [19, 2], [10.9, 1], [13.6, 3.2], [10.9, 7.4], [10.9, 0], [10.9, 8.2], [16.4, 0],
                //    ]
                //},
                {
                    name: "SAMPLE B",
                    type: 'scatter',
                    data: [
                        { x: 36.4, y: 13.4 }, { x: 1.7, y: 11 }, { x: 5.4, y: 8 }, { x: 9, y: 17 }, { x: 1.9, y: 4 },
                        { x: 3.6, y: 12.2 }, { x:1.9, y:14.4}, { x:1.9, y:9}, { x:1.9, y:13.2}, { x:1.4, y:7},
                    ]
                },
                //{
                //    name: "SAMPLE C",
                //    type: 'scatter',
                //    data: [
                //        [21.7, 3], [23.6, 3.5], [24.6, 3], [29.9, 3], [21.7, 20], [23, 2], [10.9, 3], [28, 4], [27.1, 0.3], [16.4, 4], 
                //    ]
                //},
                {
                    name: "Line C",
                    type: 'line',
                    data: [
                        { x: 1, y: 2}, { x: 2, y: 3}, { x: 3, y: 4}, { x: 4, y: 3}, { x: 5, y: 20}, 
                        { x:6, y: 2}, { x: 7, y: 3}, { x: 8, y: 4}, { x: 9, y: 0.3}, { x: 10, y: 4}, 
                    ]
                }
            ],
            chart: {
                height: 350,
                type: 'line',
                zoom: {
                    enabled: true,
                    type: 'xy'
                }
            },
            fill: {
              type:'solid',
            },
            markers: {
              size: [6, 0]
            },
            tooltip: {
                shared: false,
                intersect: true,
            },
            legend: {
                show: false
            },
            xaxis: {
                type: 'numeric',
                tickAmount: 10,
                //labels: {
                //  formatter: function(val) {
                //    return parseFloat(val).toFixed(1)
                //  }
                //}
                //min: 0,
                max: 12,
                //tickAmount: 12
            },
            //yaxis: {
            //  tickAmount: 7
            //}
        };

    let options2 = {
        series: [
            {
		      name: 'Points',
		      type: 'scatter',
              data: [
                { x: 36.4, y: 13.4 }, { x: 1.7, y: 11 }, { x: 5.4, y: 8 }, { x: 9, y: 17 }, { x: 1.9, y: 4 },
                { x: 3.6, y: 12.2 }, { x:1.9, y:14.4}, { x:1.9, y:9}, { x:1.9, y:13.2}, { x:1.4, y:7},
              ]
		}, 
	    {
          name: 'Line',
          type: 'line',
            data: [
                       { x: 1, y: 2}, { x: 2, y: 3}, { x: 3, y: 4}, { x: 4, y: 3}, { x: 5, y: 20}, 
                        { x:6, y: 2}, { x: 7, y: 3}, { x: 8, y: 4}, { x: 9, y: 0.3}, { x: 10, y: 4}, 
            ]
        }],
          chart: {
              height: 350,
              type: 'line',
            },
            fill: {
              type:'solid',
            },
            markers: {
              size: [6, 0]
            },
            tooltip: {
              shared: false,
              intersect: true,
            },
            legend: {
              show: false
            },
            xaxis: {
              type: 'numeric',
              min: 0,
              max: 12,
              tickAmount: 12
            }
        };

        var chart = new ApexCharts(document.querySelector("#chart_sample"), options);
        chart.render();
    }

    $(document).ready(function (e) {
        $('#dateFrom').val(CommonUtil.getYYYYMMDD());

        AjaxUtil.fillSelectOptions($('#cboTag'), 'tag', '', false);
        $('select').select2({ tags: true, });
        $('#cboTag').attr("title",'태그');

        $('#srchDt').ax5DatePicker({ direction: 'top' });
        $('#timeStart').timepicker({
            show2400: true,
            timeFormat: 'H:i',
        }).val('09:00');
        $('#timeEnd').timepicker({
            show2400: true,
            timeFormat: 'H:i'
        }).val('18:00');
        $("#btnSearch").click(function (e) { searchDataBind(); });

        //sample_scatter();

    })

</script>
{% endblock %}
