<div id="modalMyWorkPost" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>작업일보 등록</h4>
		</div>
		<div class="modal-body">
			<form id="wo_post_form" name="wo_post_form">
				<!-- 가이드라인 섹션 -->
				<div class="top-section">
					<div class="section-header">
						<h5>
							작성자는 작성 후 검토를 받으려면 "[ ] 작성을 완료함"을 체크하고 [임시저장] 을 누릅니다.</br>
							검토자는 "작업완료" 상태의 작업일보의 검토 후 "[등록완료] 버튼을 누릅니다.
						</h5>
						<div class="button-group">
							<button type="button" class="btn-copy" id="copyWO" name="copyWO">W/O복사</button>
							<button type="button" class="btn-copy" id="copyPM" name="copyPM">PM복사</button>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-md-3">
							<label for="wo_equ_name" class="required">설비</label>
							<button type="button" class="zoombutton" id="selectEquipment" name="selectEquipment"></button>
							<input type="hidden" id="wo_equ_pk" name="equip_pk" data-msg="설비를" />
							<input type="text" class="form-control" id="wo_equ_name" name="equip_nm" readonly placeholder="관련 설비를 선택하세요">
						</div>
						<div class="form-group col-md-3">
							<label>설비위치</label>
							<input type="hidden" id="wo_loc_pk" name="wo_loc_pk" />
							<input type="text" class="form-control" id="wo_loc_nm" name="loc_nm" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>카테고리</label>
							<input type="text" class="form-control" id="equip_category_desc" name="equip_category_desc" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>보증만료일</label>
							<input type="text" class="form-control" id="wo_warranty_dt" name="warranty_dt" readonly>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-md-3">
							<label>WO 번호</label>
							<input type="hidden" id="work_order_pk" name="work_order_pk" />
							<input type="text" class="form-control" id="work_order_no" name="work_order_no" readonly placeholder="작업완료 후 번호 생성">
						</div>
						<div class="form-group second-group col-md-9">
							<label for="wo_work_title" class="required">작업제목</label>
							<input type="text" class="form-control" id="wo_work_title" name="work_title" data-msg="작업제목을" placeholder="200자 이하로 입력하세요">
						</div>
					</div>
					<div class="form-row">
						<div class="form-group second-group col-md-11.4">
							<label for="reqInfo">작업내역</label>
							<textarea id="editor" name="reqInfo" style="height:300px" aria-label="editor"></textarea>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-md-4">
							<label for="wo_work_dept_pk" class="required">작업부서</label>
							<select id="wo_work_dept_pk" name="dept_pk"></select>
						</div>
						<div class="form-group col-md-4">
							<label for="wo_work_charger_pk" class="required">작업담당자</label>
							<select id="wo_work_charger_pk" name="work_charger_pk" data-msg="작업담당자를">
								<option value="">작업담당자를 선택하세요</option>
							</select>
						</div>
						<div class="form-group second-group col-md-4">
							<label for="wo_maint_type_cd" class="required">보전유형</label>
							<select id="wo_maint_type_cd" name="maint_type_cd" data-msg="보전유형을"></select>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-12 col-md-3">
							<label class="required" for="woPostProblem" data-labelCd="현상"></label>
							<button type="button" class="plusbutton" id="addProblem" name="addProblem"></button>
							<select id="woPostProblem" name="woPostProblem" data-msg="현상을"></select>
						</div>
						<div class="form-group col-12 col-md-3">
							<label class="required" for="cause_cd_post" data-labelCd="원인"></label>
							<button type="button" class="plusbutton" id="addCause" name="addCause"></button>
							<select id="cause_cd_post" name="cause_cd_post" data-msg="원인을"></select>
						</div>
						<div class="form-group col-12 col-md-3">
							<label class="required" for="selectRemedy" data-labelCd="조치"></label>
							<button type="button" class="plusbutton" id="addRemedy" name="addRemedy"></button>
							<select id="selectRemedy" name="selectRemedy" data-msg="조치를"></select>
						</div>
						<div class="form-group col-12 col-md-3">
							<label>프로젝트</label>
							<button type="button" class="plusbutton" id="selectProject" name="selectProject"></button>
							<select id="projectName" name="proj_cd"></select>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-12 col-md-3">
							<label>작업구분</label>
							<select id="wcType" name="work_src_cd"></select>
						</div>

						<div class="form-group col-12 col-md-6">
							<label>작업기간 </label>
							<div style="display: flex; align-items: center; gap: 5px;">
								<div class="field-wrapper">
									<input type="date" id="sDayWorkPost" name="sDayWorkPost" style="flex: 1;" disabled>
								</div>
								<span>~</span>
								<div class="field-wrapper">
									<input type="date" id="eDayWorkPost" name="eDayWorkPost" style="flex: 1;" disabled>
								</div>
								<input type="checkbox" id="chkWorkPost" name="chkWorkPost" style="margin: 0 5px;" />
								<label for="chkWorkPost" style="margin: 0;">작성을 완료함</label>
							</div>
						</div>
						<div class="form-group col-12 col-md-3">
							<label>1차 상태평가</label>
							<div class="field-wrapper">
								<select id="primaryCondAssess" name="primaryCondAssess"></select>
							</div>
						</div>
					</div>
				</div>
			</form>

			<!-- 고장부위 컨텐츠 -->
			<div class="grid-content">
				<div class="grid-header">
					<label data-labelCd="고장부위">고장부위</label>
					<button type="button" class="plusbutton" id="breakdownPointAdd" name="breakdownPointAdd"></button>
				</div>
				<div id="breakdownPointGrid"></div>
			</div>

			<!-- 외주업체 컨텐츠 -->
			<div class="grid-content">
				<div class="grid-header" style="display: flex; align-items: center; gap: 8px; justify-content: flex-start;">
					<label data-labelCd="외주업체" style="margin: 0; min-width: 80px;">외주업체</label>
					<select id="selectExSupplier" name="selectExSupplier" style="margin: 0; width: 250px;"></select>
				</div>
				<div id="woExSupplierGrid"></div>
			</div>

			<!-- 작업 인력/자재 컨텐츠 -->
			<div class="grid-content">
				<div class="grid-header" style="display: flex; align-items: center; gap: 8px; justify-content: flex-start;">
					<label data-labelCd="작업인력 또는 직종" style="margin: 0; min-width: 80px;"></label>
					<select id="selJobClass" name="selJobClass" style="margin: 0; width: 250px;">
						<option value="">직종을 선택하세요</option>
					</select>
					<div style="flex:1;"></div>
					<div style="text-align: right;">
						<button class="btn-save" id="setMeAsWork" name="setMeAsWork">나를 작업자로</button>
						<button class="btn-save" id="selWoLabor" name="selWoLabor">작업인력 선택</button>
					</div>
				</div>
				<div id="woLaborGrid"></div>
			</div>

			<!--작업자재 선택-->
			<div class="grid-content">
				<div class="grid-header" style="display: flex; align-items: center; gap: 8px; justify-content: flex-start;">
					<label data-labelCd="작업자재 선택" style="margin: 0; min-width: 80px;"></label>
					<div style="flex:1;"></div>
					<div style="text-align: right;">
						<button class="btn-save" id="selWoMtrl" name="selWoMtrl">자재선택</button>
					</div>
				</div>
				<div id="WoMtrlGrid"></div>
			</div>

			<!--총 작업비용 요약-->
			<div class="cost-content">
				<div class="cost-header">
					<label data-labelCd="총 작업비용 요약">총 작업비용 요약</label>
				</div>
				<div id="totalCostSummary" name="totalCostSummary">
					<div class="cost-item">
						<div class="cost-label">자재비</div>
						<div id="materialCostValuePost" name="materialCostValuePost" class="cost-value">₩ 0</div>
					</div>
					<div class="cost-item">
						<div class="cost-label">인건비</div>
						<div id="laborCostValuePost" name="laborCostValuePost" class="cost-value">₩ 0</div>
					</div>
					<div class="cost-item">
						<div class="cost-label">외주비</div>
						<div id="outsourcingCostValuePost" name="outsourcingCostValuePost" class="cost-value">₩ 0</div>
					</div>
					<div class="cost-item">
						<div class="cost-label">경비</div>
						<input id="expenseValuePost" name="expenseValuePost"
							   class="cost-value expense-input"
							   type="text" value="0"
							   style="text-align:right; font-weight:bold; width:150px; min-width:120px;" />
					</div>
					<div class="cost-item total-cost-item">
						<div class="cost-label">전체비용</div>
						<div id="totalCostValuePost" name="totalCostValuePost" class="cost-value total-cost-value">₩ 0</div>
					</div>
				</div>
			</div>

			<!-- 파일 탭 컨텐츠 -->
			<div id="fileTab">
				{% include 'components/FileUpload.html' with tableName='cm_work_order' attachName='file' dataPk=cm_work_order.work_order_pk|default:'' %}
			</div>

		</div>
		<!-- 버튼 영역 -->
		<div class="modal-footer">
			<button type="button" id="preSaveBtnPost">임시저장</button>
			<button type="button" class="btn-save" id="saveBtnPost">등록완료</button>
			<button type="button" class="btn-close" id="closeWoPost">닫기</button>
		</div>
	</div>
</div>

<!-- 현상 Kendo Window 팝업 -->
<div id="reliabCodesWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="reliabForm">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label for="reliab_cd" class="required">현상코드</label>
					<input type="text" class="form-control" id="reliab_cd" name="reliabCd" placeholder="25자 이하로 입력하세요">
				</div>
				<div class="form-group col-md-6">
					<label for="reliab_nm" class="required">현상코드명</label>
					<input type="text" class="form-control" id="reliab_nm" name="reliabNm" placeholder="50자 이하로 입력하세요">
				</div>
			</div>
		</form>
	</div>
	<div class="grid-section">
		<h5>최근 등록된 현상코드</h5>
		<div id="reliabCodesGrid"></div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveReliabCodes">저장</button>
		<button type="button" class="btn-close" id="btnCloseReliabCodes">닫기</button>
	</div>
</div>

<!-- 원인 Kendo Window 팝업 -->
<div id="reliabCodesWindowCC" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="reliabFormCC">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label for="reliab_cd_cc" class="required">원인코드</label>
					<input type="text" class="form-control" id="reliab_cd_cc" name="reliabCd" placeholder="25자 이하로 입력하세요">
				</div>
				<div class="form-group col-md-6">
					<label for="reliab_nm_cc" class="required">원인코드명</label>
					<input type="text" class="form-control" id="reliab_nm_cc" name="reliabNm" placeholder="50자 이하로 입력하세요">
				</div>
			</div>
		</form>
	</div>
	<div class="grid-section">
		<h5>최근 등록된 원인코드</h5>
		<div id="reliabCodesGridCC"></div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveReliabCodesCC">저장</button>
		<button type="button" class="btn-close" id="btnCloseReliabCodesCC">닫기</button>
	</div>
</div>

<!-- 조치 Kendo Window 팝업 -->
<div id="reliabCodesWindowRC" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="reliabFormRC">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label for="reliab_cd_rc" class="required">조치코드</label>
					<input type="text" class="form-control" id="reliab_cd_rc" name="reliabCd" placeholder="25자 이하로 입력하세요">
				</div>
				<div class="form-group col-md-6">
					<label for="reliab_nm_rc" class="required">조치코드명</label>
					<input type="text" class="form-control" id="reliab_nm_rc" name="reliabNm" placeholder="50자 이하로 입력하세요">
				</div>
			</div>
		</form>
	</div>
	<div class="grid-section">
		<h5>최근 등록된 조치코드</h5>
		<div id="reliabCodesGridRC"></div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveReliabCodesRC">저장</button>
		<button type="button" class="btn-close" id="btnCloseReliabCodesRC">닫기</button>
	</div>
</div>

<!-- 프로젝트 Kendo Window 팝업 -->
<div id="cmProjectWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui" style="height: 60px;">
		<form id="cmProjectForm">
			<div class="form-row">
				<div class="form-group col-md-3">
					<label for="proj_cd" class="required">프로젝트</label>
					<input type="text" class="form-control" id="proj_cd" name="proj_cd" placeholder="25자 이하로 입력하세요">
				</div>
				<div class="form-group col-md-3">
					<label for="proj_nm" class="required">프로젝트명</label>
					<input type="text" class="form-control" id="proj_nm" name="proj_nm" placeholder="50자 이하로 입력하세요">
				</div>
			</div>
			<div class="form-row">
				<label for="proj_cd" class="required">계획 시작일 / 마침일</label>
				<div class="form-group col-md-6" style="display: flex; align-items: center;">
					<input type="date" id="plan_start_dt" name="plan_start_dt" style="flex:1;" />
					<span style="margin: 0 8px;">~</span>
					<input type="date" id="plan_end_dt" name="plan_end_dt" style="flex:1;" />
				</div>
			</div>
		</form>
	</div>
	<div class="grid-section">
		<h5>최근 등록된 프로젝트</h5>
		<div id="cmProjectGrid"></div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveProject">저장</button>
		<button type="button" class="btn-close" id="btnCloseProject">닫기</button>
	</div>
</div>

<!-- W/O복사 Kendo Window 팝업 -->
<div id="woCopyWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<form id="woCopyForm" class="search-form">
		<div class="card-content search">
			<div class="form-ui">
				<div class="col-auto">
					<div class="form-item align-h">
						<label class="k-label k-form-label">검색키워드</label>
						<input id="wo_keyword" name="wo_keyword" class="form-control" placeholder="작업번호,작업제목, 작업내역" style="width: 100%;" />
					</div>
				</div>
				<div class="col-auto">
					<div class="form-item align-h">
						<label class="k-label k-form-label">요청일자</label>
						<input type="date" id="start_dt" name="start_dt" style="flex:1;" />
						<span style="margin: 0 8px;">~</span>
						<input type="date" id="end_dt" name="end_dt" style="flex:1;" />
					</div>
				</div>
				<div class="col-auto">
					<div class="form-item align-h">
						<label for="myRequest">나의 요청만</label>
						<div class="field-wrapper">
							<input id="myRequest" name="myRequest" data-msg="나의 요청만" />
						</div>
					</div>
				</div>
				<div class="col-auto">
					<div class="form-item align-h">
						<button type="button" class="btn-search" id="btnSearchWoCopy" name="btnSearchWoCopy">검색</button>
					</div>
				</div>
			</div>
		</div>
	</form>
	<div class="grid-section">
		<div id="woCopyGrid"></div>
	</div>
	<div class="bottom-area">
		<div class="selected-item" style="margin-top: 5px;">
			<label class="k-label k-form-label" for="sel_work_title" data-labelCd="선택된 항목">선택된 항목</label>
			<input type="hidden" id="sel_work_order_pk" name="work_order_pk">
			<input type="text" style="width:400px;" class="k-input k-textbox k-input-solid k-input-md k-rounded-md" id="sel_work_title" name="work_title" readonly>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn-save" id="btnConfirmWo">확인</button>
			<button type="button" class="btn-close" id="btnCancelWo">취소</button>
		</div>
	</div>
</div>

<!-- 고장부위 Kendo Window 팝업 -->
<div id="reliabCodesWindowFC" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="reliabFormFC">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label for="reliab_cd_fc" class="required">고장부위</label>
					<select id="selectReliabFc" name="selectReliabFc"></select>
				</div>
				<div class="form-group col-md-6">
					<label for="reliab_nm_fc" class="required">원인</label>
					<select id="selectReliabCc" name="selectReliabCc"></select>
				</div>
				<div class="form-group col-md-6">
					<label for="reliab_desc_fc">고장설명</label>
					<textarea id="reliab_desc_fc" name="reliab_desc_fc" style="width: 600px; height: 100px;" placeholder="100자 이하로 입력하세요"></textarea>
				</div>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveReliabCodesFC">저장</button>
		<button type="button" class="btn-close" id="btnCloseReliabCodesFC">닫기</button>
	</div>
</div>


<style>
	.modal-body {
		overflow-y: auto;
	}
	/* 총 작업비용 요약 컨테이너 */
	#totalCostSummary {
		border: 1px solid #00bcd4;
		border-radius: 4px;
		padding: 10px;
		display: flex;
		color: #555;
	}
	.cost-item {
		display: flex;
		align-items: center;
		gap: 2px;
	}
	.cost-value {
		font-weight: bold;
		font-size: 1.1em;
		color: #222;
		background: transparent;
		border: none;
	}
	.expense-input {
		border: none;
		background: transparent;
		font-size: 1.1em;
		outline: none;
		color: #222;
		font-weight: bold;
		text-align: right;
	}
	.cost-won {
		font-weight: bold;
		font-size: 1.1em;
		color: #222;
		margin-right: 2px;
	}
</style>

<script type="text/javascript">
	let myWorkPostPage = null;
	class MyWorkPost {
		constructor() {
			this.baseUrl = '/api/kmms/work_order';
			this.workOrderPk = null; // 작업지시 PK
			this.editable = false;

			this.reliabGrid = null;
			this.reliabGridCC = null;
			this.reliabGridRC = null;
			this.projectGrid = null;
			this.woCopyGrid = null;
			this.selectedRow_wo = null;

			this.init();
		}

		// 부모 페이지 새로고침 함수
		refreshParentPage() {
			try {
				// 1. page 객체가 존재하는 경우
				if (typeof page !== 'undefined' && page.searchMainData) {
					page.searchMainData();
				}
				// 2. window.opener가 존재하는 경우 (팝업에서 열린 경우)
				else if (window.opener && typeof window.opener.page !== 'undefined' && window.opener.page.searchMainData) {
					window.opener.page.searchMainData();
				}
				// 3. 부모 프레임이 존재하는 경우
				else if (window.parent && window.parent !== window && typeof window.parent.page !== 'undefined' && window.parent.page.searchMainData) {
					window.parent.page.searchMainData();
				}
				// 4. 페이지 새로고침
				else {
					location.reload();
				}
			} catch (error) {
				console.warn('부모 페이지 새로고침 실패:', error);
				// 최후의 수단으로 페이지 새로고침
				location.reload();
			}
		}

		init() {
			let _this = this;
			const modal = $("#modalMyWorkPost");

			$("#breakdownPointGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: this.baseUrl,
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'read_breakdown_point', // 실제 API에 맞게 수정 필요
									id: $('#work_order_pk').val()
								};
							}
						}
					},
				}),
				height: 200,
				sortable: true,
				autoBind: false,
				editable: { confirmation: false },
				columns: [
					{ field: "breakdown_code", title: "고장부위코드", width: 100 },
					{ field: "breakdown_name", title: "고장부위명", width: 180 },
					{ field: "cause", title: "원인", width: 120 },
					{ field: "desc", title: "고장 설명", width: 180 },
					{ field: "reg_user", title: "등록자", width: 80 },
					{ field: "reg_date", title: "등록일", width: 100, template: "#= kendo.toString(kendo.parseDate(reg_date), 'yyyy-MM-dd') #" },
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#breakdownPointGrid").data("kendoGrid");
								grid.removeRow(tr);
							}
						},
						title: "삭제",
						width: 50
					}
				],
				noRecords: true,
				messages: {
					noRecords: "조회된 데이터가 없습니다."
				}
			});

			$("#woExSupplierGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: this.baseUrl,
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'read_work_order_supplier',
									id: $('#work_order_pk').val()
								};
							}
						}
					}
				}),
				height: 100,
				sortable: true,
				autoBind: false,
				editable: { confirmation: false },
				columns: [
					{ field: "id", title: "id", hidden: true },
					{ field: "ex_supplier_nm", title: "외주업체명", width: 400 },
					{
						field: "cost",
						title: "비용",
						width: 400,
						editor: currencyEditor,
						template: function(dataItem) {
							if (dataItem.cost == null || dataItem.cost === "") return "";
							var cost = Number(dataItem.cost);
							if (isNaN(cost)) return dataItem.cost;
							return "₩ " + kendo.toString(cost, "n0");
						},
						attributes: { style: "text-align: right;" },
					},
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#woExSupplierGrid").data("kendoGrid");
								grid.removeRow(tr);
							}
						},
						title: "삭제",
						width: 50
					}
				],
				noRecords: true,
				messages: {
					noRecords: "조회된 데이터가 없습니다."
				},
				dataBound: function (e) {
					const count = this.dataSource.total();
					$("#woSupplierCount").text(`(Count: ${count})`);
					updateOutsourcingCostSum(); // 데이터 바인딩 후 합계 갱신
				},
				edit: function(e) {
					if (e.container && e.container.find("input[name='cost']").length > 0) {
						e.container.find("input[name='cost']").on("blur", function() {
							updateOutsourcingCostSum();
						});
					}
				}
			});
			// woExSupplierGrid의 dataSource 변경 시 합계 갱신
			$("#woExSupplierGrid").data("kendoGrid").dataSource.bind("change", function(e) {
				updateOutsourcingCostSum();
			});

			$("#woLaborGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					data: [],
				}),
				height: 200,
				sortable: true,
				autoBind: false,
				editable: { confirmation: false },
				columns: [
					{ field: "job_class_nm", title: "작업자/직종", width: "20%", editable: false},
					{
						field: "labor_price",
						title: "노임단가(시급)",
						width: "20%",
						editor: currencyEditor,
						template: function (dataItem) {
							if (dataItem.labor_price == null || dataItem.labor_price === "") return "";
							var cost = Number(dataItem.labor_price);
							if (isNaN(cost)) return dataItem.labor_price;
							return "₩ " + kendo.toString(cost, "n0");
						},
						attributes: { style: "text-align: right;" },
					},
					{
						field: "worker_nos",
						title: "인원수",
						width: "25%",
						editor: function(container, options) {
							if (options.model.isJobClassRow) {
								numberOnlyEditor(container, options);
							} else {
								$('<input name="' + options.field + '" type="number" class="k-input k-textbox" style="text-align:right; width:100%;" readonly value="1" />').appendTo(container);
							}
						}
					},
					{ field: "work_hr", title: "예상작업시간", width: "15%", attributes: { style: "text-align: right;" }, editor: numberOnlyEditor },
					{ field: "real_work_hr", title: "실제작업시간", width: "15%", attributes: { style: "text-align: right;" }, editor: numberOnlyEditor },
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#woLaborGrid").data("kendoGrid");
								grid.removeRow(tr);
							}
						},
						title: "삭제",
						width: "10%"
					}
				],
				// 추가: 노임단가 입력 후 blur 시 합계 갱신
				edit: function(e) {
					if (e.container && e.container.find("input[name='labor_price']").length > 0) {
						e.container.find("input[name='labor_price']").on("blur", function() {
							updateLaborCostSum();
						});
					}
				},
				// 추가: 데이터 바인딩 후 합계 갱신
				dataBound: function(e) {
					updateLaborCostSum();
				}
			});
			// woLaborGrid의 dataSource 변경 시 합계 갱신
			$("#woLaborGrid").data("kendoGrid").dataSource.bind("change", function(e) {
				updateLaborCostSum();
			});

			$("#WoMtrlGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					data: [],
				}),
				height: 200,
				sortable: true,
				autoBind: false,
				editable: { confirmation: false },
				columns: [
					{ field: "mtrl_cd", title: "자재코드", width: "20%", editable: false },
					{ field: "mtrl_nm", title: "자재명", width: "20%", editable: false },
					{
						field: "unit_price",
						title: "자재단가",
						width: "20%",
						editor: currencyEditor,
						template: function (dataItem) {
							if (dataItem.unit_price == null || dataItem.unit_price === "") return "";
							var cost = Number(dataItem.unit_price);
							if (isNaN(cost)) return dataItem.unit_price;
							return "₩ " + kendo.toString(cost, "n0");
						},
						attributes: { style: "text-align: right;" },
					},					
					{ field: "a_amt", title: "A급 수량", width: "15%", attributes: { style: "text-align: right;" }, editor: numberOnlyEditor },
					{ field: "b_amt", title: "B급 수량", width: "15%", attributes: { style: "text-align: right;" }, editor: numberOnlyEditor },
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#WoMtrlGrid").data("kendoGrid");
								grid.removeRow(tr);
							}
						},
						title: "삭제",
						width: "10%"
					}
				],
				// 추가: 단가, 수량 입력 후 blur 시 합계 갱신
				edit: function(e) {
					if (e.container) {
						e.container.find("input[name='unit_price'], input[name='a_amt'], input[name='b_amt']").on("blur", function() {
							updateMaterialCostSum();
						});
					}
				},
				// 추가: 데이터 바인딩 후 합계 갱신
				dataBound: function(e) {
					updateMaterialCostSum();
				}
			});
			// WoMtrlGrid의 dataSource 변경 시 합계 갱신
			$("#WoMtrlGrid").data("kendoGrid").dataSource.bind("change", function(e) {
				updateMaterialCostSum();
			});

			$("#btnSaveReliabCodes").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#reliabForm"));

					formData.types = 'PC'; // 현상코드 타입 지정
					formData.useYn = 'Y'; // 사용 여부 기본값 Y

					if (!formData.reliabCd || !formData.reliabNm) {
						Alert.alert('', '현상코드와 현상코드명을 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#reliabForm"));
							_this.refreshReliabGrid();
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/reliab_code' + '?action=insert', formData, fnSuccess);
				}
			});

			$("#btnCloseReliabCodes").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#woPostProblem'), 'cm_reliab_codes', 'choose', null, 'PC');
					$("#reliabCodesWindow").data("kendoWindow").close();
				}
			});

			$("#btnSaveReliabCodesCC").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#reliabFormCC"));

					formData.types = 'CC'; // 현상코드 타입 지정
					formData.useYn = 'Y'; // 사용 여부 기본값 Y

					if (!formData.reliabCd || !formData.reliabNm) {
						Alert.alert('', '원인코드와 원인코드명을 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#reliabFormCC"));
							_this.refreshReliabGridCC();
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/reliab_code' + '?action=insert', formData, fnSuccess);
				}
			});

			$("#btnCloseReliabCodesCC").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#cause_cd_post'), 'cm_reliab_codes', 'choose', null, 'CC');
					$("#reliabCodesWindowCC").data("kendoWindow").close();
				}
			});

			$("#btnSaveReliabCodesRC").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#reliabFormRC"));

					formData.types = 'RC'; // 현상코드 타입 지정
					formData.useYn = 'Y'; // 사용 여부 기본값 Y

					if (!formData.reliabCd || !formData.reliabNm) {
						Alert.alert('', '조치코드와 조치코드명을 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#reliabFormRC"));
							_this.refreshReliabGridRC();
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/reliab_code' + '?action=insert', formData, fnSuccess);
				}
			});

			$("#btnCloseReliabCodesRC").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#selectRemedy'), 'cm_reliab_codes', 'choose', null, 'RC');
					$("#reliabCodesWindowRC").data("kendoWindow").close();
				}
			});

			$("#btnSaveReliabCodesFC").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					// 폼 데이터 추출
					let formData = FormUtil.extractForm($("#reliabFormFC"));
					// 필수값 체크
					if (!formData.selectReliabFc) {
						Alert.alert('', '고장부위를 선택하세요.');
						return;
					}
					if (!formData.selectReliabCc) {
						Alert.alert('', '원인을 선택하세요.');
						return;
					}

					// 그리드에 데이터 추가
					var grid = $("#breakdownPointGrid").data("kendoGrid");
					if (grid) {
						grid.dataSource.add({
							breakdown_code: formData.selectReliabFc, // 실제 코드/명칭 매핑 필요시 수정
							breakdown_name: $("#selectReliabFc option:selected").text(),
							cause: $("#selectReliabCc option:selected").text(),
							desc: formData.reliab_desc_fc,
							reg_user: window.currentUserName || '사용자', // 실제 사용자명 변수로 대체
							reg_date: kendo.toString(new Date(), 'yyyy-MM-dd')
						});
					}
					// 폼 리셋 및 팝업 닫기
					FormUtil.resetForm($("#reliabFormFC"));
					$("#reliabCodesWindowFC").data("kendoWindow").close();
				}
			});

			$("#btnCloseReliabCodesFC").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#selectRemedy'), 'cm_reliab_codes', 'choose', null, 'FC');
					$("#reliabCodesWindowFC").data("kendoWindow").close();
				}
			});

			$("#btnSaveProject").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#cmProjectForm"));

					if (!formData.proj_cd || !formData.proj_nm) {
						Alert.alert('', '프로젝트코드와 프로젝트명을 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#cmProjectForm"));
							_this.refreshProjectGrid();
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/project' + '?action=insert', formData, fnSuccess);
				}
			});

			$("#btnCloseProject").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#projectName'), 'cm_project', 'choose', null, null);
					$("#cmProjectWindow").data("kendoWindow").close();
				}
			});

			$("#btnConfirmWo").kendoButton({
				icon: "k-i-check", // 확인 아이콘 (✔️)
				themeColor: "base",
				click: function (e) {
					$("#sel_work_order_pk").val('');
					$("#sel_work_title").val('');

					console.log('data:', _this.selectedRow_wo);
					FormUtil.BindDataForm(_this.selectedRow_wo, $("#wo_post_form"));

					//WO 번호 새로 생성해야 함
					$("#work_order_pk").val('');
					$("#work_order_no").val('');

					FormUtil.resetForm($("#woCopyForm"));
					$("#woCopyWindow").data("kendoWindow").close();
				}
			});

			$("#btnCancelWo").kendoButton({
				icon: "cancel", // 취소 아이콘 (❌)
				themeColor: "base",
				click: function () {
					$("#woCopyWindow").data("kendoWindow").close();
				}
			});

			let reliabGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'reliab_cd', title: '현상코드', width: 80 },
					{
						field: "reliab_nm", title: "현상코드명", width: 150,
					},
					{
						field: 'insert_ts',
						title: '최근  등록일',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(insert_ts), "yyyy-MM-dd HH:mm:ss") #'
					},
				],
				height: "220px"
			};

			_this.reliabGrid = new Grid($("#reliabCodesGrid"), reliabGridOption);

			let reliabGridOptionCC = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'reliab_cd', title: '원인코드', width: 80 },
					{
						field: "reliab_nm", title: "원인코드명", width: 150,
					},
					{
						field: 'insert_ts',
						title: '최근  등록일',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(insert_ts), "yyyy-MM-dd HH:mm:ss") #'
					},
				],
				height: "220px"
			};

			_this.reliabGridCC = new Grid($("#reliabCodesGridCC"), reliabGridOptionCC);

			let reliabGridOptionRC = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'reliab_cd', title: '조치코드', width: 80 },
					{
						field: "reliab_nm", title: "조치코드명", width: 150,
					},
					{
						field: 'insert_ts',
						title: '최근  등록일',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(insert_ts), "yyyy-MM-dd HH:mm:ss") #'
					},
				],
				height: "220px"
			};

			_this.reliabGridRC = new Grid($("#reliabCodesGridRC"), reliabGridOptionRC);

			let projectGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'proj_cd', title: '프로젝트코드', width: 80 },
					{
						field: "proj_nm", title: "프로젝트명", width: 150,
					},
					{
						field: 'insert_ts',
						title: '최근  등록일',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(insert_ts), "yyyy-MM-dd HH:mm:ss") #'
					},
				],
				height: "220px"
			};

			_this.projectGrid = new Grid($("#cmProjectGrid"), projectGridOption);

			let woCopyGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				change: function (e) {
					let selectedRow = this.select();
					if (selectedRow.length > 0) {
						let dataItem = this.dataItem(selectedRow);
						_this.selectedRow_wo = dataItem; // 선택된 행 데이터 저장
						$("#sel_work_order_pk").val(dataItem.work_order_pk);
						$("#sel_work_title").val(dataItem.work_title);
					} else {
						$("#sel_work_order_pk").val('');
						$("#sel_work_title").val('');
					}
				},
				columns: [
					{
						"title": "작업지시번호",
						"field": "work_order_pk",
						"width": "120px",
						"attributes": {
							"style": "text-align: right"
						},
					},
					{
						"title": "작업제목",
						"width": "120px",
						"field": "work_title"
					},
					{
						"title": "설비코드",
						"field": "equip_cd",
						"width": "150px"
					},
					{
						"title": "설비명",
						"field": "equip_nm",
						"width": "150px"
					},
					{
						"title": "작업기간",
						"field": "startendperiod",
						"width": "200px",
						"attributes": {
							"style": "text-align: center"
						}
					},
					{
						"title": "작업부서",
						"field": "equip_dept_nm",
						"width": "120px",
						"attributes": {
							"style": "text-align: center"
						}
					},
					{
						"title": "보전유형",
						"field": "maint_type_nm",
						"width": "100px",
						"attributes": {
							"style": "text-align: center"
						}
					},
					{
						"title": "상태",
						"field": "wo_status_nm",
						"width": "120px",
						"attributes": {
							"style": "text-align: center"
						},
					},
					{
						"title": "요청일",
						"field": "rqst_dt",
						"width": "100px",
						"attributes": {
							"style": "text-align: center"
						}
					},
					{
						"title": "요청자",
						"field": "rqst_user_nm",
						"width": "100px",
						"attributes": {
							"style": "text-align: center"
						}
					},
				],
				height: "400px"
			};

			_this.woCopyGrid = new Grid($("#woCopyGrid"), woCopyGridOption);

			// 데이터 로드 함수
			this.loadPmData = function (pmPk) {
				let param = {
					action: 'read',
					pm_pk: pmPk
				};

				let result = AjaxUtil.getSyncData(this.baseUrl, param);

			};

			AjaxUtil.fillDropDownOptions($('#wo_maint_type_cd'), 'cm_code', 'all', null, 'MAINT_TYPE');
			AjaxUtil.fillDropDownOptions($('#woPostProblem'), 'cm_reliab_codes', 'choose', null, 'PC');
			AjaxUtil.fillDropDownOptions($('#cause_cd_post'), 'cm_reliab_codes', 'choose', null, 'CC');
			AjaxUtil.fillDropDownOptions($('#selectRemedy'), 'cm_reliab_codes', 'choose', null, 'RC');
			AjaxUtil.fillDropDownTreeOptions($("#wo_work_dept_pk"), "depart", "select");
			AjaxUtil.fillDropDownOptions($('#wo_work_charger_pk'), 'cm_user_info', 'choose', null);
			AjaxUtil.fillDropDownOptions($('#cycleType'), 'cm_code', 'choose', null, 'CYCLE_TYPE');
			AjaxUtil.fillDropDownOptions($('#wcType'), 'cm_code', 'choose', 'WS01', 'WS_TYPE');
			AjaxUtil.fillDropDownOptions($('#primaryCondAssess'), 'cm_code', 'choose', 'WS01', 'WS_TYPE');
			AjaxUtil.fillDropDownOptions($('#projectName'), 'cm_project', 'choose', null, null);

			AjaxUtil.fillDropDownOptions($('#selectReliabFc'), 'cm_reliab_codes', 'choose', null, 'FC');
			AjaxUtil.fillDropDownOptions($('#selectReliabCc'), 'cm_reliab_codes', 'choose', null, 'CC');

			AjaxUtil.fillDropDownOptions($('#selectExSupplier'), 'cm_ex_supplier', 'choose', null, null);
			AjaxUtil.fillDropDownOptions($('#selJobClass'), 'cm_job_class', 'choose', null);

			let today = new Date();
			$("#plan_start_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd",
			});

			$("#plan_end_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd"
			});

			$("#sDayWorkPost").kendoDatePicker({
				format: "yyyy-MM-dd",
			});

			$("#eDayWorkPost").kendoDatePicker({
				format: "yyyy-MM-dd"
			});

			$("#chkWorkPost").click();

			$("#start_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd",
			});

			$("#end_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd"
			});

			$("#copyWO").kendoButton({
				icon: "k-i-copy",// 복사 아이콘
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '작업지시(WO) 선택',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '80vw',
						height: '70vh',
					}
					popupComn.openTempPopup($("#woCopyWindow"), options);
					_this.refreshWoCopyGrid();

				}
			});

			$("#copyPM").kendoButton({
				icon: "k-i-copy",// 복사 아이콘
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalPmCopy', { width: '70%', height: '70%' });
					pmCopyPage.show(function (selectedPm) {
						console.log('selectedPm:', selectedPm);

						FormUtil.BindDataForm(selectedPm, $('#pmMasterForm'));

						$("#equip_cd").val(selectedPm.equip_cd);
						$("#equip_nm").val(selectedPm.equip_nm);

					});
				}
			});

			$('#selectEquipment').kendoButton({
				themeColor: "base",
				icon: "k-i-zoom-in", // 줌인 아이콘
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEqu', { width: '70%', height: '70%' });
					equipSelectPage.show(function (data) {
						console.log('equipdata:', data);
						// 선택된 설비 데이터 처리
						$("#wo_equ_pk").val(data.equip_pk);
						$("#wo_equ_name").val(data.equip_nm);
						$("#wo_loc_pk").val(data.loc_pk);
						$("#wo_loc_nm").val(data.loc_nm);
						$("#equip_category_desc").val(data._equip_category_remark);
						$("#wo_warranty_dt").val(data.warranty_dt == undefined ? '보증만료일 없음' : data.warranty_dt);
					});
				}
			});

			$('#addProblem').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '현상코드 등록',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '50vw',
					}
					popupComn.openTempPopup($("#reliabCodesWindow"), options);
					_this.refreshReliabGrid();
				}
			});

			$('#addCause').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '원인코드 등록',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '50vw',
					}
					popupComn.openTempPopup($("#reliabCodesWindowCC"), options);
					_this.refreshReliabGridCC();
				}
			});

			$('#addRemedy').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '조치코드 등록',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '50vw',
					}
					popupComn.openTempPopup($("#reliabCodesWindowRC"), options);
					_this.refreshReliabGridRC();
				}
			});

			$('#selectProject').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '프로젝트 등록',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '50vw',
					}
					popupComn.openTempPopup($("#cmProjectWindow"), options);
					_this.refreshProjectGrid();
				}
			});

			$('#btnSearchWoCopy').kendoButton({
				themeColor: "base",
				icon: "k-i-search",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					_this.refreshWoCopyGrid();
				}
			});

			$("#myRequest").kendoSwitch().data("kendoSwitch");

			$('#breakdownPointAdd').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '고장부위 등록',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '40vw',
						height: '20vw',
					}
					popupComn.openTempPopup($("#reliabCodesWindowFC"), options);
					_this.refreshReliabGridFC();
				}
			});

			$('#addOccupations').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // 기어 아이콘 (설비 관련)
				click: function (e) {
					e.preventDefault();
					$("#modalOccupations").fadeIn();
				}
			});

			$('#selectMaterial').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // 기어 아이콘 (설비 관련)
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalMatMultiSel');
					matMultiSelectPage.show(function (data) {
						console.log('mat_data:', data);

						// 선택된 자재 데이터가 있는지 확인
						if (data && Array.isArray(data) && data.length > 0) {
							$('#materialTable .no-data').remove();
							data.forEach((material, index) => {
								const exists = $('#materialTable tbody tr').not('.no-data').toArray().some(tr =>
									$(tr).data('value') === material._mtrl_pk
								);
								if (!exists) {
									const newRow = `
							<tr data-value="${material._mtrl_pk}">
								<td>${material._mtrl_cd || ''}</td>
								<td>${material._mtrl_nm || ''}</td>
								<td>
									<input type="number"
										   class="form-control form-control-sm text-end"
										   min="0"
										   step="1"
										   value="1"
										   placeholder="수량 입력"
										   name="amt"/>
								</td>
								<td>${material._ant_unit_cd || material._ant_unit_nm || 'EA'}</td>
								<td class="text-center">
									<button type="button" class="btn-delete" onclick="deleteMaterialRow(this)">×</button>
								</td>
							</tr>
						`;
									$('#materialTable tbody').append(newRow);
								} else {
									Alert.alert('', '이미 추가된 자재입니다.');
								}
							});
						} else if (data && !Array.isArray(data)) {
							const material = data;
							const exists = $('#materialTable tbody tr').not('.no-data').toArray().some(tr =>
								$(tr).data('value') === material._mtrl_pk
							);
							if (!exists) {
								$('#materialTable .no-data').remove();
								const newRow = `
						<tr data-value="${material._mtrl_pk}">
							<td>${material._mtrl_cd || ''}</td>
							<td>${material._mtrl_nm || ''}</td>
							<td>
								<input type="number"
									   class="form-control form-control-sm text-end"
									   min="0"
									   step="1"
									   value="1"
									   placeholder="수량 입력"
									   name="amt"/>
							</td>
							<td>${material._ant_unit_cd || material._ant_unit_nm || 'EA'}</td>
							<td class="text-center">
								<button type="button" class="btn-delete" onclick="deleteMaterialRow(this)">×</button>
							</td>
						</tr>
					`;
								$('#materialTable tbody').append(newRow);
							} else {
								Alert.alert('', '이미 추가된 자재입니다.');
							}
						}
					});
				}
			});	

			$('#setMeAsWork').kendoButton({
				themeColor: "base",
				icon: "k-i-zoom-in", // 줌인 아이콘
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					const grid = $("#woLaborGrid").data("kendoGrid");
					if (!grid) return;

					// 현재 로그인 사용자 정보
					console.log(userinfo);				
					const user_nm = userinfo.username;
					var param = {
						action: 'getCurrentDept',
					};					
					const dept_nm = AjaxUtil.getSyncData('/api/system/depart', param).items.dept_nm;
					const womtrl = user_nm + ' (' + dept_nm + ')';

					// 이미 추가된 작업자인지 확인 (user_nm+dept_nm 기준)
					const exists = grid.dataSource.data().some(item => item.womtrl === womtrl);
					if (exists) {
						Alert.alert('', '이미 추가된 작업자입니다.');
						return;
					}

					grid.dataSource.add({
						job_class_nm: womtrl,
						labor_price: 0,
						worker_nos: 1,
						work_hr: 0,
						real_work_hr: 0,
						isReadOnly: true
					});
				}
			});

			$('#selWoLabor').kendoButton({
				themeColor: "base",
				icon: "k-i-zoom-in", // 줌인 아이콘
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalManMulti', { width: '40%', height: '60%' });
					woLoborMultiSelPage.show(function (data) {					
						let dataArr = Array.isArray(data) ? data : [data];
						const grid = $("#woLaborGrid").data("kendoGrid");
						if (!grid) return;

						dataArr.forEach(function(user) {
							let user_pk = user.user_pk;
							let user_dept_nm = user.user_nm + (user.dept_nm ? ' (' + user.dept_nm : '') + ')';

							// 이미 추가된 작업자인지 확인 (user_pk 기준)
							const exists = grid.dataSource.data().some(item => item.user_pk === user_pk);
							if (exists) {
								// 이미 추가된 경우는 건너뜀
								return;
							}

							grid.dataSource.add({
								user_pk: user_pk,
								job_class_nm: user_dept_nm, // 작업자/직종 컬럼에 user_dept_nm 값 사용
								labor_price: 0,
								worker_nos: 1,
								work_hr: 0,
								real_work_hr: 0,
								isReadOnly: true
							});
						});
					});
				}
			});

			$('#selWoMtrl').kendoButton({
				themeColor: "base",
				icon: "k-i-zoom-in", // 줌인 아이콘
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalMatMultiSel', { width: '70%', height: '70%' });
					matMultiSelectPage.show(function (data) {
						console.log('data:', data);				
						let dataArr = Array.isArray(data) ? data : [data];
						const grid = $("#WoMtrlGrid").data("kendoGrid");
						if (!grid) return;

						dataArr.forEach(function (mat) {
							let mat_pk = mat._mtrl_pk;					
							// 이미 추가된 자재인지 확인 (mat_pk 기준)
							const exists = grid.dataSource.data().some(item => item.mat_pk === mat_pk);
							if (exists) {
								// 이미 추가된 경우는 건너뜀
								return;
							}

														grid.dataSource.add({
								mtrl_cd: mat._mtrl_cd,
								mtrl_nm: mat._mtrl_nm,
								unit_price: mat._unit_price,
								a_amt: 0,
								b_amt: 0,
							});
						});
					});
				}
			});

			// ESC 키 누를 때 모달 닫기
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) { // ESC key
					modal.fadeOut();
				}
			});

			$("#preSaveBtnPost").kendoButton({
				icon: "k-i-save",
				themeColor: "gray",
				click: function (e) {
					e.preventDefault();
					_this.saveData('temp');
				},
				themeColor: "none"
			});

			$("#saveBtnPost").kendoButton({
				click: function (e) {
					e.preventDefault();
					_this.saveData();
				},
				themeColor: "none"
			});

			// 모달 닫기 - 닫기 버튼 클릭
			$('#closeWoPost').kendoButton({
				click: function (e) {
					e.preventDefault();
					FormUtil.resetForm($('#wo_post_form'));
					modal.fadeOut();
				}
			});

			// 탭 이벤트 초기화 추가
			_this.initTabEvents();

			// 에디터 기능입니다. 컴포넌트로 분리작업 필요합니다.
			var editor = $("#editor").kendoEditor({
				tools: [
					"undo",
					"redo",
					{ name: "separator1", type: "separator" },
					{
						name: "fontName",
						items: [
							{ text: "Arial", value: "Arial" },
							{ text: "Georgia", value: "Georgia" },
							{ text: "Helvetica", value: "Helvetica" },
							{ text: "Impact", value: "Impact" },
							{ text: "Tahoma", value: "Tahoma" },
							{ text: "Times New Roman", value: "\"Times New Roman\"" },
							{ text: "Verdana", value: "Verdana" },
						]
					},
					"fontSize",
					"bold",
					"italic",
					"underline",
					"backColor",
					"foreColor",
					{ name: "separator2", type: "separator" },
					"insertUnorderedList",
					"justifyLeft",
					"justifyCenter",
					"justifyRight",
					{ name: "separator3", type: "separator" },
					"formatting",
					{ name: "separator4", type: "separator" },
					"createLink",
					"unlink",
					"insertImage"
				]
			});

			// 외주업체 선택 시 그리드에 추가
			$('#selectExSupplier').on('change', function () {
				const supplierId = $(this).val();
				const supplierName = $('#selectExSupplier option:selected').text();

				if (!supplierId) return; // 선택 안 했으면 무시

				// 그리드 객체 가져오기
				const grid = $("#woExSupplierGrid").data("kendoGrid");
				if (!grid) return;

				// 이미 추가된 업체인지 확인
				const exists = grid.dataSource.data().some(item => item.ex_supplier_nm === supplierName);
				if (exists) {
					Alert.alert('', '이미 추가된 외주업체입니다.');
					return;
				}

				// 그리드에 데이터 추가
				grid.dataSource.add({
					ex_supplier_nm: supplierName,
					cost: 0 // 또는 기본값
				});

				// 선택 초기화(원하면)
				$(this).val('');
			});
		}

		saveData(temp) {
			let _this = this;
			let data = FormUtil.extractForm($('#wo_post_form'));
			data.BeforeStatus = 'WOS_RW';//사후 등록일 경우는 요청작성중
			data.AfterStatus = 'WOS_CL';//WO완료
			if (temp === 'temp') {
				data.tempSave = 'Y'; // 임시저장 플래그 설정
			}		

			if (checkForm($('#wo_post_form')) === false) return;

			if (!data.dept_pk) {
				Alert.alert('', '작업부서를 선택해주세요.');
				return;
			}

			// 고장부위 데이터 추출
			let breakdownPointGrid = $("#breakdownPointGrid").data("kendoGrid");
			if (breakdownPointGrid) {
				let gridData = breakdownPointGrid.dataSource.data();
				let woFaultLocArray = [];

				gridData.forEach(function (item) {
					woFaultLocArray.push({
						fault_loc_cd: item.fault_loc_cd,
						fault_loc_nm: item.fault_loc_nm,
						cause_cd: item.cause_cd,
						cause_nm: item.cause_nm,
						fault_loc_desc: item.fault_loc_desc,
						inserter_id: item.inserter_id,
						inserter_nm: item.inserter_nm,
						insert_dt: item.insert_dt
					});
				});

				// 배열을 JSON 문자열로 변환하여 전송
				data.woFaultLoc = JSON.stringify(woFaultLocArray);
			}

			// 외주업체 데이터 추출
			let woExSupplierGrid = $("#woExSupplierGrid").data("kendoGrid");
			if (woExSupplierGrid) {
				let gridData = woExSupplierGrid.dataSource.data();
				let woSupplierArray = [];

				gridData.forEach(function (item) {
					woSupplierArray.push({
						ex_supplier_pk: item.ex_supplier_pk,
						ex_supplier_nm: item.ex_supplier_nm,
						cost: item.cost,
					});
				});

				// 배열을 JSON 문자열로 변환하여 전송
				data.woSupplier = JSON.stringify(woSupplierArray);
			}

			//작업인력 또는 직종
			let woLaborGrid = $("#woLaborGrid").data("kendoGrid");
			if (woLaborGrid) {
				let gridData = woLaborGrid.dataSource.data();
				let woLaborArray = [];

				gridData.forEach(function (item) {
					woLaborArray.push({
						emp_pk: item.emp_pk,
						labor_price: item.labor_price,
						worker_nos: item.worker_nos,
						work_hr: item.work_hr,
						real_work_hr: item.real_work_hr,
						job_class_pk: item.job_class_pk,
					});
				});

				// 배열을 JSON 문자열로 변환하여 전송
				data.woLabor = JSON.stringify(woLaborArray);
			}

			//작업자재
			let WoMtrlGrid = $("#WoMtrlGrid").data("kendoGrid");
			if (WoMtrlGrid) {
				let gridData = WoMtrlGrid.dataSource.data();
				let WoMtrlArray = [];

				gridData.forEach(function (item) {
					WoMtrlArray.push({
						mtrl_pk: item.mtrl_pk,
						unit_price: item.unit_price,
						a_amt: item.a_amt,
						b_amt: item.b_amt,
					});
				});

				// 배열을 JSON 문자열로 변환하여 전송
				data.woMtrl = JSON.stringify(WoMtrlArray);
			}

			data.mtrlCost = $("#materialCostValuePost").text().replace(/[^\d.-]/g, '') || '0';
			data.laborCost = $("#laborCostValuePost").text().replace(/[^\d.-]/g, '') || '0';
			data.outsideCost = $("#outsourcingCostValuePost").text().replace(/[^\d.-]/g, '') || '0';
			data.etcCost = $("#expenseValuePost").text().replace(/[^\d.-]/g, '') || '0';
			data.totCost = $("#totalCostValuePost").text().replace(/[^\d.-]/g, '') || '0';

			let funcSucc = function (resp) {
				if (resp.success) {
					//파일 저장
					const result = fetchSomeData();

					Alert.alert('', resp.message);
					FormUtil.resetForm($("#wo_post_form"));
					$("#editor").data("kendoEditor").value('');
					$("#work_order_pk").val('');
					if (window.fileUploader && typeof window.fileUploader.clearFiles === 'function') {
						window.fileUploader.dataPk = '';
						window.fileUploader.clearFiles();
					}
					AjaxUtil.fillDropDownOptions($('#wo_maint_type_cd'), 'cm_code', 'all', 'MAINT_TYPE_BM', 'MAINT_TYPE');
					AjaxUtil.fillDropDownOptions($('#wcType'), 'cm_code', 'choose', 'WS01', 'WS_TYPE');

					$("#modalMyWorkPost").fadeOut();

					// 부모 페이지 새로고침
					_this.refreshParentPage();

				} else {
					Alert.alert('error', resp.message);
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_post', data, funcSucc);

		}

		// 탭 전환 이벤트 핸들러
		initTabEvents() {
			let _this = this;

			$('.tab-button').on('click', function (e) {
				e.preventDefault()
				const tabId = $(this).data('tab');
				$('.tab-button').removeClass('active').removeAttr('style');
				$(this).addClass('active').css({
					'background': '#1e4f88',
					'color': 'white',
					'border-color': '#1e4f88'
				});
				if (tabId) $('#' + tabId).addClass('active').show();
			});
		}

		show(woId) {
			let _this = this;
			_this.workOrderPk = woId;

			if (_this.workOrderPk == undefined) {
				this.editable = false;
			} else {
				this.editable = true;

				// 1. 상세 정보
				let param = {
					action: 'findOneWo',
					workOrderPk: _this.workOrderPk,
				};

				let woData = AjaxUtil.getSyncData(_this.baseUrl, param);
				console.log('woData:', woData)
				FormUtil.BindDataForm(woData, $('#wo_post_form'));
				var decoded = $('<div/>').html(woData.req_info || '').text();

				$("#editor").data("kendoEditor").value(decoded);

			}

			$("#modalMyWorkPost").fadeIn();
		}

		refreshReliabGrid() {
			let param = {
				action: 'findAll',
				types: 'PC', // 현상코드 타입
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/reliab_code', param);
			let kendoGrid = $("#reliabCodesGrid").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

		refreshReliabGridCC() {
			let param = {
				action: 'findAll',
				types: 'CC', // 현상코드 타입
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/reliab_code', param);
			let kendoGrid = $("#reliabCodesGridCC").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

		refreshReliabGridRC() {
			let param = {
				action: 'findAll',
				types: 'RC', // 현상코드 타입
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/reliab_code', param);
			let kendoGrid = $("#reliabCodesGridRC").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

		refreshReliabGridFC() {
			let param = {
				action: 'findAll',
				types: 'FC', // 현상코드 타입
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/reliab_code', param);
			let kendoGrid = $("#reliabCodesGridFC").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

		refreshProjectGrid() {
			let param = {
				action: 'findAll',
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/project', param);
			let kendoGrid = $("#cmProjectGrid").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

		refreshWoCopyGrid() {
			let data = FormUtil.extractForm($('#woCopyForm'));
			let param = {
				action: 'findSel',
				keywords: data.wo_keyword,
				startDate: data.start_dt,
				endDate: data.end_dt,
				isMine: data.myRequest,
			};
			let result = AjaxUtil.getSyncData('/api/kmms/work_order', param);
			let kendoGrid = $("#woCopyGrid").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}
	}

	myWorkPostPage = new MyWorkPost();
	$(document).ready(function () {
		// 체크박스 기본값: 체크 해제
		$('#chkWorkPost').prop('checked', false);
		// Kendo DatePicker 인스턴스 비활성화
		if ($('#sDayWorkPost').data('kendoDatePicker')) {
			$('#sDayWorkPost').data('kendoDatePicker').enable(false);
		}
		if ($('#eDayWorkPost').data('kendoDatePicker')) {
			$('#eDayWorkPost').data('kendoDatePicker').enable(false);
		}
		// 체크박스 상태에 따라 input 활성/비활성
		$('#chkWorkPost').on('change', function () {
			if ($(this).is(':checked')) {
				if ($('#sDayWorkPost').data('kendoDatePicker')) {
					$('#sDayWorkPost').data('kendoDatePicker').enable(true);
				}
				if ($('#eDayWorkPost').data('kendoDatePicker')) {
					$('#eDayWorkPost').data('kendoDatePicker').enable(true);
				}
			} else {
				if ($('#sDayWorkPost').data('kendoDatePicker')) {
					$('#sDayWorkPost').data('kendoDatePicker').enable(false);
				}
				if ($('#eDayWorkPost').data('kendoDatePicker')) {
					$('#eDayWorkPost').data('kendoDatePicker').enable(false);
				}
			}
		});

		// selJobClass 선택 시 woLaborGrid에 추가
		$('#selJobClass').on('change', function () {
			const job_class_pk = $(this).val();
			const job_class_nm = $('#selJobClass option:selected').text();

			if (!job_class_pk) return;

			const grid = $("#woLaborGrid").data("kendoGrid");
			if (!grid) return;

			// 이미 추가된 직종인지 확인
			const exists = grid.dataSource.data().some(item => item.job_class_pk === job_class_pk);
			if (exists) {
				Alert.alert('', '이미 추가된 직종입니다.');
				return;
			}

			// 그리드에 데이터 추가 (초기값을 숫자 0으로)
			grid.dataSource.add({
				job_class_pk: job_class_pk,
				job_class_nm: job_class_nm,
				labor_price: 0,
				worker_nos: 1,
				work_hr: 0,
				real_work_hr: 0,
				isJobClassRow: true
			});

			$(this).val('');
		});

		$("#expenseValuePost").on("input", function() {
			formatCurrencyInput(this);
		});
		// 페이지 진입 시 초기 포맷
		formatCurrencyInput(document.getElementById("expenseValuePost"));
		
	});

	function showMainFileFromUploader() {
		if (!window.fileUploader) return;

		const fileDataList = window.fileUploader.getFilesData();
		const mainFile = fileDataList.find(file => file); // 첫 번째 파일

		const container = document.querySelector('#modalEquipMaster .file-container');
		if (container) {
			if (mainFile) {
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #1e4f88;"></i>
						<div style="margin-top: 10px; color: #333;">${mainFile.name}</div>
						<div style="color: #666; font-size: 12px;">${formatFileSize(mainFile.size)}</div>
					</div>
				`;
			} else {
				// fallback 파일 표시
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #999;"></i>
						<div style="margin-top: 10px; color: #999;">No file</div>
					</div>
				`;
			}
		}
	}

	function formatFileSize(bytes) {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}

	function fetchSomeData() {
		try {
			if (window.fileUploader && typeof window.fileUploader.saveFiles === 'function' && window.fileUploader.getFilesData && window.fileUploader.getFilesData().length > 0) {
				const fileResult = window.fileUploader.saveFiles();
			}
		} catch (error) {
			console.error('Error:', error);
			alert(error.message);
			throw error;
		}
	}

	// 화폐 입력란 에디터
	function currencyEditor(container, options) {
		$('<input name="' + options.field + '" type="text" class="k-input k-textbox" style="text-align:right; width:100%;" />')
			.appendTo(container)
			.on('input', function() {
				this.value = this.value.replace(/[^0-9]/g, '');
			});
		$('<span style="position:absolute; right:16px; top:8px; color:#888; pointer-events:none;">₩</span>').appendTo(container);
	}
	// 숫자만 입력 에디터
	function numberOnlyEditor(container, options) {
		$('<input name="' + options.field + '" type="number" min="0" class="k-input k-textbox" style="text-align:right; width:100%;" />')
			.appendTo(container)
			.on('input', function() {
				this.value = this.value.replace(/[^0-9]/g, '');
			});
	}

	// 외주비 합계 계산 함수 추가
	function updateOutsourcingCostSum() {
		var grid = $("#woExSupplierGrid").data("kendoGrid");
		if (!grid) return;
		var data = grid.dataSource.data();
		var sum = 0;
		data.forEach(function(item) {
			var cost = Number(item.cost);
			if (!isNaN(cost)) sum += cost;
		});
		$("#outsourcingCostValuePost").text("₩ " + kendo.toString(sum, "n0"));
		updateTotalCostValue();
	}

	// 작업 인건비 합계 계산 함수 추가
	function updateLaborCostSum() {
		var grid = $("#woLaborGrid").data("kendoGrid");
		if (!grid) return;
		var data = grid.dataSource.data();
		var sum = 0;
		data.forEach(function(item) {
			var cost = Number(item.labor_price);
			if (!isNaN(cost)) sum += cost;
		});
		$("#laborCostValuePost").text("₩ " + kendo.toString(sum, "n0"));
		updateTotalCostValue();
	}

	// 자재비 합계 계산 함수 추가
	function updateMaterialCostSum() {
		var grid = $("#WoMtrlGrid").data("kendoGrid");
		if (!grid) return;
		var data = grid.dataSource.data();
		var sum = 0;
		data.forEach(function(item) {
			var unit = Number(item.unit_price);
			var a = Number(item.a_amt);
			var b = Number(item.b_amt);
			if (isNaN(unit)) unit = 0;
			if (isNaN(a)) a = 0;
			if (isNaN(b)) b = 0;
			sum += unit * a + unit * b;
		});
		$("#materialCostValuePost").text("₩ " + kendo.toString(sum, "n0"));
		updateTotalCostValue();
	}

	// 전체비용 합계 함수 추가
	function updateTotalCostValue() {
		var material = 0, labor = 0, outsourcing = 0, expense = 0;
		material = Number($("#materialCostValuePost").text().replace(/[^0-9]/g, '')) || 0;
		labor = Number($("#laborCostValuePost").text().replace(/[^0-9]/g, '')) || 0;
		outsourcing = Number($("#outsourcingCostValuePost").text().replace(/[^0-9]/g, '')) || 0;
		expense = getExpenseValueNumber();
		var total = material + labor + outsourcing + expense;
		$("#totalCostValuePost").text("₩ " + kendo.toString(total, "n0"));
	}

	// 경비 입력란 화폐 자동 포맷 함수
	function formatCurrencyInput(input) {
		let val = input.value.replace(/[^0-9]/g, '');
		if (val === '') val = '0';
		input.value = '₩ ' + Number(val).toLocaleString();
		updateTotalCostValue();
	}
	// 합계 계산 시 숫자만 추출
	function getExpenseValueNumber() {
		return Number($("#expenseValuePost").val().replace(/[^0-9]/g, '')) || 0;
	}

</script>
