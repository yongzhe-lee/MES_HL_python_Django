

<div id="modalPiMaster" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>ì ê²€ ë§ˆìŠ¤í„° ë“±ë¡</h4>
		</div>

		<div class="modal-body">
			<div class="equipment-section">
				<div class="section-header"  style="display: flex; justify-content: flex-end;">					
					<div class="button-group">
						<button type="button" class="btn-copy" id="copyPi" name="copyPi">
							ì ê²€ë³µì‚¬
						</button>
					</div>
				</div>

			<!-- ê³„íš ì„¹ì…˜2 -->
			<div class="section">
				<div class="tab-group">
					<button class="active">ê³„íš</button>
					<button>ì ê²€ì„¤ë¹„</button>
					<button>ì ê²€í•­ëª©</button>
					<button>ì‘ì—…ê²°ê³¼ ëª©ë¡</button>
					<button>ì‘ì—… WO ëª©ë¡</button>
				</div>
				<div class="tab-content">
					<!-- ê³„íš íƒ­ ì»¨í…ì¸  -->
					<form id="piMasterForm">
						<input type="hidden" id="pm_pk" name="pm_pk">
						<div class="plan-content">
							<div class="form-row">
								<div class="form-group col-6">
									<label>ì ê²€ë²ˆí˜¸</label>
									<input type="text" class="form-control" id="pmNumber" name="pmNumber" placeholder="ì ê²€ë²ˆí˜¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤" readonly>
								</div>
								<div class="form-group col-6">
									<label>ì ê²€ëª… <span class="required">*</span></label>
									<input type="text" class="form-control" id="piName" name="piName" placeholder="100ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”">
								</div>
							</div>
							<div class="form-row">
								<!-- ì˜¤ë¥¸ìª½ cycleInfo ì˜ì—­ -->
								<!-- ì£¼ê¸°ë‹¨ìœ„ -->
								<div class="form-group col-4">
									<label>ì£¼ê¸°ë‹¨ìœ„ <span class="required">*</span></label>
									<select id="cycleType" name="cycleType">
									</select>
								</div>
								<div class="form-group col-4">
									<label>ë°˜ë³µ <span class="required">*</span></label>
									<div class="field-wrapper" style="display:flex">
										<span class="mt-2" style="margin-left: 5px;">ë§¤</span>
										<input id="perNumber" name="perNumber" type="number" class="form-control" />
									</div>
								</div>
								<!-- ì£¼ê¸°ì‹œì‘ì¼ -->
								<div class="form-group col-4">
									<label>ì£¼ê¸°ì‹œì‘ì¼ <span class="required">*</span></label>
									<div class="field-wrapper">
										<input type="date" id="schedStartDt" name="schedStartDt" class="form-control" />
									</div>
								</div>
							</div>
							<div class="form-row">
								<div class="form-group col-6">
									<label>ì ê²€ë¶€ì„œ <span class="required">*</span></label>
									<select id="executionDept" name="executionDept">
									</select>
								</div>
								<div class="form-group col-6">
									<label>ì ê²€ë‹´ë‹¹ì <span class="required">*</span></label>
									<select id="piManager" name="piManager">
										<option value="">ì ê²€ ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
									</select>
								</div>
							</div>
							<div class="form-group col-12">
								<label>ì‘ì—…ì§€ì¹¨</label>
								<textarea class="form-control" id="work_text" name="work_text" placeholder="2000ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”" maxlength="2000"></textarea>
								<div class="char-count">0 / 2000 bytes</div>
							</div>
						</div>
					</form>


					<!-- ì ê²€ì„¤ë¹„ ëª©ë¡ íƒ­ ì»¨í…ì¸  -->
					<div id="piEquip" class="pmwo-content" style="display: none;">
						<div class="section-header" style="display: flex; justify-content: flex-end;">
							<div class="button-group">
								<button type="button" class="btn-equipment" id="selectEquipment" name="selectEquipment">
									ì„¤ë¹„ì„ íƒ
								</button>
							</div>
						</div>
						<!--<div id="piEquipGrid"></div>-->
						<div class="grid">
							<table class="table" id="equipTable">
								<thead>
									<tr style="border-top: 2px solid #343a40;">
										<th>ì„¤ë¹„ì½”ë“œ</th>
										<th>ì„¤ë¹„ëª…</th>
										<th>ìœ„ì¹˜</th>
										<th>ì¹´í…Œê³ ë¦¬</th>
										<th>ì¤‘ìš”ë„</th>
										<th>ìƒíƒœ</th>
										<th>ì‚­ì œ</th>
										<th style="display: none">equipPk</th>
										<th style="display: none">ì„¤ë¹„ì‹ ê·œì¶”ê°€ì—¬ë¶€</th>
									</tr>
								</thead>
								<tbody>
									<tr class="no-data">
										<td colspan="7">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
									</tr>
								</tbody>
							</table>
						</div>

					</div>

					<!-- ì ê²€í•­ëª© ëª©ë¡ íƒ­ ì»¨í…ì¸  -->
					<div id="piCheckItem" class="pmwo-content" style="display: none;">
						<div class="section-header" style="display: flex; justify-content: flex-end;">
							<div class="button-group">
								<button type="button" class="btn-equipment" id="addCheckItem" name="addCheckItem">
									ì ê²€í•­ëª©ì¶”ê°€
								</button>
							</div>
						</div>
						<div id="piCheckItemGrid"></div>
					</div>

	
					<!-- PM WO ëª©ë¡ íƒ­ ì»¨í…ì¸  -->
					<div id="pmWorkOrderContent" class="pmwo-content" style="display: none;">
						<div id="pmWorkOrderGrid"></div>
					</div>
				</div>
			</div>
			

			<!-- ë²„íŠ¼ ì˜ì—­ -->
			<div class="modal-footer">
				<button type="button" class="btn-save" id="saveBtn">ì €ì¥</button>
				<button type="button" class="btn-close" id="closePmModal">ë‹«ê¸°</button>
			</div>
		</div>
	</div>
	</div>
</div>
  
<style>

	/* ì„¤ë¹„ì„ íƒ, PMë³µì‚¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.modal .btn-equipment, .btn-copy {
		background: #1e4f88 !important;
		color: white !important;
		border: none !important;
	}

	.modal .btn-equipment:hover, .btn-copy:hover {
		background-color: #2980b9;
	}

	.section {
		background: #fff;
		margin-bottom: 20px;
		height: auto;
	}

    /*
	.form-row {
		display: flex;
		gap: 20px;
		margin-bottom: 15px;
	}

	.form-group {
		flex: 1;
		min-width: 0;
		margin-bottom: 10px;
	}

	.form-group:first-child {
		flex: 0.8;
	}

	.form-group:last-child {
		flex: 1.2;
	}

	.form-group label {
		font-size: 13px;
		font-weight: 600;
		color: #2c3e50;
		margin-bottom: 5px;
	}

	.form-control {
		font-size: 13px;
		padding: 8px 12px;
		border: 1px solid #ddd;
		border-radius: 4px;
		transition: border-color 0.2s;
	}
*/
	.form-control:focus {
		border-color: #3498db;
		box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
	}

/*
	.required {
		color: #e74c3c;
		margin-left: 3px;
	}
*/
	

	textarea {
		min-height: 150px;
		resize: vertical;
	}

	.char-count {
		text-align: right;
		color: #666;
		font-size: 12px;
		margin-top: 3px;
		padding-right: 5px;
	}

	.section-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 10px;
	}

	.grid {
		width: 100%;
		margin-bottom: 20px;
	}

	.table {
		width: 100%;
		min-width: 800px;
		border-collapse: collapse;
	}

		.table th, .table td {
			padding: 8px;
			border: 1px solid #ddd;
			text-align: center;
		}

		.table th {
			font-size: 13px;
			font-weight: 600;
			color: #2c3e50;
		}

		.table td {
			font-size: 13px;
			color: #34495e;
		}

	.no-data td {
		text-align: center;
		padding: 20px;
		color: #666;
	}

	.pagination {
		display: flex;
		justify-content: center;
		align-items: center;
		gap: 10px;
		padding: 10px;
	}

	.page-size {
		margin-left: 10px;
	}

	.total-count {
		margin-left: 10px;
		color: #666;
	}

	

	

	

	/* íˆ´íŒ ìŠ¤íƒ€ì¼ */
	.section-title {
		position: relative;
		display: flex;
		align-items: center;
	}

		.section-title h4 {
			margin: 0;
			display: flex;
			align-items: center;
		}

	/* ëŠë‚Œí‘œ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
	.info-badge {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 20px;
		height: 20px;
		background: #e9ecef;
		border-radius: 50%;
		margin-left: 5px;
		cursor: help;
		position: relative;
	}

		.info-badge i {
			font-size: 12px;
			color: #666;
		}

	/* íˆ´íŒ ìŠ¤íƒ€ì¼ */
	.tooltip {
		display: none;
		position: absolute;
		top: 100%;
		left: 0;
		width: 400px;
		background: #fff;
		border: 1px solid #ddd;
		box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		border-radius: 4px;
		padding: 15px;
		z-index: 1000;
		margin-top: 10px;
	}

		.tooltip h5 {
			color: #333;
			margin: 0 0 10px 0;
			font-size: 14px;
		}

	.tooltip-content {
		font-size: 13px;
		line-height: 1.5;
	}

		.tooltip-content p {
			margin: 5px 0;
		}

		.tooltip-content .highlight {
			background-color: #e9ecef;
			padding: 2px 5px;
			border-radius: 3px;
		}

	/* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ íˆ´íŒ í‘œì‹œ */
	.info-badge:hover .tooltip {
		display: block;
	}

	/* íˆ´íŒ í™”ì‚´í‘œ */
	.tooltip:before {
		content: '';
		position: absolute;
		top: -6px;
		left: 10px;
		width: 10px;
		height: 10px;
		background: #fff;
		border-left: 1px solid #ddd;
		border-top: 1px solid #ddd;
		transform: rotate(45deg);
	}

	/* íˆ´íŒ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
	.tooltip-icon {
		color: #6c757d;
		font-size: 14px;
		margin-left: 5px;
		cursor: help;
		position: relative;
	}

		/* íˆ´íŒ ìŠ¤íƒ€ì¼ */
		.tooltip-icon[data-tooltip]:hover::after {
			content: attr(data-tooltip);
			position: absolute;
			left: 50%;
			transform: translateX(-50%);
			bottom: 100%;
			width: max-content;
			max-width: 300px;
			padding: 8px 12px;
			border-radius: 4px;
			background-color: #2c3e50;
			color: white;
			font-size: 12px;
			font-weight: normal;
			z-index: 1000;
			white-space: nowrap;
		}

		/* íˆ´íŒ í™”ì‚´í‘œ */
		.tooltip-icon[data-tooltip]:hover::before {
			content: '';
			position: absolute;
			left: 50%;
			transform: translateX(-50%);
			bottom: 100%;
			border: 6px solid transparent;
			border-top-color: #2c3e50;
			margin-bottom: -12px;
		}

	

	

	#modalPiMaster {
		z-index: 1000 !important; /* âœ… ë¶€ëª¨ ëª¨ë‹¬ì˜ z-index */
	}

	#pmMasterTabs {
		margin-bottom: 20px;
	}

		#pmMasterTabs button {
			padding: 10px 20px;
			margin-right: 5px;
			border: 1px solid #ddd;
			background: #f5f5f5;
			cursor: pointer;
		}

			#pmMasterTabs button.active {
				background: #007bff;
				color: white;
				border-color: #0056b3;
			}

			#pmMasterTabs button:hover {
				background: #e9ecef;
			}

			#pmMasterTabs button.active:hover {
				background: #0056b3;
			}

    /* Kendo ë²„íŠ¼ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    .k-button-custom-save .k-button {
        background: #ECF5FF !important;
        color: #409EFF !important;
        border-color: #B3D8FF !important;
        border: 1px solid #00a9ff !important;
        padding: 6px 12px !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        min-width: 40px !important;
        height: 28px !important;
        line-height: 1 !important;
    }

        .k-button-custom-save .k-button:hover {
            background-color: #C2DFFF !important;
            border-color: #0054e0 !important;
        }











    /* ëŒ€ìƒì„¤ë¹„ ì„¹ì…˜ ì „ìš© ìŠ¤íƒ€ì¼ */
    .equipment-section {
        background: #fff;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
    }

        /* ì²« ë²ˆì§¸ form-rowì˜ input ë„ˆë¹„ ì¡°ì • */
        .equipment-section .form-row:first-child .form-group {
            flex: 1;
        }

        /* ë‘ ë²ˆì§¸ form-rowì˜ input ë„ˆë¹„ ë™ì¼í•˜ê²Œ ì¡°ì • */
        .equipment-section .form-row:last-child .form-group {
            flex: 1;
        }

	/* ì§ì¢… í…Œì´ë¸” ê´€ë ¨ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
	#jobClassTable .btn-delete {
		background: none;
		border: none;
		color: #dc3545;
		font-size: 18px;
		cursor: pointer;
		padding: 0 5px;
	}

		#jobClassTable .btn-delete:hover {
			color: #c82333;
		}

	#jobClassTable input[type="number"] {
		width: 100%;
		padding: 4px 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
	}

</style>

<script type="text/javascript">
	let piMasterPage = null;
	class PiMaster {
		constructor() {
			this.grid = null;
			this.baseUrl = '/api/kmms/pi_master';

			this.resetForm = this.resetForm.bind(this);
			this.init();
		}

		init() {
			let _this = this;
			const modal = $("#modalPiMaster");

			// cycleInfo í‘œì‹œ ì—¬ë¶€ ì²´í¬ í•¨ìˆ˜
			this.checkCycleInfo = function () {
				const pmTypeValue = $('#pmType').val();
				if (pmTypeValue === 'PM_TYPE_TBM') {
					$('#cycleInfo').show();
				} else {
					$('#cycleInfo').hide();
				}
			};

			// ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
			this.loadPmData = function (pmPk) {
				let param = {
					action: 'read',
					pm_pk: pmPk
				};

				let result = AjaxUtil.getSyncData(this.baseUrl, param);
				if (result) {
					// FormUtil.fillForm($('#piMasterForm'), result);
					// ë°ì´í„° ë¡œë“œ ì§í›„ cycleInfo ì²´í¬
					setTimeout(() => this.checkCycleInfo(), 0);
				}
			};

			// ëª¨ë‹¬ì´ í‘œì‹œë  ë•Œë§ˆë‹¤ cycleInfo ì²´í¬
			modal.on('show', function () {
				_this.checkCycleInfo();
			});

			AjaxUtil.fillDropDownOptions($('#pmType'), 'user_code', 'choose', null, 'PM_TYPE');
			AjaxUtil.fillDropDownTreeOptions($("#executionDept"), "depart", "select");
			AjaxUtil.fillDropDownOptions($('#piManager'), 'auth_user', 'choose', null);
			AjaxUtil.fillDropDownOptions($('#cycleType'), 'user_code', 'choose', null, 'CYCLE_TYPE');

			let today = CommonUtil.getYYYYMMDD();
			$("#schedStartDt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd",
			});

			//ì„¤ë¹„ì„ íƒ
			$('#selectEquipment').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // ê¸°ì–´ ì•„ì´ì½˜ (ì„¤ë¹„ ê´€ë ¨)
				click: function (e) {
					e.preventDefault();
                    console.log("main selectEquipment button click");
					$("#modalEqus").fadeIn();
				}
			});

            $('#addCheckItem').kendoButton({
                themeColor: "base",
                icon: "k-i-plus", // ê¸°ì–´ ì•„ì´ì½˜ (ì„¤ë¹„ ê´€ë ¨)
                click: function (e) {
                    e.preventDefault();
                    $("#modalEqus").fadeIn();
                }
            });
			


			$("#copyPi").kendoButton({
				icon: "k-i-copy",// ë³µì‚¬ ì•„ì´ì½˜
				click: function (e) {
					e.preventDefault();
					$("#modalPmCopy").fadeIn();
				}
			});

			$('#addOccupations').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // ê¸°ì–´ ì•„ì´ì½˜ (ì„¤ë¹„ ê´€ë ¨)
				click: function (e) {
					e.preventDefault();
					$("#modalOccupations").fadeIn();
				}
			});

			$('#selectMaterial').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // ê¸°ì–´ ì•„ì´ì½˜ (ì„¤ë¹„ ê´€ë ¨)
				click: function (e) {
					e.preventDefault();
					$("#modalMaterials").fadeIn();
				}
			});

			// ESC í‚¤ ëˆ„ë¥¼ ë•Œ ëª¨ë‹¬ ë‹«ê¸°
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) { // ESC key
					modal.fadeOut();
				}
			});

			$("#saveBtn").kendoButton({
				icon: "k-i-save",
				click: function (e) {
					e.preventDefault();
					_this.saveData();
				},
				themeColor: "none"
			}).closest(".k-button").css({
				"background": "#ECF5FF",
				"color": "#409EFF",
				"border-color": "#B3D8FF",
				"border": "1px solid #00a9ff",
				"padding": "6px 12px",
				"border-radius": "4px",
				"cursor": "pointer",
				"min-width": "40px",
				"height": "28px",
				"line-height": "1"
			}).hover(
				function () {
					$(this).css({
						"background-color": "#C2DFFF",
						"border-color": "#0054e0"
					});
				},
				function () {
					$(this).css({
						"background": "#ECF5FF",
						"border-color": "#B3D8FF"
					});
				}
			);

			// ëª¨ë‹¬ ë‹«ê¸° - ë‹«ê¸° ë²„íŠ¼ í´ë¦­
			$('#closePmModal').kendoButton({
				click: function (e) {
					e.preventDefault();
					modal.fadeOut();
				}
			});

			AjaxUtil.fillDropDownOptions($('#selJobClass'), 'job_class', 'choose', null);

		}

		saveData() {
			let _this = this;
			let data = FormUtil.extractForm($('#piMasterForm'));
			data.dept_pk = $("#executionDept").data("kendoDropDownTree").value();
			data.piManager = $("#piManager").val();
			
			// ìœ íš¨ì„± ê²€ì‚¬
			if (!$('#piName').val()) {
				Alert.alert('', 'ì ê²€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
				return;
			}

			if (!data.dept_pk) {
				Alert.alert('', 'ì ê²€ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}

			if (!data.piManager) {
				Alert.alert('', 'ì ê²€ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}

			// ì£¼ê¸°ì‹œì‘ì¼,ì£¼ê¸°ë‹¨ìœ„,ë°˜ë³µ
			const schedStartDt = $("#schedStartDt").val();
			const cycleType = $("#cycleType").val();
			const perNumber = $("#perNumber").val();

			if (!schedStartDt || !cycleType || !perNumber) {
				Alert.alert('', 'ì£¼ê¸° ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
				return;
			}

			data.sched_start_dt = schedStartDt;
			data.cycle_type = cycleType;
			data.per_number = perNumber;

            const workText = $("#work_text").val();
			data.work_text = workText;

			let funcSucc = function (resp) {
				if (resp.success) {
					// ê¸°ë³¸ ì •ë³´ ì €ì¥ ì„±ê³µ ì‹œ ì‘ì—… ì¸ë ¥ ì €ì¥ ì§„í–‰
					// choi : ì¼ë‹¨ ì œê±°
					//_this.savePmLalor(resp);
				} else {
					Alert.alert('error', resp.message);
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, funcSucc);
			$("#modalPiMaster").fadeOut();
		}

		resetData() {
			let _this = this;
			FormUtil.resetForm($('#piMasterForm'));
			// í¼ ë¦¬ì…‹ í›„ cycleInfo ì²´í¬
			this.checkCycleInfo();
		}

		savePmLalor(resp) {
			let _this = this;
			let jobClassData = [];
			$('#jobClassTable tbody tr').not('.no-data').each(function () {
				const job_class_pk = $(this).data('value');
				let work_hr = $(this).find('input[type="number"]').val();
				work_hr = work_hr || 0;
				jobClassData.push({
					job_class_pk: job_class_pk,
					work_hr: work_hr
				});
			});

			// ì‘ì—… ì¸ë ¥ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë°”ë¡œ ìì¬ ì €ì¥ìœ¼ë¡œ ì§„í–‰
			if (jobClassData.length === 0) {
				_this.savePmMtrl(resp);
				return;
			}

			let data = {
				job_classes: JSON.stringify(jobClassData),
				pm_pk: resp.id
			};

			let funcSucc2 = function (resp2) {
				if (resp2.success) {
					_this.savePmMtrl(resp);
				} else {
					Alert.alert('error', resp2.message);
				}
			}

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_job_classes', data, funcSucc2);
		}

		savePmMtrl(resp) {			
			let _this = this;
			let materialData = [];
			$('#materialTable tbody tr').not('.no-data').each(function () {				
				const mat_pk = $(this).data('value');				
				let mtrl_qty = $(this).find('input[type="number"]').val();
				mtrl_qty = mtrl_qty || 0;
				materialData.push({
					mat_pk: mat_pk,
					mtrl_qty: mtrl_qty
				});
			});
			
			// ìì¬ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë°”ë¡œ ì™„ë£Œ ì²˜ë¦¬
			if (materialData.length === 0) {
				_this.finalizeSave();
				return;
			}
		
			let data = {
				materials: JSON.stringify(materialData),
				pm_pk: resp.id
			};

			let funcSucc3 = function (resp3) {
				if (resp3.success) {
					_this.finalizeSave();
				} else {
					Alert.alert('error', resp3.message);
				}
			}

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_materials', data, funcSucc3);
		}

		finalizeSave() {
			Notify.success('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
			this.resetData();
			page.searchMainData();
		}

		searchLocationData() {
			let _this = this;

			let param = {
				action: 'read',
			};

			let result = AjaxUtil.getSyncData(_this.baseUrl, param);
			_this.grid.setData(result);
			// ë°ì´í„° ë¡œë“œ í›„ cycleInfo ì²´í¬
			this.checkCycleInfo();
		}

		resetForm() {
			// í¼ ë¦¬ì…‹ ì‹œ cycleInfo ì²´í¬
			this.checkCycleInfo();
		}

		//pm ë§ˆìŠ¤í„°
		getPmMasterModal(pmId) {
			let _this = this;

			// 1. PM ìƒì„¸ ì •ë³´ API í˜¸ì¶œ
			let param = {
				action: 'detail',
				id: pmId,
			};
			let pmData = AjaxUtil.getSyncData(_this.baseUrl, param);

			// 2. PM ì‘ì—… ì¸ë ¥ API í˜¸ì¶œ
			let param2 = {
				action: 'detail_pm_labor',
				id: pmId,
			};
			let pmDataLabor = AjaxUtil.getSyncData(_this.baseUrl, param2);

			// 3. PM í•„ìš”ìì¬ API í˜¸ì¶œ
			let param3 = {
				action: 'detail_pm_mtrl',
				id: pmId,
			};
			let pmDataMtrl = AjaxUtil.getSyncData(_this.baseUrl, param3);

			// 1.1. ê¸°ì¡´ ë°ì´í„° ë°”ì¸ë”©
			piMasterPage.bindPmMasterData(pmData);

			// 2.1. ì‘ì—…ì¸ë ¥ í…Œì´ë¸” ì´ˆê¸°í™” ë° ë°ì´í„° ë°”ì¸ë”©
			$('#jobClassTable tbody').empty();

			if (Array.isArray(pmDataLabor) && pmDataLabor.length > 0) {
				pmDataLabor.forEach((labor, index) => {

					// null ì²´í¬ë¥¼ í¬í•¨í•œ ì•ˆì „í•œ ë°ì´í„° ì ‘ê·¼
					const id = labor?.id || '';
					const job_class_pk = labor?.job_class_pk || '';
					const job_class_nm = labor?.job_class_nm || '';
					const work_hr = labor?.work_hr || '';

					const newRow = `
                        <tr data-value="${job_class_pk}">
                            <td>${index + 1}</td>
                            <td style="display: none;">${job_class_pk}</td>
                            <td>${job_class_nm}</td>
                            <td>
                                <input type="number"
                                       class="form-control form-control-sm text-end"
                                       min="0"
                                       step="0.5"
                                       placeholder="ì‹œê°„ ì…ë ¥"
                                       value="${work_hr}" />
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn-delete" onclick="deleteJobClassRow(this)">Ã—</button>
                            </td>
                        </tr>
                    `;
					$('#jobClassTable tbody').append(newRow);
				});
			} else {
				console.log("ğŸ“Œ [ERROR] ì‘ì—…ì¸ë ¥ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ:", pmDataLabor);
			}

			// 3.1. í•„ìš”ìì¬ í…Œì´ë¸” ì´ˆê¸°í™” ë° ë°ì´í„° ë°”ì¸ë”©
			$('#materialTable tbody').empty();  // ê¸°ì¡´ í…Œì´ë¸” ì´ˆê¸°í™”

			if (Array.isArray(pmDataMtrl) && pmDataMtrl.length > 0) {
				pmDataMtrl.forEach((mtrl, index) => {

					// null ì²´í¬ë¥¼ í¬í•¨í•œ ì•ˆì „í•œ ë°ì´í„° ì ‘ê·¼
					const mat_pk = mtrl?.mat_pk || '';
					const mat_cd = mtrl?.mat_cd || '';
					const mat_nm = mtrl?.mat_nm || '';
					const amt = mtrl?.amt || '0';  // ê¸°ë³¸ê°’ ì„¤ì •
					const unit = mtrl?.BasicUnit || '';

					const newRow = `
                        <tr data-value="${mat_pk}">
                            <td>${mat_cd}</td>
                            <td>${mat_nm}</td>
                            <td>
                                <input type="number"
                                       class="form-control form-control-sm text-end"
                                       min="0"
                                       step="1"
                                       value="${amt}"
                                       placeholder="ìˆ˜ëŸ‰ ì…ë ¥"
                                       name="amt"/>
                            </td>
                            <td>${unit}</td>
                            <td class="text-center">
                                <button type="button" class="btn-delete" onclick="deleteMaterialRow(this)">Ã—</button>
                            </td>
                        </tr>
                    `;
					$('#materialTable tbody').append(newRow);  // materialTableë¡œ ìˆ˜ì •
				});
			} else {
				console.log("ğŸ“Œ [ERROR] í•„ìš”ìì¬ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ:", pmDataMtrl);
			}

			$("#modalPiMaster").fadeIn();
		}

		/**
		 * PM ë§ˆìŠ¤í„° ë°ì´í„°ë¥¼ ëª¨ë‹¬ í¼ì— ë°”ì¸ë”©í•˜ëŠ” í•¨ìˆ˜
		 * @param {Object} pmData - PM ë§ˆìŠ¤í„° ìƒì„¸ ë°ì´í„°
		 */
		bindPmMasterData(pmData) {
			// ê¸°ë³¸ í•„ë“œ ë°”ì¸ë”©
			const basicFields = {
				'equip_pk': pmData.equip_pk,
				'pm_pk': pmData.pm_pk,
				'pmNumber': pmData.pm_no,
				'piName': pmData.pm_nm,
				'work_text': pmData.work_text,
				'equ_code': pmData.equ_code,
				'equ_name': pmData.equ_name,
				'equ_loc': pmData.equ_location,
				'equ_import': pmData.import_rank,
				'equ_status': pmData.Status,
				'equ_env_yn': pmData.environ_equip_yn,
				'maintenanceTime': pmData.work_expect_hr,
				'perNumber': pmData.per_number,
				'schedStartDt': pmData.sched_start_dt
			};

			// ê¸°ë³¸ í•„ë“œ ê°’ ì„¤ì •
			Object.entries(basicFields).forEach(([id, value]) => {
				$(`#${id}`).val(value);
			});

			// Kendo ë“œë¡­ë‹¤ìš´ ì»´í¬ë„ŒíŠ¸ ë°”ì¸ë”©
			const kendoDropdowns = [
				{
					id: 'executionDept',
					type: 'kendoDropDownTree',
					value: pmData.exec_dept
				},
				{
					id: 'piManager',
					type: 'kendoDropDownList',
					value: pmData.pm_manager
				},
				{
					id: 'pmType',
					type: 'kendoDropDownList',
					value: pmData.pm_type
				},
				{
					id: 'cycleType',
					type: 'kendoDropDownList',
					value: pmData.cycle_type
				}
			];

			kendoDropdowns.forEach(dropdown => {
				const component = $(`#${dropdown.id}`).data(dropdown.type);
				if (component) {
					component.one("dataBound", function () {
						component.value(dropdown.value);
						component.trigger("change");

						if (!component.value()) {
							component.text(dropdown.value);
						}
					});
					component.dataSource.read();
				}
			});
		}   
	}

	function deleteRow(btn) {
		const tr = $(btn).closest('tr');
		tr.remove();

		// ëª¨ë“  í–‰ì´ ì‚­ì œë˜ì—ˆì„ ë•Œ no-data í–‰ ì¶”ê°€
		if ($('tbody tr').length === 0) {
			$('tbody').append(`
			<tr class="no-data">
				<td colspan="4">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
			</tr>
		`);
		}

		// ìˆœë²ˆ ì¬ì •ë ¬
		$('tbody tr:not(.no-data)').each((index, tr) => {
			$(tr).find('td:first').text(index + 1);
		});
	}

	piMasterPage = new PiMaster();
	$(document).ready(function () {

		// pmType ì„ íƒ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
		$('#pmType').on('change', function () {
			piMasterPage.checkCycleInfo();
		});

		// ëª¨ë‹¬ì´ í‘œì‹œë  ë•Œë§ˆë‹¤ cycleInfo ì²´í¬ (jQuery fadeIn ë°©ì‹)
		const originalFadeIn = $.fn.fadeIn;
		$.fn.fadeIn = function () {
			if (this.attr('id') === 'modalPiMaster') {
				setTimeout(() => piMasterPage.checkCycleInfo(), 0);
			}
			return originalFadeIn.apply(this, arguments);
		};

		// íƒ­ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
		$('.tab-group button').on('click', function () {
			// ëª¨ë“  íƒ­ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
			$('.tab-group button').removeClass('active');
			// í´ë¦­ëœ íƒ­ì— active í´ë˜ìŠ¤ ì¶”ê°€
			$(this).addClass('active');

			// ëª¨ë“  ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
            $('#piMasterForm, #piEquip,  #piCheckItem, #pmWorkOrderContent').hide();

			// íƒ­ ë‚´ìš© ì „í™˜
			var tabName = $(this).text().trim();
			switch (tabName) {
				case 'ê³„íš':
					$('#piMasterForm').show();
					break;
                case 'ì ê²€ì„¤ë¹„':
                    $('#piEquip').show();
                    break;
				case 'ì ê²€í•­ëª©':
                    $('#piCheckItem').show();
					break;
				case 'PM WO ëª©ë¡':
					$('#pmWorkOrderContent').show();
					// PM WO ëª©ë¡ íƒ­ ì„ íƒ ì‹œì—ë§Œ ë°ì´í„° ë¡œë“œ
					var grid = $("#pmWorkOrderGrid").data("kendoGrid");
					var pmPk = $('#pm_pk').val();
					if (grid && pmPk) {
						console.log("Loading PM WO data for pm_pk:", pmPk);
						grid.dataSource.read();
					} else {
						console.log("Grid or pm_pk not available:", { grid: !!grid, pmPk: pmPk });
					}
					break;
			}
		});

		// ì´ˆê¸° ìƒíƒœ: ê³„íš íƒ­ í™œì„±í™”
		$('.tab-group button:first').click();

		// ê¸€ììˆ˜ ì¹´ìš´íŠ¸ ê¸°ëŠ¥
		$('#work_text').on('input', function () {
			const maxLength = 1000;
			const currentLength = $(this).val().length;
			$('.char-count').text(`${currentLength} / ${maxLength} bytes`);

			// ìµœëŒ€ ê¸€ììˆ˜ ì²´í¬
			if (currentLength > maxLength) {
				$(this).val($(this).val().substring(0, maxLength));
			}
		});

		let rowCount = 0;

		$('#selJobClass').on('change', function () {
			const selectedValue = $(this).val();
			if (!selectedValue) return;

			const selectedText = $(this).find('option:selected').text();

			// ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì§ì¢…ì¸ì§€ í™•ì¸
			const exists = $('#jobClassTable tbody tr').not('.no-data').toArray().some(tr =>
				$(tr).find('td:nth-child(3)').text() === selectedText
			);

			if (exists) {
				Alert.alert('', 'ì´ë¯¸ ì¶”ê°€ëœ ì§ì¢…ì…ë‹ˆë‹¤.');
				$(this).val('');
				return;
			}

			// no-data í–‰ ì œê±°
			$('#jobClassTable .no-data').remove();

			// í˜„ì¬ í–‰ ìˆ˜ ê³„ì‚°
			rowCount = $('#jobClassTable tbody tr').length + 1;

			const newRow = `
				<tr data-value="${selectedValue}">
					<td>${rowCount}</td>
					<td style="display: none;">${selectedValue}</td>
					<td>${selectedText}</td>
					<td>
						<input type="number" 
							class="form-control form-control-sm text-end"
							min="0" 
							step="1"
							oninput="this.value"
							placeholder="ì‹œê°„ ì…ë ¥"/>
					</td>
					<td class="text-center">
						<button type="button" class="btn-delete" onclick="deleteJobClassRow(this)">Ã—</button>
					</td>
				</tr>
			`;

			$('#jobClassTable tbody').append(newRow);
			$(this).val(''); // ì„ íƒ ì´ˆê¸°í™”
		});


        $("#piEquipGrid").kendoGrid({
            dataSource: new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "/api/kmms/pi_master",
                        dataType: "json",
                        contentType: "application/json",
                        data: function () {
                            return {
                                action: 'read_equip',
                                pm_pk: $('#pm_pk').val()
                            };
                        }
                    }
                },
                schema: {
                    data: function (response) {
                        console.log("Grid Response:", response);
                        if (Array.isArray(response)) {
                            return response;
                        }
                        return [];
                    }
                },
                pageSize: 30,
                requestStart: function () {
                    console.log("DataSource request starting with pm_pk:", $('#pm_pk').val());
                }
            }),
            height: 550,
            sortable: true,
            pageable: true,
            autoBind: false, // ìë™ ë°ì´í„° ë°”ì¸ë”© ë¹„í™œì„±í™”
            columns: [
                { field: "equipCd", title: "ì„¤ë¹„ì½”ë“œ", width: 120 },
                { field: "equipNm", title: "ì„¤ë¹„ëª…", width: 120, format: "{0:yyyy-MM-dd}" },
                { field: "locNm", title: "ìœ„ì¹˜", width: 100 },
                { field: "equipCategoryDesc", title: "ì¹´í…Œê³ ë¦¬", width: 120, format: "{0:yyyy-MM-dd}" },
                { field: "importRankCd", title: "ì¤‘ìš”ë„", width: 120, format: "{0:yyyy-MM-dd}" },
                { field: "equipStatusNm", title: "ìƒíƒœ", width: 100 },
				{ field: "user_nm", title: "ì‚­ì œ", width: 100 },
                { field: "equipPk", title: "equipPk", width: 100, hidden: true },
                { field: "addEquipYn", title: "ì„¤ë¹„ì‹ ê·œì¶”ê°€ì—¬ë¶€", width: 100, hidden: true }
            ],
            noRecords: {
                template: "ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
            }
        });


        $("#piCheckItemGrid").kendoGrid({
            dataSource: new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "/api/kmms/pi_master",
                        dataType: "json",
                        contentType: "application/json",
                        data: function () {
                            return {
                                action: 'read_equip',
                                pm_pk: $('#pm_pk').val()
                            };
                        }
                    }
                },
                schema: {
                    data: function (response) {
                        console.log("Grid Response:", response);
                        if (Array.isArray(response)) {
                            return response;
                        }
                        return [];
                    }
                },
                pageSize: 30,
                requestStart: function () {
                    console.log("DataSource request starting with pm_pk:", $('#pm_pk').val());
                }
            }),
            height: 550,
            sortable: true,
            pageable: true,
            autoBind: false, // ìë™ ë°ì´í„° ë°”ì¸ë”© ë¹„í™œì„±í™”
            columns: [
                { field: "work_order_no", title: "ìˆœë²ˆ", width: 120 },
                { field: "reg_dt", title: "ìˆœì„œì¡°ì •", width: 120, format: "{0:yyyy-MM-dd}" },
                { field: "wo_status_nm", title: "ì ê²€í•­ëª©ëª…", width: 100 },
                { field: "plan_start_dt", title: "LCL", width: 120, format: "{0:yyyy-MM-dd}" },
                { field: "end_dt", title: "UCL", width: 120, format: "{0:yyyy-MM-dd}" },
                { field: "user_nm", title: "ë‹¨ìœ„", width: 100 },
				{ field: "user_nm", title: "ì ê²€ê°€ì´ë“œ", width: 100 },
                { field: "user_nm", title: "ì‚­ì œ", width: 100 }
            ],
            noRecords: {
                template: "ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
            }
        });

		$("#pmWorkOrderGrid").kendoGrid({
			dataSource: new kendo.data.DataSource({
				transport: {
					read: {
						url: "/api/kmms/pm_master",
						dataType: "json",
						contentType: "application/json",
						data: function() {
							return {
								action: 'read_pm_wo',
								pm_pk: $('#pm_pk').val()
							};
						}
					}
				},
				schema: {
					data: function(response) {
						console.log("Grid Response:", response);
						if (Array.isArray(response)) {
							return response;
						}
						return [];
					}
				},
				pageSize: 30,
				requestStart: function() {
					console.log("DataSource request starting with pm_pk:", $('#pm_pk').val());
				}
			}),
			height: 550,
			sortable: true,
			pageable: true,
			autoBind: false, // ìë™ ë°ì´í„° ë°”ì¸ë”© ë¹„í™œì„±í™”
			columns: [
				{ field: "work_order_no", title: "WOë²ˆí˜¸", width: 120 },
				{ field: "reg_dt", title: "WOìƒì„±ì¼", width: 120, format: "{0:yyyy-MM-dd}" },
				{ field: "wo_status_nm", title: "WOìƒíƒœ", width: 100 },
				{ field: "plan_start_dt", title: "ì‘ì—…ê³„íšì¼", width: 120, format: "{0:yyyy-MM-dd}" },
				{ field: "end_dt", title: "ì‘ì—…ì™„ë£Œì¼", width: 120, format: "{0:yyyy-MM-dd}" },
				{ field: "user_nm", title: "ë‹´ë‹¹ì", width: 100 }
			],
			noRecords: {
				template: "ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
			}
		});
	});

	// ì§ì¢… í–‰ ì‚­ì œ í•¨ìˆ˜
	function deleteJobClassRow(btn) {
		const tbody = $('#jobClassTable tbody');
		$(btn).closest('tr').remove();

		// ëª¨ë“  í–‰ì´ ì‚­ì œë˜ì—ˆì„ ë•Œ no-data í–‰ ì¶”ê°€
		if (tbody.children().length === 0) {
			tbody.append(`
				<tr class="no-data">
					<td colspan="4">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
				</tr>
			`);
		} else {
			// ìˆœë²ˆ ì¬ì •ë ¬
			tbody.find('tr').not('.no-data').each((index, tr) => {
				$(tr).find('td:first').text(index + 1);
			});
		}
	}
</script>