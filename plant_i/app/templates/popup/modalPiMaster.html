

<div id="modalPiMaster" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>ì ê²€ ë§ˆìŠ¤í„° ë“±ë¡</h4>
		</div>

		<div class="modal-body">
			<div class="equipment-section">
				<div class="section-header"  style="display: flex; justify-content: flex-end;">					
					<div class="button-group">
						<button type="button" class="btn-copy" id="copyPi" name="copyPi">
							ì ê²€ë³µì‚¬
						</button>
					</div>
				</div>

			<!-- ê³„íš ì„¹ì…˜2 -->
			<div class="section">
				<div class="tab-group">
					<button class="active">ê³„íš</button>
					<button>ì ê²€ì„¤ë¹„</button>
					<button>ì ê²€í•­ëª©</button>
					<button>ì‘ì—…ê²°ê³¼ ëª©ë¡</button>
					<button>ì‘ì—… WO ëª©ë¡</button>
				</div>
				<div class="tab-content">
					<!-- ê³„íš íƒ­ ì»¨í…ì¸  -->
					<form id="piMasterForm">
						<input type="hidden" id="pm_pk" name="pm_pk">
						<div class="plan-content">
							<div class="form-row">
								<div class="form-group col-6">
									<label>ì ê²€ë²ˆí˜¸</label>
									<input type="text" class="form-control" id="pmNumber" name="pmNumber" placeholder="ì ê²€ë²ˆí˜¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤" readonly>
								</div>
								<div class="form-group col-6">
									<label>ì ê²€ëª… <span class="required">*</span></label>
									<input type="text" class="form-control" id="piName" name="piName" placeholder="100ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”">
								</div>
							</div>
							<div class="form-row">
								<!-- ì˜¤ë¥¸ìª½ cycleInfo ì˜ì—­ -->
								<!-- ì£¼ê¸°ë‹¨ìœ„ -->
								<div class="form-group col-4">
									<label>ì£¼ê¸°ë‹¨ìœ„ <span class="required">*</span></label>
									<select id="cycleType" name="cycleType">
									</select>
								</div>
								<div class="form-group col-4">
									<label>ë°˜ë³µ <span class="required">*</span></label>
									<div class="field-wrapper" style="display:flex">
										<span class="mt-2" style="margin-left: 5px;">ë§¤</span>
										<input id="perNumber" name="perNumber" type="number" class="form-control" />
									</div>
								</div>
								<!-- ì£¼ê¸°ì‹œì‘ì¼ -->
								<div class="form-group col-4">
									<label>ì£¼ê¸°ì‹œì‘ì¼ <span class="required">*</span></label>
									<div class="field-wrapper">
										<input type="date" id="schedStartDt" name="schedStartDt" class="form-control" />
									</div>
								</div>
							</div>
							<div class="form-row">
								<div class="form-group col-6">
									<label>ì ê²€ë¶€ì„œ <span class="required">*</span></label>
									<select id="executionDept" name="executionDept">
									</select>
								</div>
								<div class="form-group col-6">
									<label>ì ê²€ë‹´ë‹¹ì <span class="required">*</span></label>
									<select id="piManager" name="piManager">
										<option value="">ì ê²€ ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
									</select>
								</div>
							</div>
							<div class="form-group col-12">
								<label>ì‘ì—…ì§€ì¹¨</label>
								<textarea class="form-control" id="work_text" name="work_text" placeholder="2000ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”" maxlength="2000"></textarea>
								<div class="char-count">0 / 2000 bytes</div>
							</div>
						</div>
					</form>


					<!-- ì ê²€ì„¤ë¹„ ëª©ë¡ íƒ­ ì»¨í…ì¸  -->
					<div id="piEquip" style="display: none;">
						<div class="section-header" style="display: flex; justify-content: flex-end;">
							<div class="button-group">
								<button type="button" class="btn-equipment" id="selectEquipment" name="selectEquipment">
									ì„¤ë¹„ì„ íƒ
								</button>
							</div>
						</div>
						<!--ì•„ì´ë”” ë³€ê²½ equipTable => tblChkEquip -->
						<div class="swing-el-tab-scroll" style="height: 412px;">
							<table class="swing-table swing-table-bordered swing-table-striped mb-0" id="tblChkEquip">
								<thead>
									<tr style="border-top: 2px solid #343a40;">
										<th width="14%" class="text-center">ì„¤ë¹„ì½”ë“œ</th>
										<th width="25%" class="text-center">ì„¤ë¹„ëª…</th>
										<th width="14%" class="text-center">ìœ„ì¹˜</th>
										<th width="20%" class="text-center">ì¹´í…Œê³ ë¦¬</th>
										<th width="8%" class="text-center">ì¤‘ìš”ë„</th>
										<th width="14%" class="text-center">ìƒíƒœ</th>
										<th width="5%" class="text-center">ì‚­ì œ</th>
										<th style="display: none">equipPk</th>
										<th style="display: none">ì„¤ë¹„ì‹ ê·œì¶”ê°€ì—¬ë¶€</th>
									</tr>
								</thead>
									<tbody id="piEquipTable">
									</tbody>
							</table>
						</div>
					</div>

					<!-- ì ê²€í•­ëª© ëª©ë¡ íƒ­ ì»¨í…ì¸  -->
					<div id="piCheckItem" style="display: none;">
						<div class="section-header" style="display: flex; justify-content: flex-end;">
							<div class="button-group">
								<button type="button" class="btn-equipment" id="addCheckItem" name="addCheckItem">
									ì ê²€í•­ëª©ì¶”ê°€
								</button>
							</div>
						</div>
						<div  class="swing-el-tab-scroll" style="height: 412px;">
							<table class="swing-table swing-table-bordered swing-table-striped mb-0" id="tblChkItem">
								<thead>
									<tr style="border-top: 2px solid #343a40;">
										<th width="5%" class="text-center">ìˆœë²ˆ</th>
										<th width="8%" class="text-center">ìˆœì„œì¡°ì •</th>
										<th width="30%" class="text-center">ì ê²€í•­ëª©ëª…*</th>
										<th width="7%" class="text-center">LCL</th>
										<th width="7%" class="text-center">UCL</th>
										<th width="10%" class="text-center">ë‹¨ìœ„</th>
										<th width="10%" class="text-center">ì ê²€ ê°€ì´ë“œ</th>
										<th style="display: none">ì ê²€ ì ê²€ë°©ë²•</th>
										<th style="display: none">ì ê²€ ì´ìƒê¸°ì¤€</th>
										<th width="5%" class="text-center">ì‚­ì œ</th>
										<th style="display: none">chkItemPk</th>
									</tr>
								</thead>
								<tbody id="piCheckTable">
								</tbody>
							</table>
						</div>
					</div>

	
					<!-- PM WO ëª©ë¡ íƒ­ ì»¨í…ì¸  -->
					<div id="pmWorkOrderContent" class="pmwo-content" style="display: none;">
						<div id="pmWorkOrderGrid"></div>
					</div>
				</div>
			</div>
			

			<!-- ë²„íŠ¼ ì˜ì—­ -->
			<div class="modal-footer">
				<button type="button" class="btn-save" id="saveBtn">ì €ì¥</button>
				<button type="button" class="btn-close" id="closePmModal">ë‹«ê¸°</button>
			</div>
		</div>
	</div>
	</div>
</div>

<script type="text/x-kendo-template" id="tblChkEquipTemp">
	# if ( data.length == 0 ){ #
	<tr>
		<td colspan="9">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
	</tr>
	# } #
	# for (let index=0; index<data.length; index++) { let item = data[index]; #
	<tr id="chkequip_rows_#=item.equipPk#" >
		<td id="col" class="text-left">#=item.equipCd#</td>
		<td id="col" class="text-left">#=item.equipNm#</td>
		<td id="col" class="text-left">#=item.locNm#</td>
		<td id="col" class="text-left">#=item.equipCategoryDesc#</td>
		<td id="col" class="text-left">#=item.importRankCd#</td>
		<td id="col" class="text-left">#=item.equipStatusNm#</td>
		<td  class="text-center">
			<botton  type ="button" class="btn-save btn-equip-delete" data-uid="#= item.equipPk #">
				<span>ì‚­ì œ</span>
			</botton>
		</td>
		<td id="colPk" style="display: none;">#=item.equipPk#</td>
		<td id="colPk" style="display: none;">#=item.addEquipYn#</td>
	</tr>
	# } #

</script>

<script type="text/x-kendo-template" id="tblChkItemTemp">
	# if ( data.length == 0 ){ #
	<tr>
		<td colspan="9">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
	</tr>
	# } #
	# for (let index=0; index<data.length; index++) { let item = data[index]; #
	<tr id="chkitem_rows_#=index#" >
		<td id="colItemIdx" class="text-center colItemIdx">#=item.itemIdx#</td>
		<td >
			<div class="btn-group">
				<botton  type ="button" class="btn btn-xs btn-chkitem-down" data-uid="#= index #" style="font-size: 21px" >
					<img src="/static/img/caret-down-solid.svg"  alt="down" style="width: 24px; height: 24px;"/>
				</botton>
				<botton  type ="button" class="btn btn-xs btn-chkitem-up" data-uid="#= index #" style="font-size: 21px" >
					<img src="/static/img/caret-up-solid.svg" class="" alt="up" style="width: 24px; height: 24px;"/>
				</botton>
			</div>
		</td>
		<td id="colChkItemNm" class="text-right bg-edit-cell">
			<input type="text" class="form-control chkItemNm" maxlength="100" value= #=item.chkItemNm#  />
		</td>
		<td id="colLcl" class="text-right bg-edit-cell">
			<input type="text" class="form-control lcl" maxlength="100" value= #=item.lcl#  />
		</td>
		<td id="colUcl" class="text-right bg-edit-cell">
			<input type="text" class="form-control ucl" maxlength="100" value= #=item.ucl#  />
		</td>
		<td id="chkItemUnitPk" class="text-right bg-edit-cell">
			<select class="chkItemUnitSelect" data-index="#= index #">
				<option value="">ë‹¨ìœ„ì„ íƒ</option>
				# for (var i = 0; i < chkItemUnitData.length; i++) { #
				<option value="#= chkItemUnitData[i].codePk #"
					# if (item.chkItemUnitPk == chkItemUnitData[i].codePk) { # selected # } #>
					#= chkItemUnitData[i].codeNm #
				</option>
				# } #
			</select>
		</td>
		<td id="chkItemUnitPk2" class="text-right bg-edit-cell">
			<span>ì…ë ¥í•˜ê¸°</span>
		</td>
		<td  class="text-center">
			<botton  type ="button" class="btn-save btn-chkitem-delete" data-uid="#= index #">
				<span>ì‚­ì œ</span>
			</botton>
		</td>
	</tr>
	# } #

</script>

<style>

	

</style>

<!--swingì—ì„œ ì‚¬ìš©í•œ ìŠ¤íƒ€ì¼ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¨ë‹¤-->
<style>

    .swing-el-tab-scroll, .swing-tab-scroll {
        overflow-y: auto !important;
        overflow-x: hidden;
    }

	.swing-table-bordered {
		border-top: 2px solid #7db4d8 !important;
		border-right: 1px solid #d1d3db;
	}

	.swing-table {
		background-color: transparent;
		width: 100% !important;
		max-width: 100%;
		margin-bottom: 0.9375rem;
		border-spacing: 0;
	}	

    .swing-table > caption + thead > tr:first-child > th, .swing-table > colgroup + thead > tr:first-child > th, .swing-table > thead:first-child > tr:first-child > th, .swing-table > caption + thead > tr:first-child > td, .swing-table > colgroup + thead > tr:first-child > td, .swing-table > thead:first-child > tr:first-child > td {
        border-top: 0;
    }

    .swing-table-bordered > thead > tr > th {
        color: #656876;
        /* border-top: 0; */
        border-bottom: 1px solid #d1d3db !important;
        background-color: #ecf1f4;
    }

    .swing-table-bordered > thead > tr > th, .swing-table-bordered > thead > tr > td {
        border-bottom-width: 1px;
    }

    .swing-table > thead > tr > th {
        vertical-align: bottom;
        border-bottom: 1px solid #d1d3db;
    }

    .swing-table th, .swing-table td {
        padding: 0.75rem;
        line-height: 1.42857143;
        vertical-align: middle !important;
        border-width: 0 0 1px 1px !important;
        border-style: solid !important;
        border-color: #d1d3db !important;
    }

    .swing-table input[type="text"] {
        height: 10px;
        padding: 0px 0px;
    }

    table {
        border-collapse: collapse;
    }

    .text-center {
        text-align: center !important;
    }

    .text-right {
        text-align: right !important;
    }

    .text-left {
        text-align: left !important;
    }

    .bg-edit-cell {
        background-color: lightgoldenrodyellow !important;
    }

    .btn-group, .btn-group-vertical {
        position: relative;
        display: -webkit-inline-box;
        display: -ms-inline-flexbox;
        display: flex;
        vertical-align: middle;
		justify-content: center;
		
    }

    .btn-group > .btn, .btn-group-vertical > .btn {
        position: relative;
        -webkit-box-flex: 0;
        -ms-flex: 0 1 auto;
        flex: 0 1 auto;
        padding: 0px 0px;
        border-radius: 4px;
    }

    .btn-xs, .btn-group-xs > .btn {
        line-height: 1.5;        
        background-color: #ecf1f4;
    }
	   


</style>

<script type="text/javascript">
	let piMasterPage = null;
	class PiMaster {
		constructor() {
			this.grid = null;
			this.baseUrl = '/api/kmms/pi_master';

			this.resetForm = this.resetForm.bind(this);

			//ì ê²€ì„¤ë¹„ array
			this.chkEquipGrid = [];

			//í…œí”Œë¦¿
            this.template = null;
			this.templateEquip = null;

			//ì ê²€í•­ëª© array
			this.chkItemGrid = [];
			this.chkItemUnitList = [];

			//for test 
            let checkItemUnit =
            {
                codePk: "KG",
                codeNm: "KG"
			};
			this.chkItemUnitList.push(checkItemUnit);

			this.init();
		}

		bindMainEvents() {
			let _this = this;

            // íƒ­ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
            $('.tab-group button').on('click', function () {
                // ëª¨ë“  íƒ­ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                $('.tab-group button').removeClass('active');
                // í´ë¦­ëœ íƒ­ì— active í´ë˜ìŠ¤ ì¶”ê°€
                $(this).addClass('active');

                // ëª¨ë“  ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
                $('#piMasterForm, #piEquip,  #piCheckItem, #pmWorkOrderContent').hide();

                // íƒ­ ë‚´ìš© ì „í™˜
                var tabName = $(this).text().trim();
                switch (tabName) {
                    case 'ê³„íš':
                        $('#piMasterForm').show();
                        break;
                    case 'ì ê²€ì„¤ë¹„':
                        $('#piEquip').show();
                        break;
                    case 'ì ê²€í•­ëª©':
                        $('#piCheckItem').show();
                        break;
                    case 'PM WO ëª©ë¡':
                        $('#pmWorkOrderContent').show();
                        // PM WO ëª©ë¡ íƒ­ ì„ íƒ ì‹œì—ë§Œ ë°ì´í„° ë¡œë“œ
                        var grid = $("#pmWorkOrderGrid").data("kendoGrid");
                        var pmPk = $('#pm_pk').val();
                        if (grid && pmPk) {
                            console.log("Loading PM WO data for pm_pk:", pmPk);
                            grid.dataSource.read();
                        } else {
                            console.log("Grid or pm_pk not available:", { grid: !!grid, pmPk: pmPk });
                        }
                        break;
                }
            });

            // ì´ˆê¸° ìƒíƒœ: ê³„íš íƒ­ í™œì„±í™”
            $('.tab-group button:first').click();

            // ê¸€ììˆ˜ ì¹´ìš´íŠ¸ ê¸°ëŠ¥
            $('#work_text').on('input', function () {
                const maxLength = 1000;
                const currentLength = $(this).val().length;
                $('.char-count').text(`${currentLength} / ${maxLength} bytes`);

                // ìµœëŒ€ ê¸€ììˆ˜ ì²´í¬
                if (currentLength > maxLength) {
                    $(this).val($(this).val().substring(0, maxLength));
                }
			});    

            $("#copyPi").kendoButton({
                icon: "k-i-copy",// ë³µì‚¬ ì•„ì´ì½˜
                click: function (e) {
                    e.preventDefault();
                    $("#modalPmCopy").fadeIn();
                }
            });


            // ESC í‚¤ ëˆ„ë¥¼ ë•Œ ëª¨ë‹¬ ë‹«ê¸°
            $(document).on('keydown', (e) => {
                if (e.keyCode === 27) { // ESC key
                    modal.fadeOut();
                }
            });

            $("#saveBtn").kendoButton({
                icon: "k-i-save",
                click: function (e) {
                    e.preventDefault();
                    _this.saveData();
                },
                themeColor: "none"
            }).closest(".k-button").css({
                "background": "#ECF5FF",
                "color": "#409EFF",
                "border-color": "#B3D8FF",
                "border": "1px solid #00a9ff",
                "padding": "6px 12px",
                "border-radius": "4px",
                "cursor": "pointer",
                "min-width": "40px",
                "height": "28px",
                "line-height": "1"
            }).hover(
                function () {
                    $(this).css({
                        "background-color": "#C2DFFF",
                        "border-color": "#0054e0"
                    });
                },
                function () {
                    $(this).css({
                        "background": "#ECF5FF",
                        "border-color": "#B3D8FF"
                    });
                }
            );

            // ëª¨ë‹¬ ë‹«ê¸° - ë‹«ê¸° ë²„íŠ¼ í´ë¦­
            $('#closePmModal').kendoButton({
                click: function (e) {
                    e.preventDefault();
                    modal.fadeOut();
                }
            });
		}

		bindChkEquipTemplateEvents() {
			let _this = this;
			$('#piEquipTable').off('click', '.btn-equip-delete').on('click', '.btn-equip-delete', function () {
				const equipPk = $(this).data('uid');
				console.log('ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨. equipPk:', equipPk);

				// ì‚­ì œ
				_this.chkEquipGrid = _this.chkEquipGrid.filter(item => item.equipPk !== equipPk);

				console.log(_this.chkEquipGrid);

				//choi : ì´ê±¸ í•  í•„ìš”ê°€ ìˆë‚˜?????
				// ë Œë”ë§ ê²°ê³¼ë¥¼ piEquipTable ì‚½ì…
				$("#piEquipTable").html(_this.templateEquip({
					data: _this.chkEquipGrid
				}));

				_this.tableReorder4Equip();

			});

            //ì„¤ë¹„ì„ íƒ
            $('#selectEquipment').kendoButton({
                themeColor: "base",
                icon: "k-i-plus", // ê¸°ì–´ ì•„ì´ì½˜ (ì„¤ë¹„ ê´€ë ¨)
                click: function (e) {
                    e.preventDefault();

                    //ì„¤ë¹„ ì¶”ê°€
                    //for test : testë°ì´í„° ì—°ê²°
                    let equipData =
                    {
                        equipPk: 1,
                        equipCd: "a1",
                        equipNm: "ì„¤ë¹„ëª…",
                        locNm: "locNm",
                        equipCategoryDesc: "equipCategoryDesc",
                        importRankCd: "importRankCd",
                        equipStatusNm: "equipStatusNm",
                    };

                    _this.chkEquipGrid.push(equipData);

                    // ë Œë”ë§ ê²°ê³¼ë¥¼ piCheckTableì— ì‚½ì…
                    $("#piEquipTable").html(_this.templateEquip({
                        data: _this.chkEquipGrid
                    }));

                    _this.tableReorder4Equip();
                    //eof for test


                    console.log("main selectEquipment button click");
                    $("#modalEqus").fadeIn();
                }
			});

            $("#piEquipGrid").kendoGrid({
                dataSource: new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: "/api/kmms/pi_master",
                            dataType: "json",
                            contentType: "application/json",
                            data: function () {
                                return {
                                    action: 'read_equip',
                                    pm_pk: $('#pm_pk').val()
                                };
                            }
                        }
                    },
                    schema: {
                        data: function (response) {
                            console.log("Grid Response:", response);
                            if (Array.isArray(response)) {
                                return response;
                            }
                            return [];
                        }
                    },
                    pageSize: 30,
                    requestStart: function () {
                        console.log("DataSource request starting with pm_pk:", $('#pm_pk').val());
                    }
                }),
                height: 550,
                sortable: true,
                pageable: true,
                autoBind: false, // ìë™ ë°ì´í„° ë°”ì¸ë”© ë¹„í™œì„±í™”
                columns: [
                    { field: "equipCd", title: "ì„¤ë¹„ì½”ë“œ", width: 120 },
                    { field: "equipNm", title: "ì„¤ë¹„ëª…", width: 120, format: "{0:yyyy-MM-dd}" },
                    { field: "locNm", title: "ìœ„ì¹˜", width: 100 },
                    { field: "equipCategoryDesc", title: "ì¹´í…Œê³ ë¦¬", width: 120, format: "{0:yyyy-MM-dd}" },
                    { field: "importRankCd", title: "ì¤‘ìš”ë„", width: 120, format: "{0:yyyy-MM-dd}" },
                    { field: "equipStatusNm", title: "ìƒíƒœ", width: 100 },
                    { field: "user_nm", title: "ì‚­ì œ", width: 100 },
                    { field: "equipPk", title: "equipPk", width: 100, hidden: true },
                    { field: "addEquipYn", title: "ì„¤ë¹„ì‹ ê·œì¶”ê°€ì—¬ë¶€", width: 100, hidden: true }
                ],
                noRecords: {
                    template: "ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
                }
            });
		}

		tableReorder4Equip() {
			$("#piEquipTable").find(".btn-equip-delete").each(function () {
				//console.log("btn-equip-delete ì¬ì„¤ì •")
				const $button = $(this);

				$button.kendoButton({
					click: function (e) {
						e.preventDefault();
						//console.log("ì‚­ì œë²„íŠ¼ í´ë¦­");
					},
				});
			});
		}

		bindChkItemTemplateEvents() {
            let _this = this;
			$('#piCheckTable').off('click', '.btn-chkitem-delete').on('click', '.btn-chkitem-delete', function () {
				const nIndex = $(this).data('uid');
				//console.log('ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨. nIndex:', nIndex);

				// ì‚­ì œ ë¡œì§ ì¶”ê°€
				_this.chkItemGrid.splice(nIndex, 1);
				console.log(_this.chkItemGrid);

				// ë Œë”ë§ ê²°ê³¼ë¥¼ piCheckTableì— ì‚½ì…
				$("#piCheckTable").html(_this.template({
					data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
				}));
				_this.tableReorder('tblChkItem', 'colItemIdx');

			});

			$('#piCheckTable').off('click', '.btn-chkitem-down').on('click', '.btn-chkitem-down', function () {
				const nIndex = $(this).data('uid');
				//console.log(`ë‹¤ìš´í´ë¦­:`, nIndex);
				_this.moveDown(nIndex);
			});

			$('#piCheckTable').off('click', '.btn-chkitem-up').on('click', '.btn-chkitem-up', function () {
				const nIndex = $(this).data('uid');
				//console.log(`ì—…í´ë¦­:`, nIndex);
                _this.moveUp(nIndex);
			});


			$('#piCheckTable').off('input', '.chkItemNm').on('input', '.chkItemNm', function () {
				const $tr = $(this).closest('tr');
				const rowIndex = $tr.index();  // tbody ê¸°ì¤€ ëª‡ ë²ˆì§¸ trì¸ì§€

				console.log('í˜„ì¬ tr ì¸ë±ìŠ¤:', rowIndex);

				const value = $(this).val();               // ë³€ê²½ëœ ê°’
				console.log("value=", value);

				if (_this.chkItemGrid && _this.chkItemGrid[rowIndex]) {
					_this.chkItemGrid[rowIndex].chkItemNm = value;  // ë°ì´í„° ë°˜ì˜
				}
			});

			$('#piCheckTable').off('input', '.lcl').on('input', '.lcl', function () {
				const $tr = $(this).closest('tr');
				const rowIndex = $tr.index();  // tbody ê¸°ì¤€ ëª‡ ë²ˆì§¸ trì¸ì§€

				console.log('í˜„ì¬ tr ì¸ë±ìŠ¤:', rowIndex);

				const value = $(this).val();               // ë³€ê²½ëœ ê°’
				console.log("value=", value);

				if (_this.chkItemGrid && _this.chkItemGrid[rowIndex]) {
					_this.chkItemGrid[rowIndex].lcl = value;  // ë°ì´í„° ë°˜ì˜
				}
			});

			$('#piCheckTable').off('input', '.ucl').on('input', '.ucl', function () {
				const $tr = $(this).closest('tr');
				const rowIndex = $tr.index();  // tbody ê¸°ì¤€ ëª‡ ë²ˆì§¸ trì¸ì§€

				console.log('í˜„ì¬ tr ì¸ë±ìŠ¤:', rowIndex);

				const value = $(this).val();               // ë³€ê²½ëœ ê°’
				console.log("value=", value);

				if (_this.chkItemGrid && _this.chkItemGrid[rowIndex]) {
					_this.chkItemGrid[rowIndex].ucl = value;  // ë°ì´í„° ë°˜ì˜
				}
			});

			$('#piCheckTable').off('change', '.chkItemUnitSelect').on('change', '.chkItemUnitSelect', function () {
				const $tr = $(this).closest('tr');
				const rowIndex = $tr.index();  // tbody ê¸°ì¤€ ëª‡ ë²ˆì§¸ trì¸ì§€

				console.log('í˜„ì¬ selected ì¸ë±ìŠ¤:', rowIndex);

				const value = $(this).val();               // ë³€ê²½ëœ ê°’
				console.log("select value=", value);

				if (_this.chkItemGrid && _this.chkItemGrid[rowIndex]) {
					_this.chkItemGrid[rowIndex].chkItemUnitPk = value;  // ë°ì´í„° ë°˜ì˜
				}

				console.log(_this.chkItemGrid);
			});

            //ì ê²€í•­ëª© ì¶”ê°€ 
            $('#addCheckItem').kendoButton({
                themeColor: "base",
                icon: "k-i-plus", // ê¸°ì–´ ì•„ì´ì½˜ (ì„¤ë¹„ ê´€ë ¨)
                click: function (e) {
                    e.preventDefault();

                    //í•­ëª© ì¶”ê°€
                    //for test choi : testë°ì´í„° ì—°ê²°
                    let checkItemData =
                    {
                        itemIdx: 1,
                        chkItemNm: "ì••ë ¥ ì²´í¬",
                        lcl: "10",
                        ucl: "50",
                        chkItemUnitPk: "KG",
                        guide: "10~50 psi ìœ ì§€",
                        method: "ê²Œì´ì§€ë¡œ ì¸¡ì •",
                        chkItemPk: 101,
                    };

                    _this.chkItemGrid.push(checkItemData);

                    // ë Œë”ë§ ê²°ê³¼ë¥¼ piCheckTableì— ì‚½ì…
                    $("#piCheckTable").html(_this.template({
                        data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
                    }));

                    _this.tableReorder('tblChkItem', 'colItemIdx');
                }
            });
		}
            

		moveUp(index) {
            var $tr = $('#chkitem_rows_' + index).closest('tr'); // í•´ë‹¹ í–‰
            var $prev = $tr.prev(); // ì´ì „ í–‰

            if ($prev.length) {
                $prev.before($tr); // ì´ì „ tr ì•ì— í˜„ì¬ tr ì‚½ì… (ìœ„ë¡œ ì´ë™)
            }

            // ì •ë ¬ í›„ í›„ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ (ì˜ˆ: ì¸ë±ìŠ¤ ë‹¤ì‹œ ë§¤ê¸°ê¸°)
            this.tableReorder('tblChkItem', 'colItemIdx');
		}

		moveDown(index) {
            var $tr = $('#chkitem_rows_' + index).closest('tr'); // í˜„ì¬ tr
            var $next = $tr.next(); // ë‹¤ìŒ tr

            if ($next.length) {
                $next.after($tr); // ë‹¤ìŒ tr ë’¤ì— í˜„ì¬ tr ì‚½ì… (ì•„ë˜ë¡œ ì´ë™)
            }

            // ì •ë ¬ í›„ í›„ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ (ì˜ˆ: ì¸ë±ìŠ¤ ë‹¤ì‹œ ë§¤ê¸°ê¸°)
            this.tableReorder('tblChkItem', 'colItemIdx');
        }

		tableReorder(tableId, orderColClass) {
			$('#' + tableId + ' tbody tr').each(function (i) {
				$(this).find('.' + orderColClass).text(i + 1);  // â† class ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½
			});

            $("#piCheckTable").find(".btn-chkitem-delete").each(function () {
                //console.log("btn-chkitem-delete ì¬ì„¤ì •")
                const $button = $(this);

                $button.kendoButton({
                    click: function (e) {
                        e.preventDefault();
                        //console.log("ì‚­ì œë²„íŠ¼ í´ë¦­");
                    },
                });
            });

			//choi : tableReorderí• ë•Œ ê¸°ì¡´ì— ì ìš©í–ˆë˜ kendoìŠ¤íƒ€ì¼ì´ ì£½ì–´ ë²„ë¦¼. ê·¸ë˜ì„œ ë‹¤ì‹œ ì„¤ì •í•´ ì£¼ì–´ì•¼ í•¨
			//console.log("find2=", $("#piCheckTable").find(".chkItemUnitSelect"))
			$("#piCheckTable").find(".chkItemUnitSelect").each(function () {
				//console.log("chkItemUnitSelect ì¬ì„¤ì •")
				const $select = $(this);
				//const initialValue = $select.data("value");
				//console.log("initialValue:", initialValue)
				//const index = $select.data("index");

				//ëª¨ì–‘ë§Œ ì„¤ì •í•´ ì¤€ë‹¤
				$select.kendoDropDownList({
					//                 dataSource: _this.chkItemUnitList,
					//                 dataTextField: "codeNm",
					//                 dataValueField: "codePk",
					//                 optionLabel: "ë‹¨ìœ„ì„ íƒ",
					//                 value: initialValue,
					//                 change: function () {
					//                     const selectedValue = this.value();
					//console.log("index:", index, "selected:", selectedValue);							
					//                     if (_this.chkItemGrid && _this.chkItemGrid[index]) {
					//                         _this.chkItemGrid[index].chkItemNm = selectedValue;  // ë°ì´í„° ë°˜ì˜
					//}
					//                 }
				});
			})
		}

        saveData() {
            let _this = this;
            let data = FormUtil.extractForm($('#piMasterForm'));
            data.dept_pk = $("#executionDept").data("kendoDropDownTree").value();
            data.piManager = $("#piManager").val();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!$('#piName').val()) {
                Alert.alert('', 'ì ê²€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!data.dept_pk) {
                Alert.alert('', 'ì ê²€ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!data.piManager) {
                Alert.alert('', 'ì ê²€ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì£¼ê¸°ì‹œì‘ì¼,ì£¼ê¸°ë‹¨ìœ„,ë°˜ë³µ
            const schedStartDt = $("#schedStartDt").val();
            const cycleType = $("#cycleType").val();
            const perNumber = $("#perNumber").val();

            if (!schedStartDt || !cycleType || !perNumber) {
                Alert.alert('', 'ì£¼ê¸° ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            data.sched_start_dt = schedStartDt;
            data.cycle_type = cycleType;
            data.per_number = perNumber;

            const workText = $("#work_text").val();
            data.work_text = workText;

            let funcSucc = function (resp) {
                if (resp.success) {
                    // ê¸°ë³¸ ì •ë³´ ì €ì¥ ì„±ê³µ ì‹œ ì‘ì—… ì¸ë ¥ ì €ì¥ ì§„í–‰
                    // choi : ì¼ë‹¨ ì œê±°
                    //_this.savePmLalor(resp);
                } else {
                    Alert.alert('error', resp.message);
                }
            };

            AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, funcSucc);
            $("#modalPiMaster").fadeOut();
        }

        resetData() {
            let _this = this;
            FormUtil.resetForm($('#piMasterForm'));
            // í¼ ë¦¬ì…‹ í›„ cycleInfo ì²´í¬
            // this.checkCycleInfo();
        }

        savePmLalor(resp) {
            let _this = this;
            let jobClassData = [];
            $('#jobClassTable tbody tr').not('.no-data').each(function () {
                const job_class_pk = $(this).data('value');
                let work_hr = $(this).find('input[type="number"]').val();
                work_hr = work_hr || 0;
                jobClassData.push({
                    job_class_pk: job_class_pk,
                    work_hr: work_hr
                });
            });

            // ì‘ì—… ì¸ë ¥ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë°”ë¡œ ìì¬ ì €ì¥ìœ¼ë¡œ ì§„í–‰
            if (jobClassData.length === 0) {
                _this.savePmMtrl(resp);
                return;
            }

            let data = {
                job_classes: JSON.stringify(jobClassData),
                pm_pk: resp.id
            };

            let funcSucc2 = function (resp2) {
                if (resp2.success) {
                    _this.savePmMtrl(resp);
                } else {
                    Alert.alert('error', resp2.message);
                }
            }

            AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_job_classes', data, funcSucc2);
        }

        savePmMtrl(resp) {
            let _this = this;
            let materialData = [];
            $('#materialTable tbody tr').not('.no-data').each(function () {
                const mat_pk = $(this).data('value');
                let mtrl_qty = $(this).find('input[type="number"]').val();
                mtrl_qty = mtrl_qty || 0;
                materialData.push({
                    mat_pk: mat_pk,
                    mtrl_qty: mtrl_qty
                });
            });

            // ìì¬ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë°”ë¡œ ì™„ë£Œ ì²˜ë¦¬
            if (materialData.length === 0) {
                _this.finalizeSave();
                return;
            }

            let data = {
                materials: JSON.stringify(materialData),
                pm_pk: resp.id
            };

            let funcSucc3 = function (resp3) {
                if (resp3.success) {
                    _this.finalizeSave();
                } else {
                    Alert.alert('error', resp3.message);
                }
            }

            AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_materials', data, funcSucc3);
        }
    	

		init() {
			let _this = this;
			const modal = $("#modalPiMaster");

			// cycleInfo í‘œì‹œ ì—¬ë¶€ ì²´í¬ í•¨ìˆ˜
			this.checkCycleInfo = function () {
				const pmTypeValue = $('#pmType').val();
				if (pmTypeValue === 'PM_TYPE_TBM') {
					$('#cycleInfo').show();
				} else {
					$('#cycleInfo').hide();
				}
			};

			// ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
			this.loadPmData = function (pmPk) {
				let param = {
					action: 'read',
					pm_pk: pmPk
				};

				let result = AjaxUtil.getSyncData(this.baseUrl, param);
				if (result) {
					// FormUtil.fillForm($('#piMasterForm'), result);
					// ë°ì´í„° ë¡œë“œ ì§í›„ cycleInfo ì²´í¬
					setTimeout(() => this.checkCycleInfo(), 0);
				}
			};

			// ëª¨ë‹¬ì´ í‘œì‹œë  ë•Œë§ˆë‹¤ cycleInfo ì²´í¬
			modal.on('show', function () {
				_this.checkCycleInfo();
			});

			//AjaxUtil.fillDropDownOptions($('#pmType'), 'user_code', 'choose', null, 'PM_TYPE');
			AjaxUtil.fillDropDownTreeOptions($("#executionDept"), "depart", "select");
			AjaxUtil.fillDropDownOptions($('#piManager'), 'auth_user', 'choose', null);
			AjaxUtil.fillDropDownOptions($('#cycleType'), 'user_code', 'choose', null, 'CYCLE_TYPE');
            //AjaxUtil.fillDropDownOptions($('#selJobClass'), 'job_class', 'choose', null);

			let today = CommonUtil.getYYYYMMDD();
			$("#schedStartDt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd",
			});

			//-----------------ì ê²€ê¸°ë³¸ ì´ˆê¸°í™”
			_this.bindMainEvents();

            //-----------------eof ì ê²€ê¸°ë³¸ ì´ˆê¸°í™”


            //-----------------ê³„íš ì´ˆê¸°í™”

            //-----------------eof ê³„íš ì´ˆê¸°í™”



			//------------------ì„¤ë¹„ Kendo í…œí”Œë¦¿ ì´ˆê¸°í™”	
			_this.templateEquip = kendo.template($("#tblChkEquipTemp").html());

            // 2ê°œì˜ ë°ì´íƒ€ë¥¼ ì¤€ë¹„í•˜ê³  piCheckTableì— ì‚½ì…
            $("#piEquipTable").html(_this.templateEquip({
                data: _this.chkEquipGrid
			}));

			_this.tableReorder4Equip();

            _this.bindChkEquipTemplateEvents();           
			//------------------end of ì„¤ë¹„ Kendo í…œí”Œë¦¿ ì´ˆê¸°í™”


            //------------------ì ê²€í•­ëª© Kendo í…œí”Œë¦¿ ì´ˆê¸°í™”			
			_this.template = kendo.template($("#tblChkItemTemp").html());
			
			// 2ê°œì˜ ë°ì´íƒ€ë¥¼ ì¤€ë¹„í•˜ê³  piCheckTableì— ì‚½ì…
            $("#piCheckTable").html(_this.template({
                data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
			}));         

            this.tableReorder('tblChkItem', 'colItemIdx');

			_this.bindChkItemTemplateEvents();            			
			//----------------------end of ì ê²€í•­ëª©ì¶”ê°€

			

			

		}//end init()

		

		finalizeSave() {
			Notify.success('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
			this.resetData();
			page.searchMainData();
		}

		searchLocationData() {
			let _this = this;

			let param = {
				action: 'read',
			};

			let result = AjaxUtil.getSyncData(_this.baseUrl, param);
			_this.grid.setData(result);
			// ë°ì´í„° ë¡œë“œ í›„ cycleInfo ì²´í¬
			this.checkCycleInfo();
		}

		resetForm() {
			// í¼ ë¦¬ì…‹ ì‹œ cycleInfo ì²´í¬
			this.checkCycleInfo();
		}

		//pm ë§ˆìŠ¤í„°
		getPmMasterModal(pmId) {
			let _this = this;

			// 1. PM ìƒì„¸ ì •ë³´ API í˜¸ì¶œ
			let param = {
				action: 'detail',
				id: pmId,
			};
			let pmData = AjaxUtil.getSyncData(_this.baseUrl, param);

			// 2. PM ì‘ì—… ì¸ë ¥ API í˜¸ì¶œ
			let param2 = {
				action: 'detail_pm_labor',
				id: pmId,
			};
			let pmDataLabor = AjaxUtil.getSyncData(_this.baseUrl, param2);

			// 3. PM í•„ìš”ìì¬ API í˜¸ì¶œ
			let param3 = {
				action: 'detail_pm_mtrl',
				id: pmId,
			};
			let pmDataMtrl = AjaxUtil.getSyncData(_this.baseUrl, param3);

			// 1.1. ê¸°ì¡´ ë°ì´í„° ë°”ì¸ë”©
			piMasterPage.bindPmMasterData(pmData);

			// 2.1. ì‘ì—…ì¸ë ¥ í…Œì´ë¸” ì´ˆê¸°í™” ë° ë°ì´í„° ë°”ì¸ë”©
			$('#jobClassTable tbody').empty();

			if (Array.isArray(pmDataLabor) && pmDataLabor.length > 0) {
				pmDataLabor.forEach((labor, index) => {

					// null ì²´í¬ë¥¼ í¬í•¨í•œ ì•ˆì „í•œ ë°ì´í„° ì ‘ê·¼
					const id = labor?.id || '';
					const job_class_pk = labor?.job_class_pk || '';
					const job_class_nm = labor?.job_class_nm || '';
					const work_hr = labor?.work_hr || '';

					const newRow = `
                        <tr data-value="${job_class_pk}">
                            <td>${index + 1}</td>
                            <td style="display: none;">${job_class_pk}</td>
                            <td>${job_class_nm}</td>
                            <td>
                                <input type="number"
                                       class="form-control form-control-sm text-end"
                                       min="0"
                                       step="0.5"
                                       placeholder="ì‹œê°„ ì…ë ¥"
                                       value="${work_hr}" />
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn-delete" onclick="deleteJobClassRow(this)">Ã—</button>
                            </td>
                        </tr>
                    `;
					$('#jobClassTable tbody').append(newRow);
				});
			} else {
				console.log("ğŸ“Œ [ERROR] ì‘ì—…ì¸ë ¥ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ:", pmDataLabor);
			}

			// 3.1. í•„ìš”ìì¬ í…Œì´ë¸” ì´ˆê¸°í™” ë° ë°ì´í„° ë°”ì¸ë”©
			$('#materialTable tbody').empty();  // ê¸°ì¡´ í…Œì´ë¸” ì´ˆê¸°í™”

			if (Array.isArray(pmDataMtrl) && pmDataMtrl.length > 0) {
				pmDataMtrl.forEach((mtrl, index) => {

					// null ì²´í¬ë¥¼ í¬í•¨í•œ ì•ˆì „í•œ ë°ì´í„° ì ‘ê·¼
					const mat_pk = mtrl?.mat_pk || '';
					const mat_cd = mtrl?.mat_cd || '';
					const mat_nm = mtrl?.mat_nm || '';
					const amt = mtrl?.amt || '0';  // ê¸°ë³¸ê°’ ì„¤ì •
					const unit = mtrl?.BasicUnit || '';

					const newRow = `
                        <tr data-value="${mat_pk}">
                            <td>${mat_cd}</td>
                            <td>${mat_nm}</td>
                            <td>
                                <input type="number"
                                       class="form-control form-control-sm text-end"
                                       min="0"
                                       step="1"
                                       value="${amt}"
                                       placeholder="ìˆ˜ëŸ‰ ì…ë ¥"
                                       name="amt"/>
                            </td>
                            <td>${unit}</td>
                            <td class="text-center">
                                <button type="button" class="btn-delete" onclick="deleteMaterialRow(this)">Ã—</button>
                            </td>
                        </tr>
                    `;
					$('#materialTable tbody').append(newRow);  // materialTableë¡œ ìˆ˜ì •
				});
			} else {
				console.log("ğŸ“Œ [ERROR] í•„ìš”ìì¬ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ:", pmDataMtrl);
			}

			$("#modalPiMaster").fadeIn();
		}

		/**
		 * PM ë§ˆìŠ¤í„° ë°ì´í„°ë¥¼ ëª¨ë‹¬ í¼ì— ë°”ì¸ë”©í•˜ëŠ” í•¨ìˆ˜
		 * @param {Object} pmData - PM ë§ˆìŠ¤í„° ìƒì„¸ ë°ì´í„°
		 */
		bindPmMasterData(pmData) {
			// ê¸°ë³¸ í•„ë“œ ë°”ì¸ë”©
			const basicFields = {
				'equip_pk': pmData.equip_pk,
				'pm_pk': pmData.pm_pk,
				'pmNumber': pmData.pm_no,
				'piName': pmData.pm_nm,
				'work_text': pmData.work_text,
				'equ_code': pmData.equ_code,
				'equ_name': pmData.equ_name,
				'equ_loc': pmData.equ_location,
				'equ_import': pmData.import_rank,
				'equ_status': pmData.Status,
				'equ_env_yn': pmData.environ_equip_yn,
				'maintenanceTime': pmData.work_expect_hr,
				'perNumber': pmData.per_number,
				'schedStartDt': pmData.sched_start_dt
			};

			// ê¸°ë³¸ í•„ë“œ ê°’ ì„¤ì •
			// choi : í•œêº¼ë²ˆì— ê°’ì„ ë°”ì¸ë”©í•˜ë„¤
			Object.entries(basicFields).forEach(([id, value]) => {
				$(`#${id}`).val(value);
			});

			// Kendo ë“œë¡­ë‹¤ìš´ ì»´í¬ë„ŒíŠ¸ ë°”ì¸ë”©
			const kendoDropdowns = [
				{
					id: 'executionDept',
					type: 'kendoDropDownTree',
					value: pmData.exec_dept
				},
				{
					id: 'piManager',
					type: 'kendoDropDownList',
					value: pmData.pm_manager
				},
				{
					id: 'pmType',
					type: 'kendoDropDownList',
					value: pmData.pm_type
				},
				{
					id: 'cycleType',
					type: 'kendoDropDownList',
					value: pmData.cycle_type
				}
			];

			kendoDropdowns.forEach(dropdown => {
				const component = $(`#${dropdown.id}`).data(dropdown.type);
				if (component) {
					component.one("dataBound", function () {
						component.value(dropdown.value);
						component.trigger("change");

						if (!component.value()) {
							component.text(dropdown.value);
						}
					});
					component.dataSource.read();
				}
			});
        }//bindPmMasterData
    }//class PiMaster
	

	$(document).ready(function () {
        piMasterPage = new PiMaster();

		// pmType ì„ íƒ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
		$('#pmType').on('change', function () {
			piMasterPage.checkCycleInfo();
		});

		// ëª¨ë‹¬ì´ í‘œì‹œë  ë•Œë§ˆë‹¤ cycleInfo ì²´í¬ (jQuery fadeIn ë°©ì‹)
		const originalFadeIn = $.fn.fadeIn;
		$.fn.fadeIn = function () {
			if (this.attr('id') === 'modalPiMaster') {
				setTimeout(() => piMasterPage.checkCycleInfo(), 0);
			}
			return originalFadeIn.apply(this, arguments);
		};

		   

		
		
	});

	
</script>