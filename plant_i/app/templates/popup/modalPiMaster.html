<div id="modalPiMaster" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>점검 마스터 등록</h4>
		</div>

		<div class="modal-body">
			<div class="section-header" id="titleInfo">
				<h5>
					등록방법1. [점검복사] ▷ [계획] 정보 수정 ▷ [점검설비] 설비 변경 ▷ [점검항목] 항목 변경 ▷ [저장]</br>
					등록방법2. [계획] 정보 입력 ▶ [점검설비] 설비 추가 ▶ [점검항목] 항목 추가 ▶ [저장]
				</h5>
				<div class="button-group">
					<button type="button" class="btn-copy" id="copyPi" name="copyPi">
						점검복사
					</button>
				</div>
			</div>
			<div class="top-section">
				<div class="form-group col-md-4">
					<label for="result_work_title">점검명</label>
					<input type="text" class="form-control" id="head_chk_mast_nm" name="chk_mast_nm" readonly>
				</div>
				<div class="form-group col-md-4">
					<label for="head_chk_equip_item_cnt">점검설비 수량</label>
					<input type="text" class="form-control" id="head_chk_equip_item_cnt" name="head_chk_equip_item_cnt" value="0" readonly>
				</div>
				<div class="form-group col-md-4">
					<label for="head_equip_chk_item_cnt">점검항목 수량</label>
					<input type="text" class="form-control" id="head_equip_chk_item_cnt" name="head_equip_chk_item_cnt" value="0" readonly>
				</div>
			</div>
			<!-- 계획 섹션2 -->
			<div class="section">
				<div class="tab-group">
					<button class="tab-button active">계획</button>
					<button class="tab-button">점검설비</button>
					<button class="tab-button">점검항목</button>
					<button class="tab-button">작업결과 목록</button>
					<button class="tab-button">작업 WO 목록</button>
				</div>

				<div class="tab-content">
					<!-- 계획 탭 컨텐츠 -->
					<div id="piMasterFormContainer" class="tab-pane active">
						<form id="piMasterForm">
							<input type="hidden" id="chk_mast_pk" name="chk_mast_pk" value="">
							<div class="plan-content">
								<div class="form-row">
									<div class="form-group col-6">
										<label class="required">점검번호</label>
										<input type="text" class="form-control" id="piNumber" name="piNumber" placeholder="점검번호는 자동으로 생성됩니다" value="" readonly>
									</div>
									<div class="form-group col-6">
										<label class="required">점검명</label>
										<input type="text" class="form-control" id="piName" name="piName" data-msg="점검명을" placeholder="100자 이하로 입력하세요" value="">
									</div>
								</div>
								<div class="form-row">
									<!-- 주기단위 -->
									<div class="form-group col-3">
										<label class="required">주기단위</label>
										<select id="cycleType" data-msg="주기단위를" name="cycleType">
											<option value="">주기단위 선택</option>
										</select>
									</div>
									<div class="form-group col-3">
										<label class="required">반복</label>
										<div class="field-wrapper" style="display: flex; align-items: center">
											<span class="mt-2" style="margin-left: 5px;">매</span>
											<input id="perNumber" name="perNumber" data-msg="반복을" type="number" class="form-control" value="" />
										</div>
									</div>
									<!-- 주기시작일 -->
									<div class="form-group col-3">
										<label class="required">주기시작일</label>
										<div class="field-wrapper">
											<input type="date" id="schedStartDt" name="schedStartDt" data-msg="주기시작일을" value="" />
										</div>
									</div>
									<div class="form-group col-3">
										<label>점검일지</label>
										<select id="dailyReportCd11" name="dailyReportCd11">
											<option value="">점검일지 선택</option>
										</select>
									</div>
								</div>
								<div class="form-row">
									<div class="form-group col-6">
										<label class="required">점검부서</label>
										<select id="executionDept" name="executionDept">
											<option value="">점검부서 선택</option>
										</select>
									</div>
									<div class="form-group col-6">
										<label>점검담당자</label>
										<select id="piManager" name="piManager">
											<option value="">점검 담당자를 선택하세요</option>
										</select>
									</div>
								</div>
								<div class="form-row">
									<div class="form-group col-12">
										<label>작업지침</label>
										<textarea id="work_text" class="form-control" name="work_text" rows="3" placeholder="2000자 이하로 입력하세요" maxlength="2000"></textarea>
										<div class="char-count">0 / 2000 bytes</div>
									</div>
								</div>
							</div>
						</form>
					</div>
					<!--설비 선택-->
					<div id="piEquip" class="grid-content" style="display: none;">
						<div class="grid-header" style="display: flex; align-items: center; gap: 8px; justify-content: flex-start;">
							<label data-labelCd="점검설비" style="margin: 0; min-width: 80px;" class="required"></label>
							<div style="flex:1;"></div>
							<div style="text-align: right;">
								<button class="btn-save" id="selPiEquip" name="selPiEquip">설비선택 </button>
							</div>
						</div>
						</br>
						<div id="piEquipGrid"></div>
					</div>


					<!-- 점검항목 목록 탭 컨텐츠 -->
					<div id="piCheckItem" class="tab-pane" style="display: none;">
						<div class="section-header" style="display: flex; justify-content: space_between;">
							<label class="required" data-labelCd="점검항목"></label>
							<div class="button-group">
								<button type="button" id="addEmptyCheckItem" name="addEmptyCheckItem">
									빈항목추가
								</button>
								<button type="button" class="btn-save" id="addCheckItem" name="addCheckItem">
									점검항목추가
								</button>
							</div>
						</div>
						<div class="swing-el-tab-scroll">
							<table class="swing-table swing-table-bordered swing-table-striped mb-0" id="tblChkItem">
								<thead>
									<tr style="border-top: 2px solid #343a40;">
										<th width="5%" class="text-center">순번</th>
										<th width="8%" class="text-center">순서조정</th>
										<th width="30%" class="text-center">점검항목명*</th>
										<th width="7%" class="text-center">LCL</th>
										<th width="7%" class="text-center">UCL</th>
										<th width="10%" class="text-center">단위</th>
										<th width="10%" class="text-center">점검 가이드</th>
										<th style="display: none">점검 점검방법</th>
										<th style="display: none">점검 이상기준</th>
										<th width="5%" class="text-center">삭제</th>
										<th style="display: none">chkItemPk</th>
									</tr>
								</thead>
								<tbody id="piCheckTable">
								</tbody>
							</table>
						</div>
					</div>

					<!-- 점검결과 목록 탭 컨텐츠 -->
					<div id="piCheckResult" class="tab-pane" style="display: none;">
						<div class="section-header" style="display: flex; justify-content: flex-end; padding-top: 10px;">
							<div class="button-group">							
							</div>
						</div>
						<div class="swing-el-tab-scroll">
							<div id="piCheckResultGrid"></div>
						</div>
					</div>

					<!-- 작업 WO 목록 탭 컨텐츠 -->
					<div id="piWorkOrderContent" class="tab-pane" style="display: none;">
						<div class="section-header" style="display: flex; justify-content: flex-end; padding-top: 10px;">
							<div class="button-group">
							</div>
						</div>
						<div class="swing-el-tab-scroll">
							<div id="piWorkOrderGrid"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 버튼 영역 -->
		<div class="modal-footer">
			<button type="button" class="btn-save" style="background: #ff4d4f !important; color: #fff !important; border-color: #ff7875 !important; " id="btnNotApply">미적용</button>
			<button type="button" class="btn-save" id="saveBtn">저장</button>
			<button type="button" class="btn-close" id="closePmModal">닫기</button>
		</div>
	</div>
</div>
</div>

<!-- 점검 가이드 입력 Kendo Window 팝업 -->
<div id="chkGuideWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="reliabForm">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label for="chkMethod" class="required">점검방법</label>
					<input type="text" class="form-control" id="chkMethod" name="chkMethod" placeholder="25자 이하로 입력하세요">
				</div>
				<div class="form-group col-md-6">
					<label for="AnomalyCriteria" class="required">이상판단 기준</label>
					<input type="text" class="form-control" id="AnomalyCriteria" name="AnomalyCriteria" placeholder="50자 이하로 입력하세요">
				</div>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveChkGuide">확인</button>
		<button type="button" class="btn-close" id="btnCancelChkGuide">취소</button>
	</div>
</div>

<script type="text/x-kendo-template" id="tblChkEquipTemp">
	# if ( data.length == 0 ){ #
	<tr>
		<td colspan="9">조회된 데이터가 없습니다</td>
	</tr>
	# } #
	# for (let index=0; index<data.length; index++) { let item = data[index]; #
	<tr id="chkequip_rows_#=item.equip_pk#" >
		<td id="col" class="text-left">#=item.equip_cd#</td>
		<td id="col" class="text-left">#=item.equip_nm#</td>
		<td id="col" class="text-left">#=item.loc_nm#</td>
		<td id="col" class="text-left">#=item.equip_category_desc#</td>
		<td id="col" class="text-left">#=item.import_rank_cd#</td>
		<td id="col" class="text-left">#=item.equip_status_nm#</td>
		<td  class="text-center">
			<button  type ="button" class="btn-save btn-equip-delete" data-uid="#= item.equip_pk #">
				<span>삭제</span>
			</button>
		</td>
		<td id="colPk" style="display: none;">#=item.equip_pk#</td>
		<td id="colPk" style="display: none;">#=item.environ_equip_yn#</td>
	</tr>
	# } #

</script>

<script type="text/x-kendo-template" id="tblChkItemTemp">
	# if ( data.length == 0 ){ #
	<tr>
		<td colspan="9">조회된 데이터가 없습니다</td>
	</tr>
	# } #
	# for (let index=0; index<data.length; index++) { let item = data[index]; #
	<tr id="chkitem_rows_#=index#" >
		<td id="colItemIdx" class="text-center colItemIdx">#=item.itemIdx#</td>
		<td >
			<div class="btn-group">
				<button  type ="button" class="btn btn-xs btn-chkitem-down" data-uid="#= index #" style="font-size: 21px" >
					<img src="/static/img/caret-down-solid.svg"  alt="down" style="width: 24px; height: 24px;"/>
				</button>
				<button  type ="button" class="btn btn-xs btn-chkitem-up" data-uid="#= index #" style="font-size: 21px" >
					<img src="/static/img/caret-up-solid.svg" class="" alt="up" style="width: 24px; height: 24px;"/>
				</button>
			</div>
		</td>
		<td id="colChkItemNm" class="text-right bg-edit-cell">
			<input type="text" class="form-control chk_item_nm" maxlength="100" value="#= item.chk_item_nm #" />
		</td>
		<td id="colLcl" class="text-right bg-edit-cell">
			<input type="text" class="form-control lcl" maxlength="100" value="#= item.lcl #"/>
		</td>
		<td id="colUcl" class="text-right bg-edit-cell">
			<input type="text" class="form-control ucl" maxlength="100" value="#= item.ucl #"/>
		</td>
		<td id="chkItemUnitPk" class="text-right bg-edit-cell">
			<select class="chkItemUnitSelect" data-index="#= index #">
				<option value="">단위선택</option>
				# for (var i = 0; i < chkItemUnitData.length; i++) { #
				<option value="#= chkItemUnitData[i].value #"
					# if (item.chk_item_unit_pk == chkItemUnitData[i].value) { # selected # } #>
					#= chkItemUnitData[i].text #
				</option>
				# } #
			</select>
		</td>
		<td id="chkItemUnitPk2" class="text-right bg-edit-cell">
			<span id="addChkGuide">입력하기</span>
		</td>
		<td  class="text-center">
			<button  type ="button" class="btn-save btn-chkitem-delete" data-uid="#= index #">
				<span>삭제</span>
			</button>
		</td>
	</tr>
	# } #

</script>







<style>

	.section {
		flex: 1;
		display: flex;
		flex-direction: column;
		overflow: hidden;
	}

	.tab-content {
		overflow: auto;
	}

	.tab-pane {
		flex: 1;
		overflow: hidden;
		display: flex;
		flex-direction: column;
		min-height: 0;
	}

	.swing-el-tab-scroll {
		flex: 1;
		overflow-y: auto;
		overflow-x: hidden;
		min-height: 0;
	}

	#piCheckItem {
		height: auto !important;
		min-height: fit-content !important;
		overflow: visible;
	}

		/* 숨겨진 섹션들의 여백 완전 제거 */
		#piEquip.hidden-section,
		#piCheckItem.hidden-section,
		#piCheckResult.hidden-section,
		#piWorkOrderContent.hidden-section {
			display: none !important;
			position: absolute !important;
			visibility: hidden !important;
			height: 0 !important;
			min-height: 0 !important;
			max-height: 0 !important;
			overflow: hidden !important;
			margin: 0 !important;
			padding: 0 !important;
			border: none !important;
			opacity: 0 !important;
			pointer-events: none !important;
			z-index: -9999 !important;
			transform: scale(0) !important;
			width: 0 !important;
			max-width: 0 !important;
			left: -9999px !important;
			top: -9999px !important;
		}

	#work_text {
		height: 150px !important;
		resize: none;
	}

	.form-group {
		flex: 1;
		min-width: 0;
		margin-bottom: 10px;
	}

		.form-group:first-child {
			flex: 0.8;
		}

		.form-group:last-child {
			flex: 1.2;
		}

		.form-group label {
			font-size: 13px;
			font-weight: 600;
			color: #2c3e50;
			margin-bottom: 5px;
		}

	.char-count {
		text-align: right;
		color: #666;
		font-size: 12px;
		margin-top: 3px;
		padding-right: 5px;
	}

	.section {
		background: #fff;
		margin-bottom: 20px;
		height: auto;
	}

	.swing-el-tab-scroll, .swing-tab-scroll {
		overflow-y: auto !important;
		overflow-x: hidden;
	}

	.swing-table-bordered {
		border-top: 2px solid #7db4d8 !important;
		border-right: 1px solid #d1d3db;
	}

	.swing-table {
		background-color: transparent;
		width: 100% !important;
		max-width: 100%;
		margin-bottom: 0.9375rem;
		border-spacing: 0;
	}

		.swing-table > caption + thead > tr:first-child > th, .swing-table > colgroup + thead > tr:first-child > th, .swing-table > thead:first-child > tr:first-child > th, .swing-table > caption + thead > tr:first-child > td, .swing-table > colgroup + thead > tr:first-child > td, .swing-table > thead:first-child > tr:first-child > td {
			border-top: 0;
		}

	.swing-table-bordered > thead > tr > th {
		color: #656876;
		/* border-top: 0; */
		border-bottom: 1px solid #d1d3db !important;
		background-color: #ecf1f4;
	}

	.swing-table-bordered > thead > tr > th, .swing-table-bordered > thead > tr > td {
		border-bottom-width: 1px;
	}

	.swing-table > thead > tr > th {
		vertical-align: bottom;
		border-bottom: 1px solid #d1d3db;
	}

	.swing-table th, .swing-table td {
		padding: 0.75rem;
		line-height: 1.42857143;
		vertical-align: middle !important;
		border-width: 0 0 1px 1px !important;
		border-style: solid !important;
		border-color: #d1d3db !important;
	}

	.swing-table input[type="text"] {
		height: 10px;
		padding: 0px 0px;
	}

	table {
		border-collapse: collapse;
	}

	.text-center {
		text-align: center !important;
	}

	.text-right {
		text-align: right !important;
	}

	.text-left {
		text-align: left !important;
	}

	.bg-edit-cell {
		background-color: lightgoldenrodyellow !important;
	}

	.btn-group, .btn-group-vertical {
		position: relative;
		display: -webkit-inline-box;
		display: -ms-inline-flexbox;
		display: flex;
		vertical-align: middle;
		justify-content: center;
	}

		.btn-group > .btn, .btn-group-vertical > .btn {
			position: relative;
			-webkit-box-flex: 0;
			-ms-flex: 0 1 auto;
			flex: 0 1 auto;
			padding: 0px 0px;
			border-radius: 4px;
		}

	.btn-xs, .btn-group-xs > .btn {
		line-height: 1.5;
		background-color: #ecf1f4;
	}
</style>

<script type="text/javascript">
	let piMasterPage = null;
	class PiMaster {
		constructor() {
			this.grid = null;
			this.baseUrl = '/api/kmms/pi_master';
			this.piId = null;
			this.writeYn = true; // 기본값은 편집 가능

			//템플릿
			this.templateEquip = null;
			this.templateItem = null;

			//added by choi : 2025/06/10
	

			//점검항목 array
			this.chkItemGrid = [];
			this.chkItemUnitList = [];

			//점검결과 array
			this.chkResultGrid = [];

			//WO array
	
			this.init();
		}

		init() {
			let _this = this;
			const modal = $("#modalPiMaster");

			// cycleInfo 표시 여부 체크 함수
			this.checkCycleInfo = function () {
				const pmTypeValue = $('#pmType').val();
				if (pmTypeValue === 'PM_TYPE_TBM') {
					$('#cycleInfo').show();
				} else {
					$('#cycleInfo').hide();
				}
			};

			// 데이터 로드 함수
			this.loadPmData = function (pmPk) {
				let param = {
					action: 'read',
					pm_pk: pmPk
				};

				let result = AjaxUtil.getSyncData(this.baseUrl, param);
				if (result) {			
					// 데이터 로드 직후 cycleInfo 체크
					setTimeout(() => this.checkCycleInfo(), 0);
				}
			};

			// 모달이 표시될 때마다 cycleInfo 체크
			modal.on('show', function () {
				_this.checkCycleInfo();
			});

			$("#piEquipGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					data: [],
				}),
				height: 200,
				sortable: true,
				autoBind: false,
				editable: { confirmation: false },
				columns: [
					{ field: 'equip_pk', title: 'equip_pk', hidden: true },
					{ field: 'equip_cd', title: '설비코드', width: 100 },
					{ field: 'equip_nm', title: '설비명', width: 150 },
					{ field: 'loc_nm', title: '위치', width: 100 },
					{ field: 'equip_category_desc', title: '카테고리', width: 100 },
					{ field: 'import_rank_cd', title: '중요도', width: 100 },
					{ field: 'equip_status_nm', title: '상태', width: 80 },
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#piEquipGrid").data("kendoGrid");
								grid.removeRow(tr);
							}
						},
						title: "삭제",
						width: "10%"
					}
				],
				// 추가: 데이터 바인딩 후 합계 갱신
				dataBound: function (e) {

				}
			});

			$('#addChkGuide').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '점검 가이드 입력',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '50vw',
					}
					popupComn.openTempPopup($("#chkGuideWindow"), options);
				}
			});

			this.chkItemUnitList = [];

			let param = {
				combo_type: "cm_base_code",
				cond1: "CHK_ITEM_UNIT",
				cond2: "",
				cond3: "",
			};
			let result = AjaxUtil.getSyncData("/api/system/combo", param);

			this.chkItemUnitList.push(...result);

			//-----------------점검기본 초기화
			_this.bindMainEvents();

			//------------------점검항목 Kendo 템플릿 초기화
			_this.templateItem = kendo.template($("#tblChkItemTemp").html());

			// 2개의 데이타를 준비하고 piCheckTable에 삽입
			$("#piCheckTable").html(_this.templateItem({
				data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
			}));

			// 폼 데이터 초기화
			_this.renderPiMasterForm();

			//빈항목추가 버튼 이벤트 추가
			$('#addEmptyCheckItem').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // 기어 아이콘 (설비 관련)
				click: function (e) {
					e.preventDefault();

					//빈 항목 추가
					let checkItemData =
					{
						itemIdx: "",     //이 값은 html에서 값을 가져와야 함
						chk_item_nm: "",
						lcl: "",
						ucl: "",
						chk_item_unit_pk: "",
						guide: "",
						method: "",
						chkItemPk: "",
						dailyReportItemCd: ""
					};

					_this.chkItemGrid.push(checkItemData);

					// 렌더링 결과를 piCheckTable에 삽입
					$("#piCheckTable").html(_this.templateItem({
						data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
					}));

					_this.tableReorder('tblChkItem', 'colItemIdx');
				}
			});

			//점검항목추가 버튼 이벤트 추가
			$('#addCheckItem').kendoButton({
				themeColor: "base",
				icon: "k-i-zoom-in", // 줌인 아이콘
				size: "small",
				click: function (e) {
					e.preventDefault();

					setModalPosition('#modalchkItemMulti', { width: '60%', height: '50%' });
					chkItemTemplatePage.show(function (selectedItems) {
						console.log('data:', selectedItems);
						selectedItems.forEach(selItem => {
							const exists = _this.chkItemGrid.some(item => item.chk_item_nm === selItem.chk_item);
							if (!exists) {

								//빈 항목 추가
								let checkItemData =
								{
									itemIdx: "",     //이 값은 html에서 값을 가져와야 함
									chk_item_nm: selItem.chk_item,
									lcl: "",
									ucl: "",
									chk_item_unit_pk: selItem.chk_item_unit_pk,
									guide: "",
									method: "",
									chkItemPk: "",
									dailyReportItemCd: ""
								};

								_this.chkItemGrid.push(checkItemData);
							}
						});

						// 렌더링 결과를 piCheckTable에 삽입
						$("#piCheckTable").html(_this.templateItem({
							data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
						}));

						_this.tableReorder('tblChkItem', 'colItemIdx');
					});

				}
			});


			//----------------------end of 점검항목추가

			//----------------------점검결과
			
			// 점검결과 목록 탭 kendoGrid 초기화
			$("#piCheckResultGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					data: [],
				}),
				height: 200,
				sortable: true,
				autoBind: false,
				editable: false,
				columns: [
					{ field: 'schedule_no', title: '점검일정번호', width: '10%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'schedule_create_date', title: '점검일정 생성일', width: '15%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'schedule_status', title: '점검일정 상태', width: '15%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'planned_date', title: '점검 계획일', width: '15%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'completion_date', title: '점검 완료일', width: '15%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'abnormal_status', title: '점검이상', width: '10%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'responsible_person', title: '담당자', width: '10%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } }
				],
				dataBound: function (e) {
					// 데이터 바인딩 후 처리
				}
			});
			//----------------------end of 점검결과

					//----------------------WO
		// 작업 WO 목록 탭 kendoGrid 초기화
			$("#piWorkOrderGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					data: [],
				}),
				height: 200,
				sortable: true,
				autoBind: false,
				editable: false,
				columns: [
					{ field: 'work_order_no', title: '작업지시번호', width: '15%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'wo_title', title: '작업지시명', width: '25%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: left;' } },
					{ field: 'wo_status_nm', title: '작업상태', width: '12%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'wo_type_nm', title: '작업유형', width: '12%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'plan_start_dt', title: '계획시작일', width: '12%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'end_dt', title: '계획완료일', width: '12%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } },
					{ field: 'wo_user_nm', title: '담당자', width: '12%', headerAttributes: { style: 'text-align: center;' }, attributes: { style: 'text-align: center;' } }
				],
				dataBound: function (e) {
					// 데이터 바인딩 후 처리
				}
			});
			//----------------------end of WO

			$("#WoEquipGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					data: [],
				}),
				height: 200,
				sortable: true,
				autoBind: false,
				editable: { confirmation: false },
				columns: [
					{ field: "mtrl_cd", title: "자재코드", width: "20%", editable: false },
					{ field: "mtrl_nm", title: "자재명", width: "20%", editable: false },
					{
						field: "unit_price",
						title: "자재단가",
						width: "20%",
						editor: currencyEditor,
						template: function (dataItem) {
							if (dataItem.unit_price == null || dataItem.unit_price === "") return "";
							var cost = Number(dataItem.unit_price);
							if (isNaN(cost)) return dataItem.unit_price;
							return "₩ " + kendo.toString(cost, "n0");
						},
						attributes: { style: "text-align: right;" },
					},
					{ field: "a_amt", title: "A급 수량", width: "15%", attributes: { style: "text-align: right;" }, editor: numberOnlyEditor },
					{ field: "b_amt", title: "B급 수량", width: "15%", attributes: { style: "text-align: right;" }, editor: numberOnlyEditor },
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#WoEquipGrid").data("kendoGrid");
								grid.removeRow(tr);
							}
						},
						title: "삭제",
						width: "10%"
					}
				],
				// 추가: 단가, 수량 입력 후 blur 시 합계 갱신
				edit: function (e) {
					if (e.container) {
						e.container.find("input[name='unit_price'], input[name='a_amt'], input[name='b_amt']").on("blur", function () {
							updateMaterialCostSum();
						});
					}
				},
				// 추가: 데이터 바인딩 후 합계 갱신
				dataBound: function (e) {
					updateMaterialCostSum();
				}
			});


		}//end init()

		// 부모 페이지 새로고침 함수
		refreshParentPage() {
			try {
				// 1. page 객체가 존재하는 경우
				if (typeof page !== 'undefined' && page.searchMainData) {
					page.searchMainData();
				}
				// 2. window.opener가 존재하는 경우 (팝업에서 열린 경우)
				else if (window.opener && typeof window.opener.page !== 'undefined' && window.opener.page.searchMainData) {
					window.opener.page.searchMainData();
				}
				// 3. 부모 프레임이 존재하는 경우
				else if (window.parent && window.parent !== window && typeof window.parent.page !== 'undefined' && window.parent.page.searchMainData) {
					window.parent.page.searchMainData();
				}
				// 4. 페이지 새로고침
				else {
					location.reload();
				}
			} catch (error) {
				console.warn('부모 페이지 새로고침 실패:', error);
				// 최후의 수단으로 페이지 새로고침
				location.reload();
			}
		}

		bindMainEvents() {
			let _this = this;

			// 탭 클릭 이벤트 처리
			$('.tab-group button').on('click', function () {
				// 모든 탭에서 active 클래스 제거
				$('.tab-group button').removeClass('active');
				// 클릭된 탭에 active 클래스 추가
				$(this).addClass('active');

				// 모든 탭 컨텐츠 숨기기
				$('.tab-pane').removeClass('active').hide();
				// 모든 섹션을 완전히 숨기기 (여백 제거)
				$('#piEquip, #piCheckItem, #piCheckResult, #piWorkOrderContent')
					.addClass('hidden-section')
					.hide()
					.css({
						'width': '0',
						'max-width': '0',
						'min-width': '0',
						'left': '-9999px',
						'top': '-9999px',
						'transform': 'scale(0)',
						'clip': 'rect(0, 0, 0, 0)'
					});

				// 탭 내용 전환
				var tabName = $(this).text().trim();
				switch (tabName) {
					case '계획':
						$('#piMasterFormContainer').addClass('active').show();
						break;
					case '점검설비':
						$('#piEquip').removeClass('hidden-section').css({
							'width': 'auto',
							'max-width': 'none',
							'min-width': 'auto',
							'left': 'auto',
							'top': 'auto',
							'transform': 'none',
							'clip': 'auto'
						}).show();
						break;
					case '점검항목':
						$('#piCheckItem').removeClass('hidden-section').css({
							'width': 'auto',
							'max-width': 'none',
							'min-width': 'auto',
							'left': 'auto',
							'top': 'auto',
							'transform': 'none',
							'clip': 'auto'
						}).addClass('active').show();
						break;
					case '작업결과 목록':
						$('#piCheckResult').removeClass('hidden-section').css({
							'width': 'auto',
							'max-width': 'none',
							'min-width': 'auto',
							'left': 'auto',
							'top': 'auto',
							'transform': 'none',
							'clip': 'auto'
						}).addClass('active').show();
						break;
					case '작업 WO 목록':
						$('#piWorkOrderContent').removeClass('hidden-section').css({
							'width': 'auto',
							'max-width': 'none',
							'min-width': 'auto',
							'left': 'auto',
							'top': 'auto',
							'transform': 'none',
							'clip': 'auto'
						}).addClass('active').show();
						break;
				}
			});

			// 초기 상태: 계획 탭 활성화 및 모든 섹션 숨김
			$('.tab-group button:first').click();
			$('#piEquip, #piCheckItem, #piCheckResult, #piWorkOrderContent')
				.addClass('hidden-section')
				.hide()
				.css({
					'width': '0',
					'max-width': '0',
					'min-width': '0',
					'left': '-9999px',
					'top': '-9999px',
					'transform': 'scale(0)',
					'clip': 'rect(0, 0, 0, 0)'
				});



			$("#copyPi").kendoButton({
				icon: "k-i-copy",// 복사 아이콘
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalPiCopy', { width: '80%', height: '70%' });
					piCopyPage.show(function (res) {
						console.log('selectedPi:', res);

						FormUtil.BindDataForm(res, $('#piMasterForm'));

					});
				}
			});

			$("#btnNotApply").kendoButton({
				themeColor: 'error',
				click: function (e) {
					e.preventDefault();
					Alert.confirm('', '점검마스터를 사용안함 처리하시겠습니까?', function () {
						let data = { chkMastPk: _this.piId };
						let funcSucc = function (resp) {
							if (resp.success) {
								Alert.alert('', '정상처리 되었습니다.');
								_this.reset();
								$("#modalPiMaster").fadeOut();
							} else {
								Alert.alert('error', resp.message);
							}
						};
						AjaxUtil.postAsyncData(_this.baseUrl + '?action=delete', data, funcSucc);
					});
				}
			});

			$('#selPiEquip').kendoButton({
				themeColor: "base",
				icon: "k-i-zoom-in", // 줌인 아이콘
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEquipMultiSel', { width: '70%', height: '70%' });
					equipMultiSelectPage.show(function (data) {
						console.log('data:', data);
						let dataArr = Array.isArray(data) ? data : [data];
						const grid = $("#piEquipGrid").data("kendoGrid");
						if (!grid) return;

						dataArr.forEach(function (equip) {
							let equip_pk = equip.equip_pk;
							// 이미 추가된 자재인지 확인 (mat_pk 기준)
							const exists = grid.dataSource.data().some(item => item.equip_pk === equip_pk);
							if (exists) {
								// 이미 추가된 경우는 건너뜀
								return;
							}

							grid.dataSource.add({
								equip_pk: equip.equip_pk,
								equip_cd: equip.equip_cd,
								equip_nm: equip.equip_nm,
								loc_nm: equip.loc_nm,
								equip_category_desc: equip.equip_category_desc,
								equip_status_nm: equip.equip_status_nm,
								import_rank_cd: equip.import_rank_cd,
							});
						});
					});
				}
			});

			// ESC 키 누를 때 모달 닫기
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) { // ESC key
					modal.fadeOut();
				}
			});

			$("#saveBtn").kendoButton({
				icon: "k-i-save",
				click: function (e) {
					e.preventDefault();
					_this.saveData();
				},
				themeColor: "none"
			}).closest(".k-button").css({
				"background": "#ECF5FF",
				"color": "#409EFF",
				"border-color": "#B3D8FF",
				"border": "1px solid #00a9ff",
				"padding": "6px 12px",
				"border-radius": "4px",
				"cursor": "pointer",
				"min-width": "40px",
				"height": "28px",
				"line-height": "1"
			}).hover(
				function () {
					$(this).css({
						"background-color": "#C2DFFF",
						"border-color": "#0054e0"
					});
				},
				function () {
					$(this).css({
						"background": "#ECF5FF",
						"border-color": "#B3D8FF"
					});
				}
			);

			// 모달 닫기 - 닫기 버튼 클릭
			$('#closePmModal').kendoButton({
				click: function (e) {
					e.preventDefault();
					$('#modalPiMaster').fadeOut();
					_this.reset();
				}
			});
		}

		bindChkItemTemplateEvents() {
			let _this = this;

			//choi : kendo이벤트에서 처리하는게 어떨지???
			$("#piCheckTable").find(".btn-chkitem-delete").each(function () {
				const $button = $(this);

				$button.kendoButton({
					click: function (e) {
						e.preventDefault();
					},
				});
			});


			$('#piCheckTable').off('click', '.btn-chkitem-delete').on('click', '.btn-chkitem-delete', function () {
				const nIndex = $(this).data('uid');

				// 삭제 로직 추가
				_this.chkItemGrid.splice(nIndex, 1);

				// 렌더링 결과를 piCheckTable에 삽입
				$("#piCheckTable").html(_this.templateItem({
					data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
				}));
				_this.tableReorder('tblChkItem', 'colItemIdx');

			});

			$('#piCheckTable').off('click', '.btn-chkitem-down').on('click', '.btn-chkitem-down', function () {
				const index = $(this).data('uid');
				if (index === _this.chkItemGrid.length - 1) return; // 배열 마지막 번째 항목은 아래로 못 옮기므로 종료

				var $tr = $('#chkitem_rows_' + index).closest('tr'); // 현재 tr
				var $next = $tr.next(); // 다음 tr

				if ($next.length) {
					$next.after($tr); // 다음 tr 뒤에 현재 tr 삽입 (아래로 이동)
				}

				// 배열 순서도 아래로 이동
				const temp = _this.chkItemGrid[index];
				_this.chkItemGrid[index] = _this.chkItemGrid[index + 1];
				_this.chkItemGrid[index + 1] = temp;


				$("#piCheckTable").html(_this.templateItem({
					data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
				}));


				// 후처리 함수 호출 (예: 순번 및 이벤트 다시 설정하기)
				_this.tableReorder('tblChkItem', 'colItemIdx');

			});

			$('#piCheckTable').off('click', '.btn-chkitem-up').on('click', '.btn-chkitem-up', function () {
				const index = $(this).data('uid');

				if (index === 0) return; // 배열 첫 번째 항목은 위로 못 옮기므로 종료

				var $tr = $('#chkitem_rows_' + index).closest('tr'); // 해당 행
				var $prev = $tr.prev(); // 이전 행

				if ($prev.length) {
					$prev.before($tr); // 이전 tr 앞에 현재 tr 삽입 (위로 이동)
				}

				// 배열 순서도 위로 이동
				const temp = _this.chkItemGrid[index];
				_this.chkItemGrid[index] = _this.chkItemGrid[index - 1];
				_this.chkItemGrid[index - 1] = temp;


				$("#piCheckTable").html(_this.templateItem({
					data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
				}));


				// 정렬 후 후처리 함수 호출 (예: 순번 다시 매기기)
				_this.tableReorder('tblChkItem', 'colItemIdx');

			});


			$('#piCheckTable').off('input', '.chk_item_nm').on('input', '.chk_item_nm', function () {
				const $tr = $(this).closest('tr');
				const rowIndex = $tr.index();  // tbody 기준 몇 번째 tr인지
				const value = $(this).val();               // 변경된 값

				if (_this.chkItemGrid && _this.chkItemGrid[rowIndex]) {
					_this.chkItemGrid[rowIndex].chk_item_nm = value;  // 데이터 반영
				}
			});

			$('#piCheckTable').off('input', '.lcl').on('input', '.lcl', function () {
				const $tr = $(this).closest('tr');
				const rowIndex = $tr.index();  // tbody 기준 몇 번째 tr인지

				const value = $(this).val();               // 변경된 값

				if (_this.chkItemGrid && _this.chkItemGrid[rowIndex]) {
					_this.chkItemGrid[rowIndex].lcl = value;  // 데이터 반영
				}
			});

			$('#piCheckTable').off('input', '.ucl').on('input', '.ucl', function () {
				const $tr = $(this).closest('tr');
				const rowIndex = $tr.index();  // tbody 기준 몇 번째 tr인지


				const value = $(this).val();               // 변경된 값

				if (_this.chkItemGrid && _this.chkItemGrid[rowIndex]) {
					_this.chkItemGrid[rowIndex].ucl = value;  // 데이터 반영
				}
			});



			$("#piCheckTable").find(".chkItemUnitSelect").each(function () {
				const $select = $(this);
				const selectedValue = $select.val();

				// 기존 인스턴스 제거 (재랜더링 시 필요)
				if ($select.data("kendoDropDownList")) {
					$select.data("kendoDropDownList").destroy();
					$select.show(); // DropDown 생성 전 숨겨진 원래 select 보이게
				}

				// KendoDropDownList 설정
				$select.kendoDropDownList({
					dataSource: _this.chkItemUnitData,         // 전역 혹은 상위에서 접근 가능한 단위 리스트
					dataTextField: "value",
					dataValueField: "text",
					//optionLabel: "단위선택",
					value: selectedValue,                // 기존 선택값 유지
					change: function () {

						//const $select = $(this);
						const $select = this.element; // ← Kendo가 만든 DropDown의 원본 <select> 엘리먼트

						const $tr = $select.closest('tr');
						const rowIndex = $tr.index();  // tbody 기준 몇 번째 tr인지

						const selectedValue = this.value();

						const newValue = this.value();

						if (_this.chkItemGrid && _this.chkItemGrid[rowIndex]) {
							_this.chkItemGrid[rowIndex].chk_item_unit_pk = newValue;
						}
					}
				});
			});
		}

		tableReorder(tableId, orderColClass) {
			let _this = this;
			$('#' + tableId + ' tbody tr').each(function (i) {
				$(this).find('.' + orderColClass).text(i + 1);  // ← class 기준으로 order번호를 변경
			});

			//choi : 새롭게 정렬된 tr에 바인딩을 새로함
			_this.bindChkItemTemplateEvents();

		}

		saveData() {
			let _this = this;
			let data = FormUtil.extractForm($('#piMasterForm'));
			data.dept_pk = $("#executionDept").data("kendoDropDownTree").value();

			if (checkForm($('#piMasterForm')) === false) return;
			if (!data.dept_pk) {
				Alert.alert('', '점검부서를 선택해주세요.');
				return;
			}

			//설비
			let piEquipGrid = $("#piEquipGrid").data("kendoGrid");
			if (!piEquipGrid || piEquipGrid.dataSource.total() === 0) {
				Alert.alert('', '점검설비를 선택해주세요.');
				return;
			}
			if (piEquipGrid) {
				let gridData = piEquipGrid.dataSource.data();
				data.chkEquips = gridData.map(item => item.equip_pk).join(','); // 문자열
			}

			//선택한 점검항목 정보를 꺼낸다
			data.equipChkItems = JSON.stringify(this.chkItemGrid);

			let funcSucc = function (resp) {
				if (resp.success) {
					FormUtil.resetForm($("#piMasterForm"));
					// 부모 페이지 새로고침
					_this.refreshParentPage();

				} else {
					Alert.alert('error', resp.message);
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, funcSucc);

			$("#modalPiMaster").fadeOut();
		}

		// PI 마스터 폼 렌더링 메서드
		renderPiMasterForm(formData = {}) {
			let _this = this;

			// 기본 데이터 설정
			let defaultData = {
				chk_mast_pk: '',
				piNumber: '',
				piName: '',
				cycleType: '',
				perNumber: '',
				schedStartDt: '',
				work_text: '',
				writeYn: this.writeYn,
				mode: '',
				dept_pk: '',
			};

			// 전달받은 데이터와 기본 데이터 병합
			let renderData = { ...defaultData, ...formData, writeYn: this.writeYn };

			// 폼 필드에 직접 값 설정
			$("#chk_mast_pk").val(renderData.chk_mast_pk);
			$("#piNumber").val(renderData.piNumber);
			$("#piName").val(renderData.piName);
			$("#perNumber").val(renderData.perNumber);
			$("#work_text").val(renderData.work_text);

			// Kendo 컴포넌트 초기화
			_this.initializeKendoComponents();

			// 설비선택 버튼 표시/숨김 제어
			_this.updateEquipmentButtonVisibility();

			// 폼 모드 설정
			_this.setFormMode(this.mode);
		}

		// Kendo 컴포넌트 초기화
		initializeKendoComponents() {
			let _this = this;

			// 드롭다운 초기화
			AjaxUtil.fillDropDownTreeOptions($("#executionDept"), "depart", "select");
			AjaxUtil.fillDropDownOptions($('#piManager'), 'cm_user_info', 'choose', null);
			AjaxUtil.fillDropDownOptions($('#cycleType'), 'cm_base_code', 'choose', null, 'CYCLE_TYPE');
			AjaxUtil.fillDropDownOptions($('#dailyReportCd11'), 'cm_base_code', 'choose', null, 'DAILY_REPORT_TYPE');

			// DatePicker 초기화 (이미 존재하지 않는 경우에만)
			if (!$("#schedStartDt").data("kendoDatePicker")) {
				let today = CommonUtil.getYYYYMMDD();
				$("#schedStartDt").kendoDatePicker({
					value: today,
					format: "yyyy-MM-dd",
					enabled: this.writeYn
				});
			}

			// 글자수 카운트 기능 (이벤트 중복 등록 방지)
			$('#work_text').off('input').on('input', function () {
				const maxLength = 2000;
				const currentLength = $(this).val().length;
				$('.char-count').text(`${currentLength} / ${maxLength} bytes`);

				// 최대 글자수 체크
				if (currentLength > maxLength) {
					$(this).val($(this).val().substring(0, maxLength));
				}
			});

			// 초기 글자수 표시
			const initialLength = $('#work_text').val().length;
			$('.char-count').text(`${initialLength} / 2000 bytes`);
		}

		// 설비선택 버튼 표시/숨김 제어 메서드
		updateEquipmentButtonVisibility() {
			// 최초 등록 시에만 버튼 표시 (piId가 없거나 0일 때)
			if (!this.piId || this.piId === 0) {
				$('#equipmentButtonGroup').show();
			} else {
				$('#equipmentButtonGroup').hide();
			}
		}

		// 폼 모드 설정 (읽기/편집/등록)
		setFormMode(mode) {
			const isReadMode = mode === 'read';
			const isEditMode = mode === 'edit';
			const isRegMode = mode === 'reg';

			console.log('폼 모드 설정:', mode, '읽기모드:', isReadMode, '편집모드:', isEditMode, '등록모드:', isRegMode);

			// 모달 전체에서 모든 입력 요소들을 자동으로 찾아서 처리
			const modal = $('#modalPiMaster');
			const allInputs = modal.find('input, select, textarea');

			allInputs.each(function () {
				const element = $(this);
				const elementId = element.attr('id');

				// 특정 필드들은 제외 (예: readonly 필드, hidden 필드)
				if (elementId === 'chk_mast_pk' || element.attr('type') === 'hidden') return;

				// Kendo UI 컴포넌트인지 확인
				const kendoTypes = ['kendoDropDownList', 'kendoDatePicker', 'kendoSwitch', 'kendoTextBox', 'kendoDropDownTree'];
				let isKendoComponent = false;
				let kendoType = null;

				for (const type of kendoTypes) {
					if (element.data(type)) {
						isKendoComponent = true;
						kendoType = type;
						break;
					}
				}

				if (isKendoComponent) {
					// Kendo UI 컴포넌트 처리
					try {
						const kendoInstance = element.data(kendoType);
						if (kendoInstance && typeof kendoInstance.enable === 'function') {
							kendoInstance.enable(!isReadMode);
						}
					} catch (e) {
						console.log(`Kendo component error for ${elementId}:`, e);
					}
				} else {
					// 일반 입력 필드 처리
					element.prop('disabled', isReadMode);
				}
			});

			// 버튼들도 모드에 따라 표시/숨김
			if (isReadMode) {
				// 읽기모드: 모든 편집 관련 버튼 숨김
				$('#saveBtn').hide();
				$('#btnNotApply').hide();
				$('#copyPi').hide();
				$('#selPiEquip').hide(); // 설비선택 버튼 숨김
				$('#addEmptyCheckItem').hide();
				$('#addCheckItem').hide();
				$('#btnSaveChkGuide').hide();
				$('#btnCancelChkGuide').hide();

				// 점검설비 삭제 버튼 숨김
				$('.btn-equip-delete').hide();
				// 점검항목 삭제 버튼 숨김
				$('.btn-chkitem-delete').hide();
				// 점검항목 순서조정 버튼 숨김
				$('.btn-chkitem-up, .btn-chkitem-down').hide();

				// 점검항목 입력 필드 비활성화
				$('.chk_item_nm, .lcl, .ucl, .chkItemUnitSelect').prop('disabled', true);

				// 모달 제목 변경
				$('.modal-header h4').text('점검 마스터 상세보기');

			} else if (isEditMode) {
				// 편집모드: 기존 점검 마스터 수정 시 모든 버튼 표시
				$('#saveBtn').show();
				$('#btnNotApply').show();
				$('#copyPi').show();
				$('#selPiEquip').show(); // 설비선택 버튼 표시
				$('#addEmptyCheckItem').show();
				$('#addCheckItem').show();
				$('#btnSaveChkGuide').show();
				$('#btnCancelChkGuide').show();

				// 점검설비 삭제 버튼 표시
				$('.btn-equip-delete').show();
				// 점검항목 삭제 버튼 표시
				$('.btn-chkitem-delete').show();
				// 점검항목 순서조정 버튼 표시
				$('.btn-chkitem-up, .btn-chkitem-down').show();

				// 점검항목 입력 필드 활성화
				$('.chk_item_nm, .lcl, .ucl, .chkItemUnitSelect').prop('disabled', false);

				// 모달 제목 변경
				$('.modal-header h4').text('점검 마스터 수정');

			} else if (isRegMode) {
				// 등록모드: 새 점검 마스터 등록 시 일부 버튼만 표시
				$('#saveBtn').show();
				$('#btnNotApply').hide();
				$('#copyPi').show();
				$('#selPiEquip').show(); // 설비선택 버튼 표시
				$('#addEmptyCheckItem').show();
				$('#addCheckItem').show();
				$('#btnSaveChkGuide').show();
				$('#btnCancelChkGuide').show();

				// 점검설비 삭제 버튼 표시
				$('.btn-equip-delete').show();
				// 점검항목 삭제 버튼 표시
				$('.btn-chkitem-delete').show();
				// 점검항목 순서조정 버튼 표시
				$('.btn-chkitem-up, .btn-chkitem-down').show();

				// 점검항목 입력 필드 활성화
				$('.chk_item_nm, .lcl, .ucl, .chkItemUnitSelect').prop('disabled', false);

				// 모달 제목 변경
				$('.modal-header h4').text('점검 마스터 등록');
			}
		}

		reset() {
			this.piId = null; // piId 초기화
			this.mode = 'reg'; // 모드를 등록 모드로 초기화
			this.writeYn = true; // 편집 가능하도록 설정

			// 데이터 배열 초기화
			this.chkItemGrid = [];

			// 헤더 필드 초기화
			$("#head_chk_mast_nm").val('');
			$("#head_chk_equip_item_cnt").val('0');
			$("#head_equip_chk_item_cnt").val('0');

			// 폼 필드 초기화
			$("#chk_mast_pk").val('');
			$("#piNumber").val('');
			$("#piName").val('');
			$("#perNumber").val('');
			$("#work_text").val('');
			$('.char-count').text('0 / 2000 bytes');

			// 주기 정보 체크
			this.checkCycleInfo();

			// 탭 초기화 (첫 번째 탭으로 이동)
			$('.tab-button').removeClass('active');
			$('.tab-pane').removeClass('active').hide();
			// 모든 섹션을 완전히 숨기기 (여백 제거)
			$('#piEquip, #piCheckItem, #piCheckResult, #piWorkOrderContent')
				.addClass('hidden-section')
				.hide()
				.css({
					'width': '0',
					'max-width': '0',
					'min-width': '0',
					'left': '-9999px',
					'top': '-9999px',
					'transform': 'scale(0)',
					'clip': 'rect(0, 0, 0, 0)'
				});
			$('.tab-button:first').addClass('active');
			$('#piMasterFormContainer').addClass('active').show();

			// 점검항목 그리드 초기화 (Kendo 템플릿 재렌더링)
			if (this.templateItem) {
				$("#piCheckTable").html(this.templateItem({
					data: this.chkItemGrid,
					chkItemUnitData: this.chkItemUnitList
				}));
			}

			// titleInfo 표시 (새 등록 모드)
			$('#titleInfo').show();

			// 폼 모드 설정 (등록 모드)
			this.setFormMode('reg');
		}


		finalizeSave() {
			Notify.success('저장되었습니다.');
			this.reset();
			page.searchMainData();
		}

		searchLocationData() {
			let _this = this;

			let param = {
				action: 'read',
			};

			let result = AjaxUtil.getSyncData(_this.baseUrl, param);
			_this.grid.setData(result);
			// 데이터 로드 후 cycleInfo 체크
			this.checkCycleInfo();
		}

		//pi 마스터 상세보기
		show(piId, mode) {
			let _this = this;

			// mode가 전달되지 않은 경우에만 기본값 적용
			if (mode === undefined || mode === null) {
				mode = 'read';
			}

			console.log('PiMaster.show 호출:', 'piId:', piId, 'mode:', mode);

			// 모드에 따라 설정
			switch (mode) {
				case 'read':
					this.mode = 'read';//읽기 모드
					_this.writeYn = false; // 읽기 전용 모드
					break;
				case 'edit':
					this.mode = 'edit';//편집 모드
					_this.writeYn = true; // 편집 모드
					break;
				default:
					this.mode = 'reg';//등록 모드
					_this.writeYn = true; // 등록 모드
					break;
			}

			// '계획' 탭 항상 active 처리
			$('.tab-button').removeClass('active');
			$('.tab-pane').removeClass('active').hide();
			// 모든 섹션을 완전히 숨기기 (여백 제거)
			$('#piEquip, #piCheckItem, #piCheckResult, #piWorkOrderContent')
				.addClass('hidden-section')
				.hide()
				.css({
					'width': '0',
					'max-width': '0',
					'min-width': '0',
					'left': '-9999px',
					'top': '-9999px',
					'transform': 'scale(0)',
					'clip': 'rect(0, 0, 0, 0)'
				});
			$('.tab-button:first').addClass('active');
			$('#piMasterFormContainer').addClass('active').show();

			// titleInfo show/hide 처리 추가
			if (piId > 0) {
				_this.piId = piId;
				$('#titleInfo').hide();

				// 1. PI 상세 정보 API 호출
				let param = {
					action: 'findOne',
					chkMastPk: piId,
				};
				let piData = AjaxUtil.getSyncData(_this.baseUrl, param);
				console.log(piData);

				$("#head_chk_mast_nm").val(piData.chk_mast_nm);
				$("#head_chk_equip_item_cnt").val(piData.chk_equip_item_cnt);
				$("#head_equip_chk_item_cnt").val(piData.equip_chk_item_cnt);

				// 기존 데이터 바인딩
				_this.bindPiMasterData(piData);

				// 3. 점검항목을 가져온다
				let param3 = {
					action: 'findAll',
					chkMastPk: piId,
				};

				let itemData = AjaxUtil.getSyncData('/api/kmms/equip_chk_item', param3);

				if (itemData && Array.isArray(itemData)) {
					itemData.forEach(item => {
						if (item.ucl == null) {
							item.ucl = '';
						}
						if (item.lcl == null) {
							item.lcl = '';
						}
					});
				}

				_this.chkItemGrid = itemData;
				$("#piCheckTable").html(_this.templateItem({
					data: _this.chkItemGrid, chkItemUnitData: _this.chkItemUnitList
				}));

				// 후처리 함수 호출 (예: 순번 및 이벤트 다시 설정하기)
				_this.tableReorder('tblChkItem', 'colItemIdx');

				// 4. 점검결과를 가져온다
				let param4 = {
					action: 'selectEquipResultList',
					chkMastPk: piId,
				};

				let resultData = AjaxUtil.getSyncData(_this.baseUrl, param4);

				_this.chkResultGrid = resultData;
				// 점검결과 목록 kendoGrid에 데이터 바인딩
				let grid = $("#piCheckResultGrid").data("kendoGrid");
				if (grid) {
					grid.dataSource.data(_this.chkResultGrid);
				}

				// 5. WO List를 가져온다
				let param5 = {
					action: 'selectEquipWoList',
					chkMastPk: piId,
				};

				let woDataList = AjaxUtil.getSyncData(_this.baseUrl, param5);


				// 작업 WO 목록 kendoGrid에 데이터 바인딩
				let woGrid = $("#piWorkOrderGrid").data("kendoGrid");
				if (woGrid) {
					woGrid.dataSource.data(_this.chkWoGrid);
				}
			}
			else {
				_this.reset();
				$('#titleInfo').show();
			}

			// 설비선택 버튼 표시/숨김 제어
			_this.updateEquipmentButtonVisibility();

			// 폼 모드 설정
			_this.setFormMode(this.mode);

			$("#modalPiMaster").fadeIn();
		}

		/**
		 * PI 마스터 데이터를 모달 폼에 바인딩하는 함수
		 * @param {Object} piData - PI 마스터 상세 데이터
		 */
		bindPiMasterData(piData) {
			let _this = this;

			console.log('bindPiMasterData 호출:', 'piData:', piData, 'mode:', this.mode);

			// 폼 필드에 직접 값 설정
			$("#chk_mast_pk").val(piData.chk_mast_pk || '');
			$("#piNumber").val(piData.chk_mast_no || '');
			$("#piName").val(piData.chk_mast_nm || '');
			$("#perNumber").val(piData.per_number || '');
			$("#work_text").val(piData.work_text || '');

			// Kendo 컴포넌트 값 설정 (비동기로 처리)
			setTimeout(function () {
				// Kendo 컴포넌트 바인딩 함수
				function bindKendoComponent(selector, value) {
					let component = $(selector).data("kendoDropDownList") || $(selector).data("kendoDropDownTree") || $(selector).data("kendoDatePicker");
					if (component && value) {
						component.value(value);
						component.trigger("change");
					}
				}

				// 각 컴포넌트 바인딩
				bindKendoComponent("#cycleType", piData.cycle_type_cd);
				bindKendoComponent("#executionDept", piData.dept_pk);
				bindKendoComponent("#piManager", piData.chk_user_pk);
				bindKendoComponent("#dailyReportCd11", piData.daily_report_cd);
				bindKendoComponent("#schedStartDt", piData.sched_start_date);

				// 글자수 카운트 업데이트
				const workTextLength = $('#work_text').val().length;
				$('.char-count').text(`${workTextLength} / 2000 bytes`);
			}, 200);

			// 모드별 폼 상태 설정
			_this.setFormMode(this.mode);
		}

	}

	$(document).ready(function () {
		piMasterPage = new PiMaster();

		// pmType 선택 이벤트 핸들러 추가
		$('#pmType').on('change', function () {
			piMasterPage.checkCycleInfo();
		});

		// 모달이 표시될 때마다 cycleInfo 체크 (jQuery fadeIn 방식)
		const originalFadeIn = $.fn.fadeIn;
		$.fn.fadeIn = function () {
			if (this.attr('id') === 'modalPiMaster') {
				setTimeout(() => piMasterPage.checkCycleInfo(), 0);
			}
			return originalFadeIn.apply(this, arguments);
		};

	});

	// 화폐 입력란 에디터
	function currencyEditor(container, options) {
		$('<input name="' + options.field + '" type="text" class="k-input k-textbox" style="text-align:right; width:100%;" />')
			.appendTo(container)
			.on('input', function () {
				this.value = this.value.replace(/[^0-9]/g, '');
			});
		$('<span style="position:absolute; right:16px; top:8px; color:#888; pointer-events:none;">₩</span>').appendTo(container);
	}
	// 숫자만 입력 에디터
	function numberOnlyEditor(container, options) {
		$('<input name="' + options.field + '" type="number" min="0" class="k-input k-textbox" style="text-align:right; width:100%;" />')
			.appendTo(container)
			.on('input', function () {
				this.value = this.value.replace(/[^0-9]/g, '');
			});
	}

</script>
