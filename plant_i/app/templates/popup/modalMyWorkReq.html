<div id="modalMyWorkReq" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>WO 요청작성</h4>
        </div>

        <div class="modal-body">
            <!-- 가이드라인 섹션 -->
            <div class="top-section">
                <div class="section-header">
                    <h5>
                        설비가 "사후보전"으로 작업이 진행 중이면 사후보전은 추가 요청 불가, 그 외에는 추가 요청이 가능합니다.</br>
                        예방적 조치는 "예방보전", 성능 개선은 "개량보전", 설치/철거/페인팅 등은 "일반작업" 으로 요청해 주세요.
                    </h5>
                    <div class="button-group">
                        <button type="button" class="btn-copy" id="copyWO" name="copyWO">
                            W/O복사
                        </button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>WO 번호</label>
                        <input type="hidden" id="wo_pk" name="wo_pk" />
                        <input type="text" class="form-control" id="wo_code" name="wo_code" readonly placeholder="요청 후 번호 생성">
                    </div>
                    <div class="form-group">
                        <label>설비 <span class="required">*</span></label>
                        <button type="button" class="zoombutton" id="selectEquipment" name="selectEquipment"></button>
                        <input type="text" class="form-control" id="equ_name" name="equ_name" readonly placeholder="관련 설비를 선택하세요">
                    </div>
                    <div class="form-group">
                        <label>설비위치</label>
                        <input type="text" class="form-control" id="equ_loc_pk" name="equ_loc_pk" readonly>
                    </div>
                    <div class="form-group">
                        <label>보증만료일</label>
                        <input type="text" class="form-control" id="expiration_date" name="expiration_date" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group second-group">
                        <label>작업제목 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="equ_loc" name="equ_loc" placeholder="200자 이하로 입력하세요">
                    </div>
                    <div class="form-group second-group">
                        <label>보전유형 <span class="required">*</span></label>
                        <select id="pmType" name="pmType"></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>작업부서 <span class="required">*</span></label>
                        <select id="executionDept" name="executionDept"></select>
                    </div>
                    <div class="form-group">
                        <label>작업담당자 <span class="required">*</span></label>
                        <select id="pmManager" name="pmManager">
                            <option value="">작업담당자를 선택하세요</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; flex-direction: column;">
                        <label>희망일자(마침) <span class="required">*</span></label>
                        <div class="field-wrapper">
                            <input type="date" id="schedStartDt" name="schedStartDt" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>고장일시 <span class="required">*</span></label>
                        <div class="field-wrapper">
                            <input type="date" id="schedEndDt" name="schedEndDt" />
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>현상 <span class="required">*</span></label>
                        <button type="button" class="plusbutton" id="selectProblem" name="selectProblem"></button>
                        <select id="woProblem" name="woProblem"></select>
                    </div>
                    <div class="form-group">
                        <label>작업구분</label>
                        <select id="woType" name="woType"></select>
                    </div>
                    <div class="form-group">
                        <label>프로젝트</label>
                        <button type="button" class="plusbutton" id="selectProject" name="selectProject"></button>
                        <select id="projectName" name="projectName"></select>
                    </div>
                </div>

            </div>

            <!-- 요청정보 섹션 -->
            <div class="section">
                <div class="tab-group">
                    <button class="tab-button active" data-tab="myWorkReqForm">요청정보</button>
                    <button class="tab-button" data-tab="fileTab">파일</button>
                </div>
                <div class="tab-content">
                    <!-- 요청정보 탭 컨텐츠 -->
                    <div class="tab-pane active" id="myWorkReqForm">
                        <label>요청사항</label>
                        <section class="section">
                            <textarea id="editor" style="height:300px" aria-label="editor"></textarea>
                        </section>
                    </div>
                    <!-- 파일 탭 컨텐츠 -->
                    <div class="tab-pane" id="fileTab" style="overflow-y:auto; height: 400px;">
                        {% include 'components/FileUpload.html' %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 버튼 영역 -->
        <div class="modal-footer">
            <button type="button" class="btn-save" id="saveBtn">저장</button>
            <button type="button" class="btn-close" id="closeMyWorkReqModal">닫기</button>
        </div>
    </div>
</div>

<style>
    /* ✅ 부모 모달의 z-index */
    #modalMyWorkReq {
        z-index: 1000 !important;
    }

    /* 비율 조정 */
    .form-group {
        flex: 1;
        min-width: 0;
        margin-bottom: 0px;
    }

        .form-group:first-child {
            flex: 0.8;
        }

        .form-group:last-child {
            flex: 1.2;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            height: 24px;
        }

    .modalMyWorkReq .second-group {
        flex: 1;
        min-width: 0;
        margin-bottom: 0px;
    }

    .modalMyWorkReq .second-group:first-child {
        flex: 2.7 !important;
    }

    .modalMyWorkReq .second-group:last-child {
        flex: 1.1 !important;
    }

    .section {
        background: #fff;
        margin-bottom: 20px;
        height: auto;
    }

</style>

<script type="text/javascript">
    let myWorkReqPage = null;
    class MyWorkReq {
        constructor() {
            this.baseUrl = '/api/kmms/pm_master';

            this.resetForm = this.resetForm.bind(this);
            this.init();
        }

        init() {
            let _this = this;
            const modal = $("#modalMyWorkReq");

            // cycleInfo 표시 여부 체크 함수
            this.checkCycleInfo = function () {
                const pmTypeValue = $('#pmType').val();
                if (pmTypeValue === 'PM_TYPE_TBM') {
                    $('#cycleInfo').show();
                } else {
                    $('#cycleInfo').hide();
                }
            };

            // 데이터 로드 함수
            this.loadPmData = function (pmPk) {
                let param = {
                    action: 'read',
                    pm_pk: pmPk
                };

                let result = AjaxUtil.getSyncData(this.baseUrl, param);
                if (result) {
                    // FormUtil.fillForm($('#myWorkReqForm'), result);
                    // 데이터 로드 직후 cycleInfo 체크
                    setTimeout(() => this.checkCycleInfo(), 0);
                }
            };

            // 모달이 표시될 때마다 cycleInfo 체크
            modal.on('show', function () {
                _this.checkCycleInfo();
            });

            AjaxUtil.fillDropDownOptions($('#pmType'), 'user_code', 'choose', null, 'PM_TYPE');
            AjaxUtil.fillDropDownTreeOptions($("#executionDept"), "depart", "select");
            AjaxUtil.fillDropDownOptions($('#pmManager'), 'auth_user', 'choose', null);
            AjaxUtil.fillDropDownOptions($('#cycleType'), 'user_code', 'choose', null, 'CYCLE_TYPE');
            AjaxUtil.fillDropDownOptions($('#woProblem'), 'user_code', 'choose', null, 'CYCLE_TYPE');
            AjaxUtil.fillDropDownOptions($('#woType'), 'user_code', 'choose', null, 'CYCLE_TYPE');
            AjaxUtil.fillDropDownOptions($('#projectName'), 'user_code', 'choose', null, 'CYCLE_TYPE');

            let today = CommonUtil.getYYYYMMDD();
            $("#schedStartDt").kendoDatePicker({
                value: today,
                format: "yyyy-MM-dd",
            });

            $("#schedEndDt").kendoDateTimePicker({
                value: today,
                format: "yyyy-MM-dd",
            });

            $("#copyWO").kendoButton({
                icon: "k-i-copy",// 복사 아이콘
                click: function (e) {
                    e.preventDefault();
                    $("#modalWoCopy").fadeIn();
                }
            });

            $('#selectEquipment').kendoButton({
                themeColor: "base",
                icon: "k-i-zoom-in", // 줌인 아이콘
                rounded: "full",
                size: "small",
                click: function (e) {
                    e.preventDefault();
                    pageEquModal.show(function (selectedEqu) {
                        // 선택된 설비 데이터 처리
                        $('#equip_pk').val(selectedEqu.id);
                        $('#equ_code').val(selectedEqu.Code);
                        $('#equ_name').val(selectedEqu.Name);
                        $('#equ_loc_pk').val(selectedEqu.id);
                        $('#equ_loc').val(selectedEqu.loc_nm);
                        $('#equ_status').val(selectedEqu.Status);
                        $('#equ_import').val(selectedEqu.import_rank);
                        $('#equ_env_yn').val(selectedEqu.environ_equip_yn);
                    });
                }
            });

            $('#selectProblem').kendoButton({
                themeColor: "base",
                icon: "k-i-plus", 
                rounded: "full",
                size: "small",
                click: function (e) {
                    e.preventDefault();
                    $("#modalWoProblem").fadeIn();
                }
            });

            $('#selectProject').kendoButton({
                themeColor: "base",
                icon: "k-i-plus", 
                rounded: "full",
                size: "small",
                click: function (e) {
                    e.preventDefault();
                    $("#modalWoProject").fadeIn();
                }
            });

            // ESC 키 누를 때 모달 닫기
            $(document).on('keydown', (e) => {
                if (e.keyCode === 27) { // ESC key
                    modal.fadeOut();
                }
            });

            $("#saveBtn").kendoButton({
                icon: "k-i-save",
                click: function (e) {
                    e.preventDefault();
                    _this.saveData();
                },
                themeColor: "none"
            });

            // 모달 닫기 - 닫기 버튼 클릭
            $('#closeMyWorkReqModal').kendoButton({
                click: function (e) {
                    e.preventDefault();
                    modal.fadeOut();
                }
            });

            // 탭 이벤트 초기화 추가
            _this.initTabEvents();

            // 에디터 기능입니다. 컴포넌트로 분리작업 필요합니다.
            var editor = $("#editor").kendoEditor({
                tools: [
                    "undo",
                    "redo",
                    { name: "separator1", type: "separator" },
                    {
                        name: "fontName",
                        items: [
                            { text: "Andale Mono", value: "\"Andale Mono\"" }, // Font-family names composed of several words should be wrapped in \" \"
                            { text: "Arial", value: "Arial" },
                            { text: "Arial Black", value: "\"Arial Black\"" },
                            { text: "Book Antiqua", value: "\"Book Antiqua\"" },
                            { text: "Comic Sans MS", value: "\"Comic Sans MS\"" },
                            { text: "Courier New", value: "\"Courier New\"" },
                            { text: "Georgia", value: "Georgia" },
                            { text: "Helvetica", value: "Helvetica" },
                            { text: "Impact", value: "Impact" },
                            { text: "Symbol", value: "Symbol" },
                            { text: "Tahoma", value: "Tahoma" },
                            { text: "Terminal", value: "Terminal" },
                            { text: "Times New Roman", value: "\"Times New Roman\"" },
                            { text: "Trebuchet MS", value: "\"Trebuchet MS\"" },
                            { text: "Verdana", value: "Verdana" },
                        ]
                    },
                    "fontSize",
                    "bold",
                    "italic",
                    "underline",
                    "backColor",
                    "foreColor",
                    { name: "separator2", type: "separator" },
                    "insertUnorderedList",
                    "justifyLeft",
                    "justifyCenter",
                    "justifyRight",
                    { name: "separator3", type: "separator" },
                    "formatting",
                    { name: "separator4", type: "separator" },
                    "createLink",
                    "unlink",
                    "insertImage",
                    { name: "separator5", type: "separator" },
                    "tableWizard",
                    "tableProperties",
                    "tableCellProperties",
                    "createTable",
                    "addRowAbove",
                    "addRowBelow",
                    "addColumnLeft",
                    "addColumnRight",
                    "deleteRow",
                    "deleteColumn",
                    "mergeCellsHorizontally",
                    "mergeCellsVertically",
                    "splitCellHorizontally",
                    "splitCellVertically",
                    "tableAlignLeft",
                    "tableAlignCenter",
                    "tableAlignRight"
                ]
            });
        }

        saveData() {
            let _this = this;
            let data = FormUtil.extractForm($('#myWorkReqForm'));
            data.PMType = $("#pmType").val();
            data.dept_pk = $("#executionDept").data("kendoDropDownTree").value();
            data.pmManager = $("#pmManager").val();
            data.wo_pk = $("#wo_pk").val();

            // 유효성 검사
            if (!$('#pmName').val()) {
                Alert.alert('', 'PM명을 입력해주세요.');
                return;
            }

            if (!data.wo_pk) {
                Alert.alert('', '설비를 선택해주세요.');
                return;
            }

            if (!data.PMType) {
                Alert.alert('', 'PM유형을 선택해주세요.');
                return;
            }

            if (!data.dept_pk) {
                Alert.alert('', '실행부서를 선택해주세요.');
                return;
            }

            if (!data.pmManager) {
                Alert.alert('', 'PM담당자를 선택해주세요.');
                return;
            }

            // TBM 유형 체크
            if (data.PMType === 'PM_TYPE_TBM') {
                const schedStartDt = $("#schedStartDt").val();
                const cycleType = $("#cycleType").val();
                const perNumber = $("#perNumber").val();

                if (!schedStartDt || !cycleType || !perNumber) {
                    Alert.alert('', '주기 정보를 모두 입력해주세요.');
                    return;
                }

                data.sched_start_dt = schedStartDt;
                data.cycle_type = cycleType;
                data.per_number = perNumber;
            }

            let funcSucc = function (resp) {
                if (resp.success) {
                    // 기본 정보 저장 성공 시 작업 인력 저장 진행
                    _this.savePmLalor(resp);
                } else {
                    Alert.alert('error', resp.message);
                }
            };

            AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, funcSucc);
            $("#modalMyWorkReq").fadeOut();
        }

        resetData() {
            let _this = this;
            FormUtil.resetForm($('#myWorkReqForm'));
            // 폼 리셋 후 cycleInfo 체크
            this.checkCycleInfo();
        }

        finalizeSave() {
            Notify.success('저장되었습니다.');
            this.resetData();
            page.searchMainData();
        }

        resetForm() {
            // 폼 리셋 시 cycleInfo 체크
            this.checkCycleInfo();
        }

        // 탭 전환 이벤트 핸들러
        initTabEvents() {
            let _this = this;

            $('.tab-button').on('click', function () {
                const tabId = $(this).data('tab');
                $('.tab-button').removeClass('active').removeAttr('style');
                $('.tab-pane').removeClass('active').hide();
                if (tabId) $('#' + tabId).addClass('active').show();
            });
        }
    }

    myWorkReqPage = new MyWorkReq();
    $(document).ready(function () {

        // pmType 선택 이벤트 핸들러 추가
        $('#pmType').on('change', function () {
            myWorkReqPage.checkCycleInfo();
        });

        // 모달이 표시될 때마다 cycleInfo 체크 (jQuery fadeIn 방식)
        const originalFadeIn = $.fn.fadeIn;
        $.fn.fadeIn = function () {
            if (this.attr('id') === 'modalMyWorkReq') {
                setTimeout(() => myWorkReqPage.checkCycleInfo(), 0);
            }
            return originalFadeIn.apply(this, arguments);
        };

        let rowCount = 0;

    });

</script>