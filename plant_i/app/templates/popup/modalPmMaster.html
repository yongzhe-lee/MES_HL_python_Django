<div id="modalPmMaster" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4 id="modalTitle">PM ë§ˆìŠ¤í„° ë“±ë¡</h4>
		</div>
		<div class="modal-body">
			<!-- ëŒ€ìƒì„¤ë¹„ ì„¹ì…˜ -->
			<div class="top-section">
				<div class="section-header">
					<h5>
						ëŒ€ìƒì„¤ë¹„
						<i class="fas fa-info-circle tooltip-icon"
						   data-tooltip="PMëŒ€ìƒì´ ë˜ëŠ” ì„¤ë¹„ ë“±ë¡(í•˜ë‚˜ì˜ PMë‹¹ 1ê°œì˜ ì„¤ë¹„ë§Œ ë“±ë¡ ê°€ëŠ¥)"></i>
					</h5>
					<div class="button-group" style="display: none;">
						<button type="button" class="btn-equipment" id="pmSelectEquipment" name="pmSelectEquipment">
							ì„¤ë¹„ì„ íƒ
						</button>
						<button type="button" class="btn-copy" id="copyPM" name="copyPM">
							PMë³µì‚¬
						</button>
					</div>
				</div>
				<form id="pmEquipForm">
					<div class="form-row">
						<div class="form-group col-md-6">
							<label for="equip_cd">ì„¤ë¹„ì½”ë“œ</label>
							<input type="hidden" id="equip_pk" name="equip_pk" />
							<input type="text" class="form-control" id="equip_cd" name="equip_cd" readonly>
						</div>
						<div class="form-group col-md-6">
							<label for="equip_nm">ì„¤ë¹„ëª…</label>
							<input type="text" class="form-control" id="equip_nm" name="equip_nm" readonly>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-md-3">
							<label for="loc_nm">ì„¤ë¹„ìœ„ì¹˜</label>							
							<input type="text" class="form-control" id="loc_nm" name="loc_nm" readonly>
						</div>
						<div class="form-group col-md-3">
							<label for="import_rank_nm">ì¤‘ìš”ë„</label>
							<input type="text" class="form-control" id="import_rank_nm" name="import_rank_nm" readonly>
						</div>
						<div class="form-group col-md-3">
							<label for="equip_status_nm">ì„¤ë¹„ìƒíƒœ</label>
							<input type="text" class="form-control" id="equip_status_nm" name="equip_status_nm" readonly>
						</div>
						<div class="form-group col-md-3">
							<label for="environ_equip_yn">ë²•ì •ê´€ë¦¬ì„¤ë¹„</label>
							<input type="text" class="form-control" id="pm_environ_equip_yn" name="environ_equip_yn" readonly>
						</div>
					</div>
				</form>
			</div>

			<!-- ê³„íš ì„¹ì…˜ -->
			<div class="section">
				<div class="tab-group" id="pmMasterTabGroup">
					<button class="tab-button active" data-tab="pmMasterForm">ê³„íš</button>
					<button class="tab-button" data-tab="pmWorkerMaterialContent">ì‘ì—… ì¸ë ¥/ìì¬</button>
					<button class="tab-button" data-tab="pmWorkOrderContent">PM WO ëª©ë¡</button>
				</div>
				<div class="tab-content">
					<!-- ê³„íš íƒ­ ì»¨í…ì¸  -->
					<form id="pmMasterForm" class="tab-pane active">
						<input type="hidden" id="pm_pk" name="pm_pk">
						<div class="plan-content">
							<div class="form-row">
								<div class="form-group col-md-6">
									<label for="pm_no">PMë²ˆí˜¸</label>
									<input type="text" class="form-control" id="pm_no" name="pm_no" placeholder="PMë²ˆí˜¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤" readonly>
								</div>
								<div class="form-group col-md-6">
									<label for="pm_nm" class="required">PMëª…</label>
									<input type="text" class="form-control" id="pm_nm" name="pm_nm" placeholder="100ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”">
								</div>
							</div>
							<div class="form-row" style="display: flex; width: 100%;">
								<!-- ì™¼ìª½ ê³ ì • ì˜ì—­ -->
								<div style="display: flex; gap: 20px; width: 350px; min-width: 350px;">
									<div class="form-group col-md-3" style="width: 200px; min-width: 200px;">
										<label for="pm_type_cd" class="required">PMìœ í˜•</label>
										<select id="pm_type_cd" name="pm_type_cd">
										</select>
									</div>
									<div class="form-group col-md-3" style="width: 120px; min-width: 120px;">
										<label for="work_expect_hr" style="white-space: nowrap;">ì •ë¹„ì†Œìš”ì‹œê°„(ì‹œ)</label>
										<input type="number" class="form-control" id="work_expect_hr" name="work_expect_hr" min="0" style="text-align: right; padding-right: 20px;" />
									</div>
								</div>

								<!-- ì˜¤ë¥¸ìª½ cycleInfo ì˜ì—­ -->
								<div id="cycleInfo" style="display: none; flex: 1; margin-left: 20px;">
									<div style="display: flex; gap: 20px;">
										<!-- ì£¼ê¸°ì‹œì‘ì¼ -->
										<div class="form-group col-md-4" style="display: flex; flex-direction: column;">
											<label for="sched_start_dt" class="required">ì£¼ê¸°ì‹œì‘ì¼</label>
											<div class="field-wrapper">
												<input type="date" id="sched_start_dt" name="sched_start_dt" />
											</div>
										</div>
										<!-- ì£¼ê¸°ë‹¨ìœ„ -->
										<div class="form-group col-md-4" style="display: flex; flex-direction: column;">
											<label for="cycle_type_cd" class="required">ì£¼ê¸°ë‹¨ìœ„</label>
											<select id="cycle_type_cd" name="cycle_type_cd" style="width: 100px;">
											</select>
										</div>
										<div class="form-group col-md-4" style="width: 120px;">
											<label for="per_number" class="required">ë°˜ë³µ</label>
											<div style="display: flex; align-items: center;">
												<span style="margin-left: 5px;">ë§¤</span>
												<input id="per_number" name="per_number" type="number" class="form-control" style="width: 80px;" />
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="form-row">
								<div class="form-group col-md-6">
									<label for="pm_dept_pk" class="required">ì‹¤í–‰ë¶€ì„œ</label>
									<select id="pm_dept_pk" name="dept_pk">
									</select>
								</div>
								<div class="form-group col-md-6">
									<label for="pm_user_pk" class="required">PMë‹´ë‹¹ì</label>
									<select id="pm_user_pk" name="pm_user_pk">
										<option value="">PMë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
									</select>
								</div>
							</div>
							<div class="form-group col-md-12">
								<label>ì‘ì—…ì§€ì¹¨</label>
								<textarea class="form-control" id="work_text" name="work_text" placeholder="2000ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”" maxlength="2000"></textarea>
								<div class="char-count">0 / 2000 bytes</div>
							</div>
						</div>
					</form>
					<!-- ì‘ì—… ì¸ë ¥/ìì¬ íƒ­ ì»¨í…ì¸  -->
					<div id="pmWorkerMaterialContent" class="tab-pane work-content" style="display: none; overflow-y: auto; max-height: 350px;">
						<div class="work-section">
							<div class="section-header">
								<div style="display: flex; align-items: center;">
									<h5 style="width: 170px;">ì‘ì—…ë‹´ë‹¹ì§ì¢…</h5>
									<div class="form-item align-h">
										<div class="field-wrapper">
											<select id="selJobClass" name="selJobClass">
												<option value="">ì§ì¢…ì„ ì„ íƒí•˜ì„¸ìš”</option>
											</select>
										</div>
									</div>
								</div>
								<button class="btn-save" id="addOccupations" name="addOccupations">ì§ì¢… ë“±ë¡</button>
							</div>
							<div class="grid">
								<div id="jobClassGrid"></div>
							</div>
						</div>

						<div class="material-section">
							<div class="section-header">
								<h5>í•„ìš”ìì¬</h5>
								<button class="btn-save" id="selectMaterial" name="selectMaterial">ìì¬ì„ íƒ</button>
							</div>
							<div class="grid">
								<div id="materialGrid"></div>
							</div>
						</div>
					</div>
					<!-- PM WO ëª©ë¡ íƒ­ ì»¨í…ì¸  -->
					<div id="pmWorkOrderContent" class="tab-pane" style="display: none;">
						<div id="pmWorkOrderGrid"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- ë²„íŠ¼ ì˜ì—­ -->
		<!--
		  [ë²„íŠ¼ í™œì„±í™” ì¡°ê±´] 1) ì‚­ì œ ê°€ëŠ¥í•˜ë©´ [ì‚­ì œ] ë²„íŠ¼ ìš°ì„ , ì‚­ì œ ë¶ˆê°€ì‹œ [ì‚¬ìš©ì•ˆí•¨] ë²„íŠ¼ í™œì„±í™”
		                    2) ì‚¬ìš©ì—¬ë¶€ê°€ "ì‚¬ìš©ì•ˆí•¨" ìƒíƒœì¸ ê²½ìš° [ì‚¬ìš©][ì €ì¥][ë‹«ê¸°] ë²„íŠ¼ í™œì„±í™”
		  case 1) [ì‚­ì œ][ì €ì¥][ë‹«ê¸°]     : í˜„ì¬ "ì‚¬ìš©ì¤‘" ìƒíƒœ & ì°¸ì¡°ë˜ëŠ” WO ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•Šì€ ê²½ìš°
		  case 2) [ì‚¬ìš©ì•ˆí•¨][ì €ì¥][ë‹«ê¸°] : í˜„ì¬ "ì‚¬ìš©ì¤‘" ìƒíƒœ & ì°¸ì¡°ë˜ëŠ” WO ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°
		  case 3) [ì‚¬ìš©][ì €ì¥][ë‹«ê¸°]     : í˜„ì¬ "ì‚¬ìš©ì•ˆí•¨" ìƒíƒœ
		-->
		<div class="modal-footer">
			<!-- Case 1: ì‚­ì œ ê°€ëŠ¥í•œ ê²½ìš° -->
			<button type="button" class="btn-delete" id="delPmBtn" style="display: none;">
				<i class="material-symbols-outlined">delete</i>ì‚­ì œ
			</button>
			
			<!-- Case 2: ì‚­ì œ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° (ë¯¸ì ìš© ë²„íŠ¼) -->
			<button type="button" class="btn-delete" id="unusePmBtn" style="display: none;">ë¯¸ì ìš©</button>
			
			<!-- Case 3: ì‚¬ìš©ì•ˆí•¨ ìƒíƒœì¸ ê²½ìš° (ì ìš© ë²„íŠ¼) -->
			<button type="button" class="btn-save" id="usePmBtn" style="display: none;">ì ìš©</button>
			
			<!-- ì €ì¥ ë²„íŠ¼ -->
			<button type="button" class="btn-save" id="savePmBtn" style="display: none;">ì €ì¥</button>
			
			<!-- ë‹«ê¸° ë²„íŠ¼ -->
			<button type="button" class="btn-close" id="closePmModal">ë‹«ê¸°</button>
		</div>
	</div>
</div>

<style>

	#modalPmMaster {
		z-index: 1000 !important;
	}

	/* ì½ê¸°ëª¨ë“œì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” í…Œì´ë¸” ìš”ì†Œë“¤ ì œì–´ */
	#modalPmMaster.read-mode #materialTable input[type="number"] {
		readonly: true !important;
		pointer-events: none !important;
		background-color: #f8f9fa !important;
	}

	#modalPmMaster.read-mode #materialTable .btn-delete {
		display: none !important;
	}

	.form-group {
		flex: 1;
		min-width: 0;
		margin-bottom: 10px;
	}

		.form-group:first-child {
			flex: 0.8;
		}

		.form-group:last-child {
			flex: 1.2;
		}

		.form-group label {
			font-size: 13px;
			font-weight: 600;
			color: #2c3e50;
			margin-bottom: 5px;
		}

	.char-count {
		text-align: right;
		color: #666;
		font-size: 12px;
		margin-top: 3px;
		padding-right: 5px;
	}

	.table {
		width: 100%;
		min-width: 800px;
		border-collapse: collapse;
	}

		.table th, .table td {
			border: 1px solid #ddd;
			text-align: center;
		}

		.table th {
			font-size: 13px;
			font-weight: 600;
			color: #2c3e50;
		}

		.table td {
			font-size: 13px;
			color: #34495e;
		}

	.no-data td {
		text-align: center;
		padding: 20px;
		color: #666;
	}

	.total-count {
		margin-left: 10px;
		color: #666;
	}

	/* í…ìŠ¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
	textarea.form-control {
		min-height: 80px;
		resize: none;
		line-height: 1.4;
	}

	/* ìì¬ í…Œì´ë¸” ê´€ë ¨ ìŠ¤íƒ€ì¼ */
	#materialTable .btn-delete {
		background: none;
		border: none;
		color: #dc3545;
		font-size: 18px;
		cursor: pointer;
		padding: 0 5px;
	}

	#materialTable .btn-delete:hover {
		color: #c82333;
	}

	.section {
		background: #fff;
		margin-bottom: 20px;
		height: auto;
	}

	/* Kendo Grid ìŠ¤íƒ€ì¼ ê°œì„  */
	#jobClassGrid .k-grid-header th {
		text-align: center;
	}

	#jobClassGrid .k-grid-tbody td:nth-child(1) {
		text-align: center;
	}

	#jobClassGrid .k-grid-tbody td:nth-child(3) {
		text-align: left;
	}

	#jobClassGrid .k-grid-tbody td:nth-child(4) {
		text-align: right;
	}

	/* PM ë§ˆìŠ¤í„° ëª¨ë‹¬ ì „ìš© íƒ­ ì˜ì—­ */
	#pmMasterTabGroup {
		display: flex;
		margin-bottom: 10px;
		border-bottom: 1px solid #1e4f88;
	}

	#pmMasterTabGroup .tab-button {
		padding: 6px 20px;
		border: 1px solid #ccc;
		background: #f5f5f5;
		cursor: pointer;
		font-size: 12px;
	}
</style>

<script type="text/javascript">
	let pmMasterPage = null;
	class PmMaster {
		constructor() {
			this.grid = null;
			this.baseUrl = '/api/kmms/pm_master';
			this.pmUypeCd = null;
			this.deptPk = null;
			this.cycleTypeCd = null;		
			this.schedStartDt = null;
			
			// ë²„íŠ¼ í™œì„±í™” ì¡°ê±´ ê´€ë ¨ ë³€ìˆ˜ë“¤
			this.isWriteYn = true;        // ì“°ê¸° ê¶Œí•œ ì—¬ë¶€
			this.isUseYn = true;          // ì‚¬ìš©ì—¬ë¶€ ìƒíƒœ
			this.isDeletable = true;      // ì‚­ì œ ê°€ëŠ¥ ì—¬ë¶€
			this.workOrderCount = 0;      // WO ë°ì´í„° ê°œìˆ˜
			
			$('.button-group').show(); // button-groupì„ ê¸°ë³¸ìœ¼ë¡œ ë³´ì´ë„ë¡ ì´ˆê¸°í™”
			this.init();
		}

		init() {
			let _this = this;
			const modal = $("#modalPmMaster");
			// cycleInfo í‘œì‹œ ì—¬ë¶€ ì²´í¬ í•¨ìˆ˜
			this.checkCycleInfo = function () {
				const pmTypeValue = $('#pm_type_cd').val();
				if (pmTypeValue === 'PM_TYPE_TBM') {
					$('#cycleInfo').show();
				} else {
					$('#cycleInfo').hide();
				}
			};

			// ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
			this.loadPmData = function (pmPk) {
				let param = {
					action: 'read',
					pm_pk: pmPk
				};

				let result = AjaxUtil.getSyncData(this.baseUrl, param);
				if (result) {
					// ë°ì´í„° ë¡œë“œ ì§í›„ cycleInfo ì²´í¬
					setTimeout(() => this.checkCycleInfo(), 0);
				}
			};

			// ëª¨ë‹¬ì´ í‘œì‹œë  ë•Œë§ˆë‹¤ cycleInfo ì²´í¬
			modal.on('show', function () {
				_this.checkCycleInfo();
			});

			this.deptPk = AjaxUtil.fillDropDownTreeOptions($("#pm_dept_pk"), "depart", "select");
			this.pmUypeCd = AjaxUtil.fillDropDownOptions($('#pm_type_cd'), 'cm_code', 'choose', null, 'PM_TYPE');
			this.cycleTypeCd = AjaxUtil.fillDropDownOptions($('#cycle_type_cd'), 'cm_code', 'choose', null, 'CYCLE_TYPE');
			AjaxUtil.fillDropDownOptions($('#pm_user_pk'), 'cm_user_info', 'choose');

			let today = CommonUtil.getYYYYMMDD();
			this.schedStartDt = $("#sched_start_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd",
			});

			$('#pmSelectEquipment').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // ê¸°ì–´ ì•„ì´ì½˜ (ì„¤ë¹„ ê´€ë ¨)
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEqu');
					equipSelectPage.show(function (res) {
						console.log('data:', res);

						// ì„ íƒëœ ì„¤ë¹„ ë°ì´í„°
						FormUtil.BindDataForm(res, $('#pmEquipForm'));
				
					});
				}
			});

			$("#copyPM").kendoButton({
				icon: "k-i-copy",// ë³µì‚¬ ì•„ì´ì½˜
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalPmCopy', { width: '70%', height: '70%' });
					pmCopyPage.show(function (selectedPm) {
						console.log('selectedPm:', selectedPm);

						FormUtil.BindDataForm(selectedPm, $('#pmMasterForm'));

						$("#equip_cd").val(selectedPm.equip_cd);
						$("#equip_nm").val(selectedPm.equip_nm);

					});
				}
			});

			$('#addOccupations').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // ê¸°ì–´ ì•„ì´ì½˜ (ì„¤ë¹„ ê´€ë ¨)
				click: function (e) {
					e.preventDefault();
					$("#modalOccupations").fadeIn();
				}
			});

			$('#selectMaterial').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // ê¸°ì–´ ì•„ì´ì½˜ (ì„¤ë¹„ ê´€ë ¨)
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalMatMultiSel');
					matMultiSelectPage.show(function (data) {
						console.log('mat_data:', data);
						
						// Kendo Gridì— ìì¬ ì¶”ê°€
						if (data && Array.isArray(data) && data.length > 0) {
							data.forEach((material) => {
								_this.addMaterialToGrid(material);
							});
						} else if (data && !Array.isArray(data)) {
							_this.addMaterialToGrid(data);
						}
					});
				}
			});

			// ESC í‚¤ ëˆ„ë¥¼ ë•Œ ëª¨ë‹¬ ë‹«ê¸°
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) { // ESC key
					modal.fadeOut();
				}
			});

			// ì‚­ì œ ë²„íŠ¼
			$("#delPmBtn").kendoButton({
				themeColor: "error",
				click: function (e) {
					e.preventDefault();
					
					Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
						_this.deleteData();
					});
				}
			});

			// ë¯¸ì ìš© ë²„íŠ¼
			$("#unusePmBtn").kendoButton({
				themeColor: "error",
				click: function (e) {
					e.preventDefault();
					
					Alert.confirm('', 'ë¯¸ì ìš© ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
						_this.unUseCallback();
					});
				}
			});

			// ì ìš© ë²„íŠ¼
			$("#usePmBtn").kendoButton({
				themeColor: "base",
				click: function (e) {
					e.preventDefault();
					
					Alert.confirm('', 'ì ìš© ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
						_this.useCallback();
					});
				}
			});

			// ì €ì¥ ë²„íŠ¼
			$("#savePmBtn").kendoButton({
				themeColor: "base",
				icon: "k-i-save",
				click: function (e) {
					e.preventDefault();
					_this.saveData();
				}
			});

			// ëª¨ë‹¬ ë‹«ê¸° - ë‹«ê¸° ë²„íŠ¼ í´ë¦­
			$('#closePmModal').kendoButton({
				click: function (e) {
					e.preventDefault();
					modal.fadeOut();
					_this.reset();
				}
			});

			AjaxUtil.fillDropDownOptions($('#selJobClass'), 'cm_job_class', 'choose', null);

			// jobClassGrid Kendo Grid ì´ˆê¸°í™”
			$("#jobClassGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					data: [],
					// schema: {
					// 	model: {
					// 		fields: {
					// 			rowIndex: { type: "number" },
					// 			job_class_pk: { type: "string" },
					// 			job_class_nm: { type: "string" },
					// 			work_hr: { type: "number" }
					// 		}
					// 	}
					// }
				}),
				sortable: false,
				autoBind: false,
				editable: {
					mode: "incell",
					confirmation: false
				},
				columns: [
					{ field: 'rowIndex', title: 'ìˆœë²ˆ', width: '10%' },
					{ field: 'job_class_pk', title: 'ì§ì¢…ì½”ë“œ', hidden: true },
					{ field: 'job_class_nm', title: 'ì§ì¢…', width: '40%' },
					{ 
						field: 'work_hr', 
						title: 'ì˜ˆìƒì‘ì—…ì‹œê°„', 
						width: '40%',
						editor: function(container, options) {
							$('<input name="' + options.field + '" type="number" class="k-input k-textbox" min="0" style="text-align:right; width:100%;" />')
								.appendTo(container)
								.on('input', function () {
									this.value = this.value.replace(/[^0-9.]/g, '');
								});
						}
					},
					{
						command: {
							text: "ì‚­ì œ",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#jobClassGrid").data("kendoGrid");
								grid.removeRow(tr);
								// ìˆœë²ˆ ì¬ì •ë ¬ (ë¬´í•œ ì¬ê·€ ë°©ì§€)
								setTimeout(() => {
									_this.reorderJobClassGridWithoutRefresh();
								}, 0);
							}
						},
						title: "ì‚­ì œ",
						width: "10%",
					}
				],
				dataBound: function (e) {
					// ë°ì´í„° ë°”ì¸ë”© í›„ ìˆœë²ˆ ì¬ì •ë ¬ (ë¬´í•œ ì¬ê·€ ë°©ì§€)
					setTimeout(() => {
						_this.reorderJobClassGridWithoutRefresh();
					}, 0);
				}
			});

			// materialGrid Kendo Grid ì´ˆê¸°í™”
			$("#materialGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					data: [],
				}),
				sortable: false,
				autoBind: false,
				editable: {
					mode: "incell",
					confirmation: false
				},
				columns: [
					{ field: 'mat_cd', title: 'ìì¬ì½”ë“œ', width: '20%' },
					{ field: 'mat_nm', title: 'ìì¬ëª…', width: '30%' },
					{ 
						field: 'amt', 
						title: 'ì˜ˆìƒì†Œìš”ëŸ‰', 
						width: '25%',
						editor: function(container, options) {
							$('<input name="' + options.field + '" type="number" class="k-input k-textbox" min="0" step="1" style="text-align:right; width:100%;" />')
								.appendTo(container)
								.on('input', function () {
									this.value = this.value.replace(/[^0-9]/g, '');
								});
						}
					},
					{ field: 'unit', title: 'ìˆ˜ëŸ‰ë‹¨ìœ„', width: '15%' },
					{
						command: {
							text: "ì‚­ì œ",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#materialGrid").data("kendoGrid");
								grid.removeRow(tr);
							}
						},
						title: "ì‚­ì œ",
						width: "10%"
					}
				],
				dataBound: function (e) {
					// ë°ì´í„° ë°”ì¸ë”© í›„ ì²˜ë¦¬
				}
			});

			// íƒ­ ì´ë²¤íŠ¸ ì´ˆê¸°í™” ì¶”ê°€
			_this.initPmTabEvents();
		}

		// ë²„íŠ¼ í™œì„±í™” ì¡°ê±´ ì„¤ì • ë©”ì„œë“œ
		setButtonVisibility() {
			const pmPk = $("#pm_pk").val();
			const isNewRecord = !pmPk || pmPk <= 0;
			
			// ëª¨ë“  ë²„íŠ¼ ìˆ¨ê¸°ê¸°
			$("#delPmBtn, #unusePmBtn, #usePmBtn, #savePmBtn").hide();
			
			if (!this.isWriteYn) {
				// ì“°ê¸° ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° ë‹«ê¸° ë²„íŠ¼ë§Œ í‘œì‹œ
				return;
			}
			
			if (isNewRecord) {
				// ìƒˆ ë“±ë¡ì¸ ê²½ìš° ì €ì¥ ë²„íŠ¼ë§Œ í‘œì‹œ
				$("#savePmBtn").show();
			} else {
				// ê¸°ì¡´ PM ìˆ˜ì •ì¸ ê²½ìš°
				if (this.isUseYn) {
					// ì‚¬ìš©ì¤‘ì¸ ìƒíƒœ
					if (this.isDeletable) {
						// Case 1: ì‚­ì œ ê°€ëŠ¥í•œ ê²½ìš°
						$("#delPmBtn, #savePmBtn").show();
					} else {
						// Case 2: ì‚­ì œ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° (WO ë°ì´í„°ê°€ ìˆìŒ)
						$("#unusePmBtn, #savePmBtn").show();
					}
				} else {
					// Case 3: ì‚¬ìš©ì•ˆí•¨ ìƒíƒœì¸ ê²½ìš°
					$("#usePmBtn, #savePmBtn").show();
				}
			}
		}

		deleteData() {
			let _this = this;

			let pm_pk = $("#pm_pk").val();
			if (pm_pk) {
				let fnSuccess = function (res) {					
					if (res.success) {
						Alert.alert('', res.message || 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
						page.searchMainData();
						_this.reset();
						$("#modalPmMaster").fadeOut();
					} else {
						let errorMessage = res.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
						Alert.alert('', errorMessage);
					}
				};
				AjaxUtil.postAsyncData(_this.baseUrl + '?action=delete', { pm_pk: pm_pk }, fnSuccess);
			} else {
				Alert.alert('', 'ë°ì´í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
			}
		}

		unUseCallback() {
			let _this = this;
			let pm_pk = $("#pm_pk").val();
			
			if (!pm_pk) {
				Alert.alert('', 'PM ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
				return;
			}

			let fnSuccess = function (res) {
				if (res.success) {
					_this.isUseYn = false;
					_this.setButtonVisibility();
					
					Alert.alert('', 'PMë§ˆìŠ¤í„°ê°€ ì‚¬ìš©ì•ˆí•¨ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
					if (typeof page !== 'undefined' && page.searchMainData) {
						page.searchMainData();
					}
					_this.reset();
					$("#modalPmMaster").fadeOut();
				} else {
					Alert.alert('', res.message || 'ë¯¸ì ìš© ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=disable', { pm_pk: pm_pk }, fnSuccess);
		}

		useCallback() {
			let _this = this;
			let pm_pk = $("#pm_pk").val();
			
			if (!pm_pk) {
				Alert.alert('', 'PM ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
				return;
			}

			let fnSuccess = function (res) {
				if (res.success) {
					_this.isUseYn = true;
					_this.setButtonVisibility();
					
					Alert.alert('', 'PMë§ˆìŠ¤í„°ê°€ ì‚¬ìš©í•¨ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
					if (typeof page !== 'undefined' && page.searchMainData) {
						page.searchMainData();
					}
					_this.reset();
					$("#modalPmMaster").fadeOut();
				} else {
					Alert.alert('', res.message || 'ì ìš© ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=enable', { pm_pk: pm_pk }, fnSuccess);
		}

		saveData() {
			let _this = this;
			let data = FormUtil.extractForm($('#pmMasterForm'));			
			data.equip_pk = $("#equip_pk").val();		

			if (!data.equip_pk) {
				Alert.alert('', 'ì„¤ë¹„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}

			// ìœ íš¨ì„± ê²€ì‚¬
			if (!$('#pm_nm').val()) {
				Alert.alert('', 'PMëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
				return;
			}

			if (!data.pm_type_cd) {
				Alert.alert('', 'PMìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}

			// TBM ìœ í˜• ì²´í¬
			if (data.pm_type_cd === 'PM_TYPE_TBM') {
				if (!$("#sched_start_dt").val() || !$("#cycle_type_cd").val() || !$("#per_number").val()) {
					Alert.alert('', 'ì£¼ê¸° ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
					return;
				}
			}

			if (!data.dept_pk) {
				Alert.alert('', 'ì‹¤í–‰ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}

			if (!$("#pm_user_pk").val()) {
				Alert.alert('', 'PMë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}

			let funcSucc = function (resp) {
				if (resp.success) {
					// ê¸°ë³¸ ì •ë³´ ì €ì¥ ì„±ê³µ ì‹œ ì‘ì—… ì¸ë ¥ ì €ì¥ ì§„í–‰		
					_this.savePmLalor(resp);
				} else {
					Alert.alert('error', resp.message);
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, funcSucc);
			$("#modalPmMaster").fadeOut();
		}

		reset() {
			$('.button-group').show();
			FormUtil.resetForm($('#pmEquipForm'));			
			
			// ì§ì¢… ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
			const jobClassGrid = $("#jobClassGrid").data("kendoGrid");
			if (jobClassGrid) {
				jobClassGrid.dataSource.data([]);
			}
			
			// ìì¬ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
			const materialGrid = $("#materialGrid").data("kendoGrid");
			if (materialGrid) {
				materialGrid.dataSource.data([]);
			}
			
			// ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
			this.isUseYn = true;
			this.isDeletable = true;
			this.workOrderCount = 0;
			this.setButtonVisibility();
			
			this.checkCycleInfo();
		}

		savePmLalor(resp) {
			let _this = this;
			let jobClassData = [];
			
			// Kendo Gridì—ì„œ ë°ì´í„° ì¶”ì¶œ
			const grid = $("#jobClassGrid").data("kendoGrid");
			if (grid) {
				const gridData = grid.dataSource.data();
				gridData.forEach(function(item) {
					jobClassData.push({
						job_class_pk: item.job_class_pk,
						work_hr: item.work_hr || 0
					});
				});
			}

			let data = {
				job_classes: JSON.stringify(jobClassData),
				pm_pk: resp.id
			};

			let funcSucc2 = function (resp2) {
				if (resp2.success) {
					_this.savePmMtrl(resp);
				} else {
					Alert.alert('error', resp2.message);
				}
			}

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_job_classes', data, funcSucc2);
		}

		// ì§ì¢… ê·¸ë¦¬ë“œ ìˆœë²ˆ ì¬ì •ë ¬ ë©”ì„œë“œ (refresh ì—†ì´)
		reorderJobClassGridWithoutRefresh() {
			const grid = $("#jobClassGrid").data("kendoGrid");
			if (grid) {
				const data = grid.dataSource.data();
				data.forEach((item, index) => {
					item.rowIndex = index + 1;
				});
			}
		}

		// ì§ì¢… ê·¸ë¦¬ë“œ ìˆœë²ˆ ì¬ì •ë ¬ ë©”ì„œë“œ (refresh í¬í•¨)
		reorderJobClassGrid() {
			const grid = $("#jobClassGrid").data("kendoGrid");
			if (grid) {
				const data = grid.dataSource.data();
				data.forEach((item, index) => {
					item.rowIndex = index + 1;
				});
				grid.refresh();
			}
		}

		// ì§ì¢… ê·¸ë¦¬ë“œì— ë°ì´í„° ì¶”ê°€ ë©”ì„œë“œ
		addJobClassToGrid(jobClassPk, jobClassName) {
			const grid = $("#jobClassGrid").data("kendoGrid");
			if (grid) {
				// ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì§ì¢…ì¸ì§€ í™•ì¸
				const existingData = grid.dataSource.data();
				const exists = existingData.some(item => item.job_class_pk === jobClassPk);
				
				if (exists) {
					Alert.alert('', 'ì´ë¯¸ ì¶”ê°€ëœ ì§ì¢…ì…ë‹ˆë‹¤.');
					return;
				}

				// ìƒˆ ë°ì´í„° ì¶”ê°€
				const newData = {
					rowIndex: existingData.length + 1,
					job_class_pk: jobClassPk,
					job_class_nm: jobClassName,
					work_hr: 0
				};
				
				grid.dataSource.add(newData);
				
				// ìˆœë²ˆ ì¬ì •ë ¬ (ë¬´í•œ ì¬ê·€ ë°©ì§€)
				setTimeout(() => {
					this.reorderJobClassGridWithoutRefresh();
				}, 0);
			}
		}

		// ìì¬ ê·¸ë¦¬ë“œì— ë°ì´í„° ì¶”ê°€ ë©”ì„œë“œ
		addMaterialToGrid(material) {
			const grid = $("#materialGrid").data("kendoGrid");
			if (grid) {
				// ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìì¬ì¸ì§€ í™•ì¸
				const existingData = grid.dataSource.data();
				const exists = existingData.some(item => item.mat_pk === material._mtrl_pk);
				
				if (exists) {
					const materialName = material._mtrl_nm || material._mtrl_cd || 'ì•Œ ìˆ˜ ì—†ëŠ” ìì¬';
					Alert.alert('', `ì´ë¯¸ ì¶”ê°€ëœ ìì¬ì…ë‹ˆë‹¤: ${materialName}`);
					return;
				}

				// ìƒˆ ë°ì´í„° ì¶”ê°€
				const newData = {
					mat_pk: material._mtrl_pk,
					mat_cd: material._mtrl_cd || '',
					mat_nm: material._mtrl_nm || '',
					amt: 1,
					unit: material._ant_unit_cd || material._ant_unit_nm || 'EA'
				};
				
				grid.dataSource.add(newData);
			}
		}

		savePmMtrl(resp) {
			let _this = this;
			let materialData = [];
			
			// Kendo Gridì—ì„œ ë°ì´í„° ì¶”ì¶œ
			const grid = $("#materialGrid").data("kendoGrid");
			if (grid) {
				const gridData = grid.dataSource.data();
				gridData.forEach(function(item) {
					materialData.push({
						mat_pk: item.mat_pk,
						mtrl_qty: item.amt || 0
					});
				});
			}

			let data = {
				materials: JSON.stringify(materialData),
				pm_pk: resp.id
			};

			let funcSucc3 = function (resp3) {
				if (resp3.success) {
					_this.finalizeSave();
				} else {
					Alert.alert('error', resp3.message);
				}
			}
	
			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_materials', data, funcSucc3);
		}

		finalizeSave() {
			Notify.success('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
			this.reset();
			page.searchMainData();
		}

		//pm ë§ˆìŠ¤í„°
		show(pmId, mode = 'edit') {
			let _this = this;
			
			// 'ê³„íš' íƒ­ í•­ìƒ active ì²˜ë¦¬
			$('#pmMasterTabGroup .tab-button').removeClass('active').removeAttr('style');
			$('#modalPmMaster .tab-pane').removeClass('active').hide();
			$('#pmMasterTabGroup .tab-button[data-tab="pmMasterForm"]').addClass('active').css({
				'background': '#1e4f88',
				'color': 'white',
				'border-color': '#1e4f88'
			});
			$('#pmMasterForm').addClass('active').show();

			// ëª¨ë“œì— ë”°ë¥¸ UI ì„¤ì •
			if (mode === 'read') {
				// ì½ê¸°ëª¨ë“œ: ëª¨ë“  ì…ë ¥ í•„ë“œë¥¼ readonlyë¡œ ì„¤ì •í•˜ê³  ë²„íŠ¼ ìˆ¨ê¹€
				_this.isWriteYn = false; // ì½ê¸° ëª¨ë“œì—ì„œëŠ” ì“°ê¸° ê¶Œí•œ ì—†ìŒ
				$('#modalTitle').text('PM ë§ˆìŠ¤í„° ìƒì„¸ë³´ê¸°');
				$('#pmMasterForm input, #pmMasterForm textarea').prop('readonly', true);
				
				// ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” í…Œì´ë¸” input ìš”ì†Œë“¤ë„ ì œì–´í•˜ê¸° ìœ„í•´ CSS í´ë˜ìŠ¤ ì¶”ê°€
				$('#modalPmMaster').addClass('read-mode');
				
				// Kendo UI select ìš”ì†Œë“¤ ë¹„í™œì„±í™”
				if ($('#pm_type_cd').data('kendoDropDownList')) {
					$('#pm_type_cd').data('kendoDropDownList').enable(false);
				}
				if ($('#pm_dept_pk').data('kendoDropDownTree')) {
					$('#pm_dept_pk').data('kendoDropDownTree').enable(false);
				}
				if ($('#pm_user_pk').data('kendoDropDownList')) {
					$('#pm_user_pk').data('kendoDropDownList').enable(false);
				}
				if ($('#cycle_type_cd').data('kendoDropDownList')) {
					$('#cycle_type_cd').data('kendoDropDownList').enable(false);
				}
				if ($('#sched_start_dt').data('kendoDatePicker')) {
					$('#sched_start_dt').data('kendoDatePicker').enable(false);
				}
				if ($('#selJobClass').data('kendoDropDownList')) {
					$('#selJobClass').data('kendoDropDownList').enable(false);
				}
				
				// ì§ì¢… ê·¸ë¦¬ë“œ í¸ì§‘ ë¹„í™œì„±í™” ë° ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€
				const jobClassGrid = $("#jobClassGrid").data("kendoGrid");
				if (jobClassGrid) {
					jobClassGrid.setOptions({ editable: false });
					// ì‚­ì œ ì»¬ëŸ¼ ìˆ¨ê¸°ê¸°
					const columns = jobClassGrid.options.columns;
					columns.forEach((col, index) => {
						if (col.command && col.command.text === "ì‚­ì œ") {
							col.hidden = true;
						}
					});
					jobClassGrid.setOptions({ columns: columns });
				}
				
				// ìì¬ ê·¸ë¦¬ë“œ í¸ì§‘ ë¹„í™œì„±í™” ë° ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€
				const materialGrid = $("#materialGrid").data("kendoGrid");
				if (materialGrid) {
					materialGrid.setOptions({ editable: false });
					// ì‚­ì œ ì»¬ëŸ¼ ìˆ¨ê¸°ê¸°
					const columns = materialGrid.options.columns;
					columns.forEach((col, index) => {
						if (col.command && col.command.text === "ì‚­ì œ") {
							col.hidden = true;
						}
					});
					materialGrid.setOptions({ columns: columns });
				}
				
				$('.button-group').hide();
				$('#addOccupations, #selectMaterial').hide();
				// ì½ê¸° ëª¨ë“œì—ì„œëŠ” ëª¨ë“  ë²„íŠ¼ ìˆ¨ê¸°ê³  ë‹«ê¸° ë²„íŠ¼ë§Œ í‘œì‹œ
				$("#delPmBtn, #unusePmBtn, #usePmBtn, #savePmBtn").hide();
				$('#closePmModal').show();
			} else if (mode === 'reg') {
				// ë“±ë¡ëª¨ë“œ: ì…ë ¥ í•„ë“œ í™œì„±í™”
				_this.isWriteYn = true; // ë“±ë¡ ëª¨ë“œì—ì„œëŠ” ì“°ê¸° ê¶Œí•œ ìˆìŒ
				$('#modalTitle').text('PM ë§ˆìŠ¤í„° ë“±ë¡');
				$('#pmMasterForm input, #pmMasterForm textarea').prop('readonly', false);
				
				$('#pm_no').prop('readonly', true);

				// ì½ê¸°ëª¨ë“œ CSS í´ë˜ìŠ¤ ì œê±°
				$('#modalPmMaster').removeClass('read-mode');
				
				// Kendo UI select ìš”ì†Œë“¤ í™œì„±í™”
				if ($('#pm_type_cd').data('kendoDropDownList')) {
					$('#pm_type_cd').data('kendoDropDownList').enable(true);
				}
				if ($('#pm_dept_pk').data('kendoDropDownTree')) {
					$('#pm_dept_pk').data('kendoDropDownTree').enable(true);
				}
				if ($('#pm_user_pk').data('kendoDropDownList')) {
					$('#pm_user_pk').data('kendoDropDownList').enable(true);
				}
				if ($('#cycle_type_cd').data('kendoDropDownList')) {
					$('#cycle_type_cd').data('kendoDropDownList').enable(true);
				}
				if ($('#sched_start_dt').data('kendoDatePicker')) {
					$('#sched_start_dt').data('kendoDatePicker').enable(true);
				}
				if ($('#selJobClass').data('kendoDropDownList')) {
					$('#selJobClass').data('kendoDropDownList').enable(true);
				}
				
				// ì§ì¢… ê·¸ë¦¬ë“œ í¸ì§‘ í™œì„±í™” ë° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
				const jobClassGrid = $("#jobClassGrid").data("kendoGrid");
				if (jobClassGrid) {
					jobClassGrid.setOptions({ editable: { confirmation: false } });
					// ì‚­ì œ ì»¬ëŸ¼ í‘œì‹œ
					const columns = jobClassGrid.options.columns;
					columns.forEach((col, index) => {
						if (col.command && col.command.text === "ì‚­ì œ") {
							col.hidden = false;
						}
					});
					jobClassGrid.setOptions({ columns: columns });
				}
				
				// ìì¬ ê·¸ë¦¬ë“œ í¸ì§‘ í™œì„±í™” ë° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
				const materialGrid = $("#materialGrid").data("kendoGrid");
				if (materialGrid) {
					materialGrid.setOptions({ editable: { confirmation: false } });
					// ì‚­ì œ ì»¬ëŸ¼ í‘œì‹œ
					const columns = materialGrid.options.columns;
					columns.forEach((col, index) => {
						if (col.command && col.command.text === "ì‚­ì œ") {
							col.hidden = false;
						}
					});
					materialGrid.setOptions({ columns: columns });
				}
				
				$('#addOccupations, #selectMaterial').show();
				// ë²„íŠ¼ í™œì„±í™”ëŠ” setButtonVisibility()ì—ì„œ ì²˜ë¦¬
				$('#closePmModal').show();
			} else {
				// í¸ì§‘ëª¨ë“œ: ì…ë ¥ í•„ë“œ í™œì„±í™”
				_this.isWriteYn = true; // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ì“°ê¸° ê¶Œí•œ ìˆìŒ
				$('#modalTitle').text('PM ë§ˆìŠ¤í„° ìˆ˜ì •');
				$('#pmMasterForm input, #pmMasterForm textarea').prop('readonly', false);
				
				$('#pm_no').prop('readonly', true);
				
				// ì½ê¸°ëª¨ë“œ CSS í´ë˜ìŠ¤ ì œê±°
				$('#modalPmMaster').removeClass('read-mode');
				
				// Kendo UI select ìš”ì†Œë“¤ í™œì„±í™”
				if ($('#pm_type_cd').data('kendoDropDownList')) {
					$('#pm_type_cd').data('kendoDropDownList').enable(true);
				}
				if ($('#pm_dept_pk').data('kendoDropDownTree')) {
					$('#pm_dept_pk').data('kendoDropDownTree').enable(true);
				}
				if ($('#pm_user_pk').data('kendoDropDownList')) {
					$('#pm_user_pk').data('kendoDropDownList').enable(true);
				}
				if ($('#cycle_type_cd').data('kendoDropDownList')) {
					$('#cycle_type_cd').data('kendoDropDownList').enable(true);
				}
				if ($('#sched_start_dt').data('kendoDatePicker')) {
					$('#sched_start_dt').data('kendoDatePicker').enable(true);
				}
				if ($('#selJobClass').data('kendoDropDownList')) {
					$('#selJobClass').data('kendoDropDownList').enable(true);
				}
				
				// ì§ì¢… ê·¸ë¦¬ë“œ í¸ì§‘ í™œì„±í™” ë° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
				const jobClassGrid = $("#jobClassGrid").data("kendoGrid");
				if (jobClassGrid) {
					jobClassGrid.setOptions({ editable: { confirmation: false } });
					// ì‚­ì œ ì»¬ëŸ¼ í‘œì‹œ
					const columns = jobClassGrid.options.columns;
					columns.forEach((col, index) => {
						if (col.command && col.command.text === "ì‚­ì œ") {
							col.hidden = false;
						}
					});
					jobClassGrid.setOptions({ columns: columns });
				}
				
				// ìì¬ ê·¸ë¦¬ë“œ í¸ì§‘ í™œì„±í™” ë° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
				const materialGrid = $("#materialGrid").data("kendoGrid");
				if (materialGrid) {
					materialGrid.setOptions({ editable: { confirmation: false } });
					// ì‚­ì œ ì»¬ëŸ¼ í‘œì‹œ
					const columns = materialGrid.options.columns;
					columns.forEach((col, index) => {
						if (col.command && col.command.text === "ì‚­ì œ") {
							col.hidden = false;
						}
					});
					materialGrid.setOptions({ columns: columns });
				}
				
				$('#addOccupations, #selectMaterial').show();
				// ë²„íŠ¼ í™œì„±í™”ëŠ” setButtonVisibility()ì—ì„œ ì²˜ë¦¬
				$('#closePmModal').show();
			}

			if (pmId > 0) {	
				if (mode !== 'read') {
					$('.button-group').show();
				}
			} else if (mode === 'reg') {
				// ë“±ë¡ëª¨ë“œì¼ ë•Œ button-group í‘œì‹œ
				$('.button-group').show();
				// ë“±ë¡ëª¨ë“œì—ì„œëŠ” API í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
				_this.reset();
				FormUtil.resetForm($('#pmMasterForm'));
			}

			if (pmId > 0 && mode !== 'reg') {
				// 1. PM ìƒì„¸ ì •ë³´ API í˜¸ì¶œ
				let param1 = {
					action: 'findOne',
					id: pmId,
				};

				let pmData = AjaxUtil.getSyncData(_this.baseUrl, param1);
				
				// PM ë°ì´í„°ì—ì„œ ë²„íŠ¼ í™œì„±í™” ì¡°ê±´ ì„¤ì •
				if (pmData) {
					_this.isUseYn = pmData.use_yn !== 'N'; // use_ynì´ falseê°€ ì•„ë‹ˆë©´ true
					_this.workOrderCount = pmData.work_order_count || 0;
					_this.isDeletable = _this.workOrderCount === 0; // WO ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì‚­ì œ ê°€ëŠ¥
					
					console.log('PM Data:', pmData);
					console.log('Work Order Count:', _this.workOrderCount);
					console.log('Is Deletable:', _this.isDeletable);
				}
				
				// ê³„íš tab			
				FormUtil.BindDataForm(pmData, $('#pmMasterForm'));
				$("#pm_dept_pk").val(pmData.dept_pk);

				let paramEquip = {
					action: 'findOne',
					equip_pk: pmData.equip_pk,
				};
				let equipData = AjaxUtil.getSyncData('/api/kmms/equipment', paramEquip);
				//ëŒ€ìƒì„¤ë¹„
				FormUtil.BindDataForm(equipData, $('#pmEquipForm'));			

				// 2. PM ì‘ì—… ì¸ë ¥ API í˜¸ì¶œ
				let param2 = {
					action: 'detail_pm_labor',
					id: pmId,
				};
				
				let pmDataLabor = AjaxUtil.getSyncData(_this.baseUrl, param2);
				console.log('pmDataLabor:', pmDataLabor);

				// 3. PM í•„ìš”ìì¬ API í˜¸ì¶œ
				let param3 = {
					action: 'detail_pm_mtrl',
					id: pmId,
				};
				let pmDataMtrl = AjaxUtil.getSyncData(_this.baseUrl, param3);
				console.log('pmDataMtrl:', pmDataMtrl);

				// 2.1. ì‘ì—…ì¸ë ¥ ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ë° ë°ì´í„° ë°”ì¸ë”©
				const jobClassGrid = $("#jobClassGrid").data("kendoGrid");
				if (jobClassGrid) {
					jobClassGrid.dataSource.data([]); // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
					
					if (Array.isArray(pmDataLabor) && pmDataLabor.length > 0) {
						const gridData = pmDataLabor.map((labor, index) => {
							return {
								rowIndex: index + 1,
								job_class_pk: labor?.job_class_pk || '',
								job_class_nm: labor?.job_class_nm || '',
								work_hr: labor?.work_hr || 0
							};
						});
						jobClassGrid.dataSource.data(gridData);
					} else {
						console.log("ğŸ“Œ [ERROR] ì‘ì—…ì¸ë ¥ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ:", pmDataLabor);
					}
				}

				// 3.1. í•„ìš”ìì¬ ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ë° ë°ì´í„° ë°”ì¸ë”©
				const materialGrid = $("#materialGrid").data("kendoGrid");
				if (materialGrid) {
					materialGrid.dataSource.data([]); // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
					
					if (Array.isArray(pmDataMtrl) && pmDataMtrl.length > 0) {
						const gridData = pmDataMtrl.map((mtrl) => {
							return {
								mat_pk: mtrl?.mat_pk || '',
								mat_cd: mtrl?.mat_cd || '',
								mat_nm: mtrl?.mat_nm || '',
								amt: mtrl?.amt || 0,
								unit: mtrl?.BasicUnit || 'EA'
							};
						});
						materialGrid.dataSource.data(gridData);
					} else {
						console.log("ğŸ“Œ [ERROR] í•„ìš”ìì¬ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ:", pmDataMtrl);
					}
				}
				
			} else if (pmId <= 0 && mode !== 'reg') {
				// pmIdê°€ ì—†ê³  ë“±ë¡ëª¨ë“œê°€ ì•„ë‹Œ ê²½ìš° í¼ ì´ˆê¸°í™”
				_this.reset();
				FormUtil.resetForm($('#pmMasterForm'));
			}
			// ë²„íŠ¼ í™œì„±í™” ì¡°ê±´ ì„¤ì •
			_this.setButtonVisibility();
			
			$("#modalPmMaster").fadeIn();
			
			// ëª¨ë‹¬ í‘œì‹œ í›„ ê¸€ììˆ˜ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
			setTimeout(() => {
				if (typeof initCharCount === 'function') {
					initCharCount();
				}
			}, 200);
		}

		// íƒ­ ì „í™˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
		initPmTabEvents() {
			let _this = this;

			$('#pmMasterTabGroup .tab-button').on('click', function () {
				const tabId = $(this).data('tab');
				$('#pmMasterTabGroup .tab-button').removeClass('active').removeAttr('style');
				$('#modalPmMaster .tab-pane').removeClass('active').hide();
				$(this).addClass('active').css({
					'background': '#1e4f88',
					'color': 'white',
					'border-color': '#1e4f88'
				});

				if (tabId) {
					$('#' + tabId).addClass('active').show(); // í•´ë‹¹ íƒ­ ì½˜í…ì¸ ë¥¼ í™œì„±í™”í•˜ê³  ë³´ì—¬ì¤Œ
					switch (tabId) {
						case 'pmMasterForm':
							if (_this.currentPmData) {
							
							}
							break;
						case 'pmWorkerMaterialContent':
							break;
						case 'pmWorkOrderContent':
							var grid = $("#pmWorkOrderGrid").data("kendoGrid");
							var pmPk = $('#pm_pk').val();
							if (grid && pmPk) {
								grid.dataSource.read(); // ê·¸ë¦¬ë“œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
							}
							break;
					}
				}
			});
		}
	}

	function deleteRow(btn) {
		const tr = $(btn).closest('tr');
		tr.remove();

		// ëª¨ë“  í–‰ì´ ì‚­ì œë˜ì—ˆì„ ë•Œ no-data í–‰ ì¶”ê°€
		if ($('tbody tr').length === 0) {
			$('tbody').append(`
			<tr class="no-data">
				<td colspan="4">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
			</tr>
		`);
		}

		// ìˆœë²ˆ ì¬ì •ë ¬
		$('tbody tr:not(.no-data)').each((index, tr) => {
			$(tr).find('td:first').text(index + 1);
		});
	}

	pmMasterPage = new PmMaster();
	$(document).ready(function () {

		$('#pm_type_cd').on('change', function () {
			pmMasterPage.checkCycleInfo();
		});

		// ëª¨ë‹¬ì´ í‘œì‹œë  ë•Œë§ˆë‹¤ cycleInfo ì²´í¬ (jQuery fadeIn ë°©ì‹)
		const originalFadeIn = $.fn.fadeIn;
		$.fn.fadeIn = function () {
			if (this.attr('id') === 'modalPmMaster') {
				setTimeout(() => {
					pmMasterPage.checkCycleInfo();
					// ê¸€ììˆ˜ ì¹´ìš´íŠ¸ë„ ì´ˆê¸°í™”
					if (typeof initCharCount === 'function') {
						initCharCount();
					}
				}, 0);
			}
			return originalFadeIn.apply(this, arguments);
		};

		// ê¸€ììˆ˜ ì¹´ìš´íŠ¸ ê¸°ëŠ¥
		function initCharCount() {
			const maxLength = 2000; // HTML maxlengthì™€ ì¼ì¹˜
			const $workText = $('#work_text');
			const $charCount = $('.char-count');
			
			// ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° í›„ ë‹¤ì‹œ ë°”ì¸ë”©
			$workText.off('input').on('input', function () {
				const currentLength = $(this).val().length;
				$charCount.text(`${currentLength} / ${maxLength} bytes`);

				// ìµœëŒ€ ê¸€ììˆ˜ ì²´í¬
				if (currentLength > maxLength) {
					$(this).val($(this).val().substring(0, maxLength));
					$charCount.text(`${maxLength} / ${maxLength} bytes`);
				}
			});
			
			// ì´ˆê¸° ê¸€ììˆ˜ ì„¤ì •
			const initialLength = $workText.val().length;
			$charCount.text(`${initialLength} / ${maxLength} bytes`);
		}
		
		// ëª¨ë‹¬ì´ í‘œì‹œë  ë•Œë§ˆë‹¤ ê¸€ììˆ˜ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
		$('#modalPmMaster').on('shown', function() {
			setTimeout(initCharCount, 100);
		});
		
		// documentì— ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ë” ì•ˆì •ì ì¸ ë°”ì¸ë”©
		$(document).on('input', '#work_text', function() {
			const maxLength = 2000;
			const currentLength = $(this).val().length;
			$('.char-count').text(`${currentLength} / ${maxLength} bytes`);

			// ìµœëŒ€ ê¸€ììˆ˜ ì²´í¬
			if (currentLength > maxLength) {
				$(this).val($(this).val().substring(0, maxLength));
				$('.char-count').text(`${maxLength} / ${maxLength} bytes`);
			}
		});
		
		// ì´ˆê¸° ë°”ì¸ë”©
		initCharCount();

		$('#selJobClass').on('change', function () {
			const selectedValue = $(this).val();
			if (!selectedValue) return;

			const selectedText = $(this).find('option:selected').text();

			// Kendo Gridì— ì§ì¢… ì¶”ê°€
			pmMasterPage.addJobClassToGrid(selectedValue, selectedText);
			
			$(this).data('kendoDropDownList').select(0);
		});

		$("#pmWorkOrderGrid").kendoGrid({
			dataSource: new kendo.data.DataSource({
				transport: {
					read: {
						url: "/api/kmms/pm_master",
						dataType: "json",
						contentType: "application/json",
						data: function () {
							return {
								action: 'read_pm_wo',
								pm_pk: $('#pm_pk').val()
							};
						}
					}
				},
				schema: {
					data: function (response) {
						console.log("Grid Response:", response);
						if (Array.isArray(response)) {
							return response;
						}
						return [];
					}
				},
				requestStart: function () {
					console.log("DataSource request starting with pm_pk:", $('#pm_pk').val());
				}
			}),
			height: 300,
			sortable: true,
			pageable: false,
			autoBind: false, // ìë™ ë°ì´í„° ë°”ì¸ë”© ë¹„í™œì„±í™”
			columns: [
				{ field: "work_order_no", title: "WOë²ˆí˜¸", width: 120 },
				{ field: "reg_dt", title: "WOìƒì„±ì¼", width: 120, format: "{0:yyyy-MM-dd}" },
				{ field: "wo_status_nm", title: "WOìƒíƒœ", width: 100 },
				{ field: "plan_start_dt", title: "ì‘ì—…ê³„íšì¼", width: 120, format: "{0:yyyy-MM-dd}" },
				{ field: "end_dt", title: "ì‘ì—…ì™„ë£Œì¼", width: 120, format: "{0:yyyy-MM-dd}" },
				{ field: "user_nm", title: "ë‹´ë‹¹ì", width: 100 }
			],
			noRecords: true,
			messages: {
				noRecords: "ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
			}
		});
	});



	// ìì¬ í–‰ ì‚­ì œ í•¨ìˆ˜
	function deleteMaterialRow(btn) {
		const tbody = $('#materialTable tbody');
		$(btn).closest('tr').remove();

		// ëª¨ë“  í–‰ì´ ì‚­ì œë˜ì—ˆì„ ë•Œ no-data í–‰ ì¶”ê°€
		if (tbody.children().length === 0) {
			tbody.append(`
				<tr class="no-data">
					<td colspan="5">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
				</tr>
			`);
		}
	}
</script>