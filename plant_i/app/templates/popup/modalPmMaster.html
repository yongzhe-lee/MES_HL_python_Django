<div id="modalPmMaster" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>PM 마스터 등록</h4>
		</div>
		<div class="modal-body">
			<!-- 대상설비 섹션 -->
			<div class="top-section">
				<div class="section-header">
					<h5>
						대상설비
						<i class="fas fa-info-circle tooltip-icon"
						   data-tooltip="PM대상이 되는 설비 등록(하나의 PM당 1개의 설비만 등록 가능)"></i>
					</h5>
					<div class="button-group" style="display: none;">
						<button type="button" class="btn-equipment" id="selectEquipment" name="selectEquipment">
							설비선택
						</button>
						<button type="button" class="btn-copy" id="copyPM" name="copyPM">
							PM복사
						</button>
					</div>
				</div>
				<form id="pmEquipForm">
					<div class="form-row">
						<div class="form-group col-md-6">
							<label for="equip_cd">설비코드</label>
							<input type="hidden" id="equip_pk" name="equip_pk" />
							<input type="text" class="form-control" id="equip_cd" name="equip_cd" readonly>
						</div>
						<div class="form-group col-md-6">
							<label for="equip_nm">설비명</label>
							<input type="text" class="form-control" id="equip_nm" name="equip_nm" readonly>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-md-3">
							<label for="loc_nm">설비위치</label>							
							<input type="text" class="form-control" id="loc_nm" name="loc_nm" readonly>
						</div>
						<div class="form-group col-md-3">
							<label for="import_rank_nm">중요도</label>
							<input type="text" class="form-control" id="import_rank_nm" name="import_rank_nm" readonly>
						</div>
						<div class="form-group col-md-3">
							<label for="equip_status_nm">설비상태</label>
							<input type="text" class="form-control" id="equip_status_nm" name="equip_status_nm" readonly>
						</div>
						<div class="form-group col-md-3">
							<label for="environ_equip_yn">법정관리설비</label>
							<input type="text" class="form-control" id="pm_environ_equip_yn" name="environ_equip_yn" readonly>
						</div>
					</div>
				</form>
			</div>

			<!-- 계획 섹션 -->
			<div class="section">
				<div class="tab-group">
					<button class="tab-button active" data-tab="pmMasterForm">계획</button>
					<button class="tab-button" data-tab="pmWorkerMaterialContent">작업 인력/자재</button>
					<button class="tab-button" data-tab="pmWorkOrderContent">PM WO 목록</button>
				</div>
				<div class="tab-content">
					<!-- 계획 탭 컨텐츠 -->
					<form id="pmMasterForm" class="tab-pane active">
						<input type="hidden" id="pm_pk" name="pm_pk">
						<div class="plan-content">
							<div class="form-row">
								<div class="form-group col-md-6">
									<label for="pm_no">PM번호</label>
									<input type="text" class="form-control" id="pm_no" name="pm_no" placeholder="PM번호는 자동으로 생성됩니다" readonly>
								</div>
								<div class="form-group col-md-6">
									<label for="pm_nm">PM명 <span class="required">*</span></label>
									<input type="text" class="form-control" id="pm_nm" name="pm_nm" placeholder="100자 이하로 입력하세요">
								</div>
							</div>
							<div class="form-row" style="display: flex; width: 100%;">
								<!-- 왼쪽 고정 영역 -->
								<div style="display: flex; gap: 20px; width: 350px; min-width: 350px;">
									<div class="form-group col-md-3" style="width: 200px; min-width: 200px;">
										<label for="pm_type_cd">PM유형 <span class="required">*</span></label>
										<select id="pm_type_cd" name="pm_type_cd">
										</select>
									</div>
									<div class="form-group col-md-3" style="width: 120px; min-width: 120px;">
										<label for="work_expect_hr" style="white-space: nowrap;">정비소요시간(시)</label>
										<input type="number" class="form-control" id="work_expect_hr" name="work_expect_hr" style="text-align: right; padding-right: 20px;" />
									</div>
								</div>

								<!-- 오른쪽 cycleInfo 영역 -->
								<div id="cycleInfo" style="display: none; flex: 1; margin-left: 20px;">
									<div style="display: flex; gap: 20px;">
										<!-- 주기시작일 -->
										<div class="form-group col-md-4" style="display: flex; flex-direction: column;">
											<label for="sched_start_dt">주기시작일 <span class="required">*</span></label>
											<div class="field-wrapper">
												<input type="date" id="sched_start_dt" name="sched_start_dt" />
											</div>
										</div>
										<!-- 주기단위 -->
										<div class="form-group col-md-4" style="display: flex; flex-direction: column;">
											<label for="cycle_type_cd">주기단위 <span class="required">*</span></label>
											<select id="cycle_type_cd" name="cycle_type_cd" style="width: 100px;">
											</select>
										</div>
										<div class="form-group col-md-4" style="width: 120px;">
											<label for="per_number">반복 <span class="required">*</span></label>
											<div style="display: flex; align-items: center;">
												<span style="margin-left: 5px;">매</span>
												<input id="per_number" name="per_number" type="number" class="form-control" style="width: 80px;" />
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="form-row">
								<div class="form-group col-md-6">
									<label for="pm_dept_pk">실행부서 <span class="required">*</span></label>
									<select id="pm_dept_pk" name="dept_pk">
									</select>
								</div>
								<div class="form-group col-md-6">
									<label for="pm_user_pk">PM담당자 <span class="required">*</span></label>
									<select id="pm_user_pk" name="pm_user_pk">
										<option value="">PM담당자를 선택하세요</option>
									</select>
								</div>
							</div>
							<div class="form-group col-md-12">
								<label>작업지침</label>
								<textarea class="form-control" id="work_text" name="work_text" placeholder="2000자 이하로 입력하세요" maxlength="2000"></textarea>
								<div class="char-count">0 / 2000 bytes</div>
							</div>
						</div>
					</form>
					<!-- 작업 인력/자재 탭 컨텐츠 -->
					<div id="pmWorkerMaterialContent" class="tab-pane work-content" style="display: none; overflow-y: auto; max-height: 350px;">
						<div class="work-section">
							<div class="edit-form-ui">
								<div class="col-12 col-md-4 col-lg-4 col-xl-3">
									<div class="form-item align-h">
										<label class="k-label k-form-label" for="selJobClass">작업담당직종</label>
										<div class="field-wrapper">
											<select id="selJobClass" name="selJobClass">
												<option value="">직종을 선택하세요</option>
											</select>
										</div>
									</div>
								</div>
								<div style="text-align: right;">
									<button class="btn-save" id="addOccupations" name="addOccupations">직종 등록</button>
								</div>
							</div>
							<div class="grid">
								<table class="table" id="jobClassTable">
									<thead>
										<tr style="border-top: 2px solid #343a40;">
											<th width="10%">순번</th>
											<th style="display: none;">직종코드</th>
											<th width="40%">직종 *</th>
											<th width="40%">예상작업시간</th>
											<th width="10%">삭제</th>
										</tr>
									</thead>
									<tbody>
										<tr class="no-data">
											<td colspan="4">조회된 데이터가 없습니다.</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>

						<div class="material-section">
							<div class="section-header">
								<h5>필요자재</h5>
								<button class="btn-save" id="selectMaterial" name="selectMaterial">자재선택</button>
							</div>
							<div class="grid">
								<table class="table" id="materialTable">
									<thead>
										<tr style="border-top: 2px solid #343a40;">
											<th>자재코드</th>
											<th>자재명</th>
											<th>예상소요량</th>
											<th>수량단위</th>
											<th>삭제</th>
										</tr>
									</thead>
									<tbody>
										<tr class="no-data">
											<td colspan="5">조회된 데이터가 없습니다.</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<!-- PM WO 목록 탭 컨텐츠 -->
					<div id="pmWorkOrderContent" class="tab-pane" style="display: none;">
						<div id="pmWorkOrderGrid"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- 버튼 영역 -->
		<div class="modal-footer">
			<button type="button" class="btn-save" id="savePmBtn">저장</button>
			<button type="button" class="btn-close" id="closePmModal">닫기</button>
		</div>
	</div>
</div>

<style>

	#modalPmMaster {
		z-index: 1000 !important;
	}

	.form-group {
		flex: 1;
		min-width: 0;
		margin-bottom: 10px;
	}

		.form-group:first-child {
			flex: 0.8;
		}

		.form-group:last-child {
			flex: 1.2;
		}

		.form-group label {
			font-size: 13px;
			font-weight: 600;
			color: #2c3e50;
			margin-bottom: 5px;
		}

	.char-count {
		text-align: right;
		color: #666;
		font-size: 12px;
		margin-top: 3px;
		padding-right: 5px;
	}

	.table {
		width: 100%;
		min-width: 800px;
		border-collapse: collapse;
	}

		.table th, .table td {
			border: 1px solid #ddd;
			text-align: center;
		}

		.table th {
			font-size: 13px;
			font-weight: 600;
			color: #2c3e50;
		}

		.table td {
			font-size: 13px;
			color: #34495e;
		}

	.no-data td {
		text-align: center;
		padding: 20px;
		color: #666;
	}

	.total-count {
		margin-left: 10px;
		color: #666;
	}

	/* 텍스트 영역 스타일 */
	textarea.form-control {
		min-height: 80px;
		resize: none;
		line-height: 1.4;
	}

	/* 직종 테이블 관련 스타일 */
	#jobClassTable .btn-delete {
		background: none;
		border: none;
		color: #dc3545;
		font-size: 18px;
		cursor: pointer;
		padding: 0 5px;
	}

		#jobClassTable .btn-delete:hover {
			color: #c82333;
		}

	#jobClassTable input[type="number"] {
		width: 100%;
		padding: 4px 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
	}

	.section {
		background: #fff;
		margin-bottom: 20px;
		height: auto;
	}
</style>

<script type="text/javascript">
	let pmMasterPage = null;
	class PmMaster {
		constructor() {
			this.grid = null;
			this.baseUrl = '/api/kmms/pm_master';
			this.pmUypeCd = null;
			this.deptPk = null;
			this.cycleTypeCd = null;
			this.cmUserInfo = null;
			this.schedStartDt = null;			
			$('.button-group').show(); // button-group을 기본으로 보이도록 초기화
			this.init();
		}

		init() {
			let _this = this;
			const modal = $("#modalPmMaster");
			// cycleInfo 표시 여부 체크 함수
			this.checkCycleInfo = function () {
				const pmTypeValue = $('#pm_type_cd').val();
				if (pmTypeValue === 'PM_TYPE_TBM') {
					$('#cycleInfo').show();
				} else {
					$('#cycleInfo').hide();
				}
			};

			// 데이터 로드 함수
			this.loadPmData = function (pmPk) {
				let param = {
					action: 'read',
					pm_pk: pmPk
				};

				let result = AjaxUtil.getSyncData(this.baseUrl, param);
				if (result) {
					// 데이터 로드 직후 cycleInfo 체크
					setTimeout(() => this.checkCycleInfo(), 0);
				}
			};

			// 모달이 표시될 때마다 cycleInfo 체크
			modal.on('show', function () {
				_this.checkCycleInfo();
			});

			this.deptPk = AjaxUtil.fillDropDownTreeOptions($("#pm_dept_pk"), "cm_depart", "select");
			this.pmUypeCd = AjaxUtil.fillDropDownOptions($('#pm_type_cd'), 'cm_code', 'choose', null, 'PM_TYPE');
			this.cycleTypeCd = AjaxUtil.fillDropDownOptions($('#cycle_type_cd'), 'cm_code', 'choose', null, 'CYCLE_TYPE');
			this.cmUserInfo = AjaxUtil.fillDropDownOptions($('#pm_user_pk'), 'cm_user_info', 'choose');

			let today = CommonUtil.getYYYYMMDD();
			this.schedStartDt = $("#sched_start_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd",
			});

			$('#selectEquipment').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // 기어 아이콘 (설비 관련)
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEqu');
					equipSelectPage.show(function (res) {
						console.log('data:', res);

						// 선택된 설비 데이터
						FormUtil.BindDataForm(res, $('#pmEquipForm'));
				
					});
				}
			});

			$("#copyPM").kendoButton({
				icon: "k-i-copy",// 복사 아이콘
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalPmCopy', { width: '70%', height: '70%' });
					pmCopyPage.show(function (selectedPm) {
						console.log('selectedPm:', selectedPm);

						FormUtil.BindDataForm(selectedPm, $('#pmMasterForm'));

						$("#equip_cd").val(selectedPm.equip_cd);
						$("#equip_nm").val(selectedPm.equip_nm);

					});
				}
			});

			$('#addOccupations').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // 기어 아이콘 (설비 관련)
				click: function (e) {
					e.preventDefault();
					$("#modalOccupations").fadeIn();
				}
			});

			$('#selectMaterial').kendoButton({
				themeColor: "base",
				icon: "k-i-plus", // 기어 아이콘 (설비 관련)
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalMatSel');
					matSelectPage.show();
				}
			});

			// ESC 키 누를 때 모달 닫기
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) { // ESC key
					modal.fadeOut();
				}
			});

			$("#savePmBtn").kendoButton({
				icon: "k-i-save",
				click: function (e) {
					e.preventDefault();
					_this.saveData();
				},
				themeColor: "none"
			}).closest(".k-button").css({
				"background": "#ECF5FF",
				"color": "#409EFF",
				"border-color": "#B3D8FF",
				"border": "1px solid #00a9ff",
				"padding": "6px 12px",
				"border-radius": "4px",
				"cursor": "pointer",
				"min-width": "40px",
				"height": "28px",
				"line-height": "1"
			}).hover(
				function () {
					$(this).css({
						"background-color": "#C2DFFF",
						"border-color": "#0054e0"
					});
				},
				function () {
					$(this).css({
						"background": "#ECF5FF",
						"border-color": "#B3D8FF"
					});
				}
			);

			// 모달 닫기 - 닫기 버튼 클릭
			$('#closePmModal').kendoButton({
				click: function (e) {
					e.preventDefault();
					modal.fadeOut();
					_this.reset();
				}
			});

			AjaxUtil.fillDropDownOptions($('#selJobClass'), 'job_class', 'choose', null);

			// 탭 이벤트 초기화 추가
			_this.initTabEvents();
		}

		saveData() {
			let _this = this;
			let data = FormUtil.extractForm($('#pmMasterForm'));			
			data.equip_pk = $("#equip_pk").val();		

			if (!data.equip_pk) {
				Alert.alert('', '설비를 선택해주세요.');
				return;
			}

			// 유효성 검사
			if (!$('#pm_nm').val()) {
				Alert.alert('', 'PM명을 입력해주세요.');
				return;
			}

			if (!data.pm_type_cd) {
				Alert.alert('', 'PM유형을 선택해주세요.');
				return;
			}

			// TBM 유형 체크
			if (data.pm_type_cd === 'PM_TYPE_TBM') {
				if (!$("#sched_start_dt").val() || !$("#cycle_type_cd").val() || !$("#per_number").val()) {
					Alert.alert('', '주기 정보를 모두 입력해주세요.');
					return;
				}
			}

			if (!data.dept_pk) {
				Alert.alert('', '실행부서를 선택해주세요.');
				return;
			}

			if (!$("#pm_user_pk").val()) {
				Alert.alert('', 'PM담당자를 선택해주세요.');
				return;
			}

			let funcSucc = function (resp) {
				if (resp.success) {
					// 기본 정보 저장 성공 시 작업 인력 저장 진행
					_this.savePmLalor(resp);
				} else {
					Alert.alert('error', resp.message);
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, funcSucc);
			$("#modalPmMaster").fadeOut();
		}

		reset() {
			$('.button-group').show();
			FormUtil.resetForm($('#pmEquipForm'));			
			
			this.checkCycleInfo();
		}

		savePmLalor(resp) {
			let _this = this;
			let jobClassData = [];
			$('#jobClassTable tbody tr').not('.no-data').each(function () {
				const job_class_pk = $(this).data('value');
				let work_hr = $(this).find('input[type="number"]').val();
				work_hr = work_hr || 0;
				jobClassData.push({
					job_class_pk: job_class_pk,
					work_hr: work_hr
				});
			});

			// 작업 인력 데이터가 없는 경우 바로 자재 저장으로 진행
			if (jobClassData.length === 0) {
				_this.savePmMtrl(resp);
				return;
			}

			let data = {
				job_classes: JSON.stringify(jobClassData),
				pm_pk: resp.id
			};

			let funcSucc2 = function (resp2) {
				if (resp2.success) {
					_this.savePmMtrl(resp);
				} else {
					Alert.alert('error', resp2.message);
				}
			}

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_job_classes', data, funcSucc2);
		}

		savePmMtrl(resp) {
			let _this = this;
			let materialData = [];
			$('#materialTable tbody tr').not('.no-data').each(function () {
				const mat_pk = $(this).data('value');
				let mtrl_qty = $(this).find('input[type="number"]').val();
				mtrl_qty = mtrl_qty || 0;
				materialData.push({
					mat_pk: mat_pk,
					mtrl_qty: mtrl_qty
				});
			});

			// 자재 데이터가 없는 경우 바로 완료 처리
			if (materialData.length === 0) {
				_this.finalizeSave();
				return;
			}

			let data = {
				materials: JSON.stringify(materialData),
				pm_pk: resp.id
			};

			let funcSucc3 = function (resp3) {
				if (resp3.success) {
					_this.finalizeSave();
				} else {
					Alert.alert('error', resp3.message);
				}
			}

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_materials', data, funcSucc3);
		}

		finalizeSave() {
			Notify.success('저장되었습니다.');
			this.reset();
			page.searchMainData();
		}

		searchLocationData() {
			let _this = this;

			let param = {
				action: 'read',
			};

			let result = AjaxUtil.getSyncData(_this.baseUrl, param);
			_this.grid.setData(result);
			// 데이터 로드 후 cycleInfo 체크
			this.checkCycleInfo();
		}

		//pm 마스터
		show(pmId) {
			let _this = this;
			
			// '계획' 탭 항상 active 처리
			$('.tab-button').removeClass('active');
			$('.tab-pane').removeClass('active').hide();
			$('.tab-button[data-tab="pmMasterForm"]').addClass('active');
			$('#pmMasterForm').addClass('active').show();

			if (pmId > 0) {	
				$('.button-group').hide();

				// 1. PM 상세 정보 API 호출
				let param1 = {
					action: 'findOne',
					id: pmId,
				};

				let pmData = AjaxUtil.getSyncData(_this.baseUrl, param1);

				// 계획 tab			
				FormUtil.BindDataForm(pmData, $('#pmMasterForm'));


				let paramEquip = {
					action: 'findOne',
					equip_pk: pmData.equip_pk,
				};
				let equipData = AjaxUtil.getSyncData('/api/kmms/equipment', paramEquip);
				//대상설비
				FormUtil.BindDataForm(equipData, $('#pmEquipForm'));			

				// 2. PM 작업 인력 API 호출
				let param2 = {
					action: 'detail_pm_labor',
					id: pmId,
				};
				let pmDataLabor = AjaxUtil.getSyncData(_this.baseUrl, param2);

				// 3. PM 필요자재 API 호출
				let param3 = {
					action: 'detail_pm_mtrl',
					id: pmId,
				};
				let pmDataMtrl = AjaxUtil.getSyncData(_this.baseUrl, param3);

				// 2.1. 작업인력 테이블 초기화 및 데이터 바인딩
				$('#jobClassTable tbody').empty();

				if (Array.isArray(pmDataLabor) && pmDataLabor.length > 0) {
					pmDataLabor.forEach((labor, index) => {

						// null 체크를 포함한 안전한 데이터 접근
						const id = labor?.id || '';
						const job_class_pk = labor?.job_class_pk || '';
						const job_class_nm = labor?.job_class_nm || '';
						const work_hr = labor?.work_hr || '';

						const newRow = `
						<tr data-value="${job_class_pk}">
							<td>${index + 1}</td>
							<td style="display: none;">${job_class_pk}</td>
							<td>${job_class_nm}</td>
							<td>
								<input type="number"
									   class="form-control form-control-sm text-end"
									   min="0"
									   step="0.5"
									   placeholder="시간 입력"
									   value="${work_hr}" />
							</td>
							<td class="text-center">
								<button type="button" class="btn-delete" onclick="deleteJobClassRow(this)">×</button>
							</td>
						</tr>
					`;
						$('#jobClassTable tbody').append(newRow);
					});
				} else {
					console.log("📌 [ERROR] 작업인력 데이터가 없거나 유효하지 않음:", pmDataLabor);
				}

				// 3.1. 필요자재 테이블 초기화 및 데이터 바인딩
				$('#materialTable tbody').empty();  // 기존 테이블 초기화

				if (Array.isArray(pmDataMtrl) && pmDataMtrl.length > 0) {
					pmDataMtrl.forEach((mtrl, index) => {

						// null 체크를 포함한 안전한 데이터 접근
						const mat_pk = mtrl?.mat_pk || '';
						const mat_cd = mtrl?.mat_cd || '';
						const mat_nm = mtrl?.mat_nm || '';
						const amt = mtrl?.amt || '0';  // 기본값 설정
						const unit = mtrl?.BasicUnit || '';

						const newRow = `
						<tr data-value="${mat_pk}">
							<td>${mat_cd}</td>
							<td>${mat_nm}</td>
							<td>
								<input type="number"
									   class="form-control form-control-sm text-end"
									   min="0"
									   step="1"
									   value="${amt}"
									   placeholder="수량 입력"
									   name="amt"/>
							</td>
							<td>${unit}</td>
							<td class="text-center">
								<button type="button" class="btn-delete" onclick="deleteMaterialRow(this)">×</button>
							</td>
						</tr>
					`;
						$('#materialTable tbody').append(newRow);  // materialTable로 수정
					});
				} else {
					console.log("📌 [ERROR] 필요자재 데이터가 없거나 유효하지 않음:", pmDataMtrl);
				}
				
			} else {
				_this.reset();
				FormUtil.resetForm($('#pmMasterForm'));
			}
			$("#modalPmMaster").fadeIn();
		}

		// 탭 전환 이벤트 핸들러
		initTabEvents() {
			let _this = this;

			$('.tab-button').on('click', function () {
				const tabId = $(this).data('tab');
				$('.tab-button').removeClass('active').removeAttr('style');
				$('.tab-pane').removeClass('active').hide();
				$(this).addClass('active');

				if (tabId) {
					$('#' + tabId).addClass('active').show(); // 해당 탭 콘텐츠를 활성화하고 보여줌
					switch (tabId) {
						case 'pmMasterForm':
							if (_this.currentPmData) {
							
							}
							break;
						case 'pmWorkerMaterialContent':
							// 추가적인 로직이 필요하면 여기에 작성
							break;
						case 'pmWorkOrderContent':
							var grid = $("#pmWorkOrderGrid").data("kendoGrid");
							var pmPk = $('#pm_pk').val();
							if (grid && pmPk) {
								grid.dataSource.read(); // 그리드 데이터 새로고침
							}
							break;
					}
				}
			});
		}
	}

	function deleteRow(btn) {
		const tr = $(btn).closest('tr');
		tr.remove();

		// 모든 행이 삭제되었을 때 no-data 행 추가
		if ($('tbody tr').length === 0) {
			$('tbody').append(`
			<tr class="no-data">
				<td colspan="4">조회된 데이터가 없습니다.</td>
			</tr>
		`);
		}

		// 순번 재정렬
		$('tbody tr:not(.no-data)').each((index, tr) => {
			$(tr).find('td:first').text(index + 1);
		});
	}

	pmMasterPage = new PmMaster();
	$(document).ready(function () {

		$('#pm_type_cd').on('change', function () {
			pmMasterPage.checkCycleInfo();
		});

		// 모달이 표시될 때마다 cycleInfo 체크 (jQuery fadeIn 방식)
		const originalFadeIn = $.fn.fadeIn;
		$.fn.fadeIn = function () {
			if (this.attr('id') === 'modalPmMaster') {
				setTimeout(() => pmMasterPage.checkCycleInfo(), 0);
			}
			return originalFadeIn.apply(this, arguments);
		};

		// 글자수 카운트 기능
		$('#work_text').on('input', function () {
			const maxLength = 4000;
			const currentLength = $(this).val().length;
			$('.char-count').text(`${currentLength} / ${maxLength} bytes`);

			// 최대 글자수 체크
			if (currentLength > maxLength) {
				$(this).val($(this).val().substring(0, maxLength));
			}
		});

		let rowCount = 0;

		$('#selJobClass').on('change', function () {
			const selectedValue = $(this).val();
			if (!selectedValue) return;

			const selectedText = $(this).find('option:selected').text();

			// 이미 존재하는 직종인지 확인
			const exists = $('#jobClassTable tbody tr').not('.no-data').toArray().some(tr =>
				$(tr).find('td:nth-child(3)').text() === selectedText
			);

			if (exists) {
				Alert.alert('', '이미 추가된 직종입니다.');
				$(this).val('');
				return;
			}

			// no-data 행 제거
			$('#jobClassTable .no-data').remove();

			// 현재 행 수 계산
			rowCount = $('#jobClassTable tbody tr').length + 1;

			const newRow = `
				<tr data-value="${selectedValue}">
					<td>${rowCount}</td>
					<td style="display: none;">${selectedValue}</td>
					<td>${selectedText}</td>
					<td>
						<input type="number"
							class="form-control form-control-sm text-end"
							min="0"
							step="1"
							oninput="this.value"
							placeholder="시간 입력"/>
					</td>
					<td class="text-center">
						<button type="button" class="btn-delete" onclick="deleteJobClassRow(this)">×</button>
					</td>
				</tr>
			`;

			$('#jobClassTable tbody').append(newRow);
			$(this).val(''); // 선택 초기화
		});

		$("#pmWorkOrderGrid").kendoGrid({
			dataSource: new kendo.data.DataSource({
				transport: {
					read: {
						url: "/api/kmms/pm_master",
						dataType: "json",
						contentType: "application/json",
						data: function () {
							return {
								action: 'read_pm_wo',
								pm_pk: $('#pm_pk').val()
							};
						}
					}
				},
				schema: {
					data: function (response) {
						console.log("Grid Response:", response);
						if (Array.isArray(response)) {
							return response;
						}
						return [];
					}
				},
				requestStart: function () {
					console.log("DataSource request starting with pm_pk:", $('#pm_pk').val());
				}
			}),
			height: 300,
			sortable: true,
			pageable: false,
			autoBind: false, // 자동 데이터 바인딩 비활성화
			columns: [
				{ field: "work_order_no", title: "WO번호", width: 120 },
				{ field: "reg_dt", title: "WO생성일", width: 120, format: "{0:yyyy-MM-dd}" },
				{ field: "wo_status_nm", title: "WO상태", width: 100 },
				{ field: "plan_start_dt", title: "작업계획일", width: 120, format: "{0:yyyy-MM-dd}" },
				{ field: "end_dt", title: "작업완료일", width: 120, format: "{0:yyyy-MM-dd}" },
				{ field: "user_nm", title: "담당자", width: 100 }
			],
			noRecords: {
				template: "조회된 데이터가 없습니다."
			}
		});
	});

	// 직종 행 삭제 함수
	function deleteJobClassRow(btn) {
		const tbody = $('#jobClassTable tbody');
		$(btn).closest('tr').remove();

		// 모든 행이 삭제되었을 때 no-data 행 추가
		if (tbody.children().length === 0) {
			tbody.append(`
				<tr class="no-data">
					<td colspan="4">조회된 데이터가 없습니다.</td>
				</tr>
			`);
		} else {
			// 순번 재정렬
			tbody.find('tr').not('.no-data').each((index, tr) => {
				$(tr).find('td:first').text(index + 1);
			});
		}
	}
</script>