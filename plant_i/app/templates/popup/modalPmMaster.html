<div id="modalPmMaster" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>PM 마스터 등록</h4>
        </div>

        <div class="modal-body">
            <!-- 대상설비 섹션 -->
            <div class="equipment-section">
                <div class="section-header">
                    <h5>
                        대상설비
                        <i class="fas fa-info-circle tooltip-icon"
                           data-tooltip="PM대상이 되는 설비 등록(하나의 PM당 1개의 설비만 등록 가능)"></i>
                    </h5>
                    <div class="button-group">
                        <button type="button" class="btn-equipment" id="selectEquipment" name="selectEquipment">
                            <i class="fas fa-search"></i> 설비선택
                        </button>
                        <button type="button" class="btn-copy" id="copyPM" name="copyPM">
                            <i class="fas fa-copy"></i> PM복사
                        </button>
                    </div>
                </div>
                <div class="equipment-info">
                    <div class="form-row">
                        <div class="form-group">
                            <label>설비코드</label>
                            <input type="hidden" id="equ_id" name="equ_id" />
                            <input type="text" class="form-control" id="equ_code" name="equ_code" readonly>
                        </div>
                        <div class="form-group">
                            <label>설비명</label>
                            <input type="text" class="form-control" id="equ_name" name="equ_name" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>설비위치</label>
                            <input type="hidden" id="equ_loc_pk" name="equ_loc_pk" />
                            <input type="text" class="form-control" id="equ_loc" name="equ_loc" readonly>
                        </div>
                        <div class="form-group">
                            <label>중요도</label>
                            <input type="text" class="form-control" id="equ_import" name="equ_import" readonly>
                        </div>
                        <div class="form-group">
                            <label>설비상태</label>
                            <input type="text" class="form-control" id="equ_status" name="equ_status" readonly>
                        </div>
                        <div class="form-group">
                            <label>법정관리설비</label>
                            <input type="text" class="form-control" id="equ_env_yn" name="equ_env_yn" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 계획 섹션 -->
            <div class="section">
                <div class="tab-group">
                    <button class="active">계획</button>
                    <button>작업 인력/자재</button>
                    <button>PM WO 목록</button>
                </div>
                <div class="tab-content">
                    <!-- 계획 탭 컨텐츠 -->
                    <form id="pmMasterForm">
                        <input type="hidden" id="pm_pk" name="pm_pk">
                        <div class="plan-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>PM 번호 <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="pmNumber" name="pmNumber" placeholder="PM번호는 자동으로 생성됩니다" readonly>
                                </div>
                                <div class="form-group">
                                    <label>PM명 <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="pmName" name="pmName" placeholder="100자 이하로 입력하세요">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>PM유형 <span class="required">*</span></label>
                                    <select class="form-control" id="pmType" name="pmType">
                                        <option value="">PM유형을 선택하세요</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>정비소요시간(시)</label>
                                    <input type="number" class="form-control" id="maintenanceTime" name="maintenanceTime">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>실행부서 <span class="required">*</span></label>
                                    <select class="form-control" id="executionDept" name="executionDept">
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>PM담당자 <span class="required">*</span></label>
                                    <select class="form-control" id="pmManager" name="pmManager">
                                        <option value="">PM담당자를 선택하세요</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>작업지침</label>
                                <textarea class="form-control" id="work_text" name="work_text" placeholder="2000자 이하로 입력하세요" maxlength="2000"></textarea>
                                <div class="char-count">0 / 2000 bytes</div>
                            </div>
                        </div>
                    </form>
                    <!-- 작업 인력/자재 탭 컨텐츠 -->
                    <div id="pmWorkerMaterialContent" class="work-content" style="display: none;">
                        <div class="work-section">
                            <div class="edit-form-ui">
                                <div class="col-12 col-md-4 col-lg-4 col-xl-3">
                                    <div class="form-item align-h">
                                        <label class="k-label k-form-label" for="selJobClass">작업담당직종</label>
                                        <div class="field-wrapper">
                                            <select id="selJobClass" name="selJobClass" class="form-control">
                                                <option value="">직종을 선택하세요</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <button class="btn btn-sm btn-primary" id="addOccupations" name="addOccupations">직종 등록</button>
                                </div>
                            </div>
                            <div class="grid">
                                <table class="table" id="jobClassTable">
                                    <thead>
                                        <tr style="border-top: 2px solid #343a40;">
                                            <th width="10%">순번</th>
                                            <th width="40%">직종 *</th>
                                            <th width="40%">예상작업시간</th>
                                            <th width="10%">삭제</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="no-data">
                                            <td colspan="4">조회된 데이터가 없습니다.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="material-section">
                            <div class="section-header">
                                <h5>필요자재</h5>
                                <button class="btn btn-sm btn-primary" id="selectMaterial" name="selectMaterial">자재선택</button>
                            </div>
                            <div class="grid">
                                <table class="table">
                                    <thead>
                                        <tr style="border-top: 2px solid #343a40;">
                                            <th>자재코드</th>
                                            <th>자재명</th>
                                            <th>예상소요량</th>
                                            <th>수량단위</th>
                                            <th>삭제</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="no-data">
                                            <td colspan="5">조회된 데이터가 없습니다.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- PM WO 목록 탭 컨텐츠 -->
                    <div id="pmWorkOrderContent" class="pmwo-content" style="display: none;">
                        <div class="grid">
                            <table class="table">
                                <thead>
                                    <tr style="border-top: 2px solid #343a40;">
                                        <th>WO번호</th>
                                        <th>WO생성일</th>
                                        <th>WO상태</th>
                                        <th>작업계획일</th>
                                        <th>작업완료일</th>
                                        <th>담당자</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="no-data">
                                        <td colspan="6">데이터 없음</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="pagination">
                                <button class="prev-btn">&lt;</button>
                                <span class="page-number">1</span>
                                <button class="next-btn">&gt;</button>
                                <select class="page-size">
                                    <option value="30">30</option>
                                </select>
                                <span class="total-count">Total: 0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 버튼 영역 -->
        <div class="modal-footer">
            <button type="button" class="btn-save" id="saveBtn">저장</button>
            <button type="button" class="btn-close" id="closePmModal">닫기</button>
        </div>
    </div>
</div>

<style>
    /* 설비선택, PM복사 버튼 스타일 */
    .modal .btn-equipment, .btn-copy {
        background: #1e4f88 !important;
        color: white !important;
        border: none !important;
    }

    .modal .btn-equipment:hover, .btn-copy:hover {
        background-color: #2980b9;
    }

    /* 작업 등록, 자재선택, 저장, 닫기 버튼 스타일 */
    .modal .btn-primary, #addOccupations, #selectMaterial {
        background-color: #3498db;
        border: none;
        color: white;
    }

    .modal .btn-primary:hover, #addOccupations:hover, #selectMaterial:hover {
        background-color: #2980b9;
    }

    .section {
        background: #fff;
        margin-bottom: 20px;
        height: auto;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .form-group {
        flex: 1;
        min-width: 0;
        margin-bottom: 10px;
    }

        .form-group:first-child {
            flex: 0.8;
        }

        .form-group:last-child {
            flex: 1.2;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

    .form-control {
        font-size: 13px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: border-color 0.2s;
    }

        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

    .required {
        color: #e74c3c;
        margin-left: 3px;
    }

    .tabs {
        margin-bottom: 15px;
        border-bottom: 1px solid #ddd;
    }

    .tab {
        padding: 8px 15px;
        border: none;
        background: none;
        cursor: pointer;
    }

        .tab.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }

    textarea {
        min-height: 150px;
        resize: vertical;
    }

    .char-count {
        text-align: right;
        color: #666;
        font-size: 12px;
        margin-top: 3px;
        padding-right: 5px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .grid {
        width: 100%;
        margin-bottom: 20px;
    }

    .table {
        width: 100%;
        min-width: 800px;
        border-collapse: collapse;
    }

        .table th, .table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .table th {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
        }

        .table td {
            font-size: 13px;
            color: #34495e;
        }

    .no-data td {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 10px;
    }

    .page-size {
        margin-left: 10px;
    }

    .total-count {
        margin-left: 10px;
        color: #666;
    }

    /* 텍스트 영역 스타일 */
    textarea.form-control {
        width: 100%;
        height: 80px;
        min-height: 80px;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: none;
        font-size: 14px;
        line-height: 1.4;
    }

        /* 텍스트 영역 placeholder 스타일 */
        textarea.form-control::placeholder {
            color: #999;
        }

        /* 텍스트 영역 포커스 스타일 */
        textarea.form-control:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

    /* 대상설비 섹션 전용 스타일 */
    .equipment-section {
        background: #fff;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
    }

        /* 첫 번째 form-row의 input 너비 조정 */
        .equipment-section .form-row:first-child .form-group {
            flex: 1;
        }

        /* 두 번째 form-row의 input 너비 동일하게 조정 */
        .equipment-section .form-row:last-child .form-group {
            flex: 1;
        }

    /* 탭 컨테이너 */
    .tab-container {
        margin-top: 20px;
    }

    /* 탭 컨텐츠 영역 */
    .tab-content {
        position: relative; /* 위치 고정 */
        min-height: 400px; /* 최소 높이 설정 */
        width: 100%; /* 너비 100% */
    }

        .tab-content > .tab-pane {
            position: absolute; /* 절대 위치 */
            width: 100%; /* 너비 100% */
            display: none; /* 기본적으로 숨김 */
        }

        .tab-content > .active {
            display: block; /* 활성화된 탭만 표시 */
            position: relative; /* 활성화된 탭은 상대 위치로 */
        }

    /* 툴팁 스타일 */
    .section-title {
        position: relative;
        display: flex;
        align-items: center;
    }

        .section-title h4 {
            margin: 0;
            display: flex;
            align-items: center;
        }

    /* 느낌표 아이콘 스타일 */
    .info-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        background: #e9ecef;
        border-radius: 50%;
        margin-left: 5px;
        cursor: help;
        position: relative;
    }

        .info-badge i {
            font-size: 12px;
            color: #666;
        }

    /* 툴팁 스타일 */
    .tooltip {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 400px;
        background: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 4px;
        padding: 15px;
        z-index: 1000;
        margin-top: 10px;
    }

        .tooltip h5 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 14px;
        }

    .tooltip-content {
        font-size: 13px;
        line-height: 1.5;
    }

        .tooltip-content p {
            margin: 5px 0;
        }

        .tooltip-content .highlight {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
        }

    /* 마우스 오버 시 툴팁 표시 */
    .info-badge:hover .tooltip {
        display: block;
    }

    /* 툴팁 화살표 */
    .tooltip:before {
        content: '';
        position: absolute;
        top: -6px;
        left: 10px;
        width: 10px;
        height: 10px;
        background: #fff;
        border-left: 1px solid #ddd;
        border-top: 1px solid #ddd;
        transform: rotate(45deg);
    }    

    /* 툴팁 아이콘 스타일 */
    .tooltip-icon {
        color: #6c757d;
        font-size: 14px;
        margin-left: 5px;
        cursor: help;
        position: relative;
    }

        /* 툴팁 스타일 */
        .tooltip-icon[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 100%;
            width: max-content;
            max-width: 300px;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #2c3e50;
            color: white;
            font-size: 12px;
            font-weight: normal;
            z-index: 1000;
            white-space: nowrap;
        }

        /* 툴팁 화살표 */
        .tooltip-icon[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 100%;
            border: 6px solid transparent;
            border-top-color: #2c3e50;
            margin-bottom: -12px;
        }

    /* 탭 스타일 */
    .nav-tabs {
        border-bottom: none;
    }

        .nav-tabs .nav-item .nav-link {
            border: none;
            padding: 8px 16px;
            color: #666;
            background-color: transparent;
        }

            .nav-tabs .nav-item .nav-link.active {
                background-color: transparent;
                color: #666;
                border-radius: 0;
            }

            /* 비활성 탭 스타일 */
            .nav-tabs .nav-item .nav-link:not(.active) {
                background-color: transparent;
            }

    /* 탭 영역 스타일 */
    .tab-group {
        display: flex;
        margin-bottom: 10px;
        border-bottom: 1px solid #1e4f88; /* 네이비 컬러 밑줄 */
    }

        .tab-group button {
            padding: 6px 20px;
            border: 1px solid #ccc;
            background: #f5f5f5;
            margin-right: -1px;
            cursor: pointer;
            font-size: 12px;
        }

            .tab-group button.active {
                background: #1e4f88; /* 네이비 배경색 */
                color: white;
                border-color: #1e4f88;
                position: relative;
            }

            /* 마지막 탭 오른쪽 여백 제거 */
            .tab-group button:last-child {
                margin-right: 0;
            }

    #modalPmMaster {
        z-index: 1000 !important; /* ✅ 부모 모달의 z-index */
    }

    #pmMasterTabs {
        margin-bottom: 20px;
    }

        #pmMasterTabs button {
            padding: 10px 20px;
            margin-right: 5px;
            border: 1px solid #ddd;
            background: #f5f5f5;
            cursor: pointer;
        }

            #pmMasterTabs button.active {
                background: #007bff;
                color: white;
                border-color: #0056b3;
            }

            #pmMasterTabs button:hover {
                background: #e9ecef;
            }

            #pmMasterTabs button.active:hover {
                background: #0056b3;
            }

    /* 직종 테이블 관련 스타일 추가 */
    #jobClassTable .btn-delete {
        background: none;
        border: none;
        color: #dc3545;
        font-size: 18px;
        cursor: pointer;
        padding: 0 5px;
    }

        #jobClassTable .btn-delete:hover {
            color: #c82333;
        }

    #jobClassTable input[type="number"] {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
</style>

<script type="text/javascript">
    let pmMasterPage = null;
    class PmMaster {
        constructor() {
            this.grid = null;
            this.baseUrl = '/api/kmms/pm_master';

            this.resetForm = this.resetForm.bind(this);
            this.init();
        }

        init() {
            let _this = this;
            const modal = $("#modalPmMaster");

            AjaxUtil.fillDropDownOptions($('#pmType'), 'user_code', 'choose', null, 'PM_TYPE');
            AjaxUtil.fillDropDownTreeOptions($("#executionDept"), "depart", "select");
            AjaxUtil.fillDropDownOptions($('#pmManager'), 'auth_user', 'choose', null);

            $('#selectEquipment').kendoButton({
                themeColor: "base",
                icon: "k-i-plus", // 기어 아이콘 (설비 관련)
                click: function (e) {
                    e.preventDefault();
                    $("#modalEqu").fadeIn();
                }
            });

            $("#copyPM").kendoButton({
                icon: "k-i-copy",// 복사 아이콘
                click: function (e) {
                    e.preventDefault();
                    $("#modalPmCopy").fadeIn();
                }
            });

            $('#addOccupations').kendoButton({
                themeColor: "base",
                icon: "k-i-plus", // 기어 아이콘 (설비 관련)
                click: function (e) {
                    e.preventDefault();
                    $("#modalOccupations").fadeIn();
                }
            });

            $('#selectMaterial').kendoButton({
                themeColor: "base",
                icon: "k-i-plus", // 기어 아이콘 (설비 관련)
                click: function (e) {
                    e.preventDefault();
                    $("#modalMaterials").fadeIn();
                }
            });

            // ESC 키 누를 때 모달 닫기
            $(document).on('keydown', (e) => {
                if (e.keyCode === 27) { // ESC key
                    modal.fadeOut();
                }
            });

            $("#saveBtn").kendoButton({
                icon: "k-i-save",
                click: function (e) {
                    e.preventDefault();                    
                    _this.saveData();
                }
            });

            // 모달 닫기 - 닫기 버튼 클릭
            $('#closePmModal').kendoButton({
                click: function (e) {
                    e.preventDefault();
                    modal.fadeOut();
                }
            });

            AjaxUtil.fillDropDownOptions($('#selJobClass'), 'job_class', 'choose', null);

        }

        saveData() {
            let _this = this;
            let data = FormUtil.extractForm($('#pmMasterForm'));
            data.pm_type = $("#pmType").val();  // pmType 값 명시적 추가
            data.dept_id = $("#executionDept").data("kendoDropDownTree").value();
            data.pmManager = $("#pmManager").val();
            data.equ_id = $("#equ_id").val();
            
            let Name = $('#pmName').val();
            if (!Name) {
                Alert.alert('', 'PM명을 입력해주세요.');
                return;
            }

            let funcSucc = function (resp) {
                if (resp.success) {
                    Notify.success('저장되었습니다.');
                    _this.resetData();

                    // 부모 페이지의 그리드 갱신
                    page.searchMainData();

                } else {
                    Alert.alert('error', resp.message);
                }
            };

            AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, funcSucc);
            $("#modalPmMaster").fadeOut();
        }

        resetData() {
            let _this = this;
            FormUtil.resetForm($('#pmMasterForm'));
        }

        searchLocationData() {
            let _this = this;

            let param = {
                action: 'read',
            };

            let result = AjaxUtil.getSyncData(_this.baseUrl, param);
            _this.grid.setData(result);
        }

        resetForm() {

        }
    }

    function deleteRow(btn) {
        const tr = $(btn).closest('tr');
        tr.remove();

        // 모든 행이 삭제되었을 때 no-data 행 추가
        if ($('tbody tr').length === 0) {
            $('tbody').append(`
            <tr class="no-data">
                <td colspan="4">조회된 데이터가 없습니다.</td>
            </tr>
        `);
        }

        // 순번 재정렬
        $('tbody tr:not(.no-data)').each((index, tr) => {
            $(tr).find('td:first').text(index + 1);
        });
    }

    pmMasterPage = new PmMaster();
    $(document).ready(function () {
        // 탭 클릭 이벤트 처리
        $('.tab-group button').on('click', function () {
            // 모든 탭에서 active 클래스 제거
            $('.tab-group button').removeClass('active');
            // 클릭된 탭에 active 클래스 추가
            $(this).addClass('active');

            // 모든 컨텐츠 숨기기
            $('#pmMasterForm, #pmWorkerMaterialContent, #pmWorkOrderContent').hide();

            // 탭 내용 전환
            var tabName = $(this).text().trim();
            switch (tabName) {
                case '계획':
                    $('#pmMasterForm').show();
                    break;
                case '작업 인력/자재':
                    $('#pmWorkerMaterialContent').show();
                    break;
                case 'PM WO 목록':
                    $('#pmWorkOrderContent').show();
                    break;
            }
        });

        // 초기 상태: 계획 탭 활성화
        $('.tab-group button:first').click();

        // 글자수 카운트 기능
        $('#work_text').on('input', function () {
            const maxLength = 4000;
            const currentLength = $(this).val().length;
            $('.char-count').text(`${currentLength} / ${maxLength} bytes`);

            // 최대 글자수 체크
            if (currentLength > maxLength) {
                $(this).val($(this).val().substring(0, maxLength));
            }
        });

        let rowCount = 0;

        $('#selJobClass').on('change', function () {
            const selectedValue = $(this).val();
            if (!selectedValue) return;

            const selectedText = $(this).find('option:selected').text();

            // 이미 존재하는 직종인지 확인
            const exists = $('#jobClassTable tbody tr').not('.no-data').toArray().some(tr =>
                $(tr).find('td:nth-child(2)').text() === selectedText
            );

            if (exists) {
                Alert.alert('', '이미 추가된 직종입니다.');
                $(this).val('');
                return;
            }

            // no-data 행 제거
            $('#jobClassTable .no-data').remove();

            // 현재 행 수 계산
            rowCount = $('#jobClassTable tbody tr').length + 1;

            const newRow = `
                <tr data-value="${selectedValue}">
                    <td>${rowCount}</td>
                    <td>${selectedText}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-end"
                               min="0" step="0.5" placeholder="시간 입력"/>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn-delete" onclick="deleteJobClassRow(this)">×</button>
                    </td>
                </tr>
            `;

            $('#jobClassTable tbody').append(newRow);
            $(this).val(''); // 선택 초기화
        });
    });

    // 직종 행 삭제 함수
    function deleteJobClassRow(btn) {
        const tbody = $('#jobClassTable tbody');
        $(btn).closest('tr').remove();

        // 모든 행이 삭제되었을 때 no-data 행 추가
        if (tbody.children().length === 0) {
            tbody.append(`
                <tr class="no-data">
                    <td colspan="4">조회된 데이터가 없습니다.</td>
                </tr>
            `);
        } else {
            // 순번 재정렬
            tbody.find('tr').not('.no-data').each((index, tr) => {
                $(tr).find('td:first').text(index + 1);
            });
        }
    }
</script>