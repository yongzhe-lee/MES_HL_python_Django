<div id="modalWoDetail" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>ì‘ì—… ê²°ê³¼ì…ë ¥</h4>
		</div>

		<div class="modal-body">
			<input type="hidden" id="work_order_pk" name="work_order_pk" />
			<!-- ê²°ì¬ ë¼ì¸ -->
			<div class="appLine-section">
				<div class="navigation-menu">
					<span class="menu-item pm-icon">PM</span>
					<span class="menu-separator">>></span>
					<span class="menu-item">ì‘ì—…ìš”ì²­</span>
					<span class="menu-separator">></span>
					<span class="menu-item">ìš”ì²­ìŠ¹ì¸</span>
					<span class="menu-separator">></span>
					<span class="menu-item">ì‘ì—…ìŠ¹ì¸</span>
					<span class="menu-separator">></span>
					<span class="menu-item">ì‘ì—…ì™„ë£Œ</span>
					<span class="menu-separator">></span>
					<span class="menu-item">WO ì™„ë£Œ</span>
				</div>
			</div>
			<!-- ëŒ€ìƒì„¤ë¹„ ì„¹ì…˜ -->
			<div class="equipment-section">
				<div class="form-row">					
					<input type="hidden" id="tabId" name="tabId" />
					<div class="form-group">
						<label>ì‘ì—…ì œëª©</label>
						<input type="text" class="form-control" id="sum_work_title" name="sum_work_title" readonly>
					</div>
					<div class="form-group">
						<label>ì‘ì—…ìœ í˜•</label>
						<input type="text" class="form-control" id="sum_wo_type_nm" name="sum_wo_type_nm" readonly>
					</div>
					<div class="form-group">
						<label>ë³´ì „ìœ í˜•</label>
						<input type="text" class="form-control" id="sum_maint_type_nm" name="sum_maint_type_nm" readonly>
					</div>
					<div class="form-group">
						<label>ìš”ì²­ì</label>
						<input type="text" class="form-control" id="sum__creater_nm" name="sum__creater_nm" readonly>
					</div>
					<div class="form-group">
						<label>í¬ë§ì¼</label>
						<input type="text" class="form-control" id="sum_want_dt" name="sum_	want_dt" readonly>
					</div>
				</div>
			</div>
			<!-- íƒ­ ì„¹ì…˜ -->
			<div class="section">
				<div class="tab-group">
					<button class="tab-button" data-tab="reqInfo" style="background: #1e4f88; color: white; border-color: #1e4f88;">ìš”ì²­ì •ë³´</button>
					<button class="tab-button active" data-tab="workInfo">ì‘ì—…ë‚´ì—­(ì „ì²´)</button>
					<button class="tab-button" data-tab="logInfo">ë¡œê·¸</button>
				</div>
				<div class="tab-content">
					<!-- ê¸°ë³¸ì •ë³´ íƒ­ ì»¨í…ì¸  -->
					<div class="tab-pane" id="reqInfo" style="display: block; overflow-y:auto; height: 400px;">
						<div class="modal-table-header-line"></div>
						<table class="detail-table">
							<tr>
								<th width="120">ì‘ì—…ì œëª©</th>
								<td id="req_work_title" colspan="7"></td>
							</tr>
							<tr>
								<th>WO ë²ˆí˜¸</th>
								<td id="req_work_order_no" width="150"></td>
								<th width="120">PM ë²ˆí˜¸</th>
								<td id="req_pm_no" width="150"></td>
								<th width="120">ë³´ì „ìœ í˜•</th>
								<td id="req_maint_type_nm" width="150"></td>
								<th width="120">ì‘ì—…êµ¬ë¶„</th>
								<td id="req_wo_type_nm"></td>
							</tr>
							<tr>
								<th>í˜„ìƒ</th>
								<td id="req_problem_nm" colspan="3"></td>
								<th>í”„ë¡œì íŠ¸</th>
								<td id="req_proj_nm" colspan="3"></td>
							</tr>
							<tr>
								<th>ì„¤ë¹„</th>
								<td id="req_equip_cd_nm" colspan="5"></td>
								<th>ì„¤ë¹„ì¤‘ìš”ë„</th>
								<td id="req_import_rank_cd"></td>
							</tr>
							<tr>
								<th>ì¹´í…Œê³ ë¦¬</th>
								<td id="req_equip_category_desc"></td>
								<th>ìƒìœ„ì„¤ë¹„</th>
								<td id="req_loc_nm"></td>
								<th>ì„¤ë¹„ìœ„ì¹˜</th>
								<td id="req_up_loc_nm" colspan="3"></td>
							</tr>
						</table>
						<br />
						<div class="form-row">
							<div class="form-group">
								<label>ì‘ì—…ì§€ì¹¨</label>
								<textarea class="form-control" id="req_pm_work_text" name="req_pm_work_text" style="height:180px !important;"></textarea>
							</div>
						</div>
					</div>
					<!-- ì‘ì—… ì¸ë ¥/ìì¬ íƒ­ ì»¨í…ì¸  -->
					<form id="workResultForm">
						<input type="hidden" id="work_order_pk" name="work_order_pk" />
						<div class="tab-pane active" id="workInfo" style="display: block; overflow-y:auto; height: 400px;">
							<div class="form-row">
								<div class="form-group">
									<label>ì‘ì—…ë¶€ì„œ<span class="required">*</span></label>
									<input type="text" class="form-control" id="wo_dept_nm" name="wo_dept_nm">
								</div>
								<div class="form-group">
									<label>ì‘ì—…ë‹´ë‹¹ì<span class="required">*</span></label>
									<input type="text" class="form-control" id="wo_work_charger_nm" name="wo_work_charger_nm">
									<select id="wo_work_charger_sel" name="wo_work_charger_sel"></select>
								</div>
								<div class="form-group">
									<label>ì‘ì—…ê³„íšì¼<span class="required">*</span></label>
									<div class="date-range-input">
										<input type="text" class="form-control" id="wo_plan_dt" name="wo_plan_dt">
										<input type="date" id="wo_plan_start_dt" name="wo_plan_start_dt" />
										<span class="spandt" style="margin:0 5px;">~</span>
										<input type="date" id="wo_plan_end_dt" name="wo_plan_end_dt" />
									</div>
								</div>
								<div class="form-group">
									<label>ë³´ì „ìœ í˜•<span class="required">*</span></label>
									<input type="text" class="form-control" id="wo_maint_type_nm" name="wo_maint_type_nm">
								</div>
							</div>
							<div class="form-row">
								<div class="form-group">
									<label>í˜„ìƒ<span class="required">*</span></label>
									<input type="text" class="form-control" id="wo_problem_nm" name="wo_problem_nm">
									<select id="wo_problem_sel" name="wo_problem_sel"></select>
								</div>
								<div class="form-group">
									<label>ì›ì¸<span class="required">*</span></label>
									<input type="text" class="form-control" id="wo_cause_nm" name="wo_cause_nm">
									<select id="wo_cause_sel" name="wo_cause_sel"></select>
								</div>
								<div class="form-group">
									<label>ì¡°ì¹˜<span class="required">*</span></label>
									<input type="text" class="form-control" id="wo_remedy_nm" name="wo_remedy_nm">
									<select id="wo_remedy_sel" name="wo_remedy_sel"></select>
								</div>
								<div class="form-group">
									<label>í”„ë¡œì íŠ¸</label>
									<input type="text" class="form-control" id="wo_proj_nm" name="wo_proj_nm">
									<select id="wo_proj_sel" name="wo_proj_sel"></select>
								</div>
							</div>
							<div class="form-row">
								<div class="form-group">
									<label>ì‘ì—…êµ¬ë¶„<span class="required">*</span></label>
									<input type="text" class="form-control" id="wo_work_src_nm" name="wo_work_src_nm">
									<select id="wo_work_src_sel" name="wo_work_src_sel"></select>
								</div>
								<div class="form-group">
									<label>ì‘ì—…ê¸°ê°„(ì‹œì‘~ì¢…ë£Œ)<span class="required">*</span></label>
									<div class="date-range-input">
										<input type="text" class="form-control" id="wo_start_end_dt" name="wo_start_end_dt">
										<input type="date" id="wo_start_dt" name="wo_start_dt" />
										<span class="spandt" style="margin:0 5px;">~</span>
										<input type="date" id="wo_end_dt" name="wo_end_dt" />
									</div>
								</div>
								<div class="form-group">
									<label></label>
								</div>
							</div>
							<div class="form-row">
								<div class="form-group">
									<label>ì‘ì—…ë‚´ì—­</label>
									<textarea class="form-control" id="wo_work_text" name="wo_work_text"></textarea>
								</div>
							</div>
						</div>
					</form>
					<!-- PM WO ëª©ë¡ íƒ­ ì»¨í…ì¸  -->
					<div class="tab-pane" id="logInfo">						
						<div id="logInfoGrid"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- ë²„íŠ¼ ì˜ì—­ -->
		<div class="modal-footer">
			<button type="button" class="btn-save" id="btnWoSave">ì €ì¥</button>
			<button type="button" class="btn-close" id="closeWoModal">ë‹«ê¸°</button>
		</div>
	</div>
</div>

<style>
	.required {
		color: #e74c3c;
		margin-left: 3px;
	}

	.grid {
		width: 100%;
		margin-bottom: 20px;
	}

	/* íƒ­ ì˜ì—­ */
	.tab-group {
		display: flex;
		margin-bottom: 10px;
		border-bottom: 1px solid #1e4f88;
	}

	.tab-button {
		padding: 6px 20px;
		border: 1px solid #ccc;
		background: #f5f5f5;
		cursor: pointer;
		font-size: 12px;
	}

		.tab-button.active {
			background: #4682B4;
			color: white;
			border-color: #4682B4;
		}

	/* íƒ­ ì»¨í…ì¸  */
	.tab-content {
		min-height: 400px;
	}

	.tab-pane {
		display: none;
	}

		.tab-pane.active {
			display: block;
		}

	/* ëª¨ë‹¬ */
	#modalWoDetail {
		z-index: 1000;
	}

	.navigation-menu {
		display: flex;
		align-items: center;
		padding: 5px 10px;
		background-color: #f5f5f5;
		border: 1px solid #ddd;
	}

	.menu-item {
		padding: 2px 8px;
		font-size: 12px;
		color: #666;
	}

	.menu-item.active {
		font-weight: bold;
		color: #000;
	}

	.menu-item.pm-icon {
		background-color: #4CAF50;
		color: white;
		padding: 2px 8px;
		border-radius: 3px;
	}

	.menu-separator {
		color: #999;
		margin: 0 5px;
		font-size: 11px;
	}


	.detail-table {
		width: 100%;
		border-collapse: collapse;
		border: 1px solid #ddd;
	}

	.detail-table th,
	.detail-table td {
		border: 1px solid #ddd;
		padding: 5px 8px;
		font-size: 12px;
		height: 28px;
	}

	.detail-table th {
		background-color: #f5f5f5;
		font-weight: normal;
		text-align: left;
	}

	.equipment-section {
		margin-bottom: 20px;
	}

	/* date-range-input ìŠ¤íƒ€ì¼ */
	.date-range-input {
		display: flex;
		align-items: center;
		gap: 5px;
	}

</style>

<script type="text/javascript">
	class WorkOrder {
		constructor() {
			this.baseUrl = '/api/kmms/pm_master';
			this.init();
		}

		init() {
			let _this = this;
			const modal = $("#modalWoDetail");

			$("#logInfoGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: this.baseUrl,
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'read_work_order_hist',
									id: $('#work_order_pk').val()
								};
							}
						}
					},									
				}),
				height: 550,
				sortable: true,
				pageable: true,
				autoBind: false, // ìë™ ë°ì´í„° ë°”ì¸ë”© ë¹„í™œì„±í™”
				columns: [
					{ field: "work_order_hist_pk", title: "id", hidden: true },
					{ field: "after_status_nm", title: "ìƒíƒœ", width: 120 },
					{ field: "changer_nm", title: "ë‹´ë‹¹ì", width: 120,},
					{ field: "change_reason", title: "ë¹„ê³ ", width: 100 },
					{ field: "change_ts", title: "ì¼ì‹œ", width: 100 }
				],
				noRecords: {
					template: "ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
				}
			});

			// íƒ­ í´ë¦­ ì´ë²¤íŠ¸
			$('.tab-button').on('click', function () {
				const tabId = $(this).data('tab');
				$('.tab-button').removeClass('active').removeAttr('style');
				$('.tab-pane').removeClass('active').hide();
				$(this).addClass('active').css({
					'background': '#1e4f88',
					'color': 'white',
					'border-color': '#1e4f88'
				});
				if (tabId) $('#' + tabId).addClass('active').show();
				// ğŸ’¡ ì—¬ê¸°ì„œ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë°œìƒì‹œí‚´
				
				$(document).trigger(tabId);  // e.g. 'reqInfo', 'workInfo', 'logInfo'
				$("#tabId").val(tabId);
			});

			$("#btnWoSave").kendoButton({
				icon: "k-i-save",
				click: function (e) {
					e.preventDefault();
					_this.saveData();
				}
			})

			// ëª¨ë‹¬ ë‹«ê¸°
			$('#closeWoModal').kendoButton({
				click: () => modal.fadeOut()
			});		

			// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) modal.fadeOut();
			});
			
		}

		// ì‘ì—… ê²°ê³¼ ì €ì¥
		saveData() {
			let _this = this;
			let data = FormUtil.extractForm($('#workResultForm'));
			data.WorkCharger = $("#wo_work_charger_sel").val();
	

			// ìœ íš¨ì„± ê²€ì‚¬
			if (!$('#wo_work_charger_sel').val()) {
				Alert.alert('', 'ì‘ì—…ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}

			let funcSucc = function (resp) {
				if (resp.success) {
					// ê¸°ë³¸ ì •ë³´ ì €ì¥ ì„±ê³µ ì‹œ ì‘ì—… ì¸ë ¥ ì €ì¥ ì§„í–‰
					
				} else {
					Alert.alert('error', resp.message);
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save_work_order', data, funcSucc);
			$("#modalWoDetail").fadeOut();
		}

		//ì‘ì—… ê²°ê³¼
		getWorkOrderData(work_order_pk, idx) {			
			let _this = this;
			
			// work_order_pk ì„¤ì •
			$('#work_order_pk').val(work_order_pk);

			// ì„¤ë¹„ ìƒì„¸ ì •ë³´ API í˜¸ì¶œ
			let param = {
				action: 'read_work_order_summary',
				id: work_order_pk,
			};
			let woSummaryData = AjaxUtil.getSyncData(_this.baseUrl, param);
			console.log(woSummaryData);
		
			// 1.1. summary ë°ì´í„°
			this.bindWoSummaryData(woSummaryData);

			// TODO: ìš”ì²­ì •ë³´ ë°ì´í„° ë°”ì¸ë”©
			this.getWoRequestData(woSummaryData);

			// TODO: ì‘ì—…ë‚´ì—­ ë°ì´í„° ë°”ì¸ë”©
			this.getWoInfoData(woSummaryData);

			if (woSummaryData) {
				$("#modalWoDetail").fadeIn();
				
				// ì‘ì—…ë‚´ì—­ íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ í™œì„±í™”
				switch (idx) {
					case 1:
						$("#tabId").val('reqInfo');						
						$('#workInfo input, #workInfo textarea').prop('readonly', true);
						break;
					case 2:
						$("#tabId").val('workInfo');
						// workInfo íƒ­ì˜ ëª¨ë“  inputì˜ readonly ì†ì„± ì œê±°
						$('#workInfo input, #workInfo textarea').prop('readonly', false);
						// ì‘ì—…ë¶€ì„œì™€ ë³´ì „ìœ í˜•ë§Œ readonlyë¡œ ì„¤ì •
						$('#wo_dept_nm, #wo_maint_type_nm').prop('readonly', true);
						break;
					default:
						$("#tabId").val('logInfo');
						break;
				}	

				this.activateTab($("#tabId").val(), woSummaryData);

				// ê·¸ë¦¬ë“œ ë°ì´í„° ë¦¬í”„ë ˆì‹œ
				$("#logInfoGrid").data("kendoGrid").dataSource.read();
			}
		}

		// íƒ­ í™œì„±í™” ë©”ì„œë“œ
		activateTab(tabId, data) {
			$('.tab-button').removeClass('active').removeAttr('style');
			$('.tab-pane').removeClass('active').hide();			
			$(`.tab-button[data-tab="${tabId}"]`).addClass('active').css({
				'background': '#1e4f88',
				'color': 'white',
				'border-color': '#1e4f88'
			});
			$(`#${tabId}`).addClass('active').show();
			
			// ì‘ì—…ë‹´ë‹¹ì í•„ë“œ ì „í™˜
			if (tabId === 'reqInfo') {
				$('#wo_work_charger_nm').show();
				$('#wo_plan_dt').show();	
				$('#wo_work_charger_sel').css("display", "none"); // â† ì´ ë¶€ë¶„ ì¶”ê°€!	
				
				$('.spandt').css("display", "none");
				$('#wo_plan_start_dt,#wo_plan_end_dt,#wo_start_dt,#wo_end_dt').css({
					'position': 'absolute',
					'left': '-9999px'
				});

				$('#wo_problem_sel').css("display", "none");
				$('#wo_cause_sel').css("display", "none");
				$('#wo_remedy_sel').css("display", "none");
				$('#wo_proj_sel').css("display", "none");	
				$('#wo_work_src_sel').css("display", "none");				

			} else if (tabId === 'workInfo') {
				// ê¸°ì¡´ ì˜µì…˜ ì œê±°
				$('#wo_work_charger_sel').empty(); 
				$('#wo_work_src_sel').empty();
				

				$('#wo_plan_dt,#wo_start_end_dt, #wo_work_charger_nm,#wo_problem_nm,#wo_cause_nm,#wo_remedy_nm,#wo_proj_nm,#wo_work_src_nm').css({
					'position': 'absolute',
					'left': '-9999px'
				});

				AjaxUtil.fillDropDownOptions($('#wo_work_charger_sel'), 'auth_user', 'choose', data.work_charger_pk);

				//ìœ„ì¹˜ì›ìƒë³µêµ¬
				$('#wo_plan_start_dt,#wo_plan_end_dt,#wo_start_dt,#wo_end_dt').css({
					position: '',
					left: ''
				});

				$("#wo_plan_start_dt").kendoDatePicker({
					value: data.plan_start_dt,
					format: "yyyy-MM-dd",
				});

				$("#wo_plan_end_dt").kendoDatePicker({
					value: data.plan_end_dt,
					format: "yyyy-MM-dd",
				});

				AjaxUtil.fillDropDownOptions($('#wo_problem_sel'), 'user_code', 'choose', data.problem_cd, 'PC');
				AjaxUtil.fillDropDownOptions($('#wo_cause_sel'), 'user_code', 'choose', data.cause_cd, 'CC');
				AjaxUtil.fillDropDownOptions($('#wo_remedy_sel'), 'user_code', 'choose', data.remedy_cd, 'RC');

				AjaxUtil.fillDropDownOptions($('#wo_proj_sel'), 'project', 'choose', null);
				AjaxUtil.fillDropDownOptions($('#wo_work_src_sel'), 'user_code', 'choose', data.work_src_cd, 'WORK_SRC');

				$("#wo_start_dt").kendoDatePicker({
					value: data.start_dt,
					format: "yyyy-MM-dd",
				});

				$("#wo_end_dt").kendoDatePicker({
					value: data.end_dt,
					format: "yyyy-MM-dd",
				});

			}
		}

		bindWoSummaryData(data) {
			
			 //ê¸°ë³¸ í•„ë“œ ë°”ì¸ë”©
			const basicFields = {
				'work_order_pk': data.work_order_pk,
				'sum_work_title': data.work_title,
				'wo_status_nm': data.wo_status_nm,
				'sum_wo_type_nm': data.wo_type_nm,				
				'sum_maint_type_nm': data.maint_type_nm,
				'sum__creater_nm': data._creater_nm,
				'sum_want_dt': data.want_dt,
			};
			
			// ê¸°ë³¸ í•„ë“œ ê°’ ì„¤ì •
			Object.entries(basicFields).forEach(([id, value]) => {
				$(`#${id}`).val(value);
			});

			// ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ í™œì„±í™” ìƒíƒœ ì´ˆê¸°í™”
			$('.navigation-menu .menu-item').removeClass('active');

			// ì‘ì—… ìƒíƒœì— ë”°ë¥¸ ë©”ë‰´ í™œì„±í™”
			const menuMap = {
				'ì‘ì—…ìš”ì²­': 'ì‘ì—…ìš”ì²­',
				'ìš”ì²­ìŠ¹ì¸': 'ìš”ì²­ìŠ¹ì¸',
				'ì‘ì—…ìŠ¹ì¸': 'ì‘ì—…ìŠ¹ì¸',
				'ì‘ì—…ì™„ë£Œ': 'ì‘ì—…ì™„ë£Œ',
				'WOì™„ë£Œ': 'WO ì™„ë£Œ'
			};

			if (menuMap[data.wo_status_nm]) {
				$(`.navigation-menu .menu-item:contains('${menuMap[data.wo_status_nm]}')`).addClass('active');
			}
		}
		// ìš”ì²­ì •ë³´ ë°ì´í„° ë°”ì¸ë”©
		getWoRequestData(data) {
		
			//ê¸°ë³¸ í•„ë“œ ë°”ì¸ë”©
			const reqFields = {
				'work_order_pk': data.work_order_pk,
				'req_work_title': data.work_title,
				'req_work_order_no': data.work_order_no,
				'req_pm_no': data.pm_no,
				'req_maint_type_nm': data.maint_type_nm,
				'req_wo_type_nm': data.wo_type_nm,
				'req_problem_nm': data.problem_nm,
				'req_proj_nm': data.proj_nm,
				'req_equip_cd_nm': '[' + data.equip_cd + '] ' + data.equip_nm,
				'req_import_rank_cd': data.import_rank_cd,
				'req_equip_category_desc': data.equip_category_desc,
				'req_loc_nm': data.loc_nm,
				'req_up_loc_nm': data.up_loc_nm,
				'req_pm_work_text': data.pm_work_text,
			};

			// ê¸°ë³¸ í•„ë“œ ê°’ ì„¤ì •
			Object.entries(reqFields).forEach(([id, value]) => {				
				$(`#${id}`).text(value);
			});
		}
		// ì‘ì—…ë‚´ì—­ ë°ì´í„° ë°”ì¸ë”©
		getWoInfoData(data) {
			
			//ê¸°ë³¸ í•„ë“œ ë°”ì¸ë”©
			const reqFields = {
				'work_order_pk': data.work_order_pk,
				'wo_dept_nm': data.dept_nm,
				'wo_work_charger_nm': data.work_charger_nm,						
				'wo_plan_dt': data.plan_start_dt + ' ~ ' + data.plan_end_dt,
				'wo_maint_type_nm': data.maint_type_nm,
				'wo_problem_nm': data.problem_nm,
				'wo_cause_nm': data.cause_nm,
				'wo_remedy_nm': data.remedy_nm,
				'wo_proj_nm': data.proj_nm,
				'wo_work_src_nm': data.work_src_nm,
				'wo_start_end_dt': data.start_dt + ' ~ ' + data.end_dt,
				'wo_work_text': data.work_text,
			};

			// ê¸°ë³¸ í•„ë“œ ê°’ ì„¤ì •
			Object.entries(reqFields).forEach(([id, value]) => {
				$(`#${id}`).val(value);
			});		

		}
	}

	woDetailPage = new WorkOrder();

</script>