<div id="modalMyWorkApprInfo" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h4>작업지시 승인</h4>
		</div>
		<div class="modal-body">
			<!-- 결재 라인 -->
			<div id="woApprovalLineContainer_MyWorkAppr">
				<div class="navigation-approval-line" id="woApprovalLine_MyWorkAppr" style="display:none;">
					<!-- WoApprovalLine.html 상단에 삽입 -->
					<input type="hidden" id="dataPk_MyWorkAppr" value="{{ dataPk }}">
					<span class="approval-item pm-icon" id="woTypeDisplay_MyWorkAppr">작업</span>
					<span class="approval-separator">>></span>
					<div id="statusMenuItems_MyWorkAppr">
						<!-- 기본 메뉴 아이템들 -->
					</div>
				</div>
			</div>
			<div class="top-section">
				<div class="modal-table-header-line"></div>
				<table class="detail-table">
					<tr>
						<th width="150">요청부서</th>
						<td id="req_dept_nm" width="150"></td>
						<th width="150">요청자</th>
						<td id="req_user_nm" width="150"></td>
						<th width="150">요청일</th>
						<td id="req_date" width="150"></td>
						<th width="150">희망일</th>
						<td id="req_want_dt" width="150"></td>
					</tr>
					<tr>
						<th>요청사항 </th>
						<td id="appr_req_info" colspan="7">요청사항이 있습니다. 왼쪽 버튼을 눌러 확인하세요.</td>
					</tr>
					<tr>
						<th>WO 번호</th>
						<td id="appr_work_order_no" width="150"></td>
						<th>설비</th>
						<td id="appr_equip_cd_nm" colspan="3"></td>
						<th>보증만료일</th>
						<td id="appr_warranty_dt" width="150"></td>
					</tr>
					<tr>
						<th>작업제목 </th>
						<td id="appr_wo_work_title" colspan="7"></td>
					</tr>
					<tr>
						<th width="120">보전유형</th>
						<td id="appr_maint_type_nm" width="100"></td>
						<th>계획기간</th>
						<td id="appr_plan_period" colspan="3"></td>
						<th>고장일시</th>
						<td id="appr_breakdown_dt" width="100"></td>
					</tr>
				</table>
			</div>
			<form id="wo_req_form" name="wo_req_form">
				<!-- 가이드라인 섹션 -->
				<div class="top-section">
					<div class="form-row">
						<div class="form-group col-md-4">
							<label for="wo_work_dept_pk" class="required">작업부서</label>
							<select id="wo_work_dept_pk" name="dept_pk" data-msg="작업부서를"></select>
						</div>
						<div class="form-group col-md-4">
							<label for="wo_work_charger_pk" class="required">작업담당자</label>
							<select id="wo_work_charger_pk" name="work_charger_pk" data-msg="작업담당자를">
								<option value="">작업담당자를 선택하세요</option>
							</select>
						</div>
						<div class="form-group second-group col-md-4">
							<label for="appr_wo_maint_type_cd" class="required">보전유형</label>
							<select id="appr_wo_maint_type_cd" name="appr_wo_maint_type_cd" data-msg="보전유형을"></select>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-12 col-md-3">
							<label for="woPostProblem" data-labelCd="현상 *"></label>
							<button type="button" class="plusbutton" id="addProblem" name="addProblem"></button>
							<select id="woPostProblem" name="woPostProblem" data-msg="현상을"></select>
						</div>
						<div class="form-group col-12 col-md-3">
							<label for="cause_cd_post" data-labelCd="원인 *"></label>
							<button type="button" class="plusbutton" id="addCause" name="addCause"></button>
							<select id="cause_cd_post" name="cause_cd_post" data-msg="원인을"></select>
						</div>
						<div class="form-group col-12 col-md-3">
							<label for="selectRemedy" data-labelCd="조치 *"></label>
							<button type="button" class="plusbutton" id="addRemedy" name="addRemedy"></button>
							<select id="selectRemedy" name="selectRemedy" data-msg="조치를"></select>
						</div>
						<div class="form-group col-12 col-md-3">
							<label>프로젝트</label>
							<button type="button" class="plusbutton" id="selectProject" name="selectProject"></button>
							<select id="projectName" name="proj_cd"></select>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group col-12 col-md-3">
							<label>작업구분</label>
							<select id="wcType" name="work_src_cd"></select>
						</div>

						<div class="form-group col-12 col-md-6">
							<label class="required">작업계획일</label>
							<div style="display: flex; align-items: center; gap: 5px;">
								<div class="field-wrapper">
									<input type="date" id="sDayWorkPost" name="sDayWorkPost" data-msg="작업계획일을" style="flex: 1;">
								</div>
								<span>~</span>
								<div class="field-wrapper">
									<input type="date" id="eDayWorkPost" name="eDayWorkPost" data-msg="작업계획일을" style="flex: 1;">
								</div>
							</div>
						</div>
						<div class="form-group col-12 col-md-3">
							<label class="required" for="breakDownDate">고장일시</label>
							<div class="field-wrapper">
								<input type="datetime" id="breakDownDate" name="breakDownDate" data-msg="고장일시를"></input>
							</div>
						</div>
					</div>
				</div>
			</form>

			<!-- 외주업체 컨텐츠 -->
			<div class="grid-content">
				<div class="grid-header" style="display: flex; align-items: center; gap: 8px; justify-content: flex-start;">
					<label data-labelCd="외주업체" style="margin: 0; min-width: 80px;">외주업체</label>
					<select id="selectExSupplier" name="selectExSupplier" style="margin: 0; width: 250px;"></select>
				</div>
				<div id="woExSupplierGrid"></div>
			</div>

			<!-- 작업 인력/자재 컨텐츠 -->
			<div class="grid-content">
				<div class="grid-header" style="display: flex; align-items: center; gap: 8px; justify-content: flex-start;">
					<label data-labelCd="작업인력 또는 직종" style="margin: 0; min-width: 80px;"></label>
					<select id="selJobClass" name="selJobClass" style="margin: 0; width: 250px;">
						<option value="">직종을 선택하세요</option>
					</select>
					<div style="flex:1;"></div>
					<div style="text-align: right;">
						<button class="btn-save" id="setMeAsWork" name="setMeAsWork">나를 작업자로</button>
						<button class="btn-save" id="selWoLabor" name="selWoLabor">작업인력 선택</button>
					</div>
				</div>
				<div id="woLaborGrid"></div>
			</div>

			<!-- 파일 탭 컨텐츠 -->
			<div id="fileTab">
				{% include 'components/FileUpload.html' with tableName='cm_work_order' attachName='file' dataPk=cm_work_order.work_order_pk|default:'' %}
			</div>
		</div>
		<!-- 버튼 영역 -->
		<div class="modal-footer">
			<button type="button" id="btnRejectApprInfo">요청반려</button>
			<button type="button" class="btn-save" id="btnApprovalApprInfo">승인</button>
			<button type="button" class="btn-save" id="btnSave">저장</button>
			<button type="button" class="btn-close" id="btnCloseApprInfo">닫기</button>
		</div>
	</div>
</div>

<!-- 반려 Kendo Window 팝업 -->
<div id="woRejectWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="modal-body">
		<form id="rejectReasonForm">
			<div class="form-row">
				<div class="form-group col-12">
					<label for="reject_reason" class="required">반려사유</label>
					<textarea class="form-control" id="reject_reason" name="reject_reason" placeholder="4000자 이하로 입력하세요" rows="6" style="resize: vertical;"></textarea>
					<div class="char-counter" style="text-align: right; margin-top: 5px; color: #666;">
						<span id="charCount">0</span> / 4000 bytes
					</div>
				</div>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-save" id="btnRejectReq">반려</button>
		<button type="button" class="btn-close" id="btnCloseReject">닫기</button>
	</div>
</div>

<!-- 현상 Kendo Window 팝업 -->
<div id="reliabCodesWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="reliabForm">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label for="reliab_cd" class="required">현상코드</label>
					<input type="text" class="form-control" id="reliab_cd" name="reliabCd" placeholder="25자 이하로 입력하세요">
				</div>
				<div class="form-group col-md-6">
					<label for="reliab_nm" class="required">현상코드명</label>
					<input type="text" class="form-control" id="reliab_nm" name="reliabNm" placeholder="50자 이하로 입력하세요">
				</div>
			</div>
		</form>
	</div>
	<div class="grid-section">
		<h5>최근 등록된 현상코드</h5>
		<div id="reliabCodesGrid"></div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveReliabCodes">저장</button>
		<button type="button" class="btn-close" id="btnCloseReliabCodes">닫기</button>
	</div>
</div>

<!-- 원인 Kendo Window 팝업 -->
<div id="reliabCodesWindowCC" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="reliabFormCC">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label for="reliab_cd_cc" class="required">원인코드</label>
					<input type="text" class="form-control" id="reliab_cd_cc" name="reliabCd" placeholder="25자 이하로 입력하세요">
				</div>
				<div class="form-group col-md-6">
					<label for="reliab_nm_cc" class="required">원인코드명</label>
					<input type="text" class="form-control" id="reliab_nm_cc" name="reliabNm" placeholder="50자 이하로 입력하세요">
				</div>
			</div>
		</form>
	</div>
	<div class="grid-section">
		<h5>최근 등록된 원인코드</h5>
		<div id="reliabCodesGridCC"></div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveReliabCodesCC">저장</button>
		<button type="button" class="btn-close" id="btnCloseReliabCodesCC">닫기</button>
	</div>
</div>

<!-- 조치 Kendo Window 팝업 -->
<div id="reliabCodesWindowRC" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui">
		<form id="reliabFormRC">
			<div class="form-row">
				<div class="form-group col-md-6">
					<label for="reliab_cd_rc" class="required">조치코드</label>
					<input type="text" class="form-control" id="reliab_cd_rc" name="reliabCd" placeholder="25자 이하로 입력하세요">
				</div>
				<div class="form-group col-md-6">
					<label for="reliab_nm_rc" class="required">조치코드명</label>
					<input type="text" class="form-control" id="reliab_nm_rc" name="reliabNm" placeholder="50자 이하로 입력하세요">
				</div>
			</div>
		</form>
	</div>
	<div class="grid-section">
		<h5>최근 등록된 조치코드</h5>
		<div id="reliabCodesGridRC"></div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveReliabCodesRC">저장</button>
		<button type="button" class="btn-close" id="btnCloseReliabCodesRC">닫기</button>
	</div>
</div>

<!-- 프로젝트 Kendo Window 팝업 -->
<div id="cmProjectWindow" class="dynamic-window" style="display:none; overflow: visible; height: auto; max-height: none;">
	<div class="form-ui" style="height: 60px;">
		<form id="cmProjectForm">
			<div class="form-row">
				<div class="form-group col-md-3">
					<label for="proj_cd" class="required">프로젝트</label>
					<input type="text" class="form-control" id="proj_cd" name="proj_cd" placeholder="25자 이하로 입력하세요">
				</div>
				<div class="form-group col-md-3">
					<label for="proj_nm" class="required">프로젝트명</label>
					<input type="text" class="form-control" id="proj_nm" name="proj_nm" placeholder="50자 이하로 입력하세요">
				</div>
			</div>
			<div class="form-row">
				<label for="proj_cd" class="required">계획 시작일 / 마침일</label>
				<div class="form-group col-md-6" style="display: flex; align-items: center;">
					<input type="date" id="plan_start_dt" name="plan_start_dt" style="flex:1;" />
					<span style="margin: 0 8px;">~</span>
					<input type="date" id="plan_end_dt" name="plan_end_dt" style="flex:1;" />
				</div>
			</div>
		</form>
	</div>
	<div class="grid-section">
		<h5>최근 등록된 프로젝트</h5>
		<div id="cmProjectGrid"></div>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn-close" id="btnSaveProject">저장</button>
		<button type="button" class="btn-close" id="btnCloseProject">닫기</button>
	</div>
</div>

<style>

	.modal-body {
		overflow-y: auto;
	}

	/* section-header 스타일 추가 */
	.section-header {
		margin-bottom: 15px;
		padding: 10px 0;
		border-bottom: 1px solid #eee;
	}

	/* woApprovalLineContainer 스타일 추가 */
	#woApprovalLineContainer {
		display: block !important;
		margin-bottom: 10px;
	}

	/* WoApprovalLine이 보이도록 강제 설정 */
	#woApprovalLine {
		display: block !important;
		visibility: visible !important;
		opacity: 1 !important;
		position: relative !important;
		z-index: 1002 !important;
		width: 100% !important;
		height: auto !important;
		min-height: 30px !important;
		background-color: #f5f5f5 !important;
		border: 1px solid #ccc !important;
		border-radius: 4px !important;
		padding: 5px 10px !important;
		margin: 5px 0 !important;
	}

	/* navigation-approval-line 스타일 강제 적용 */
	.navigation-approval-line {
		display: inline-flex !important;
		align-items: center !important;
		padding: 5px 10px !important;
		background-color: #f5f5f5 !important;
		border: 1px solid #ddd !important;
		border-radius: 4px !important;
		width: 100% !important;
		max-width: 100% !important;
		overflow-x: auto !important;
		position: relative !important;
		z-index: 1003 !important;
	}

	/* approval-item 스타일 강제 적용 */
	.approval-item {
		padding: 2px 8px !important;
		font-size: 12px !important;
		color: #666 !important;
		white-space: nowrap !important;
		flex-shrink: 0 !important;
		display: inline-block !important;
		position: relative !important;
		z-index: 1004 !important;
	}

		/* active 클래스 스타일 강제 적용 */
		.approval-item.active {
			font-weight: bold !important;
			color: white !important;
			background-color: #007bff !important;
			border-radius: 3px !important;
			padding: 2px 8px !important;
			box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
			border: 1px solid #0056b3 !important;
		}

	/* approval-separator 스타일 강제 적용 */
	.approval-separator {
		color: #999 !important;
		margin: 0 5px !important;
		font-size: 11px !important;
		flex-shrink: 0 !important;
		white-space: nowrap !important;
		display: inline-block !important;
	}
</style>

<script type="text/javascript">
	let myWorkApprInfoPage = null;
	class MyWorkApprInfo {
		constructor() {
			this.baseUrl = '/api/kmms/work_order';
			this.workOrderPk = null; // 작업지시 PK
			this.editable = false;

			this.reliabGrid = null;
			this.projectGrid = null;
			this.woCopyGrid = null;
			this.selectedRow_wo = null;

			this.init();
		}

		// 부모 페이지 새로고침 함수
		refreshParentPage() {
			try {
				// 1. page 객체가 존재하는 경우
				if (typeof page !== 'undefined' && page.searchMainData) {
					page.searchMainData();
				}
				// 2. window.opener가 존재하는 경우 (팝업에서 열린 경우)
				else if (window.opener && typeof window.opener.page !== 'undefined' && window.opener.page.searchMainData) {
					window.opener.page.searchMainData();
				}
				// 3. 부모 프레임이 존재하는 경우
				else if (window.parent && window.parent !== window && typeof window.parent.page !== 'undefined' && window.parent.page.searchMainData) {
					window.parent.page.searchMainData();
				}
				// 4. 페이지 새로고침
				else {
					location.reload();
				}
			} catch (error) {
				console.warn('부모 페이지 새로고침 실패:', error);
				// 최후의 수단으로 페이지 새로고침
				location.reload();
			}
		}

		init() {
			let _this = this;
			const modal = $("#modalMyWorkApprInfo");

			$("#btnSaveReliabCodes").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#reliabForm"));

					formData.types = 'PC'; // 현상코드 타입 지정
					formData.useYn = 'Y'; // 사용 여부 기본값 Y

					if (!formData.reliabCd || !formData.reliabNm) {
						Alert.alert('', '현상코드와 현상코드명을 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#reliabForm"));
							_this.refreshReliabGrid();
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/reliab_code' + '?action=insert', formData, fnSuccess);
				}
			});

			$("#btnCloseReliabCodes").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#woProblem'), 'cm_reliab_codes', 'choose', null, 'PC');
					$("#reliabCodesWindow").data("kendoWindow").close();
				}
			});

			$("#woExSupplierGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: '/api/kmms/pm_master',
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'read_work_order_supplier',
									id: _this.workOrderPk
								};
							}
						}
					}
				}),
				height: 100,
				sortable: true,
				autoBind: false,
				editable: { confirmation: false },
				columns: [
					{ field: "id", title: "id", hidden: true },
					{ field: "ex_supplier_nm", title: "외주업체명", width: 400 },
					{
						field: "cost",
						title: "비용",
						width: 400,
						editor: currencyEditor,
						template: function (dataItem) {
							if (dataItem.cost == null || dataItem.cost === "") return "";
							var cost = Number(dataItem.cost);
							if (isNaN(cost)) return dataItem.cost;
							return "₩ " + kendo.toString(cost, "n0");
						},
						attributes: { style: "text-align: right;" },
					},
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#woExSupplierGrid").data("kendoGrid");
								grid.removeRow(tr);
							}
						},
						title: "삭제",
						width: 50
					}
				],
				noRecords: true,
				messages: {
					noRecords: "조회된 데이터가 없습니다."
				},
				dataBound: function (e) {
					const count = this.dataSource.total();
					$("#woSupplierCount").text(`(Count: ${count})`);
				},		
			});

			$("#woLaborGrid").kendoGrid({
				dataSource: new kendo.data.DataSource({
					transport: {
						read: {
							url: '/api/kmms/pm_master',
							dataType: "json",
							contentType: "application/json",
							data: function () {
								return {
									action: 'read_work_order_manpower',
									id: _this.workOrderPk
								};
							}
						}
					}
				}),
				height: 100,
				sortable: true,
				autoBind: false,
				editable: { confirmation: false },
				columns: [
					{ field: "job_class_nm", title: "작업자/직종", width: "20%", editable: false },
					{
						field: "labor_price",
						title: "노임단가(시급)",
						width: "20%",
						editor: currencyEditor,
						template: function (dataItem) {
							if (dataItem.labor_price == null || dataItem.labor_price === "") return "";
							var cost = Number(dataItem.labor_price);
							if (isNaN(cost)) return dataItem.labor_price;
							return "₩ " + kendo.toString(cost, "n0");
						},
						attributes: { style: "text-align: right;" },
					},
					{
						field: "worker_nos",
						title: "인원수",
						width: "25%",
						editor: function (container, options) {
							if (options.model.isJobClassRow) {
								numberOnlyEditor(container, options);
							} else {
								$('<input name="' + options.field + '" type="number" class="k-input k-textbox" style="text-align:right; width:100%;" readonly value="1" />').appendTo(container);
							}
						}
					},
					{ field: "work_hr", title: "예상작업시간", width: "15%", attributes: { style: "text-align: right;" }, editor: numberOnlyEditor },
					{ field: "real_work_hr", title: "실제작업시간", width: "15%", attributes: { style: "text-align: right;" }, editor: numberOnlyEditor },
					{
						command: {
							text: "삭제",
							click: function (e) {
								e.preventDefault();
								var tr = $(e.target).closest("tr");
								var grid = $("#woLaborGrid").data("kendoGrid");
								grid.removeRow(tr);
							}
						},
						title: "삭제",
						width: "10%"
					}
				],
				noRecords: true,
				messages: {
					noRecords: "조회된 데이터가 없습니다."
				},
			});

			// 데이터 로드 함수
			this.loadPmData = function (pmPk) {
				let param = {
					action: 'read',
					pm_pk: pmPk
				};

				let result = AjaxUtil.getSyncData(this.baseUrl, param);

			};

			AjaxUtil.fillDropDownOptions($('#appr_wo_maint_type_cd'), 'cm_code', 'all', null, 'MAINT_TYPE');
			AjaxUtil.fillDropDownOptions($('#woPostProblem'), 'cm_reliab_codes', 'choose', null, 'PC');
			AjaxUtil.fillDropDownOptions($('#cause_cd_post'), 'cm_reliab_codes', 'choose', null, 'CC');
			AjaxUtil.fillDropDownOptions($('#selectRemedy'), 'cm_reliab_codes', 'choose', null, 'RC');
			AjaxUtil.fillDropDownTreeOptions($("#wo_work_dept_pk"), "depart", "select");
			AjaxUtil.fillDropDownOptions($('#wo_work_charger_pk'), 'cm_user_info', 'choose', null);
			AjaxUtil.fillDropDownOptions($('#cycleType'), 'cm_code', 'choose', null, 'CYCLE_TYPE');
			AjaxUtil.fillDropDownOptions($('#woProblem'), 'cm_reliab_codes', 'choose', null, 'PC');
			AjaxUtil.fillDropDownOptions($('#wcType'), 'cm_code', 'choose', 'WS01', 'WS_TYPE');
			AjaxUtil.fillDropDownOptions($('#projectName'), 'cm_project', 'choose', null, null);

			AjaxUtil.fillDropDownOptions($('#selectExSupplier'), 'cm_ex_supplier', 'choose', null, null);
			AjaxUtil.fillDropDownOptions($('#selJobClass'), 'cm_job_class', 'choose', null);

			let today = CommonUtil.getYYYYMMDD();
			$("#want_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd",
			});

			$("#breakdown_dt").kendoDateTimePicker({
				value: today,
				format: "yyyy-MM-dd HH:mm:ss"
			});

			$("#plan_start_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd",
			});

			$("#plan_end_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd"
			});

			$("#sDayWorkPost").kendoDatePicker({
				format: "yyyy-MM-dd",
			});

			$("#eDayWorkPost").kendoDatePicker({
				format: "yyyy-MM-dd"
			});

			$("#start_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd",
			});

			$("#end_dt").kendoDatePicker({
				value: today,
				format: "yyyy-MM-dd"
			});

			$("#breakDownDate").kendoDateTimePicker({
				value: today,
				format: "yyyy-MM-dd HH:mm"
			});

			$('#selectEquipment').kendoButton({
				themeColor: "base",
				icon: "k-i-zoom-in", // 줌인 아이콘
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalEqu', { width: '70%', height: '70%' });
					equipSelectPage.show(function (data) {
						// 선택된 설비 데이터 처리
						$("#wo_equ_pk").val(data.equip_pk);
						$("#wo_equ_name").val(data.equip_nm);
						$("#wo_loc_pk").val(data.loc_pk);
						$("#wo_loc_nm").val(data.loc_nm);
						$("#wo_warranty_dt").val(data.warranty_dt == undefined ? '보증만료일 없음' : data.warranty_dt);
					});
				}
			});

			$('#addProblem').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '현상코드 등록',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '50vw',
					}
					popupComn.openTempPopup($("#reliabCodesWindow"), options);
					_this.refreshReliabGrid();
				}
			});

			$('#addCause').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '원인코드 등록',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '50vw',
					}
					popupComn.openTempPopup($("#reliabCodesWindowCC"), options);
					_this.refreshReliabGridCC();
				}
			});

			$('#addRemedy').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '조치코드 등록',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '50vw',
					}
					popupComn.openTempPopup($("#reliabCodesWindowRC"), options);
					_this.refreshReliabGridRC();
				}
			});

			$('#selectProject').kendoButton({
				themeColor: "base",
				icon: "k-i-plus",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '프로젝트 등록',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '50vw',
					}
					popupComn.openTempPopup($("#cmProjectWindow"), options);
					_this.refreshProjectGrid();
				}
			});

			$('#btnSearchWoCopy').kendoButton({
				themeColor: "base",
				icon: "k-i-search",
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					_this.refreshWoCopyGrid();
				}
			});

			$("#btnSaveReliabCodes").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#reliabForm"));

					formData.types = 'PC'; // 현상코드 타입 지정
					formData.useYn = 'Y'; // 사용 여부 기본값 Y

					if (!formData.reliabCd || !formData.reliabNm) {
						Alert.alert('', '현상코드와 현상코드명을 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#reliabForm"));
							_this.refreshReliabGrid();
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/reliab_code' + '?action=insert', formData, fnSuccess);
				}
			});

			$("#btnCloseReliabCodes").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#woPostProblem'), 'cm_reliab_codes', 'choose', null, 'PC');
					$("#reliabCodesWindow").data("kendoWindow").close();
				}
			});

			$("#btnSaveReliabCodesCC").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#reliabFormCC"));

					formData.types = 'CC'; // 현상코드 타입 지정
					formData.useYn = 'Y'; // 사용 여부 기본값 Y

					if (!formData.reliabCd || !formData.reliabNm) {
						Alert.alert('', '원인코드와 원인코드명을 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#reliabFormCC"));
							_this.refreshReliabGridCC();
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/reliab_code' + '?action=insert', formData, fnSuccess);
				}
			});

			$("#btnCloseReliabCodesCC").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#cause_cd_post'), 'cm_reliab_codes', 'choose', null, 'CC');
					$("#reliabCodesWindowCC").data("kendoWindow").close();
				}
			});

			$("#btnSaveReliabCodesRC").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#reliabFormRC"));

					formData.types = 'RC'; // 현상코드 타입 지정
					formData.useYn = 'Y'; // 사용 여부 기본값 Y

					if (!formData.reliabCd || !formData.reliabNm) {
						Alert.alert('', '조치코드와 조치코드명을 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#reliabFormRC"));
							_this.refreshReliabGridRC();
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/reliab_code' + '?action=insert', formData, fnSuccess);
				}
			});

			$("#btnCloseReliabCodesRC").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#selectRemedy'), 'cm_reliab_codes', 'choose', null, 'RC');
					$("#reliabCodesWindowRC").data("kendoWindow").close();
				}
			});

			$("#btnSaveReliabCodesFC").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					// 폼 데이터 추출
					let formData = FormUtil.extractForm($("#reliabFormFC"));
					// 필수값 체크
					if (!formData.selectReliabFc) {
						Alert.alert('', '고장부위를 선택하세요.');
						return;
					}
					if (!formData.selectReliabCc) {
						Alert.alert('', '원인을 선택하세요.');
						return;
					}
					if (!formData.reliab_desc_fc) {
						Alert.alert('', '고장설명을 입력하세요.');
						return;
					}
					// 그리드에 데이터 추가
					var grid = $("#breakdownPointGrid").data("kendoGrid");
					if (grid) {
						grid.dataSource.add({
							breakdown_code: formData.selectReliabFc, // 실제 코드/명칭 매핑 필요시 수정
							breakdown_name: $("#selectReliabFc option:selected").text(),
							cause: $("#selectReliabCc option:selected").text(),
							desc: formData.reliab_desc_fc,
							reg_user: window.currentUserName || '사용자', // 실제 사용자명 변수로 대체
							reg_date: kendo.toString(new Date(), 'yyyy-MM-dd')
						});
					}
					// 폼 리셋 및 팝업 닫기
					FormUtil.resetForm($("#reliabFormFC"));
					$("#reliabCodesWindowFC").data("kendoWindow").close();
				}
			});

			$("#btnCloseReliabCodesFC").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#selectRemedy'), 'cm_reliab_codes', 'choose', null, 'FC');
					$("#reliabCodesWindowFC").data("kendoWindow").close();
				}
			});

			$("#btnSaveProject").kendoButton({
				icon: "k-i-save", // 저장 아이콘
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#cmProjectForm"));

					if (!formData.proj_cd || !formData.proj_nm) {
						Alert.alert('', '프로젝트코드와 프로젝트명을 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#cmProjectForm"));
							_this.refreshProjectGrid();
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/project' + '?action=insert', formData, fnSuccess);
				}
			});

			$("#btnCloseProject").kendoButton({
				themeColor: "base",
				click: function () {
					AjaxUtil.fillDropDownOptions($('#projectName'), 'cm_project', 'choose', null, null);
					$("#cmProjectWindow").data("kendoWindow").close();
				}
			});

			$('#setMeAsWork').kendoButton({
				themeColor: "base",
				icon: "k-i-zoom-in", // 줌인 아이콘
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					const grid = $("#woLaborGrid").data("kendoGrid");
					if (!grid) return;

					// 현재 로그인 사용자 정보
					console.log(userinfo);
					const user_nm = userinfo.username;
					var param = {
						action: 'getCurrentDept',
					};
					const dept_nm = AjaxUtil.getSyncData('/api/system/depart', param).items.dept_nm;
					const womtrl = user_nm + ' (' + dept_nm + ')';

					// 이미 추가된 작업자인지 확인 (user_nm+dept_nm 기준)
					const exists = grid.dataSource.data().some(item => item.womtrl === womtrl);
					if (exists) {
						Alert.alert('', '이미 추가된 작업자입니다.');
						return;
					}

					grid.dataSource.add({
						job_class_nm: womtrl,
						labor_price: 0,
						worker_nos: 1,
						work_hr: 0,
						real_work_hr: 0,
						isReadOnly: true
					});
				}
			});

			$('#selWoLabor').kendoButton({
				themeColor: "base",
				icon: "k-i-zoom-in", // 줌인 아이콘
				rounded: "full",
				size: "small",
				click: function (e) {
					e.preventDefault();
					setModalPosition('#modalManMulti', { width: '40%', height: '60%' });
					woLoborMultiSelPage.show(function (data) {				
						let dataArr = Array.isArray(data) ? data : [data];
						const grid = $("#woLaborGrid").data("kendoGrid");
						if (!grid) return;

						dataArr.forEach(function (user) {
							let user_pk = user.user_pk;
							let user_dept_nm = user.user_nm + (user.dept_nm ? ' (' + user.dept_nm : '') + ')';

							// 이미 추가된 작업자인지 확인 (user_pk 기준)
							const exists = grid.dataSource.data().some(item => item.user_pk === user_pk);
							if (exists) {
								// 이미 추가된 경우는 건너뜀
								return;
							}

							grid.dataSource.add({
								user_pk: user_pk,
								job_class_nm: user_dept_nm, // 작업자/직종 컬럼에 user_dept_nm 값 사용
								labor_price: 0,
								worker_nos: 1,
								work_hr: 0,
								real_work_hr: 0,
								isReadOnly: true
							});
						});
					});
				}
			});


			// ESC 키 누를 때 모달 닫기
			$(document).on('keydown', (e) => {
				if (e.keyCode === 27) { // ESC key
					modal.fadeOut();
				}
			});

			$("#btnRejectApprInfo").kendoButton({
				themeColor: "error",
				click: function (e) {
					e.preventDefault();
					//기존 common.js 이용
					const options = {
						title: '반려',
						visible: false,
						modal: true,
						actions: [],
						appendTo: "body",
						width: '40vw',
						height: '20vw',
					}
					popupComn.openTempPopup($("#woRejectWindow"), options);

				}
			});

			$("#btnApprovalApprInfo ").kendoButton({
				click: function (e) {
					e.preventDefault();
					_this.ApprovalApprInfo();
				},
				themeColor: "none"
			});

			$("#btnRejectReq").kendoButton({
				themeColor: "base",
				click: function () {
					let formData = FormUtil.extractForm($("#rejectReasonForm"));
					formData.workOrderPk = _this.workOrderPk;

					if (!formData.reject_reason) {
						Alert.alert('', '반려사유를 입력해주세요.');
						return;
					}
					let fnSuccess = function (res) {
						if (res.success) {
							FormUtil.resetForm($("#rejectReasonForm"));
							Alert.alert('', res.message);
						} else if (!res.success) {
							Alert.alert('', res.message);
						}
					};
					AjaxUtil.postAsyncData('/api/kmms/work_order_approval' + '?action=updateRejectReq', formData, fnSuccess);
				}
			});

			$("#btnSave").kendoButton({
				click: function (e) {
					e.preventDefault();
					_this.saveData();
				},
				themeColor: "none"
			});

			// 모달 닫기 - 닫기 버튼 클릭
			$('#btnCloseApprInfo').kendoButton({
				click: function (e) {
					e.preventDefault();
					FormUtil.resetForm($('#wo_req_form'));
					// WoApprovalLine 숨김
					$("#woApprovalLine").css("display", "none");
					modal.fadeOut();
				}
			});

			$("#btnCloseReject").kendoButton({
				themeColor: "base",
				click: function () {
					FormUtil.resetForm($("#rejectReasonForm"));
					$("#woRejectWindow").data("kendoWindow").close();
				}
			});

			let reliabGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'reliab_cd', title: '현상코드', width: 80 },
					{
						field: "reliab_nm", title: "현상코드명", width: 150,
					},
					{
						field: 'insert_ts',
						title: '최근  등록일',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(insert_ts), "yyyy-MM-dd HH:mm:ss") #'
					},
				],
				height: "220px"
			};

			_this.reliabGrid = new Grid($("#reliabCodesGrid"), reliabGridOption);

			let reliabGridOptionCC = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'reliab_cd', title: '원인코드', width: 80 },
					{
						field: "reliab_nm", title: "원인코드명", width: 150,
					},
					{
						field: 'insert_ts',
						title: '최근  등록일',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(insert_ts), "yyyy-MM-dd HH:mm:ss") #'
					},
				],
				height: "220px"
			};

			_this.reliabGridCC = new Grid($("#reliabCodesGridCC"), reliabGridOptionCC);

			let reliabGridOptionRC = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'reliab_cd', title: '조치코드', width: 80 },
					{
						field: "reliab_nm", title: "조치코드명", width: 150,
					},
					{
						field: 'insert_ts',
						title: '최근  등록일',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(insert_ts), "yyyy-MM-dd HH:mm:ss") #'
					},
				],
				height: "220px"
			};

			_this.reliabGridRC = new Grid($("#reliabCodesGridRC"), reliabGridOptionRC);

			let projectGridOption = {
				toolbar: [
					"columns"
				],
				columnMenu: {
					componentType: "classic",
					autoSize: true,
					clearAllFilters: true,
					columns: {
						sort: "asc",
					}
				},
				columns: [
					{ field: 'proj_cd', title: '프로젝트코드', width: 80 },
					{
						field: "proj_nm", title: "프로젝트명", width: 150,
					},
					{
						field: 'insert_ts',
						title: '최근  등록일',
						width: 120,
						template: '#= kendo.toString(kendo.parseDate(insert_ts), "yyyy-MM-dd HH:mm:ss") #'
					},
				],
				height: "220px"
			};

			_this.projectGrid = new Grid($("#cmProjectGrid"), projectGridOption);

			// 문자 카운터 초기화
			_this.initCharCounter();

			// 에디터 기능입니다. 컴포넌트로 분리작업 필요합니다.
			var editor = $("#editor").kendoEditor({
				tools: [
					"undo",
					"redo",
					{ name: "separator1", type: "separator" },
					{
						name: "fontName",
						items: [
							{ text: "Arial", value: "Arial" },
							{ text: "Georgia", value: "Georgia" },
							{ text: "Helvetica", value: "Helvetica" },
							{ text: "Impact", value: "Impact" },
							{ text: "Tahoma", value: "Tahoma" },
							{ text: "Times New Roman", value: "\"Times New Roman\"" },
							{ text: "Verdana", value: "Verdana" },
						]
					},
					"fontSize",
					"bold",
					"italic",
					"underline",
					"backColor",
					"foreColor",
					{ name: "separator2", type: "separator" },
					"insertUnorderedList",
					"justifyLeft",
					"justifyCenter",
					"justifyRight",
					{ name: "separator3", type: "separator" },
					"formatting",
					{ name: "separator4", type: "separator" },
					"createLink",
					"unlink",
					"insertImage"
				]
			});

			// 외주업체 선택 시 그리드에 추가
			$('#selectExSupplier').on('change', function () {
				const supplierId = $(this).val();
				const supplierName = $('#selectExSupplier option:selected').text();

				if (!supplierId) return; // 선택 안 했으면 무시

				// 그리드 객체 가져오기
				const grid = $("#woExSupplierGrid").data("kendoGrid");
				if (!grid) return;

				// 이미 추가된 업체인지 확인
				const exists = grid.dataSource.data().some(item => item.ex_supplier_nm === supplierName);
				if (exists) {
					Alert.alert('', '이미 추가된 외주업체입니다.');
					return;
				}

				// 그리드에 데이터 추가
				grid.dataSource.add({
					ex_supplier_nm: supplierName,
					cost: 0 // 또는 기본값
				});

				// 선택 초기화(원하면)
				$(this).val('');
			});
		}

		// 문자 카운터 초기화
		initCharCounter() {
			$('#reject_reason').on('input', function () {
				const maxLength = 4000;
				const currentLength = $(this).val().length;
				$('#charCount').text(currentLength);

				if (currentLength > maxLength) {
					$(this).val($(this).val().substring(0, maxLength));
					$('#charCount').text(maxLength);
				}
			});
		}

		ApprovalApprInfo() {
			let _this = this;
			let data = {};
			data.workOrderPk = _this.workOrderPk;

			let funcSucc = function (resp) {
				if (resp.success) {
					Alert.alert('', '승인처리되었습니다.');
					$("#modalMyWorkApprInfo").fadeOut();
					// 부모 페이지 새로고침
					_this.refreshParentPage();

				} else {
					Alert.alert('error', resp.message);
				}
			};

			AjaxUtil.postAsyncData('/api/kmms/work_order_approval' + '?action=updateWoApproval', data, funcSucc);

		}

		saveData() {
			let _this = this;
			let data = FormUtil.extractForm($('#wo_req_form'));
			data.woStatusCd = 'WOS_OC';//요청완료
			console.log('wo_req_form_data', data);

			// 유효성 검사
			if (!data.equip_pk) {
				Alert.alert('', '설비를 선택해주세요.');
				return;
			}

			if (!data.maint_type_cd) {
				Alert.alert('', '보전유형을 선택해주세요.');
				return;
			}

			if (!data.dept_pk) {
				Alert.alert('', '작업부서를 선택해주세요.');
				return;
			}

			if (!data.work_charger_pk) {
				Alert.alert('', '작업담당자를 선택해주세요.');
				return;
			}

			if (!data.want_dt) {
				Alert.alert('', '희망일자(마침)을 선택해주세요.');
				return;
			}

			if (!data.breakdown_dt) {
				Alert.alert('', '고장일시를 선택해주세요.');
				return;
			}

			if (!data.problem_cd) {
				Alert.alert('', '현상을 선택해주세요.');
				return;
			}

			let funcSucc = function (resp) {
				if (resp.success) {
					//파일 저장
					const result = fetchSomeData();

					Alert.alert('', resp.message);
					FormUtil.resetForm($("#wo_req_form"));
					AjaxUtil.fillDropDownOptions($('#wcType'), 'cm_code', 'choose', 'WS01', 'WS_TYPE');
					// WoApprovalLine 숨김
					$("#woApprovalLine").css("display", "none");
					$("#modalMyWorkReqInfo").fadeOut();

					// 부모 페이지 새로고침
					_this.refreshParentPage();

				} else {
					Alert.alert('error', resp.message);
				}
			};

			AjaxUtil.postAsyncData(_this.baseUrl + '?action=save', data, funcSucc);

		}

		show(work_order_pk) {
			let _this = this;
			_this.workOrderPk = work_order_pk;

			// WoApprovalLine 동적 로드
			this.loadWoApprovalLine(work_order_pk);

			if (_this.workOrderPk == undefined) {
				this.editable = false;
				// 새 작업 요청 시 WoApprovalLine 숨김
				$("#woApprovalLine").css("display", "none");
			} else {
				this.editable = true;

				// 1. 상세 정보
				let param = {
					action: 'findOneWo',
					workOrderPk: _this.workOrderPk,
				};

				let woData = AjaxUtil.getSyncData(_this.baseUrl, param);
				console.log('woData:', woData);

				$("#req_dept_nm").text(woData.req_dept_nm);
				$("#req_user_nm").text(woData.rqst_user_nm);
				$("#req_date").text(woData.rqst_dt);
				$("#req_want_dt").text(woData.want_dt);

				$("#appr_req_info").text($("<div>").html(woData.req_info).text());

				$("#appr_work_order_no").text(woData.work_order_no);
				$("#appr_equip_cd_nm").text(woData.equip_nm);
				$("#appr_warranty_dt").text(woData.want_dt);

				$("#appr_wo_work_title").text(woData.work_title);

				$("#appr_maint_type_nm").text(woData.maint_type_nm);
				$("#appr_plan_period").text(woData.start_dt + ' - ' + woData.end_dt);
				$("#appr_breakdown_dt").text(woData.breakdown_dt);

				// approvalLine.js를 사용하여 결재라인 표시
				if (window.approvalLine) {
					// MyWorkAppr 모달용 고유 ID 사용
					window.approvalLine.onWorkOrderClick(_this.workOrderPk, 'MyWorkAppr');
				}

				// 그리드 데이터 로드
				_this.loadGridData();

			}

			$("#modalMyWorkApprInfo").fadeIn();
		}

		// WoApprovalLine 동적 로드 메소드
		loadWoApprovalLine(woNoPk) {
			if (window.approvalLine && typeof window.approvalLine.onWorkOrderClick === 'function') {
				window.approvalLine.onWorkOrderClick(woNoPk);
			}
		}

		// 그리드 데이터 로드 메소드
		loadGridData() {
			let _this = this;
			
			const woExSupplierGrid = $("#woExSupplierGrid").data("kendoGrid");
			if (woExSupplierGrid) {
				woExSupplierGrid.dataSource.read();
			}

			const woLaborGrid = $("#woLaborGrid").data("kendoGrid");
			if (woLaborGrid) {
				woLaborGrid.dataSource.read();
			}
		}

		refreshReliabGrid() {
			let param = {
				action: 'findAll',
				types: 'PC', // 현상코드 타입
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/reliab_code', param);
			let kendoGrid = $("#reliabCodesGrid").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

		refreshReliabGridCC() {
			let param = {
				action: 'findAll',
				types: 'CC', // 현상코드 타입
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/reliab_code', param);
			let kendoGrid = $("#reliabCodesGridCC").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

		refreshReliabGridRC() {
			let param = {
				action: 'findAll',
				types: 'RC', // 현상코드 타입
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/reliab_code', param);
			let kendoGrid = $("#reliabCodesGridRC").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

		refreshReliabGridFC() {
			let param = {
				action: 'findAll',
				types: 'FC', // 현상코드 타입
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/reliab_code', param);
			let kendoGrid = $("#reliabCodesGridFC").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

		refreshProjectGrid() {
			let param = {
				action: 'findAll',
				useYn: 'Y'   // 사용 여부
			};
			let result = AjaxUtil.getSyncData('/api/kmms/project', param);
			let kendoGrid = $("#cmProjectGrid").data("kendoGrid");
			if (kendoGrid) {
				kendoGrid.setDataSource(new kendo.data.DataSource({
					data: result
				}));
			}
		}

	}

	myWorkApprInfoPage = new MyWorkApprInfo();
	$(document).ready(function () {

		// 모달이 표시될 때마다 cycleInfo 체크 (jQuery fadeIn 방식)
		const originalFadeIn = $.fn.fadeIn;
		$.fn.fadeIn = function () {
			return originalFadeIn.apply(this, arguments);
		};

		let rowCount = 0;

		// selJobClass 선택 시 woLaborGrid에 추가
		$('#selJobClass').on('change', function () {
			const job_class_pk = $(this).val();
			const job_class_nm = $('#selJobClass option:selected').text();

			if (!job_class_pk) return;

			const grid = $("#woLaborGrid").data("kendoGrid");
			if (!grid) return;

			// 이미 추가된 직종인지 확인
			const exists = grid.dataSource.data().some(item => item.job_class_pk === job_class_pk);
			if (exists) {
				Alert.alert('', '이미 추가된 직종입니다.');
				return;
			}

			// 그리드에 데이터 추가 (초기값을 숫자 0으로)
			grid.dataSource.add({
				job_class_pk: job_class_pk,
				job_class_nm: job_class_nm,
				labor_price: 0,
				worker_nos: 1,
				work_hr: 0,
				real_work_hr: 0,
				isJobClassRow: true
			});

			$(this).val('');
		});

	});

	function showMainFileFromUploader() {
		if (!window.fileUploader) return;

		const fileDataList = window.fileUploader.getFilesData();
		const mainFile = fileDataList.find(file => file); // 첫 번째 파일

		const container = document.querySelector('#modalEquipMaster .file-container');
		if (container) {
			if (mainFile) {
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #1e4f88;"></i>
						<div style="margin-top: 10px; color: #333;">${mainFile.name}</div>
						<div style="color: #666; font-size: 12px;">${formatFileSize(mainFile.size)}</div>
					</div>
				`;
			} else {
				// fallback 파일 표시
				container.innerHTML = `
					<div style="text-align: center;">
						<i class="fas fa-file" style="font-size: 48px; color: #999;"></i>
						<div style="margin-top: 10px; color: #999;">No file</div>
					</div>
				`;
			}
		}
	}

	function formatFileSize(bytes) {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}

	function fetchSomeData() {
		try {
			if (window.fileUploader && typeof window.fileUploader.saveFiles === 'function' && window.fileUploader.getFilesData && window.fileUploader.getFilesData().length > 0) {
				const fileResult = window.fileUploader.saveFiles();
			}
		} catch (error) {
			console.error('Error:', error);
			alert(error.message);
			throw error;
		}
	}

	// 화폐 입력란 에디터
	function currencyEditor(container, options) {
		$('<input name="' + options.field + '" type="text" class="k-input k-textbox" style="text-align:right; width:100%;" />')
			.appendTo(container)
			.on('input', function () {
				this.value = this.value.replace(/[^0-9]/g, '');
			});
		$('<span style="position:absolute; right:16px; top:8px; color:#888; pointer-events:none;">₩</span>').appendTo(container);
	}
	// 숫자만 입력 에디터
	function numberOnlyEditor(container, options) {
		$('<input name="' + options.field + '" type="number" min="0" class="k-input k-textbox" style="text-align:right; width:100%;" />')
			.appendTo(container)
			.on('input', function () {
				this.value = this.value.replace(/[^0-9]/g, '');
			});
	}

</script>
